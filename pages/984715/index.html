<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>MySQL锁🌟 | Pangolin Note</title>
    <meta name="generator" content="VuePress 1.9.5">
    <link rel="icon" href="/img/favicon.ico">
    <meta name="description" content="大道至简">
    <meta name="keywords" content="前端博客,个人技术博客,前端,前端开发,前端框架,web前端,前端面试题,技术文档,学习,面试,JavaScript,js,ES6,TypeScript,vue,python,css3,html5,Node,git,github,markdown">
    <meta name="baidu-site-verification" content="7F55weZDDc">
    <meta name="theme-color" content="#11a8cd">
    
    <link rel="preload" href="/assets/css/0.styles.56073ad3.css" as="style"><link rel="preload" href="/assets/js/app.3f3e0e10.js" as="script"><link rel="preload" href="/assets/js/2.e9fcb30c.js" as="script"><link rel="preload" href="/assets/js/3.1998f389.js" as="script"><link rel="preload" href="/assets/js/102.e31e89b2.js" as="script"><link rel="prefetch" href="/assets/js/10.0b55747f.js"><link rel="prefetch" href="/assets/js/100.b8912a99.js"><link rel="prefetch" href="/assets/js/101.a6740c8a.js"><link rel="prefetch" href="/assets/js/103.2c5dbdae.js"><link rel="prefetch" href="/assets/js/104.0e9c02f6.js"><link rel="prefetch" href="/assets/js/105.8288396c.js"><link rel="prefetch" href="/assets/js/106.62f43c11.js"><link rel="prefetch" href="/assets/js/107.70c90211.js"><link rel="prefetch" href="/assets/js/108.b488ce56.js"><link rel="prefetch" href="/assets/js/109.12942650.js"><link rel="prefetch" href="/assets/js/11.ac3fd1ca.js"><link rel="prefetch" href="/assets/js/110.1e57ecba.js"><link rel="prefetch" href="/assets/js/111.6e33b4ea.js"><link rel="prefetch" href="/assets/js/112.bd52831b.js"><link rel="prefetch" href="/assets/js/113.868c1ac9.js"><link rel="prefetch" href="/assets/js/114.090549d1.js"><link rel="prefetch" href="/assets/js/115.d97f6c2b.js"><link rel="prefetch" href="/assets/js/116.097c4b4e.js"><link rel="prefetch" href="/assets/js/117.4024cfe2.js"><link rel="prefetch" href="/assets/js/118.e3057cba.js"><link rel="prefetch" href="/assets/js/119.4ef1fa3b.js"><link rel="prefetch" href="/assets/js/12.863eaabe.js"><link rel="prefetch" href="/assets/js/120.78f9df50.js"><link rel="prefetch" href="/assets/js/121.8e16df87.js"><link rel="prefetch" href="/assets/js/122.f21c0107.js"><link rel="prefetch" href="/assets/js/123.ea1cb375.js"><link rel="prefetch" href="/assets/js/124.01c04c6e.js"><link rel="prefetch" href="/assets/js/125.d383e301.js"><link rel="prefetch" href="/assets/js/126.3162cb47.js"><link rel="prefetch" href="/assets/js/127.c6bebae6.js"><link rel="prefetch" href="/assets/js/128.d659db60.js"><link rel="prefetch" href="/assets/js/129.2afdcf48.js"><link rel="prefetch" href="/assets/js/13.4f59ce35.js"><link rel="prefetch" href="/assets/js/130.beb9ed9d.js"><link rel="prefetch" href="/assets/js/131.35b05f8a.js"><link rel="prefetch" href="/assets/js/132.d77f4f93.js"><link rel="prefetch" href="/assets/js/133.4ceda6e5.js"><link rel="prefetch" href="/assets/js/134.11390c5f.js"><link rel="prefetch" href="/assets/js/135.32f9e38f.js"><link rel="prefetch" href="/assets/js/136.6d8bb0f2.js"><link rel="prefetch" href="/assets/js/137.9c0ffeef.js"><link rel="prefetch" href="/assets/js/138.88d86e5f.js"><link rel="prefetch" href="/assets/js/139.8c2c3d6c.js"><link rel="prefetch" href="/assets/js/14.11c82d35.js"><link rel="prefetch" href="/assets/js/140.c5c375d3.js"><link rel="prefetch" href="/assets/js/141.d703f30b.js"><link rel="prefetch" href="/assets/js/142.6a005a44.js"><link rel="prefetch" href="/assets/js/143.9b2edf6f.js"><link rel="prefetch" href="/assets/js/144.3fd013c9.js"><link rel="prefetch" href="/assets/js/145.b05079c5.js"><link rel="prefetch" href="/assets/js/146.ed5360a6.js"><link rel="prefetch" href="/assets/js/147.7408d86f.js"><link rel="prefetch" href="/assets/js/148.f390b370.js"><link rel="prefetch" href="/assets/js/149.95017f0a.js"><link rel="prefetch" href="/assets/js/15.bd143bd5.js"><link rel="prefetch" href="/assets/js/150.f0ede764.js"><link rel="prefetch" href="/assets/js/151.b7093623.js"><link rel="prefetch" href="/assets/js/152.a82a6c83.js"><link rel="prefetch" href="/assets/js/153.965e3fb2.js"><link rel="prefetch" href="/assets/js/154.9e49311e.js"><link rel="prefetch" href="/assets/js/155.cef33ba5.js"><link rel="prefetch" href="/assets/js/156.bcc397ae.js"><link rel="prefetch" href="/assets/js/157.90824739.js"><link rel="prefetch" href="/assets/js/158.efd429b9.js"><link rel="prefetch" href="/assets/js/159.122ff5b7.js"><link rel="prefetch" href="/assets/js/16.2449162b.js"><link rel="prefetch" href="/assets/js/160.0b806535.js"><link rel="prefetch" href="/assets/js/161.835052c6.js"><link rel="prefetch" href="/assets/js/162.ca34e2d2.js"><link rel="prefetch" href="/assets/js/163.08000d04.js"><link rel="prefetch" href="/assets/js/164.a1cc0109.js"><link rel="prefetch" href="/assets/js/165.65444686.js"><link rel="prefetch" href="/assets/js/166.7d73c84f.js"><link rel="prefetch" href="/assets/js/167.009d47a3.js"><link rel="prefetch" href="/assets/js/168.0afeae2a.js"><link rel="prefetch" href="/assets/js/169.7654cb31.js"><link rel="prefetch" href="/assets/js/17.eb7f9def.js"><link rel="prefetch" href="/assets/js/170.58569530.js"><link rel="prefetch" href="/assets/js/171.7db9ed40.js"><link rel="prefetch" href="/assets/js/172.3cb50ed4.js"><link rel="prefetch" href="/assets/js/173.0846425f.js"><link rel="prefetch" href="/assets/js/174.9e95f111.js"><link rel="prefetch" href="/assets/js/175.ef2098f2.js"><link rel="prefetch" href="/assets/js/176.c2635fe9.js"><link rel="prefetch" href="/assets/js/177.4fa38e8e.js"><link rel="prefetch" href="/assets/js/178.2be7037f.js"><link rel="prefetch" href="/assets/js/179.bf3bba28.js"><link rel="prefetch" href="/assets/js/18.0455f4d1.js"><link rel="prefetch" href="/assets/js/180.72c5f597.js"><link rel="prefetch" href="/assets/js/181.42287bcc.js"><link rel="prefetch" href="/assets/js/182.6cd4bf1a.js"><link rel="prefetch" href="/assets/js/183.05dbbfd9.js"><link rel="prefetch" href="/assets/js/184.03de7e00.js"><link rel="prefetch" href="/assets/js/185.42dd210e.js"><link rel="prefetch" href="/assets/js/186.28ee0f8a.js"><link rel="prefetch" href="/assets/js/187.bb58697b.js"><link rel="prefetch" href="/assets/js/188.1bc8be96.js"><link rel="prefetch" href="/assets/js/189.fac747e3.js"><link rel="prefetch" href="/assets/js/19.ae9e35d6.js"><link rel="prefetch" href="/assets/js/190.ea533ac7.js"><link rel="prefetch" href="/assets/js/191.6dc6eb13.js"><link rel="prefetch" href="/assets/js/192.184d249f.js"><link rel="prefetch" href="/assets/js/193.4a06bc12.js"><link rel="prefetch" href="/assets/js/194.8cce60a9.js"><link rel="prefetch" href="/assets/js/195.93231a13.js"><link rel="prefetch" href="/assets/js/196.4a596bde.js"><link rel="prefetch" href="/assets/js/197.96c113cf.js"><link rel="prefetch" href="/assets/js/198.73ba3f67.js"><link rel="prefetch" href="/assets/js/199.74bab595.js"><link rel="prefetch" href="/assets/js/20.b542d0e7.js"><link rel="prefetch" href="/assets/js/200.69a6928a.js"><link rel="prefetch" href="/assets/js/201.9ffa7c5a.js"><link rel="prefetch" href="/assets/js/202.41edb652.js"><link rel="prefetch" href="/assets/js/203.7fabcef3.js"><link rel="prefetch" href="/assets/js/204.b0ae2f62.js"><link rel="prefetch" href="/assets/js/205.add8738b.js"><link rel="prefetch" href="/assets/js/206.f3a712ec.js"><link rel="prefetch" href="/assets/js/207.cd7dd729.js"><link rel="prefetch" href="/assets/js/208.78b33afa.js"><link rel="prefetch" href="/assets/js/209.9d3329ff.js"><link rel="prefetch" href="/assets/js/21.5a050318.js"><link rel="prefetch" href="/assets/js/210.d285d5ac.js"><link rel="prefetch" href="/assets/js/211.8791bb3f.js"><link rel="prefetch" href="/assets/js/212.84ed81a8.js"><link rel="prefetch" href="/assets/js/213.7b990580.js"><link rel="prefetch" href="/assets/js/214.da31f20c.js"><link rel="prefetch" href="/assets/js/215.9eeed659.js"><link rel="prefetch" href="/assets/js/216.9539f0ec.js"><link rel="prefetch" href="/assets/js/217.11b575be.js"><link rel="prefetch" href="/assets/js/218.a67f12f1.js"><link rel="prefetch" href="/assets/js/219.bfbb817a.js"><link rel="prefetch" href="/assets/js/22.2bc6f7e3.js"><link rel="prefetch" href="/assets/js/220.8b01342f.js"><link rel="prefetch" href="/assets/js/221.b450decd.js"><link rel="prefetch" href="/assets/js/222.97468507.js"><link rel="prefetch" href="/assets/js/223.b6dafd73.js"><link rel="prefetch" href="/assets/js/224.c86c18c6.js"><link rel="prefetch" href="/assets/js/225.b0dcf86e.js"><link rel="prefetch" href="/assets/js/226.02cc2999.js"><link rel="prefetch" href="/assets/js/227.8474ef5a.js"><link rel="prefetch" href="/assets/js/228.0298e421.js"><link rel="prefetch" href="/assets/js/229.6aeaf595.js"><link rel="prefetch" href="/assets/js/23.9995fce4.js"><link rel="prefetch" href="/assets/js/230.a5785286.js"><link rel="prefetch" href="/assets/js/231.d791daa4.js"><link rel="prefetch" href="/assets/js/232.97aeeb00.js"><link rel="prefetch" href="/assets/js/233.46e51e28.js"><link rel="prefetch" href="/assets/js/234.2cffe82f.js"><link rel="prefetch" href="/assets/js/235.14965da6.js"><link rel="prefetch" href="/assets/js/236.00a5afc0.js"><link rel="prefetch" href="/assets/js/237.3b73d52f.js"><link rel="prefetch" href="/assets/js/238.6e1db765.js"><link rel="prefetch" href="/assets/js/239.75866c5e.js"><link rel="prefetch" href="/assets/js/24.9141eeb2.js"><link rel="prefetch" href="/assets/js/240.af9c2cc9.js"><link rel="prefetch" href="/assets/js/241.388acab2.js"><link rel="prefetch" href="/assets/js/242.c60f2b48.js"><link rel="prefetch" href="/assets/js/243.d8e81b13.js"><link rel="prefetch" href="/assets/js/244.58b0b21d.js"><link rel="prefetch" href="/assets/js/245.c3768497.js"><link rel="prefetch" href="/assets/js/246.ac8bbe7a.js"><link rel="prefetch" href="/assets/js/247.d095f70a.js"><link rel="prefetch" href="/assets/js/248.e9f210b5.js"><link rel="prefetch" href="/assets/js/249.a9fad023.js"><link rel="prefetch" href="/assets/js/25.98e8593e.js"><link rel="prefetch" href="/assets/js/250.ae7f0ebb.js"><link rel="prefetch" href="/assets/js/251.9a617d55.js"><link rel="prefetch" href="/assets/js/252.ce082446.js"><link rel="prefetch" href="/assets/js/253.4575302d.js"><link rel="prefetch" href="/assets/js/254.5899a61b.js"><link rel="prefetch" href="/assets/js/255.66c69f31.js"><link rel="prefetch" href="/assets/js/256.8fd6c706.js"><link rel="prefetch" href="/assets/js/257.31b77e5e.js"><link rel="prefetch" href="/assets/js/258.eba48891.js"><link rel="prefetch" href="/assets/js/259.edf74b59.js"><link rel="prefetch" href="/assets/js/26.e69924ea.js"><link rel="prefetch" href="/assets/js/260.cf2ed36d.js"><link rel="prefetch" href="/assets/js/261.9e7792d8.js"><link rel="prefetch" href="/assets/js/262.e7b9433e.js"><link rel="prefetch" href="/assets/js/263.1185b25c.js"><link rel="prefetch" href="/assets/js/264.5e0f89cb.js"><link rel="prefetch" href="/assets/js/265.a38d3b94.js"><link rel="prefetch" href="/assets/js/266.2ef170b3.js"><link rel="prefetch" href="/assets/js/267.a7d14651.js"><link rel="prefetch" href="/assets/js/268.05b18748.js"><link rel="prefetch" href="/assets/js/269.dad48d6f.js"><link rel="prefetch" href="/assets/js/27.13612515.js"><link rel="prefetch" href="/assets/js/270.4f5a6b8d.js"><link rel="prefetch" href="/assets/js/271.7ebf6682.js"><link rel="prefetch" href="/assets/js/272.7c2fbfd1.js"><link rel="prefetch" href="/assets/js/273.8ee20732.js"><link rel="prefetch" href="/assets/js/274.d525242a.js"><link rel="prefetch" href="/assets/js/275.a8a19acb.js"><link rel="prefetch" href="/assets/js/276.df3a4eb4.js"><link rel="prefetch" href="/assets/js/277.336debda.js"><link rel="prefetch" href="/assets/js/278.c470625f.js"><link rel="prefetch" href="/assets/js/279.a91e1a64.js"><link rel="prefetch" href="/assets/js/28.ab7ae1df.js"><link rel="prefetch" href="/assets/js/280.87e25c9a.js"><link rel="prefetch" href="/assets/js/281.87c1ba25.js"><link rel="prefetch" href="/assets/js/282.dcd4dce0.js"><link rel="prefetch" href="/assets/js/283.abac2e00.js"><link rel="prefetch" href="/assets/js/284.f6079659.js"><link rel="prefetch" href="/assets/js/285.f1b39879.js"><link rel="prefetch" href="/assets/js/286.f6a79242.js"><link rel="prefetch" href="/assets/js/287.06bebe07.js"><link rel="prefetch" href="/assets/js/288.89e325df.js"><link rel="prefetch" href="/assets/js/289.3aa1bedd.js"><link rel="prefetch" href="/assets/js/29.ebe50f76.js"><link rel="prefetch" href="/assets/js/290.ee059c92.js"><link rel="prefetch" href="/assets/js/291.fa9a921a.js"><link rel="prefetch" href="/assets/js/292.2a8811cd.js"><link rel="prefetch" href="/assets/js/293.eec09cdf.js"><link rel="prefetch" href="/assets/js/294.dfac20dc.js"><link rel="prefetch" href="/assets/js/295.825d2070.js"><link rel="prefetch" href="/assets/js/296.f645861e.js"><link rel="prefetch" href="/assets/js/297.424fdb17.js"><link rel="prefetch" href="/assets/js/298.ebf87cdc.js"><link rel="prefetch" href="/assets/js/299.b8f19cbb.js"><link rel="prefetch" href="/assets/js/30.75237511.js"><link rel="prefetch" href="/assets/js/300.10fb6d4f.js"><link rel="prefetch" href="/assets/js/301.ef77c612.js"><link rel="prefetch" href="/assets/js/302.1b839763.js"><link rel="prefetch" href="/assets/js/303.609f7d98.js"><link rel="prefetch" href="/assets/js/304.1d255f19.js"><link rel="prefetch" href="/assets/js/305.b0234f2c.js"><link rel="prefetch" href="/assets/js/306.48677f64.js"><link rel="prefetch" href="/assets/js/307.14390d4b.js"><link rel="prefetch" href="/assets/js/308.fa730b28.js"><link rel="prefetch" href="/assets/js/309.0496b9e0.js"><link rel="prefetch" href="/assets/js/31.cf3f471a.js"><link rel="prefetch" href="/assets/js/310.a31676dc.js"><link rel="prefetch" href="/assets/js/311.ed53adc5.js"><link rel="prefetch" href="/assets/js/312.1b0ff2f1.js"><link rel="prefetch" href="/assets/js/313.bf123f32.js"><link rel="prefetch" href="/assets/js/314.4e6ce06b.js"><link rel="prefetch" href="/assets/js/315.8eb18560.js"><link rel="prefetch" href="/assets/js/32.74fef842.js"><link rel="prefetch" href="/assets/js/33.bc2d190b.js"><link rel="prefetch" href="/assets/js/34.d23438fc.js"><link rel="prefetch" href="/assets/js/35.7675c4d0.js"><link rel="prefetch" href="/assets/js/36.96a4161b.js"><link rel="prefetch" href="/assets/js/37.d1824f2f.js"><link rel="prefetch" href="/assets/js/38.4effff9e.js"><link rel="prefetch" href="/assets/js/39.6509914b.js"><link rel="prefetch" href="/assets/js/4.4d01750f.js"><link rel="prefetch" href="/assets/js/40.1509d08b.js"><link rel="prefetch" href="/assets/js/41.f2c1124f.js"><link rel="prefetch" href="/assets/js/42.e541d077.js"><link rel="prefetch" href="/assets/js/43.369de999.js"><link rel="prefetch" href="/assets/js/44.43959db0.js"><link rel="prefetch" href="/assets/js/45.282fbd31.js"><link rel="prefetch" href="/assets/js/46.1b83cfe9.js"><link rel="prefetch" href="/assets/js/47.c3a88e41.js"><link rel="prefetch" href="/assets/js/48.bc7c0a1b.js"><link rel="prefetch" href="/assets/js/49.92a4e5ba.js"><link rel="prefetch" href="/assets/js/5.c3991e24.js"><link rel="prefetch" href="/assets/js/50.9c488c6c.js"><link rel="prefetch" href="/assets/js/51.546ea632.js"><link rel="prefetch" href="/assets/js/52.0d2ccee1.js"><link rel="prefetch" href="/assets/js/53.6f52b5b1.js"><link rel="prefetch" href="/assets/js/54.c838b295.js"><link rel="prefetch" href="/assets/js/55.13af99ee.js"><link rel="prefetch" href="/assets/js/56.6be6d1ed.js"><link rel="prefetch" href="/assets/js/57.67c98b39.js"><link rel="prefetch" href="/assets/js/58.107e82ec.js"><link rel="prefetch" href="/assets/js/59.b3e5edc7.js"><link rel="prefetch" href="/assets/js/6.36a535f9.js"><link rel="prefetch" href="/assets/js/60.3b0b4ba5.js"><link rel="prefetch" href="/assets/js/61.3df843df.js"><link rel="prefetch" href="/assets/js/62.1213823d.js"><link rel="prefetch" href="/assets/js/63.e8f3f926.js"><link rel="prefetch" href="/assets/js/64.e1219050.js"><link rel="prefetch" href="/assets/js/65.5bf5bb0b.js"><link rel="prefetch" href="/assets/js/66.a2502afb.js"><link rel="prefetch" href="/assets/js/67.690dd59b.js"><link rel="prefetch" href="/assets/js/68.de7b0915.js"><link rel="prefetch" href="/assets/js/69.ac61dd61.js"><link rel="prefetch" href="/assets/js/7.5d254238.js"><link rel="prefetch" href="/assets/js/70.3edd41b1.js"><link rel="prefetch" href="/assets/js/71.d23407e9.js"><link rel="prefetch" href="/assets/js/72.a5bd01bc.js"><link rel="prefetch" href="/assets/js/73.c9f4dd57.js"><link rel="prefetch" href="/assets/js/74.66323fc1.js"><link rel="prefetch" href="/assets/js/75.e1a72e00.js"><link rel="prefetch" href="/assets/js/76.801268b4.js"><link rel="prefetch" href="/assets/js/77.3a5fda67.js"><link rel="prefetch" href="/assets/js/78.54d84cd4.js"><link rel="prefetch" href="/assets/js/79.fa10f4e3.js"><link rel="prefetch" href="/assets/js/8.e060e47d.js"><link rel="prefetch" href="/assets/js/80.d5b24fea.js"><link rel="prefetch" href="/assets/js/81.0e9da714.js"><link rel="prefetch" href="/assets/js/82.e96ff6d7.js"><link rel="prefetch" href="/assets/js/83.771cced1.js"><link rel="prefetch" href="/assets/js/84.220b69e7.js"><link rel="prefetch" href="/assets/js/85.7dcc5659.js"><link rel="prefetch" href="/assets/js/86.44ba2100.js"><link rel="prefetch" href="/assets/js/87.281da75d.js"><link rel="prefetch" href="/assets/js/88.12d88449.js"><link rel="prefetch" href="/assets/js/89.f28c86d3.js"><link rel="prefetch" href="/assets/js/9.8f9fef32.js"><link rel="prefetch" href="/assets/js/90.715cabb2.js"><link rel="prefetch" href="/assets/js/91.6ced7c82.js"><link rel="prefetch" href="/assets/js/92.c05b33ca.js"><link rel="prefetch" href="/assets/js/93.6bf5fb66.js"><link rel="prefetch" href="/assets/js/94.3561200e.js"><link rel="prefetch" href="/assets/js/95.0f2cf716.js"><link rel="prefetch" href="/assets/js/96.ac8487ea.js"><link rel="prefetch" href="/assets/js/97.48042b5a.js"><link rel="prefetch" href="/assets/js/98.441bb7f8.js"><link rel="prefetch" href="/assets/js/99.4b214d92.js">
    <link rel="stylesheet" href="/assets/css/0.styles.56073ad3.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu"><header class="navbar blur"><div title="目录" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/img/magic.png" alt="Pangolin Note" class="logo"> <span class="site-name can-hide">Pangolin Note</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">🏡首页</a></div><div class="nav-item"><a href="/basic/" class="nav-link">基础</a></div><div class="nav-item"><a href="/develop/" class="nav-link">开发</a></div><div class="nav-item"><a href="/middleware/" class="nav-link">系统</a></div><div class="nav-item"><a href="/algorithm/" class="nav-link">算法</a></div><div class="nav-item"><a href="/books/" class="nav-link">🍀读书笔记</a></div><div class="nav-item"><a href="/work/" class="nav-link">工作</a></div><div class="nav-item"><a href="/pangolin/" class="nav-link">🌸达尔文的猹</a></div><div class="nav-item"><a href="/pages/beb6c0bd8a66cea6/" class="nav-link">收藏</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/archives/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">归档</a></li></ul></div></div> <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><div class="blogger"><img src="/img/avatarnew.png"> <div class="blogger-info"><h3>达尔文的猹</h3> <span>大道至简 悟在天成</span></div></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">🏡首页</a></div><div class="nav-item"><a href="/basic/" class="nav-link">基础</a></div><div class="nav-item"><a href="/develop/" class="nav-link">开发</a></div><div class="nav-item"><a href="/middleware/" class="nav-link">系统</a></div><div class="nav-item"><a href="/algorithm/" class="nav-link">算法</a></div><div class="nav-item"><a href="/books/" class="nav-link">🍀读书笔记</a></div><div class="nav-item"><a href="/work/" class="nav-link">工作</a></div><div class="nav-item"><a href="/pangolin/" class="nav-link">🌸达尔文的猹</a></div><div class="nav-item"><a href="/pages/beb6c0bd8a66cea6/" class="nav-link">收藏</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/archives/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">归档</a></li></ul></div></div> <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Java</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading open"><span>基础</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/4f30b9/" class="sidebar-link">Java基础</a></li><li><a href="/pages/795eca/" class="sidebar-link">类与继承</a></li><li><a href="/pages/c69152/" class="sidebar-link">抽象类与接口</a></li><li><a href="/pages/d71abb/" class="sidebar-link">内部类</a></li><li><a href="/pages/f06dca/" class="sidebar-link">枚举类</a></li><li><a href="/pages/259f57/" class="sidebar-link">常用类</a></li><li><a href="/pages/84b03b/" class="sidebar-link">关键字</a></li><li><a href="/pages/31b87b/" class="sidebar-link">注解</a></li><li><a href="/pages/f81c0d/" class="sidebar-link">异常</a></li><li><a href="/pages/ae7746/" class="sidebar-link">泛型</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading"><span>容器类</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/0c88ac/" class="sidebar-link">集合容器类基础</a></li><li><a href="/pages/f805ed/" class="sidebar-link">List与Queue类</a></li><li><a href="/pages/d24b60/" class="sidebar-link">Map与Set类</a></li><li><a href="/pages/54e5d3/" class="sidebar-link">并发容器类</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading"><span>并发</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/67d70f/" class="sidebar-link">多线程基础</a></li><li><a href="/pages/ffc8f7/" class="sidebar-link">Java内置锁</a></li><li><a href="/pages/c43494/" class="sidebar-link">AQS</a></li><li><a href="/pages/eb5b61/" class="sidebar-link">显式锁ReentrantLock</a></li><li><a href="/pages/eb8cbc/" class="sidebar-link">线程协作与JUC组件</a></li><li><a href="/pages/23c79a/" class="sidebar-link">Atomic原子变量与Unsafe类与CAS</a></li><li><a href="/pages/9d6ed4/" class="sidebar-link">线程池与定时任务</a></li><li><a href="/pages/5b787a/" class="sidebar-link">ThreadLocal</a></li><li><a href="/pages/db53d1/" class="sidebar-link">Java并发编程实战(极客时间)🌸</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading"><span>IO</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/b4d461/" class="sidebar-link">文件操作</a></li><li><a href="/pages/1b9d6c/" class="sidebar-link">IO流操作</a></li><li><a href="/pages/076a47/" class="sidebar-link">Java网络IO模型</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading"><span>高级特性</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/d76905/" class="sidebar-link">Lambda表达式</a></li><li><a href="/pages/f7f0e6/" class="sidebar-link">流Stream</a></li><li><a href="/pages/7cc40a/" class="sidebar-link">反射</a></li><li><a href="/pages/945326/" class="sidebar-link">代理</a></li><li><a href="/pages/7fd9b4/" class="sidebar-link">Javaagent</a></li><li><a href="/pages/a3cee0/" class="sidebar-link">Guava</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading"><span>JVM</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/d308f6/" class="sidebar-link">走进JVM🌼</a></li><li><a href="/pages/be0269/" class="sidebar-link">JVM内存区域与对象解析🌼</a></li><li><a href="/pages/48d1be/" class="sidebar-link">垃圾收集器与内存分配策略🌼</a></li><li><a href="/pages/3a4c8a/" class="sidebar-link">JVM性能监控与故障处理工具🌼</a></li><li><a href="/pages/106680/" class="sidebar-link">调优案例分析与实战🌼</a></li><li><a href="/pages/16a914/" class="sidebar-link">类文件结构🌼</a></li><li><a href="/pages/ea287c/" class="sidebar-link">虚拟机类加载机制🌼</a></li><li><a href="/pages/6367b0/" class="sidebar-link">虚拟机字节码执行引擎🌼</a></li><li><a href="/pages/c6c210/" class="sidebar-link">类加载及执行子系统的案例与实战🌼</a></li><li><a href="/pages/deb8b7/" class="sidebar-link">前端编译与优化🌼</a></li><li><a href="/pages/1f8f72/" class="sidebar-link">后端编译与优化🌼</a></li><li><a href="/pages/3d72db/" class="sidebar-link">Java内存模型与线程实现🌼</a></li><li><a href="/pages/ed086e/" class="sidebar-link">线程安全与内置锁优化🌼</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading"><span>其他</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/56b9dd/" class="sidebar-link">Java性能问题定位分析</a></li><li><a href="/pages/939bf8/" class="sidebar-link">杂记</a></li></ul></section></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>开发</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading"><span>软件设计</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/a5f6fe/" class="sidebar-link">设计基础理论</a></li><li><a href="/pages/3b245c/" class="sidebar-link">设计模式之美(极客时间)🌟</a></li><li><a href="/pages/661fa4/" class="sidebar-link">领域驱动设计(DDD)</a></li><li><a href="/pages/856368/" class="sidebar-link">DDD实战课(极客时间)🌸</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading open"><span>数据库</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/d3fbd2/" class="sidebar-link">数据库基础</a></li><li><a href="/pages/691fc3/" class="sidebar-link">数据库系统原理</a></li><li><a href="/pages/50f6b7/" class="sidebar-link">MySQL基础必知必会</a></li><li><a href="/pages/fe297e/" class="sidebar-link">MySQL特性</a></li><li><a href="/pages/07bdb6/" class="sidebar-link">MySQL索引🌟</a></li><li><a href="/pages/984715/" aria-current="page" class="active sidebar-link">MySQL锁🌟</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/pages/53b588/" class="sidebar-link">MySQL事务🌟</a></li><li><a href="/pages/becc59/" class="sidebar-link">MySQL高级特性</a></li><li><a href="/pages/056463/" class="sidebar-link">MySQL基础架构与存储引擎🌟</a></li><li><a href="/pages/63b46e/" class="sidebar-link">MySQL架构优化与运维</a></li><li><a href="/pages/9995e5/" class="sidebar-link">MySQL优化</a></li><li><a href="/pages/c1c2f6/" class="sidebar-link">MySQL架构</a></li><li><a href="/pages/8e8e0a/" class="sidebar-link">MySQL设计规范</a></li><li><a href="/pages/0219aa/" class="sidebar-link">MySQL运维</a></li><li><a href="/pages/e288c0/" class="sidebar-link">MySQL中间件</a></li><li><a href="/pages/c6cafa/" class="sidebar-link">MySQL实战45讲(极客时间)🌟</a></li><li><a href="/pages/4a6106/" class="sidebar-link">数据库LeetCode题目</a></li><li><a href="/pages/2827f1/" class="sidebar-link">数据库综合问题</a></li><li><a href="/pages/c616d5/" class="sidebar-link">MongoDB</a></li><li><a href="/pages/075e71/" class="sidebar-link">ClickHouse</a></li><li><a href="/pages/d74f6d/" class="sidebar-link">Doris</a></li><li><a href="/pages/b6bad9/" class="sidebar-link">HBase</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading"><span>Spring</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/bd8eb8/" class="sidebar-link">Spring Boot基础</a></li><li><a href="/pages/d0d797/" class="sidebar-link">Spring Boot应用整合</a></li><li><a href="/pages/314cdc/" class="sidebar-link">Spring MVC基础</a></li><li><a href="/pages/80de47/" class="sidebar-link">Spring AOP基础</a></li><li><a href="/pages/f0d4d6/" class="sidebar-link">Spring事务基础</a></li><li><a href="/pages/db6afe/" class="sidebar-link">Spring IOC源码分析-概览</a></li><li><a href="/pages/672e98/" class="sidebar-link">Spring IOC源码分析-getBean()</a></li><li><a href="/pages/695b90/" class="sidebar-link">Spring IOC源码分析-createBean()</a></li><li><a href="/pages/f89bcf/" class="sidebar-link">Spring AOP源码分析</a></li><li><a href="/pages/3b52f4/" class="sidebar-link">Spring事务源码分析</a></li><li><a href="/pages/186902/" class="sidebar-link">Spring Boot源码分析</a></li><li><a href="/pages/16bd1c/" class="sidebar-link">Spring MVC源码分析</a></li><li><a href="/pages/3d0c1f/" class="sidebar-link">Spring Cloud</a></li><li><a href="/pages/d56156/" class="sidebar-link">Spring编程常见错误50例(极客时间)🌸</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading"><span>MyBatis</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/bb032d/" class="sidebar-link">基础</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading"><span>工具与环境</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/c9cb6e/" class="sidebar-link">Arthas</a></li><li><a href="/pages/3172bb/" class="sidebar-link">Maven</a></li><li><a href="/pages/37f79a/" class="sidebar-link">Git</a></li><li><a href="/pages/db9f99/" class="sidebar-link">环境搭建与部署</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading"><span>测试</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/c725f5/" class="sidebar-link">测试基础</a></li><li><a href="/pages/7893a4/" class="sidebar-link">单元测试</a></li><li><a href="/pages/af9f25/" class="sidebar-link">压力测试</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading"><span>代码质量</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/ec2b81/" class="sidebar-link">代码整洁之道</a></li><li><a href="/pages/474cdf/" class="sidebar-link">阿里巴巴编程规范</a></li><li><a href="/pages/c47e15/" class="sidebar-link">代码之丑(极客时间)🌸</a></li><li><a href="/pages/4d4606/" class="sidebar-link">Java业务开发常见错误100例(极客时间)🌸</a></li></ul></section></li></ul></section></li></ul> </aside> <div><main class="page"><div class="theme-vdoing-wrapper "><div class="articleInfo-wrap" data-v-06970110><div class="articleInfo" data-v-06970110><ul class="breadcrumbs" data-v-06970110><li data-v-06970110><a href="/" title="首页" class="iconfont icon-home router-link-active" data-v-06970110></a></li> <li data-v-06970110><a href="/develop/#开发" data-v-06970110>开发</a></li><li data-v-06970110><a href="/develop/#开发" data-v-06970110>开发</a></li><li data-v-06970110><a href="/develop/#数据库" data-v-06970110>数据库</a></li></ul> <div class="info" data-v-06970110><div title="作者" class="author iconfont icon-touxiang" data-v-06970110><a href="https://github.com/nanodaemony" target="_blank" title="作者" class="beLink" data-v-06970110>NanoDaemony</a></div> <div title="创建时间" class="date iconfont icon-riqi" data-v-06970110><a href="javascript:;" data-v-06970110>2025-02-26</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-title">本文目录</div> <div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABKFJREFUSA3tVl1oFVcQnrMbrak3QUgkya1akpJYcrUtIqW1JvFBE9LiQ5v6JmJpolbMg32rVrhgoYK0QiMY6i9Y6EMaW5D+xFJaTYItIuK2Kr3+BJNwkxBj05sQY3b3nM6cs2dv9t7NT/vQJw/sndk5M/PNzJkzewGerP+pAmy+ON8lLzUJgA8ZYxYIYZmGYRnctDaWvJJAmTtfP1pvXsBCCPP8QFcCaRkZYACgDZFO4stNIcBCajEOlmmC9XpJ9bAGCaPaPmzPl32dvLSVu3BWCTQs0XQQ6g0DYgwLIoAZbBCdW/i+781o1VVlm/410mw4h06Y7bIPHNyWDyL4FHkX03Q8SrzNhZTZriieckWt7cL6MM85YcLpsi/7O9/iXFT6MswI0DmmpkSaJ0qLxFIm3+i1THHB3zmBH3PYx9CcykcLOeQVVa7QtdxTgQgEleX2AjHYfwA+2ddV77ruGoJUbhGDI09YSNXyMpUt5ylOzxgbUmtOp7NmbNt8v3arjTBfYELmLUV+M+nSawNNAUqpT3ClJWg5I3BLT+cGW/DXNGCa6tx1aakCGEigArTn4TDIPdrXXYKCZNrHLMCOEPvHBlLQ99s9eHB7EB6NTki73CVPQ2F5MSx/uRQixfmq7rK0wYD8w8E905bnPDfwoWs/rfv93NWN/ZfvwsLIU7A09gxECyISeGJkHAau98L97tuw7NXnoPyNF8FcYGLGKsOs0mN3OEyec9esGW/ZEl945dTP34wlR2FZVQWU1q0Cw8Tr7p+hgLLNL0FPxx/Q35mA8aEUrH6nCgwEl0tn7wUiZYJnNRh6DK4UH/k0lfyrsBKdPVv/AriGIQcEDQZ65LBAGe2Rzui9Ybjz7XUppz1/uKBbyVPGkN3ZAeC6hr0x7Nr38N5+EqkoOm17xpoqR9ohQF55ERSvr4Dkr3chNfC3DMzGJlNBElW8w9nsGQvhNGIzDkXzCg8cLK951xHsFBlTJspJNi3ZFIMF2AeDV3q8DNOB+YHi6QTrChDIWDBRi5U5f+ZMfJLu3ccrqxtdxk4SKH336LFxSmkqefwU5T8fhdSdQf9IVKD6aNiwI/hnmcAZ91isYMJIaCUCx9W098+LgruikeTqzqqxKPUwqJyCPJiyemVVZBOijDGjD38Os0jOiSPL1z3SPjXNANbiNPXAdzTfukjjuknNBbyz3nwgTd3AVFqUJ5hpHlq9MveLnWwttUfoygBmvVjuikxND3znrhsELnZk7k+OjIGxeNEkomyLVta0xxn+HZhjBc4YZ/AFjHjz9u3xRZl2BN4aq9nFwWh16IrQ1aHHEd3j1+4/dB9OtH4e29A2H1DyHQRmOSfQZ1Fy7MHBTGB6J/Djq6p3OxyO2cB+4Car7v/o3GXgfAkj23+x9ID1Teoamo/SXcbvSf2PX7Vc8DdCmE1vN9di+32P9/5YR3vLnhCVGUWBjEkr3yh4H8v9CzmsbdhzOKzsJKM90iFdaTMjRPhGVsakRvOaRidljo6H6G7j+ctrJpsP+4COhDIl0La2+FS4+5mlocBaXY5QnGZysIBYoeSsl5qQzrSj/cgNrfuEzlWBfwA+EjrZyWUvpAAAAABJRU5ErkJggg==">MySQL锁🌟<!----></h1>  <div class="theme-vdoing-content content__default"><h1 id="_220-mysql锁🌟"><a href="#_220-mysql锁🌟" class="header-anchor">#</a> 220.MySQL锁🌟</h1> <h4 id="锁基础"><a href="#锁基础" class="header-anchor">#</a> 锁基础</h4> <h5 id="_1-概述"><a href="#_1-概述" class="header-anchor">#</a> 1.概述</h5> <p><strong>锁是数据库在并发访问时保证数据一致性和完整性的主要机制</strong>。在 MySQL 中，不同存储引擎使用不同的加锁方式. 下面以 InnoDB 存储引擎为例介绍 MySQL 中的锁机制，其他存储引擎中的锁相对简单一些。</p> <p>无论何时, 只要有多个查询需要在<strong>同一时刻修改数据</strong>, 都会产生并发控制的问题. 为了解决多事务并发问题, 数据库设计了事务隔离机制, 锁机制, MVCC 多版本并发控制隔离机制, 日志机制, 用一整套机制来解决多事务并发问题.</p> <p>锁是计算机协调多个进程或线程并发访问某一资源的机制. 在数据库中, 除 CPU, I/O 等传统计算资源的争用以外, 数据也是一种供需要用户<strong>共享的资源</strong>. 如何保证数据并发访问的一致性, 有效性是所有数据库必须解决的一个问题, 锁冲突也是影响数据库并发访问性能的一个重要因素.</p> <p>MySQL 每种存储引擎都可以实现自己的锁策略和锁粒度.</p> <p>锁的根本特性: <strong>锁是和索引, 隔离级别密切相关的</strong>. 在 InnoDB 引擎里面, 锁和索引, 隔离级别都是有密切关系的. 在 InnoDB 引擎里面, 锁是依赖于索引来实现的. 或者说, 锁都是加在索引项上的. 因此, 如果一个查询用了索引, 那么会用行锁, 如果没用到任何索引, 那么就会用表锁. 此外, 在 MySQL 里面, 间隙锁和临键锁是只工作在可重复读这个隔离级别下的.</p> <h5 id="_2-释放锁时机"><a href="#_2-释放锁时机" class="header-anchor">#</a> 2.释放锁时机</h5> <p>许多人认为锁是在语句执行完毕之后就立刻释放掉的. 其实并不是, 它是在<strong>整个事务结束之后才释放</strong>的. 换句话来说, <mark><strong>当一个事务内部给数据加上锁之后, 只有在执行 Rollback 或者 Commit 的时候, 锁才会被释放掉</strong></mark>.</p> <p>​<img src="/img/147aab4d2904995f473919e089e64cca-20231223175001-s60p1oc.png" alt="">​</p> <h4 id="锁的分类"><a href="#锁的分类" class="header-anchor">#</a> 锁的分类</h4> <p>从不同角度可以对 MySQL 锁进行分类：</p> <ul><li>从对数据的操作粒度分: <strong>表锁, 行锁</strong>.</li> <li>从对数据的操作类型分: <strong>读锁</strong>和<strong>写锁</strong>(都属于悲观锁), 以及意向锁.</li> <li>从性能上分为乐观锁(用版本对比或 CAS 机制)和悲观锁, 乐观锁适合读操作较多的场景, 悲观锁适合写操作较多的场景, 如果在写操作较多的场景使用乐观锁会导致比对次数过多, 影响性能.</li></ul> <h5 id="_1-表锁与行锁"><a href="#_1-表锁与行锁" class="header-anchor">#</a> 1.表锁与行锁</h5> <p>MySQL 中的锁可以按照<mark><strong>加锁粒度</strong></mark>分为<strong>锁定整个表的表锁</strong>和<strong>锁定数据行的行锁</strong>：</p> <ul><li>表级锁具有开销小、加锁快的特性；表级锁的锁定粒度较大，发生锁冲突的概率高，支持的并发度低。</li> <li>行级锁具有开销大，加锁慢的特性；行级锁的锁定粒度较小，发生锁冲突的概率低，支持的并发度高。</li></ul> <p>行锁与表锁都是根据锁的范围来划分的. 一般来说, <mark><strong>行锁是指锁住行, 可能是锁住一行, 也可能是锁住多行. 表锁则是直接将整个表都锁住</strong></mark>.</p> <p>InnoDB 存储引擎同时支持行锁和表锁，<strong>默认情况下采用行锁</strong>。</p> <p><strong>行级锁只在存储引擎层实现</strong>, MySQL 服务器层没有实现. 服务器层完全不了解存储引擎中的锁实现.</p> <p>任何时候, 在给定的资源上, <strong>锁定的数据量越少, 则系统的并发程度越高, 只要相互之间不发生冲突即可</strong>. 所谓的锁策略, 就是在锁的开销和数据的安全性之间寻求平衡, 这种平衡当然也会影响到性能.</p> <h5 id="_2-共享锁与排他锁-读写锁"><a href="#_2-共享锁与排他锁-读写锁" class="header-anchor">#</a> 2.共享锁与排他锁(读写锁)</h5> <blockquote><p>共享锁与排他锁的定义</p></blockquote> <p>InnoDB 实现了以下两种类型的<mark><strong>行锁</strong></mark>：</p> <ul><li><strong>共享锁(读锁)</strong> ：简称 S 锁。允许获得该锁的事务<strong>读取数据行</strong>，同时允许其他事务获得该数据行上的共享锁(读锁)，并且阻止其他事务获得数据行上的排他锁(写锁)。</li> <li><strong>排他锁(写锁)</strong> ：简称 X 锁。允许获得该锁的事务<strong>更新或删除数据行</strong>，同时阻止其他事务取得该数据行上的共享锁(读锁)和排他锁(写锁)。</li></ul> <p><mark><strong>对数据行加了共享锁(读锁)之后，可以对数据行进行读取；对数据行加了排他锁(写锁)，可以对数据行进行读取和修改</strong></mark>.</p> <p>只有这样, 才能确保在给定的时间里, <strong>只有一个用户能执行写入, 并防止其他用户读取</strong>正在写入的同一资源.</p> <blockquote><p>共享锁与排他锁的兼容性</p></blockquote> <p>这两种行锁之间的兼容性如下：</p> <p>​<img src="https://nano-note.oss-cn-beijing.aliyuncs.com/images/image-20250220000044-fjpm43i.png" alt="image">​</p> <p><mark><strong>共享锁和共享锁可以兼容，排他锁和其它锁都不兼容</strong></mark>。</p> <p>例如，事务 A 获取了一行数据的共享锁，事务 B 可以立即获得该数据行的共享锁，也就是锁兼容；但是此时事务 B 如果想获得该数据行的排他锁，则必须等待事务 A 释数据行上的共享锁，此种情况存在锁冲突。</p> <blockquote><p>手动加共享锁与排他锁</p></blockquote> <p>默认情况下，数据库中的锁都可以自动获取；但是也可以<strong>手动加读写锁</strong>。</p> <table><thead><tr><th style="text-align:center;">类型</th> <th style="text-align:center;">语句</th> <th>备注</th></tr></thead> <tbody><tr><td style="text-align:center;">加共享锁(读锁)</td> <td style="text-align:center;"><mark><strong>select ... for share</strong></mark></td> <td>MySQL8.0 后的版本</td></tr> <tr><td style="text-align:center;">加共享锁(读锁)</td> <td style="text-align:center;"><mark><strong>select ... lock in share mode</strong></mark></td> <td>MySQL8.0 前的版本</td></tr> <tr><td style="text-align:center;">加排他锁(写锁)</td> <td style="text-align:center;"><mark><strong>select ... for update</strong></mark></td> <td></td></tr></tbody></table> <blockquote><p>示例</p></blockquote> <p>来看一个示例，首先创建一个表：</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">create</span> <span class="token keyword">table</span> t<span class="token punctuation">(</span>
  id <span class="token keyword">int</span> <span class="token keyword">auto_increment</span> <span class="token keyword">primary</span> <span class="token keyword">key</span><span class="token punctuation">,</span>
  c1 <span class="token keyword">int</span><span class="token punctuation">,</span>
  c2 <span class="token keyword">int</span><span class="token punctuation">,</span>
  c3 <span class="token keyword">int</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">create</span> <span class="token keyword">unique</span> <span class="token keyword">index</span> idx_t_c1 <span class="token keyword">on</span> t<span class="token punctuation">(</span>c1<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">create</span> <span class="token keyword">index</span> idx_t_c2 <span class="token keyword">on</span> t<span class="token punctuation">(</span>c2<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">insert</span> <span class="token keyword">into</span> t<span class="token punctuation">(</span>c1<span class="token punctuation">,</span>c2<span class="token punctuation">,</span>c3<span class="token punctuation">)</span> <span class="token keyword">values</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>其中，id 是主键；c1 上创建了一个唯一索引；c2 上创建了一个非唯一索引；c3 上没有索引。接下来的示例都使用 MySQL 默认的隔离级别 Repeatable Read，除非另有说明。</p> <p>然后<strong>创建两个数据库连接 T1 和 T2</strong>，先在 T1 中<strong>使用共享锁锁定一行数据</strong>：</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token comment">-- 连接T1</span>
mysql<span class="token operator">&gt;</span> <span class="token keyword">begin</span><span class="token punctuation">;</span>  <span class="token comment"># 开启一个事务</span>

mysql<span class="token operator">&gt;</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> t <span class="token keyword">where</span> id <span class="token operator">=</span> <span class="token number">1</span> <span class="token keyword">for</span> <span class="token keyword">share</span><span class="token punctuation">;</span>    <span class="token comment"># T1尝试加共享锁</span>
<span class="token operator">+</span><span class="token comment">----+------+------+------+</span>
<span class="token operator">|</span> id <span class="token operator">|</span> c1   <span class="token operator">|</span> c2   <span class="token operator">|</span> c3   <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+------+------+------+</span>
<span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span>    <span class="token number">1</span> <span class="token operator">|</span>    <span class="token number">1</span> <span class="token operator">|</span>    <span class="token number">1</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+------+------+------+</span>
<span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>        <span class="token comment"># 加共享锁成功并读取到数据</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>在事务中使用 <code>select ... for share</code>​ 语句获得了数据行 id = 1 上的共享锁。由于 InnoDB 中的自动提交 autocommit 默认设置为 ON，所以必须在事务中为数据行加锁；或者将 autocommit 设置为 OFF。</p> <p>然后在 T2 中执行以下语句同样尝试对 id = 1 的数据行加<strong>共享锁</strong>：</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token comment">-- 连接T2</span>
mysql<span class="token operator">&gt;</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> t <span class="token keyword">where</span> id <span class="token operator">=</span> <span class="token number">1</span> <span class="token keyword">for</span> <span class="token keyword">share</span><span class="token punctuation">;</span>    <span class="token comment"># T2也尝试对id=1加共享锁</span>
<span class="token operator">+</span><span class="token comment">----+------+------+------+</span>
<span class="token operator">|</span> id <span class="token operator">|</span> c1   <span class="token operator">|</span> c2   <span class="token operator">|</span> c3   <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+------+------+------+</span>
<span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span>    <span class="token number">1</span> <span class="token operator">|</span>    <span class="token number">1</span> <span class="token operator">|</span>    <span class="token number">1</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+------+------+------+</span>
<span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>    <span class="token comment"># 加共享锁成功并读取到数据</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>结果显示，在 T2 中成功获取改行数据上的共享锁。然后尝试使用 <code>select ... for update</code>​ 命令获取排他锁：</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token comment">-- 连接T2</span>
mysql<span class="token operator">&gt;</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> t <span class="token keyword">where</span> id <span class="token operator">=</span> <span class="token number">1</span> <span class="token keyword">for</span> <span class="token keyword">update</span><span class="token punctuation">;</span>    <span class="token comment"># 尝试获取id=1数据行的排他锁</span>
ERROR <span class="token number">1205</span> <span class="token punctuation">(</span>HY000<span class="token punctuation">)</span>: <span class="token keyword">Lock</span> wait timeout exceeded<span class="token punctuation">;</span> try restarting <span class="token keyword">transaction</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>此时该命令会一直处于等待状态并且最终超时。也就是说共享锁和排他锁不兼容。</p> <h5 id="_3-意向锁"><a href="#_3-意向锁" class="header-anchor">#</a> 3.意向锁</h5> <blockquote><p>意向锁的引入与使用场景</p></blockquote> <p>InnoDB 除了支持行级锁，还支持<strong>由 MySQL 服务层实现的</strong>​<mark><strong>表级锁</strong></mark>(LOCK TABLES ... WRITE 在指定的表加上表级排他锁)。<strong>当这两种锁同时存在时，可能导致冲突</strong>。</p> <p>在 MySQL 里面, <strong>使用意向锁的典型场景是在增删改查的时候, 对表结构定义加一个意向共享锁, 防止在查询的时候有人修改表结构. 而在修改表结构的时候, 则会加一个意向排它锁. 这也就是修改表结构的时候会直接阻塞掉所有的增删改查语句的原因</strong>. 使用意向锁能够提高数据库的并发性能, 并且避免死锁问题.</p> <p>例如，事务 A 获取了<strong>表中一行数据的共享锁(读锁)</strong> ；然后事务 B 申请该<strong>表的排他锁(写锁)(例如修改表的结构)</strong> 。如果事务 B 加锁成功，那么它就应该能修改表中的任意数据行，<strong>但是 A 持有的行锁不允许修改锁定的数据行。显然数据库需要避免这种问题，B 的加锁申请需要等待 A 释放行锁</strong>。</p> <p>​<img src="https://nano-note.oss-cn-beijing.aliyuncs.com/images/image-20250220093017-66kjy59.png" alt="image">​</p> <p>那么如何判断事务 B 是否应该获取表级锁呢？首先需要看该表是否已经被其他事务加上了表级锁，然后<strong>依次查看该表中的每一行是否已经被其他事务加上了行级锁</strong>。这种方式需要<strong>遍历整个表中的记录</strong>，效率很低。为此，InnoDB 引入了另外一种锁：<strong>意向锁</strong>(Intention Lock)。</p> <blockquote><p>定义</p></blockquote> <p><mark><strong>意向锁属于表级锁(注意!!)，由 InnoDB 自动添加. 比如给某行数据加写锁，那么就会为整个表加上意向排他锁</strong></mark>。</p> <p><mark><strong>意向锁的主要作用是表明某个事务正在或者即将给表中的数据行加行锁</strong></mark>。</p> <p>意向锁也分为共享和排他两种方式：</p> <ul><li><strong>意向共享锁</strong>(IS)：事务在<strong>给</strong>​<mark><strong>数据行</strong></mark>​<strong>加行级共享锁之前，必须先取得</strong>​<mark><strong>该表</strong></mark>​<strong>的 IS 锁</strong>。</li> <li><strong>意向排他锁</strong>(IX)：事务在<strong>给</strong>​<mark><strong>数据行</strong></mark>​<strong>加行级排他锁之前，必须先取得</strong>​<mark><strong>该表</strong></mark>​<strong>的 IX 锁</strong>。</li></ul> <p>再看上面的例子，此时，事务 A 必须<strong>先申请该表的意向共享锁</strong>，成功后再申请数据行的行锁。事务 B 申请表锁时，数据库<strong>查看该表是否已经被其他事务加上了表级锁</strong>；如果发现该表上存在意向共享锁，说明表中某些数据行上存在共享锁，事务 B 申请的写锁会被阻塞。</p> <p>​<img src="https://nano-note.oss-cn-beijing.aliyuncs.com/images/image-20250220093033-axh7bc2.png" alt="image">​</p> <p><strong>当有事务给数据行加了读锁或写锁时, 同时会给表设置一个标识, 代表已经有行锁了</strong>, 其他事务要想对表加表锁时, 就不必逐行判断有没有行锁可能跟表锁冲突了, 直接读这个标识就可以确定自己该不该加表锁. <strong>这个标识就是意向锁</strong>.</p> <p>注意, 意向锁的意向强调的就是想要拿到这个锁, 但是<strong>最终能否拿到这个锁是不确定的</strong>.</p> <blockquote><p>意向锁的兼容性</p></blockquote> <p>因此，意向锁是为了<strong>使得行锁和表锁能够共存，从而实现多粒度的锁机制</strong>。以下是<strong>表级锁</strong>和<strong>表级意向锁</strong>的兼容性：</p> <p>​<img src="https://nano-note.oss-cn-beijing.aliyuncs.com/images/image-20250220090837-cdt1x77.png" alt="image">​</p> <p>简单来说，<strong>意向锁和行锁之间只有共享锁兼容，意向锁和意向锁之间都可以兼容</strong>。</p> <blockquote><p>示例1：排他锁与意向排他锁的冲突</p></blockquote> <p>以<strong>意向排他锁</strong> IX 为例，继续上面的示例。先在 T1 中执行以下加锁语句：</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token comment">-- 连接T1</span>
mysql<span class="token operator">&gt;</span> <span class="token keyword">begin</span><span class="token punctuation">;</span>
Query OK<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>

mysql<span class="token operator">&gt;</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> t <span class="token keyword">where</span> id <span class="token operator">=</span> <span class="token number">1</span> <span class="token keyword">for</span> <span class="token keyword">update</span><span class="token punctuation">;</span>  <span class="token comment"># 加排他锁</span>
<span class="token operator">+</span><span class="token comment">----+------+------+------+</span>
<span class="token operator">|</span> id <span class="token operator">|</span> c1   <span class="token operator">|</span> c2   <span class="token operator">|</span> c3   <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+------+------+------+</span>
<span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span>    <span class="token number">1</span> <span class="token operator">|</span>    <span class="token number">1</span> <span class="token operator">|</span>    <span class="token number">1</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+------+------+------+</span>
<span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>        <span class="token comment"># 加排他锁成功并读取到数据，同时InnoDB也给表加上了意向排他锁!</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>在事务中<strong>为表 t 中的数据行 id = 1 加上了排他锁，同时会为表 t 加上意向排他锁</strong>。然后在 T2 中执行以下语句：</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token comment">-- 连接T2</span>
mysql<span class="token operator">&gt;</span> <span class="token keyword">lock</span> <span class="token keyword">tables</span> t <span class="token keyword">read</span><span class="token punctuation">;</span> <span class="token comment">-- lock tables t write;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>​<code>lock tables ... read</code>​ 语句用于为表 t 加上<strong>表级共享锁</strong>；因为意向排他锁和表级共享锁冲突，所以 T2 一直等待 T1 释放锁。也可以使用 <code>lock tables ... write</code>​ 语句为表 t 加上<strong>表级排他锁</strong>；因为意向排他锁和表级排他锁冲突，所以该语句也会一直等待 T1 释放锁。</p> <p>当在 T1 中提交或者回滚事务：</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token comment">-- 连接T1</span>
mysql<span class="token operator">&gt;</span> <span class="token keyword">commit</span><span class="token punctuation">;</span>    <span class="token comment"># 提交事务</span>
Query OK<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p><strong>T2 自动获得该表上的共享锁</strong>：</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token comment">-- 连接T2</span>
Query OK<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">1</span> min <span class="token number">43.17</span> sec<span class="token punctuation">)</span>

mysql<span class="token operator">&gt;</span> <span class="token keyword">unlock</span> <span class="token keyword">tables</span><span class="token punctuation">;</span>
Query OK<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>以上的 <code>unlock tables</code>​ 语句用于释放该表上的排他锁。</p> <blockquote><p>示例2：意向排他锁之间的兼容性</p></blockquote> <p>再来验证一下<strong>两个意向排他锁之间锁的兼容性</strong>，先在 T1 中执行以下加锁语句：</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token comment">-- 连接T1</span>
mysql<span class="token operator">&gt;</span> <span class="token keyword">begin</span><span class="token punctuation">;</span>
Query OK<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>

mysql<span class="token operator">&gt;</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> t <span class="token keyword">where</span> id <span class="token operator">=</span> <span class="token number">1</span> <span class="token keyword">for</span> <span class="token keyword">update</span><span class="token punctuation">;</span>  <span class="token comment"># 加排他锁</span>
<span class="token operator">+</span><span class="token comment">----+------+------+------+</span>
<span class="token operator">|</span> id <span class="token operator">|</span> c1   <span class="token operator">|</span> c2   <span class="token operator">|</span> c3   <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+------+------+------+</span>
<span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span>    <span class="token number">1</span> <span class="token operator">|</span>    <span class="token number">1</span> <span class="token operator">|</span>    <span class="token number">1</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+------+------+------+</span>
<span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>  <span class="token comment"># 加排他锁成功并读取到数据，同时InnoDB也给表加上了意向排他锁!</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p><strong>==T1 为数据行 id = 1 上的排他锁，并且给表 t 加上了意向排他锁==</strong>。然后在 T2 中执行以下语句：</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token comment">-- 连接T2</span>
mysql<span class="token operator">&gt;</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> t <span class="token keyword">where</span> id <span class="token operator">=</span> <span class="token number">2</span> <span class="token keyword">for</span> <span class="token keyword">update</span><span class="token punctuation">;</span>  
<span class="token operator">+</span><span class="token comment">----+------+------+------+</span>
<span class="token operator">|</span> id <span class="token operator">|</span> c1   <span class="token operator">|</span> c2   <span class="token operator">|</span> c3   <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+------+------+------+</span>
<span class="token operator">|</span>  <span class="token number">2</span> <span class="token operator">|</span>    <span class="token number">2</span> <span class="token operator">|</span>    <span class="token number">3</span> <span class="token operator">|</span>    <span class="token number">4</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+------+------+------+</span>
<span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p><strong>==T2 成功为数据行 id = 2 加上的排他锁，同时为表 t 加上了意向排他锁==</strong>。也就是说，T1 和 T2 同时获得了表 t 上的意向排他锁，以及不同数据行上的行级排他锁。<strong>InnoDB 通过行级锁，实现了更细粒度的控制，能够支持更高的并发更新和查询</strong>。</p> <p>最后在 T1 中提交或者回滚事务：</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token comment">-- 连接T1</span>
mysql<span class="token operator">&gt;</span> <span class="token keyword">commit</span><span class="token punctuation">;</span>
Query OK<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h4 id="锁的实现"><a href="#锁的实现" class="header-anchor">#</a> 锁的实现</h4> <p><mark><strong>InnoDB 的行锁实际上是针对索引加的锁(在索引对应的索引项上做标记), 不是针对整个行记录加的锁. 并且该索引不能失效, 否则会从行锁升级为表锁</strong></mark>.</p> <p><mark><strong>InnoDB 实现了三种行锁的算法：记录锁(Record Lock)、间隙锁(Gap Lock) 和 Next-key 锁(Next-key Lock) 又称临键锁</strong></mark>。</p> <p><strong>其中间隙锁只在 RR 隔离级别下生效，其目的是为了防止产生幻读。Next-key 锁（Next-key Lock）相当于一个索引记录锁加上该记录之前的一个间隙锁</strong>。</p> <h5 id="_1-记录锁"><a href="#_1-记录锁" class="header-anchor">#</a> 1.记录锁</h5> <h6 id="基础"><a href="#基础" class="header-anchor">#</a> 基础</h6> <p><strong>记录锁是指锁住了特定的某一条记录的锁</strong>. <strong>记录锁（Record Lock）是针对索引记录（index record）的锁定，可以实现对单个行记录加锁</strong>。</p> <p>InnoDB 实现行级锁的方式如下：当搜索或扫描表索引时，在遇到的索引记录上设置共享锁或排它锁。因此，InnoDB <strong>行级锁实际上是索引记录锁</strong>。</p> <p>例如这样一条语句:</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> your_tab <span class="token keyword">WHERE</span> id <span class="token operator">=</span> <span class="token number">31</span> <span class="token keyword">FOR</span> <span class="token keyword">UPDATE</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>在使用了<strong>主键</strong>作为查询条件, 并且是相等条件下, <strong>将只命中一条记录</strong>. 这一条记录就会被加上记录锁. 同时会阻止其他事务对 id = 31 的数据执行插入、更新，以及删除操作。</p> <p>​<img src="/img/57af4ccedf9b2270decb19235c8a4e08-20231223175001-x2ggvy9.png" alt="图片">​</p> <p>但是<strong>如果查询条件没有命中任何记录, 那么就不会使用记录锁, 而是使用间隙锁</strong>. 又或者使用了唯一索引作为条件, 比如说在 user 表里面在列 email 上有一个唯一索引.</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> your_tab <span class="token keyword">WHERE</span> email<span class="token operator">=</span><span class="token string">'your_email'</span> <span class="token keyword">FOR</span> <span class="token keyword">UPDATE</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>那么这条查询语句此时也是使用了记录锁. 类似地, 如果 email='your_email' 这条记录不存在, 那么会变成一个间隙锁.</p> <p>举个例子, 如果数据库中只有 id 为(1, 4, 7)的三条记录, 也就是 id = 3 这个条件没有命中任何数据, 那么这条语句会在 (1, 4) 加上间隙锁. 所以可以看到, <strong>在生产环境里面遇到了未命中索引的情况, 对性能影响极大</strong>.</p> <h6 id="示例"><a href="#示例" class="header-anchor">#</a> 示例</h6> <blockquote><p>示例1：通过主键操作单个值</p></blockquote> <p>id 是表 t 的主键，先在 T1 中执行以下命令：</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token comment">-- T1</span>
mysql<span class="token operator">&gt;</span> <span class="token keyword">SET</span> <span class="token keyword">GLOBAL</span> innodb_status_output<span class="token operator">=</span><span class="token keyword">ON</span><span class="token punctuation">;</span>
Query OK<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>

mysql<span class="token operator">&gt;</span> <span class="token keyword">SET</span> <span class="token keyword">GLOBAL</span> innodb_status_output_locks<span class="token operator">=</span><span class="token keyword">ON</span><span class="token punctuation">;</span>
Query OK<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>

mysql<span class="token operator">&gt;</span> <span class="token keyword">begin</span><span class="token punctuation">;</span>
Query OK<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>

mysql<span class="token operator">&gt;</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> t <span class="token keyword">WHERE</span> id <span class="token operator">=</span> <span class="token number">1</span> <span class="token keyword">FOR</span> <span class="token keyword">UPDATE</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">----+------+------+------+</span>
<span class="token operator">|</span> id <span class="token operator">|</span> c1   <span class="token operator">|</span> c2   <span class="token operator">|</span> c3   <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+------+------+------+</span>
<span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span>    <span class="token number">1</span> <span class="token operator">|</span>    <span class="token number">1</span> <span class="token operator">|</span>    <span class="token number">1</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+------+------+------+</span>
<span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>全局变量 innodb_status_output 和 innodb_status_output_locks 用于控制 InnoDB 标准监控和锁监控，可以利用监控查看锁的使用情况。<strong>然后 T1 锁定了 id = 1 的记录</strong>，此时 T2 无法修改该记录：</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token comment">-- T2</span>
mysql<span class="token operator">&gt;</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> t <span class="token keyword">WHERE</span> id <span class="token operator">=</span> <span class="token number">1</span> <span class="token keyword">for</span> <span class="token keyword">update</span><span class="token punctuation">;</span>
ERROR <span class="token number">1205</span> <span class="token punctuation">(</span>HY000<span class="token punctuation">)</span>: <span class="token keyword">Lock</span> wait timeout exceeded<span class="token punctuation">;</span> try restarting <span class="token keyword">transaction</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>使用 <code>SHOW ENGINE INNODB STATUS</code>​ 命令查看 InnoDB 监控中关于锁的事务数据，可以看到以下内容：</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token comment">---TRANSACTION 43764, ACTIVE 4 sec</span>
<span class="token number">2</span> <span class="token keyword">lock</span> struct<span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">,</span> heap size <span class="token number">1136</span><span class="token punctuation">,</span> <span class="token number">1</span> <span class="token keyword">row</span> <span class="token keyword">lock</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>
MySQL thread id <span class="token number">103</span><span class="token punctuation">,</span> OS thread handle <span class="token number">140437513750272</span><span class="token punctuation">,</span> query id <span class="token number">23734</span> localhost root
<span class="token keyword">TABLE</span> <span class="token keyword">LOCK</span> <span class="token keyword">table</span> <span class="token identifier"><span class="token punctuation">`</span>hrdb<span class="token punctuation">`</span></span><span class="token punctuation">.</span><span class="token identifier"><span class="token punctuation">`</span>t<span class="token punctuation">`</span></span> trx id <span class="token number">43764</span> <span class="token keyword">lock</span> <span class="token keyword">mode</span> IX
RECORD LOCKS space id <span class="token number">101</span> page <span class="token keyword">no</span> <span class="token number">4</span> n bits <span class="token number">72</span> <span class="token keyword">index</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">of</span> <span class="token keyword">table</span> <span class="token identifier"><span class="token punctuation">`</span>hrdb<span class="token punctuation">`</span></span><span class="token punctuation">.</span><span class="token identifier"><span class="token punctuation">`</span>t<span class="token punctuation">`</span></span> trx id <span class="token number">43764</span> lock_mode X locks rec but <span class="token operator">not</span> gap
Record <span class="token keyword">lock</span><span class="token punctuation">,</span> heap <span class="token keyword">no</span> <span class="token number">2</span> PHYSICAL RECORD: n_fields <span class="token number">6</span><span class="token punctuation">;</span> compact format<span class="token punctuation">;</span> info bits <span class="token number">0</span>
 <span class="token number">0</span>: len <span class="token number">4</span><span class="token punctuation">;</span> hex <span class="token number">80000001</span><span class="token punctuation">;</span> <span class="token keyword">asc</span>     <span class="token punctuation">;</span><span class="token punctuation">;</span>
 <span class="token number">1</span>: len <span class="token number">6</span><span class="token punctuation">;</span> hex <span class="token number">00000000</span>aaec<span class="token punctuation">;</span> <span class="token keyword">asc</span>       <span class="token punctuation">;</span><span class="token punctuation">;</span>
 <span class="token number">2</span>: len <span class="token number">7</span><span class="token punctuation">;</span> hex <span class="token number">820000008</span>f0110<span class="token punctuation">;</span> <span class="token keyword">asc</span>        <span class="token punctuation">;</span><span class="token punctuation">;</span>
 <span class="token number">3</span>: len <span class="token number">4</span><span class="token punctuation">;</span> hex <span class="token number">80000001</span><span class="token punctuation">;</span> <span class="token keyword">asc</span>     <span class="token punctuation">;</span><span class="token punctuation">;</span>
 <span class="token number">4</span>: len <span class="token number">4</span><span class="token punctuation">;</span> hex <span class="token number">80000001</span><span class="token punctuation">;</span> <span class="token keyword">asc</span>     <span class="token punctuation">;</span><span class="token punctuation">;</span>
 <span class="token number">5</span>: len <span class="token number">4</span><span class="token punctuation">;</span> hex <span class="token number">80000001</span><span class="token punctuation">;</span> <span class="token keyword">asc</span>     <span class="token punctuation">;</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p><strong>日志显示存在 2 个锁结构，锁定了一个记录；表 t 上存在 IX 锁，主键索引上存在一个 X 记录锁，同时还显示了记录对应的数据值</strong>。注意 <code>but not gap</code>​，下文会介绍间隙锁(Gap Lock)。最后在 T1 中释放锁：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>-- T1
mysql&gt; commit;
Query OK, 0 rows affected (0.00 sec)
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><blockquote><p>示例2：通过唯一索引操作单个值</p></blockquote> <p>c1 字段上存在唯一索引，先在 T1 中执行以下命令：</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token comment">-- T1</span>
mysql<span class="token operator">&gt;</span> <span class="token keyword">begin</span><span class="token punctuation">;</span>
Query OK<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>

mysql<span class="token operator">&gt;</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> t <span class="token keyword">WHERE</span> c1 <span class="token operator">=</span> <span class="token number">1</span> <span class="token keyword">FOR</span> <span class="token keyword">UPDATE</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">----+------+------+------+</span>
<span class="token operator">|</span> id <span class="token operator">|</span> c1   <span class="token operator">|</span> c2   <span class="token operator">|</span> c3   <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+------+------+------+</span>
<span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span>    <span class="token number">1</span> <span class="token operator">|</span>    <span class="token number">1</span> <span class="token operator">|</span>    <span class="token number">1</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+------+------+------+</span>
<span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>使用 <code>SHOW ENGINE INNODB STATUS</code>​ 命令查看 InnoDB 监控中关于<strong>锁的事务数据</strong>，可以看到以下内容：</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token comment">---TRANSACTION 43761, ACTIVE 47 sec</span>
<span class="token number">3</span> <span class="token keyword">lock</span> struct<span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">,</span> heap size <span class="token number">1136</span><span class="token punctuation">,</span> <span class="token number">2</span> <span class="token keyword">row</span> <span class="token keyword">lock</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>
MySQL thread id <span class="token number">103</span><span class="token punctuation">,</span> OS thread handle <span class="token number">140437513750272</span><span class="token punctuation">,</span> query id <span class="token number">23722</span> localhost root
<span class="token keyword">TABLE</span> <span class="token keyword">LOCK</span> <span class="token keyword">table</span> <span class="token identifier"><span class="token punctuation">`</span>hrdb<span class="token punctuation">`</span></span><span class="token punctuation">.</span><span class="token identifier"><span class="token punctuation">`</span>t<span class="token punctuation">`</span></span> trx id <span class="token number">43761</span> <span class="token keyword">lock</span> <span class="token keyword">mode</span> IX
RECORD LOCKS space id <span class="token number">101</span> page <span class="token keyword">no</span> <span class="token number">5</span> n bits <span class="token number">72</span> <span class="token keyword">index</span> idx_t_c1 <span class="token keyword">of</span> <span class="token keyword">table</span> <span class="token identifier"><span class="token punctuation">`</span>hrdb<span class="token punctuation">`</span></span><span class="token punctuation">.</span><span class="token identifier"><span class="token punctuation">`</span>t<span class="token punctuation">`</span></span> trx id <span class="token number">43761</span> lock_mode X locks rec but <span class="token operator">not</span> gap
Record <span class="token keyword">lock</span><span class="token punctuation">,</span> heap <span class="token keyword">no</span> <span class="token number">2</span> PHYSICAL RECORD: n_fields <span class="token number">2</span><span class="token punctuation">;</span> compact format<span class="token punctuation">;</span> info bits <span class="token number">0</span>
 <span class="token number">0</span>: len <span class="token number">4</span><span class="token punctuation">;</span> hex <span class="token number">80000001</span><span class="token punctuation">;</span> <span class="token keyword">asc</span>     <span class="token punctuation">;</span><span class="token punctuation">;</span>
 <span class="token number">1</span>: len <span class="token number">4</span><span class="token punctuation">;</span> hex <span class="token number">80000001</span><span class="token punctuation">;</span> <span class="token keyword">asc</span>     <span class="token punctuation">;</span><span class="token punctuation">;</span>

RECORD LOCKS space id <span class="token number">101</span> page <span class="token keyword">no</span> <span class="token number">4</span> n bits <span class="token number">72</span> <span class="token keyword">index</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">of</span> <span class="token keyword">table</span> <span class="token identifier"><span class="token punctuation">`</span>hrdb<span class="token punctuation">`</span></span><span class="token punctuation">.</span><span class="token identifier"><span class="token punctuation">`</span>t<span class="token punctuation">`</span></span> trx id <span class="token number">43761</span> lock_mode X locks rec but <span class="token operator">not</span> gap
Record <span class="token keyword">lock</span><span class="token punctuation">,</span> heap <span class="token keyword">no</span> <span class="token number">2</span> PHYSICAL RECORD: n_fields <span class="token number">6</span><span class="token punctuation">;</span> compact format<span class="token punctuation">;</span> info bits <span class="token number">0</span>
 <span class="token number">0</span>: len <span class="token number">4</span><span class="token punctuation">;</span> hex <span class="token number">80000001</span><span class="token punctuation">;</span> <span class="token keyword">asc</span>     <span class="token punctuation">;</span><span class="token punctuation">;</span>
 <span class="token number">1</span>: len <span class="token number">6</span><span class="token punctuation">;</span> hex <span class="token number">00000000</span>aaec<span class="token punctuation">;</span> <span class="token keyword">asc</span>       <span class="token punctuation">;</span><span class="token punctuation">;</span>
 <span class="token number">2</span>: len <span class="token number">7</span><span class="token punctuation">;</span> hex <span class="token number">820000008</span>f0110<span class="token punctuation">;</span> <span class="token keyword">asc</span>        <span class="token punctuation">;</span><span class="token punctuation">;</span>
 <span class="token number">3</span>: len <span class="token number">4</span><span class="token punctuation">;</span> hex <span class="token number">80000001</span><span class="token punctuation">;</span> <span class="token keyword">asc</span>     <span class="token punctuation">;</span><span class="token punctuation">;</span>
 <span class="token number">4</span>: len <span class="token number">4</span><span class="token punctuation">;</span> hex <span class="token number">80000001</span><span class="token punctuation">;</span> <span class="token keyword">asc</span>     <span class="token punctuation">;</span><span class="token punctuation">;</span>
 <span class="token number">5</span>: len <span class="token number">4</span><span class="token punctuation">;</span> hex <span class="token number">80000001</span><span class="token punctuation">;</span> <span class="token keyword">asc</span>     <span class="token punctuation">;</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p><strong>日志显示存在 3 个锁结构，锁定了 2 个记录；表 t 上存在 IX 锁，索引 idx_t_c1 上存在一个 X 记录锁，主键索引上存在一个 X 记录锁</strong>。最后在 T1 中释放锁：</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token comment">-- T1</span>
mysql<span class="token operator">&gt;</span> <span class="token keyword">commit</span><span class="token punctuation">;</span>
Query OK<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p><mark><strong>记录锁永远都是锁定索引记录，锁定非聚集索引会先锁定聚集索引</strong></mark>。如果表中没有定义索引，InnoDB 默认为表创建一个隐藏的聚簇索引，并且使用该索引锁定记录。</p> <h5 id="_2-间隙锁"><a href="#_2-间隙锁" class="header-anchor">#</a> 2.间隙锁</h5> <h6 id="基础-2"><a href="#基础-2" class="header-anchor">#</a> 基础</h6> <p><strong>间隙锁是锁住了某一段记录的锁</strong>. 直观来说就是锁住了一个范围的记录. 比如在查询的时候使用了 <code>&lt;, &lt;=, BETWEEN</code>​ 之类的范围查询条件, 就会使用间隙锁.</p> <p><mark><strong>间隙锁(Gap Lock)锁定的是索引记录之间的间隙、第一个索引之前的间隙或者最后一个索引之后的间隙</strong></mark>。间隙锁<strong>锁定一个范围, 也就是锁定索引之间的间隙, 但是不包含索引本身</strong>. 只要在间隙范围内锁了一条不存在的记录会锁住整个间隙范围, 不锁边界记录, 这样就能防止其它 Session 在这个间隙范围内插入数据, 就解决了可重复读隔离级别的幻读问题.</p> <p>例如当一个事务执行以下语句。</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> your_tab <span class="token keyword">WHERE</span> id <span class="token operator">BETWEEN</span> <span class="token number">50</span> <span class="token operator">AND</span> <span class="token number">100</span> <span class="token keyword">FOR</span> <span class="token keyword">UPDATE</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>如果表里面没有 50, 那么数据库就会<strong>一直向左</strong>, 找到第一个存在的数据, 比如说 40; 如果表里面没有 100, 那么数据库就会<strong>一直向右</strong>, 找到第一个存在的数据, 比如说 120. 那么使用的间隙锁就是 (40, 120). 如果此时其他事务想要插入一个主键为 70 的行, 是无法插入的, 它需要<strong>等这个 SELECT 语句释放掉间隙锁</strong>.</p> <blockquote><p>产生间隙锁的场景</p></blockquote> <ol><li>使用普通索引锁定；在普通索引列上，不管是何种查询，只要加锁，都会产生间隙锁。</li> <li>使用多列唯一索引会产生间隙锁。</li> <li>使用唯一索引锁定多行记录(范围查找)。</li> <li>使用唯一索引，对于指定查询某一条记录的加锁语句，如果该记录不存在，会产生记录锁和间隙锁，如果记录存在，则只会产生记录锁。</li></ol> <blockquote><p>间隙锁的互斥性</p></blockquote> <p><mark><strong>InnoDB 间隙锁的唯一目的是阻止其他事务在间隙中插入数据</strong></mark>.</p> <p><strong>记录锁和记录锁是排它的, 但是间隙锁可以共存，一个事务的间隙锁不会阻止另一个事务在同一个间隙上获取间隙锁</strong>. 也就是说两个间隙锁之间即便重叠了, 也还是可以加锁成功的. 共享间隙锁和排他间隙锁之间没有区别，彼此不冲突，它们的作用相同。</p> <p>​<img src="https://nano-note.oss-cn-beijing.aliyuncs.com/images/4a3e1d90160bb31cd91edcd720dcbac9-20231223175001-h15ww8v.png" alt="图片">​</p> <p>因此，<strong>不同事务可以获取一个间隙上互相冲突的锁</strong>。例如，事务 A 在一个间隙上获取了共享的间隙锁（间隙 S 锁），事务 B 可以在同一间隙上获取排他的间隙锁（间隙 X 锁）。允许存在互相冲突的间隙锁的原因在于，如果从索引中清除某个记录，必须合并不同事务在记录上获取的间隙锁。</p> <p>间隙锁在<strong>可重复读</strong>隔离级别下才会生效. 间隙锁可以显式禁用，例如将事务隔离级别设置为 READ COMMITTED。此时，查找和索引扫描不会使用间隙锁，间隙锁只用于外键约束和重复键的检查。</p> <h6 id="示例-2"><a href="#示例-2" class="header-anchor">#</a> 示例</h6> <blockquote><p>示例1：通过主键操作范围值</p></blockquote> <p>首先在 T1 中执行以下命令<strong>锁住数据范围</strong>：</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token comment">-- T1</span>
mysql<span class="token operator">&gt;</span> <span class="token keyword">begin</span><span class="token punctuation">;</span>
Query OK<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>

mysql<span class="token operator">&gt;</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> t <span class="token keyword">WHERE</span> id <span class="token operator">BETWEEN</span> <span class="token number">1</span> <span class="token operator">and</span> <span class="token number">10</span> <span class="token keyword">FOR</span> <span class="token keyword">UPDATE</span><span class="token punctuation">;</span>  <span class="token comment"># 锁住范围数据</span>
<span class="token operator">+</span><span class="token comment">----+------+------+------+</span>
<span class="token operator">|</span> id <span class="token operator">|</span> c1   <span class="token operator">|</span> c2   <span class="token operator">|</span> c3   <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+------+------+------+</span>
<span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span>    <span class="token number">1</span> <span class="token operator">|</span>    <span class="token number">1</span> <span class="token operator">|</span>    <span class="token number">1</span> <span class="token operator">|</span>
<span class="token operator">|</span>  <span class="token number">2</span> <span class="token operator">|</span>    <span class="token number">2</span> <span class="token operator">|</span>    <span class="token number">3</span> <span class="token operator">|</span>    <span class="token number">4</span> <span class="token operator">|</span>
<span class="token operator">|</span>  <span class="token number">3</span> <span class="token operator">|</span>    <span class="token number">3</span> <span class="token operator">|</span>    <span class="token number">6</span> <span class="token operator">|</span>    <span class="token number">9</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+------+------+------+</span>
<span class="token number">3</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>表 t 中只有 3 条记录，id = 4 的记录不存在；即便如此，<strong>T2 仍然无法插入该记录</strong>：</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token comment">-- T2</span>
mysql<span class="token operator">&gt;</span> <span class="token keyword">insert</span> <span class="token keyword">into</span> t<span class="token punctuation">(</span>c1<span class="token punctuation">,</span>c2<span class="token punctuation">,</span>c3<span class="token punctuation">)</span> <span class="token keyword">values</span> <span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
ERROR <span class="token number">1205</span> <span class="token punctuation">(</span>HY000<span class="token punctuation">)</span>: <span class="token keyword">Lock</span> wait timeout exceeded<span class="token punctuation">;</span> try restarting <span class="token keyword">transaction</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>再次使用 <code>SHOW ENGINE INNODB STATUS</code>​ 命令查看 InnoDB 监控中关于锁的事务数据，可以看到以下内容：</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token comment">---TRANSACTION 43765, ACTIVE 4 sec</span>
<span class="token number">3</span> <span class="token keyword">lock</span> struct<span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">,</span> heap size <span class="token number">1136</span><span class="token punctuation">,</span> <span class="token number">4</span> <span class="token keyword">row</span> <span class="token keyword">lock</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>
MySQL thread id <span class="token number">103</span><span class="token punctuation">,</span> OS thread handle <span class="token number">140437513750272</span><span class="token punctuation">,</span> query id <span class="token number">23741</span> localhost root
<span class="token keyword">TABLE</span> <span class="token keyword">LOCK</span> <span class="token keyword">table</span> <span class="token identifier"><span class="token punctuation">`</span>hrdb<span class="token punctuation">`</span></span><span class="token punctuation">.</span><span class="token identifier"><span class="token punctuation">`</span>t<span class="token punctuation">`</span></span> trx id <span class="token number">43765</span> <span class="token keyword">lock</span> <span class="token keyword">mode</span> IX
RECORD LOCKS space id <span class="token number">101</span> page <span class="token keyword">no</span> <span class="token number">4</span> n bits <span class="token number">72</span> <span class="token keyword">index</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">of</span> <span class="token keyword">table</span> <span class="token identifier"><span class="token punctuation">`</span>hrdb<span class="token punctuation">`</span></span><span class="token punctuation">.</span><span class="token identifier"><span class="token punctuation">`</span>t<span class="token punctuation">`</span></span> trx id <span class="token number">43765</span> lock_mode X locks rec but <span class="token operator">not</span> gap
Record <span class="token keyword">lock</span><span class="token punctuation">,</span> heap <span class="token keyword">no</span> <span class="token number">2</span> PHYSICAL RECORD: n_fields <span class="token number">6</span><span class="token punctuation">;</span> compact format<span class="token punctuation">;</span> info bits <span class="token number">0</span>
 <span class="token number">0</span>: len <span class="token number">4</span><span class="token punctuation">;</span> hex <span class="token number">80000001</span><span class="token punctuation">;</span> <span class="token keyword">asc</span>     <span class="token punctuation">;</span><span class="token punctuation">;</span>
 <span class="token number">1</span>: len <span class="token number">6</span><span class="token punctuation">;</span> hex <span class="token number">00000000</span>aaec<span class="token punctuation">;</span> <span class="token keyword">asc</span>       <span class="token punctuation">;</span><span class="token punctuation">;</span>
 <span class="token number">2</span>: len <span class="token number">7</span><span class="token punctuation">;</span> hex <span class="token number">820000008</span>f0110<span class="token punctuation">;</span> <span class="token keyword">asc</span>        <span class="token punctuation">;</span><span class="token punctuation">;</span>
 <span class="token number">3</span>: len <span class="token number">4</span><span class="token punctuation">;</span> hex <span class="token number">80000001</span><span class="token punctuation">;</span> <span class="token keyword">asc</span>     <span class="token punctuation">;</span><span class="token punctuation">;</span>
 <span class="token number">4</span>: len <span class="token number">4</span><span class="token punctuation">;</span> hex <span class="token number">80000001</span><span class="token punctuation">;</span> <span class="token keyword">asc</span>     <span class="token punctuation">;</span><span class="token punctuation">;</span>
 <span class="token number">5</span>: len <span class="token number">4</span><span class="token punctuation">;</span> hex <span class="token number">80000001</span><span class="token punctuation">;</span> <span class="token keyword">asc</span>     <span class="token punctuation">;</span><span class="token punctuation">;</span>

RECORD LOCKS space id <span class="token number">101</span> page <span class="token keyword">no</span> <span class="token number">4</span> n bits <span class="token number">72</span> <span class="token keyword">index</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">of</span> <span class="token keyword">table</span> <span class="token identifier"><span class="token punctuation">`</span>hrdb<span class="token punctuation">`</span></span><span class="token punctuation">.</span><span class="token identifier"><span class="token punctuation">`</span>t<span class="token punctuation">`</span></span> trx id <span class="token number">43765</span> lock_mode X
Record <span class="token keyword">lock</span><span class="token punctuation">,</span> heap <span class="token keyword">no</span> <span class="token number">1</span> PHYSICAL RECORD: n_fields <span class="token number">1</span><span class="token punctuation">;</span> compact format<span class="token punctuation">;</span> info bits <span class="token number">0</span>
 <span class="token number">0</span>: len <span class="token number">8</span><span class="token punctuation">;</span> hex <span class="token number">73757072656</span>d756d<span class="token punctuation">;</span> <span class="token keyword">asc</span> supremum<span class="token punctuation">;</span><span class="token punctuation">;</span>

Record <span class="token keyword">lock</span><span class="token punctuation">,</span> heap <span class="token keyword">no</span> <span class="token number">3</span> PHYSICAL RECORD: n_fields <span class="token number">6</span><span class="token punctuation">;</span> compact format<span class="token punctuation">;</span> info bits <span class="token number">0</span>
 <span class="token number">0</span>: len <span class="token number">4</span><span class="token punctuation">;</span> hex <span class="token number">80000002</span><span class="token punctuation">;</span> <span class="token keyword">asc</span>     <span class="token punctuation">;</span><span class="token punctuation">;</span>
 <span class="token number">1</span>: len <span class="token number">6</span><span class="token punctuation">;</span> hex <span class="token number">00000000</span>aaec<span class="token punctuation">;</span> <span class="token keyword">asc</span>       <span class="token punctuation">;</span><span class="token punctuation">;</span>
 <span class="token number">2</span>: len <span class="token number">7</span><span class="token punctuation">;</span> hex <span class="token number">820000008</span>f011d<span class="token punctuation">;</span> <span class="token keyword">asc</span>        <span class="token punctuation">;</span><span class="token punctuation">;</span>
 <span class="token number">3</span>: len <span class="token number">4</span><span class="token punctuation">;</span> hex <span class="token number">80000002</span><span class="token punctuation">;</span> <span class="token keyword">asc</span>     <span class="token punctuation">;</span><span class="token punctuation">;</span>
 <span class="token number">4</span>: len <span class="token number">4</span><span class="token punctuation">;</span> hex <span class="token number">80000003</span><span class="token punctuation">;</span> <span class="token keyword">asc</span>     <span class="token punctuation">;</span><span class="token punctuation">;</span>
 <span class="token number">5</span>: len <span class="token number">4</span><span class="token punctuation">;</span> hex <span class="token number">80000004</span><span class="token punctuation">;</span> <span class="token keyword">asc</span>     <span class="token punctuation">;</span><span class="token punctuation">;</span>

Record <span class="token keyword">lock</span><span class="token punctuation">,</span> heap <span class="token keyword">no</span> <span class="token number">4</span> PHYSICAL RECORD: n_fields <span class="token number">6</span><span class="token punctuation">;</span> compact format<span class="token punctuation">;</span> info bits <span class="token number">0</span>
 <span class="token number">0</span>: len <span class="token number">4</span><span class="token punctuation">;</span> hex <span class="token number">80000003</span><span class="token punctuation">;</span> <span class="token keyword">asc</span>     <span class="token punctuation">;</span><span class="token punctuation">;</span>
 <span class="token number">1</span>: len <span class="token number">6</span><span class="token punctuation">;</span> hex <span class="token number">00000000</span>aaec<span class="token punctuation">;</span> <span class="token keyword">asc</span>       <span class="token punctuation">;</span><span class="token punctuation">;</span>
 <span class="token number">2</span>: len <span class="token number">7</span><span class="token punctuation">;</span> hex <span class="token number">820000008</span>f012a<span class="token punctuation">;</span> <span class="token keyword">asc</span>       <span class="token operator">*</span><span class="token punctuation">;</span><span class="token punctuation">;</span>
 <span class="token number">3</span>: len <span class="token number">4</span><span class="token punctuation">;</span> hex <span class="token number">80000003</span><span class="token punctuation">;</span> <span class="token keyword">asc</span>     <span class="token punctuation">;</span><span class="token punctuation">;</span>
 <span class="token number">4</span>: len <span class="token number">4</span><span class="token punctuation">;</span> hex <span class="token number">80000006</span><span class="token punctuation">;</span> <span class="token keyword">asc</span>     <span class="token punctuation">;</span><span class="token punctuation">;</span>
 <span class="token number">5</span>: len <span class="token number">4</span><span class="token punctuation">;</span> hex <span class="token number">80000009</span><span class="token punctuation">;</span> <span class="token keyword">asc</span>     <span class="token punctuation">;</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br></div></div><p>日志显示<strong>存在 3 个锁结构</strong>，锁定了 4 个索引记录；<strong>表 t 上存在 IX 锁，主键索引上存在 1 个 X 记录锁（id = 1）和 3 个间隙锁（(1, 2]、(2, 3]、supremum）；其中 supremum 代表了大于 3 的间隙（(3, positive infinity)）</strong> 。实际上这里的间隙锁属于 Next-key 锁，相当于<strong>间隙锁加记录锁</strong>。</p> <p>此时，可以插入 id 小于 1 的数据；但是不能插入 id 大于 10 的数据。</p> <blockquote><p>示例2：通过唯一索引操作范围值</p></blockquote> <p>首先在 T1 中执行以下命令锁住数据范围：</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token comment">-- T1</span>
mysql<span class="token operator">&gt;</span> <span class="token keyword">begin</span><span class="token punctuation">;</span>
Query OK<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>

mysql<span class="token operator">&gt;</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> t <span class="token keyword">WHERE</span> c1 <span class="token operator">BETWEEN</span> <span class="token number">1</span> <span class="token operator">and</span> <span class="token number">10</span> <span class="token keyword">FOR</span> <span class="token keyword">UPDATE</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">----+------+------+------+</span>
<span class="token operator">|</span> id <span class="token operator">|</span> c1   <span class="token operator">|</span> c2   <span class="token operator">|</span> c3   <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+------+------+------+</span>
<span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span>    <span class="token number">1</span> <span class="token operator">|</span>    <span class="token number">1</span> <span class="token operator">|</span>    <span class="token number">1</span> <span class="token operator">|</span>
<span class="token operator">|</span>  <span class="token number">2</span> <span class="token operator">|</span>    <span class="token number">2</span> <span class="token operator">|</span>    <span class="token number">3</span> <span class="token operator">|</span>    <span class="token number">4</span> <span class="token operator">|</span>
<span class="token operator">|</span>  <span class="token number">3</span> <span class="token operator">|</span>    <span class="token number">3</span> <span class="token operator">|</span>    <span class="token number">6</span> <span class="token operator">|</span>    <span class="token number">9</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+------+------+------+</span>
<span class="token number">3</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>再次使用 <code>SHOW ENGINE INNODB STATUS</code>​ 命令查看 InnoDB 监控中关于锁的事务数据，可以看到以下内容：</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token comment">---TRANSACTION 43824, ACTIVE 153 sec</span>
<span class="token number">3</span> <span class="token keyword">lock</span> struct<span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">,</span> heap size <span class="token number">1136</span><span class="token punctuation">,</span> <span class="token number">7</span> <span class="token keyword">row</span> <span class="token keyword">lock</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>
MySQL thread id <span class="token number">103</span><span class="token punctuation">,</span> OS thread handle <span class="token number">140437513750272</span><span class="token punctuation">,</span> query id <span class="token number">23852</span> localhost root
<span class="token keyword">TABLE</span> <span class="token keyword">LOCK</span> <span class="token keyword">table</span> <span class="token identifier"><span class="token punctuation">`</span>hrdb<span class="token punctuation">`</span></span><span class="token punctuation">.</span><span class="token identifier"><span class="token punctuation">`</span>t<span class="token punctuation">`</span></span> trx id <span class="token number">43824</span> <span class="token keyword">lock</span> <span class="token keyword">mode</span> IX
RECORD LOCKS space id <span class="token number">102</span> page <span class="token keyword">no</span> <span class="token number">5</span> n bits <span class="token number">72</span> <span class="token keyword">index</span> idx_t_c1 <span class="token keyword">of</span> <span class="token keyword">table</span> <span class="token identifier"><span class="token punctuation">`</span>hrdb<span class="token punctuation">`</span></span><span class="token punctuation">.</span><span class="token identifier"><span class="token punctuation">`</span>t<span class="token punctuation">`</span></span> trx id <span class="token number">43824</span> lock_mode X
Record <span class="token keyword">lock</span><span class="token punctuation">,</span> heap <span class="token keyword">no</span> <span class="token number">1</span> PHYSICAL RECORD: n_fields <span class="token number">1</span><span class="token punctuation">;</span> compact format<span class="token punctuation">;</span> info bits <span class="token number">0</span>
 <span class="token number">0</span>: len <span class="token number">8</span><span class="token punctuation">;</span> hex <span class="token number">73757072656</span>d756d<span class="token punctuation">;</span> <span class="token keyword">asc</span> supremum<span class="token punctuation">;</span><span class="token punctuation">;</span>

Record <span class="token keyword">lock</span><span class="token punctuation">,</span> heap <span class="token keyword">no</span> <span class="token number">2</span> PHYSICAL RECORD: n_fields <span class="token number">2</span><span class="token punctuation">;</span> compact format<span class="token punctuation">;</span> info bits <span class="token number">0</span>
 <span class="token number">0</span>: len <span class="token number">4</span><span class="token punctuation">;</span> hex <span class="token number">80000001</span><span class="token punctuation">;</span> <span class="token keyword">asc</span>     <span class="token punctuation">;</span><span class="token punctuation">;</span>
 <span class="token number">1</span>: len <span class="token number">4</span><span class="token punctuation">;</span> hex <span class="token number">80000001</span><span class="token punctuation">;</span> <span class="token keyword">asc</span>     <span class="token punctuation">;</span><span class="token punctuation">;</span>

Record <span class="token keyword">lock</span><span class="token punctuation">,</span> heap <span class="token keyword">no</span> <span class="token number">3</span> PHYSICAL RECORD: n_fields <span class="token number">2</span><span class="token punctuation">;</span> compact format<span class="token punctuation">;</span> info bits <span class="token number">0</span>
 <span class="token number">0</span>: len <span class="token number">4</span><span class="token punctuation">;</span> hex <span class="token number">80000002</span><span class="token punctuation">;</span> <span class="token keyword">asc</span>     <span class="token punctuation">;</span><span class="token punctuation">;</span>
 <span class="token number">1</span>: len <span class="token number">4</span><span class="token punctuation">;</span> hex <span class="token number">80000002</span><span class="token punctuation">;</span> <span class="token keyword">asc</span>     <span class="token punctuation">;</span><span class="token punctuation">;</span>

Record <span class="token keyword">lock</span><span class="token punctuation">,</span> heap <span class="token keyword">no</span> <span class="token number">4</span> PHYSICAL RECORD: n_fields <span class="token number">2</span><span class="token punctuation">;</span> compact format<span class="token punctuation">;</span> info bits <span class="token number">0</span>
 <span class="token number">0</span>: len <span class="token number">4</span><span class="token punctuation">;</span> hex <span class="token number">80000003</span><span class="token punctuation">;</span> <span class="token keyword">asc</span>     <span class="token punctuation">;</span><span class="token punctuation">;</span>
 <span class="token number">1</span>: len <span class="token number">4</span><span class="token punctuation">;</span> hex <span class="token number">80000003</span><span class="token punctuation">;</span> <span class="token keyword">asc</span>     <span class="token punctuation">;</span><span class="token punctuation">;</span>

RECORD LOCKS space id <span class="token number">102</span> page <span class="token keyword">no</span> <span class="token number">4</span> n bits <span class="token number">72</span> <span class="token keyword">index</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">of</span> <span class="token keyword">table</span> <span class="token identifier"><span class="token punctuation">`</span>hrdb<span class="token punctuation">`</span></span><span class="token punctuation">.</span><span class="token identifier"><span class="token punctuation">`</span>t<span class="token punctuation">`</span></span> trx id <span class="token number">43824</span> lock_mode X locks rec but <span class="token operator">not</span> gap
Record <span class="token keyword">lock</span><span class="token punctuation">,</span> heap <span class="token keyword">no</span> <span class="token number">2</span> PHYSICAL RECORD: n_fields <span class="token number">6</span><span class="token punctuation">;</span> compact format<span class="token punctuation">;</span> info bits <span class="token number">0</span>
 <span class="token number">0</span>: len <span class="token number">4</span><span class="token punctuation">;</span> hex <span class="token number">80000001</span><span class="token punctuation">;</span> <span class="token keyword">asc</span>     <span class="token punctuation">;</span><span class="token punctuation">;</span>
 <span class="token number">1</span>: len <span class="token number">6</span><span class="token punctuation">;</span> hex <span class="token number">00000000</span>ab2b<span class="token punctuation">;</span> <span class="token keyword">asc</span>      <span class="token operator">+</span><span class="token punctuation">;</span><span class="token punctuation">;</span>
 <span class="token number">2</span>: len <span class="token number">7</span><span class="token punctuation">;</span> hex <span class="token number">82000000</span>a70110<span class="token punctuation">;</span> <span class="token keyword">asc</span>        <span class="token punctuation">;</span><span class="token punctuation">;</span>
 <span class="token number">3</span>: len <span class="token number">4</span><span class="token punctuation">;</span> hex <span class="token number">80000001</span><span class="token punctuation">;</span> <span class="token keyword">asc</span>     <span class="token punctuation">;</span><span class="token punctuation">;</span>
 <span class="token number">4</span>: len <span class="token number">4</span><span class="token punctuation">;</span> hex <span class="token number">80000001</span><span class="token punctuation">;</span> <span class="token keyword">asc</span>     <span class="token punctuation">;</span><span class="token punctuation">;</span>
 <span class="token number">5</span>: len <span class="token number">4</span><span class="token punctuation">;</span> hex <span class="token number">80000001</span><span class="token punctuation">;</span> <span class="token keyword">asc</span>     <span class="token punctuation">;</span><span class="token punctuation">;</span>

Record <span class="token keyword">lock</span><span class="token punctuation">,</span> heap <span class="token keyword">no</span> <span class="token number">3</span> PHYSICAL RECORD: n_fields <span class="token number">6</span><span class="token punctuation">;</span> compact format<span class="token punctuation">;</span> info bits <span class="token number">0</span>
 <span class="token number">0</span>: len <span class="token number">4</span><span class="token punctuation">;</span> hex <span class="token number">80000002</span><span class="token punctuation">;</span> <span class="token keyword">asc</span>     <span class="token punctuation">;</span><span class="token punctuation">;</span>
 <span class="token number">1</span>: len <span class="token number">6</span><span class="token punctuation">;</span> hex <span class="token number">00000000</span>ab2b<span class="token punctuation">;</span> <span class="token keyword">asc</span>      <span class="token operator">+</span><span class="token punctuation">;</span><span class="token punctuation">;</span>
 <span class="token number">2</span>: len <span class="token number">7</span><span class="token punctuation">;</span> hex <span class="token number">82000000</span>a7011d<span class="token punctuation">;</span> <span class="token keyword">asc</span>        <span class="token punctuation">;</span><span class="token punctuation">;</span>
 <span class="token number">3</span>: len <span class="token number">4</span><span class="token punctuation">;</span> hex <span class="token number">80000002</span><span class="token punctuation">;</span> <span class="token keyword">asc</span>     <span class="token punctuation">;</span><span class="token punctuation">;</span>
 <span class="token number">4</span>: len <span class="token number">4</span><span class="token punctuation">;</span> hex <span class="token number">80000003</span><span class="token punctuation">;</span> <span class="token keyword">asc</span>     <span class="token punctuation">;</span><span class="token punctuation">;</span>
 <span class="token number">5</span>: len <span class="token number">4</span><span class="token punctuation">;</span> hex <span class="token number">80000004</span><span class="token punctuation">;</span> <span class="token keyword">asc</span>     <span class="token punctuation">;</span><span class="token punctuation">;</span>

Record <span class="token keyword">lock</span><span class="token punctuation">,</span> heap <span class="token keyword">no</span> <span class="token number">4</span> PHYSICAL RECORD: n_fields <span class="token number">6</span><span class="token punctuation">;</span> compact format<span class="token punctuation">;</span> info bits <span class="token number">0</span>
 <span class="token number">0</span>: len <span class="token number">4</span><span class="token punctuation">;</span> hex <span class="token number">80000003</span><span class="token punctuation">;</span> <span class="token keyword">asc</span>     <span class="token punctuation">;</span><span class="token punctuation">;</span>
 <span class="token number">1</span>: len <span class="token number">6</span><span class="token punctuation">;</span> hex <span class="token number">00000000</span>ab2b<span class="token punctuation">;</span> <span class="token keyword">asc</span>      <span class="token operator">+</span><span class="token punctuation">;</span><span class="token punctuation">;</span>
 <span class="token number">2</span>: len <span class="token number">7</span><span class="token punctuation">;</span> hex <span class="token number">82000000</span>a7012a<span class="token punctuation">;</span> <span class="token keyword">asc</span>       <span class="token operator">*</span><span class="token punctuation">;</span><span class="token punctuation">;</span>
 <span class="token number">3</span>: len <span class="token number">4</span><span class="token punctuation">;</span> hex <span class="token number">80000003</span><span class="token punctuation">;</span> <span class="token keyword">asc</span>     <span class="token punctuation">;</span><span class="token punctuation">;</span>
 <span class="token number">4</span>: len <span class="token number">4</span><span class="token punctuation">;</span> hex <span class="token number">80000006</span><span class="token punctuation">;</span> <span class="token keyword">asc</span>     <span class="token punctuation">;</span><span class="token punctuation">;</span>
 <span class="token number">5</span>: len <span class="token number">4</span><span class="token punctuation">;</span> hex <span class="token number">80000009</span><span class="token punctuation">;</span> <span class="token keyword">asc</span>     <span class="token punctuation">;</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br></div></div><p>日志显示存在 3 个锁结构，锁定了 7 个索引记录；表 t 上存在 IX 锁，索引 idx_t_c1 上存在 4 个间隙锁（(negative infinity, 1]、(1, 2]、(2, 3]、supremum），其中 supremum 代表了大于 3 的间隙（(3, positive infinity)）；主键索引上存在 3 个 X 记录锁，锁定了 3 个主键值。实际上这里的间隙锁属于 Next-key 锁，相当于<strong>间隙锁加记录锁</strong>。</p> <p>此时，无法插入任何数据。</p> <h5 id="_3-临键锁-next-key-lock"><a href="#_3-临键锁-next-key-lock" class="header-anchor">#</a> 3.临键锁(Next-Key Lock)</h5> <h6 id="基础-3"><a href="#基础-3" class="header-anchor">#</a> 基础</h6> <p><strong>临键锁（Next-key Lock）相当于索引记录锁和间隙锁的结合，</strong> 不仅锁定一个记录上的索引(包含记录本身), 也锁定索引之间的间隙.</p> <p>假设一个索引中包含数据 10、11、13 和 20。该索引中可能的 next-key 锁包含以下范围，其中圆括号表示排除端点值，方括号表示包含端点值：</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token punctuation">(</span>negative infinity<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">]</span>
<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">]</span>
<span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">,</span> <span class="token number">13</span><span class="token punctuation">]</span>
<span class="token punctuation">(</span><span class="token number">13</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">]</span>
<span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">,</span> positive infinity<span class="token punctuation">)</span> <span class="token comment">-- 显示为 supermum</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>对于最后一个间隔，next-key 锁将会锁定最大索引值（20）之后的间隙；伪记录 &quot;supermum&quot; 的值大于索引中任何值，它不是真正的索引记录。 <strong>(10, 11) 是一个间隙锁的锁定范围，(10, 11] 是一个 next-key 锁的锁定范围</strong>。</p> <p>MySQL 默认<strong>隔离级别是可重复读</strong>, 解决不了幻读问题. 在默认的可重复读隔离级别下，<mark><strong>InnoDB 通过 next-key 锁进行查找和索引扫描，因为它会锁定范围值，不会导致两次查询结果的数量不同，因此可以解决幻读问题</strong></mark>。</p> <p>锁定间隙有什么用? 因为幻读就是 A 事务<strong>第一次读了一个范围的数据</strong>之后(此时 A 没有结束), 另一个 B 事务在这个范围插入或者删除数据行所致, <strong>锁定间隙可以防止其他事务在之中改变数据行数, 就解决了幻读问题</strong>.</p> <h6 id="示例-3"><a href="#示例-3" class="header-anchor">#</a> 示例</h6> <blockquote><p>示例1：通过普通索引操作单个值</p></blockquote> <p>c2 字段上<strong>存在非唯一索引</strong>，先在 T1 中执行以下命令：</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token comment">-- T1</span>
mysql<span class="token operator">&gt;</span> <span class="token keyword">begin</span><span class="token punctuation">;</span>
Query OK<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>

mysql<span class="token operator">&gt;</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> t <span class="token keyword">WHERE</span> c2 <span class="token operator">=</span> <span class="token number">1</span> <span class="token keyword">FOR</span> <span class="token keyword">UPDATE</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">----+------+------+------+</span>
<span class="token operator">|</span> id <span class="token operator">|</span> c1   <span class="token operator">|</span> c2   <span class="token operator">|</span> c3   <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+------+------+------+</span>
<span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span>    <span class="token number">1</span> <span class="token operator">|</span>    <span class="token number">1</span> <span class="token operator">|</span>    <span class="token number">1</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+------+------+------+</span>
<span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>使用 <code>SHOW ENGINE INNODB STATUS</code>​ 命令查看 InnoDB 监控中关于锁的事务数据，可以看到以下内容：</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token comment">---TRANSACTION 43830, ACTIVE 6 sec</span>
<span class="token number">4</span> <span class="token keyword">lock</span> struct<span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">,</span> heap size <span class="token number">1136</span><span class="token punctuation">,</span> <span class="token number">3</span> <span class="token keyword">row</span> <span class="token keyword">lock</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>
MySQL thread id <span class="token number">103</span><span class="token punctuation">,</span> OS thread handle <span class="token number">140437513750272</span><span class="token punctuation">,</span> query id <span class="token number">23871</span> localhost root
<span class="token keyword">TABLE</span> <span class="token keyword">LOCK</span> <span class="token keyword">table</span> <span class="token identifier"><span class="token punctuation">`</span>hrdb<span class="token punctuation">`</span></span><span class="token punctuation">.</span><span class="token identifier"><span class="token punctuation">`</span>t<span class="token punctuation">`</span></span> trx id <span class="token number">43830</span> <span class="token keyword">lock</span> <span class="token keyword">mode</span> IX
RECORD LOCKS space id <span class="token number">102</span> page <span class="token keyword">no</span> <span class="token number">6</span> n bits <span class="token number">72</span> <span class="token keyword">index</span> idx_t_c2 <span class="token keyword">of</span> <span class="token keyword">table</span> <span class="token identifier"><span class="token punctuation">`</span>hrdb<span class="token punctuation">`</span></span><span class="token punctuation">.</span><span class="token identifier"><span class="token punctuation">`</span>t<span class="token punctuation">`</span></span> trx id <span class="token number">43830</span> lock_mode X
Record <span class="token keyword">lock</span><span class="token punctuation">,</span> heap <span class="token keyword">no</span> <span class="token number">2</span> PHYSICAL RECORD: n_fields <span class="token number">2</span><span class="token punctuation">;</span> compact format<span class="token punctuation">;</span> info bits <span class="token number">0</span>
 <span class="token number">0</span>: len <span class="token number">4</span><span class="token punctuation">;</span> hex <span class="token number">80000001</span><span class="token punctuation">;</span> <span class="token keyword">asc</span>     <span class="token punctuation">;</span><span class="token punctuation">;</span>
 <span class="token number">1</span>: len <span class="token number">4</span><span class="token punctuation">;</span> hex <span class="token number">80000001</span><span class="token punctuation">;</span> <span class="token keyword">asc</span>     <span class="token punctuation">;</span><span class="token punctuation">;</span>

RECORD LOCKS space id <span class="token number">102</span> page <span class="token keyword">no</span> <span class="token number">4</span> n bits <span class="token number">72</span> <span class="token keyword">index</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">of</span> <span class="token keyword">table</span> <span class="token identifier"><span class="token punctuation">`</span>hrdb<span class="token punctuation">`</span></span><span class="token punctuation">.</span><span class="token identifier"><span class="token punctuation">`</span>t<span class="token punctuation">`</span></span> trx id <span class="token number">43830</span> lock_mode X locks rec but <span class="token operator">not</span> gap
Record <span class="token keyword">lock</span><span class="token punctuation">,</span> heap <span class="token keyword">no</span> <span class="token number">2</span> PHYSICAL RECORD: n_fields <span class="token number">6</span><span class="token punctuation">;</span> compact format<span class="token punctuation">;</span> info bits <span class="token number">0</span>
 <span class="token number">0</span>: len <span class="token number">4</span><span class="token punctuation">;</span> hex <span class="token number">80000001</span><span class="token punctuation">;</span> <span class="token keyword">asc</span>     <span class="token punctuation">;</span><span class="token punctuation">;</span>
 <span class="token number">1</span>: len <span class="token number">6</span><span class="token punctuation">;</span> hex <span class="token number">00000000</span>ab2b<span class="token punctuation">;</span> <span class="token keyword">asc</span>      <span class="token operator">+</span><span class="token punctuation">;</span><span class="token punctuation">;</span>
 <span class="token number">2</span>: len <span class="token number">7</span><span class="token punctuation">;</span> hex <span class="token number">82000000</span>a70110<span class="token punctuation">;</span> <span class="token keyword">asc</span>        <span class="token punctuation">;</span><span class="token punctuation">;</span>
 <span class="token number">3</span>: len <span class="token number">4</span><span class="token punctuation">;</span> hex <span class="token number">80000001</span><span class="token punctuation">;</span> <span class="token keyword">asc</span>     <span class="token punctuation">;</span><span class="token punctuation">;</span>
 <span class="token number">4</span>: len <span class="token number">4</span><span class="token punctuation">;</span> hex <span class="token number">80000001</span><span class="token punctuation">;</span> <span class="token keyword">asc</span>     <span class="token punctuation">;</span><span class="token punctuation">;</span>
 <span class="token number">5</span>: len <span class="token number">4</span><span class="token punctuation">;</span> hex <span class="token number">80000001</span><span class="token punctuation">;</span> <span class="token keyword">asc</span>     <span class="token punctuation">;</span><span class="token punctuation">;</span>

RECORD LOCKS space id <span class="token number">102</span> page <span class="token keyword">no</span> <span class="token number">6</span> n bits <span class="token number">72</span> <span class="token keyword">index</span> idx_t_c2 <span class="token keyword">of</span> <span class="token keyword">table</span> <span class="token identifier"><span class="token punctuation">`</span>hrdb<span class="token punctuation">`</span></span><span class="token punctuation">.</span><span class="token identifier"><span class="token punctuation">`</span>t<span class="token punctuation">`</span></span> trx id <span class="token number">43830</span> lock_mode X locks gap before rec
Record <span class="token keyword">lock</span><span class="token punctuation">,</span> heap <span class="token keyword">no</span> <span class="token number">3</span> PHYSICAL RECORD: n_fields <span class="token number">2</span><span class="token punctuation">;</span> compact format<span class="token punctuation">;</span> info bits <span class="token number">0</span>
 <span class="token number">0</span>: len <span class="token number">4</span><span class="token punctuation">;</span> hex <span class="token number">80000003</span><span class="token punctuation">;</span> <span class="token keyword">asc</span>     <span class="token punctuation">;</span><span class="token punctuation">;</span>
 <span class="token number">1</span>: len <span class="token number">4</span><span class="token punctuation">;</span> hex <span class="token number">80000002</span><span class="token punctuation">;</span> <span class="token keyword">asc</span>     <span class="token punctuation">;</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><p>日志显示存在 4 个锁结构，锁定了 3 个索引项；表 t 上存在 IX 锁，索引 idx_t_c2 上存在一个 next-key 锁（c2 = 1，锁定了 (negative infinity, 1]）和一个 X 间隙锁（（1, 3）），主键索引上存在一个 X 记录锁（id = 1）。</p> <p><strong>此时其他事务无法在 c2 中插入小于 3 的值，但是可以插入大于等于 3 的值</strong>。最后在 T1 中释放锁：</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token comment">-- T1</span>
mysql<span class="token operator">&gt;</span> <span class="token keyword">commit</span><span class="token punctuation">;</span>
Query OK<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p><mark><strong>如果索引有唯一属性，则 InnnoDB 会自动将 next-key 锁降级为记录锁</strong></mark>。</p> <blockquote><p>示例2：通过普通索引操作范围值</p></blockquote> <p>如果利用 c2 字段作为条件操作范围值，加锁情况与通过唯一索引（c1）操作范围值相同。可以参考上文示例。</p> <blockquote><p>示例3：无索引操作单个值或范围值</p></blockquote> <p><strong>c3 字段上没有索引</strong>，先在 T1 中执行以下命令：</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token comment">-- T1</span>
mysql<span class="token operator">&gt;</span> <span class="token keyword">begin</span><span class="token punctuation">;</span>
Query OK<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>

mysql<span class="token operator">&gt;</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> t <span class="token keyword">WHERE</span> c3 <span class="token operator">=</span> <span class="token number">1</span> <span class="token keyword">FOR</span> <span class="token keyword">UPDATE</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">----+------+------+------+</span>
<span class="token operator">|</span> id <span class="token operator">|</span> c1   <span class="token operator">|</span> c2   <span class="token operator">|</span> c3   <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+------+------+------+</span>
<span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span>    <span class="token number">1</span> <span class="token operator">|</span>    <span class="token number">1</span> <span class="token operator">|</span>    <span class="token number">1</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+------+------+------+</span>
<span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>使用 <code>SHOW ENGINE INNODB STATUS</code>​ 命令查看 InnoDB 监控中关于锁的事务数据，可以看到以下内容：</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token comment">---TRANSACTION 43848, ACTIVE 5 sec</span>
<span class="token number">2</span> <span class="token keyword">lock</span> struct<span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">,</span> heap size <span class="token number">1136</span><span class="token punctuation">,</span> <span class="token number">4</span> <span class="token keyword">row</span> <span class="token keyword">lock</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>
MySQL thread id <span class="token number">103</span><span class="token punctuation">,</span> OS thread handle <span class="token number">140437513750272</span><span class="token punctuation">,</span> query id <span class="token number">23917</span> localhost root
<span class="token keyword">TABLE</span> <span class="token keyword">LOCK</span> <span class="token keyword">table</span> <span class="token identifier"><span class="token punctuation">`</span>hrdb<span class="token punctuation">`</span></span><span class="token punctuation">.</span><span class="token identifier"><span class="token punctuation">`</span>t<span class="token punctuation">`</span></span> trx id <span class="token number">43848</span> <span class="token keyword">lock</span> <span class="token keyword">mode</span> IX
RECORD LOCKS space id <span class="token number">102</span> page <span class="token keyword">no</span> <span class="token number">4</span> n bits <span class="token number">80</span> <span class="token keyword">index</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">of</span> <span class="token keyword">table</span> <span class="token identifier"><span class="token punctuation">`</span>hrdb<span class="token punctuation">`</span></span><span class="token punctuation">.</span><span class="token identifier"><span class="token punctuation">`</span>t<span class="token punctuation">`</span></span> trx id <span class="token number">43848</span> lock_mode X
Record <span class="token keyword">lock</span><span class="token punctuation">,</span> heap <span class="token keyword">no</span> <span class="token number">1</span> PHYSICAL RECORD: n_fields <span class="token number">1</span><span class="token punctuation">;</span> compact format<span class="token punctuation">;</span> info bits <span class="token number">0</span>
 <span class="token number">0</span>: len <span class="token number">8</span><span class="token punctuation">;</span> hex <span class="token number">73757072656</span>d756d<span class="token punctuation">;</span> <span class="token keyword">asc</span> supremum<span class="token punctuation">;</span><span class="token punctuation">;</span>

Record <span class="token keyword">lock</span><span class="token punctuation">,</span> heap <span class="token keyword">no</span> <span class="token number">2</span> PHYSICAL RECORD: n_fields <span class="token number">6</span><span class="token punctuation">;</span> compact format<span class="token punctuation">;</span> info bits <span class="token number">0</span>
 <span class="token number">0</span>: len <span class="token number">4</span><span class="token punctuation">;</span> hex <span class="token number">80000001</span><span class="token punctuation">;</span> <span class="token keyword">asc</span>     <span class="token punctuation">;</span><span class="token punctuation">;</span>
 <span class="token number">1</span>: len <span class="token number">6</span><span class="token punctuation">;</span> hex <span class="token number">00000000</span>ab2b<span class="token punctuation">;</span> <span class="token keyword">asc</span>      <span class="token operator">+</span><span class="token punctuation">;</span><span class="token punctuation">;</span>
 <span class="token number">2</span>: len <span class="token number">7</span><span class="token punctuation">;</span> hex <span class="token number">82000000</span>a70110<span class="token punctuation">;</span> <span class="token keyword">asc</span>        <span class="token punctuation">;</span><span class="token punctuation">;</span>
 <span class="token number">3</span>: len <span class="token number">4</span><span class="token punctuation">;</span> hex <span class="token number">80000001</span><span class="token punctuation">;</span> <span class="token keyword">asc</span>     <span class="token punctuation">;</span><span class="token punctuation">;</span>
 <span class="token number">4</span>: len <span class="token number">4</span><span class="token punctuation">;</span> hex <span class="token number">80000001</span><span class="token punctuation">;</span> <span class="token keyword">asc</span>     <span class="token punctuation">;</span><span class="token punctuation">;</span>
 <span class="token number">5</span>: len <span class="token number">4</span><span class="token punctuation">;</span> hex <span class="token number">80000001</span><span class="token punctuation">;</span> <span class="token keyword">asc</span>     <span class="token punctuation">;</span><span class="token punctuation">;</span>

Record <span class="token keyword">lock</span><span class="token punctuation">,</span> heap <span class="token keyword">no</span> <span class="token number">3</span> PHYSICAL RECORD: n_fields <span class="token number">6</span><span class="token punctuation">;</span> compact format<span class="token punctuation">;</span> info bits <span class="token number">0</span>
 <span class="token number">0</span>: len <span class="token number">4</span><span class="token punctuation">;</span> hex <span class="token number">80000002</span><span class="token punctuation">;</span> <span class="token keyword">asc</span>     <span class="token punctuation">;</span><span class="token punctuation">;</span>
 <span class="token number">1</span>: len <span class="token number">6</span><span class="token punctuation">;</span> hex <span class="token number">00000000</span>ab2b<span class="token punctuation">;</span> <span class="token keyword">asc</span>      <span class="token operator">+</span><span class="token punctuation">;</span><span class="token punctuation">;</span>
 <span class="token number">2</span>: len <span class="token number">7</span><span class="token punctuation">;</span> hex <span class="token number">82000000</span>a7011d<span class="token punctuation">;</span> <span class="token keyword">asc</span>        <span class="token punctuation">;</span><span class="token punctuation">;</span>
 <span class="token number">3</span>: len <span class="token number">4</span><span class="token punctuation">;</span> hex <span class="token number">80000002</span><span class="token punctuation">;</span> <span class="token keyword">asc</span>     <span class="token punctuation">;</span><span class="token punctuation">;</span>
 <span class="token number">4</span>: len <span class="token number">4</span><span class="token punctuation">;</span> hex <span class="token number">80000003</span><span class="token punctuation">;</span> <span class="token keyword">asc</span>     <span class="token punctuation">;</span><span class="token punctuation">;</span>
 <span class="token number">5</span>: len <span class="token number">4</span><span class="token punctuation">;</span> hex <span class="token number">80000004</span><span class="token punctuation">;</span> <span class="token keyword">asc</span>     <span class="token punctuation">;</span><span class="token punctuation">;</span>

Record <span class="token keyword">lock</span><span class="token punctuation">,</span> heap <span class="token keyword">no</span> <span class="token number">4</span> PHYSICAL RECORD: n_fields <span class="token number">6</span><span class="token punctuation">;</span> compact format<span class="token punctuation">;</span> info bits <span class="token number">0</span>
 <span class="token number">0</span>: len <span class="token number">4</span><span class="token punctuation">;</span> hex <span class="token number">80000003</span><span class="token punctuation">;</span> <span class="token keyword">asc</span>     <span class="token punctuation">;</span><span class="token punctuation">;</span>
 <span class="token number">1</span>: len <span class="token number">6</span><span class="token punctuation">;</span> hex <span class="token number">00000000</span>ab2b<span class="token punctuation">;</span> <span class="token keyword">asc</span>      <span class="token operator">+</span><span class="token punctuation">;</span><span class="token punctuation">;</span>
 <span class="token number">2</span>: len <span class="token number">7</span><span class="token punctuation">;</span> hex <span class="token number">82000000</span>a7012a<span class="token punctuation">;</span> <span class="token keyword">asc</span>       <span class="token operator">*</span><span class="token punctuation">;</span><span class="token punctuation">;</span>
 <span class="token number">3</span>: len <span class="token number">4</span><span class="token punctuation">;</span> hex <span class="token number">80000003</span><span class="token punctuation">;</span> <span class="token keyword">asc</span>     <span class="token punctuation">;</span><span class="token punctuation">;</span>
 <span class="token number">4</span>: len <span class="token number">4</span><span class="token punctuation">;</span> hex <span class="token number">80000006</span><span class="token punctuation">;</span> <span class="token keyword">asc</span>     <span class="token punctuation">;</span><span class="token punctuation">;</span>
 <span class="token number">5</span>: len <span class="token number">4</span><span class="token punctuation">;</span> hex <span class="token number">80000009</span><span class="token punctuation">;</span> <span class="token keyword">asc</span>     <span class="token punctuation">;</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br></div></div><p>日志显示存在 2 个锁结构，锁定了 4 个索引项；表 t 上存在 IX 锁，主键索引上存在 4 个 next-key 锁，<strong>锁定了所有的主键范围</strong>。此时其他事务无法插入任何数据。</p> <p>最后在 T1 中释放锁：</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token comment">-- T1</span>
mysql<span class="token operator">&gt;</span> <span class="token keyword">commit</span><span class="token punctuation">;</span>
Query OK<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>如果将语句修改为 <code>SELECT * FROM t WHERE c3 between 1 and 10 FOR UPDATE;</code>​，通过无索引的字段操作范围值，也会锁定主键的所有范围。这也就是为什么 <strong>MySQL 推荐通过索引操作数据，最好是主键</strong>。</p> <h6 id="临键锁引发死锁问题"><a href="#临键锁引发死锁问题" class="header-anchor">#</a> 临键锁引发死锁问题</h6> <p>在一个业务中, 有一个场景是<strong>先从数据库中查询数据并锁住</strong>. 如果<strong>这个数据不存在, 那么就需要执行一段逻辑, 计算出一个数据, 然后插入. 如果已经有数据了, 那么就将原始的数据取出来, 再利用这个数据执行一段逻辑, 计算出来一个结果, 执行更新</strong>.</p> <p>​<img src="https://nano-note.oss-cn-beijing.aliyuncs.com/images/0519d4897c4b8b985d6f54e79yy9ba3e-20231223175001-uegh1ta.png" alt="图片">​</p> <p>因为两段运算逻辑不同, 所以不能简单地使用 INSERT ON DUPLICATE 的语句来取代.</p> <p>只看没有数据的逻辑, 在计算之后插入新数据, 如果用伪代码来描述, 就是下面这样的.</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">BEGIN</span><span class="token punctuation">;</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> biz <span class="token keyword">WHERE</span> id <span class="token operator">=</span> ? <span class="token keyword">FOR</span> <span class="token keyword">UPDATE</span>
<span class="token comment">// 中间有很多业务操作</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> biz<span class="token punctuation">(</span>id<span class="token punctuation">,</span> <span class="token keyword">data</span><span class="token punctuation">)</span> <span class="token keyword">VALUE</span><span class="token punctuation">(</span>?<span class="token punctuation">,</span> ?<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">COMMIT</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>看起来是不是没有任何问题? 实际上, 这个地方会引起<strong>死锁</strong>.</p> <p>假设说现在数据库中 ID 最大的值是 78. 那么<strong>如果两个业务进来, 同时执行这个逻辑</strong>. 一个准备插入 id = 79 的数据, 一个准备插入 id = 80 的数据. 如果它们的执行时序如下图, 那就会得到一个死锁错误.</p> <p>​<img src="/img/f585706c073yyf00128b91876ff410fc-20231223175001-fpuuh2m.png" alt="图片">​</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token punctuation">[</span><span class="token number">40001</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1213</span><span class="token punctuation">]</span> Deadlock found when trying to get lock<span class="token punctuation">;</span> try restarting transaction
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>造成死锁的原因也很简单. 在线程 1 执行 SELECT FOR UPDATE 的时候, 因为 id = 79 的数据<strong>不存在</strong>, 所以实际上<strong>数据库会产生一个 (78, supremum] 的临键锁</strong>. 类似地, 线程 2 也会<strong>产生一个 (78, supremum] 临键锁</strong>.</p> <p><strong>==当线程 1 想要执行插入的时候, 它想要获得 id = 79 的行锁. 当线程 2 想要执行插入的时候, 它想要获得 id = 80 的行锁, 这个时候就会出现死锁. 因为线程 1 和线程 2 同时还在等着对方释放掉持有的间隙锁==</strong>.</p> <p>​<img src="/img/31cee3eb57ff5e8f4ddf49757a072d46-20231223175001-5bxdeud.png" alt="图片">​</p> <p>从理论上来说, 解决方案有三种.</p> <ul><li><strong>不管有没有数据, 先插入一个默认的数据</strong>. 如果没有数据, 那么会插入成功; 如果有数据, 那么会出现主键冲突或者唯一索引冲突, 插入失败. 那么在插入成功的时候, 执行以前数据不存在的逻辑, 但是因为此时数据库中有数据, 所以不会使用间隙锁, 而是使用行锁, 从而规避了死锁问题.</li> <li><strong>调整数据库的隔离级别, 降低为已提交读, 那么就没有间隙锁了</strong>.</li> <li><strong>放弃悲观锁, 使用乐观锁</strong>.</li></ul> <h4 id="锁与索引"><a href="#锁与索引" class="header-anchor">#</a> 锁与索引</h4> <p><mark><strong>在 MySQL 的 InnoDB 引擎里面, 锁是借助索引来实现的. 或者说加锁锁住的其实是索引项, 更加具体地来说, 就是锁住了叶子节点</strong></mark>.</p> <p>​<img src="https://nano-note.oss-cn-beijing.aliyuncs.com/images/0be4ab811c14f01f477f9ea2267fbefe-20231223175001-pm3bn8z.png" alt="图片">​</p> <p>从这个角度出发, 就能理解大部分跟锁有关的千奇百怪的问题了.</p> <p><mark><strong>一个表有很多索引, 锁的是哪个索引呢? 其实就是查询最终使用的那个索引. 万一查询没有使用任何索引呢? 那么锁住的就是整个表, 也就是此时退化为表锁</strong></mark>.</p> <p>如果查询条件的值并不存在, 例如:</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> your_tab <span class="token keyword">WHERE</span> id <span class="token operator">=</span> <span class="token number">15</span> <span class="token keyword">FOR</span> <span class="token keyword">UPDATE</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>id = 15 的值根本不存在, 那么怎么锁? InnoDB 引擎会利用最接近 15 的相邻的两个节点, 构造一个<strong>临键锁</strong>.</p> <p>​<img src="https://nano-note.oss-cn-beijing.aliyuncs.com/images/eb2c722f039d8962ae6d7c8e29ff7e8a-20231223175001-6qmtahu.png" alt="">​</p> <p>此时<strong>如果别的事务想要插入一个 id=15 的记录, 就不会成功</strong>.</p> <p>那么范围查询呢? 也是利用索引上的数据, <strong>构造一个恰好能够装下这个范围的临键锁</strong>. 例如:</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> your_tab <span class="token keyword">WHERE</span> id <span class="token operator">&gt;</span> <span class="token number">33</span> <span class="token keyword">FOR</span> <span class="token keyword">UPDATE</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>InnoDB 引擎会构造一个 (33, supremum] 的临键锁, 锁住整个范围. supremum 可以直观理解为 MySQL 认为的一个虚拟的最大值.</p> <p>​<img src="https://nano-note.oss-cn-beijing.aliyuncs.com/images/c081d44794e712b4f4d0c7196b9b85d8-20231223175001-m51en98.png" alt="">​</p> <p>因此, 可以得出了一个结论: <mark><strong>锁和索引密切相关</strong></mark>.</p> <h4 id="锁等待分析"><a href="#锁等待分析" class="header-anchor">#</a> 锁等待分析</h4> <p>可以通过检查 <strong>InnoDB_row_lock</strong> 状态变量来分析系统上的<strong>行锁的争夺</strong>情况.</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">SHOW</span> <span class="token keyword">STATUS</span> <span class="token operator">LIKE</span> <span class="token string">'innodb_row_lock%'</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>各个状态量的说明如下:</p> <ul><li>Innodb_row_lock_current_waits: 当前正在等待锁定的数量.</li> <li>Innodb_row_lock_time: 从系统启动到现在锁定总时间长度.</li> <li>Innodb_row_lock_time_avg: 每次等待所花平均时间.</li> <li>Innodb_row_lock_time_max: 从系统启动到现在等待最长的一次所花时间.</li> <li>Innodb_row_lock_waits: 系统启动后到现在总共等待的次数.</li></ul> <p>对于这 5 个状态变量, 比较重要的主要是:</p> <ul><li><strong>Innodb_row_lock_time_avg</strong>: 等待平均时长</li> <li><strong>Innodb_row_lock_waits:</strong>  等待总次数</li> <li><strong>Innodb_row_lock_time:</strong>  等待总时长</li></ul> <p>尤其是当<strong>等待次数很高</strong>, 而且每次等待时长也不小的时候, 就需要分析系统中为什么会有如此多的等待, 然后根据分析结果着手制定优化计划.</p> <h4 id="死锁"><a href="#死锁" class="header-anchor">#</a> 死锁</h4> <p>死锁基础参考: 进程死锁.</p> <p>下面的语句产生死锁.</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token comment">-- 设置隔离级别为可重复读</span>
<span class="token keyword">SET</span> tx_isolation <span class="token operator">=</span> <span class="token string">'repeatable-read'</span><span class="token punctuation">;</span>
Session_1执行: <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> account <span class="token keyword">WHERE</span> id <span class="token operator">=</span> <span class="token number">1</span> <span class="token keyword">FOR</span> <span class="token keyword">UPDATE</span><span class="token punctuation">;</span> <span class="token comment"># 事务1尝试给id=1加写锁</span>
Session_2执行: <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> account <span class="token keyword">WHERE</span> id <span class="token operator">=</span> <span class="token number">2</span> <span class="token keyword">FOR</span> <span class="token keyword">UPDATE</span><span class="token punctuation">;</span> <span class="token comment"># 事务2尝试给id=2加写锁</span>
Session_1执行: <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> account <span class="token keyword">WHERE</span> id <span class="token operator">=</span> <span class="token number">2</span> <span class="token keyword">FOR</span> <span class="token keyword">UPDATE</span><span class="token punctuation">;</span> <span class="token comment"># 事务1尝试给id=2加写锁</span>
Session_2执行: <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> account <span class="token keyword">WHERE</span> id <span class="token operator">=</span> <span class="token number">1</span> <span class="token keyword">FOR</span> <span class="token keyword">UPDATE</span><span class="token punctuation">;</span> <span class="token comment"># 事务2尝试给id=1加写锁</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>查看近期死锁日志信息:</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">SHOW</span> <span class="token keyword">engine</span> <span class="token keyword">innodb</span> <span class="token keyword">STATUS</span>\G<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>大多数情况 MySQL 可以<strong>自动检测死锁</strong>并回滚产生死锁的那个事务. 但是有些情况没法自动检测死锁, 这种情况可以通过日志分析找到<strong>对应事务线程 id, 可以通过 kill 杀掉</strong>.</p> <p>InnoDB 目前处理死锁的方法是, <strong>将持有最少行级排他锁的事务进行回滚</strong>, 这是相对比较简单的死锁回滚算法.</p> <h4 id="锁优化实践"><a href="#锁优化实践" class="header-anchor">#</a> 锁优化实践</h4> <ul><li>尽可能让所有<strong>数据检索都通过索引来完成</strong>, 避免<strong>无索引行锁升级为表锁</strong>. 同时合理设计索引, 尽量<strong>缩小锁的范围</strong>.</li> <li>尽可能减少检索条件范围, 避免间隙锁.</li> <li>尽量<strong>控制事务大小</strong>, 减少锁定资源量和时间长度, 涉及事务加锁的 SQL 尽量放在事务最后执行. 尽可能低级别事务隔离.</li> <li><strong>使用乐观锁</strong>. 有的场景可以考虑使用乐观锁。比如正常的悲观锁都是使用了 <code>SELECT FOR UPDATE</code>​ 语句, 查询到数据之后, 进行一串计算, 再将结果写回去. 那么改造的方案很简单, 查询的时候使用 SELECT 语句直接查询, 然后进行计算. 修改的时候使用 <code>UPDATE xxx SET data = newData WHERE id = 1 AND data = oldData</code>​ 这样的乐观锁的思想.</li></ul> <p>‍</p> <p>‍</p> <p>‍</p> <h4 id="参考资料"><a href="#参考资料" class="header-anchor">#</a> 参考资料</h4> <ul><li><a href="https://www.cnblogs.com/better-farther-world2099/articles/14955475.html" title="发布于 2021-07-03 14:34" target="_blank" rel="noopener noreferrer">彻底搞懂 MySQL 中的锁机制<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div>  <div class="page-edit"><div class="edit-link"><a href="https://github.com/xugaoyi/vuepress-theme-vdoing/edit/main/docs/20.开发/2100.开发/200.数据库/220.MySQL锁🌟.md" target="_blank" rel="noopener noreferrer">编辑</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <!----> <!----></div> <div class="page-nav-wapper"><div class="page-nav-centre-wrap"><a href="/pages/07bdb6/" class="page-nav-centre page-nav-centre-prev"><div class="tooltip">MySQL索引🌟</div></a> <a href="/pages/53b588/" class="page-nav-centre page-nav-centre-next"><div class="tooltip">MySQL事务🌟</div></a></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/pages/07bdb6/" class="prev">MySQL索引🌟</a></span> <span class="next"><a href="/pages/53b588/">MySQL事务🌟</a>→
      </span></p></div></div></div> <!----></main></div> <div class="footer"><div class="icons"><a href="mailto:1174520425@qq.com" title="发邮件" target="_blank" class="iconfont icon-youjian"></a><a href="https://github.com/nanodaemony" title="GitHub" target="_blank" class="iconfont icon-github"></a></div> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="本站主题">Vdoing</a> 
    | Copyright © 2019-2025
    <span>达尔文的猹 | MIT License</span></div> <div class="buttons"><div title="返回顶部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去评论" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主题模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          跟随系统
        </li><li class="iconfont icon-rijianmoshi">
          浅色模式
        </li><li class="iconfont icon-yejianmoshi">
          深色模式
        </li><li class="iconfont icon-yuedu">
          阅读模式
        </li></ul></div></div> <!----> <!----> <!----></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.3f3e0e10.js" defer></script><script src="/assets/js/2.e9fcb30c.js" defer></script><script src="/assets/js/3.1998f389.js" defer></script><script src="/assets/js/102.e31e89b2.js" defer></script>
  </body>
</html>
