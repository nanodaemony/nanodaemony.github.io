<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>MySQL优化 | Pangolin Note</title>
    <meta name="generator" content="VuePress 1.9.5">
    <link rel="icon" href="/img/favicon.ico">
    <meta name="description" content="大道至简">
    <meta name="keywords" content="前端博客,个人技术博客,前端,前端开发,前端框架,web前端,前端面试题,技术文档,学习,面试,JavaScript,js,ES6,TypeScript,vue,python,css3,html5,Node,git,github,markdown">
    <meta name="baidu-site-verification" content="7F55weZDDc">
    <meta name="theme-color" content="#11a8cd">
    
    <link rel="preload" href="/assets/css/0.styles.56073ad3.css" as="style"><link rel="preload" href="/assets/js/app.3f3e0e10.js" as="script"><link rel="preload" href="/assets/js/2.e9fcb30c.js" as="script"><link rel="preload" href="/assets/js/3.1998f389.js" as="script"><link rel="preload" href="/assets/js/108.b488ce56.js" as="script"><link rel="prefetch" href="/assets/js/10.0b55747f.js"><link rel="prefetch" href="/assets/js/100.b8912a99.js"><link rel="prefetch" href="/assets/js/101.a6740c8a.js"><link rel="prefetch" href="/assets/js/102.e31e89b2.js"><link rel="prefetch" href="/assets/js/103.2c5dbdae.js"><link rel="prefetch" href="/assets/js/104.0e9c02f6.js"><link rel="prefetch" href="/assets/js/105.8288396c.js"><link rel="prefetch" href="/assets/js/106.62f43c11.js"><link rel="prefetch" href="/assets/js/107.70c90211.js"><link rel="prefetch" href="/assets/js/109.12942650.js"><link rel="prefetch" href="/assets/js/11.ac3fd1ca.js"><link rel="prefetch" href="/assets/js/110.1e57ecba.js"><link rel="prefetch" href="/assets/js/111.6e33b4ea.js"><link rel="prefetch" href="/assets/js/112.bd52831b.js"><link rel="prefetch" href="/assets/js/113.868c1ac9.js"><link rel="prefetch" href="/assets/js/114.090549d1.js"><link rel="prefetch" href="/assets/js/115.d97f6c2b.js"><link rel="prefetch" href="/assets/js/116.097c4b4e.js"><link rel="prefetch" href="/assets/js/117.4024cfe2.js"><link rel="prefetch" href="/assets/js/118.e3057cba.js"><link rel="prefetch" href="/assets/js/119.4ef1fa3b.js"><link rel="prefetch" href="/assets/js/12.863eaabe.js"><link rel="prefetch" href="/assets/js/120.78f9df50.js"><link rel="prefetch" href="/assets/js/121.8e16df87.js"><link rel="prefetch" href="/assets/js/122.f21c0107.js"><link rel="prefetch" href="/assets/js/123.ea1cb375.js"><link rel="prefetch" href="/assets/js/124.01c04c6e.js"><link rel="prefetch" href="/assets/js/125.d383e301.js"><link rel="prefetch" href="/assets/js/126.3162cb47.js"><link rel="prefetch" href="/assets/js/127.c6bebae6.js"><link rel="prefetch" href="/assets/js/128.d659db60.js"><link rel="prefetch" href="/assets/js/129.2afdcf48.js"><link rel="prefetch" href="/assets/js/13.4f59ce35.js"><link rel="prefetch" href="/assets/js/130.beb9ed9d.js"><link rel="prefetch" href="/assets/js/131.35b05f8a.js"><link rel="prefetch" href="/assets/js/132.d77f4f93.js"><link rel="prefetch" href="/assets/js/133.4ceda6e5.js"><link rel="prefetch" href="/assets/js/134.11390c5f.js"><link rel="prefetch" href="/assets/js/135.32f9e38f.js"><link rel="prefetch" href="/assets/js/136.6d8bb0f2.js"><link rel="prefetch" href="/assets/js/137.9c0ffeef.js"><link rel="prefetch" href="/assets/js/138.88d86e5f.js"><link rel="prefetch" href="/assets/js/139.8c2c3d6c.js"><link rel="prefetch" href="/assets/js/14.11c82d35.js"><link rel="prefetch" href="/assets/js/140.c5c375d3.js"><link rel="prefetch" href="/assets/js/141.d703f30b.js"><link rel="prefetch" href="/assets/js/142.6a005a44.js"><link rel="prefetch" href="/assets/js/143.9b2edf6f.js"><link rel="prefetch" href="/assets/js/144.3fd013c9.js"><link rel="prefetch" href="/assets/js/145.b05079c5.js"><link rel="prefetch" href="/assets/js/146.ed5360a6.js"><link rel="prefetch" href="/assets/js/147.7408d86f.js"><link rel="prefetch" href="/assets/js/148.f390b370.js"><link rel="prefetch" href="/assets/js/149.95017f0a.js"><link rel="prefetch" href="/assets/js/15.bd143bd5.js"><link rel="prefetch" href="/assets/js/150.f0ede764.js"><link rel="prefetch" href="/assets/js/151.b7093623.js"><link rel="prefetch" href="/assets/js/152.a82a6c83.js"><link rel="prefetch" href="/assets/js/153.965e3fb2.js"><link rel="prefetch" href="/assets/js/154.9e49311e.js"><link rel="prefetch" href="/assets/js/155.cef33ba5.js"><link rel="prefetch" href="/assets/js/156.bcc397ae.js"><link rel="prefetch" href="/assets/js/157.90824739.js"><link rel="prefetch" href="/assets/js/158.efd429b9.js"><link rel="prefetch" href="/assets/js/159.122ff5b7.js"><link rel="prefetch" href="/assets/js/16.2449162b.js"><link rel="prefetch" href="/assets/js/160.0b806535.js"><link rel="prefetch" href="/assets/js/161.835052c6.js"><link rel="prefetch" href="/assets/js/162.ca34e2d2.js"><link rel="prefetch" href="/assets/js/163.08000d04.js"><link rel="prefetch" href="/assets/js/164.a1cc0109.js"><link rel="prefetch" href="/assets/js/165.65444686.js"><link rel="prefetch" href="/assets/js/166.7d73c84f.js"><link rel="prefetch" href="/assets/js/167.009d47a3.js"><link rel="prefetch" href="/assets/js/168.0afeae2a.js"><link rel="prefetch" href="/assets/js/169.7654cb31.js"><link rel="prefetch" href="/assets/js/17.eb7f9def.js"><link rel="prefetch" href="/assets/js/170.58569530.js"><link rel="prefetch" href="/assets/js/171.7db9ed40.js"><link rel="prefetch" href="/assets/js/172.3cb50ed4.js"><link rel="prefetch" href="/assets/js/173.0846425f.js"><link rel="prefetch" href="/assets/js/174.9e95f111.js"><link rel="prefetch" href="/assets/js/175.ef2098f2.js"><link rel="prefetch" href="/assets/js/176.c2635fe9.js"><link rel="prefetch" href="/assets/js/177.4fa38e8e.js"><link rel="prefetch" href="/assets/js/178.2be7037f.js"><link rel="prefetch" href="/assets/js/179.bf3bba28.js"><link rel="prefetch" href="/assets/js/18.0455f4d1.js"><link rel="prefetch" href="/assets/js/180.72c5f597.js"><link rel="prefetch" href="/assets/js/181.42287bcc.js"><link rel="prefetch" href="/assets/js/182.6cd4bf1a.js"><link rel="prefetch" href="/assets/js/183.05dbbfd9.js"><link rel="prefetch" href="/assets/js/184.03de7e00.js"><link rel="prefetch" href="/assets/js/185.42dd210e.js"><link rel="prefetch" href="/assets/js/186.28ee0f8a.js"><link rel="prefetch" href="/assets/js/187.bb58697b.js"><link rel="prefetch" href="/assets/js/188.1bc8be96.js"><link rel="prefetch" href="/assets/js/189.fac747e3.js"><link rel="prefetch" href="/assets/js/19.ae9e35d6.js"><link rel="prefetch" href="/assets/js/190.ea533ac7.js"><link rel="prefetch" href="/assets/js/191.6dc6eb13.js"><link rel="prefetch" href="/assets/js/192.184d249f.js"><link rel="prefetch" href="/assets/js/193.4a06bc12.js"><link rel="prefetch" href="/assets/js/194.8cce60a9.js"><link rel="prefetch" href="/assets/js/195.93231a13.js"><link rel="prefetch" href="/assets/js/196.4a596bde.js"><link rel="prefetch" href="/assets/js/197.96c113cf.js"><link rel="prefetch" href="/assets/js/198.73ba3f67.js"><link rel="prefetch" href="/assets/js/199.74bab595.js"><link rel="prefetch" href="/assets/js/20.b542d0e7.js"><link rel="prefetch" href="/assets/js/200.69a6928a.js"><link rel="prefetch" href="/assets/js/201.9ffa7c5a.js"><link rel="prefetch" href="/assets/js/202.41edb652.js"><link rel="prefetch" href="/assets/js/203.7fabcef3.js"><link rel="prefetch" href="/assets/js/204.b0ae2f62.js"><link rel="prefetch" href="/assets/js/205.add8738b.js"><link rel="prefetch" href="/assets/js/206.f3a712ec.js"><link rel="prefetch" href="/assets/js/207.cd7dd729.js"><link rel="prefetch" href="/assets/js/208.78b33afa.js"><link rel="prefetch" href="/assets/js/209.9d3329ff.js"><link rel="prefetch" href="/assets/js/21.5a050318.js"><link rel="prefetch" href="/assets/js/210.d285d5ac.js"><link rel="prefetch" href="/assets/js/211.8791bb3f.js"><link rel="prefetch" href="/assets/js/212.84ed81a8.js"><link rel="prefetch" href="/assets/js/213.7b990580.js"><link rel="prefetch" href="/assets/js/214.da31f20c.js"><link rel="prefetch" href="/assets/js/215.9eeed659.js"><link rel="prefetch" href="/assets/js/216.9539f0ec.js"><link rel="prefetch" href="/assets/js/217.11b575be.js"><link rel="prefetch" href="/assets/js/218.a67f12f1.js"><link rel="prefetch" href="/assets/js/219.bfbb817a.js"><link rel="prefetch" href="/assets/js/22.2bc6f7e3.js"><link rel="prefetch" href="/assets/js/220.8b01342f.js"><link rel="prefetch" href="/assets/js/221.b450decd.js"><link rel="prefetch" href="/assets/js/222.97468507.js"><link rel="prefetch" href="/assets/js/223.b6dafd73.js"><link rel="prefetch" href="/assets/js/224.c86c18c6.js"><link rel="prefetch" href="/assets/js/225.b0dcf86e.js"><link rel="prefetch" href="/assets/js/226.02cc2999.js"><link rel="prefetch" href="/assets/js/227.8474ef5a.js"><link rel="prefetch" href="/assets/js/228.0298e421.js"><link rel="prefetch" href="/assets/js/229.6aeaf595.js"><link rel="prefetch" href="/assets/js/23.9995fce4.js"><link rel="prefetch" href="/assets/js/230.a5785286.js"><link rel="prefetch" href="/assets/js/231.d791daa4.js"><link rel="prefetch" href="/assets/js/232.97aeeb00.js"><link rel="prefetch" href="/assets/js/233.46e51e28.js"><link rel="prefetch" href="/assets/js/234.2cffe82f.js"><link rel="prefetch" href="/assets/js/235.14965da6.js"><link rel="prefetch" href="/assets/js/236.00a5afc0.js"><link rel="prefetch" href="/assets/js/237.3b73d52f.js"><link rel="prefetch" href="/assets/js/238.6e1db765.js"><link rel="prefetch" href="/assets/js/239.75866c5e.js"><link rel="prefetch" href="/assets/js/24.9141eeb2.js"><link rel="prefetch" href="/assets/js/240.af9c2cc9.js"><link rel="prefetch" href="/assets/js/241.388acab2.js"><link rel="prefetch" href="/assets/js/242.c60f2b48.js"><link rel="prefetch" href="/assets/js/243.d8e81b13.js"><link rel="prefetch" href="/assets/js/244.58b0b21d.js"><link rel="prefetch" href="/assets/js/245.c3768497.js"><link rel="prefetch" href="/assets/js/246.ac8bbe7a.js"><link rel="prefetch" href="/assets/js/247.d095f70a.js"><link rel="prefetch" href="/assets/js/248.e9f210b5.js"><link rel="prefetch" href="/assets/js/249.a9fad023.js"><link rel="prefetch" href="/assets/js/25.98e8593e.js"><link rel="prefetch" href="/assets/js/250.ae7f0ebb.js"><link rel="prefetch" href="/assets/js/251.9a617d55.js"><link rel="prefetch" href="/assets/js/252.ce082446.js"><link rel="prefetch" href="/assets/js/253.4575302d.js"><link rel="prefetch" href="/assets/js/254.5899a61b.js"><link rel="prefetch" href="/assets/js/255.66c69f31.js"><link rel="prefetch" href="/assets/js/256.8fd6c706.js"><link rel="prefetch" href="/assets/js/257.31b77e5e.js"><link rel="prefetch" href="/assets/js/258.eba48891.js"><link rel="prefetch" href="/assets/js/259.edf74b59.js"><link rel="prefetch" href="/assets/js/26.e69924ea.js"><link rel="prefetch" href="/assets/js/260.cf2ed36d.js"><link rel="prefetch" href="/assets/js/261.9e7792d8.js"><link rel="prefetch" href="/assets/js/262.e7b9433e.js"><link rel="prefetch" href="/assets/js/263.1185b25c.js"><link rel="prefetch" href="/assets/js/264.5e0f89cb.js"><link rel="prefetch" href="/assets/js/265.a38d3b94.js"><link rel="prefetch" href="/assets/js/266.2ef170b3.js"><link rel="prefetch" href="/assets/js/267.a7d14651.js"><link rel="prefetch" href="/assets/js/268.05b18748.js"><link rel="prefetch" href="/assets/js/269.dad48d6f.js"><link rel="prefetch" href="/assets/js/27.13612515.js"><link rel="prefetch" href="/assets/js/270.4f5a6b8d.js"><link rel="prefetch" href="/assets/js/271.7ebf6682.js"><link rel="prefetch" href="/assets/js/272.7c2fbfd1.js"><link rel="prefetch" href="/assets/js/273.8ee20732.js"><link rel="prefetch" href="/assets/js/274.d525242a.js"><link rel="prefetch" href="/assets/js/275.a8a19acb.js"><link rel="prefetch" href="/assets/js/276.df3a4eb4.js"><link rel="prefetch" href="/assets/js/277.336debda.js"><link rel="prefetch" href="/assets/js/278.c470625f.js"><link rel="prefetch" href="/assets/js/279.a91e1a64.js"><link rel="prefetch" href="/assets/js/28.ab7ae1df.js"><link rel="prefetch" href="/assets/js/280.87e25c9a.js"><link rel="prefetch" href="/assets/js/281.87c1ba25.js"><link rel="prefetch" href="/assets/js/282.dcd4dce0.js"><link rel="prefetch" href="/assets/js/283.abac2e00.js"><link rel="prefetch" href="/assets/js/284.f6079659.js"><link rel="prefetch" href="/assets/js/285.f1b39879.js"><link rel="prefetch" href="/assets/js/286.f6a79242.js"><link rel="prefetch" href="/assets/js/287.06bebe07.js"><link rel="prefetch" href="/assets/js/288.89e325df.js"><link rel="prefetch" href="/assets/js/289.3aa1bedd.js"><link rel="prefetch" href="/assets/js/29.ebe50f76.js"><link rel="prefetch" href="/assets/js/290.ee059c92.js"><link rel="prefetch" href="/assets/js/291.fa9a921a.js"><link rel="prefetch" href="/assets/js/292.2a8811cd.js"><link rel="prefetch" href="/assets/js/293.eec09cdf.js"><link rel="prefetch" href="/assets/js/294.dfac20dc.js"><link rel="prefetch" href="/assets/js/295.825d2070.js"><link rel="prefetch" href="/assets/js/296.f645861e.js"><link rel="prefetch" href="/assets/js/297.424fdb17.js"><link rel="prefetch" href="/assets/js/298.ebf87cdc.js"><link rel="prefetch" href="/assets/js/299.b8f19cbb.js"><link rel="prefetch" href="/assets/js/30.75237511.js"><link rel="prefetch" href="/assets/js/300.10fb6d4f.js"><link rel="prefetch" href="/assets/js/301.ef77c612.js"><link rel="prefetch" href="/assets/js/302.1b839763.js"><link rel="prefetch" href="/assets/js/303.609f7d98.js"><link rel="prefetch" href="/assets/js/304.1d255f19.js"><link rel="prefetch" href="/assets/js/305.b0234f2c.js"><link rel="prefetch" href="/assets/js/306.48677f64.js"><link rel="prefetch" href="/assets/js/307.14390d4b.js"><link rel="prefetch" href="/assets/js/308.fa730b28.js"><link rel="prefetch" href="/assets/js/309.0496b9e0.js"><link rel="prefetch" href="/assets/js/31.cf3f471a.js"><link rel="prefetch" href="/assets/js/310.a31676dc.js"><link rel="prefetch" href="/assets/js/311.ed53adc5.js"><link rel="prefetch" href="/assets/js/312.1b0ff2f1.js"><link rel="prefetch" href="/assets/js/313.bf123f32.js"><link rel="prefetch" href="/assets/js/314.4e6ce06b.js"><link rel="prefetch" href="/assets/js/315.8eb18560.js"><link rel="prefetch" href="/assets/js/32.74fef842.js"><link rel="prefetch" href="/assets/js/33.bc2d190b.js"><link rel="prefetch" href="/assets/js/34.d23438fc.js"><link rel="prefetch" href="/assets/js/35.7675c4d0.js"><link rel="prefetch" href="/assets/js/36.96a4161b.js"><link rel="prefetch" href="/assets/js/37.d1824f2f.js"><link rel="prefetch" href="/assets/js/38.4effff9e.js"><link rel="prefetch" href="/assets/js/39.6509914b.js"><link rel="prefetch" href="/assets/js/4.4d01750f.js"><link rel="prefetch" href="/assets/js/40.1509d08b.js"><link rel="prefetch" href="/assets/js/41.f2c1124f.js"><link rel="prefetch" href="/assets/js/42.e541d077.js"><link rel="prefetch" href="/assets/js/43.369de999.js"><link rel="prefetch" href="/assets/js/44.43959db0.js"><link rel="prefetch" href="/assets/js/45.282fbd31.js"><link rel="prefetch" href="/assets/js/46.1b83cfe9.js"><link rel="prefetch" href="/assets/js/47.c3a88e41.js"><link rel="prefetch" href="/assets/js/48.bc7c0a1b.js"><link rel="prefetch" href="/assets/js/49.92a4e5ba.js"><link rel="prefetch" href="/assets/js/5.c3991e24.js"><link rel="prefetch" href="/assets/js/50.9c488c6c.js"><link rel="prefetch" href="/assets/js/51.546ea632.js"><link rel="prefetch" href="/assets/js/52.0d2ccee1.js"><link rel="prefetch" href="/assets/js/53.6f52b5b1.js"><link rel="prefetch" href="/assets/js/54.c838b295.js"><link rel="prefetch" href="/assets/js/55.13af99ee.js"><link rel="prefetch" href="/assets/js/56.6be6d1ed.js"><link rel="prefetch" href="/assets/js/57.67c98b39.js"><link rel="prefetch" href="/assets/js/58.107e82ec.js"><link rel="prefetch" href="/assets/js/59.b3e5edc7.js"><link rel="prefetch" href="/assets/js/6.36a535f9.js"><link rel="prefetch" href="/assets/js/60.3b0b4ba5.js"><link rel="prefetch" href="/assets/js/61.3df843df.js"><link rel="prefetch" href="/assets/js/62.1213823d.js"><link rel="prefetch" href="/assets/js/63.e8f3f926.js"><link rel="prefetch" href="/assets/js/64.e1219050.js"><link rel="prefetch" href="/assets/js/65.5bf5bb0b.js"><link rel="prefetch" href="/assets/js/66.a2502afb.js"><link rel="prefetch" href="/assets/js/67.690dd59b.js"><link rel="prefetch" href="/assets/js/68.de7b0915.js"><link rel="prefetch" href="/assets/js/69.ac61dd61.js"><link rel="prefetch" href="/assets/js/7.5d254238.js"><link rel="prefetch" href="/assets/js/70.3edd41b1.js"><link rel="prefetch" href="/assets/js/71.d23407e9.js"><link rel="prefetch" href="/assets/js/72.a5bd01bc.js"><link rel="prefetch" href="/assets/js/73.c9f4dd57.js"><link rel="prefetch" href="/assets/js/74.66323fc1.js"><link rel="prefetch" href="/assets/js/75.e1a72e00.js"><link rel="prefetch" href="/assets/js/76.801268b4.js"><link rel="prefetch" href="/assets/js/77.3a5fda67.js"><link rel="prefetch" href="/assets/js/78.54d84cd4.js"><link rel="prefetch" href="/assets/js/79.fa10f4e3.js"><link rel="prefetch" href="/assets/js/8.e060e47d.js"><link rel="prefetch" href="/assets/js/80.d5b24fea.js"><link rel="prefetch" href="/assets/js/81.0e9da714.js"><link rel="prefetch" href="/assets/js/82.e96ff6d7.js"><link rel="prefetch" href="/assets/js/83.771cced1.js"><link rel="prefetch" href="/assets/js/84.220b69e7.js"><link rel="prefetch" href="/assets/js/85.7dcc5659.js"><link rel="prefetch" href="/assets/js/86.44ba2100.js"><link rel="prefetch" href="/assets/js/87.281da75d.js"><link rel="prefetch" href="/assets/js/88.12d88449.js"><link rel="prefetch" href="/assets/js/89.f28c86d3.js"><link rel="prefetch" href="/assets/js/9.8f9fef32.js"><link rel="prefetch" href="/assets/js/90.715cabb2.js"><link rel="prefetch" href="/assets/js/91.6ced7c82.js"><link rel="prefetch" href="/assets/js/92.c05b33ca.js"><link rel="prefetch" href="/assets/js/93.6bf5fb66.js"><link rel="prefetch" href="/assets/js/94.3561200e.js"><link rel="prefetch" href="/assets/js/95.0f2cf716.js"><link rel="prefetch" href="/assets/js/96.ac8487ea.js"><link rel="prefetch" href="/assets/js/97.48042b5a.js"><link rel="prefetch" href="/assets/js/98.441bb7f8.js"><link rel="prefetch" href="/assets/js/99.4b214d92.js">
    <link rel="stylesheet" href="/assets/css/0.styles.56073ad3.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu"><header class="navbar blur"><div title="目录" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/img/magic.png" alt="Pangolin Note" class="logo"> <span class="site-name can-hide">Pangolin Note</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">🏡首页</a></div><div class="nav-item"><a href="/basic/" class="nav-link">基础</a></div><div class="nav-item"><a href="/develop/" class="nav-link">开发</a></div><div class="nav-item"><a href="/middleware/" class="nav-link">系统</a></div><div class="nav-item"><a href="/algorithm/" class="nav-link">算法</a></div><div class="nav-item"><a href="/books/" class="nav-link">🍀读书笔记</a></div><div class="nav-item"><a href="/work/" class="nav-link">工作</a></div><div class="nav-item"><a href="/pangolin/" class="nav-link">🌸达尔文的猹</a></div><div class="nav-item"><a href="/pages/beb6c0bd8a66cea6/" class="nav-link">收藏</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/archives/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">归档</a></li></ul></div></div> <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><div class="blogger"><img src="/img/avatarnew.png"> <div class="blogger-info"><h3>达尔文的猹</h3> <span>大道至简 悟在天成</span></div></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">🏡首页</a></div><div class="nav-item"><a href="/basic/" class="nav-link">基础</a></div><div class="nav-item"><a href="/develop/" class="nav-link">开发</a></div><div class="nav-item"><a href="/middleware/" class="nav-link">系统</a></div><div class="nav-item"><a href="/algorithm/" class="nav-link">算法</a></div><div class="nav-item"><a href="/books/" class="nav-link">🍀读书笔记</a></div><div class="nav-item"><a href="/work/" class="nav-link">工作</a></div><div class="nav-item"><a href="/pangolin/" class="nav-link">🌸达尔文的猹</a></div><div class="nav-item"><a href="/pages/beb6c0bd8a66cea6/" class="nav-link">收藏</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/archives/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">归档</a></li></ul></div></div> <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Java</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading open"><span>基础</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/4f30b9/" class="sidebar-link">Java基础</a></li><li><a href="/pages/795eca/" class="sidebar-link">类与继承</a></li><li><a href="/pages/c69152/" class="sidebar-link">抽象类与接口</a></li><li><a href="/pages/d71abb/" class="sidebar-link">内部类</a></li><li><a href="/pages/f06dca/" class="sidebar-link">枚举类</a></li><li><a href="/pages/259f57/" class="sidebar-link">常用类</a></li><li><a href="/pages/84b03b/" class="sidebar-link">关键字</a></li><li><a href="/pages/31b87b/" class="sidebar-link">注解</a></li><li><a href="/pages/f81c0d/" class="sidebar-link">异常</a></li><li><a href="/pages/ae7746/" class="sidebar-link">泛型</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading"><span>容器类</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/0c88ac/" class="sidebar-link">集合容器类基础</a></li><li><a href="/pages/f805ed/" class="sidebar-link">List与Queue类</a></li><li><a href="/pages/d24b60/" class="sidebar-link">Map与Set类</a></li><li><a href="/pages/54e5d3/" class="sidebar-link">并发容器类</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading"><span>并发</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/67d70f/" class="sidebar-link">多线程基础</a></li><li><a href="/pages/ffc8f7/" class="sidebar-link">Java内置锁</a></li><li><a href="/pages/c43494/" class="sidebar-link">AQS</a></li><li><a href="/pages/eb5b61/" class="sidebar-link">显式锁ReentrantLock</a></li><li><a href="/pages/eb8cbc/" class="sidebar-link">线程协作与JUC组件</a></li><li><a href="/pages/23c79a/" class="sidebar-link">Atomic原子变量与Unsafe类与CAS</a></li><li><a href="/pages/9d6ed4/" class="sidebar-link">线程池与定时任务</a></li><li><a href="/pages/5b787a/" class="sidebar-link">ThreadLocal</a></li><li><a href="/pages/db53d1/" class="sidebar-link">Java并发编程实战(极客时间)🌸</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading"><span>IO</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/b4d461/" class="sidebar-link">文件操作</a></li><li><a href="/pages/1b9d6c/" class="sidebar-link">IO流操作</a></li><li><a href="/pages/076a47/" class="sidebar-link">Java网络IO模型</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading"><span>高级特性</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/d76905/" class="sidebar-link">Lambda表达式</a></li><li><a href="/pages/f7f0e6/" class="sidebar-link">流Stream</a></li><li><a href="/pages/7cc40a/" class="sidebar-link">反射</a></li><li><a href="/pages/945326/" class="sidebar-link">代理</a></li><li><a href="/pages/7fd9b4/" class="sidebar-link">Javaagent</a></li><li><a href="/pages/a3cee0/" class="sidebar-link">Guava</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading"><span>JVM</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/d308f6/" class="sidebar-link">走进JVM🌼</a></li><li><a href="/pages/be0269/" class="sidebar-link">JVM内存区域与对象解析🌼</a></li><li><a href="/pages/48d1be/" class="sidebar-link">垃圾收集器与内存分配策略🌼</a></li><li><a href="/pages/3a4c8a/" class="sidebar-link">JVM性能监控与故障处理工具🌼</a></li><li><a href="/pages/106680/" class="sidebar-link">调优案例分析与实战🌼</a></li><li><a href="/pages/16a914/" class="sidebar-link">类文件结构🌼</a></li><li><a href="/pages/ea287c/" class="sidebar-link">虚拟机类加载机制🌼</a></li><li><a href="/pages/6367b0/" class="sidebar-link">虚拟机字节码执行引擎🌼</a></li><li><a href="/pages/c6c210/" class="sidebar-link">类加载及执行子系统的案例与实战🌼</a></li><li><a href="/pages/deb8b7/" class="sidebar-link">前端编译与优化🌼</a></li><li><a href="/pages/1f8f72/" class="sidebar-link">后端编译与优化🌼</a></li><li><a href="/pages/3d72db/" class="sidebar-link">Java内存模型与线程实现🌼</a></li><li><a href="/pages/ed086e/" class="sidebar-link">线程安全与内置锁优化🌼</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading"><span>其他</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/56b9dd/" class="sidebar-link">Java性能问题定位分析</a></li><li><a href="/pages/939bf8/" class="sidebar-link">杂记</a></li></ul></section></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>开发</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading"><span>软件设计</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/a5f6fe/" class="sidebar-link">设计基础理论</a></li><li><a href="/pages/3b245c/" class="sidebar-link">设计模式之美(极客时间)🌟</a></li><li><a href="/pages/661fa4/" class="sidebar-link">领域驱动设计(DDD)</a></li><li><a href="/pages/856368/" class="sidebar-link">DDD实战课(极客时间)🌸</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading open"><span>数据库</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/d3fbd2/" class="sidebar-link">数据库基础</a></li><li><a href="/pages/691fc3/" class="sidebar-link">数据库系统原理</a></li><li><a href="/pages/50f6b7/" class="sidebar-link">MySQL基础必知必会</a></li><li><a href="/pages/fe297e/" class="sidebar-link">MySQL特性</a></li><li><a href="/pages/07bdb6/" class="sidebar-link">MySQL索引🌟</a></li><li><a href="/pages/984715/" class="sidebar-link">MySQL锁🌟</a></li><li><a href="/pages/53b588/" class="sidebar-link">MySQL事务🌟</a></li><li><a href="/pages/becc59/" class="sidebar-link">MySQL高级特性</a></li><li><a href="/pages/056463/" class="sidebar-link">MySQL基础架构与存储引擎🌟</a></li><li><a href="/pages/63b46e/" class="sidebar-link">MySQL架构优化与运维</a></li><li><a href="/pages/9995e5/" aria-current="page" class="active sidebar-link">MySQL优化</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/pages/c1c2f6/" class="sidebar-link">MySQL架构</a></li><li><a href="/pages/8e8e0a/" class="sidebar-link">MySQL设计规范</a></li><li><a href="/pages/0219aa/" class="sidebar-link">MySQL运维</a></li><li><a href="/pages/e288c0/" class="sidebar-link">MySQL中间件</a></li><li><a href="/pages/c6cafa/" class="sidebar-link">MySQL实战45讲(极客时间)🌟</a></li><li><a href="/pages/4a6106/" class="sidebar-link">数据库LeetCode题目</a></li><li><a href="/pages/2827f1/" class="sidebar-link">数据库综合问题</a></li><li><a href="/pages/c616d5/" class="sidebar-link">MongoDB</a></li><li><a href="/pages/075e71/" class="sidebar-link">ClickHouse</a></li><li><a href="/pages/d74f6d/" class="sidebar-link">Doris</a></li><li><a href="/pages/b6bad9/" class="sidebar-link">HBase</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading"><span>Spring</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/bd8eb8/" class="sidebar-link">Spring Boot基础</a></li><li><a href="/pages/d0d797/" class="sidebar-link">Spring Boot应用整合</a></li><li><a href="/pages/314cdc/" class="sidebar-link">Spring MVC基础</a></li><li><a href="/pages/80de47/" class="sidebar-link">Spring AOP基础</a></li><li><a href="/pages/f0d4d6/" class="sidebar-link">Spring事务基础</a></li><li><a href="/pages/db6afe/" class="sidebar-link">Spring IOC源码分析-概览</a></li><li><a href="/pages/672e98/" class="sidebar-link">Spring IOC源码分析-getBean()</a></li><li><a href="/pages/695b90/" class="sidebar-link">Spring IOC源码分析-createBean()</a></li><li><a href="/pages/f89bcf/" class="sidebar-link">Spring AOP源码分析</a></li><li><a href="/pages/3b52f4/" class="sidebar-link">Spring事务源码分析</a></li><li><a href="/pages/186902/" class="sidebar-link">Spring Boot源码分析</a></li><li><a href="/pages/16bd1c/" class="sidebar-link">Spring MVC源码分析</a></li><li><a href="/pages/3d0c1f/" class="sidebar-link">Spring Cloud</a></li><li><a href="/pages/d56156/" class="sidebar-link">Spring编程常见错误50例(极客时间)🌸</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading"><span>MyBatis</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/bb032d/" class="sidebar-link">基础</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading"><span>工具与环境</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/c9cb6e/" class="sidebar-link">Arthas</a></li><li><a href="/pages/3172bb/" class="sidebar-link">Maven</a></li><li><a href="/pages/37f79a/" class="sidebar-link">Git</a></li><li><a href="/pages/db9f99/" class="sidebar-link">环境搭建与部署</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading"><span>测试</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/c725f5/" class="sidebar-link">测试基础</a></li><li><a href="/pages/7893a4/" class="sidebar-link">单元测试</a></li><li><a href="/pages/af9f25/" class="sidebar-link">压力测试</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading"><span>代码质量</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/ec2b81/" class="sidebar-link">代码整洁之道</a></li><li><a href="/pages/474cdf/" class="sidebar-link">阿里巴巴编程规范</a></li><li><a href="/pages/c47e15/" class="sidebar-link">代码之丑(极客时间)🌸</a></li><li><a href="/pages/4d4606/" class="sidebar-link">Java业务开发常见错误100例(极客时间)🌸</a></li></ul></section></li></ul></section></li></ul> </aside> <div><main class="page"><div class="theme-vdoing-wrapper "><div class="articleInfo-wrap" data-v-06970110><div class="articleInfo" data-v-06970110><ul class="breadcrumbs" data-v-06970110><li data-v-06970110><a href="/" title="首页" class="iconfont icon-home router-link-active" data-v-06970110></a></li> <li data-v-06970110><a href="/develop/#开发" data-v-06970110>开发</a></li><li data-v-06970110><a href="/develop/#开发" data-v-06970110>开发</a></li><li data-v-06970110><a href="/develop/#数据库" data-v-06970110>数据库</a></li></ul> <div class="info" data-v-06970110><div title="作者" class="author iconfont icon-touxiang" data-v-06970110><a href="https://github.com/nanodaemony" target="_blank" title="作者" class="beLink" data-v-06970110>NanoDaemony</a></div> <div title="创建时间" class="date iconfont icon-riqi" data-v-06970110><a href="javascript:;" data-v-06970110>2025-02-26</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-title">本文目录</div> <div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABGpJREFUSA3tVVtoXFUU3fvOI53UlmCaKIFmwEhsE7QK0ipFEdHEKpXaZGrp15SINsXUWvBDpBgQRKi0+KKoFeJHfZA+ED9KKoIU2gYD9UejTW4rVIzm0VSTziPzuNu1z507dibTTjL4U/DAzLn3nL3X2o91ziX6f9wMFdh6Jvbm9nNSV0msViVO6tN1Rm7NMu2OpeJ9lWBUTDxrJbYTS0hInuwciu9eLHlFxCLCZEk3MegsJmZ5K/JD6t7FkFdEvGUo1g7qJoG3MHImqRIn8/nzY1K9UPKKiJmtnUqHVE3Gbuay6vJE/N2FEmuxFjW2nUuE0yQXRRxLiTUAzs36zhZvOXJPdX850EVnnLZkB8prodQoM5JGj7Xk2mvC7JB8tG04Ef5PiXtG0UtxupRQSfTnBoCy554x18yJHI6I+G5Eru4LHmPJZEQsrvPUbMiA8G/WgMK7w7I+ez7++o2ANfbrjvaOl1tFMs+htG3IrZH9/hDX1Pr8Tc0UvH8tcX29KzAgIGcEkINyW5BF9x891hw6VYqgJHEk0huccS7vh3C6gTiODL+26huuBtbct8eZnqLML8PkxGYpuPZBqtqwkSjgc4mB5gbgig5i+y0UDK35LMxXisn9xQtK+nd26gTIHsHe/oblK/b29fUmN/8Y+9jAQrnBp56m1LcDlDp9irKTExSKduXJVWSqdBMA08pEJnEIOB3FPPMybu/oeV8zFeYN3xx576Q6RH+VmplE4ncQV5v+5rzSoyOU7PuEAg8g803PwBJ0CExno/jcMbN8tONYeOmHiuUNryvm3fRUy4tMPVLdAGkUhNWuggGrJcXPv+ouCjz0MKUHz1J2/E8IC9nqTabcxgaBYM0hPhD5Y65FsbxRQKxCQrDjDctW7PUM3HuZunFyifSAqEfuzCp48Il24luWUWZoyJCaPR82jE0+kFA643wRFVni4RYSq3ohJO2pZ7B5dO4xkDWbEpossJPLSrPjYID8rS2UHTlvyNxqIGsg674XJJ7vnh5L7PNwC4hh2sjCI96mzszOTpxLF0T7l88Yz7lAuK6OnL8gXLOnTvpzSb22YG8W7us3jSebFHeeqnXRG1vt+MoUM84LQIBmMsCTAcOauTh0T0l0neQK7m2bLMt2mGxU3HYssS0J2cdv5wljlPsrIuZLAG/2DOZIXgCYT8uMGZN+e2kSirfxZOPCsC0f24nTZzspnVn9VePS1Z5vubmAGGXG8ZFno9Hel0yfA5ZPhF7Dh972BQJ2qCpgH67lmWtBYbvk6sz02wjky2vXyz0XErP/kFB619js1BtwfOV4OPRqOQBjy3Qbk18vigUPPSD5ceHnwck7W9bhAqZdd7SuG7w4/P2F/GaJh8c7e9qgow+Q7cGBo+98WsLkuktFqiZabtXuQTu/Y5ETbR0v7tNSFnvrmu6pjdoan2KjMu8q/Hmj1EfCO2ZGfEIbIXKUlw8qaX9/b2oeSJmFksSeT/Fn0V3nSypChh4Gjh74ybO9aeZ/AN2dwciu2/MhAAAAAElFTkSuQmCC">MySQL优化<!----></h1>  <div class="theme-vdoing-content content__default"><h1 id="_310-mysql优化"><a href="#_310-mysql优化" class="header-anchor">#</a> 310.MySQL优化</h1> <h3 id="一-基础"><a href="#一-基础" class="header-anchor">#</a> 一.基础</h3> <p>下图是优化的手段及其收益成本的经验图, 可以看出 SQL 及索引的优化效果是最好的, 而且成本最低, 所以工作中要在这块花更多时间.</p> <p>​<img src="https://nano-note.oss-cn-beijing.aliyuncs.com/images/image-20250225210003-6nyp3en.png" alt="image">​</p> <p>数据库优化主要包含以下内容:</p> <ul><li><strong>硬件资源优化</strong>: 换更大更强的机器.</li> <li><strong>操作系统优化</strong>: 调整操作系统的某些设置.</li> <li><strong>服务器/引擎优化</strong>: 也就是针对数据库软件本体进行优化, 比如说调整事务隔离级别. 在 MySQL 里面还可以针对不同的引擎做优化, 比如说调整 InnoDB 引擎的日志刷盘时机.</li> <li><strong>SQL 优化</strong>: 针对的就是 SQL 本身了.</li></ul> <p>如果站在数据库的角度, 那么 SQL 优化就是为了达到两个目标.</p> <ol><li><strong>减少磁盘 IO</strong>, 这个又可以说是尽量避免全表扫描, 尽量使用索引以及尽量使用覆盖索引.</li> <li><strong>减少内存 CPU 消耗</strong>, 这一部分主要是尽可能减少排序, 分组, 去重之类的操作.</li></ol> <h4 id="优化工具"><a href="#优化工具" class="header-anchor">#</a> 优化工具</h4> <p>如果想要知道优化后的效果, 优化相关的工具必不可少.</p> <p>先来个表:</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">`</span>employees<span class="token punctuation">`</span></span> <span class="token punctuation">(</span>
    <span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>name<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">24</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">''</span> <span class="token keyword">COMMENT</span> <span class="token string">'姓名'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>age<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">'0'</span> <span class="token keyword">COMMENT</span> <span class="token string">'年龄'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>position<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">''</span> <span class="token keyword">COMMENT</span> <span class="token string">'职位'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>hire_time<span class="token punctuation">`</span></span> <span class="token keyword">timestamp</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CURRENT_TIMESTAMP</span> <span class="token keyword">COMMENT</span> <span class="token string">'入职时间'</span><span class="token punctuation">,</span> 
    <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token keyword">KEY</span> <span class="token identifier"><span class="token punctuation">`</span>idx_name_age_position<span class="token punctuation">`</span></span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>name<span class="token punctuation">`</span></span><span class="token punctuation">,</span><span class="token identifier"><span class="token punctuation">`</span>age<span class="token punctuation">`</span></span><span class="token punctuation">,</span><span class="token identifier"><span class="token punctuation">`</span>position<span class="token punctuation">`</span></span><span class="token punctuation">)</span> <span class="token keyword">USING</span> <span class="token keyword">BTREE</span>     <span class="token comment"># 联合索引</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span> <span class="token operator">=</span> <span class="token keyword">InnoDB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span> <span class="token operator">=</span> utf8 <span class="token keyword">COMMENT</span> <span class="token operator">=</span> <span class="token string">'员工表'</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>这里创建了<strong>联合索引</strong>: idx_name_age_position, 共三个字段 <strong>name, age 和 position</strong>.</p> <h5 id="_1-explain⭐️"><a href="#_1-explain⭐️" class="header-anchor">#</a> 1.EXPLAIN⭐️</h5> <p>使用 EXPLAIN 关键字可以<strong>模拟优化器执行 SQL 语句, 并返回一个</strong>​<mark><strong>执行计划</strong></mark>.</p> <p><strong>在 SELECT 语句之前加 EXPLAIN 关键字</strong>, MySQL 会在查询上设置一个<strong>标记</strong>, 执行查询会<strong>返回执行计划的信息</strong>, 而<strong>不是执行</strong>这条 SQL. 可以用于分析查询语句或结构的性能瓶颈.</p> <p>如果一条 SQL 包含子查询等较复杂的查询, 那么 Explain 的结果可能有多行, 每行都可能各自有一些属性.</p> <p>一般优化 SQL 都是在 <strong>EXPLAIN 查看执行计划, 尝试优化</strong>两个步骤之间循环往复, 直到发现 SQL 性能达标.</p> <p>​<img src="https://nano-note.oss-cn-beijing.aliyuncs.com/images/3bc7f7d1f70494957272092cc643d1fa-20231223175001-dhwx9gd.png" alt="">​</p> <h6 id="重要属性"><a href="#重要属性" class="header-anchor">#</a> 重要属性</h6> <p>Explain 分析结果中比较重要的<strong>属性</strong>如下:</p> <blockquote><p>table</p></blockquote> <p>表示正在访问哪个表.</p> <blockquote><p><mark>type(重要)</mark></p></blockquote> <p>表示<strong>访问类型</strong>, 即表示 MySQL 如何查找表中的行, 是<strong>较为重要</strong>的一个指标.</p> <p>从<mark><strong>最优到最差</strong></mark>依次为: <strong>system &gt; const &gt; eq_ref &gt; ref &gt; range &gt; index &gt; ALL</strong>. 一般来说, <strong>得保证查询达到 range 级别, 最好达到 ref</strong>, 如果达不到则可以考虑进行 SQL 优化.</p> <ul><li><strong>const, system</strong>: 当 <strong>MySQL 能对查询的某部分进行优化并将其转化成一个常量时, type 取值为 const 或 system. 用于 primary key 或 unique key 的所有列与常数</strong>比较时, 所以表最多有一个匹配行, 读取 1 次, 速度比较快. system 是 const 的特例, 表里只有一条元组匹配时为 system.</li> <li><strong>eq_ref</strong>: 使用这种索引查找, MySQL 知道<strong>最多只返回一条符合条件</strong>的记录. 这种访问方法可以在 MySQL 使用主键或者唯一性索引查找时看到, 它会将它们与某个参考值做比较. primary key 或 unique key 索引的所有部分被连接使用, 最多只会返回一条符合条件的记录. 简单的 SELECT 查询不会出现这种 type.</li> <li><strong>ref</strong>: 相比 eq_ref, 不使用唯一索引, 而是使用<strong>普通索引或唯一索引</strong>的部分前缀. 索引要和某个值相比较, 可能会找到<strong>多个符合条件的行, 因此它是查找和扫描的混合体</strong>. 这是一种索引访问(有时也叫做索引查找), 它返回<strong>所有匹配某个单个值</strong>的行. 此类索引访问只有当使用非唯一性索引或唯一性索引的非唯一性前缀时才会发生.</li> <li><strong>range</strong>: 使用一个<strong>索引来检索给定范围的行</strong>. 范围扫描通常出现在 <code>in(), between ,&gt; ,&lt;, &gt;=</code>​ 等操作中.</li> <li><strong>index</strong>: <strong>扫描全索引就能拿到结果</strong>, 一般是扫描某个<strong>二级索引</strong>, 这种扫描不会从索引树根节点开始快速查找, 而是直接对二级索引的叶子节点遍历和扫描, 速度还是比较慢的, 这种查询一般为使用<strong>覆盖索引</strong>, 二级索引一般比较小, 所以这种通常比 ALL 快一些. 这种情况虽然使用了索引, 但是其实是在遍历索引进行查找, 所以通常需要避免.</li> <li><strong>ALL</strong>: 全表扫描. 扫描聚簇索引的所有叶子节点. 通常情况下这需要增加索引来进行优化.</li></ul> <blockquote><p>possible_keys</p></blockquote> <p>表示本次查询<mark><strong>可能会使用哪些索引</strong></mark>来进行查找. 当 key 为 NULL 时, 可能是因为表中数据不多, MySQL 认为索引对此查询帮助不大, 选择了全表查询.</p> <blockquote><p>key</p></blockquote> <p>表示查询<mark><strong>实际采用哪个索引来进行查找</strong></mark>. 如果<strong>没有选择使用索引, 则是 NULL</strong>.</p> <ul><li><strong>key = primary</strong> 表示使用了<strong>主键</strong>.</li> <li><strong>key = null</strong> 表示<strong>没有用到索引</strong>.</li></ul> <p>有时候可能出现 possible_key 有值但是 key 没有值的情况, 就是实际上并没有用到索引.</p> <blockquote><p>key_len</p></blockquote> <p>表示<strong>在索引里使用的字节数</strong>. 如果键是 NULL, 长度就是 NULL. 比如查询用到了联合索引, 那么从 key_len 就可以推算出使用到的联合索引的前缀长度.</p> <p>举例: film_actor 表的联合索引 idx_film_actor_id 由 film_id 和 actor_id 两个 int 列组成, 并且每个 int 是 4 字节. 通过结果中的 key_len = 4 可推断出查询使用了联合索引的第一个列即 film_id 列来执行索引查找.</p> <blockquote><p>ref</p></blockquote> <p>表示哪个字段或常数与 key 一起被使用.</p> <blockquote><p>rows</p></blockquote> <p>MySQL <strong>估计要读取的行数</strong>, 注意这个不是结果集里的行数.</p> <blockquote><p><mark>Extra</mark></p></blockquote> <p>额外信息, 常见重要值如下:</p> <ul><li><mark><strong>Using index</strong></mark>: 使用了<mark><strong>覆盖索引</strong></mark>.</li> <li><mark><strong>Using where</strong></mark>: 使用 WHERE 语句来处理结果, 并且查询的列未被索引覆盖.</li> <li><mark><strong>Using index condition</strong></mark>: 查询的列不完全被索引覆盖, WHERE 条件中是一个前导列的范围. 参考：索引下推。</li> <li>Using temporary: 需要创建一张临时表来处理查询. 出现这种情况一般是要进行优化.</li> <li><mark><strong>Using filesort</strong></mark>: 使用了外部磁盘排序而不是索引排序. 在没有索引的情况下, 数据较小时可以在内存进行排序, 否则需要<strong>在磁盘完成排序</strong>. 这种情况下一般也要考虑使用索引来优化.</li></ul> <h5 id="_2-trace工具"><a href="#_2-trace工具" class="header-anchor">#</a> 2.Trace工具</h5> <p>对于 <code>name &gt; 'a'</code>​ 和 <code>name &gt; 'zzz'</code>​ 这种<strong>范围查询</strong>的执行结果, MySQL <strong>最终</strong>是否会选择走索引可能是<strong>无法轻易判断</strong>的, 可以<strong>使用 trace 工具来看看 MySQL 最终如何选择索引</strong>. 注意开启 trace 工具会影响 MySQL 性能, 所以只能临时分析 SQL 使用, 用完后应立即关闭.</p> <p>开启 trace 工具.</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">SET</span> <span class="token keyword">session</span> optimizer_trace <span class="token operator">=</span> <span class="token string">&quot;enabled=on&quot;</span><span class="token punctuation">,</span> end_markers_in_json <span class="token operator">=</span> <span class="token keyword">on</span><span class="token punctuation">;</span>    <span class="token comment"># 开启trace</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>执行语句.</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> employees <span class="token keyword">WHERE</span> name <span class="token operator">&gt;</span> <span class="token string">'a'</span> <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> position<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><strong>分析结果</strong>存放到了下面的表中.</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> information_schema<span class="token punctuation">.</span>OPTIMIZER_TRACE<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>得到 trace 字段:</p> <div class="language-json line-numbers-mode"><pre class="language-json"><code><span class="token punctuation">{</span>
<span class="token property">&quot;steps&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
<span class="token punctuation">{</span>
<span class="token property">&quot;join_preparation&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> ‐‐第一阶段<span class="token operator">:</span> SQL准备阶段
                 <span class="token property">&quot;select#&quot;</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
                 <span class="token property">&quot;steps&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
                 <span class="token punctuation">{</span>
                 <span class="token property">&quot;expanded_query&quot;</span><span class="token operator">:</span> <span class="token string">&quot;/* select#1 */ select `employees`.`id` AS `id`,`employees`.`name` AS `name`,`employees`.`age` AS `age`,`employees`.`position` AS `position`,`employees`.`hire_time` AS `hire_time` from`employees` where (`employees`.`name` &gt; 'a') order by `employees`.`position`&quot;</span>
<span class="token punctuation">}</span>
<span class="token punctuation">]</span><span class="token comment">/* steps */</span>
<span class="token punctuation">}</span><span class="token comment">/* join_preparation */</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">{</span>
<span class="token property">&quot;join_optimization&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> ‐‐第二阶段<span class="token operator">:</span> SQL优化阶段
<span class="token property">&quot;select#&quot;</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
<span class="token property">&quot;steps&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
<span class="token punctuation">{</span>
<span class="token property">&quot;condition_processing&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> ‐‐条件处理
<span class="token property">&quot;condition&quot;</span><span class="token operator">:</span> <span class="token string">&quot;WHERE&quot;</span><span class="token punctuation">,</span>
<span class="token property">&quot;original_condition&quot;</span><span class="token operator">:</span> <span class="token string">&quot;(`employees`.`name` &gt; 'a')&quot;</span><span class="token punctuation">,</span>
<span class="token property">&quot;steps&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
<span class="token punctuation">{</span>
<span class="token property">&quot;transformation&quot;</span><span class="token operator">:</span> <span class="token string">&quot;equality_propagation&quot;</span><span class="token punctuation">,</span>
<span class="token property">&quot;resulting_condition&quot;</span><span class="token operator">:</span> <span class="token string">&quot;(`employees`.`name` &gt; 'a')&quot;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">{</span>
<span class="token property">&quot;transformation&quot;</span><span class="token operator">:</span> <span class="token string">&quot;constant_propagation&quot;</span><span class="token punctuation">,</span>
<span class="token property">&quot;resulting_condition&quot;</span><span class="token operator">:</span> <span class="token string">&quot;(`employees`.`name` &gt; 'a')&quot;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">{</span>
<span class="token property">&quot;transformation&quot;</span><span class="token operator">:</span> <span class="token string">&quot;trivial_condition_removal&quot;</span><span class="token punctuation">,</span>
<span class="token property">&quot;resulting_condition&quot;</span><span class="token operator">:</span> <span class="token string">&quot;(`employees`.`name` &gt; 'a')&quot;</span>
<span class="token punctuation">}</span>
<span class="token punctuation">]</span><span class="token comment">/* steps */</span>
<span class="token punctuation">}</span><span class="token comment">/* condition_processing */</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">{</span>
<span class="token property">&quot;substitute_generated_columns&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span><span class="token comment">/* substitute_generated_columns */</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">{</span>
<span class="token property">&quot;table_dependencies&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span> ‐‐表依赖详情
<span class="token punctuation">{</span>
<span class="token property">&quot;table&quot;</span><span class="token operator">:</span> <span class="token string">&quot;`employees`&quot;</span><span class="token punctuation">,</span>
<span class="token property">&quot;row_may_be_null&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
<span class="token property">&quot;map_bit&quot;</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
<span class="token property">&quot;depends_on_map_bits&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
<span class="token punctuation">]</span><span class="token comment">/* depends_on_map_bits */</span>
<span class="token punctuation">}</span>
<span class="token punctuation">]</span><span class="token comment">/* table_dependencies */</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">{</span>
<span class="token property">&quot;ref_optimizer_key_uses&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
<span class="token punctuation">]</span><span class="token comment">/* ref_optimizer_key_uses */</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">{</span>
<span class="token property">&quot;rows_estimation&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span> ‐‐预估表的访问成本
<span class="token punctuation">{</span>
<span class="token property">&quot;table&quot;</span><span class="token operator">:</span> <span class="token string">&quot;`employees`&quot;</span><span class="token punctuation">,</span>
<span class="token property">&quot;range_analysis&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
<span class="token property">&quot;table_scan&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>     ‐‐全表扫描情况
<span class="token property">&quot;rows&quot;</span><span class="token operator">:</span> <span class="token number">10123</span><span class="token punctuation">,</span>      ‐‐扫描行数
<span class="token property">&quot;cost&quot;</span><span class="token operator">:</span> <span class="token number">2054.7</span>      ‐‐查询成本
<span class="token punctuation">}</span><span class="token comment">/* table_scan */</span><span class="token punctuation">,</span><span class="token number">70</span> <span class="token property">&quot;potential_range_indexes&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span> ‐‐查询可能使用的索引
<span class="token punctuation">{</span>
<span class="token property">&quot;index&quot;</span><span class="token operator">:</span> <span class="token string">&quot;PRIMARY&quot;</span><span class="token punctuation">,</span> ‐‐主键索引
<span class="token property">&quot;usable&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
<span class="token property">&quot;cause&quot;</span><span class="token operator">:</span> <span class="token string">&quot;not_applicable&quot;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">{</span>
<span class="token property">&quot;index&quot;</span><span class="token operator">:</span> <span class="token string">&quot;idx_name_age_position&quot;</span><span class="token punctuation">,</span> ‐‐辅助索引
<span class="token property">&quot;usable&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
<span class="token property">&quot;key_parts&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
<span class="token string">&quot;name&quot;</span><span class="token punctuation">,</span>
<span class="token string">&quot;age&quot;</span><span class="token punctuation">,</span>
<span class="token string">&quot;position&quot;</span><span class="token punctuation">,</span>
<span class="token string">&quot;id&quot;</span>
<span class="token punctuation">]</span><span class="token comment">/* key_parts */</span>
<span class="token punctuation">}</span>
<span class="token punctuation">]</span><span class="token comment">/* potential_range_indexes */</span><span class="token punctuation">,</span>
<span class="token property">&quot;setup_range_conditions&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
<span class="token punctuation">]</span><span class="token comment">/* setup_range_conditions */</span><span class="token punctuation">,</span>
<span class="token property">&quot;group_index_range&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
<span class="token property">&quot;chosen&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
<span class="token property">&quot;cause&quot;</span><span class="token operator">:</span> <span class="token string">&quot;not_group_by_or_distinct&quot;</span>
<span class="token punctuation">}</span><span class="token comment">/* group_index_range */</span><span class="token punctuation">,</span>
<span class="token property">&quot;analyzing_range_alternatives&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> ‐‐分析各个索引使用成本
<span class="token property">&quot;range_scan_alternatives&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
<span class="token punctuation">{</span>
<span class="token property">&quot;index&quot;</span><span class="token operator">:</span> <span class="token string">&quot;idx_name_age_position&quot;</span><span class="token punctuation">,</span>
<span class="token property">&quot;ranges&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
<span class="token string">&quot;a &lt; name&quot;</span> ‐‐索引使用范围
<span class="token punctuation">]</span><span class="token comment">/* ranges */</span><span class="token punctuation">,</span>
<span class="token property">&quot;index_dives_for_eq_ranges&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
<span class="token property">&quot;rowid_ordered&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> ‐‐使用该索引获取的记录是否按照主键排序
<span class="token property">&quot;using_mrr&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
<span class="token property">&quot;index_only&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> ‐‐是否使用覆盖索引
<span class="token property">&quot;rows&quot;</span><span class="token operator">:</span> <span class="token number">5061</span><span class="token punctuation">,</span>        ‐‐索引扫描行数
<span class="token property">&quot;cost&quot;</span><span class="token operator">:</span> <span class="token number">6074.2</span><span class="token punctuation">,</span>      ‐‐索引使用成本
<span class="token property">&quot;chosen&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>     ‐‐是否选择该索引
<span class="token property">&quot;cause&quot;</span><span class="token operator">:</span> <span class="token string">&quot;cost&quot;</span>
<span class="token punctuation">}</span>
<span class="token punctuation">]</span><span class="token comment">/* range_scan_alternatives */</span><span class="token punctuation">,</span>
<span class="token property">&quot;analyzing_roworder_intersect&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
<span class="token property">&quot;usable&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
<span class="token property">&quot;cause&quot;</span><span class="token operator">:</span> <span class="token string">&quot;too_few_roworder_scans&quot;</span>
<span class="token punctuation">}</span><span class="token comment">/* analyzing_roworder_intersect */</span>
<span class="token punctuation">}</span><span class="token comment">/* analyzing_range_alternatives */</span>
<span class="token punctuation">}</span><span class="token comment">/* range_analysis */</span>
<span class="token punctuation">}</span>
<span class="token punctuation">]</span><span class="token comment">/* rows_estimation */</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">{</span>
<span class="token property">&quot;considered_execution_plans&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
<span class="token punctuation">{</span> <span class="token property">&quot;plan_prefix&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
<span class="token punctuation">]</span><span class="token comment">/* plan_prefix */</span><span class="token punctuation">,</span>
<span class="token property">&quot;table&quot;</span><span class="token operator">:</span> <span class="token string">&quot;`employees`&quot;</span><span class="token punctuation">,</span>
<span class="token property">&quot;best_access_path&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> ‐‐最优访问路径
<span class="token property">&quot;considered_access_paths&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span> ‐‐最终选择的访问路径
<span class="token punctuation">{</span>
<span class="token property">&quot;rows_to_scan&quot;</span><span class="token operator">:</span> <span class="token number">10123</span><span class="token punctuation">,</span>
<span class="token property">&quot;access_type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;scan&quot;</span><span class="token punctuation">,</span> ‐‐访问类型<span class="token operator">:</span> 为scan<span class="token punctuation">,</span> 全表扫描
<span class="token property">&quot;resulting_rows&quot;</span><span class="token operator">:</span> <span class="token number">10123</span><span class="token punctuation">,</span>
<span class="token property">&quot;cost&quot;</span><span class="token operator">:</span> <span class="token number">2052.6</span><span class="token punctuation">,</span>
<span class="token property">&quot;chosen&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> ‐‐确定选择
<span class="token property">&quot;use_tmp_table&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span>
<span class="token punctuation">}</span>
<span class="token punctuation">]</span><span class="token comment">/* considered_access_paths */</span>
<span class="token punctuation">}</span><span class="token comment">/* best_access_path */</span><span class="token punctuation">,</span>
<span class="token property">&quot;condition_filtering_pct&quot;</span><span class="token operator">:</span> <span class="token number">100</span><span class="token punctuation">,</span>
<span class="token property">&quot;rows_for_plan&quot;</span><span class="token operator">:</span> <span class="token number">10123</span><span class="token punctuation">,</span>
<span class="token property">&quot;cost_for_plan&quot;</span><span class="token operator">:</span> <span class="token number">2052.6</span><span class="token punctuation">,</span>
<span class="token property">&quot;sort_cost&quot;</span><span class="token operator">:</span> <span class="token number">10123</span><span class="token punctuation">,</span>
<span class="token property">&quot;new_cost_for_plan&quot;</span><span class="token operator">:</span> <span class="token number">12176</span><span class="token punctuation">,</span>
<span class="token property">&quot;chosen&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span>
<span class="token punctuation">}</span>
<span class="token punctuation">]</span><span class="token comment">/* considered_execution_plans */</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">{</span>
<span class="token property">&quot;attaching_conditions_to_tables&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
<span class="token property">&quot;original_condition&quot;</span><span class="token operator">:</span> <span class="token string">&quot;(`employees`.`name` &gt; 'a')&quot;</span><span class="token punctuation">,</span>
<span class="token property">&quot;attached_conditions_computation&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
<span class="token punctuation">]</span><span class="token comment">/* attached_conditions_computation */</span><span class="token punctuation">,</span>
<span class="token property">&quot;attached_conditions_summary&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
<span class="token punctuation">{</span>
<span class="token property">&quot;table&quot;</span><span class="token operator">:</span> <span class="token string">&quot;`employees`&quot;</span><span class="token punctuation">,</span>
<span class="token property">&quot;attached&quot;</span><span class="token operator">:</span> <span class="token string">&quot;(`employees`.`name` &gt; 'a')&quot;</span>
<span class="token punctuation">}</span>
<span class="token punctuation">]</span><span class="token comment">/* attached_conditions_summary */</span>
<span class="token punctuation">}</span><span class="token comment">/* attaching_conditions_to_tables */</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">{</span>
<span class="token property">&quot;clause_processing&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
<span class="token property">&quot;clause&quot;</span><span class="token operator">:</span> <span class="token string">&quot;ORDER BY&quot;</span><span class="token punctuation">,</span>
<span class="token property">&quot;original_clause&quot;</span><span class="token operator">:</span> <span class="token string">&quot;`employees`.`position`&quot;</span><span class="token punctuation">,</span>
<span class="token property">&quot;items&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
<span class="token punctuation">{</span>
<span class="token property">&quot;item&quot;</span><span class="token operator">:</span> <span class="token string">&quot;`employees`.`position`&quot;</span>
<span class="token punctuation">}</span>
<span class="token punctuation">]</span><span class="token comment">/* items */</span><span class="token punctuation">,</span>
<span class="token property">&quot;resulting_clause_is_simple&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
<span class="token property">&quot;resulting_clause&quot;</span><span class="token operator">:</span> <span class="token string">&quot;`employees`.`position`&quot;</span>
<span class="token punctuation">}</span><span class="token comment">/* clause_processing */</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">{</span>
<span class="token property">&quot;reconsidering_access_paths_for_index_ordering&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
<span class="token property">&quot;clause&quot;</span><span class="token operator">:</span> <span class="token string">&quot;ORDER BY&quot;</span><span class="token punctuation">,</span> <span class="token property">&quot;steps&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
<span class="token punctuation">]</span><span class="token comment">/* steps */</span><span class="token punctuation">,</span>
<span class="token property">&quot;index_order_summary&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
<span class="token property">&quot;table&quot;</span><span class="token operator">:</span> <span class="token string">&quot;`employees`&quot;</span><span class="token punctuation">,</span>
<span class="token property">&quot;index_provides_order&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
<span class="token property">&quot;order_direction&quot;</span><span class="token operator">:</span> <span class="token string">&quot;undefined&quot;</span><span class="token punctuation">,</span>
<span class="token property">&quot;index&quot;</span><span class="token operator">:</span> <span class="token string">&quot;unknown&quot;</span><span class="token punctuation">,</span>
<span class="token property">&quot;plan_changed&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span>
<span class="token punctuation">}</span><span class="token comment">/* index_order_summary */</span>
<span class="token punctuation">}</span><span class="token comment">/* reconsidering_access_paths_for_index_ordering */</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">{</span>
<span class="token property">&quot;refine_plan&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
<span class="token punctuation">{</span>
<span class="token property">&quot;table&quot;</span><span class="token operator">:</span> <span class="token string">&quot;`employees`&quot;</span>
<span class="token punctuation">}</span>
<span class="token punctuation">]</span><span class="token comment">/* refine_plan */</span>
<span class="token punctuation">}</span>
<span class="token punctuation">]</span><span class="token comment">/* steps */</span>
<span class="token punctuation">}</span><span class="token comment">/* join_optimization */</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">{</span>
<span class="token property">&quot;join_execution&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> ‐‐第三阶段<span class="token operator">:</span> SQL执行阶段
<span class="token property">&quot;select#&quot;</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
<span class="token property">&quot;steps&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
<span class="token punctuation">]</span><span class="token comment">/* steps */</span>
<span class="token punctuation">}</span><span class="token comment">/* join_execution */</span>
<span class="token punctuation">}</span>
<span class="token punctuation">]</span><span class="token comment">/* steps */</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br><span class="line-number">165</span><br><span class="line-number">166</span><br><span class="line-number">167</span><br><span class="line-number">168</span><br><span class="line-number">169</span><br><span class="line-number">170</span><br><span class="line-number">171</span><br><span class="line-number">172</span><br><span class="line-number">173</span><br><span class="line-number">174</span><br><span class="line-number">175</span><br><span class="line-number">176</span><br><span class="line-number">177</span><br><span class="line-number">178</span><br><span class="line-number">179</span><br><span class="line-number">180</span><br><span class="line-number">181</span><br><span class="line-number">182</span><br><span class="line-number">183</span><br><span class="line-number">184</span><br><span class="line-number">185</span><br><span class="line-number">186</span><br><span class="line-number">187</span><br><span class="line-number">188</span><br><span class="line-number">189</span><br><span class="line-number">190</span><br><span class="line-number">191</span><br><span class="line-number">192</span><br><span class="line-number">193</span><br><span class="line-number">194</span><br><span class="line-number">195</span><br></div></div><p>上述的 SQL 语句中<strong>全表扫描的成本低于索引扫描, 所以最终选择全表扫描.</strong></p> <p>trace 工具会<strong>分析并预估走索引和全表扫描的成本</strong>, 进行对比, 然后进行选择执行.</p> <h3 id="二-查询性能优化"><a href="#二-查询性能优化" class="header-anchor">#</a> 二.查询性能优化</h3> <h4 id="通用优化原则"><a href="#通用优化原则" class="header-anchor">#</a> 通用优化原则</h4> <h5 id="_1-查询方式优化"><a href="#_1-查询方式优化" class="header-anchor">#</a> 1.查询方式优化</h5> <h6 id="减少请求数据量"><a href="#减少请求数据量" class="header-anchor">#</a> 减少请求数据量</h6> <p>查询性能低下的常见原因是访问的数据太多. 确认应用程序是否在检索大量超过需要的数据. 这通常意味着访问了太多的行, 但有时候也可能是访问了太多的列.</p> <ul><li>只返回<strong>必要的列</strong>: 最好*<em>不要使用 &quot;SELECT <em>&quot; 语句, 而只查询需要的字段</em></em>, 使用覆盖索引.</li> <li>只返回<strong>必要的行</strong>: 使用 <strong>LIMIT</strong> 限制返回的数据量. 可以自己封装一层默认加上 LIMIT 参数.</li> <li>缓存重复查询的数据: 使用缓存可以避免在数据库中进行查询, 缓存带来的查询性能提升将会非常明显.</li> <li>禁止不带任何限制数据范围条件的查询语句. 比如: 当用户在查询订单历史的时候, 可以控制在一个月的范围内.</li> <li>考虑随着业务发展, 查询条件是否会查询出越来越多的数据.</li></ul> <h6 id="减少服务器端扫描行数"><a href="#减少服务器端扫描行数" class="header-anchor">#</a> 减少服务器端扫描行数</h6> <p>最有效的方式是<strong>使用索引来覆盖查询</strong>.</p> <h6 id="切分大查询"><a href="#切分大查询" class="header-anchor">#</a> 切分大查询</h6> <p>一个<strong>大查询</strong>如果<strong>一次性执行</strong>的话, 可能一次锁住很多数据, 导致占满整个事务日志, 耗尽系统资源, 阻塞很多小但重要的查询.</p> <p>有时候对于一个大查询可以 &quot;<strong>分而治之</strong>&quot;, 将大查询切分成小查询, 每个查询功能完全一样, 只完成一小部分, 每次只返回一小部分查询结果.</p> <p>比如删除数据可以<strong>分批次删除</strong>.</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">DELETE</span> <span class="token keyword">FROM</span> messages <span class="token keyword">WHERE</span> createTime <span class="token operator">&lt;</span> DATE_SUB<span class="token punctuation">(</span><span class="token function">NOW</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">INTERVAL</span> <span class="token number">3</span> <span class="token keyword">MONTH</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>切分一下:</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>rows_affected <span class="token operator">=</span> <span class="token number">0</span>
do <span class="token punctuation">{</span>
    rows_affected <span class="token operator">=</span> do_query<span class="token punctuation">(</span>
        <span class="token string">&quot;DELETE FROM messages WHERE create  &lt; DATE_SUB(NOW(), INTERVAL 3 MONTH) LIMIT 10000&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span> <span class="token keyword">while</span> rows_affected <span class="token operator">&gt;</span> <span class="token number">0</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h4 id="范围查询优化"><a href="#范围查询优化" class="header-anchor">#</a> 范围查询优化</h4> <p>MySQL 优化器会<strong>根据检索比例, 表大小等多个因素整体评估是否使用索引</strong>. 如果使用范围查询, 可能会因为<strong>范围问题</strong>使得优化器觉得全表扫描的效率还高, 进而使得索引失效. 具体的情况还得靠优化器根据实际场景自己分析.</p> <p>例 1: 给年龄添加单值索引.</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">`</span>employees<span class="token punctuation">`</span></span> <span class="token keyword">ADD</span> <span class="token keyword">INDEX</span> <span class="token identifier"><span class="token punctuation">`</span>idx_age<span class="token punctuation">`</span></span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>age<span class="token punctuation">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>下面的<strong>范围查询</strong>, 实际上<strong>没有走索引</strong>.</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> employees <span class="token keyword">WHERE</span> age <span class="token operator">&gt;=</span> <span class="token number">1</span> <span class="token operator">AND</span> age <span class="token operator">&lt;=</span> <span class="token number">2000</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>本例可能是由于单次数据量<strong>查询过大</strong>导致优化器最终选择不走索引.</p> <p>优化方法: <strong>可以将大的范围拆分成多个小范围</strong>. 比如改成下面的两个范围查询, 可能就会走索引.</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> employees <span class="token keyword">WHERE</span> age <span class="token operator">&gt;=</span> <span class="token number">1</span> <span class="token operator">AND</span> age <span class="token operator">&lt;=</span> <span class="token number">1000</span><span class="token punctuation">;</span>
<span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> employees <span class="token keyword">WHERE</span> age <span class="token operator">&gt;=</span> <span class="token number">1001</span> <span class="token operator">AND</span> age <span class="token operator">&lt;=</span> <span class="token number">2000</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>例 2: 看下面的 SQL 语句执行后是没走索引的.</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> employees <span class="token keyword">WHERE</span> name <span class="token operator">&gt;</span> <span class="token string">'a'</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>如果用 name 索引需要遍历 name 字段<strong>联合索引树</strong>, 然后还需要根据<strong>遍历出来的主键值</strong>去主键索引树里再去查出最终数据, 相当于<strong>遍历了两棵索引树</strong>(一颗联合索引树, 一颗主键聚簇索引树), 成本比全表扫描还高, 所以就不走索引了.</p> <p>可以用<strong>覆盖索引</strong>优化, 这样<strong>只需要遍历 name 字段</strong>的<strong>联合索引树</strong>就能拿到所有结果, 如下:</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> name<span class="token punctuation">,</span> age <span class="token keyword">FROM</span> employees <span class="token keyword">WHERE</span> name <span class="token operator">&gt;</span> <span class="token string">'a'</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>再看下面的 SQL. 这一条其实跟上面的类似, 只是 name 的范围不同, 这里 MySQL 发现这里数据量较少, 于是<strong>走了索引</strong>. 这里就是引擎执行的<strong>过程中</strong>根据数据情况进行优化.</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> employees <span class="token keyword">WHERE</span> name <span class="token operator">&gt;</span> <span class="token string">'zzz'</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h4 id="查询排序优化"><a href="#查询排序优化" class="header-anchor">#</a> 查询排序优化</h4> <h5 id="_1-排序基础"><a href="#_1-排序基础" class="header-anchor">#</a> 1.排序基础</h5> <p>ORDER BY 语句可以对查询出来的数据进行排序。进行排序时可能出现下面的排序方式：</p> <ul><li><strong>索引排序(index sort)</strong> ​：直接在<strong>索引上完成了排序</strong>。效率很高。</li> <li><strong>文件排序(file sort)</strong> ​：索引无法排序，数据量小的情况下，在<strong>内存中完成排序</strong>; 数据量大的情况下，在内存中无法无法完成排序，会使用<strong>基于磁盘的文件排序</strong>。效率很低。</li></ul> <h5 id="_2-索引排序"><a href="#_2-索引排序" class="header-anchor">#</a> 2.索引排序</h5> <p>ORDER BY 满足两种情况会使用<strong>索引排序</strong>.</p> <ul><li>ORDER BY 语句使用<strong>索引最左前列</strong>.</li> <li>使用 WHERE 子句与 ORDER BY子句<strong>条件列组合满足索引最左前列</strong>.</li></ul> <p><strong>所以尽量在索引列上完成排序, 遵循最左前缀法则</strong>. 如果 ORDER BY 的<strong>条件不在索引列上</strong>, 就会产生文件排序. 所以能用覆盖索引尽量用覆盖索引.</p> <p>GROUP BY 与 ORDER BY 很类似, 其实质是<strong>先排序后分组</strong>, 遵照索引创建顺序的<strong>最左前缀法则</strong>. 对于 GROUP BY 的优化如果不需要排序的可以<strong>加上 OEDER BY NULL 禁止排序</strong>. 注意, <strong>WHERE 筛选先于 HAVING</strong>, 能写在 WHERE 中的限定条件就不要去用 HAVING 限定.</p> <h5 id="_3-文件排序-filesort"><a href="#_3-文件排序-filesort" class="header-anchor">#</a> 3.文件排序(filesort)</h5> <p>当<strong>不能使用索引生成排序结果</strong>的时候, MySQL 需要自己进行排序, 如果数据量小则在<strong>内存</strong>中进行, 如果数据量大则需要使用磁盘排序, MySQL 将这个过程统一称为<strong>文件排序(filesort)</strong> , 即使完全是内存排序不需要磁盘文件时也叫文件排序. 在内存中进行排序的区域叫做 &quot;<strong>排序缓冲区(Sort Buffer, 这是一块内存区域)</strong> &quot;.</p> <p>当查询数据后, 如果需要排序的<strong>数据量小于排序缓冲区</strong>, MySQL 将使用此<strong>内存</strong>进行 &quot;快速排序&quot; 操作. 如果内存不够排序, 那么 MySQL 会先将数据分块, 对每个独立的块使用 &quot;快速排序&quot; 进行排序, 并<strong>将各个块的排序结果存放在磁盘上, 然后将各个排好序的块进行合并(merge), 最后返回排序结果</strong>.</p> <blockquote><p>trace工具查看文件排序信息</p></blockquote> <p>如果<strong>使用了 filesort</strong>, 那么 <strong>trace</strong> 工具的分析结果中会有 <strong>filesort_summary</strong> 的信息. 双路排序的 sort_mode 信息里显示 <code>&lt;sort_key, rowid&gt;</code>​. 单路排序时 sort_mode 信息里显示 <code>&lt;sort_key, additional_fields&gt;</code>​ 或 <code>&lt;sort_key, packed_additional_fields&gt;</code>​.</p> <div class="language-json line-numbers-mode"><pre class="language-json"><code><span class="token property">&quot;filesort_summary&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> 
    <span class="token property">&quot;rows&quot;</span><span class="token operator">:</span> <span class="token number">10000</span><span class="token punctuation">,</span>          <span class="token comment">// 预计扫描行数</span>
    <span class="token property">&quot;examined_rows&quot;</span><span class="token operator">:</span> <span class="token number">10000</span><span class="token punctuation">,</span> <span class="token comment">// 参数排序的行</span>
    <span class="token property">&quot;number_of_tmp_files&quot;</span><span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span> 
    <span class="token property">&quot;sort_buffer_size&quot;</span><span class="token operator">:</span> <span class="token number">262056</span><span class="token punctuation">,</span> <span class="token comment">// 排序缓存的大小</span>
    <span class="token property">&quot;sort_mode&quot;</span><span class="token operator">:</span> <span class="token string">&quot;&lt;sort_key, packed_additional_fields&gt;&quot;</span> <span class="token comment">// 排序方式, 这里用的单路排序</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>如果内存不够用时, 可能使用<strong>磁盘排序</strong>. number_of_tmp_files 表示使用的<strong>临时文件</strong>数, 如果<strong>值为 0 代表全部使用 排序缓冲区进行内存排序, 否则使用磁盘文件排序</strong>.</p> <blockquote><p>文件排序算法</p></blockquote> <p>文件排序算法有:</p> <ul><li><strong>双路排序</strong>(又叫回表排序): 首先根据相应的条件<strong>仅取出需要排序的字段和数据行 ID</strong>, 然后在 <strong>sort buffer</strong> 中进行排序, 排序完后需要<strong>再次回表查询得到其它需要的字段</strong>. 由于只把一部分数据加载到内存排序, 所以占用的内存小一点, 但是排序完成需要回表查询.</li> <li><strong>单路排序</strong>: 一次性取出满足条件行的<strong>所有字段</strong>, 然后在排序缓冲区​中进行排序. 由于把全部需要的数据都加载到了内存, 所以占用内存较大, 但是排序完成后不需要进行回表了.</li></ul> <p><strong>双路排序</strong>过程:</p> <ul><li>从索引 name 找到第一个满足 name = 'Tom' 的主键 <strong>id.</strong></li> <li>根据主键 id 取出排序字段 position 和主键 id 这<strong>两个字段</strong>放到 sort buffer 中.</li> <li>从索引 name 取下一个满足 name = 'Tom' 记录的主键 id.</li> <li>重复上述步骤直到不满足 name = 'Tom'.</li> <li>对 <strong>sort_buffer 中的字段 position 和主键 id 按照字段 position 进行排序</strong>.</li> <li>遍历排序好的 id 和字段 position, 按照 id 的值<strong>回到原表</strong>中取出所有字段的值返回给客户端.</li></ul> <p><strong>单路排序</strong>过程:</p> <ul><li>从索引 name 找到第一个满足 name = 'Tom' 条件的主键 id.</li> <li>根据主键 id 取出<strong>整行</strong>, 取出所有字段的值, 存入 <strong>sort_buffer</strong> 中.</li> <li>从索引 name 找到下一个满足 name = 'Tom' 条件的主键 id.</li> <li>重复上述步骤直到不满足 name = 'Tom'.</li> <li>对 sort_buffer 中的数据按照字段 position 进行排序.</li> <li>返回结果给客户端.</li></ul> <p>对比两个排序模式, <strong>单路排序</strong>会把所有需要查询的字段<strong>都放到排序缓冲区</strong> 中, 而双路排序只会把<strong>主键和需要排序的字段</strong>放到排序缓冲区中进行排序, 然后再通过主键<strong>回到原表</strong>查询需要的字段.</p> <blockquote><p>排序算法与max_length_for_sort_data参数</p></blockquote> <p>MySQL 通过比较参数 <strong>max_length_for_sort_data</strong>(默认 1024 字节) 的大小和需要查询的字段总大小来判断使用哪种排序模式.</p> <ul><li>如果 max_length_for_sort_data 比查询字段的总长度<strong>小</strong>, 使用<strong>双路排序</strong>模式.</li> <li>如果 max_length_for_sort_data 比查询字段的总长度<strong>大</strong>, 使用<strong>单路排序</strong>模式.</li></ul> <p>其实就是如果需要回表的数据行太多或字段较多, 双路排序的内存开销已经接近单路排序了, 这时候还不如直接用单路排序减少一次回表查询.</p> <p>如果 MySQL <strong>排序内存比较小</strong>并且没有条件继续增加了, 可以适当把 <strong>max_length_for_sort_data</strong> 配置小点, 让优化器选择使用双路排序算法, 可以在 sort_buffer 中一次排序更多的行, 只是需要<strong>再根据主键回到原表取数据</strong>.</p> <p>如果 MySQL <strong>排序内存</strong>有条件可以配置比较大, 可以适当增大 <strong>max_length_for_sort_data</strong> 的值, 让优化器优先选择全字段排序(单路排序), 把需要的字段放到 sort_buffer 中, 这样排序后就能直接从<strong>内存</strong>里返回查询结果.</p> <p>所以 MySQL 通过 <strong>max_length_for_sort_data</strong> 这个参数来控制排序, 在不同场景使用不同的排序模式, 从而提升排序效率.</p> <p>注意, 如果<strong>全部使用 sort_buffer 内存排序一般情况下效率会高于磁盘文件排序</strong>, 但不能因为这个就随便增大 sort_buffer(默认 1M), MySQL 很多参数设置都是做过优化的, 不要轻易调整.</p> <h4 id="分页查询优化"><a href="#分页查询优化" class="header-anchor">#</a> 分页查询优化</h4> <p>一个常见的分页查询:</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> employees <span class="token keyword">LIMIT</span> <span class="token number">10000</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>表示从表 employees 中取出<strong>从 10001 行开始的 10 行记录</strong>. 如果<strong>没有索引</strong>, 这里看似只查询了 10 条记录, 实际这条 SQL 是<mark><strong>先读取 10010 条记录, 然后抛弃前 10000 条记录, 然后读到后面 10 条想要的数据</strong></mark>. 因此要查询一张大表比较靠后的数据, 执行效率是非常低的.</p> <p>优化此类分页查询的一个<strong>最简单的办法就是尽可能地使用索引覆盖扫描</strong>, 而不是查询所有的列. 然后根据需要做一次<strong>关联操作</strong>再返回所需的列. 分页查询时，一定要<mark><strong>使用主键来限定查询范围</strong></mark> (<code>WHERE id &gt; 10000 LIMIT 10</code>​) 进行查找.</p> <blockquote><p>优化示例</p></blockquote> <p>看一个根据<strong>非主键字段排序</strong>的分页查询, SQL 如下:</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> employees <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> NAME <span class="token keyword">LIMIT</span> <span class="token number">90000</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>这里发现并没有使用 name 字段的索引(key 字段对应的值为 null), 具体原因是扫描整个索引并查找到没索引的行(<strong>可能要遍历多个索引树)的成本比扫描全表的成本更高, 所以优化器</strong>放弃使用索引.</p> <p>这里优化关键是让排序时返回的字段尽可能少, 所以可以让排序和分页操作先查出主键, 然后根据主键查到对应的记录, SQL 改写如下:</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> employees e <span class="token keyword">INNER</span> <span class="token keyword">JOIN</span> <span class="token punctuation">(</span><span class="token keyword">SELECT</span> id <span class="token keyword">FROM</span> employees <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> NAME <span class="token keyword">LIMIT</span> <span class="token number">90000</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span> ed <span class="token keyword">ON</span> e<span class="token punctuation">.</span>id <span class="token operator">=</span> ed<span class="token punctuation">.</span>id<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>观察执行计划之后可以发现, 原 SQL 使用的是 filesort 排序, 而优化后的 SQL 使用的是索引排序.</p> <h4 id="join联结查询优化"><a href="#join联结查询优化" class="header-anchor">#</a> JOIN联结查询优化</h4> <p><strong>少用 JOIN, JOIN 操作一般可以放到业务层进行</strong>.</p> <p>建个表:</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">`</span>t1<span class="token punctuation">`</span></span> <span class="token punctuation">(</span>
    <span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>a<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>b<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token keyword">KEY</span> <span class="token identifier"><span class="token punctuation">`</span>idx_a<span class="token punctuation">`</span></span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>a<span class="token punctuation">`</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">ENGINE</span> <span class="token operator">=</span> <span class="token keyword">InnoDB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span> <span class="token operator">=</span> utf8<span class="token punctuation">;</span>

<span class="token comment"># 创建一个与 t1 表结构一样的表 t2</span>
<span class="token keyword">create</span> <span class="token keyword">table</span> t2 <span class="token operator">like</span> t1<span class="token punctuation">;</span>
<span class="token comment"># 然后在 t1 表插入 10000 行数据, 在 t2 表插入 100 条数据</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>MySQL 的<strong>表关联</strong>常见有两种算法:</p> <ul><li><strong>Nested-Loop Join</strong> 算法.</li> <li><strong>Block Nested-Loop Join</strong> 算法.</li></ul> <h5 id="_1-嵌套循环连接-nlj-算法"><a href="#_1-嵌套循环连接-nlj-算法" class="header-anchor">#</a> 1.嵌套循环连接(NLJ)算法</h5> <p>嵌套循环连接 (NLJ) 算法即<strong>一次一行循环</strong>地从第一张表(称为驱动表)中读取行, 在这行数据中取到关联字段, 根据关联字段在另一张表(被驱动表)里取出满足条件的行, 然后取出两张表的结果合集.</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> t1 <span class="token keyword">INNER</span> <span class="token keyword">JOIN</span> t2 <span class="token keyword">ON</span> t1<span class="token punctuation">.</span>a <span class="token operator">=</span> t2<span class="token punctuation">.</span>a<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><strong>驱动表是 t2</strong>, 被驱动表是 t1. <strong>先执行的就是驱动表</strong>(执行计划结果的 id 如果一样则按从上到下顺序执行 SQL); <mark><strong>优化器一般会优先选择小表做驱动表</strong></mark>. 所以使用 INNER JOIN 时, 排在前面的表并不一定就是驱动表. 一般 JOIN 语句中, 如果执行计划 Extra 中未出现 <code>Using join buffer</code>​ 则表示使用的 JOIN 算法是 NLJ.</p> <p>上面 SQL 的大致流程如下:</p> <ul><li>从表 t2 中读取一行数据;</li> <li>从第 1 步的数据中, 取出关联字段 a, 到表 t1 中查找;</li> <li>取出表 t1 中满足条件的行, 跟 t2 中获取到的结果合并, 作为结果返回给客户端;</li> <li>重复上面 3 步.</li></ul> <p>整个过程会读取 t2 表的<strong>所有数据</strong>(扫描 100 行), 然后遍历这每行数据中<strong>字段 a 的值</strong>, 根据 t2 表中 a 的值索引扫描 t1 表中的对应行(扫描 100 次 t1 表的索引, 1 次扫描可以认为最终只扫描 t1 表一行完整数据, 也就是总共 t1 表也扫描了 100 行). 因此整个过程扫描了 200 行. 如果被驱动表的关联字段没索引, 使用 NLJ 算法<strong>性能会比较低</strong> (下面有详细解释), MySQL 会选择 Block Nested-Loop Join 算法.</p> <h5 id="_2-基于块的嵌套循环连接-bnl-算法"><a href="#_2-基于块的嵌套循环连接-bnl-算法" class="header-anchor">#</a> 2.基于块的嵌套循环连接(BNL)算法</h5> <p>把驱动表的数据读入到 <strong>join_buffer</strong> 中, 然后<strong>扫描被驱动表</strong>, 把被驱动表每一行取出来跟 join_buffer 中的数据做对比.</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> t1 <span class="token keyword">INNER</span> <span class="token keyword">JOIN</span> t2 <span class="token keyword">ON</span> t1<span class="token punctuation">.</span>b <span class="token operator">=</span> t2<span class="token punctuation">.</span>b<span class="token punctuation">;</span>  
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>EXPLAIN 结果的 Extra 字段中的 <strong>Using join buffer(Block Nested Loop)</strong>  说明该关联查询使用的是 <strong>BNL 算法</strong>.</p> <p>上面 SQL 的大致流程如下:</p> <ul><li>把 t2 的所有数据放入到 join_buffer 中</li> <li>把表 t1 中每一行取出来, 跟 join_buffer 中的数据做对比</li> <li>返回满足 join 条件的数据</li></ul> <p>整个过程对表 t1 和 t2 都做了<strong>一次全表扫描</strong>, 因此扫描的总行数为 10000(表 t1 的数据总量) + 100(表 t2 的数据总量) = 10100. 并且 join_buffer 里的数据是<strong>无序</strong>的, 因此对表 t1 中的每一行, 都要做 <strong>100 次判断</strong>, 所以内存中的判断次数是 100 * 10000= <strong>100 万次</strong>.</p> <p><strong>被驱动表的关联字段没索引为什么要选择使用 BNL 算法而不使用 Nested-Loop Join 呢</strong>?  如果上面第二条 SQL 使用 Nested-Loop Join, 那么扫描行数为 100 * 10000 = 100 万次, 这个是<strong>磁盘扫描</strong>. 很显然, 用 BNL 磁盘扫描次数少很多, 相比于磁盘扫描, BNL 的<strong>内存计算</strong>会快得多. 因此 MySQL 对于被驱动表的<strong>关联字段没索引的关联查询, 一般都会使用 BNL 算法. 如果有索引一般选择 NLJ 算法, 有索引的情况下 NLJ 算法比 BNL 算法性能更高.</strong></p> <h5 id="_3-联结查询优化建议"><a href="#_3-联结查询优化建议" class="header-anchor">#</a> 3.联结查询优化建议</h5> <p>对关联字段加<strong>索引</strong>, 关联操作尽量走索引, 让 MySQL 做 JOIN 操作时尽量选择 <strong>NLJ 算法</strong>. 驱动表因为需要全部查询出来, 所以过滤的条件也尽量要走索引, 避免全表扫描, 总之<strong>能走索引的过滤条件尽量都走索引</strong>.</p> <p>让<strong>小表驱动大表</strong>, 写多表联结 SQL 时如果明确知道哪张表是小表可以用 <strong>straight_join</strong> 写法固定连接驱动方式, 省去 MySQL 优化器自己判断的时间. SRTAIGHT_JOIN 功能同 JOIN 类似, 但<strong>能让左边的表来驱动右边的表</strong>, 能改表优化器对于联表查询的执行顺序. 比如: 代表制定 MySQL 选 t2 表作为驱动表. <strong>小表的判断方式</strong>: 在决定哪个表做驱动表的时候, 应该是两个表按照各自的条件过滤, 过滤完成之后, 计算参与 JOIN 的各个字段的总数据量, 数据量小的那个表, 就是 &quot;小表&quot;, 应该作为驱动表.</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> t2 SRTAIGHT_JOIN t1 <span class="token keyword">ON</span> t2<span class="token punctuation">.</span>a <span class="token operator">=</span> t1<span class="token punctuation">.</span>a<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h4 id="count查询优化"><a href="#count查询优化" class="header-anchor">#</a> COUNT查询优化</h4> <p>对于下面的语句.</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">FROM</span> employees<span class="token punctuation">;</span>
<span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token function">count</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span> <span class="token keyword">FROM</span> employees<span class="token punctuation">;</span>
<span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token function">count</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token keyword">FROM</span> employees<span class="token punctuation">;</span>
<span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">FROM</span> employees<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>四个 SQL 的执行计划一样, 说明这四个 SQL 执行效率应该<strong>差不多</strong>, 区别在于根据某个字段 count <strong>会不会统计字段为 NULL 值的数据行</strong>.</p> <p>InnoDB 存储引擎的表 MySQL <mark><strong>不会维护表的总记录行数</strong></mark>​ <strong>，因为需要实现 MVCC，数据可能有多个版本，所以并不好统计总数, 查询 count 需要实时计算</strong>. 所以类似的语句在 MySQL InnoDB 引擎上执行起来特别慢.</p> <p>优化 COUNT 的思路也比较简单, 整体来说就是<strong>不要去表里面 COUNT</strong>.</p> <ul><li><strong>如果业务要求精度不是很高, 可以考虑把总数维护到 Redis 里</strong>. 插入或删除表数据行的时候同时维护 Redis 里的表总行数 key 的计数值(用 INCR 或 DECR 命令). 但这可能存在数据不一致.</li> <li><strong>使用一个额外的表来记录总数</strong>.</li></ul> <p>如果用了 Redis 来维持总数, 那么就会涉及数据一致性的问题. 也就是如果插入数据库成功, 但是更新 Redis 上的总数失败了, 应该怎么办?</p> <ol><li><strong>如果数据短时间不一致但是业务可以接受的话, 那么就可以考虑异步刷新 Redis 上的总数</strong>.</li> <li><strong>使用 Canal 之类的工具监听 MySQL binlog, 然后刷新 Redis 上的总数</strong>.</li></ol> <h4 id="group-by优化"><a href="#group-by优化" class="header-anchor">#</a> GROUP BY优化</h4> <p>当无法使用索引的时候, GROUP BY 会使用两种策略来完成: <strong>使用临时表或者文件排序来做分组</strong>. 为了避免文件排序, 可以<strong>使用索引来优化</strong>, 这也是最有效的优化办法.</p> <h3 id="三-服务器与基础设施优化"><a href="#三-服务器与基础设施优化" class="header-anchor">#</a> 三.服务器与基础设施优化</h3> <h4 id="mysql参数配置"><a href="#mysql参数配置" class="header-anchor">#</a> MySQL参数配置</h4> <p>可以通过<strong>设置一些参数控制 MySQL 的行为</strong>.</p> <p>配置项可以有多个作用域. 有些设置是服务器级的(全局作用域), 有些对每个连接是不同的(会话作用域), 剩下的一些是对象级的. 如果在服务器运行时修改了变量的全局值, 这个值对当前会话和其他任何已经存在的会话都不起效果, 因为会话的变量值是在连接创建时从全局值初始化来的.</p> <h5 id="_1-缓存池大小配置"><a href="#_1-缓存池大小配置" class="header-anchor">#</a> 1.缓存池大小配置</h5> <p>如果大部分都是 InnoDB 表, 那么 <strong>InnoDB 缓冲池(Buffer Pool)或许比其他任何东西更需要内存</strong>.</p> <p>InnoDB 缓冲池并不仅仅缓存索引: <strong>它还会缓存行的数据, 自适应哈希索引, 插入缓冲(Insert Buffer), 锁, 以及其他内部数据结构</strong>. InnoDB 还使用缓冲池来帮助延迟写入, 这样就能合并多个写入操作, 然后一起顺序地写回. <strong>总之 InnoDB 严重依赖缓冲池, 必须确认为它分配足够的内存</strong>.</p> <blockquote><p>参数: ==innodb_buffer_pool_size=40G==</p></blockquote> <p>配置 InnoDB <strong>存储引擎 buffer pool 缓存池大小</strong>, 一般为物理内存的 60%-70%.</p> <h5 id="_2-日志与io相关配置"><a href="#_2-日志与io相关配置" class="header-anchor">#</a> 2.日志与IO相关配置</h5> <p>日志相关参数主要配置了 MySQL 一些关于日志的行为参数，比如十分重要的重做(日志)日志。同时还可以决定一些 IO 相关的策略。</p> <p>InnoDB 在大多数情况下如果要运行得很好, 除了配置大小合适的<strong>缓</strong>冲池(Buffer Pool)之外，<strong>配置合适的日志文件(Log File)大小</strong>也很重要.</p> <blockquote><p>参数: innodb_log_group_home_dir</p></blockquote> <p>innodb_log_group_home_dir 可以设置 <strong>redo log 文件存储位置</strong>, 默认值为 &quot;./&quot;, 其中 ib_logfile0 和 ib_logfile1 即为 redo log 文件.</p> <blockquote><p>参数: innodb_log_buffer_size</p></blockquote> <p>innodb_log_buffer_size 参数设置 redo log buffer 大小, 默认 16M, 最大值是 4096M, 最小值为 1M. YFD 设置为 8388608(8M).</p> <blockquote><p>参数：innodb_log_files_in_group</p></blockquote> <p>innodb_log_files_in_group 参数设置 redo log 文件的个数, 命名方式如: ib_logfile0, iblogfile1... iblogfileN. 默认 2 个, 最大 100 个.</p> <blockquote><p>参数：<mark>innodb_log_file_size</mark></p></blockquote> <p>InnoDB 存储引擎使用一个指定大小的 <strong>Redo log 空间</strong>(一个环形的数据结构)(参考: 重做日志(redo log)). Redo log 的空间通过 innodb_log_file_size 和 innodb_log_files_in_group(默认 2)参数来调节. 将这俩参数相乘即可得到总的可用 Redo log 空间. 多数情况下通过 innodb_log_file_size 来调节即可.</p> <p>innodb_log_file_size 参数设置单个 redo log 文件大小, 默认值为 48 M. 最大值为 512G, 注意最大值指的是<strong>整个 redo log 系列文件之和</strong>, 即 (innodb_log_files_in_group * innodb_log_file_size) 不能大于最大值 512G.</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">show</span> variables <span class="token operator">like</span> <span class="token string">'%innodb_log_buffer_size%'</span><span class="token punctuation">;</span>
<span class="token keyword">show</span> variables <span class="token operator">like</span> <span class="token string">'%innodb_log_group_home_dir%'</span><span class="token punctuation">;</span>
<span class="token keyword">show</span> variables <span class="token operator">like</span> <span class="token string">'%innodb_log_files_in_group%'</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><blockquote><p>参数: innodb_flush_log_at_trx_commit</p></blockquote> <p>参数 innodb_flush_log_at_trx_commit 可以控制 redo log 的<strong>从内存缓冲区写入磁盘的策略(日志缓冲刷新的频繁程度)</strong> . 具体参考: 刷盘策略与innodb_flush_log_at_trx_commit参数.</p> <h5 id="_3-连接相关配置"><a href="#_3-连接相关配置" class="header-anchor">#</a> 3.连接相关配置</h5> <p>主要配置 MySQL 的对外连接建立、维护等行为。</p> <blockquote><p>参数: max_connections=3000</p></blockquote> <p>连接的创建和销毁都需要系统资源, 比如内存, 文件句柄, 业务说的支持多少并发, 指的是每秒请求数, 也就是 QPS.</p> <p>一个连接最少占用内存是 256 K, 最大是 64 M, 如果一个连接的请求数据超过 64MB(比如排序), 就会申请临时空间, 放到硬盘上. 如果 3000 个用户同时连上 MySQL, 最小需要内存 3000 * 256KB = 750M <em>,</em>  最大需要内存 3000 * 64MB = 192G.</p> <p>如果 innodb_buffer_pool_size 是 40GB, 给操作系统分配 4G, 给连接使用的最大内存不到 20G, 如果连接过多, 使用的内存超过 20G, 将会产生磁盘 SWAP, 此时将会影响性能. <strong>连接数过高, 不一定带来吞吐量的提高, 而且可能占用更多的系统资源</strong>.</p> <blockquote><p>参数: max_user_connections=2980</p></blockquote> <p>允许用户连接的最大数量, 剩余连接数用作 DBA 管理.</p> <blockquote><p>参数: back_log=300</p></blockquote> <p>MySQL 能够<strong>暂存的连接数量</strong>. 如果 MySQL 的连接数达到 max_connections 时, 新的请求将会被存在堆栈中, 等待某一连接释放资源, 该堆栈数量即 back_log, 如果等待连接的数量超过 back_log, 将被拒绝.</p> <blockquote><p>参数: wait_timeout=20000</p></blockquote> <p>指应用通过 JDBC 连接 MySQL 进行操作完毕后, 空闲 20000 秒后断开, <strong>默认是 28800, 单位秒, 即 8 个小时</strong>.</p> <blockquote><p>参数: interactive_timeout=300</p></blockquote> <p>指的是 MySQL client 连接 MySQL 进行操作完毕后, 空闲 300 秒后断开, 默认是 28800, 单位秒, 即 8 个小时.</p> <h5 id="_4-并发相关配置"><a href="#_4-并发相关配置" class="header-anchor">#</a> 4.并发相关配置</h5> <blockquote><p>线程缓存配置</p></blockquote> <p>线程缓存保存那些当前没有与连接关联但是准备为后面新的连接服务的线程. 当一个新的连接创建时, 如果缓存中有线程存在, MySQL 从缓存中删除一个线程, 并且把它分配给这个新的连接. 当连接关闭时, 如果线程缓存还有空间的话, MySQL 又会把线程放回缓存. 如果没有空间的话, MySQL 会销毁这个线程. 只要 MySQL 在缓存里还有空闲的线程, 它就可以迅速地响应连接请求, 因为这样就不用为每个连接创建新的线程.</p> <p><strong>thread_cache_size 参数可以配置 MySQL 可以保持在缓存中的线程数</strong>.</p> <blockquote><p>参数: <mark>innodb_thread_concurrency</mark>=64</p></blockquote> <p>最基本的限制并发的方式是使用 <strong>innodb_thread_concurrency</strong> 参数, 它会限制一次性可以有多少线程进入内核, 0 表示不限制.</p> <p>经验公式:</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>并发值 = CPU数量 * 磁盘数量 * 2
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>如果已经进入内核的线程超过了允许的数量, 新的线程就无法再进入内核. InnoDB 使用两段处理来尝试让线程尽可能高效地进入内核. 两段策略减少了因操作系统调度引起的上下文切换. 线程第一次休眠 innodb_thread_sleep_delay 微秒, 然后再重试. 如果它依然不能进入内核, 则放入一个等待线程队列, 让操作系统来处理.</p> <p>innodb_thread_concurrency 参数用来设置 InnoDB 线程的并发数, 默认值为 0 表示不被限制, <strong>若要设置则与服务器的 CPU 核心数相同或是 CPU 的核心数的 2 倍, 如果超过配置并发数, 则需要排队, 这个值不宜太大, 不然可能会导致线程之间锁争用严重</strong>, 影响性能.</p> <blockquote><p>参数: innodb_lock_wait_timeout=10</p></blockquote> <p>行锁锁定时间, 默认 50s, 根据公司业务定, 没有标准值.</p> <h5 id="_5-查询相关配置"><a href="#_5-查询相关配置" class="header-anchor">#</a> 5.查询相关配置</h5> <blockquote><p>参数: sort_buffer_size=4M</p></blockquote> <p>每个需要<strong>排序的线程</strong>分配该大小的一个缓冲区. 增加该值可以加速 ORDER BY 或 GROUP BY 操作.</p> <p><strong>sort_buffer_size 是一个 connection 级的参数, 在每个 connection(session) 第一次需要使用这个 buffer 的时候, 一次性分配设置的内存</strong>.</p> <p>sort_buffer_size 并不是越大越好, 由于是 connection 级的参数, 过大的设置 + 高并发可能会耗尽系统的内存资源. 例如: 500 个连接将会消耗 500 * sort_buffer_size(4M) = 2G.</p> <h4 id="硬件优化"><a href="#硬件优化" class="header-anchor">#</a> 硬件优化</h4> <p>许多不同的硬件都可以影响 MySQL 的性能, 需要依靠 CPU, 内存, 硬盘和网络等资源, 这些都可以进行优化.</p> <p>应该分析应用是 IO 密集型还是 CPU 密集型, 然后据此选择合适的 CPU.</p> <h4 id="应用层优化"><a href="#应用层优化" class="header-anchor">#</a> 应用层优化</h4> <p>应用层可以想办法降低查询次数, 减少查询数量, 比如使用缓存.</p> <p>‍</p> <h3 id="参考资料"><a href="#参考资料" class="header-anchor">#</a> 参考资料</h3> <ul><li><a href="https://segmentfault.com/a/1190000006158186" target="_blank" rel="noopener noreferrer">MySQL大表优化方案<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://blog.51cto.com/kaifly/2114068" target="_blank" rel="noopener noreferrer">如何设置innodb_log_file_size<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul> <p>‍</p></div></div>  <div class="page-edit"><div class="edit-link"><a href="https://github.com/xugaoyi/vuepress-theme-vdoing/edit/main/docs/20.开发/2100.开发/200.数据库/310.MySQL优化.md" target="_blank" rel="noopener noreferrer">编辑</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <!----> <!----></div> <div class="page-nav-wapper"><div class="page-nav-centre-wrap"><a href="/pages/63b46e/" class="page-nav-centre page-nav-centre-prev"><div class="tooltip">MySQL架构优化与运维</div></a> <a href="/pages/c1c2f6/" class="page-nav-centre page-nav-centre-next"><div class="tooltip">MySQL架构</div></a></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/pages/63b46e/" class="prev">MySQL架构优化与运维</a></span> <span class="next"><a href="/pages/c1c2f6/">MySQL架构</a>→
      </span></p></div></div></div> <!----></main></div> <div class="footer"><div class="icons"><a href="mailto:1174520425@qq.com" title="发邮件" target="_blank" class="iconfont icon-youjian"></a><a href="https://github.com/nanodaemony" title="GitHub" target="_blank" class="iconfont icon-github"></a></div> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="本站主题">Vdoing</a> 
    | Copyright © 2019-2025
    <span>达尔文的猹 | MIT License</span></div> <div class="buttons"><div title="返回顶部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去评论" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主题模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          跟随系统
        </li><li class="iconfont icon-rijianmoshi">
          浅色模式
        </li><li class="iconfont icon-yejianmoshi">
          深色模式
        </li><li class="iconfont icon-yuedu">
          阅读模式
        </li></ul></div></div> <!----> <!----> <!----></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.3f3e0e10.js" defer></script><script src="/assets/js/2.e9fcb30c.js" defer></script><script src="/assets/js/3.1998f389.js" defer></script><script src="/assets/js/108.b488ce56.js" defer></script>
  </body>
</html>
