<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>类加载及执行子系统的案例与实战🌼 | Pangolin Note</title>
    <meta name="generator" content="VuePress 1.9.5">
    <link rel="icon" href="/img/favicon.ico">
    <meta name="description" content="大道至简">
    <meta name="keywords" content="前端博客,个人技术博客,前端,前端开发,前端框架,web前端,前端面试题,技术文档,学习,面试,JavaScript,js,ES6,TypeScript,vue,python,css3,html5,Node,git,github,markdown">
    <meta name="baidu-site-verification" content="7F55weZDDc">
    <meta name="theme-color" content="#11a8cd">
    
    <link rel="preload" href="/assets/css/0.styles.56073ad3.css" as="style"><link rel="preload" href="/assets/js/app.3f3e0e10.js" as="script"><link rel="preload" href="/assets/js/2.e9fcb30c.js" as="script"><link rel="preload" href="/assets/js/3.1998f389.js" as="script"><link rel="preload" href="/assets/js/85.7dcc5659.js" as="script"><link rel="prefetch" href="/assets/js/10.0b55747f.js"><link rel="prefetch" href="/assets/js/100.b8912a99.js"><link rel="prefetch" href="/assets/js/101.a6740c8a.js"><link rel="prefetch" href="/assets/js/102.e31e89b2.js"><link rel="prefetch" href="/assets/js/103.2c5dbdae.js"><link rel="prefetch" href="/assets/js/104.0e9c02f6.js"><link rel="prefetch" href="/assets/js/105.8288396c.js"><link rel="prefetch" href="/assets/js/106.62f43c11.js"><link rel="prefetch" href="/assets/js/107.70c90211.js"><link rel="prefetch" href="/assets/js/108.b488ce56.js"><link rel="prefetch" href="/assets/js/109.12942650.js"><link rel="prefetch" href="/assets/js/11.ac3fd1ca.js"><link rel="prefetch" href="/assets/js/110.1e57ecba.js"><link rel="prefetch" href="/assets/js/111.6e33b4ea.js"><link rel="prefetch" href="/assets/js/112.bd52831b.js"><link rel="prefetch" href="/assets/js/113.868c1ac9.js"><link rel="prefetch" href="/assets/js/114.090549d1.js"><link rel="prefetch" href="/assets/js/115.d97f6c2b.js"><link rel="prefetch" href="/assets/js/116.097c4b4e.js"><link rel="prefetch" href="/assets/js/117.4024cfe2.js"><link rel="prefetch" href="/assets/js/118.e3057cba.js"><link rel="prefetch" href="/assets/js/119.4ef1fa3b.js"><link rel="prefetch" href="/assets/js/12.863eaabe.js"><link rel="prefetch" href="/assets/js/120.78f9df50.js"><link rel="prefetch" href="/assets/js/121.8e16df87.js"><link rel="prefetch" href="/assets/js/122.f21c0107.js"><link rel="prefetch" href="/assets/js/123.ea1cb375.js"><link rel="prefetch" href="/assets/js/124.01c04c6e.js"><link rel="prefetch" href="/assets/js/125.d383e301.js"><link rel="prefetch" href="/assets/js/126.3162cb47.js"><link rel="prefetch" href="/assets/js/127.c6bebae6.js"><link rel="prefetch" href="/assets/js/128.d659db60.js"><link rel="prefetch" href="/assets/js/129.2afdcf48.js"><link rel="prefetch" href="/assets/js/13.4f59ce35.js"><link rel="prefetch" href="/assets/js/130.beb9ed9d.js"><link rel="prefetch" href="/assets/js/131.35b05f8a.js"><link rel="prefetch" href="/assets/js/132.d77f4f93.js"><link rel="prefetch" href="/assets/js/133.4ceda6e5.js"><link rel="prefetch" href="/assets/js/134.11390c5f.js"><link rel="prefetch" href="/assets/js/135.32f9e38f.js"><link rel="prefetch" href="/assets/js/136.6d8bb0f2.js"><link rel="prefetch" href="/assets/js/137.9c0ffeef.js"><link rel="prefetch" href="/assets/js/138.88d86e5f.js"><link rel="prefetch" href="/assets/js/139.8c2c3d6c.js"><link rel="prefetch" href="/assets/js/14.11c82d35.js"><link rel="prefetch" href="/assets/js/140.c5c375d3.js"><link rel="prefetch" href="/assets/js/141.d703f30b.js"><link rel="prefetch" href="/assets/js/142.6a005a44.js"><link rel="prefetch" href="/assets/js/143.9b2edf6f.js"><link rel="prefetch" href="/assets/js/144.3fd013c9.js"><link rel="prefetch" href="/assets/js/145.b05079c5.js"><link rel="prefetch" href="/assets/js/146.ed5360a6.js"><link rel="prefetch" href="/assets/js/147.7408d86f.js"><link rel="prefetch" href="/assets/js/148.f390b370.js"><link rel="prefetch" href="/assets/js/149.95017f0a.js"><link rel="prefetch" href="/assets/js/15.bd143bd5.js"><link rel="prefetch" href="/assets/js/150.f0ede764.js"><link rel="prefetch" href="/assets/js/151.b7093623.js"><link rel="prefetch" href="/assets/js/152.a82a6c83.js"><link rel="prefetch" href="/assets/js/153.965e3fb2.js"><link rel="prefetch" href="/assets/js/154.9e49311e.js"><link rel="prefetch" href="/assets/js/155.cef33ba5.js"><link rel="prefetch" href="/assets/js/156.bcc397ae.js"><link rel="prefetch" href="/assets/js/157.90824739.js"><link rel="prefetch" href="/assets/js/158.efd429b9.js"><link rel="prefetch" href="/assets/js/159.122ff5b7.js"><link rel="prefetch" href="/assets/js/16.2449162b.js"><link rel="prefetch" href="/assets/js/160.0b806535.js"><link rel="prefetch" href="/assets/js/161.835052c6.js"><link rel="prefetch" href="/assets/js/162.ca34e2d2.js"><link rel="prefetch" href="/assets/js/163.08000d04.js"><link rel="prefetch" href="/assets/js/164.a1cc0109.js"><link rel="prefetch" href="/assets/js/165.65444686.js"><link rel="prefetch" href="/assets/js/166.7d73c84f.js"><link rel="prefetch" href="/assets/js/167.009d47a3.js"><link rel="prefetch" href="/assets/js/168.0afeae2a.js"><link rel="prefetch" href="/assets/js/169.7654cb31.js"><link rel="prefetch" href="/assets/js/17.eb7f9def.js"><link rel="prefetch" href="/assets/js/170.58569530.js"><link rel="prefetch" href="/assets/js/171.7db9ed40.js"><link rel="prefetch" href="/assets/js/172.3cb50ed4.js"><link rel="prefetch" href="/assets/js/173.0846425f.js"><link rel="prefetch" href="/assets/js/174.9e95f111.js"><link rel="prefetch" href="/assets/js/175.ef2098f2.js"><link rel="prefetch" href="/assets/js/176.c2635fe9.js"><link rel="prefetch" href="/assets/js/177.4fa38e8e.js"><link rel="prefetch" href="/assets/js/178.2be7037f.js"><link rel="prefetch" href="/assets/js/179.bf3bba28.js"><link rel="prefetch" href="/assets/js/18.0455f4d1.js"><link rel="prefetch" href="/assets/js/180.72c5f597.js"><link rel="prefetch" href="/assets/js/181.42287bcc.js"><link rel="prefetch" href="/assets/js/182.6cd4bf1a.js"><link rel="prefetch" href="/assets/js/183.05dbbfd9.js"><link rel="prefetch" href="/assets/js/184.03de7e00.js"><link rel="prefetch" href="/assets/js/185.42dd210e.js"><link rel="prefetch" href="/assets/js/186.28ee0f8a.js"><link rel="prefetch" href="/assets/js/187.bb58697b.js"><link rel="prefetch" href="/assets/js/188.1bc8be96.js"><link rel="prefetch" href="/assets/js/189.fac747e3.js"><link rel="prefetch" href="/assets/js/19.ae9e35d6.js"><link rel="prefetch" href="/assets/js/190.ea533ac7.js"><link rel="prefetch" href="/assets/js/191.6dc6eb13.js"><link rel="prefetch" href="/assets/js/192.184d249f.js"><link rel="prefetch" href="/assets/js/193.4a06bc12.js"><link rel="prefetch" href="/assets/js/194.8cce60a9.js"><link rel="prefetch" href="/assets/js/195.93231a13.js"><link rel="prefetch" href="/assets/js/196.4a596bde.js"><link rel="prefetch" href="/assets/js/197.96c113cf.js"><link rel="prefetch" href="/assets/js/198.73ba3f67.js"><link rel="prefetch" href="/assets/js/199.74bab595.js"><link rel="prefetch" href="/assets/js/20.b542d0e7.js"><link rel="prefetch" href="/assets/js/200.69a6928a.js"><link rel="prefetch" href="/assets/js/201.9ffa7c5a.js"><link rel="prefetch" href="/assets/js/202.41edb652.js"><link rel="prefetch" href="/assets/js/203.7fabcef3.js"><link rel="prefetch" href="/assets/js/204.b0ae2f62.js"><link rel="prefetch" href="/assets/js/205.add8738b.js"><link rel="prefetch" href="/assets/js/206.f3a712ec.js"><link rel="prefetch" href="/assets/js/207.cd7dd729.js"><link rel="prefetch" href="/assets/js/208.78b33afa.js"><link rel="prefetch" href="/assets/js/209.9d3329ff.js"><link rel="prefetch" href="/assets/js/21.5a050318.js"><link rel="prefetch" href="/assets/js/210.d285d5ac.js"><link rel="prefetch" href="/assets/js/211.8791bb3f.js"><link rel="prefetch" href="/assets/js/212.84ed81a8.js"><link rel="prefetch" href="/assets/js/213.7b990580.js"><link rel="prefetch" href="/assets/js/214.da31f20c.js"><link rel="prefetch" href="/assets/js/215.9eeed659.js"><link rel="prefetch" href="/assets/js/216.9539f0ec.js"><link rel="prefetch" href="/assets/js/217.11b575be.js"><link rel="prefetch" href="/assets/js/218.a67f12f1.js"><link rel="prefetch" href="/assets/js/219.bfbb817a.js"><link rel="prefetch" href="/assets/js/22.2bc6f7e3.js"><link rel="prefetch" href="/assets/js/220.8b01342f.js"><link rel="prefetch" href="/assets/js/221.b450decd.js"><link rel="prefetch" href="/assets/js/222.97468507.js"><link rel="prefetch" href="/assets/js/223.b6dafd73.js"><link rel="prefetch" href="/assets/js/224.c86c18c6.js"><link rel="prefetch" href="/assets/js/225.b0dcf86e.js"><link rel="prefetch" href="/assets/js/226.02cc2999.js"><link rel="prefetch" href="/assets/js/227.8474ef5a.js"><link rel="prefetch" href="/assets/js/228.0298e421.js"><link rel="prefetch" href="/assets/js/229.6aeaf595.js"><link rel="prefetch" href="/assets/js/23.9995fce4.js"><link rel="prefetch" href="/assets/js/230.a5785286.js"><link rel="prefetch" href="/assets/js/231.d791daa4.js"><link rel="prefetch" href="/assets/js/232.97aeeb00.js"><link rel="prefetch" href="/assets/js/233.46e51e28.js"><link rel="prefetch" href="/assets/js/234.2cffe82f.js"><link rel="prefetch" href="/assets/js/235.14965da6.js"><link rel="prefetch" href="/assets/js/236.00a5afc0.js"><link rel="prefetch" href="/assets/js/237.3b73d52f.js"><link rel="prefetch" href="/assets/js/238.6e1db765.js"><link rel="prefetch" href="/assets/js/239.75866c5e.js"><link rel="prefetch" href="/assets/js/24.9141eeb2.js"><link rel="prefetch" href="/assets/js/240.af9c2cc9.js"><link rel="prefetch" href="/assets/js/241.388acab2.js"><link rel="prefetch" href="/assets/js/242.c60f2b48.js"><link rel="prefetch" href="/assets/js/243.d8e81b13.js"><link rel="prefetch" href="/assets/js/244.58b0b21d.js"><link rel="prefetch" href="/assets/js/245.c3768497.js"><link rel="prefetch" href="/assets/js/246.ac8bbe7a.js"><link rel="prefetch" href="/assets/js/247.d095f70a.js"><link rel="prefetch" href="/assets/js/248.e9f210b5.js"><link rel="prefetch" href="/assets/js/249.a9fad023.js"><link rel="prefetch" href="/assets/js/25.98e8593e.js"><link rel="prefetch" href="/assets/js/250.ae7f0ebb.js"><link rel="prefetch" href="/assets/js/251.9a617d55.js"><link rel="prefetch" href="/assets/js/252.ce082446.js"><link rel="prefetch" href="/assets/js/253.4575302d.js"><link rel="prefetch" href="/assets/js/254.5899a61b.js"><link rel="prefetch" href="/assets/js/255.66c69f31.js"><link rel="prefetch" href="/assets/js/256.8fd6c706.js"><link rel="prefetch" href="/assets/js/257.31b77e5e.js"><link rel="prefetch" href="/assets/js/258.eba48891.js"><link rel="prefetch" href="/assets/js/259.edf74b59.js"><link rel="prefetch" href="/assets/js/26.e69924ea.js"><link rel="prefetch" href="/assets/js/260.cf2ed36d.js"><link rel="prefetch" href="/assets/js/261.9e7792d8.js"><link rel="prefetch" href="/assets/js/262.e7b9433e.js"><link rel="prefetch" href="/assets/js/263.1185b25c.js"><link rel="prefetch" href="/assets/js/264.5e0f89cb.js"><link rel="prefetch" href="/assets/js/265.a38d3b94.js"><link rel="prefetch" href="/assets/js/266.2ef170b3.js"><link rel="prefetch" href="/assets/js/267.a7d14651.js"><link rel="prefetch" href="/assets/js/268.05b18748.js"><link rel="prefetch" href="/assets/js/269.dad48d6f.js"><link rel="prefetch" href="/assets/js/27.13612515.js"><link rel="prefetch" href="/assets/js/270.4f5a6b8d.js"><link rel="prefetch" href="/assets/js/271.7ebf6682.js"><link rel="prefetch" href="/assets/js/272.7c2fbfd1.js"><link rel="prefetch" href="/assets/js/273.8ee20732.js"><link rel="prefetch" href="/assets/js/274.d525242a.js"><link rel="prefetch" href="/assets/js/275.a8a19acb.js"><link rel="prefetch" href="/assets/js/276.df3a4eb4.js"><link rel="prefetch" href="/assets/js/277.336debda.js"><link rel="prefetch" href="/assets/js/278.c470625f.js"><link rel="prefetch" href="/assets/js/279.a91e1a64.js"><link rel="prefetch" href="/assets/js/28.ab7ae1df.js"><link rel="prefetch" href="/assets/js/280.87e25c9a.js"><link rel="prefetch" href="/assets/js/281.87c1ba25.js"><link rel="prefetch" href="/assets/js/282.dcd4dce0.js"><link rel="prefetch" href="/assets/js/283.abac2e00.js"><link rel="prefetch" href="/assets/js/284.f6079659.js"><link rel="prefetch" href="/assets/js/285.f1b39879.js"><link rel="prefetch" href="/assets/js/286.f6a79242.js"><link rel="prefetch" href="/assets/js/287.06bebe07.js"><link rel="prefetch" href="/assets/js/288.89e325df.js"><link rel="prefetch" href="/assets/js/289.3aa1bedd.js"><link rel="prefetch" href="/assets/js/29.ebe50f76.js"><link rel="prefetch" href="/assets/js/290.ee059c92.js"><link rel="prefetch" href="/assets/js/291.fa9a921a.js"><link rel="prefetch" href="/assets/js/292.2a8811cd.js"><link rel="prefetch" href="/assets/js/293.eec09cdf.js"><link rel="prefetch" href="/assets/js/294.dfac20dc.js"><link rel="prefetch" href="/assets/js/295.825d2070.js"><link rel="prefetch" href="/assets/js/296.f645861e.js"><link rel="prefetch" href="/assets/js/297.424fdb17.js"><link rel="prefetch" href="/assets/js/298.ebf87cdc.js"><link rel="prefetch" href="/assets/js/299.b8f19cbb.js"><link rel="prefetch" href="/assets/js/30.75237511.js"><link rel="prefetch" href="/assets/js/300.10fb6d4f.js"><link rel="prefetch" href="/assets/js/301.ef77c612.js"><link rel="prefetch" href="/assets/js/302.1b839763.js"><link rel="prefetch" href="/assets/js/303.609f7d98.js"><link rel="prefetch" href="/assets/js/304.1d255f19.js"><link rel="prefetch" href="/assets/js/305.b0234f2c.js"><link rel="prefetch" href="/assets/js/306.48677f64.js"><link rel="prefetch" href="/assets/js/307.14390d4b.js"><link rel="prefetch" href="/assets/js/308.fa730b28.js"><link rel="prefetch" href="/assets/js/309.0496b9e0.js"><link rel="prefetch" href="/assets/js/31.cf3f471a.js"><link rel="prefetch" href="/assets/js/310.a31676dc.js"><link rel="prefetch" href="/assets/js/311.ed53adc5.js"><link rel="prefetch" href="/assets/js/312.1b0ff2f1.js"><link rel="prefetch" href="/assets/js/313.bf123f32.js"><link rel="prefetch" href="/assets/js/314.4e6ce06b.js"><link rel="prefetch" href="/assets/js/315.8eb18560.js"><link rel="prefetch" href="/assets/js/32.74fef842.js"><link rel="prefetch" href="/assets/js/33.bc2d190b.js"><link rel="prefetch" href="/assets/js/34.d23438fc.js"><link rel="prefetch" href="/assets/js/35.7675c4d0.js"><link rel="prefetch" href="/assets/js/36.96a4161b.js"><link rel="prefetch" href="/assets/js/37.d1824f2f.js"><link rel="prefetch" href="/assets/js/38.4effff9e.js"><link rel="prefetch" href="/assets/js/39.6509914b.js"><link rel="prefetch" href="/assets/js/4.4d01750f.js"><link rel="prefetch" href="/assets/js/40.1509d08b.js"><link rel="prefetch" href="/assets/js/41.f2c1124f.js"><link rel="prefetch" href="/assets/js/42.e541d077.js"><link rel="prefetch" href="/assets/js/43.369de999.js"><link rel="prefetch" href="/assets/js/44.43959db0.js"><link rel="prefetch" href="/assets/js/45.282fbd31.js"><link rel="prefetch" href="/assets/js/46.1b83cfe9.js"><link rel="prefetch" href="/assets/js/47.c3a88e41.js"><link rel="prefetch" href="/assets/js/48.bc7c0a1b.js"><link rel="prefetch" href="/assets/js/49.92a4e5ba.js"><link rel="prefetch" href="/assets/js/5.c3991e24.js"><link rel="prefetch" href="/assets/js/50.9c488c6c.js"><link rel="prefetch" href="/assets/js/51.546ea632.js"><link rel="prefetch" href="/assets/js/52.0d2ccee1.js"><link rel="prefetch" href="/assets/js/53.6f52b5b1.js"><link rel="prefetch" href="/assets/js/54.c838b295.js"><link rel="prefetch" href="/assets/js/55.13af99ee.js"><link rel="prefetch" href="/assets/js/56.6be6d1ed.js"><link rel="prefetch" href="/assets/js/57.67c98b39.js"><link rel="prefetch" href="/assets/js/58.107e82ec.js"><link rel="prefetch" href="/assets/js/59.b3e5edc7.js"><link rel="prefetch" href="/assets/js/6.36a535f9.js"><link rel="prefetch" href="/assets/js/60.3b0b4ba5.js"><link rel="prefetch" href="/assets/js/61.3df843df.js"><link rel="prefetch" href="/assets/js/62.1213823d.js"><link rel="prefetch" href="/assets/js/63.e8f3f926.js"><link rel="prefetch" href="/assets/js/64.e1219050.js"><link rel="prefetch" href="/assets/js/65.5bf5bb0b.js"><link rel="prefetch" href="/assets/js/66.a2502afb.js"><link rel="prefetch" href="/assets/js/67.690dd59b.js"><link rel="prefetch" href="/assets/js/68.de7b0915.js"><link rel="prefetch" href="/assets/js/69.ac61dd61.js"><link rel="prefetch" href="/assets/js/7.5d254238.js"><link rel="prefetch" href="/assets/js/70.3edd41b1.js"><link rel="prefetch" href="/assets/js/71.d23407e9.js"><link rel="prefetch" href="/assets/js/72.a5bd01bc.js"><link rel="prefetch" href="/assets/js/73.c9f4dd57.js"><link rel="prefetch" href="/assets/js/74.66323fc1.js"><link rel="prefetch" href="/assets/js/75.e1a72e00.js"><link rel="prefetch" href="/assets/js/76.801268b4.js"><link rel="prefetch" href="/assets/js/77.3a5fda67.js"><link rel="prefetch" href="/assets/js/78.54d84cd4.js"><link rel="prefetch" href="/assets/js/79.fa10f4e3.js"><link rel="prefetch" href="/assets/js/8.e060e47d.js"><link rel="prefetch" href="/assets/js/80.d5b24fea.js"><link rel="prefetch" href="/assets/js/81.0e9da714.js"><link rel="prefetch" href="/assets/js/82.e96ff6d7.js"><link rel="prefetch" href="/assets/js/83.771cced1.js"><link rel="prefetch" href="/assets/js/84.220b69e7.js"><link rel="prefetch" href="/assets/js/86.44ba2100.js"><link rel="prefetch" href="/assets/js/87.281da75d.js"><link rel="prefetch" href="/assets/js/88.12d88449.js"><link rel="prefetch" href="/assets/js/89.f28c86d3.js"><link rel="prefetch" href="/assets/js/9.8f9fef32.js"><link rel="prefetch" href="/assets/js/90.715cabb2.js"><link rel="prefetch" href="/assets/js/91.6ced7c82.js"><link rel="prefetch" href="/assets/js/92.c05b33ca.js"><link rel="prefetch" href="/assets/js/93.6bf5fb66.js"><link rel="prefetch" href="/assets/js/94.3561200e.js"><link rel="prefetch" href="/assets/js/95.0f2cf716.js"><link rel="prefetch" href="/assets/js/96.ac8487ea.js"><link rel="prefetch" href="/assets/js/97.48042b5a.js"><link rel="prefetch" href="/assets/js/98.441bb7f8.js"><link rel="prefetch" href="/assets/js/99.4b214d92.js">
    <link rel="stylesheet" href="/assets/css/0.styles.56073ad3.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu"><header class="navbar blur"><div title="目录" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/img/magic.png" alt="Pangolin Note" class="logo"> <span class="site-name can-hide">Pangolin Note</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">🏡首页</a></div><div class="nav-item"><a href="/basic/" class="nav-link">基础</a></div><div class="nav-item"><a href="/develop/" class="nav-link">开发</a></div><div class="nav-item"><a href="/middleware/" class="nav-link">系统</a></div><div class="nav-item"><a href="/algorithm/" class="nav-link">算法</a></div><div class="nav-item"><a href="/books/" class="nav-link">🍀读书笔记</a></div><div class="nav-item"><a href="/work/" class="nav-link">工作</a></div><div class="nav-item"><a href="/pangolin/" class="nav-link">🌸达尔文的猹</a></div><div class="nav-item"><a href="/pages/beb6c0bd8a66cea6/" class="nav-link">收藏</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/archives/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">归档</a></li></ul></div></div> <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><div class="blogger"><img src="/img/avatarnew.png"> <div class="blogger-info"><h3>达尔文的猹</h3> <span>大道至简 悟在天成</span></div></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">🏡首页</a></div><div class="nav-item"><a href="/basic/" class="nav-link">基础</a></div><div class="nav-item"><a href="/develop/" class="nav-link">开发</a></div><div class="nav-item"><a href="/middleware/" class="nav-link">系统</a></div><div class="nav-item"><a href="/algorithm/" class="nav-link">算法</a></div><div class="nav-item"><a href="/books/" class="nav-link">🍀读书笔记</a></div><div class="nav-item"><a href="/work/" class="nav-link">工作</a></div><div class="nav-item"><a href="/pangolin/" class="nav-link">🌸达尔文的猹</a></div><div class="nav-item"><a href="/pages/beb6c0bd8a66cea6/" class="nav-link">收藏</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/archives/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">归档</a></li></ul></div></div> <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Java</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading"><span>基础</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/4f30b9/" class="sidebar-link">Java基础</a></li><li><a href="/pages/795eca/" class="sidebar-link">类与继承</a></li><li><a href="/pages/c69152/" class="sidebar-link">抽象类与接口</a></li><li><a href="/pages/d71abb/" class="sidebar-link">内部类</a></li><li><a href="/pages/f06dca/" class="sidebar-link">枚举类</a></li><li><a href="/pages/259f57/" class="sidebar-link">常用类</a></li><li><a href="/pages/84b03b/" class="sidebar-link">关键字</a></li><li><a href="/pages/31b87b/" class="sidebar-link">注解</a></li><li><a href="/pages/f81c0d/" class="sidebar-link">异常</a></li><li><a href="/pages/ae7746/" class="sidebar-link">泛型</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading"><span>容器类</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/0c88ac/" class="sidebar-link">集合容器类基础</a></li><li><a href="/pages/f805ed/" class="sidebar-link">List与Queue类</a></li><li><a href="/pages/d24b60/" class="sidebar-link">Map与Set类</a></li><li><a href="/pages/54e5d3/" class="sidebar-link">并发容器类</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading"><span>并发</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/67d70f/" class="sidebar-link">多线程基础</a></li><li><a href="/pages/ffc8f7/" class="sidebar-link">Java内置锁</a></li><li><a href="/pages/c43494/" class="sidebar-link">AQS</a></li><li><a href="/pages/eb5b61/" class="sidebar-link">显式锁ReentrantLock</a></li><li><a href="/pages/eb8cbc/" class="sidebar-link">线程协作与JUC组件</a></li><li><a href="/pages/23c79a/" class="sidebar-link">Atomic原子变量与Unsafe类与CAS</a></li><li><a href="/pages/9d6ed4/" class="sidebar-link">线程池与定时任务</a></li><li><a href="/pages/5b787a/" class="sidebar-link">ThreadLocal</a></li><li><a href="/pages/db53d1/" class="sidebar-link">Java并发编程实战(极客时间)🌸</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading"><span>IO</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/b4d461/" class="sidebar-link">文件操作</a></li><li><a href="/pages/1b9d6c/" class="sidebar-link">IO流操作</a></li><li><a href="/pages/076a47/" class="sidebar-link">Java网络IO模型</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading"><span>高级特性</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/d76905/" class="sidebar-link">Lambda表达式</a></li><li><a href="/pages/f7f0e6/" class="sidebar-link">流Stream</a></li><li><a href="/pages/7cc40a/" class="sidebar-link">反射</a></li><li><a href="/pages/945326/" class="sidebar-link">代理</a></li><li><a href="/pages/7fd9b4/" class="sidebar-link">Javaagent</a></li><li><a href="/pages/a3cee0/" class="sidebar-link">Guava</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading open"><span>JVM</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/d308f6/" class="sidebar-link">走进JVM🌼</a></li><li><a href="/pages/be0269/" class="sidebar-link">JVM内存区域与对象解析🌼</a></li><li><a href="/pages/48d1be/" class="sidebar-link">垃圾收集器与内存分配策略🌼</a></li><li><a href="/pages/3a4c8a/" class="sidebar-link">JVM性能监控与故障处理工具🌼</a></li><li><a href="/pages/106680/" class="sidebar-link">调优案例分析与实战🌼</a></li><li><a href="/pages/16a914/" class="sidebar-link">类文件结构🌼</a></li><li><a href="/pages/ea287c/" class="sidebar-link">虚拟机类加载机制🌼</a></li><li><a href="/pages/6367b0/" class="sidebar-link">虚拟机字节码执行引擎🌼</a></li><li><a href="/pages/c6c210/" aria-current="page" class="active sidebar-link">类加载及执行子系统的案例与实战🌼</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/pages/deb8b7/" class="sidebar-link">前端编译与优化🌼</a></li><li><a href="/pages/1f8f72/" class="sidebar-link">后端编译与优化🌼</a></li><li><a href="/pages/3d72db/" class="sidebar-link">Java内存模型与线程实现🌼</a></li><li><a href="/pages/ed086e/" class="sidebar-link">线程安全与内置锁优化🌼</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading"><span>其他</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/56b9dd/" class="sidebar-link">Java性能问题定位分析</a></li><li><a href="/pages/939bf8/" class="sidebar-link">杂记</a></li></ul></section></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>开发</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading open"><span>软件设计</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/a5f6fe/" class="sidebar-link">设计基础理论</a></li><li><a href="/pages/3b245c/" class="sidebar-link">设计模式之美(极客时间)🌟</a></li><li><a href="/pages/661fa4/" class="sidebar-link">领域驱动设计(DDD)</a></li><li><a href="/pages/856368/" class="sidebar-link">DDD实战课(极客时间)🌸</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading"><span>数据库</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/d3fbd2/" class="sidebar-link">数据库基础</a></li><li><a href="/pages/691fc3/" class="sidebar-link">数据库系统原理</a></li><li><a href="/pages/50f6b7/" class="sidebar-link">MySQL基础必知必会</a></li><li><a href="/pages/fe297e/" class="sidebar-link">MySQL特性</a></li><li><a href="/pages/07bdb6/" class="sidebar-link">MySQL索引🌟</a></li><li><a href="/pages/984715/" class="sidebar-link">MySQL锁🌟</a></li><li><a href="/pages/53b588/" class="sidebar-link">MySQL事务🌟</a></li><li><a href="/pages/becc59/" class="sidebar-link">MySQL高级特性</a></li><li><a href="/pages/056463/" class="sidebar-link">MySQL基础架构与存储引擎🌟</a></li><li><a href="/pages/63b46e/" class="sidebar-link">MySQL架构优化与运维</a></li><li><a href="/pages/9995e5/" class="sidebar-link">MySQL优化</a></li><li><a href="/pages/c1c2f6/" class="sidebar-link">MySQL架构</a></li><li><a href="/pages/8e8e0a/" class="sidebar-link">MySQL设计规范</a></li><li><a href="/pages/0219aa/" class="sidebar-link">MySQL运维</a></li><li><a href="/pages/e288c0/" class="sidebar-link">MySQL中间件</a></li><li><a href="/pages/c6cafa/" class="sidebar-link">MySQL实战45讲(极客时间)🌟</a></li><li><a href="/pages/4a6106/" class="sidebar-link">数据库LeetCode题目</a></li><li><a href="/pages/2827f1/" class="sidebar-link">数据库综合问题</a></li><li><a href="/pages/c616d5/" class="sidebar-link">MongoDB</a></li><li><a href="/pages/075e71/" class="sidebar-link">ClickHouse</a></li><li><a href="/pages/d74f6d/" class="sidebar-link">Doris</a></li><li><a href="/pages/b6bad9/" class="sidebar-link">HBase</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading"><span>Spring</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/bd8eb8/" class="sidebar-link">Spring Boot基础</a></li><li><a href="/pages/d0d797/" class="sidebar-link">Spring Boot应用整合</a></li><li><a href="/pages/314cdc/" class="sidebar-link">Spring MVC基础</a></li><li><a href="/pages/80de47/" class="sidebar-link">Spring AOP基础</a></li><li><a href="/pages/f0d4d6/" class="sidebar-link">Spring事务基础</a></li><li><a href="/pages/db6afe/" class="sidebar-link">Spring IOC源码分析-概览</a></li><li><a href="/pages/672e98/" class="sidebar-link">Spring IOC源码分析-getBean()</a></li><li><a href="/pages/695b90/" class="sidebar-link">Spring IOC源码分析-createBean()</a></li><li><a href="/pages/f89bcf/" class="sidebar-link">Spring AOP源码分析</a></li><li><a href="/pages/3b52f4/" class="sidebar-link">Spring事务源码分析</a></li><li><a href="/pages/186902/" class="sidebar-link">Spring Boot源码分析</a></li><li><a href="/pages/16bd1c/" class="sidebar-link">Spring MVC源码分析</a></li><li><a href="/pages/3d0c1f/" class="sidebar-link">Spring Cloud</a></li><li><a href="/pages/d56156/" class="sidebar-link">Spring编程常见错误50例(极客时间)🌸</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading"><span>MyBatis</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/bb032d/" class="sidebar-link">基础</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading"><span>工具与环境</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/c9cb6e/" class="sidebar-link">Arthas</a></li><li><a href="/pages/3172bb/" class="sidebar-link">Maven</a></li><li><a href="/pages/37f79a/" class="sidebar-link">Git</a></li><li><a href="/pages/db9f99/" class="sidebar-link">环境搭建与部署</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading"><span>测试</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/c725f5/" class="sidebar-link">测试基础</a></li><li><a href="/pages/7893a4/" class="sidebar-link">单元测试</a></li><li><a href="/pages/af9f25/" class="sidebar-link">压力测试</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading"><span>代码质量</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/ec2b81/" class="sidebar-link">代码整洁之道</a></li><li><a href="/pages/474cdf/" class="sidebar-link">阿里巴巴编程规范</a></li><li><a href="/pages/c47e15/" class="sidebar-link">代码之丑(极客时间)🌸</a></li><li><a href="/pages/4d4606/" class="sidebar-link">Java业务开发常见错误100例(极客时间)🌸</a></li></ul></section></li></ul></section></li></ul> </aside> <div><main class="page"><div class="theme-vdoing-wrapper "><div class="articleInfo-wrap" data-v-06970110><div class="articleInfo" data-v-06970110><ul class="breadcrumbs" data-v-06970110><li data-v-06970110><a href="/" title="首页" class="iconfont icon-home router-link-active" data-v-06970110></a></li> <li data-v-06970110><a href="/develop/#开发" data-v-06970110>开发</a></li><li data-v-06970110><a href="/develop/#Java" data-v-06970110>Java</a></li><li data-v-06970110><a href="/develop/#JVM" data-v-06970110>JVM</a></li></ul> <div class="info" data-v-06970110><div title="作者" class="author iconfont icon-touxiang" data-v-06970110><a href="https://github.com/nanodaemony" target="_blank" title="作者" class="beLink" data-v-06970110>NanoDaemony</a></div> <div title="创建时间" class="date iconfont icon-riqi" data-v-06970110><a href="javascript:;" data-v-06970110>2025-02-26</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-title">本文目录</div> <div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABKFJREFUSA3tVl1oFVcQnrMbrak3QUgkya1akpJYcrUtIqW1JvFBE9LiQ5v6JmJpolbMg32rVrhgoYK0QiMY6i9Y6EMaW5D+xFJaTYItIuK2Kr3+BJNwkxBj05sQY3b3nM6cs2dv9t7NT/vQJw/sndk5M/PNzJkzewGerP+pAmy+ON8lLzUJgA8ZYxYIYZmGYRnctDaWvJJAmTtfP1pvXsBCCPP8QFcCaRkZYACgDZFO4stNIcBCajEOlmmC9XpJ9bAGCaPaPmzPl32dvLSVu3BWCTQs0XQQ6g0DYgwLIoAZbBCdW/i+781o1VVlm/410mw4h06Y7bIPHNyWDyL4FHkX03Q8SrzNhZTZriieckWt7cL6MM85YcLpsi/7O9/iXFT6MswI0DmmpkSaJ0qLxFIm3+i1THHB3zmBH3PYx9CcykcLOeQVVa7QtdxTgQgEleX2AjHYfwA+2ddV77ruGoJUbhGDI09YSNXyMpUt5ylOzxgbUmtOp7NmbNt8v3arjTBfYELmLUV+M+nSawNNAUqpT3ClJWg5I3BLT+cGW/DXNGCa6tx1aakCGEigArTn4TDIPdrXXYKCZNrHLMCOEPvHBlLQ99s9eHB7EB6NTki73CVPQ2F5MSx/uRQixfmq7rK0wYD8w8E905bnPDfwoWs/rfv93NWN/ZfvwsLIU7A09gxECyISeGJkHAau98L97tuw7NXnoPyNF8FcYGLGKsOs0mN3OEyec9esGW/ZEl945dTP34wlR2FZVQWU1q0Cw8Tr7p+hgLLNL0FPxx/Q35mA8aEUrH6nCgwEl0tn7wUiZYJnNRh6DK4UH/k0lfyrsBKdPVv/AriGIQcEDQZ65LBAGe2Rzui9Ybjz7XUppz1/uKBbyVPGkN3ZAeC6hr0x7Nr38N5+EqkoOm17xpoqR9ohQF55ERSvr4Dkr3chNfC3DMzGJlNBElW8w9nsGQvhNGIzDkXzCg8cLK951xHsFBlTJspJNi3ZFIMF2AeDV3q8DNOB+YHi6QTrChDIWDBRi5U5f+ZMfJLu3ccrqxtdxk4SKH336LFxSmkqefwU5T8fhdSdQf9IVKD6aNiwI/hnmcAZ91isYMJIaCUCx9W098+LgruikeTqzqqxKPUwqJyCPJiyemVVZBOijDGjD38Os0jOiSPL1z3SPjXNANbiNPXAdzTfukjjuknNBbyz3nwgTd3AVFqUJ5hpHlq9MveLnWwttUfoygBmvVjuikxND3znrhsELnZk7k+OjIGxeNEkomyLVta0xxn+HZhjBc4YZ/AFjHjz9u3xRZl2BN4aq9nFwWh16IrQ1aHHEd3j1+4/dB9OtH4e29A2H1DyHQRmOSfQZ1Fy7MHBTGB6J/Djq6p3OxyO2cB+4Car7v/o3GXgfAkj23+x9ID1Teoamo/SXcbvSf2PX7Vc8DdCmE1vN9di+32P9/5YR3vLnhCVGUWBjEkr3yh4H8v9CzmsbdhzOKzsJKM90iFdaTMjRPhGVsakRvOaRidljo6H6G7j+ctrJpsP+4COhDIl0La2+FS4+5mlocBaXY5QnGZysIBYoeSsl5qQzrSj/cgNrfuEzlWBfwA+EjrZyWUvpAAAAABJRU5ErkJggg==">类加载及执行子系统的案例与实战🌼<!----></h1>  <div class="theme-vdoing-content content__default"><h1 id="_33-类加载及执行子系统的案例与实战🌼"><a href="#_33-类加载及执行子系统的案例与实战🌼" class="header-anchor">#</a> 33.类加载及执行子系统的案例与实战🌼</h1> <p>本节对应《深入理解 Java 虚拟机》的第九章</p> <h4 id="概述"><a href="#概述" class="header-anchor">#</a> 概述</h4> <p>在 Class 文件格式与执行引擎这部分里, 用户的程序能直接参与的内容并不太多, Class 文件以何种格式存储, 类型何时加载, 如何连接, 以及虚拟机如何执行字节码指令等都是由虚拟机直接控制的行为, 用户程序无法对其进行改变. 能通过程序进行操作的, 主要是字节码生成与类加载器这两部分的功能, 但仅仅在如何处理这两点上, 就已经出现了许多值得欣赏和借鉴的思路, 这些思路后来成为许多常用功能和程序实现的基础. 在本章中, 将看一下前面所学的知识在<strong>实际开发之中是如何应用</strong>的.</p> <h4 id="类加载综合示例"><a href="#类加载综合示例" class="header-anchor">#</a> 类加载综合示例</h4> <p>一个简单的类:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Student</span> <span class="token punctuation">{</span>
  
    <span class="token keyword">private</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span>
  
    <span class="token keyword">public</span> <span class="token class-name">Student</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">hello</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>Main 方法:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Test</span> <span class="token punctuation">{</span>
  
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Student</span> stu <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Student</span><span class="token punctuation">(</span><span class="token string">&quot;Jack&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        stu<span class="token punctuation">.</span><span class="token function">hello</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> 
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>执行 main 方法的步骤如下:</p> <ol><li>编译好 Test.java 后得到 Test.class 后, 执行 Test.class, 系统会启动一个 JVM 进程, 从 <strong>classpath</strong> 路径中找到一个名为 <strong>Test.class 的二进制文件</strong>, 将 <strong>Test 的类信息加载到运行时数据区的方法区内, 这个过程即 Test 类的加载</strong>.</li> <li>JVM 找到 Test 的主程序入口, 执行 main 方法.</li> <li>这个 main 中的第一条语句就是让 JVM <strong>创建一个 Student 对象</strong>, 但是这个时候<strong>方法区</strong>中是没有 Student 类的信息的, 所以 JVM 马上<strong>加载 Student 类</strong>, 把 Student 类的信息放到方法区中.</li> <li>加载完 Student 类后, JVM 在<strong>堆中</strong>为一个新的 Student <strong>实例分配内存</strong>, 然后调用构造函数初始化 Student 实例, 这个 Student 实例持有<strong>指向方法区中的 Student 类的类型信息</strong> 的引用.</li> <li>执行 stu.hello() 时, JVM 根据 <strong>stu 的引用找到 stu 对象</strong>, 然后根据 stu 对象<strong>持有的引用定位到方法区中 stu 类的类型信息的方法表</strong>, 获得 hello() 的<strong>字节码地址</strong>.</li> <li>执行 hello() 方法.</li></ol> <p><strong>总结一下就是对象实例初始化时会去方法区中找类信息, 完成后再到栈那里去运行方法. 找方法就在方法表中找.</strong></p> <h4 id="案例分析"><a href="#案例分析" class="header-anchor">#</a> 案例分析</h4> <p>在案例分析部分准备了 4 个例子, 关于<strong>类加载器和字节码</strong>的案例各有两个. 并且这两个领域的案例中又各有一个案例是大多数 Java 开发人员都使用过的工具或技术, 另外一个案例虽然不一定每个人都使用过, 但却能特别精彩地演绎出这个领域中的技术特性. 希望后面的案例能引起读者的思考, 并给读者的日常工作带来灵感.</p> <h5 id="_1-tomcat-正统的类加载器架构"><a href="#_1-tomcat-正统的类加载器架构" class="header-anchor">#</a> 1.Tomcat:正统的类加载器架构</h5> <blockquote><p>Web服务器需要解决的问题</p></blockquote> <p>主流的 Java Web 服务器, 如 Tomcat, Jetty, WebLogic, WebSphere 或其他笔者没有列举的服务器, 都<strong>实现了自己定义的类加载器, 而且一般还都不止一个</strong>. 因为一个功能健全的 Web 服务器, 都要解决如下的这些问题:</p> <ul><li><mark><strong>部署在同一个服务器上的两个 Web 应用程序所使用的 Java 类库可以实现相互隔离</strong></mark>. 这是最基本的需求, <strong>两个不同的应用程序可能会依赖同一个第三方类库的不同版本, 不能要求每个类库在一个服务器中只能有一份, 服务器应当能够保证两个独立应用程序的类库可以互相独立使用</strong>.</li> <li><mark><strong>部署在同一个服务器上的两个 Web 应用程序所使用的 Java 类库可以互相共享</strong></mark>. 这个需求与前面一点正好相反, 但是也很常见, 例如用户可能有 10 个使用 Spring 组织的应用程序部署在同一台服务器上, 如果把 10 份 Spring 分别存放在各个应用程序的隔离目录中, 将会是很大的资源浪费. 这主要倒不是浪费磁盘空间的问题, 而是指类库在使用时都要被加载到服务器内存, 如果类库不能共享, 虚拟机的方法区就会很容易出现过度膨胀的风险.</li> <li><mark><strong>服务器需要尽可能地保证自身的安全不受部署的 Web 应用程序影响</strong></mark>. 目前, 有许多主流的 Java Web 服务器自身也是使用 Java 语言来实现的. 因此服务器本身也有类库依赖的问题, 一般来说, 基于安全考虑, <strong>服务器所使用的类库应该与应用程序的类库互相独立</strong>.</li> <li>支持 JSP 应用的 Web 服务器, 十有八九都需要支持 <strong>HotSwap</strong> 功能. JSP 文件最终要被编译成 Java 的 Class 文件才能被虚拟机执行, 但 JSP 文件由于其纯文本存储的特性, 被运行时修改的概率远大于第三方类库或程序自己的 Class 文件. 而且 ASP, PHP 和 JSP 这些网页应用也把修改后无须重启作为一个很大的 &quot;优势&quot; 来看待, 因此 &quot;主流&quot; 的 Web 服务器都会支持 JSP 生成类的热替换, 当然也有 &quot;非主流&quot; 的, 如运行在生产模式(Production Mode)下的 WebLogic 服务器默认就不会处理 JSP 文件的变化.</li></ul> <blockquote><p>Tomcat能不能使用默认的双亲委派模型?</p></blockquote> <p><strong>Tomcat 如果使用默认的双亲委派类加载机制行不行?</strong>  答案是不行的.</p> <ul><li>第一个问题, 如果使用默认的类加载器机制, 那么是无法加载两个相同类库的不同版本的, 默认的类加器是不管是什么版本的, 只在乎全限定类名, 并且只有一份.</li> <li>第二个问题, 默认的类加载器是能够实现的, 因为他的职责就是保证<strong>唯一性</strong>.</li> <li>第三个问题和第一个问题一样.</li></ul> <p>由于存在上述问题, 在部署 Web 应用时, 单独的一个 ClassPath 就不能满足需求了, <strong>所以各种 Web 服务器都不约而同地提供了好几个</strong>​<mark><strong>有着不同含义的 ClassPath 路径供用户存放第三方类库</strong></mark>​ <strong>, 这些路径一般会以 &quot;lib&quot; 或 &quot;classes&quot; 命名</strong>. 被放置到不同路径中的类库, 具备不同的访问范围和服务对象, <mark><strong>通常每一个目录都会有一个相应的自定义类加载器去加载放置在里面的 Java 类库</strong></mark>.</p> <p>现在就以 Tomcat 服务器为例, 来分析 Tomcat 具体是如何规划用户类库结构和类加载器的.</p> <p>在 Tomcat 目录结构中, 可以设置 3 组目录(<code>/common/*</code>​, <code>/server/*</code>​ 和 <code>/shared/*</code>​, 但默认不一定是开放的, 可能只有 <code>/lib/*</code>​ 目录存在)用于存放 Java 类库, 另外还应该加上 Web 应用程序自身的 &quot;<code>/WEB-INF/*</code>​&quot; 目录, 一共 4 组. 把 Java 类库放置在这 4 组目录中, 每一组都有独立的含义, 分别是:</p> <ul><li><strong>放置在 /common 目录中. 类库可被 Tomcat 和所有的 Web 应用程序共同使用</strong>.</li> <li><strong>放置在 /server 目录中. 类库可被 Tomcat 使用, 对所有的 Web 应用程序都不可见</strong>.</li> <li><strong>放置在 /shared 目录中. 类库可被所有的 Web 应用程序共同使用, 但对 Tomcat 自己不可见</strong>.</li> <li><strong>放置在 /WebApp/WEB-INF 目录中. 类库仅仅可以被该 Web 应用程序使用, 对 Tomcat 和其他 Web 应用程序都不可见</strong>.</li></ul> <p><mark><strong>为了支持这套目录结构, 并对目录里面的类库进行加载和隔离, Tomcat 自定义了多个类加载器, 这些类加载器按照经典的双亲委派模型来实现</strong></mark>, 其关系如图 9-1 所示.</p> <p><img src="/img/4.%E7%B1%BB%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E4%B8%8E%E7%B1%BB%E5%8A%A0%E8%BD%BD%E6%9C%BA%E5%88%B6-Tomcat%E7%B1%BB%E5%8A%A0%E8%BD%BD%E5%99%A8%E6%A8%A1%E5%9E%8B-20230329223827-jn5ynbg.png" alt="4.类文件结构与类加载机制-Tomcat类加载器模型" title="图9-1 Tomcat 服务器的类加载架构"></p> <p>顶上的 3 个类加载器是 JDK(以 JDK 9 之前经典的三层类加载器为例)<strong>默认提供的类加载器</strong>, 这 3 个加载器的作用已经介绍过了(参考: 类加载器分类). <mark><strong>而 Common 类加载器, Catalina 类加载器(也称为 Server 类加载器), Shared 类加载器和 Webapp 类加载器则是 Tomcat 自己定义的类加载器</strong></mark>, 它们分别加载 <code>/common/*</code>​, <code>/server/*</code>​, <code>/shared/*</code>​ 和 <code>/WebApp/WEB-INF/*</code>​ 中的 Java 类库. 其中 <strong>WebApp 类加载器和 JSP 类加载器通常还会存在多个实例, 每一个 Web 应用程序对应一个 WebApp 类加载器, 每一个 JSP 文件对应一个 JasperLoader 类加载器</strong>.</p> <p>Tomcat 的几个<strong>主要类加载器</strong>:</p> <ul><li><strong>CommonClassLoader</strong>: Tomcat 最基本的类加载器, 加载路径中的 class 可以被 Tomcat 容器本身以及各个 Webapp 访问.</li> <li><strong>CatalinaClassLoader</strong>: Tomcat 容器私有的类加载器, 加载路径中的 class 对于 Webapp 不可见.</li> <li><strong>SharedClassLoader</strong>: 各个 Webapp 共享的类加载器, 加载路径中的 class 对于所有 Webapp 可见, 但是对于 Tomcat 容器不可见.</li> <li><strong>WebappClassLoader</strong>: 各<strong>个 Webapp 私有的类加载器</strong>, 加载路径中的 class 只<strong>对当前 Webapp 可见</strong>, 比如加载 war 包里相关的类, 每个 war 包应用都有自己的 WebappClassLoader, 实现<strong>相互隔离</strong>, 比如不同 war 包应用引入了不同的 spring 版本, 这样实现就能加载各自的 spring 版本; 每个 war 包都有一个 WebappClassLoader 来加载自己的东西, 不再进行双亲委派, 打破了双亲委派机制.</li></ul> <p>从图 9-1 的委派关系中可以看出, Common 类加载器能加载的类都可以被 Catalina 类加载器和 Shared 类加载器使用, <strong>而 Catalina 类加载器和 Shared 类加载器自己能加载的类则与对方相互隔离</strong>. WebApp 类加载器可以使用 Shared 类加载器加载到的类, 但<strong>各个 WebApp 类加载器实例之间相互隔离</strong>. 而 JasperLoader 的加载范围仅仅是这个 JSP 文件所编译出来的那一个 Class 文件, 它存在的目的就是为了被丢弃: 当服务器检测到 JSP 文件被修改时, 会替换掉目前的 JasperLoader 的实例, 并通过再建立一个新的 JSP 类加载器来实现 JSP 文件的 HotSwap 功能.</p> <p>Tomcat 这种类加载机制违背了 Java 推荐的双亲委派模型. Tomcat 为了实现隔离性, <strong>每个 webappClassLoader 加载自己的目录下的 class 文件, 不会传递给父类加载器, 打破了双亲委派机制</strong>.</p> <p>本例中的类加载结构在 Tomcat 6 以前是它默认的类加载器结构, 在 Tomcat 6 及之后的版本<strong>简化了默认的目录结构</strong>, 只有指定了 <code>tomcat/conf/catalina.properties</code>​ 配置文件的 <code>server.loader</code>​ 和 <code>share.loader</code>​ 项后才会真正建立 Catalina 类加载器和 Shared 类加载器的实例, 否则会用到这两个类加载器的地方都会用 Common 类加载器的实例代替, 而默认的配置文件中并没有设置这两个 loader 项, 所以 Tomcat 6 之后也顺理成章地把 <code>/common</code>​, <code>/server</code>​ 和 <code>/shared</code>​ 这 3 个目录默认合并到一起变成 1 个 <code>/lib</code>​ 目录, 这个目录里的类库相当于以前 <code>/common</code>​ 目录中类库的作用, 是 Tomcat 的开发团队为了简化大多数的部署场景所做的一项易用性改进. 如果默认设置不能满足需要, 用户可以通过修改配置文件指定 server.loader 和 share.loader 的方式重新启用原来完整的加载器架构.</p> <p>Tomcat 加载器的实现清晰易懂, 并且采用了官方推荐的 &quot;<strong>正统</strong>&quot; 的使用类加载器的方式. 如果读者阅读完上面的案例后, 毫不费力就能完全理解 Tomcat 设计团队这样布置加载器架构的用意, 这就说明你已经大致掌握了类加载器 &quot;主流&quot; 的使用方式.</p> <h5 id="_2-osgi-灵活的类加载器架构"><a href="#_2-osgi-灵活的类加载器架构" class="header-anchor">#</a> 2.OSGi:灵活的类加载器架构</h5> <p>曾经在 Java 程序社区中流传着这么一个观点: &quot;学习 Java EE 规范, 推荐去看 JBoss 源码; <strong>学习类加载器的知识, 就推荐去看 OSGi 源码</strong>.&quot; 尽管 &quot;Java EE 规范&quot; 和 &quot;类加载器的知识&quot; 并不是一个对等的概念, 不过, 既然这个观点能在部分程序员群体中流传开来, 也从侧面说明了 OSGi 对类加载器的运用确实有其独到之处.</p> <p><strong>OSGi</strong> (Open Service Gateway Initiative)是 OSGi 联盟(OSGi Alliance)制订的<strong>一个基于 Java 语言的</strong>​<mark><strong>动态模块化规范</strong></mark>(在 JDK 9 引入的 JPMS 是静态的模块系统), 这个规范最初的目的是使服务提供商通过住宅网关为各种家用智能设备提供服务, 后来这个规范在 Java 的其他技术领域也有相当不错的发展, 现在已经成为 Java 世界中 &quot;事实上&quot; 的动态模块化标准, 并且已经有了 Equinox, Felix 等成熟的实现. 根据 OSGi 联盟主页上的宣传资料, OSGi 现在的重点应用在智慧城市, 智慧农业, 工业 4.0 这些地方, 而在传统 Java 程序员中最知名的应用案例可能就数 Eclipse IDE 了, 另外, 还有许多大型的软件平台和中间件服务器都基于或声明将会基于 OSGi 规范来实现, 如 IBM Jazz 平台, GlassFish 服务器, JBoss OSGi 等.</p> <p>OSGi 中的每个模块(称为 Bundle)与普通的 Java 类库区别并不太大, 两者一般都以 JAR 格式进行封装, 并且内部存储的都是 Java 的 Package 和 Class. 但是一个 Bundle 可以声明它所依赖的 Package(通过 Import-Package 描述), 也可以声明它允许导出发布的 Package(通过 Export-Package 描述). 在 OSGi 里面, Bundle 之间的依赖关系从传统的上层模块依赖底层模块转变为平级模块之间的依赖, 而且类库的可见性能得到非常精确的控制, 一个模块里只有被 Export 过的 Package 才可能被外界访问, 其他的 Package 和 Class 将会被隐藏起来.</p> <p>以上这些<strong>静态的模块化特性</strong>原本也是 OSGi 的核心需求之一, 不过它和后来出现的 Java 的模块化系统互相重叠了, 所以 <strong>OSGi 现在着重向动态模块化系统的方向发展</strong>. 在今天, 通常引入 OSGi 的主要理由是基于 OSGi 架构的程序很可能(只是很可能, 并不是一定会, 需要考虑热插拔后的内存管理, 上下文状态维护问题等复杂因素)会实现模块级的热插拔功能, 当程序升级更新或调试除错时, 可以只停用, 重新安装然后启用程序的其中一部分, 这对大型软件, 企业级程序开发来说是一个非常有诱惑力的特性, 譬如 Eclipse 中安装, 卸载, 更新插件而不需要重启动, 就使用到了这种特性.</p> <p>OSGi 之所以能有上述诱人的特点, 必须要归功于它<strong>灵活的类加载器架构</strong>. OSGi 的 <strong>Bundle 类加载器之间只有规则, 没有固定的委派关系</strong>. 例如, 某个 Bundle 声明了一个它依赖的 Package, 如果有其他 Bundle 声明了发布这个 Package 后, 那么所有对这个 Package 的类加载动作都会委派给发布它的 Bundle 类加载器去完成. <strong>不涉及某个具体的 Package 时, 各个 Bundle 加载器都是平级的关系</strong>, 只有具体使用到某个 Package 和 Class 的时候, 才会根据 Package 导入导出定义来构造 Bundle 间的委派和依赖.</p> <p>另外, 一个 Bundle 类加载器为其他 Bundle 提供服务时, 会根据 Export-Package 列表严格控制访问范围. 如果一个类存在于 Bundle 的类库中但是没有被 Export, 那么这个 Bundle 的类加载器能找到这个类, 但不会提供给其他 Bundle 使用, 而且 OSGi 框架也不会把其他 Bundle 的类加载请求分配给这个 Bundle 来处理.</p> <p>可以举一个更具体些的简单例子来解释上面的规则, 假设存在 Bundle A, Bundle B, Bundle C 3 个模块, 并且这 3 个 Bundle 定义的依赖关系如下所示.</p> <ul><li>Bundle A: 声明发布了 packageA, 依赖了 <code>java.*</code>​ 的包;</li> <li>Bundle B: 声明依赖了 packageA 和 packageC, 同时也依赖了 <code>java.*</code>​ 的包;</li> <li>Bundle C: 声明发布了 packageC, 依赖了 packageA.</li></ul> <p>那么, 这 3 个 Bundle 之间的类加载器及父类加载器之间的关系如图 9-2 所示.</p> <p><img src="/img/Image00186-20240302133505-ae7dwu2.jpg" alt="" title="图9-2　OSGi 的类加载器架构"></p> <p>由于没有涉及具体的 OSGi 实现, 图 9-2 中的类加载器都没有指明具体的加载器实现, 它只是一个体现了加载器之间关系的概念模型, 并且只是体现了 OSGi 中最简单的加载器委派关系. 一般来说, 在 OSGi 里, 加载一个类可能发生的查找行为和委派关系会远远比图 9-2 中显示的复杂, 类加载时可能进行的查找规则如下:</p> <ol><li>以 <code>java.*</code>​ 开头的类, 委派给父类加载器加载.</li> <li>否则, 委派列表名单内的类, 委派给父类加载器加载.</li> <li>否则, Import 列表中的类, 委派给 Export 这个类的 Bundle 的类加载器加载.</li> <li>否则, 查找当前 Bundle 的 Classpath, 使用自己的类加载器加载.</li> <li>否则, 查找是否在自己的 Fragment Bundle 中, 如果是则委派给 Fragment Bundle 的类加载器加载.</li> <li>否则, 查找 Dynamic Import 列表的 Bundle, 委派给对应 Bundle 的类加载器加载.</li> <li>否则, 类查找失败.</li></ol> <p>从图 9-2 中还可以看出, 在 OSGi 中, <mark><strong>加载器之间的关系不再是双亲委派模型的树形结构, 而是已经进一步发展成一种更为复杂的, 运行时才能确定的网状结构</strong></mark>. 这种网状的类加载器架构在带来更优秀的灵活性的同时, 也可能会产生许多新的隐患. 笔者曾经参与过将一个非 OSGi 的大型系统向 Equinox OSGi 平台迁移的项目, 由于项目规模和历史原因, 代码模块之间的依赖关系错综复杂, 勉强分离出各个模块的 Bundle 后, 发现在高并发环境下经常出现死锁. 很容易就找到了死锁的原因: 如果出现了 Bundle A 依赖 Bundle B 的 Package B, 而 Bundle B 又依赖了 Bundle A 的 Package A, 这<strong>两个 Bundle 进行类加载时就有很高的概率发生死锁</strong>. 具体情况是当 Bundle A 加载 Package B 的类时, 首先需要锁定当前类加载器的实例对象(java.lang.ClassLoader.loadClass() 是一个同步方法), 然后把请求委派给 Bundle B 的加载器处理, 但如果这时 Bundle B 也正好想加载 Package A 的类, 它会先锁定自己的加载器再去请求 Bundle A 的加载器处理, 这样两个加载器都在等待对方处理自己的请求, 而对方处理完之前自己又一直处于同步锁定的状态, 因此它们就互相死锁, 永远无法完成加载请求了. Equinox 的 Bug List 中有不少关于这类问题的 Bug, 也提供了一个以牺牲性能为代价的解决方案---用户可以启用 osgi.classloader.singleThreadLoads 参数来按单线程串行化的方式强制进行类加载动作. 在 JDK 7 时才终于出现了 JDK 层面的解决方案, 类加载器架构进行了一次专门的升级, 在 ClassLoader 中增加了 registerAsParallelCapable 方法对可并行的类加载进行注册声明, <strong>把锁的级别从 ClassLoader 对象本身, 降低为要加载的类名这个级别, 目的是从底层避免以上这类死锁出现的可能</strong>.</p> <p>总体来说, <strong>OSGi 描绘了一个很美好的模块化开发的目标, 而且定义了实现这个目标所需的各种服务, 同时也有成熟框架对其提供实现支持</strong>. 对于单个虚拟机下的应用, 从开发初期就建立在 OSGi 上是一个很不错的选择, 这样便于约束依赖. 但并非所有的应用都适合采用 OSGi 作为基础架构, OSGi 在提供强大功能的同时, 也引入了额外而且非常高的复杂度, 带来了额外的风险.</p> <h5 id="_3-字节码生成技术与动态代理的实现"><a href="#_3-字节码生成技术与动态代理的实现" class="header-anchor">#</a> 3.字节码生成技术与动态代理的实现</h5> <p>&quot;字节码生成&quot; 并不是什么高深的技术, 读者在看到 &quot;字节码生成&quot; 这个标题时也先不必去想诸如 <strong>Javassist, CGLib, ASM</strong> 之类的字节码类库, 因为 JDK 里面的 Javac 命令就是字节码生成技术的 &quot;老祖宗&quot;, 并且 Javac 也是一个由 Java 语言写成的程序, 它的代码存放在 OpenJDK 的 <code>jdk.compiler\share\classes\com\sun\tools\javac</code>​ 目录中. 要深入从 Java 源码到字节码编译过程, 阅读 Javac 的源码是个很好的途径, 不过 Javac 对于这个例子来说太过庞大了. 在 Java 世界里面除了 Javac 和字节码类库外, <strong>使用到字节码生成的例子比比皆是</strong>, 如 Web 服务器中的 JSP 编译器, 编译时织入的 AOP 框架, 还有很常用的<strong>动态代理技术</strong>, 甚至在使用反射的时候虚拟机都有可能会在运行时生成字节码来提高执行速度. 这里选择其中相对简单的<strong>动态代理技术来讲解字节码生成技术是如何影响程序运作</strong>的.</p> <p>相信许多 Java 开发人员都使用过动态代理, 即使没有直接使用过 java.lang.reflect.Proxy 或实现过 java.lang.reflect.InvocationHandler 接口, 应该也用过 Spring 来做过 Bean 的组织管理. 如果使用过 Spring, 那大多数情况应该已经不知不觉地用到动态代理了, 因为如果 Bean 是面向接口编程, 那么在 <mark><strong>Spring 内部都是通过动态代理的方式来对 Bean 进行增强的</strong></mark>. 动态代理中所说的 &quot;动态&quot;, 是针对使用 Java 代码实际编写了代理类的 &quot;静态&quot; 代理而言的, 它的优势不在于省去了编写代理类那一点编码工作量, 而是<strong>实现了可以在原始类和接口还未知的时候, 就确定代理类的代理行为, 当代理类与原始类脱离直接联系后, 就可以很灵活地重用于不同的应用场景之中</strong>.</p> <p>代码清单 9-1 演示了一个最简单的动态代理的用法, 原始的代码逻辑是打印一句 &quot;hello world&quot;, 代理类的逻辑是在原始类方法执行前打印一句 &quot;welcome&quot;. 先看一下代码, 然后再分析 JDK 是如何做到的. 这里用的是 JDK 动态代理, 参考: JDK动态代理.</p> <blockquote><p>代码清单9-1 动态代理的简单示例</p></blockquote> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DynamicProxyTest</span> <span class="token punctuation">{</span>

    <span class="token keyword">interface</span> <span class="token class-name">IHello</span> <span class="token punctuation">{</span>
        <span class="token keyword">void</span> <span class="token function">sayHello</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Hello</span> <span class="token keyword">implements</span> <span class="token class-name">IHello</span> <span class="token punctuation">{</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">sayHello</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;hello world&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">DynamicProxy</span> <span class="token keyword">implements</span> <span class="token class-name">InvocationHandler</span> <span class="token punctuation">{</span>

        <span class="token class-name">Object</span> originalObj<span class="token punctuation">;</span>

        <span class="token class-name">Object</span> <span class="token function">bind</span><span class="token punctuation">(</span><span class="token class-name">Object</span> originalObj<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>originalObj <span class="token operator">=</span> originalObj<span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token class-name">Proxy</span><span class="token punctuation">.</span><span class="token function">newProxyInstance</span><span class="token punctuation">(</span>originalObj<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> originalObj<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getInterfaces</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">invoke</span><span class="token punctuation">(</span><span class="token class-name">Object</span> proxy<span class="token punctuation">,</span> <span class="token class-name">Method</span> method<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;welcome&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> method<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>originalObj<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">IHello</span> hello <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">IHello</span><span class="token punctuation">)</span> <span class="token keyword">new</span> <span class="token class-name">DynamicProxy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Hello</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        hello<span class="token punctuation">.</span><span class="token function">sayHello</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br></div></div><p>运行结果如下:</p> <div class="language-ziti1 line-numbers-mode"><pre class="language-text"><code>welcome
hello world
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>在上述代码里, 唯一的 &quot;黑匣子&quot; 就是 <code>Proxy::newProxyInstance()</code>​ 方法, 除此之外再没有任何特殊之处. 这个方法<strong>返回一个实现了 IHello 的接口, 并且代理了 new Hello() 实例行为的对象</strong>.</p> <p>跟踪这个方法的源码, 可以看到程序进行过<strong>验证, 优化, 缓存, 同步, 生成字节码, 显式类加载</strong>等操作, 前面的步骤并不是关注的重点, 这里只分析它最后调用 <code>sun.misc.ProxyGenerator::generateProxyClass()</code>​ 方法来<strong>完成生成字节码的动作</strong>, 这个方法会<strong>在运行时产生一个描述代理类的字节码 byte[] 数组</strong>. 如果想看一看这个在运行时产生的代理类中写了些什么, 可以在 main() 方法中加入下面这句:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">getProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;sun.misc.ProxyGenerator.saveGeneratedFiles&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;true&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>加入这句代码后再次运行程序, 磁盘中将会产生一个名为 &quot;<code>$Proxy0.class</code>​&quot; 的代理类 Class 文件, 反编译后可以看见如代码清单 9-2 所示的内容:</p> <blockquote><p>代码清单9-2 反编译的动态代理类的代码</p></blockquote> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">org<span class="token punctuation">.</span>fenixsoft<span class="token punctuation">.</span>bytecode</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span></span><span class="token class-name">InvocationHandler</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span></span><span class="token class-name">Method</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span></span><span class="token class-name">Proxy</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span></span><span class="token class-name">UndeclaredThrowableException</span></span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> $<span class="token class-name">Proxy0</span> <span class="token keyword">extends</span> <span class="token class-name">Proxy</span>
    <span class="token keyword">implements</span> <span class="token class-name">DynamicProxyTest<span class="token punctuation">.</span>IHello</span>
<span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">Method</span> m3<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">Method</span> m1<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">Method</span> m0<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">Method</span> m2<span class="token punctuation">;</span>

    <span class="token keyword">public</span> $<span class="token class-name">Proxy0</span><span class="token punctuation">(</span><span class="token class-name">InvocationHandler</span> paramInvocationHandler<span class="token punctuation">)</span>
        <span class="token keyword">throws</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span>paramInvocationHandler<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">sayHello</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">throws</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">try</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>h<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> m3<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RuntimeException</span> localRuntimeException<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> localRuntimeException<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> localThrowable<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">UndeclaredThrowableException</span><span class="token punctuation">(</span>localThrowable<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 此处由于版面原因, 省略 equals(), hashCode(), toString()3个方法的代码</span>
    <span class="token comment">// 这3个方法的内容与 sayHello()非常相似. </span>

    <span class="token keyword">static</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">try</span>
        <span class="token punctuation">{</span>
            m3 <span class="token operator">=</span> <span class="token class-name">Class</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span><span class="token string">&quot;org.fenixsoft.bytecode.DynamicProxyTest$IHello&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token string">&quot;sayHello&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            m1 <span class="token operator">=</span> <span class="token class-name">Class</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span><span class="token string">&quot;java.lang.Object&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token string">&quot;equals&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span> <span class="token class-name">Class</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span><span class="token string">&quot;java.lang.Object&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            m0 <span class="token operator">=</span> <span class="token class-name">Class</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span><span class="token string">&quot;java.lang.Object&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token string">&quot;hashCode&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            m2 <span class="token operator">=</span> <span class="token class-name">Class</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span><span class="token string">&quot;java.lang.Object&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token string">&quot;toString&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">NoSuchMethodException</span> localNoSuchMethodException<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NoSuchMethodError</span><span class="token punctuation">(</span>localNoSuchMethodException<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ClassNotFoundException</span> localClassNotFoundException<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NoClassDefFoundError</span><span class="token punctuation">(</span>localClassNotFoundException<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br></div></div><p>这个代理类的实现代码也很简单, <strong>它为传入接口中的每一个方法, 以及从 java.lang.Object 中继承来的 equals(), hashCode(), toString() 方法都生成了对应的实现, 并且统一调用了 InvocationHandler 对象的 invoke() 方法(代码中的 &quot;this.h&quot; 就是父类 Proxy 中保存的 InvocationHandler 实例变量)来实现这些方法的内容</strong>, 各个方法的区别不过是传入的参数和 Method 对象有所不同而已, 所以无论调用动态代理的哪一个方法, 实际上都是在执行 <strong>InvocationHandler::invoke()</strong>  中的代理逻辑.</p> <p>这个例子中并没有讲到 generateProxyClass() 方法具体是如何产生代理类 &quot;<code>$Proxy0.class</code>​&quot; 的字节码的, 大致的生成过程其实就是<strong>根据 Class 文件的格式规范去拼装字节码</strong>, 但是在实际开发中, 以字节为单位直接拼装出字节码的应用场合很少见, 这种生成方式也只能产生一些<strong>高度模板化</strong>的代码. 对于用户的程序代码来说, 如果有要大量操作字节码的需求, 还是使用封装好的字节码类库比较合适. 如果读者对动态代理的字节码拼装过程确实很感兴趣, 可以在 OpenJDK 的 <code>java.base\share\classes\java\lang\reflect</code>​ 目录下找到 sun.misc.ProxyGenerator 的源码.</p> <h5 id="_4-backport工具-java的时光机器"><a href="#_4-backport工具-java的时光机器" class="header-anchor">#</a> 4.Backport工具:Java的时光机器</h5> <p>在 Java 世界里, 每一次 JDK 大版本的发布, 都会伴随着规模不等或大或小的技术革新, 而对 Java 程序编写习惯改变最大的, 肯定是那些对 Java 语法做出重大改变的版本, 譬如 JDK 5 时加入的自动装箱, 泛型, 动态注解, 枚举, 变长参数, 遍历循环(foreach 循环); 譬如 JDK 8 时加入的 Lambda 表达式, Stream API, 接口默认方法等. 事实上在没有这些语法特性的年代, Java 程序也照样能写, 但是现在回头看来, 上述每一种语法的改进几乎都是 &quot;必不可少&quot; 的, 如同用惯了 32 寸液晶, 4K 分辨率显示器的程序员, 就很难再在 19 寸显示器, 1080P 分辨率的显示器上编写代码了. 但假如公司 &quot;不幸&quot; 因为要保护现有投资, 维持程序结构稳定等, 必须使用 JDK 5 或者 JDK 8 以前的版本呢? 幸好, 我们没有办法把 19 寸显示器变成 32 寸的, 但却可以跨越 JDK 版本之间的沟壑, <strong>把高版本 JDK 中编写的代码放到低版本 JDK 环境中去部署使用</strong>. 为了解决这个问题, 一种名为 &quot;Java 逆向移植&quot; 的工具(Java Backporting Tools)应运而生, Retrotranslator 和 Retrolambda 是这类工具中的杰出代表.</p> <p>Retrotranslator 的作用是将 JDK 5 编译出来的 Class 文件转变为可以在 JDK 1.4 或 1.3 上部署的版本, 它能很好地支持自动装箱, 泛型, 动态注解, 枚举, 变长参数, 遍历循环, 静态导入这些语法特性, 甚至还可以支持 JDK 5 中新增的集合改进, 并发包及对泛型, 注解等的反射操作. Retrolambda 的作用与 Retrotranslator 是类似的, 目标是将 JDK 8 的 Lambda 表达式和 try-resources 语法转变为可以在 JDK 5, JDK 6, JDK 7 中使用的形式, 同时也对接口默认方法提供了有限度的支持.</p> <p>了解了 Retrotranslator 和 Retrolambda 这种逆向移植工具的作用以后, 相信读者更关心的是它是怎样做到的? 要想知道 Backporting 工具如何在旧版本 JDK 中模拟新版本 JDK 的功能, 首先要搞清楚 <strong>JDK 升级中会提供哪些新的功能</strong>. JDK 的每次升级新增的功能大致可以分为以下五类:</p> <ul><li>(1) 对 Java 类库 API 的代码增强. 譬如 JDK 1.2 时代引入的 java.util.Collections 等一系列集合类, 在 JDK 5 时代引入的 java.util.concurrent 并发包, 在 JDK 7 时引入的 java.lang.invoke 包, 等等.</li> <li>(2) 在前端编译器层面做的改进. 这种改进被称作语法糖, 如自动装箱拆箱, 实际上就是 Javac 编译器在程序中使用到包装对象的地方自动插入了很多 Integer.valueOf(), Float.valueOf() 之类的代码; 变长参数在编译之后就被自动转化成了一个数组来完成参数传递; 泛型的信息则在编译阶段就已经被擦除掉了(但是在元数据中还保留着), 相应的地方被编译器自动插入了类型转换代码.</li> <li>(3) 需要在字节码中进行支持的改动. 如 JDK 7 里面新加入的语法特性---动态语言支持, 就需要在虚拟机中新增一条 invokedynamic 字节码指令来实现相关的调用功能. 不过字节码指令集一直处于相对稳定的状态, 这种要在字节码层面直接进行的改动是比较少见的.</li> <li>(4) 需要在 JDK 整体结构层面进行支持的改进, 典型的如 JDK 9 时引入的 Java 模块化系统, 它就涉及了 JDK 结构, Java 语法, 类加载和连接过程, Java 虚拟机等多个层面.</li> <li>(5) 集中在虚拟机内部的改进. 如 JDK 5 中实现的 JSR-133 规范重新定义的 Java 内存模型(Java Memory Model, JMM), 以及在 JDK 7, JDK 11, JDK 12 中新增的 G1, ZGC 和 Shenandoah 收集器之类的改动, 这种改动对于程序员编写代码基本是透明的, 只会在程序运行时产生影响.</li></ul> <p>上述的 5 类新功能中, 逆向移植工具能比较完美地模拟了前两类, 从第 3 类开始就逐步深入地涉及了直接在虚拟机内部实现的改进了, 这些功能一般要么是逆向移植工具完全无能为力, 要么是不能完整地或者在比较良好的运行效率上完成全部模拟. 想想这也挺合理的, 如果在语法糖和类库层面可以完美解决的问题, Java 虚拟机设计团队也没有必要舍近求远地改动处于 JDK 底层的虚拟机嘛.</p> <p>在能够较好模拟的前两类功能中, 第一类模拟相对更容易实现一些, 如 JDK 5 引入的 java.util.concurrent 包, 实际是由多线程编程的大师 Doug Lea 开发的一套并发包, 在 JDK 5 出现之前就已经存在(那时候名字叫作 dl.util.concurrent, 引入 JDK 时由作者和 JDK 开发团队共同进行了一些改进), 所以要在旧的 JDK 中支持这部分功能, 以独立类库的方式便可实现. Retrotranslator 中就附带了一个名叫 &quot;backport-util-concurrent.jar&quot; 的类库(由另一个名为 &quot;Backport to JSR 166&quot; 的项目所提供)来代替 JDK 5 的并发包.</p> <p>至于第二类 JDK 在编译阶段进行处理的那些改进, Retrotranslator 则是使用 ASM 框架直接对字节码进行处理. 由于组成 Class 文件的字节码指令数量并没有改变, 所以无论是 JDK 1.3, JDK 1.4 还是 JDK 5, 能用字节码表达的语义范围应该是一致的. 当然, 肯定不会是简单地把 Class 的文件版本号从 49.0 改回 48.0 就能解决问题了, 虽然字节码指令的数量没有变化, 但是元数据信息和一些语法支持的内容还是要做相应的修改.</p> <p>以枚举为例, 尽管在 JDK 5 中增加了 enum 关键字, 但是 Class 文件常量池的 CONSTANT_Class_info 类型常量并没有发生任何语义变化, 仍然是代表一个类或接口的符号引用, 没有加入枚举, 也没有增加过 &quot;CONSTANT_Enum_info&quot; 之类的 &quot;枚举符号引用&quot; 常量. 所以使用 enum 关键字定义常量, 尽管从 Java 语法上看起来与使用 class 关键字定义类, 使用 interface 关键字定义接口是同一层次的, 但实际上这是由 Javac 编译器做出来的假象, 从字节码的角度来看, 枚举仅仅是一个继承于 java.lang.Enum, 自动生成了 values() 和 valueOf() 方法的普通 Java 类而已.</p> <p>Retrotranslator 对枚举所做的主要处理就是把枚举类的父类从 &quot;java.lang.Enum&quot; 替换为它运行时类库中包含的 &quot;net.sf.retrotranslator.runtime.java.lang.Enum_&quot;, 然后再在类和字段的访问标志中抹去 ACC_ENUM 标志位. 当然, 这只是处理的总体思路, 具体的实现要比上面说的复杂得多. 可以想象既然两个父类实现都不一样, values() 和 valueOf() 的方法自然需要重写, 常量池需要引入大量新的来自父类的符号引用, 这些都是实现细节. 图 9-3 是一个使用 JDK 5 编译的枚举类与被 Retrotranslator 转换处理后的字节码的对比图.</p> <p><img src="/img/Image00187-20240302133505-x33vfnw.jpg" alt="" title="图9-3 Retrotranslator 处理前后的枚举类字节码对比"></p> <p><strong>用 Retrolambda 模拟 JDK 8 的 Lambda 表达式属于涉及字节码改动的第三类情况</strong>, Java 为支持 Lambda 会用到新的 invokedynamic 字节码指令, 但幸好这并不是必须的, 只是基于效率的考量. 在 JDK 8 之前, Lambda 表达式就已经被其他运行在 Java 虚拟机的编程语言(如 Scala)广泛使用了, 那时候是怎么生成字节码的现在照着做就是, 不使用 invokedynamic, 除了牺牲一点效率外, 可行性方面并没有太大的障碍.</p> <p>Retrolambda 的 Backport 过程实质上就是<strong>生成一组匿名内部类来代替 Lambda</strong>, 里面会做一些优化措施, 譬如采用单例来保证无状态的 Lambda 表达式不会重复创建匿名类的对象. 有一些 Java IDE 工具, 如 IntelliJ IDEA 和 Eclipse 里会包含将此过程反过来使用的功能特性, 在低版本 Java 里把匿名内部类显示成 Lambda 语法的样子, 实际存在磁盘上的源码还是匿名内部类形式的, 只是在 IDE 里可以把它显示为 Lambda 表达式的语法, 让人阅读起来比较简洁而已.</p> <h4 id="实战-自己动手实现远程执行代码功能"><a href="#实战-自己动手实现远程执行代码功能" class="header-anchor">#</a> 实战:自己动手实现远程执行代码功能</h4> <h5 id="_1-目标与思路"><a href="#_1-目标与思路" class="header-anchor">#</a> 1.目标与思路</h5> <p>不知道读者在做程序维护的时候是否遇到过这类情形: 排查问题的过程中, 想查看内存中的一些参数值, 却苦于没有方法把这些值输出到界面或日志中. 又或者定位到某个缓存数据有问题, 由于缺少缓存的统一管理界面, 不得不重启服务才能清理掉这个缓存. 类似的需求有一个共同的特点, 那就是<strong>只要在服务中执行一小段程序代码</strong>, 就可以定位或排除问题, 但就是偏偏找不到可以让服务器执行临时代码的途径, 让人恨不得<strong>在服务器上装个后门</strong>. 这是项目运维中的常见问题, 通常解决类问题有以下几种途径:</p> <ul><li>可以使用 BTrace 这类 JVMTI 工具去动态修改程序中某一部分的运行代码, 类似的 JVMTI 工具还有阿里巴巴的 <strong>Arthas</strong> 等.</li> <li>使用 JDK 6 之后提供了 Compiler API, 可以动态地编译 Java 程序, 这样虽然达不到动态语言的灵活度, 但让服务器执行临时代码的需求是可以得到解决的.</li> <li>也可以通过 &quot;曲线救国&quot; 的方式来做到, 譬如写一个 JSP 文件上传到服务器, 然后在浏览器中运行它, 或者在服务端程序中加入一个 BeanShell Script, JavaScript 等的执行引擎(如 Mozilla Rhino)去执行动态脚本.</li> <li>在应用程序中内置动态执行的功能.</li></ul> <p>在本章的实战部分, 将使用前面学到的关于<mark><strong>类加载及虚拟机执行子系统的知识去完成在服务端执行临时代码的功能</strong></mark>.</p> <blockquote><p>目标</p></blockquote> <p>首先, 在实现 &quot;在服务端执行临时代码&quot; 这个需求之前, 先来明确一下本次实战的具体目标, 我们希望最终的产品是这样的:</p> <ul><li>不改变原有服务端程序的部署, 不依赖任何第三方类库.</li> <li><strong>不侵入原有程序, 即无须改动原程序的任何代码. 也不会对原有程序的运行带来任何影响</strong>.</li> <li>考虑到 BeanShell Script 或 JavaScript 等脚本与 Java 对象交互起来不太方便, &quot;临时代码&quot; 应该<strong>直接支持 Java 语言</strong>.</li> <li>&quot;临时代码&quot; 应当具备足够的自由度, <strong>不需要依赖特定的类或实现特定的接口</strong>. 这里写的是 &quot;不需要&quot; 而不是 &quot;不可以&quot;, 当 &quot;临时代码&quot; 需要引用其他类库时也没有限制, 只要服务端程序能使用的类型和接口, 临时代码都应当能直接引用.</li> <li><strong>&quot;临时代码&quot; 的执行结果能返回到客户端</strong>, 执行结果可以包括程序中输出的信息及抛出的异常等.</li></ul> <p>看完上面列出的目标, 读者觉得完成这个需求需要做多少工作量呢? 也许答案比大多数人所想的都要简单一些: 5 个类, 250 行代码(含注释), 大约一个半小时左右的开发时间就可以了, 现在就开始编写程序吧!</p> <blockquote><p>思路</p></blockquote> <p>在程序实现的过程中, 需要解决以下 3 个问题:</p> <ul><li><strong>如何编译提交到服务器的 Java 代码</strong>?</li> <li><strong>如何执行编译之后的 Java 代码</strong>?</li> <li><strong>如何收集 Java 代码的执行结果</strong>?</li></ul> <p>对于第一个问题, 有两种方案可以选择. 一种<strong>在服务器上编译</strong>, 在 JDK 6 以后可以使用 Compiler API, 在 JDK 6 以前可以使用 tools.jar 包(在 <code>JAVA_HOME/lib</code>​ 目录下)中的 com.sun.tools.Javac.Main 类来编译 Java 文件, 它们其实和直接使用 Javac 命令来编译是一样的. 这种思路的缺点是<strong>引入了额外的依赖</strong>, 而且把程序绑死在特定的 JDK 上了, 要部署到其他公司的 JDK 中还得把 tools.jar 带上(虽然 JRockit 和 J9 虚拟机也有这个 JAR 包, 但它总不是标准所规定必须存在的). 另外一种思路是<mark><strong>直接在客户端编译好, 把字节码而不是 Java 代码传到服务端</strong></mark>, 这听起来好像有点投机取巧, 一般来说确实不应该假定客户端一定具有编译代码的能力, 也不能假定客户端就有编译出产品所需的依赖项. 但是既然程序员会写 Java 代码去给服务端排查问题, 那么很难想象他的机器上会连编译 Java 程序的环境都没有.</p> <p>对于第二个问题: <mark><strong>要执行编译后的 Java 代码, 让类加载器加载这个类生成一个 Class 对象, 然后反射调用一下某个方法就可以了</strong></mark>(因为不实现任何接口, 可以借用一下 Java 中约定俗成的 &quot;main()&quot; 方法). 但还应该考虑得更周全些: 一段程序往往不是编写, 运行一次就能达到效果, 同一个类可能要被<strong>反复地修改, 提交, 执行</strong>. 另外, 提交上去的类<strong>要能访问到服务端的其他类库才行</strong>. 还有就是既然提交的是临时代码, 那提交的 Java 类在<strong>执行完后就应当能被卸载和回收掉</strong>.</p> <p>最后一个问题, 想把程序往<strong>标准输出(System.out)和标准错误输出</strong>(System.err)中打印的信息收集起来. 但标准输出设备是整个虚拟机进程全局共享的资源, 如果使用 <code>System.setOut()/System.setErr()</code>​ 方法把输出流重定向到自己定义的 PrintStream 对象上固然可以收集到输出信息, 但也会对原有程序产生影响: 会把其他线程向标准输出中打印的信息也收集了. 虽然这些并不是不能解决的问题, 不过为了达到完全不影响原程序的目的, 可以采用另外一种办法: <strong>直接在执行的类中把对 System.out 的符号引用替换为我们准备的 PrintStream 的符号引用</strong>, 依赖前面学习到的知识, 做到这一点并不困难.</p> <h5 id="_2-实现与验证"><a href="#_2-实现与验证" class="header-anchor">#</a> 2.实现与验证</h5> <p>在程序实现部分, 主要看看代码和里面的注释. 首先看看实现过程中需要用到的 4 个支持类. 第一个类用于实现 &quot;<strong>同一个类的代码可以被多次加载</strong>&quot; 这个需求, 即用于解决 前面第二个问题的 <strong>HotSwapClassLoader</strong>, 具体程序如代码清单 9-3 所示.</p> <p>HotSwapClassLoader 所做的事情仅仅是公开父类(即 java.lang.ClassLoader)中的 protected 方法 defineClass(), 这里将会使用这个方法把提交执行的 Java 类的 <code>byte[]</code>​ 数组转<strong>变为 Class 对象</strong>. HotSwapClassLoader 中并没有重写 loadClass() 或 findClass() 方法, 因此如果不算外部手工调用 loadByte() 方法的话, 这个类加载器的类查找范围与它的父类加载器是完全一致的, 在被虚拟机调用时, 它会按照双亲委派模型交给父类加载. <mark><strong>构造函数中指定为加载 HotSwapClassLoader 类的类加载器作为父类加载器, 这一步是实现提交的执行代码可以访问服务端引用类库的关键</strong></mark>, 下面来看看代码清单 9-3.</p> <blockquote><p>代码清单9-3 HotSwapClassLoader的实现</p></blockquote> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
 * 为了多次载入执行类而加入的加载器
 * 把 defineClass 方法开放出来, 只有外部显式调用的时候才会使用到 loadByte 方法
 * 由虚拟机调用时, 仍然按照原有的双亲委派规则使用 loadClass 方法进行类加载
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HotSwapClassLoader</span> <span class="token keyword">extends</span> <span class="token class-name">ClassLoader</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token class-name">HotSwapClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token class-name">HotSwapClassLoader</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">Class</span> <span class="token function">loadByte</span><span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> classByte<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">defineClass</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> classByte<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> classByte<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>第二个类是实现将 java.lang.System 替换为自己定义的 <strong>HackSystem</strong> 类的过程, 它直接修改符合 Class 文件格式的 <code>byte[]</code>​ 数组中的常量池部分, 将常量池中指定内容的 CONSTANT_Utf8_info 常量替换为新的字符串, 具体代码如下面的代码清单 9-4 所示. ClassModifier 中涉及对 <code>byte[]</code>​ 数组操作的部分, 主要是将 <code>byte[]</code>​ 与 int 和 String 互相转换, 以及把对 <code>byte[]</code>​ 数据的替换操作封装在代码清单 9-5 所示的 ByteUtils 中.</p> <p>经过 ClassModifier 处理后的 <code>byte[]</code>​ 数组才会传给 <strong>HotSwapClassLoader.loadByte()</strong>  方法进行类加载, <code>byte[]</code>​ 数组在这里替换符号引用之后, 与客户端直接在 Java 代码中引用 HackSystem 类再编译生成的 Class 是完全一样的. 这样的实现既避免了客户端编写临时执行代码时要依赖特定的类(不然无法引入 HackSystem), 又避免了服务端修改标准输出后影响到其他程序的输出. 下面来看看代码清单 9-4 和代码清单 9-5.</p> <blockquote><p>代码清单9-4 ClassModifier的实现</p></blockquote> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
 * 修改 Class 文件, 暂时只提供修改常量池常量的功能
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ClassModifier</span> <span class="token punctuation">{</span>

    <span class="token comment">/**
     * Class 文件中常量池的起始偏移
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">CONSTANT_POOL_COUNT_INDEX</span> <span class="token operator">=</span> <span class="token number">8</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * CONSTANT_Utf8_info 常量的 tag 标志
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token class-name">CONSTANT_Utf8_info</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * 常量池中11种常量所占的长度, CONSTANT_Utf8_info 型常量除外, 因为它不是定长的
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token constant">CONSTANT_ITEM_LENGTH</span> <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">5</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> u1 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> u2 <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> classByte<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">ClassModifier</span><span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> classByte<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>classByte <span class="token operator">=</span> classByte<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 修改常量池中 CONSTANT_Utf8_info 常量的内容
     * @param oldStr 修改前的字符串
     * @param newStr 修改后的字符串
     * @return 修改结果
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">modifyUTF8Constant</span><span class="token punctuation">(</span><span class="token class-name">String</span> oldStr<span class="token punctuation">,</span> <span class="token class-name">String</span> newStr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> cpc <span class="token operator">=</span> <span class="token function">getConstantPoolCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> offset <span class="token operator">=</span> <span class="token constant">CONSTANT_POOL_COUNT_INDEX</span> <span class="token operator">+</span> u2<span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> cpc<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">int</span> tag <span class="token operator">=</span> <span class="token class-name">ByteUtils</span><span class="token punctuation">.</span><span class="token function">bytes2Int</span><span class="token punctuation">(</span>classByte<span class="token punctuation">,</span> offset<span class="token punctuation">,</span> u1<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>tag <span class="token operator">==</span> <span class="token class-name">CONSTANT_Utf8_info</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">int</span> len <span class="token operator">=</span> <span class="token class-name">ByteUtils</span><span class="token punctuation">.</span><span class="token function">bytes2Int</span><span class="token punctuation">(</span>classByte<span class="token punctuation">,</span> offset <span class="token operator">+</span> u1<span class="token punctuation">,</span> u2<span class="token punctuation">)</span><span class="token punctuation">;</span>
                offset <span class="token operator">+=</span> <span class="token punctuation">(</span>u1 <span class="token operator">+</span> u2<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">String</span> str <span class="token operator">=</span> <span class="token class-name">ByteUtils</span><span class="token punctuation">.</span><span class="token function">bytes2String</span><span class="token punctuation">(</span>classByte<span class="token punctuation">,</span> offset<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>str<span class="token punctuation">.</span><span class="token function">equalsIgnoreCase</span><span class="token punctuation">(</span>oldStr<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> strBytes <span class="token operator">=</span> <span class="token class-name">ByteUtils</span><span class="token punctuation">.</span><span class="token function">string2Bytes</span><span class="token punctuation">(</span>newStr<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> strLen <span class="token operator">=</span> <span class="token class-name">ByteUtils</span><span class="token punctuation">.</span><span class="token function">int2Bytes</span><span class="token punctuation">(</span>newStr<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> u2<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    classByte <span class="token operator">=</span> <span class="token class-name">ByteUtils</span><span class="token punctuation">.</span><span class="token function">bytesReplace</span><span class="token punctuation">(</span>classByte<span class="token punctuation">,</span> offset <span class="token operator">-</span> u2<span class="token punctuation">,</span> u2<span class="token punctuation">,</span> strLen<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    classByte <span class="token operator">=</span> <span class="token class-name">ByteUtils</span><span class="token punctuation">.</span><span class="token function">bytesReplace</span><span class="token punctuation">(</span>classByte<span class="token punctuation">,</span> offset<span class="token punctuation">,</span> len<span class="token punctuation">,</span> strBytes<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span> classByte<span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    offset <span class="token operator">+=</span> len<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                offset <span class="token operator">+=</span> <span class="token constant">CONSTANT_ITEM_LENGTH</span><span class="token punctuation">[</span>tag<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> classByte<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 获取常量池中常量的数量
     * @return 常量池数量
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getConstantPoolCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">ByteUtils</span><span class="token punctuation">.</span><span class="token function">bytes2Int</span><span class="token punctuation">(</span>classByte<span class="token punctuation">,</span> <span class="token constant">CONSTANT_POOL_COUNT_INDEX</span><span class="token punctuation">,</span> u2<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br></div></div><blockquote><p>代码清单9-5 ByteUtils的实现</p></blockquote> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
 * Bytes 数组处理工具
 * @author
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ByteUtils</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">bytes2Int</span><span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> b<span class="token punctuation">,</span> <span class="token keyword">int</span> start<span class="token punctuation">,</span> <span class="token keyword">int</span> len<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> sum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> end <span class="token operator">=</span> start <span class="token operator">+</span> len<span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> start<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> end<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">int</span> n <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> b<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xff</span><span class="token punctuation">;</span>
            n <span class="token operator">&lt;&lt;=</span> <span class="token punctuation">(</span><span class="token operator">--</span>len<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">8</span><span class="token punctuation">;</span>
            sum <span class="token operator">=</span> n <span class="token operator">+</span> sum<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> sum<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">int2Bytes</span><span class="token punctuation">(</span><span class="token keyword">int</span> value<span class="token punctuation">,</span> <span class="token keyword">int</span> len<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> b <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span>len<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> len<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            b<span class="token punctuation">[</span>len <span class="token operator">-</span> i <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>value <span class="token operator">&gt;&gt;</span> <span class="token number">8</span> <span class="token operator">*</span> i<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xff</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> b<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">bytes2String</span><span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> b<span class="token punctuation">,</span> <span class="token keyword">int</span> start<span class="token punctuation">,</span> <span class="token keyword">int</span> len<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>b<span class="token punctuation">,</span> start<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">string2Bytes</span><span class="token punctuation">(</span><span class="token class-name">String</span> str<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> str<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">bytesReplace</span><span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> originalBytes<span class="token punctuation">,</span> <span class="token keyword">int</span> offset<span class="token punctuation">,</span> <span class="token keyword">int</span> len<span class="token punctuation">,</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> replaceBytes<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> newBytes <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span>originalBytes<span class="token punctuation">.</span>length <span class="token operator">+</span> <span class="token punctuation">(</span>replaceBytes<span class="token punctuation">.</span>length <span class="token operator">-</span> len<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">arraycopy</span><span class="token punctuation">(</span>originalBytes<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> newBytes<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> offset<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">arraycopy</span><span class="token punctuation">(</span>replaceBytes<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> newBytes<span class="token punctuation">,</span> offset<span class="token punctuation">,</span> replaceBytes<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">arraycopy</span><span class="token punctuation">(</span>originalBytes<span class="token punctuation">,</span> offset <span class="token operator">+</span> len<span class="token punctuation">,</span> newBytes<span class="token punctuation">,</span> offset <span class="token operator">+</span> replaceBytes<span class="token punctuation">.</span>length<span class="token punctuation">,</span> originalBytes<span class="token punctuation">.</span>length <span class="token operator">-</span> offset <span class="token operator">-</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> newBytes<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br></div></div><p>最后一个类就是前面提到过的<strong>用来代替 java.lang.System 的 HackSystem</strong>, 这个类中的方法看起来不少, 但其实除了把 out 和 err 两个静态变量改成使用 ByteArrayOutputStream 作为打印目标的同一个 PrintStream 对象, 以及增加了读取, 清理 ByteArrayOutputStream 中内容的 getBufferString() 和 clearBuffer() 方法外, 就再没有其他新鲜的内容了. 其余的方法全部都来自于 System 类的 public 方法, 方法名字, 参数, 返回值都完全一样, 并且实现也是<strong>直接转调了 System 类的对应方法</strong>而已. 保留这些方法的目的, 是为了在 Sytem 被替换成 HackSystem 之后, 保证执行代码中调用的 System 的其余方法仍然可以继续使用, HackSystem 的实现如代码清单 9-6 所示.</p> <blockquote><p>代码清单9-6 HackSystem的实现</p></blockquote> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
 * 为 Javaclass 劫持 java.lang.System 提供支持
 * 除了 out 和 err 外, 其余的都直接转发给 System 处理
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HackSystem</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token class-name">InputStream</span> in <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span>in<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">ByteArrayOutputStream</span> buffer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ByteArrayOutputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token class-name">PrintStream</span> out <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PrintStream</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token class-name">PrintStream</span> err <span class="token operator">=</span> out<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">getBufferString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> buffer<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">clearBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        buffer<span class="token punctuation">.</span><span class="token function">reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">setSecurityManager</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">SecurityManager</span> s<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">setSecurityManager</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">SecurityManager</span> <span class="token function">getSecurityManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">getSecurityManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">long</span> <span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">arraycopy</span><span class="token punctuation">(</span><span class="token class-name">Object</span> src<span class="token punctuation">,</span> <span class="token keyword">int</span> srcPos<span class="token punctuation">,</span> <span class="token class-name">Object</span> dest<span class="token punctuation">,</span> <span class="token keyword">int</span> destPos<span class="token punctuation">,</span> <span class="token keyword">int</span> length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">arraycopy</span><span class="token punctuation">(</span>src<span class="token punctuation">,</span> srcPos<span class="token punctuation">,</span> dest<span class="token punctuation">,</span> destPos<span class="token punctuation">,</span> length<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">identityHashCode</span><span class="token punctuation">(</span><span class="token class-name">Object</span> x<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">identityHashCode</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 下面所有的方法都与 java.lang.System 的名称一样</span>
    <span class="token comment">// 实现都是字节转调 System 的对应方法</span>
    <span class="token comment">// 因版面原因, 省略了其他方法</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br></div></div><p>4 个支持类已经讲解完毕, 来看看最后一个类 JavaclassExecuter, 它是<strong>提供给外部调用的入口, 调用前面几个支持类组装逻辑, 完成类加载工作</strong>. JavaclassExecuter 只有一个 execute() 方法, 用输入的符合 Class 文件格式的 <code>byte[]</code>​ 数组替换掉 java.lang.System 的符号引用后, <strong>使用 HotSwapClassLoader 加载生成一个 Class 对象, 由于每次执行 execute() 方法都会生成一个新的类加载器实例, 因此同一个类可以实现重复加载</strong>. 然后反射调用这个 Class 对象的 main() 方法, 如果期间出现任何异常, 将异常信息打印到 HackSystem.out 中, 最后把缓冲区中的信息作为方法的结果来返回. JavaclassExecuter 的实现代码如代码清单 9-7 所示.</p> <blockquote><p>代码清单9-7 JavaclassExecuter的实现</p></blockquote> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
 * Javaclass 执行工具
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">JavaclassExecuter</span> <span class="token punctuation">{</span>

    <span class="token comment">/**
     * 执行外部传过来的代表一个 Java 类的 Byte 数组&lt;br&gt;
     * 将输入类的 byte 数组中代表 java.lang.System 的 CONSTANT_Utf8_info 常量修改为劫持后的 HackSystem 类
     * 执行方法为该类的 static main(String[] args)方法, 输出结果为该类向 System.out/err 输出的信息
     * @param classByte 代表一个 Java 类的 Byte 数组
     * @return 执行结果
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> classByte<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">HackSystem</span><span class="token punctuation">.</span><span class="token function">clearBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ClassModifier</span> cm <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ClassModifier</span><span class="token punctuation">(</span>classByte<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> modiBytes <span class="token operator">=</span> cm<span class="token punctuation">.</span><span class="token function">modifyUTF8Constant</span><span class="token punctuation">(</span><span class="token string">&quot;java/lang/System&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;org/fenixsoft/classloading/execute/HackSystem&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 初始化新的类加载器</span>
        <span class="token class-name">HotSwapClassLoader</span> loader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HotSwapClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Class</span> clazz <span class="token operator">=</span> loader<span class="token punctuation">.</span><span class="token function">loadByte</span><span class="token punctuation">(</span>modiBytes<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">// 获取main方法</span>
            <span class="token class-name">Method</span> method <span class="token operator">=</span> clazz<span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token string">&quot;main&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token keyword">class</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            method<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span> <span class="token keyword">null</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token class-name">HackSystem</span><span class="token punctuation">.</span>out<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 返回执行结果</span>
        <span class="token keyword">return</span> <span class="token class-name">HackSystem</span><span class="token punctuation">.</span><span class="token function">getBufferString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br></div></div><p>远程执行功能的编码到此就完成了, 接下来就要检验一下劳动成果. 只是测试的话, 任意写一个 Java 类, 内容无所谓, 只要<strong>向 System.out 输出信息</strong>即可, 取名为 TestClass, 放到服务器 C 盘的根目录中. 然后建立一个 JSP 文件写上如代码清单 9-8 所示的内容, 就可以在浏览器中看到这个类的运行结果了.</p> <blockquote><p>代码清单9-8 测试JSP</p></blockquote> <div class="language-jsp line-numbers-mode"><pre class="language-text"><code>&lt;%@ page import=&quot;java.lang.*&quot; %&gt;
&lt;%@ page import=&quot;java.io.*&quot; %&gt;
&lt;%@ page import=&quot;org.fenixsoft.classloading.execute.*&quot; %&gt;
&lt;%
    InputStream is = new FileInputStream(&quot;c:/TestClass.class&quot;);
    byte[] b = new byte[is.available()];
    is.read(b);
    is.close();

    out.println(&quot;&lt;textarea style='width:1000;height=800'&gt;&quot;);
    out.println(JavaclassExecuter.execute(b));
    out.println(&quot;&lt;/textarea&gt;&quot;);
%&gt;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>当然, 上面的做法只是用于测试和演示, 实际使用这个 JavaExecuter 执行器的时候, 如果还要手工复制一个 Class 文件到服务器上就完全失去意义了, 总得给它配一个 <strong>Class 文件上传</strong>功能, 这是一件很容易做到的事情.</p> <p>在工作中, 笔者进一步给这个执行器写了一个 &quot;外壳&quot;, 这是一个 <strong>Eclipse 插件</strong>, 可以<strong>把 Java 文件编译后传输到服务器中</strong>, 然后把执行器的返回结果输出到 Eclipse 的 Console 窗口里, 这样就可以在有灵感的时候随时写几行调试代码, 放到测试环境的服务器上立即运行了. 实现虽然简单, 但效果很不错, 对调试问题非常有用, 如图 9-4 所示.</p> <p><img src="/img/Image00188-20240302133505-qeibax0.jpg" alt="" title="图9-4　JavaclassExecuter 的使用"></p> <p>‍</p> <h4 id="本章小结"><a href="#本章小结" class="header-anchor">#</a> 本章小结</h4> <p>第 6 章至第 9 章介绍了 Class 文件格式, 类加载及虚拟机执行引擎这几部分内容, 这些内容是虚拟机中必不可少的组成部分, 了解了虚拟机如何执行程序, 才能更好地理解怎样才能写出优秀的代码.</p> <p>关于虚拟机执行子系统的介绍就到此为止, 通过这 4 章的讲解, 描绘了一个虚拟机应该是怎样运行 Class 文件的概念模型的, 对于具体到某个虚拟机的实现, 为了使实现简单清晰, 或者为了更快的运行速度, 在虚拟机内部的运作与概念模型可能会有非常大的差异, 但从最终的执行结果来看应该是一致的. 从第 10 章开始, 将把目光从概念模型转到具体实现, 去探索虚拟机在语法上和运行性能上, 是如何对程序编写做出各种优化的.</p> <p>‍</p> <p>‍</p> <p>‍</p> <p>‍</p></div></div>  <div class="page-edit"><div class="edit-link"><a href="https://github.com/xugaoyi/vuepress-theme-vdoing/edit/main/docs/20.开发/2000.Java/600.JVM/33.类加载及执行子系统的案例与实战🌼.md" target="_blank" rel="noopener noreferrer">编辑</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <!----> <!----></div> <div class="page-nav-wapper"><div class="page-nav-centre-wrap"><a href="/pages/6367b0/" class="page-nav-centre page-nav-centre-prev"><div class="tooltip">虚拟机字节码执行引擎🌼</div></a> <a href="/pages/deb8b7/" class="page-nav-centre page-nav-centre-next"><div class="tooltip">前端编译与优化🌼</div></a></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/pages/6367b0/" class="prev">虚拟机字节码执行引擎🌼</a></span> <span class="next"><a href="/pages/deb8b7/">前端编译与优化🌼</a>→
      </span></p></div></div></div> <!----></main></div> <div class="footer"><div class="icons"><a href="mailto:1174520425@qq.com" title="发邮件" target="_blank" class="iconfont icon-youjian"></a><a href="https://github.com/nanodaemony" title="GitHub" target="_blank" class="iconfont icon-github"></a></div> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="本站主题">Vdoing</a> 
    | Copyright © 2019-2025
    <span>达尔文的猹 | MIT License</span></div> <div class="buttons"><div title="返回顶部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去评论" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主题模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          跟随系统
        </li><li class="iconfont icon-rijianmoshi">
          浅色模式
        </li><li class="iconfont icon-yejianmoshi">
          深色模式
        </li><li class="iconfont icon-yuedu">
          阅读模式
        </li></ul></div></div> <!----> <!----> <!----></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.3f3e0e10.js" defer></script><script src="/assets/js/2.e9fcb30c.js" defer></script><script src="/assets/js/3.1998f389.js" defer></script><script src="/assets/js/85.7dcc5659.js" defer></script>
  </body>
</html>
