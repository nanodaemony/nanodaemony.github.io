<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Java业务开发常见错误100例(极客时间)🌸 | Pangolin Note</title>
    <meta name="generator" content="VuePress 1.9.5">
    <link rel="icon" href="/img/favicon.ico">
    <meta name="description" content="大道至简">
    <meta name="keywords" content="前端博客,个人技术博客,前端,前端开发,前端框架,web前端,前端面试题,技术文档,学习,面试,JavaScript,js,ES6,TypeScript,vue,python,css3,html5,Node,git,github,markdown">
    <meta name="baidu-site-verification" content="7F55weZDDc">
    <meta name="theme-color" content="#11a8cd">
    
    <link rel="preload" href="/assets/css/0.styles.56073ad3.css" as="style"><link rel="preload" href="/assets/js/app.3f3e0e10.js" as="script"><link rel="preload" href="/assets/js/2.e9fcb30c.js" as="script"><link rel="preload" href="/assets/js/3.1998f389.js" as="script"><link rel="preload" href="/assets/js/141.d703f30b.js" as="script"><link rel="prefetch" href="/assets/js/10.0b55747f.js"><link rel="prefetch" href="/assets/js/100.b8912a99.js"><link rel="prefetch" href="/assets/js/101.a6740c8a.js"><link rel="prefetch" href="/assets/js/102.e31e89b2.js"><link rel="prefetch" href="/assets/js/103.2c5dbdae.js"><link rel="prefetch" href="/assets/js/104.0e9c02f6.js"><link rel="prefetch" href="/assets/js/105.8288396c.js"><link rel="prefetch" href="/assets/js/106.62f43c11.js"><link rel="prefetch" href="/assets/js/107.70c90211.js"><link rel="prefetch" href="/assets/js/108.b488ce56.js"><link rel="prefetch" href="/assets/js/109.12942650.js"><link rel="prefetch" href="/assets/js/11.ac3fd1ca.js"><link rel="prefetch" href="/assets/js/110.1e57ecba.js"><link rel="prefetch" href="/assets/js/111.6e33b4ea.js"><link rel="prefetch" href="/assets/js/112.bd52831b.js"><link rel="prefetch" href="/assets/js/113.868c1ac9.js"><link rel="prefetch" href="/assets/js/114.090549d1.js"><link rel="prefetch" href="/assets/js/115.d97f6c2b.js"><link rel="prefetch" href="/assets/js/116.097c4b4e.js"><link rel="prefetch" href="/assets/js/117.4024cfe2.js"><link rel="prefetch" href="/assets/js/118.e3057cba.js"><link rel="prefetch" href="/assets/js/119.4ef1fa3b.js"><link rel="prefetch" href="/assets/js/12.863eaabe.js"><link rel="prefetch" href="/assets/js/120.78f9df50.js"><link rel="prefetch" href="/assets/js/121.8e16df87.js"><link rel="prefetch" href="/assets/js/122.f21c0107.js"><link rel="prefetch" href="/assets/js/123.ea1cb375.js"><link rel="prefetch" href="/assets/js/124.01c04c6e.js"><link rel="prefetch" href="/assets/js/125.d383e301.js"><link rel="prefetch" href="/assets/js/126.3162cb47.js"><link rel="prefetch" href="/assets/js/127.c6bebae6.js"><link rel="prefetch" href="/assets/js/128.d659db60.js"><link rel="prefetch" href="/assets/js/129.2afdcf48.js"><link rel="prefetch" href="/assets/js/13.4f59ce35.js"><link rel="prefetch" href="/assets/js/130.beb9ed9d.js"><link rel="prefetch" href="/assets/js/131.35b05f8a.js"><link rel="prefetch" href="/assets/js/132.d77f4f93.js"><link rel="prefetch" href="/assets/js/133.4ceda6e5.js"><link rel="prefetch" href="/assets/js/134.11390c5f.js"><link rel="prefetch" href="/assets/js/135.32f9e38f.js"><link rel="prefetch" href="/assets/js/136.6d8bb0f2.js"><link rel="prefetch" href="/assets/js/137.9c0ffeef.js"><link rel="prefetch" href="/assets/js/138.88d86e5f.js"><link rel="prefetch" href="/assets/js/139.8c2c3d6c.js"><link rel="prefetch" href="/assets/js/14.11c82d35.js"><link rel="prefetch" href="/assets/js/140.c5c375d3.js"><link rel="prefetch" href="/assets/js/142.6a005a44.js"><link rel="prefetch" href="/assets/js/143.9b2edf6f.js"><link rel="prefetch" href="/assets/js/144.3fd013c9.js"><link rel="prefetch" href="/assets/js/145.b05079c5.js"><link rel="prefetch" href="/assets/js/146.ed5360a6.js"><link rel="prefetch" href="/assets/js/147.7408d86f.js"><link rel="prefetch" href="/assets/js/148.f390b370.js"><link rel="prefetch" href="/assets/js/149.95017f0a.js"><link rel="prefetch" href="/assets/js/15.bd143bd5.js"><link rel="prefetch" href="/assets/js/150.f0ede764.js"><link rel="prefetch" href="/assets/js/151.b7093623.js"><link rel="prefetch" href="/assets/js/152.a82a6c83.js"><link rel="prefetch" href="/assets/js/153.965e3fb2.js"><link rel="prefetch" href="/assets/js/154.9e49311e.js"><link rel="prefetch" href="/assets/js/155.cef33ba5.js"><link rel="prefetch" href="/assets/js/156.bcc397ae.js"><link rel="prefetch" href="/assets/js/157.90824739.js"><link rel="prefetch" href="/assets/js/158.efd429b9.js"><link rel="prefetch" href="/assets/js/159.122ff5b7.js"><link rel="prefetch" href="/assets/js/16.2449162b.js"><link rel="prefetch" href="/assets/js/160.0b806535.js"><link rel="prefetch" href="/assets/js/161.835052c6.js"><link rel="prefetch" href="/assets/js/162.ca34e2d2.js"><link rel="prefetch" href="/assets/js/163.08000d04.js"><link rel="prefetch" href="/assets/js/164.a1cc0109.js"><link rel="prefetch" href="/assets/js/165.65444686.js"><link rel="prefetch" href="/assets/js/166.7d73c84f.js"><link rel="prefetch" href="/assets/js/167.009d47a3.js"><link rel="prefetch" href="/assets/js/168.0afeae2a.js"><link rel="prefetch" href="/assets/js/169.7654cb31.js"><link rel="prefetch" href="/assets/js/17.eb7f9def.js"><link rel="prefetch" href="/assets/js/170.58569530.js"><link rel="prefetch" href="/assets/js/171.7db9ed40.js"><link rel="prefetch" href="/assets/js/172.3cb50ed4.js"><link rel="prefetch" href="/assets/js/173.0846425f.js"><link rel="prefetch" href="/assets/js/174.9e95f111.js"><link rel="prefetch" href="/assets/js/175.ef2098f2.js"><link rel="prefetch" href="/assets/js/176.c2635fe9.js"><link rel="prefetch" href="/assets/js/177.4fa38e8e.js"><link rel="prefetch" href="/assets/js/178.2be7037f.js"><link rel="prefetch" href="/assets/js/179.bf3bba28.js"><link rel="prefetch" href="/assets/js/18.0455f4d1.js"><link rel="prefetch" href="/assets/js/180.72c5f597.js"><link rel="prefetch" href="/assets/js/181.42287bcc.js"><link rel="prefetch" href="/assets/js/182.6cd4bf1a.js"><link rel="prefetch" href="/assets/js/183.05dbbfd9.js"><link rel="prefetch" href="/assets/js/184.03de7e00.js"><link rel="prefetch" href="/assets/js/185.42dd210e.js"><link rel="prefetch" href="/assets/js/186.28ee0f8a.js"><link rel="prefetch" href="/assets/js/187.bb58697b.js"><link rel="prefetch" href="/assets/js/188.1bc8be96.js"><link rel="prefetch" href="/assets/js/189.fac747e3.js"><link rel="prefetch" href="/assets/js/19.ae9e35d6.js"><link rel="prefetch" href="/assets/js/190.ea533ac7.js"><link rel="prefetch" href="/assets/js/191.6dc6eb13.js"><link rel="prefetch" href="/assets/js/192.184d249f.js"><link rel="prefetch" href="/assets/js/193.4a06bc12.js"><link rel="prefetch" href="/assets/js/194.8cce60a9.js"><link rel="prefetch" href="/assets/js/195.93231a13.js"><link rel="prefetch" href="/assets/js/196.4a596bde.js"><link rel="prefetch" href="/assets/js/197.96c113cf.js"><link rel="prefetch" href="/assets/js/198.73ba3f67.js"><link rel="prefetch" href="/assets/js/199.74bab595.js"><link rel="prefetch" href="/assets/js/20.b542d0e7.js"><link rel="prefetch" href="/assets/js/200.69a6928a.js"><link rel="prefetch" href="/assets/js/201.9ffa7c5a.js"><link rel="prefetch" href="/assets/js/202.41edb652.js"><link rel="prefetch" href="/assets/js/203.7fabcef3.js"><link rel="prefetch" href="/assets/js/204.b0ae2f62.js"><link rel="prefetch" href="/assets/js/205.add8738b.js"><link rel="prefetch" href="/assets/js/206.f3a712ec.js"><link rel="prefetch" href="/assets/js/207.cd7dd729.js"><link rel="prefetch" href="/assets/js/208.78b33afa.js"><link rel="prefetch" href="/assets/js/209.9d3329ff.js"><link rel="prefetch" href="/assets/js/21.5a050318.js"><link rel="prefetch" href="/assets/js/210.d285d5ac.js"><link rel="prefetch" href="/assets/js/211.8791bb3f.js"><link rel="prefetch" href="/assets/js/212.84ed81a8.js"><link rel="prefetch" href="/assets/js/213.7b990580.js"><link rel="prefetch" href="/assets/js/214.da31f20c.js"><link rel="prefetch" href="/assets/js/215.9eeed659.js"><link rel="prefetch" href="/assets/js/216.9539f0ec.js"><link rel="prefetch" href="/assets/js/217.11b575be.js"><link rel="prefetch" href="/assets/js/218.a67f12f1.js"><link rel="prefetch" href="/assets/js/219.bfbb817a.js"><link rel="prefetch" href="/assets/js/22.2bc6f7e3.js"><link rel="prefetch" href="/assets/js/220.8b01342f.js"><link rel="prefetch" href="/assets/js/221.b450decd.js"><link rel="prefetch" href="/assets/js/222.97468507.js"><link rel="prefetch" href="/assets/js/223.b6dafd73.js"><link rel="prefetch" href="/assets/js/224.c86c18c6.js"><link rel="prefetch" href="/assets/js/225.b0dcf86e.js"><link rel="prefetch" href="/assets/js/226.02cc2999.js"><link rel="prefetch" href="/assets/js/227.8474ef5a.js"><link rel="prefetch" href="/assets/js/228.0298e421.js"><link rel="prefetch" href="/assets/js/229.6aeaf595.js"><link rel="prefetch" href="/assets/js/23.9995fce4.js"><link rel="prefetch" href="/assets/js/230.a5785286.js"><link rel="prefetch" href="/assets/js/231.d791daa4.js"><link rel="prefetch" href="/assets/js/232.97aeeb00.js"><link rel="prefetch" href="/assets/js/233.46e51e28.js"><link rel="prefetch" href="/assets/js/234.2cffe82f.js"><link rel="prefetch" href="/assets/js/235.14965da6.js"><link rel="prefetch" href="/assets/js/236.00a5afc0.js"><link rel="prefetch" href="/assets/js/237.3b73d52f.js"><link rel="prefetch" href="/assets/js/238.6e1db765.js"><link rel="prefetch" href="/assets/js/239.75866c5e.js"><link rel="prefetch" href="/assets/js/24.9141eeb2.js"><link rel="prefetch" href="/assets/js/240.af9c2cc9.js"><link rel="prefetch" href="/assets/js/241.388acab2.js"><link rel="prefetch" href="/assets/js/242.c60f2b48.js"><link rel="prefetch" href="/assets/js/243.d8e81b13.js"><link rel="prefetch" href="/assets/js/244.58b0b21d.js"><link rel="prefetch" href="/assets/js/245.c3768497.js"><link rel="prefetch" href="/assets/js/246.ac8bbe7a.js"><link rel="prefetch" href="/assets/js/247.d095f70a.js"><link rel="prefetch" href="/assets/js/248.e9f210b5.js"><link rel="prefetch" href="/assets/js/249.a9fad023.js"><link rel="prefetch" href="/assets/js/25.98e8593e.js"><link rel="prefetch" href="/assets/js/250.ae7f0ebb.js"><link rel="prefetch" href="/assets/js/251.9a617d55.js"><link rel="prefetch" href="/assets/js/252.ce082446.js"><link rel="prefetch" href="/assets/js/253.4575302d.js"><link rel="prefetch" href="/assets/js/254.5899a61b.js"><link rel="prefetch" href="/assets/js/255.66c69f31.js"><link rel="prefetch" href="/assets/js/256.8fd6c706.js"><link rel="prefetch" href="/assets/js/257.31b77e5e.js"><link rel="prefetch" href="/assets/js/258.eba48891.js"><link rel="prefetch" href="/assets/js/259.edf74b59.js"><link rel="prefetch" href="/assets/js/26.e69924ea.js"><link rel="prefetch" href="/assets/js/260.cf2ed36d.js"><link rel="prefetch" href="/assets/js/261.9e7792d8.js"><link rel="prefetch" href="/assets/js/262.e7b9433e.js"><link rel="prefetch" href="/assets/js/263.1185b25c.js"><link rel="prefetch" href="/assets/js/264.5e0f89cb.js"><link rel="prefetch" href="/assets/js/265.a38d3b94.js"><link rel="prefetch" href="/assets/js/266.2ef170b3.js"><link rel="prefetch" href="/assets/js/267.a7d14651.js"><link rel="prefetch" href="/assets/js/268.05b18748.js"><link rel="prefetch" href="/assets/js/269.dad48d6f.js"><link rel="prefetch" href="/assets/js/27.13612515.js"><link rel="prefetch" href="/assets/js/270.4f5a6b8d.js"><link rel="prefetch" href="/assets/js/271.7ebf6682.js"><link rel="prefetch" href="/assets/js/272.7c2fbfd1.js"><link rel="prefetch" href="/assets/js/273.8ee20732.js"><link rel="prefetch" href="/assets/js/274.d525242a.js"><link rel="prefetch" href="/assets/js/275.a8a19acb.js"><link rel="prefetch" href="/assets/js/276.df3a4eb4.js"><link rel="prefetch" href="/assets/js/277.336debda.js"><link rel="prefetch" href="/assets/js/278.c470625f.js"><link rel="prefetch" href="/assets/js/279.a91e1a64.js"><link rel="prefetch" href="/assets/js/28.ab7ae1df.js"><link rel="prefetch" href="/assets/js/280.87e25c9a.js"><link rel="prefetch" href="/assets/js/281.87c1ba25.js"><link rel="prefetch" href="/assets/js/282.dcd4dce0.js"><link rel="prefetch" href="/assets/js/283.abac2e00.js"><link rel="prefetch" href="/assets/js/284.f6079659.js"><link rel="prefetch" href="/assets/js/285.f1b39879.js"><link rel="prefetch" href="/assets/js/286.f6a79242.js"><link rel="prefetch" href="/assets/js/287.06bebe07.js"><link rel="prefetch" href="/assets/js/288.89e325df.js"><link rel="prefetch" href="/assets/js/289.3aa1bedd.js"><link rel="prefetch" href="/assets/js/29.ebe50f76.js"><link rel="prefetch" href="/assets/js/290.ee059c92.js"><link rel="prefetch" href="/assets/js/291.fa9a921a.js"><link rel="prefetch" href="/assets/js/292.2a8811cd.js"><link rel="prefetch" href="/assets/js/293.eec09cdf.js"><link rel="prefetch" href="/assets/js/294.dfac20dc.js"><link rel="prefetch" href="/assets/js/295.825d2070.js"><link rel="prefetch" href="/assets/js/296.f645861e.js"><link rel="prefetch" href="/assets/js/297.424fdb17.js"><link rel="prefetch" href="/assets/js/298.ebf87cdc.js"><link rel="prefetch" href="/assets/js/299.b8f19cbb.js"><link rel="prefetch" href="/assets/js/30.75237511.js"><link rel="prefetch" href="/assets/js/300.10fb6d4f.js"><link rel="prefetch" href="/assets/js/301.ef77c612.js"><link rel="prefetch" href="/assets/js/302.1b839763.js"><link rel="prefetch" href="/assets/js/303.609f7d98.js"><link rel="prefetch" href="/assets/js/304.1d255f19.js"><link rel="prefetch" href="/assets/js/305.b0234f2c.js"><link rel="prefetch" href="/assets/js/306.48677f64.js"><link rel="prefetch" href="/assets/js/307.14390d4b.js"><link rel="prefetch" href="/assets/js/308.fa730b28.js"><link rel="prefetch" href="/assets/js/309.0496b9e0.js"><link rel="prefetch" href="/assets/js/31.cf3f471a.js"><link rel="prefetch" href="/assets/js/310.a31676dc.js"><link rel="prefetch" href="/assets/js/311.ed53adc5.js"><link rel="prefetch" href="/assets/js/312.1b0ff2f1.js"><link rel="prefetch" href="/assets/js/313.bf123f32.js"><link rel="prefetch" href="/assets/js/314.4e6ce06b.js"><link rel="prefetch" href="/assets/js/315.8eb18560.js"><link rel="prefetch" href="/assets/js/32.74fef842.js"><link rel="prefetch" href="/assets/js/33.bc2d190b.js"><link rel="prefetch" href="/assets/js/34.d23438fc.js"><link rel="prefetch" href="/assets/js/35.7675c4d0.js"><link rel="prefetch" href="/assets/js/36.96a4161b.js"><link rel="prefetch" href="/assets/js/37.d1824f2f.js"><link rel="prefetch" href="/assets/js/38.4effff9e.js"><link rel="prefetch" href="/assets/js/39.6509914b.js"><link rel="prefetch" href="/assets/js/4.4d01750f.js"><link rel="prefetch" href="/assets/js/40.1509d08b.js"><link rel="prefetch" href="/assets/js/41.f2c1124f.js"><link rel="prefetch" href="/assets/js/42.e541d077.js"><link rel="prefetch" href="/assets/js/43.369de999.js"><link rel="prefetch" href="/assets/js/44.43959db0.js"><link rel="prefetch" href="/assets/js/45.282fbd31.js"><link rel="prefetch" href="/assets/js/46.1b83cfe9.js"><link rel="prefetch" href="/assets/js/47.c3a88e41.js"><link rel="prefetch" href="/assets/js/48.bc7c0a1b.js"><link rel="prefetch" href="/assets/js/49.92a4e5ba.js"><link rel="prefetch" href="/assets/js/5.c3991e24.js"><link rel="prefetch" href="/assets/js/50.9c488c6c.js"><link rel="prefetch" href="/assets/js/51.546ea632.js"><link rel="prefetch" href="/assets/js/52.0d2ccee1.js"><link rel="prefetch" href="/assets/js/53.6f52b5b1.js"><link rel="prefetch" href="/assets/js/54.c838b295.js"><link rel="prefetch" href="/assets/js/55.13af99ee.js"><link rel="prefetch" href="/assets/js/56.6be6d1ed.js"><link rel="prefetch" href="/assets/js/57.67c98b39.js"><link rel="prefetch" href="/assets/js/58.107e82ec.js"><link rel="prefetch" href="/assets/js/59.b3e5edc7.js"><link rel="prefetch" href="/assets/js/6.36a535f9.js"><link rel="prefetch" href="/assets/js/60.3b0b4ba5.js"><link rel="prefetch" href="/assets/js/61.3df843df.js"><link rel="prefetch" href="/assets/js/62.1213823d.js"><link rel="prefetch" href="/assets/js/63.e8f3f926.js"><link rel="prefetch" href="/assets/js/64.e1219050.js"><link rel="prefetch" href="/assets/js/65.5bf5bb0b.js"><link rel="prefetch" href="/assets/js/66.a2502afb.js"><link rel="prefetch" href="/assets/js/67.690dd59b.js"><link rel="prefetch" href="/assets/js/68.de7b0915.js"><link rel="prefetch" href="/assets/js/69.ac61dd61.js"><link rel="prefetch" href="/assets/js/7.5d254238.js"><link rel="prefetch" href="/assets/js/70.3edd41b1.js"><link rel="prefetch" href="/assets/js/71.d23407e9.js"><link rel="prefetch" href="/assets/js/72.a5bd01bc.js"><link rel="prefetch" href="/assets/js/73.c9f4dd57.js"><link rel="prefetch" href="/assets/js/74.66323fc1.js"><link rel="prefetch" href="/assets/js/75.e1a72e00.js"><link rel="prefetch" href="/assets/js/76.801268b4.js"><link rel="prefetch" href="/assets/js/77.3a5fda67.js"><link rel="prefetch" href="/assets/js/78.54d84cd4.js"><link rel="prefetch" href="/assets/js/79.fa10f4e3.js"><link rel="prefetch" href="/assets/js/8.e060e47d.js"><link rel="prefetch" href="/assets/js/80.d5b24fea.js"><link rel="prefetch" href="/assets/js/81.0e9da714.js"><link rel="prefetch" href="/assets/js/82.e96ff6d7.js"><link rel="prefetch" href="/assets/js/83.771cced1.js"><link rel="prefetch" href="/assets/js/84.220b69e7.js"><link rel="prefetch" href="/assets/js/85.7dcc5659.js"><link rel="prefetch" href="/assets/js/86.44ba2100.js"><link rel="prefetch" href="/assets/js/87.281da75d.js"><link rel="prefetch" href="/assets/js/88.12d88449.js"><link rel="prefetch" href="/assets/js/89.f28c86d3.js"><link rel="prefetch" href="/assets/js/9.8f9fef32.js"><link rel="prefetch" href="/assets/js/90.715cabb2.js"><link rel="prefetch" href="/assets/js/91.6ced7c82.js"><link rel="prefetch" href="/assets/js/92.c05b33ca.js"><link rel="prefetch" href="/assets/js/93.6bf5fb66.js"><link rel="prefetch" href="/assets/js/94.3561200e.js"><link rel="prefetch" href="/assets/js/95.0f2cf716.js"><link rel="prefetch" href="/assets/js/96.ac8487ea.js"><link rel="prefetch" href="/assets/js/97.48042b5a.js"><link rel="prefetch" href="/assets/js/98.441bb7f8.js"><link rel="prefetch" href="/assets/js/99.4b214d92.js">
    <link rel="stylesheet" href="/assets/css/0.styles.56073ad3.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu"><header class="navbar blur"><div title="目录" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/img/magic.png" alt="Pangolin Note" class="logo"> <span class="site-name can-hide">Pangolin Note</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">🏡首页</a></div><div class="nav-item"><a href="/basic/" class="nav-link">基础</a></div><div class="nav-item"><a href="/develop/" class="nav-link">开发</a></div><div class="nav-item"><a href="/middleware/" class="nav-link">系统</a></div><div class="nav-item"><a href="/algorithm/" class="nav-link">算法</a></div><div class="nav-item"><a href="/books/" class="nav-link">🍀读书笔记</a></div><div class="nav-item"><a href="/work/" class="nav-link">工作</a></div><div class="nav-item"><a href="/pangolin/" class="nav-link">🌸达尔文的猹</a></div><div class="nav-item"><a href="/pages/beb6c0bd8a66cea6/" class="nav-link">收藏</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/archives/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">归档</a></li></ul></div></div> <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><div class="blogger"><img src="/img/avatarnew.png"> <div class="blogger-info"><h3>达尔文的猹</h3> <span>大道至简 悟在天成</span></div></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">🏡首页</a></div><div class="nav-item"><a href="/basic/" class="nav-link">基础</a></div><div class="nav-item"><a href="/develop/" class="nav-link">开发</a></div><div class="nav-item"><a href="/middleware/" class="nav-link">系统</a></div><div class="nav-item"><a href="/algorithm/" class="nav-link">算法</a></div><div class="nav-item"><a href="/books/" class="nav-link">🍀读书笔记</a></div><div class="nav-item"><a href="/work/" class="nav-link">工作</a></div><div class="nav-item"><a href="/pangolin/" class="nav-link">🌸达尔文的猹</a></div><div class="nav-item"><a href="/pages/beb6c0bd8a66cea6/" class="nav-link">收藏</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/archives/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">归档</a></li></ul></div></div> <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Java</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading open"><span>基础</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/4f30b9/" class="sidebar-link">Java基础</a></li><li><a href="/pages/795eca/" class="sidebar-link">类与继承</a></li><li><a href="/pages/c69152/" class="sidebar-link">抽象类与接口</a></li><li><a href="/pages/d71abb/" class="sidebar-link">内部类</a></li><li><a href="/pages/f06dca/" class="sidebar-link">枚举类</a></li><li><a href="/pages/259f57/" class="sidebar-link">常用类</a></li><li><a href="/pages/84b03b/" class="sidebar-link">关键字</a></li><li><a href="/pages/31b87b/" class="sidebar-link">注解</a></li><li><a href="/pages/f81c0d/" class="sidebar-link">异常</a></li><li><a href="/pages/ae7746/" class="sidebar-link">泛型</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading"><span>容器类</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/0c88ac/" class="sidebar-link">集合容器类基础</a></li><li><a href="/pages/f805ed/" class="sidebar-link">List与Queue类</a></li><li><a href="/pages/d24b60/" class="sidebar-link">Map与Set类</a></li><li><a href="/pages/54e5d3/" class="sidebar-link">并发容器类</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading"><span>并发</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/67d70f/" class="sidebar-link">多线程基础</a></li><li><a href="/pages/ffc8f7/" class="sidebar-link">Java内置锁</a></li><li><a href="/pages/c43494/" class="sidebar-link">AQS</a></li><li><a href="/pages/eb5b61/" class="sidebar-link">显式锁ReentrantLock</a></li><li><a href="/pages/eb8cbc/" class="sidebar-link">线程协作与JUC组件</a></li><li><a href="/pages/23c79a/" class="sidebar-link">Atomic原子变量与Unsafe类与CAS</a></li><li><a href="/pages/9d6ed4/" class="sidebar-link">线程池与定时任务</a></li><li><a href="/pages/5b787a/" class="sidebar-link">ThreadLocal</a></li><li><a href="/pages/db53d1/" class="sidebar-link">Java并发编程实战(极客时间)🌸</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading"><span>IO</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/b4d461/" class="sidebar-link">文件操作</a></li><li><a href="/pages/1b9d6c/" class="sidebar-link">IO流操作</a></li><li><a href="/pages/076a47/" class="sidebar-link">Java网络IO模型</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading"><span>高级特性</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/d76905/" class="sidebar-link">Lambda表达式</a></li><li><a href="/pages/f7f0e6/" class="sidebar-link">流Stream</a></li><li><a href="/pages/7cc40a/" class="sidebar-link">反射</a></li><li><a href="/pages/945326/" class="sidebar-link">代理</a></li><li><a href="/pages/7fd9b4/" class="sidebar-link">Javaagent</a></li><li><a href="/pages/a3cee0/" class="sidebar-link">Guava</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading"><span>JVM</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/d308f6/" class="sidebar-link">走进JVM🌼</a></li><li><a href="/pages/be0269/" class="sidebar-link">JVM内存区域与对象解析🌼</a></li><li><a href="/pages/48d1be/" class="sidebar-link">垃圾收集器与内存分配策略🌼</a></li><li><a href="/pages/3a4c8a/" class="sidebar-link">JVM性能监控与故障处理工具🌼</a></li><li><a href="/pages/106680/" class="sidebar-link">调优案例分析与实战🌼</a></li><li><a href="/pages/16a914/" class="sidebar-link">类文件结构🌼</a></li><li><a href="/pages/ea287c/" class="sidebar-link">虚拟机类加载机制🌼</a></li><li><a href="/pages/6367b0/" class="sidebar-link">虚拟机字节码执行引擎🌼</a></li><li><a href="/pages/c6c210/" class="sidebar-link">类加载及执行子系统的案例与实战🌼</a></li><li><a href="/pages/deb8b7/" class="sidebar-link">前端编译与优化🌼</a></li><li><a href="/pages/1f8f72/" class="sidebar-link">后端编译与优化🌼</a></li><li><a href="/pages/3d72db/" class="sidebar-link">Java内存模型与线程实现🌼</a></li><li><a href="/pages/ed086e/" class="sidebar-link">线程安全与内置锁优化🌼</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading"><span>其他</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/56b9dd/" class="sidebar-link">Java性能问题定位分析</a></li><li><a href="/pages/939bf8/" class="sidebar-link">杂记</a></li></ul></section></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>开发</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading"><span>软件设计</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/a5f6fe/" class="sidebar-link">设计基础理论</a></li><li><a href="/pages/3b245c/" class="sidebar-link">设计模式之美(极客时间)🌟</a></li><li><a href="/pages/661fa4/" class="sidebar-link">领域驱动设计(DDD)</a></li><li><a href="/pages/856368/" class="sidebar-link">DDD实战课(极客时间)🌸</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading"><span>数据库</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/d3fbd2/" class="sidebar-link">数据库基础</a></li><li><a href="/pages/691fc3/" class="sidebar-link">数据库系统原理</a></li><li><a href="/pages/50f6b7/" class="sidebar-link">MySQL基础必知必会</a></li><li><a href="/pages/fe297e/" class="sidebar-link">MySQL特性</a></li><li><a href="/pages/07bdb6/" class="sidebar-link">MySQL索引🌟</a></li><li><a href="/pages/984715/" class="sidebar-link">MySQL锁🌟</a></li><li><a href="/pages/53b588/" class="sidebar-link">MySQL事务🌟</a></li><li><a href="/pages/becc59/" class="sidebar-link">MySQL高级特性</a></li><li><a href="/pages/056463/" class="sidebar-link">MySQL基础架构与存储引擎🌟</a></li><li><a href="/pages/63b46e/" class="sidebar-link">MySQL架构优化与运维</a></li><li><a href="/pages/9995e5/" class="sidebar-link">MySQL优化</a></li><li><a href="/pages/c1c2f6/" class="sidebar-link">MySQL架构</a></li><li><a href="/pages/8e8e0a/" class="sidebar-link">MySQL设计规范</a></li><li><a href="/pages/0219aa/" class="sidebar-link">MySQL运维</a></li><li><a href="/pages/e288c0/" class="sidebar-link">MySQL中间件</a></li><li><a href="/pages/c6cafa/" class="sidebar-link">MySQL实战45讲(极客时间)🌟</a></li><li><a href="/pages/4a6106/" class="sidebar-link">数据库LeetCode题目</a></li><li><a href="/pages/2827f1/" class="sidebar-link">数据库综合问题</a></li><li><a href="/pages/c616d5/" class="sidebar-link">MongoDB</a></li><li><a href="/pages/075e71/" class="sidebar-link">ClickHouse</a></li><li><a href="/pages/d74f6d/" class="sidebar-link">Doris</a></li><li><a href="/pages/b6bad9/" class="sidebar-link">HBase</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading"><span>Spring</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/bd8eb8/" class="sidebar-link">Spring Boot基础</a></li><li><a href="/pages/d0d797/" class="sidebar-link">Spring Boot应用整合</a></li><li><a href="/pages/314cdc/" class="sidebar-link">Spring MVC基础</a></li><li><a href="/pages/80de47/" class="sidebar-link">Spring AOP基础</a></li><li><a href="/pages/f0d4d6/" class="sidebar-link">Spring事务基础</a></li><li><a href="/pages/db6afe/" class="sidebar-link">Spring IOC源码分析-概览</a></li><li><a href="/pages/672e98/" class="sidebar-link">Spring IOC源码分析-getBean()</a></li><li><a href="/pages/695b90/" class="sidebar-link">Spring IOC源码分析-createBean()</a></li><li><a href="/pages/f89bcf/" class="sidebar-link">Spring AOP源码分析</a></li><li><a href="/pages/3b52f4/" class="sidebar-link">Spring事务源码分析</a></li><li><a href="/pages/186902/" class="sidebar-link">Spring Boot源码分析</a></li><li><a href="/pages/16bd1c/" class="sidebar-link">Spring MVC源码分析</a></li><li><a href="/pages/3d0c1f/" class="sidebar-link">Spring Cloud</a></li><li><a href="/pages/d56156/" class="sidebar-link">Spring编程常见错误50例(极客时间)🌸</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading"><span>MyBatis</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/bb032d/" class="sidebar-link">基础</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading"><span>工具与环境</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/c9cb6e/" class="sidebar-link">Arthas</a></li><li><a href="/pages/3172bb/" class="sidebar-link">Maven</a></li><li><a href="/pages/37f79a/" class="sidebar-link">Git</a></li><li><a href="/pages/db9f99/" class="sidebar-link">环境搭建与部署</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading"><span>测试</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/c725f5/" class="sidebar-link">测试基础</a></li><li><a href="/pages/7893a4/" class="sidebar-link">单元测试</a></li><li><a href="/pages/af9f25/" class="sidebar-link">压力测试</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading open"><span>代码质量</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/ec2b81/" class="sidebar-link">代码整洁之道</a></li><li><a href="/pages/474cdf/" class="sidebar-link">阿里巴巴编程规范</a></li><li><a href="/pages/c47e15/" class="sidebar-link">代码之丑(极客时间)🌸</a></li><li><a href="/pages/4d4606/" aria-current="page" class="active sidebar-link">Java业务开发常见错误100例(极客时间)🌸</a><ul class="sidebar-sub-headers"></ul></li></ul></section></li></ul></section></li></ul> </aside> <div><main class="page"><div class="theme-vdoing-wrapper "><div class="articleInfo-wrap" data-v-06970110><div class="articleInfo" data-v-06970110><ul class="breadcrumbs" data-v-06970110><li data-v-06970110><a href="/" title="首页" class="iconfont icon-home router-link-active" data-v-06970110></a></li> <li data-v-06970110><a href="/develop/#开发" data-v-06970110>开发</a></li><li data-v-06970110><a href="/develop/#开发" data-v-06970110>开发</a></li><li data-v-06970110><a href="/develop/#代码质量" data-v-06970110>代码质量</a></li></ul> <div class="info" data-v-06970110><div title="作者" class="author iconfont icon-touxiang" data-v-06970110><a href="https://github.com/nanodaemony" target="_blank" title="作者" class="beLink" data-v-06970110>NanoDaemony</a></div> <div title="创建时间" class="date iconfont icon-riqi" data-v-06970110><a href="javascript:;" data-v-06970110>2025-02-26</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-title">本文目录</div> <div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABH1JREFUSA3tVl1oHFUUPmdmd2ltklqbpJDiNnXFmgbFktho7YMPNiJSSZM0+CAYSkUELVhM6YuwIPpgoOKDqOBDC0XE2CQoNtQXBUFTTcCi+Wlh1V2TQExsUzcltd3M9Tt3ZjZzZ2fT+OJTL8yeM+eee757fmeJbq//KQL8X3DUSFOcfr7cRsRtxNQMWueeVzOkaITIGqQHNg5y8+jNW9ldM7A6nTpAjuolUikAwq7CE3WcM2RRDz+XGVgN3FptU/aUSlvq9Pa3iZ1+sgAqJyyAFqkipd9dqiwHF3P65YycLWc/6sqGrvoEoIp6DOFaX5h6+dnfjkWprwqsPk0dUGq5vySwDImC10KxFHgGL1SWoc92O3eVht09qdXNH11I2SsTsJYqMWzihqGMi+A+Garf3BAuuLI5oGlULyNfyB/HYNujwktOfRrMr5t77NmevqaUopx0grnKAyvVpmwUDB4x6FPXuGvYLTDwWsejwgtgkYKPqRJg8SV6xaiZ3ZTppGneS4yfH5/66fZSDHv+QZci/+h5c5UHtpy67JUqGppM0sh0Nc1dW6/N1W5Yoqat8/TU/VnadmdeW2PLLSyh0cvxBs3KbqTmwYPpxN4do/mzE8nEpvX/UMu2Wbp74zUAK5q6WkHns7V0eWkdPbPzd3rxkTGybadYySumVzhcaJFbs5UrEkQ/+CK8gF5dnh/6ciIZ73gwQ927L1IitoxKLXYP3SjYdOrHHfTZhRRlFyrorafPk20B3HPD1y2G3qKZME5Jcf3t/HUC13/8tSd++vqFveMUTwAUxSUFI1QekR1+bIze3D9MF2aq6cPvG72CgnldWCFqyRw3lwH8ZMerjTD9ElRO7Gv44wNpC90aASqGfVlz/Rx17srQ57/UU26hkhQqUB7dBR71WmzQhHUnblGmVOEw0jhbV1n9OlXUDCIRGaNV5Jp43N516fN7JmnTHdfp7Hgy0luO4aMhtkLL8Bi3bUWYvzh5Mn1dTxrL6QmGuRhGL/TiTTxRoEdTszSaq9GR0NGA3KdkOz3hqSV3MIDhQ5IVX/Ivx3umBti2es2h4eZby7x8br1rkf7Mo90AqC8aQ3sJeNzqFRu+vSANAQe3PL7l0HGOAdwDCeZYvNKeoZp1Qfs6Aipndh86HmFRi0LAnEO47wsqM6cdfjh3jBPUzhZy7nvlUfFsamED1VQt6aISHVymXZ/B2aCtIG8AI8xfobj2d3en1wWVhOeHELKmLQ1s211s88comkv4UCwWyF787mJdYXtNfhKAXVqnKTq8QZvGAGGOfaTo5pGZ/PwbUCr5+DPr/1J92JNHr9aOl/F3iI5+O1nfybsGxoimvZ3ViWSluDITw3P37mypheDIPY0tw7+O/5ApbkYw+zpfaUVu32Pi98+defdUhEpZkRFq0aqyNh9FuL9hpYbEm6iwi0z2REd09ZmyENEbuhjDWzKvZXTqKYaBIr3tt5kuPtQBZFvEUwHt60vfCNu41XsksH9Ij1BMMz1Y0OOunHNShFIP5868g5zeXmuLwL9T4b6Q2+KejgAAAABJRU5ErkJggg==">Java业务开发常见错误100例(极客时间)🌸<!----></h1>  <div class="theme-vdoing-content content__default"><h1 id="_740-java业务开发常见错误100例-极客时间-🌸"><a href="#_740-java业务开发常见错误100例-极客时间-🌸" class="header-anchor">#</a> 740.Java业务开发常见错误100例(极客时间)🌸</h1> <h3 id="开篇词"><a href="#开篇词" class="header-anchor">#</a> 开篇词</h3> <h4 id="开篇词-业务代码真的会有这么多坑"><a href="#开篇词-业务代码真的会有这么多坑" class="header-anchor">#</a> 开篇词-业务代码真的会有这么多坑?</h4> <p>你好, 我是朱晔, 贝壳金服的资深架构师. 说说我这 15 年的工作经历吧, 以加深彼此的了解. 前 7 年, 我专注于 .NET 领域, 负责业务项目的同时, 也做了很多社区工作. 在 CSDN 做版主期间, 我因为回答了大量有关 .NET 的问题, 并把很多问题的答案总结成了博客, 获得了 3 次微软 MVP 的称号.</p> <p>后来, 我转到了 Java 领域, 也从程序员变为了架构师, 更关注开源项目和互联网架构设计. 在空中网, 我整体负责了百万人在线的大型 MMO 网游《激战》技术平台的架构设计, 期间和团队开发了许多性能和稳定性都不错的 Java 框架; 在饿了么, 我负责过日千万订单量的物流平台的开发管理和架构工作, 遇到了许多只有高并发下才会出现的问题, 积累了大量的架构经验; 现在, 我在贝壳金服的基础架构团队, 负责基础组件, 中间件, 基础服务开发规划, 制定一些流程和规范, 带领团队自研 Java 后端开发框架, 微服务治理平台等, 在落地 Spring Cloud 结合 Kubernetes 容器云平台技术体系的过程中, 摸索出了很多适合公司项目的基础组件和最佳实践.</p> <p>这 15 年来, 我一直没有脱离编码工作, 接触过大大小小的项目不下 400 个, 自己亲身经历的, 见别人踩过的坑不计其数. 我感触很深的一点是, 业务代码中真的有太多的坑: 有些是看似非常简单的知识点反而容易屡次踩坑, 比如 Spring 声明式事务不生效的问题; 而有些坑因为 &quot;潜伏期&quot; 长, 引发的线上事故造成了大量的人力和资金损失. 因此, 我系统梳理了这些案例和坑点, 最终筛选出 100 个案例, 涉及 130 多个坑点, 组成了这个课程.</p> <blockquote><p>意识不到业务代码的坑很危险</p></blockquote> <p>据我观察, 很多开发同学没意识到这些坑, 有以下三种可能:</p> <ol><li><strong>意识不到坑的存在</strong>, 比如所谓的服务器不稳定很可能是代码问题导致的, 很多时候遇到 OOM, 死锁, 超时问题在运维层面通过改配置, 重启, 扩容等手段解决了, 没有反推到开发层面去寻找根本原因.</li> <li><strong>有些问题只会在特定情况下暴露</strong>. 比如, 缓存击穿, 在多线程环境使用非线程安全的类, 只有在多线程或高并发的情况才会暴露问题.</li> <li><strong>有些性能问题不会导致明显的 Bug, 只会让程序运行缓慢, 内存使用增加, 但会在量变到质变的瞬间爆发</strong>.</li></ol> <p>而正是因为没有意识到这些坑和问题, 采用了错误的处理方式, 最后问题一旦爆发, 处理起来就非常棘手, 这是非常可怕的. 下面这些场景有没有感觉似曾相识呢?</p> <p>比如, 我曾听说过有一个订单量很大的项目, 每天总有上千份订单的状态或流程有问题, 需要花费大量的时间来核对数据, 修复订单状态. 开发同学因为每天牵扯太多经历在排查问题上, 根本没时间开发新需求. 技术负责人为此头痛不已, 无奈之下招了专门的技术支持人员. 最后痛定思痛, 才决定开启明细日志彻查这个问题, 结果发现是自调用方法导致事务没生效的坑.</p> <p>再比如, 有个朋友告诉我, 他们的金融项目计算利息的代码中, 使用了 float 类型而不是 BigDecimal 类来保存和计算金额, 导致给用户结算的每一笔利息都多了几分钱. 好在, 日终对账及时发现了问题. 试想一下, 结算的有上千个用户, 每个用户有上千笔小订单, 如果等月终对账的时候再发现, 可能已经损失了几百万.</p> <p>再比如, 我们使用 RabbitMQ 做异步处理, 业务处理失败的消息会循环不断地进入 MQ. 问题爆发之前, 可能只影响了消息处理的时效性. 但等 MQ 彻底瘫痪时, 面对 MQ 中堆积的, 混杂了死信和正常消息的几百万条数据, 你除了清空又能怎么办. 但清空 MQ, 就意味着要花费几小时甚至几十小时的时间, 来补正常的业务数据, 对业务影响时间很长.</p> <p>像这样由一个小坑引发的重大事故, 不仅仅会给公司造成损失, 还会因为自责影响工作状态, 降低编码的自信心. 我就曾遇到过一位比较负责的核心开发同学, 因为一个 Bug 给公司带来数万元的经济损失, 最后心理上承受不住提出了辞职.</p> <p>其实, 很多时候不是我们不想从根本上解决问题, <strong>只是不知道问题到底在了哪里</strong>. 要避开这些坑, 找到这些定时炸弹, 第一步就是得知道<strong>它们是什么, 在哪里, 为什么会出现</strong>. 而讲清楚这些坑点和相关的最佳实践, 正是本课程的主要内容.</p> <blockquote><p>这个课程是什么?</p></blockquote> <p>接下来就详细说说这个课程是什么, 以及有什么特点.</p> <p><strong>第一个关键词是 &quot;Java&quot;</strong> , 指的是课程内所有 Demo 都是基于 Java 语言的.</p> <p>如果你熟悉 Java, 那可以 100% 体会到这些坑点, 也可以直接用这些 Demo 去检查你的业务代码是否也有类似的错误实现. 要说明的是, 这个课程是围绕坑点而不是 Java 语言体系展开的, 因此不是系统学习 Java 的教材.</p> <p><strong>第二个关键词是 &quot;业务开发&quot;, 也就是说课程内容限定在业务项目的开发, 侧重业务项目开发时可能遇到的坑.</strong></p> <p>先看 &quot;业务&quot; 这个词. 做业务开发时间长的同学尤其知道, 业务项目有两大特点:</p> <ol><li>工期紧, 逻辑复杂, 开发人员会更多地考虑主流程逻辑的正确实现, 忽略非主流程逻辑, 或保障, 补偿, 一致性逻辑的实现;</li> <li>往往缺乏详细的设计, 监控和容量规划的闭环, 结果就是随着业务发展出现各种各样的事故.</li></ol> <p>根据这些性质, 我总结出了近 30 个方面的内容, 力求覆盖业务项目开发的关键问题. 案例的全面性, 是本课程的第二大特点. 这些案例可以看作是 Java 业务代码的避坑大全, 帮助你写出更好的代码, 也能帮你进一步补全知识网增加面试的信心. 你甚至<strong>可以把二级目录当作代码审核的 Checklist, 帮助业务项目一起成长和避坑</strong>.</p> <p>再看 &quot;开发&quot; 这个词. 为了更聚焦, 也更有针对性, 我把专栏内容限定在业务开发, 不会过多地讨论架构, 测试, 部署运维等阶段的问题. 而 &quot;设计篇&quot;, 重在讲述架构设计上可能会遇到的坑, 不会全面, 完整地介绍高可用, 高并发, 可伸缩性等架构因素.</p> <p><strong>第三个关键词是 &quot;避坑 100 例&quot;. 坑就是容易犯的错, 避坑就是踩坑后分析根因, 避免重复踩同样的坑.</strong></p> <p>整个课程 30 篇文章, 涉及 100 个案例, 约 130 个小坑, 其中 40% 来自于我经历过或者是见过的 200 多个线上生产事故, 剩下的 60% 来自于我开发业务项目, 以及日常审核别人的代码发现的问题. 贴近实际, 而不是讲述过时的或日常开发根本用不到的技术或框架, 就是本课程的第三大特点了.</p> <p>大部分案例会配合一个可执行的 Demo 来演示, Demo 中不仅有错误实现(踩坑), 还有修正后的正确实现(避坑). 完整且连续, 授人以渔, 是本课程的第四大特点.</p> <ol><li>完整且连续, 知其所以然. 会按照 &quot;知识介绍 -&gt; 还原业务场景 -&gt; 错误实现 -&gt; 正确实现 -&gt; 原理分析 -&gt; 小总结&quot; 来讲解每个案例, 针对每个坑点至少会给出一个解决方案, 并会挑选核心的点来剖析源码. 这样一来, 不仅能避坑, 更能知道产生坑的根本原因, 提升自己的技术能力.</li> <li>授人以渔. 在遇到问题的时候, 一定是先通过经验和工具来定位分析问题, 然后才能定位到坑, 并不是一开始就知道为什么的. 在这个课程中, 会尽可能地把分析问题的过程完整地呈现给你, 而不是直接告诉你为什么, 这样以后遇到问题时也能有解决问题的思路.</li></ol> <p>这也是为什么, 网络上虽然有很多关于 Java 代码踩坑的资料, 但很多同学却和我反馈说, 看过之后印象不深刻, 也因为没吃透导致在一个知识点上重复踩坑. 鉴于此, 还会与你分析我根据多年经验和思考, 梳理出的一些最佳实践.</p> <p><img src="/img/32ccf812c0d2492db4518af77ecffd47-20230731165210-zjtag9f.png" alt=""></p> <p>鉴于这个专栏的内容和特点, 再说说最佳的<strong>学习方式</strong>是什么.</p> <blockquote><p>学习课程的最佳方法</p></blockquote> <p>编程是一门实践科学, 只看不练, 不思考, 效果通常不会太好. 因此建议打开每篇文章后, 能够按照下面的方式深入学习:</p> <ul><li>对于每一个坑点, 实际运行调试一下源码, 使用文中提到的工具和方法重现问题, 眼见为实.</li> <li>对于每一个坑点, 再思考下除了文内的解决方案和思路外, 是否还有其他修正方式.</li> <li>对于坑点根因中涉及的 JDK 或框架源码分析, 可以找到相关类再系统阅读一下源码.</li></ul> <p>理解了课程涉及的所有案例后, 应该就对业务代码大部分容易犯错的点了如指掌了, 不仅仅自己可以写出更高质量的业务代码, 还可以在审核别人代码时发现可能存在的问题, 帮助整个团队成长.</p> <p>当然了, 你从这个课程收获的将不仅是解决案例中那些问题的方法, 还可以提升自己分析定位问题, 阅读源码的能力. 当你再遇到其他诡异的坑时, 也能有清晰的解决思路, 也可以成长为一名救火专家, 帮助大家一起定位, 分析问题.</p> <h3 id="代码篇"><a href="#代码篇" class="header-anchor">#</a> 代码篇</h3> <h4 id="_01-使用了并发工具类库-线程安全就高枕无忧了吗"><a href="#_01-使用了并发工具类库-线程安全就高枕无忧了吗" class="header-anchor">#</a> 01-使用了并发工具类库,线程安全就高枕无忧了吗?</h4> <p>今天要聊聊使用<strong>并发工具类库</strong>相关的话题.</p> <p>在代码审核讨论的时候, 有时会听到有关线程安全和并发工具的一些片面的观点和结论, 比如 &quot;把 HashMap 改为 ConcurrentHashMap, 就可以解决并发问题了呀&quot;, &quot;要不试试无锁的 CopyOnWriteArrayList, 性能更好&quot;. 事实上, 这些说法都<strong>不太准确</strong>.</p> <p>的确, 为了方便开发者进行多线程编程, 现代编程语言会提供各种并发工具类. 但如果没有充分了解它们的使用场景, 解决的问题, 以及最佳实践的话, 盲目使用就可能会导致一些坑, 小则损失性能, 大则无法确保多线程情况下业务逻辑的正确性.</p> <p>需要先说明下, 这里的并发工具类是指用来解决多线程环境下并发问题的工具类库. 一般而言并发工具包括同步器和容器两大类, 业务代码中使用并发容器的情况会多一些, 今天分享的例子也会侧重并发容器.</p> <p>接下来就看看在使用并发工具时, 最常遇到哪些坑, 以及如何解决, 避免这些坑.</p> <h5 id="没有意识到线程重用导致用户信息错乱的bug"><a href="#没有意识到线程重用导致用户信息错乱的bug" class="header-anchor">#</a> 没有意识到线程重用导致用户信息错乱的Bug</h5> <p>之前在生产上遇到一个诡异的问题, 有时获取到的用户信息是别人的. 查看代码后, 发现<strong>使用了 ThreadLocal 来缓存获取到的用户信息</strong>.</p> <p><strong>ThreadLocal 适用于变量在线程间隔离, 而在方法或类间共享的场景</strong>. 如果用户信息的获取比较昂贵(比如从数据库查询用户信息), 那么在 ThreadLocal 中缓存数据是比较合适的做法. 但这么做为什么会出现用户信息错乱的 Bug 呢?</p> <p>看一个具体的案例.</p> <p>使用 Spring Boot 创建一个 Web 应用程序, 使用 ThreadLocal 存放一个 Integer 的值, 来暂且代表需要在线程中保存的用户信息, 这个值初始是 null. 在业务逻辑中, 先从 ThreadLocal 获取一次值, 然后把外部传入的参数设置到 ThreadLocal 中, <strong>来模拟从当前上下文获取到用户信息的逻辑, 随后再获取一次值</strong>, 最后输出两次获得的值和线程名称.</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> currentUser <span class="token operator">=</span> <span class="token class-name">ThreadLocal</span><span class="token punctuation">.</span><span class="token function">withInitial</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;wrong&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">Map</span> <span class="token function">wrong</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;userId&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Integer</span> userId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 设置用户信息之前先查询一次ThreadLocal中的用户信息</span>
    <span class="token class-name">String</span> before  <span class="token operator">=</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;:&quot;</span> <span class="token operator">+</span> currentUser<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 设置用户信息到ThreadLocal</span>
    currentUser<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 设置用户信息之后再查询一次ThreadLocal中的用户信息</span>
    <span class="token class-name">String</span> after  <span class="token operator">=</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;:&quot;</span> <span class="token operator">+</span> currentUser<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 汇总输出两次查询结果</span>
    <span class="token class-name">Map</span> result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    result<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;before&quot;</span><span class="token punctuation">,</span> before<span class="token punctuation">)</span><span class="token punctuation">;</span>
    result<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;after&quot;</span><span class="token punctuation">,</span> after<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>按理说, 在设置用户信息之前第一次获取的值始终应该是 null, 但要意识到, 程序运行在 Tomcat 中, <strong>执行程序的线程是 Tomcat 的工作线程, 而 Tomcat 的工作线程是基于线程池的</strong>.</p> <p><strong>顾名思义,</strong> <mark><strong>线程池会重用固定的几个线程, 一旦线程重用, 那么很可能首次从 ThreadLocal 获取的值是之前其他用户的请求遗留的值. 这时 ThreadLocal 中的用户信息就是其他用户的信息</strong></mark>​ <strong>.</strong></p> <p>为了更快地重现这个问题, 在配置文件中设置一下 Tomcat 的参数, 把工作线程池最大线程数设置为 1, 这样始终是<strong>同一个线程</strong>在处理请求:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>server<span class="token punctuation">.</span>tomcat<span class="token punctuation">.</span>max<span class="token operator">-</span>threads<span class="token operator">=</span><span class="token number">1</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>运行程序后先让用户 1 来请求接口, 可以看到第一和第二次获取到用户 ID 分别是 null 和 1, 符合预期:</p> <p><img src="/img/aef032266a32ccf114bcddbabbc6d626-20230731165210-8d6uju0.png" alt=""></p> <p>随后用户 2 来请求接口, 这次就出现了 Bug, 第一和第二次获取到用户 ID 分别是 1 和 2, 显然第一次获取到了用户 1 的信息, <strong>原因就是 Tomcat 的线程池重用了线程</strong>. 从图中可以看到, 两次请求的线程都是同一个线程: http-nio-8080-exec-1.</p> <p><img src="/img/dadbabf54b914b4eaf89cef4d3605f9b-20230731165210-9ackvsu.png" alt=""></p> <p>这个例子告诉我们, 在写业务代码时, 首先要理解<strong>代码会跑在什么线程</strong>上:</p> <ol><li>大家可能会抱怨学多线程没用, 因为代码里没有开启使用多线程. 但其实可能只是没有意识到, 在 Tomcat 这种 Web 服务器下跑的业务代码, 本来就运行在一个多线程环境(否则接口也不可能支持这么高的并发), <strong>并不能认为没有显式开启多线程就不会有线程安全问题</strong>.</li> <li>因为线程的创建比较昂贵, 所以 Web 服务器往往会使用线程池来处理请求, 这就意味着<strong>线程会被重用</strong>. 这时, <mark><strong>使用类似 ThreadLocal 工具来存放一些数据时, 需要特别注意在代码运行完后, 显式地去清空设置的数据</strong></mark>. 如果在代码中使用了自定义的线程池, 也同样会遇到这个问题.</li></ol> <p>理解了这个知识点后, 修正这段代码的方案是, 在代码的 finally 代码块中, <mark><strong>显式清除 ThreadLocal 中的数据</strong></mark>. 这样一来, 新的请求过来即使使用了之前的线程也不会获取到错误的用户信息了. 修正后的代码如下:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;right&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">Map</span> <span class="token function">right</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;userId&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Integer</span> userId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">String</span> before  <span class="token operator">=</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;:&quot;</span> <span class="token operator">+</span> currentUser<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    currentUser<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> after <span class="token operator">=</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;:&quot;</span> <span class="token operator">+</span> currentUser<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Map</span> result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        result<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;before&quot;</span><span class="token punctuation">,</span> before<span class="token punctuation">)</span><span class="token punctuation">;</span>
        result<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;after&quot;</span><span class="token punctuation">,</span> after<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        <span class="token comment">// 在finally代码块中删除ThreadLocal中的数据, 确保数据不串</span>
        currentUser<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>重新运行程序可以验证, 再也不会出现第一次查询用户信息查询到之前用户请求的 Bug:</p> <p><img src="/img/53999aa8e9c639292894a32b6bcb481e-20230731165210-i24ey8p.png" alt=""></p> <p>ThreadLocal 是利用独占资源的方式, 来解决线程安全问题, 那如果确实需要有资源在线程之前共享, 应该怎么办呢? 这时可能就需要用到线程安全的容器了.</p> <h5 id="使用了线程安全的并发工具-并不代表解决了所有线程安全问题"><a href="#使用了线程安全的并发工具-并不代表解决了所有线程安全问题" class="header-anchor">#</a> 使用了线程安全的并发工具,并不代表解决了所有线程安全问题</h5> <p>JDK 1.5 后推出的 ConcurrentHashMap, 是一个高性能的线程安全的哈希表容器. &quot;线程安全&quot; 这四个字特别容易让人误解, 因为 <strong>ConcurrentHashMap 只能保证提供的原子性读写操作是线程安全的.</strong></p> <p>我在相当多的业务代码中看到过这个误区, 比如下面这个场景. 有一个含 900 个元素的 Map, 现在再补充 100 个元素进去, 这个补充操作由 10 个线程并发进行. 开发人员误以为使用了 ConcurrentHashMap 就不会有线程安全问题, 于是不加思索地写出了下面的代码: 在每一个线程的代码逻辑中先通过 size 方法拿到当前元素数量, 计算 ConcurrentHashMap 目前还需要补充多少元素, 并在日志中输出了这个值, 然后通过 putAll 方法把缺少的元素添加进去.</p> <p>为方便观察问题, 下面输出了这个 Map 一开始和最后的元素个数.</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// 线程个数</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token constant">THREAD_COUNT</span> <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
<span class="token comment">// 总元素数量</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token constant">ITEM_COUNT</span> <span class="token operator">=</span> <span class="token number">1000</span><span class="token punctuation">;</span>
<span class="token comment">// 帮助方法, 用来获得一个指定元素数量模拟数据的ConcurrentHashMap</span>
<span class="token keyword">private</span> <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> <span class="token function">getData</span><span class="token punctuation">(</span><span class="token keyword">int</span> count<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token class-name">LongStream</span><span class="token punctuation">.</span><span class="token function">rangeClosed</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> count<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">boxed</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toConcurrentMap</span><span class="token punctuation">(</span>i <span class="token operator">-&gt;</span> <span class="token constant">UUID</span><span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Function</span><span class="token punctuation">.</span><span class="token function">identity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token punctuation">(</span>o1<span class="token punctuation">,</span> o2<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> o1<span class="token punctuation">,</span> <span class="token class-name">ConcurrentHashMap</span><span class="token operator">::</span><span class="token keyword">new</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;wrong&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">wrong</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
    <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> concurrentHashMap <span class="token operator">=</span> <span class="token function">getData</span><span class="token punctuation">(</span><span class="token constant">ITEM_COUNT</span> <span class="token operator">-</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 初始900个元素</span>
    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;init size:{}&quot;</span><span class="token punctuation">,</span> concurrentHashMap<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">ForkJoinPool</span> forkJoinPool <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ForkJoinPool</span><span class="token punctuation">(</span><span class="token constant">THREAD_COUNT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 使用线程池并发处理逻辑</span>
    forkJoinPool<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token class-name">IntStream</span><span class="token punctuation">.</span><span class="token function">rangeClosed</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">parallel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>i <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">// 查询还需要补充多少个元素</span>
        <span class="token keyword">int</span> gap <span class="token operator">=</span> <span class="token constant">ITEM_COUNT</span> <span class="token operator">-</span> concurrentHashMap<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;gap size:{}&quot;</span><span class="token punctuation">,</span> gap<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 补充元素</span>
        concurrentHashMap<span class="token punctuation">.</span><span class="token function">putAll</span><span class="token punctuation">(</span><span class="token function">getData</span><span class="token punctuation">(</span>gap<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 等待所有任务完成</span>
    forkJoinPool<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    forkJoinPool<span class="token punctuation">.</span><span class="token function">awaitTermination</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">HOURS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 最后元素个数会是1000吗? </span>
    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;finish size:{}&quot;</span><span class="token punctuation">,</span> concurrentHashMap<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token string">&quot;OK&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br></div></div><p>访问接口后程序输出的日志内容如下:</p> <p><img src="/img/21b1dd879808a98682d1f668f462f588-20230731165210-dad5cg4.png" alt=""></p> <p>从日志中可以看到:</p> <ol><li>初始大小 900 符合预期, 还需要填充 100 个元素.</li> <li>worker1 线程查询到当前需要填充的元素为 36, 竟然还不是 100 的倍数.</li> <li>worker13 线程查询到需要填充的元素数是负的, 显然已经过度填充了.</li> <li>最后 HashMap 的总项目数是 1536, 显然不符合填充满 1000 的预期.</li></ol> <p>针对这个场景, 可以举一个形象的例子. ConcurrentHashMap 就像是一个大篮子, 现在这个篮子里有 900 个桔子, 我们期望把这个篮子装满 1000 个桔子, 也就是再装 100 个桔子. 有 10 个工人来干这件事儿, 大家先后到岗后会计算还需要补多少个桔子进去, 最后把桔子装入篮子.</p> <p>ConcurrentHashMap 这个篮子本身, <strong>可以确保多个工人在装东西进去时, 不会相互影响干扰, 但无法确保工人 A 看到还需要装 100 个桔子但是还未装的时候, 工人 B 就看不到篮子中的桔子数量</strong>. 更值得注意的是, 往这个篮子装 100 个桔子的操作不是原子性的, 在别人看来可能会有一个瞬间篮子里有 964 个桔子, 还需要补 36 个桔子.</p> <p>回到 ConcurrentHashMap, 需要注意 <strong>ConcurrentHashMap 对外提供的方法或能力的限制</strong>:</p> <ol><li>使用了 ConcurrentHashMap, 不代表对它的多个操作之间的状态是一致的, 是没有其他线程在操作它的, 如果需要确保需要手动加锁.</li> <li><strong>诸如 size, isEmpty 和 containsValue 等聚合方法, 在并发情况下可能会反映 ConcurrentHashMap 的中间状态</strong>. 因此在并发情况下, 这些方法的返回值只能用作参考, 而不能用于流程控制. 显然, 利用 size 方法计算差异值, 是一个流程控制.</li> <li>诸如 putAll 这样的聚合方法也不能确保原子性, 在 putAll 的过程中去获取数据可能会获取到部分数据.</li></ol> <p>代码的修改方案很简单, 整段逻辑加锁即可:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;right&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">right</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
    <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> concurrentHashMap <span class="token operator">=</span> <span class="token function">getData</span><span class="token punctuation">(</span><span class="token constant">ITEM_COUNT</span> <span class="token operator">-</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;init size:{}&quot;</span><span class="token punctuation">,</span> concurrentHashMap<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">ForkJoinPool</span> forkJoinPool <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ForkJoinPool</span><span class="token punctuation">(</span><span class="token constant">THREAD_COUNT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    forkJoinPool<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token class-name">IntStream</span><span class="token punctuation">.</span><span class="token function">rangeClosed</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">parallel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>i <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">// 下面的这段复合逻辑需要锁一下这个ConcurrentHashMap</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>concurrentHashMap<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">int</span> gap <span class="token operator">=</span> <span class="token constant">ITEM_COUNT</span> <span class="token operator">-</span> concurrentHashMap<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;gap size:{}&quot;</span><span class="token punctuation">,</span> gap<span class="token punctuation">)</span><span class="token punctuation">;</span>
            concurrentHashMap<span class="token punctuation">.</span><span class="token function">putAll</span><span class="token punctuation">(</span><span class="token function">getData</span><span class="token punctuation">(</span>gap<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    forkJoinPool<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    forkJoinPool<span class="token punctuation">.</span><span class="token function">awaitTermination</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">HOURS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;finish size:{}&quot;</span><span class="token punctuation">,</span> concurrentHashMap<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token string">&quot;OK&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>重新调用接口, 程序的日志输出结果符合预期:</p> <p><img src="/img/b948ef9fe90b95e783a83baef7f3bcae-20230731165210-nynrp8s.png" alt=""></p> <p>可以看到, <strong>只有一个线程查询到了需要补 100 个元素, 其他 9 个线程查询到不需要补元素</strong>, 最后 Map 大小为 1000.</p> <p>到了这里, 你可能又要问了, 使用 ConcurrentHashMap 全程加锁, 还不如使用普通的 HashMap 呢.</p> <p>其实不完全是这样. ConcurrentHashMap 提供了一些原子性的简单复合逻辑方法, 用好这些方法就可以发挥其威力. 这就引申出代码中常见的另一个问题: <strong>在使用一些类库提供的高级工具类时, 开发人员可能还是按照旧的方式去使用这些新类, 因为没有使用其特性, 所以无法发挥其威力</strong>.</p> <h5 id="没有充分了解并发工具的特性-从而无法发挥其威力"><a href="#没有充分了解并发工具的特性-从而无法发挥其威力" class="header-anchor">#</a> 没有充分了解并发工具的特性,从而无法发挥其威力</h5> <p>来看一个使用 Map 来统计 Key 出现次数的场景, 这个逻辑在业务代码中非常常见.</p> <ol><li>使用 ConcurrentHashMap 来统计, Key 的范围是 10.</li> <li>使用最多 10 个并发, 循环操作 1000 万次, 每次操作<strong>累加随机的 Key</strong>.</li> <li>如果 Key 不存在的话, 首次设置值为 1.</li></ol> <p>代码如下:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// 循环次数</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token constant">LOOP_COUNT</span> <span class="token operator">=</span> <span class="token number">10000000</span><span class="token punctuation">;</span>
<span class="token comment">// 线程数量</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token constant">THREAD_COUNT</span> <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
<span class="token comment">// 元素数量</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token constant">ITEM_COUNT</span> <span class="token operator">=</span> <span class="token number">1000</span><span class="token punctuation">;</span>
<span class="token keyword">private</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> <span class="token function">normaluse</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
    <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> freqs <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token constant">ITEM_COUNT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">ForkJoinPool</span> forkJoinPool <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ForkJoinPool</span><span class="token punctuation">(</span><span class="token constant">THREAD_COUNT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    forkJoinPool<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token class-name">IntStream</span><span class="token punctuation">.</span><span class="token function">rangeClosed</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token constant">LOOP_COUNT</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">parallel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>i <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">// 获得一个随机的Key</span>
        <span class="token class-name">String</span> key <span class="token operator">=</span> <span class="token string">&quot;item&quot;</span> <span class="token operator">+</span> <span class="token class-name">ThreadLocalRandom</span><span class="token punctuation">.</span><span class="token function">current</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span><span class="token constant">ITEM_COUNT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>freqs<span class="token punctuation">)</span> <span class="token punctuation">{</span>  
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>freqs<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment">// Key存在则+1</span>
                        freqs<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> freqs<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                        <span class="token comment">// Key不存在则初始化为1</span>
                        freqs<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token number">1L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
    <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    forkJoinPool<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    forkJoinPool<span class="token punctuation">.</span><span class="token function">awaitTermination</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">HOURS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> freqs<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><p>我们吸取之前的教训, 直接通过锁的方式锁住 Map, 然后做判断, 读取现在的累计值, 加 1, 保存累加后值的逻辑. 这段代码在功能上没有问题, 但<strong>无法充分发挥 ConcurrentHashMap 的威力</strong>, 改进后的代码如下:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> <span class="token function">gooduse</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
    <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">LongAdder</span><span class="token punctuation">&gt;</span></span> freqs <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token constant">ITEM_COUNT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">ForkJoinPool</span> forkJoinPool <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ForkJoinPool</span><span class="token punctuation">(</span><span class="token constant">THREAD_COUNT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    forkJoinPool<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token class-name">IntStream</span><span class="token punctuation">.</span><span class="token function">rangeClosed</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token constant">LOOP_COUNT</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">parallel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>i <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> key <span class="token operator">=</span> <span class="token string">&quot;item&quot;</span> <span class="token operator">+</span> <span class="token class-name">ThreadLocalRandom</span><span class="token punctuation">.</span><span class="token function">current</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span><span class="token constant">ITEM_COUNT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 利用computeIfAbsent()方法来实例化LongAdder, 然后利用LongAdder来进行线程安全计数</span>
                freqs<span class="token punctuation">.</span><span class="token function">computeIfAbsent</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> k <span class="token operator">-&gt;</span> <span class="token keyword">new</span> <span class="token class-name">LongAdder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">increment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
    <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    forkJoinPool<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    forkJoinPool<span class="token punctuation">.</span><span class="token function">awaitTermination</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">HOURS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 因为Value是LongAdder而不是Long, 所以需要做一次转换才能返回</span>
    <span class="token keyword">return</span> freqs<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toMap</span><span class="token punctuation">(</span>
                    e <span class="token operator">-&gt;</span> e<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    e <span class="token operator">-&gt;</span> e<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">longValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>在这段改进后的代码中, 巧妙利用了下面两点:</p> <ol><li><strong>使用 ConcurrentHashMap 的原子性方法 computeIfAbsent 来做复合逻辑操</strong>作, 判断 Key 是否存在 Value, 如果不存在则把 Lambda 表达式运行后的结果放入 Map 作为 Value, 也就是新创建一个 LongAdder 对象, 最后返回 Value.</li> <li><strong>由于 computeIfAbsent 方法返回的 Value 是 LongAdder, 是一个线程安全的累加器</strong>, 因此可以直接调用其 increment 方法进行累加.</li></ol> <p>**这样在确保线程安全的情况下达到极致性能, 把之前 7 行代码替换为了 1 行. **</p> <p>下面通过一个简单的测试比较一下修改前后两段代码的性能:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>
<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;good&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">good</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
    <span class="token class-name">StopWatch</span> stopWatch <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StopWatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    stopWatch<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token string">&quot;normaluse&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> normaluse <span class="token operator">=</span> <span class="token function">normaluse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    stopWatch<span class="token punctuation">.</span><span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 校验元素数量</span>
    <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">isTrue</span><span class="token punctuation">(</span>normaluse<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token generics"><span class="token punctuation">&lt;</span>mark<span class="token punctuation">&gt;</span></span> <span class="token constant">ITEM_COUNT</span><span class="token punctuation">,</span> <span class="token string">&quot;normaluse size error&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 校验累计总数  </span>
    <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">isTrue</span><span class="token punctuation">(</span>normaluse<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">mapToLong</span><span class="token punctuation">(</span>item <span class="token operator">-&gt;</span> item<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token operator">::</span><span class="token function">sum</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span><span class="token operator">/</span>mark<span class="token operator">&gt;</span> <span class="token constant">LOOP_COUNT</span>
            <span class="token punctuation">,</span> <span class="token string">&quot;normaluse count error&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    stopWatch<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token string">&quot;gooduse&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> gooduse <span class="token operator">=</span> <span class="token function">gooduse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    stopWatch<span class="token punctuation">.</span><span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">isTrue</span><span class="token punctuation">(</span>gooduse<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token generics"><span class="token punctuation">&lt;</span>mark<span class="token punctuation">&gt;</span></span> <span class="token constant">ITEM_COUNT</span><span class="token punctuation">,</span> <span class="token string">&quot;gooduse size error&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">isTrue</span><span class="token punctuation">(</span>gooduse<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">mapToLong</span><span class="token punctuation">(</span>item <span class="token operator">-&gt;</span> item<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token operator">::</span><span class="token function">sum</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span><span class="token operator">/</span>mark<span class="token operator">&gt;</span> <span class="token constant">LOOP_COUNT</span>
            <span class="token punctuation">,</span> <span class="token string">&quot;gooduse count error&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span>stopWatch<span class="token punctuation">.</span><span class="token function">prettyPrint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token string">&quot;OK&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><p>这段测试代码并无特殊之处, 使用 StopWatch 来测试两段代码的性能, 最后跟了一个断言判断 Map 中元素的个数以及所有 Value 的和, 是否符合预期来校验代码的正确性. 测试结果如下:</p> <p><img src="/img/a416134d2e78579bf36a925f03095e50-20230731165210-qnp56uf.png" alt=""></p> <p>可以看到, <strong>优化后的代码, 相比使用锁来操作 ConcurrentHashMap 的方式, 性能提升了 10 倍</strong>.</p> <p>你可能会问, <strong>computeIfAbsent 为什么如此高效</strong>呢? 答案就在源码最核心的部分, 也就是 Java 自带的 Unsafe 实现的 <strong>CAS</strong>. 它<strong>在虚拟机层面确保了写入数据的原子性, 比加锁的效率高</strong>得多:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">boolean</span> <span class="token function">casTabAt</span><span class="token punctuation">(</span><span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> tab<span class="token punctuation">,</span> <span class="token keyword">int</span> i<span class="token punctuation">,</span> <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> c<span class="token punctuation">,</span> <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> v<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token class-name">U</span><span class="token punctuation">.</span><span class="token function">compareAndSetObject</span><span class="token punctuation">(</span>tab<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span>i <span class="token operator">&lt;&lt;</span> <span class="token constant">ASHIFT</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token constant">ABASE</span><span class="token punctuation">,</span> c<span class="token punctuation">,</span> v<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p><strong>像 ConcurrentHashMap 这样的高级并发工具的确提供了一些高级 API</strong>, 只有充分了解其特性才能最大化其威力, 而不能因为其足够高级, 酷炫盲目使用.</p> <h5 id="没有认清并发工具的使用场景-因而导致性能问题"><a href="#没有认清并发工具的使用场景-因而导致性能问题" class="header-anchor">#</a> 没有认清并发工具的使用场景,因而导致性能问题</h5> <p>除了 ConcurrentHashMap 这样通用的并发工具类之外, 工具包中还有些针对特殊场景实现的生面孔. 一般来说, 针对通用场景的通用解决方案, 在所有场景下性能都还可以, 属于 &quot;万金油&quot;; 而针对特殊场景的特殊实现, 会有比通用解决方案更高的性能, 但一定要在它针对的场景下使用, 否则可能会产生性能问题甚至是 Bug.</p> <p>之前在排查一个生产性能问题时, 我们发现一段简单的非数据库操作的业务逻辑, 消耗了超出预期的时间, 在修改数据时操作本地缓存比回写数据库慢许多. 查看代码发现, 开发同学<strong>使用了 CopyOnWriteArrayList 来缓存大量的数据, 而数据变化又比较频繁</strong>.</p> <p>CopyOnWrite 是一个时髦的技术, 不管是 Linux 还是 Redis 都会用到. **在 Java 中, CopyOnWriteArrayList 虽然是一个线程安全的 ArrayList, 但因为其实现方式是, 每次修改数据时都会复制一份数据出来, 所以有明显的适用场景, 即读多写少或者说希望无锁读的场景. **</p> <p>如果要使用 CopyOnWriteArrayList, 那一定是因为场景需要而不是因为足够酷炫. <strong>如果读写比例均衡或者有大量写操作的话, 使用 CopyOnWriteArrayList 的性能会非常糟糕</strong>.</p> <p>下面写一段测试代码, 来比较下使用 CopyOnWriteArrayList 和普通加锁方式 ArrayList 的读写性能. 在这段代码中针对并发读和并发写分别写了一个测试方法, 测试两者一定次数的写或读操作的耗时.</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// 测试并发写的性能</span>
<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;write&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">Map</span> <span class="token function">testWrite</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> copyOnWriteArrayList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CopyOnWriteArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> synchronizedList <span class="token operator">=</span> <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">synchronizedList</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">StopWatch</span> stopWatch <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StopWatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> loopCount <span class="token operator">=</span> <span class="token number">100000</span><span class="token punctuation">;</span>
    stopWatch<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token string">&quot;Write:copyOnWriteArrayList&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 循环100000次并发往CopyOnWriteArrayList写入随机元素</span>
    <span class="token class-name">IntStream</span><span class="token punctuation">.</span><span class="token function">rangeClosed</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> loopCount<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">parallel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>__ <span class="token operator">-&gt;</span> copyOnWriteArrayList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">ThreadLocalRandom</span><span class="token punctuation">.</span><span class="token function">current</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span>loopCount<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    stopWatch<span class="token punctuation">.</span><span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    stopWatch<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token string">&quot;Write:synchronizedList&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 循环100000次并发往加锁的ArrayList写入随机元素</span>
    <span class="token class-name">IntStream</span><span class="token punctuation">.</span><span class="token function">rangeClosed</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> loopCount<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">parallel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>__ <span class="token operator">-&gt;</span> synchronizedList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">ThreadLocalRandom</span><span class="token punctuation">.</span><span class="token function">current</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span>loopCount<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    stopWatch<span class="token punctuation">.</span><span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span>stopWatch<span class="token punctuation">.</span><span class="token function">prettyPrint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Map</span> result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    result<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;copyOnWriteArrayList&quot;</span><span class="token punctuation">,</span> copyOnWriteArrayList<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    result<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;synchronizedList&quot;</span><span class="token punctuation">,</span> synchronizedList<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// 帮助方法用来填充List</span>
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">addAll</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> list<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    list<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span><span class="token class-name">IntStream</span><span class="token punctuation">.</span><span class="token function">rangeClosed</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1000000</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">boxed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// 测试并发读的性能</span>
<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;read&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">Map</span> <span class="token function">testRead</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 创建两个测试对象</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> copyOnWriteArrayList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CopyOnWriteArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> synchronizedList <span class="token operator">=</span> <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">synchronizedList</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 填充数据   </span>
    <span class="token function">addAll</span><span class="token punctuation">(</span>copyOnWriteArrayList<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">addAll</span><span class="token punctuation">(</span>synchronizedList<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">StopWatch</span> stopWatch <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StopWatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> loopCount <span class="token operator">=</span> <span class="token number">1000000</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> count <span class="token operator">=</span> copyOnWriteArrayList<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    stopWatch<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token string">&quot;Read:copyOnWriteArrayList&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 循环1000000次并发从CopyOnWriteArrayList随机查询元素</span>
    <span class="token class-name">IntStream</span><span class="token punctuation">.</span><span class="token function">rangeClosed</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> loopCount<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">parallel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>__ <span class="token operator">-&gt;</span> copyOnWriteArrayList<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">ThreadLocalRandom</span><span class="token punctuation">.</span><span class="token function">current</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    stopWatch<span class="token punctuation">.</span><span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    stopWatch<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token string">&quot;Read:synchronizedList&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 循环1000000次并发从加锁的ArrayList随机查询元素</span>
    <span class="token class-name">IntStream</span><span class="token punctuation">.</span><span class="token function">range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> loopCount<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">parallel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>__ <span class="token operator">-&gt;</span> synchronizedList<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">ThreadLocalRandom</span><span class="token punctuation">.</span><span class="token function">current</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    stopWatch<span class="token punctuation">.</span><span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span>stopWatch<span class="token punctuation">.</span><span class="token function">prettyPrint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Map</span> result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    result<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;copyOnWriteArrayList&quot;</span><span class="token punctuation">,</span> copyOnWriteArrayList<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    result<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;synchronizedList&quot;</span><span class="token punctuation">,</span> synchronizedList<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br></div></div><p>运行程序可以看到, **大量写的场景(10 万次 add 操作), **<strong>CopyOnWriteArray 几乎比同步的 ArrayList 慢一百倍</strong>:</p> <p><img src="/img/8d03b96135aab5e184f160fabcb6e786-20230731165210-cqyhhkc.png" alt=""></p> <p>而在<strong>大量读的场景下(100 万次 get 操作), CopyOnWriteArray 又比同步的 ArrayList 快五倍</strong>以上:</p> <p><img src="/img/776e00e78aa81e3ac972424781fa67be-20230731165210-br9zwcv.png" alt=""></p> <p>为何在大量写的场景下, CopyOnWriteArrayList 会这么慢呢?</p> <p>答案就在源码中. 以 add 方法为例, 每次 add 时, 都会用 Arrays.copyOf 创建一个新数组, 频繁 add 时内存的申请释放消耗会很大:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
 * Appends the specified element to the end of this list.
 *
 * @param e element to be appended to this list
 * @return {@code true} (as specified by {@link Collection#add})
 */</span>
<span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">E</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>lock<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> elements <span class="token operator">=</span> <span class="token function">getArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> len <span class="token operator">=</span> elements<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
        <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> newElements <span class="token operator">=</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">copyOf</span><span class="token punctuation">(</span>elements<span class="token punctuation">,</span> len <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        newElements<span class="token punctuation">[</span>len<span class="token punctuation">]</span> <span class="token operator">=</span> e<span class="token punctuation">;</span>
        <span class="token function">setArray</span><span class="token punctuation">(</span>newElements<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><h5 id="重点回顾"><a href="#重点回顾" class="header-anchor">#</a> 重点回顾</h5> <p>今天主要分享了, 开发人员<strong>使用并发工具来解决线程安全问题</strong>时容易犯的四类错.</p> <p>一是, 只知道使用并发工具, 但并不清楚当前线程的来龙去脉, 解决多线程问题却不了解线程. 比如, 使用 ThreadLocal 来缓存数据, 以为 ThreadLocal 在线程之间做了隔离不会有线程安全问题, 没想到线程重用导致数据串了. 请务必记得, <strong>在业务逻辑结束之前清理 ThreadLocal 中的数据</strong>.</p> <p>二是, 误以为使用了并发工具就可以解决一切线程安全问题, 期望通过把线程不安全的类替换为线程安全的类来一键解决问题. 比如认为使用了 ConcurrentHashMap 就可以解决线程安全问题, 没对复合逻辑加锁导致业务逻辑错误. 如果你希望在一整段业务逻辑中, 对容器的操作都保持整体一致性的话, 需要加锁处理.</p> <p>三是, 没有充分了解并发工具的特性, 还是按照老方式使用新工具导致无法发挥其性能. 比如使用了 ConcurrentHashMap, 但没有充分利用其提供的基于 CAS 安全的方法, 还是使用锁的方式来实现逻辑. 可以阅读一下 ConcurrentHashMap 的文档, 看一下相关原子性操作 API 是否可以满足业务需求, 如果可以则优先考虑使用.</p> <p>四是, 没有了解清楚工具的适用场景, 在不合适的场景下使用了错误的工具导致性能更差. 比如, 没有理解 CopyOnWriteArrayList 的适用场景, 把它用在了读写均衡或者大量写操作的场景下, 导致性能问题. 对于这种场景, 可以考虑是用普通的 List.</p> <p>其实, 这四类坑之所以容易踩到, 原因可以归结为, 在使用并发工具的时候, 并没有充分理解其可能存在的问题, 适用场景等. 所以最后, <strong>还要分享两点建议</strong>:</p> <ul><li>一定要认真阅读官方文档(比如 Oracle JDK 文档). 充分阅读官方文档, 理解工具的适用场景及其 API 的用法, 并做一些小实验. 了解之后再去使用, 就可以避免大部分坑.</li> <li>如果代码运行在多线程环境下, 那么就会有并发问题, 并发问题不那么容易重现, 可能需要使用压力测试模拟并发场景, 来发现其中的 Bug 或性能问题.</li></ul> <h4 id="_02-代码加锁-不要让-锁-事成为烦心事"><a href="#_02-代码加锁-不要让-锁-事成为烦心事" class="header-anchor">#</a> 02-代码加锁:不要让&quot;锁&quot;事成为烦心事</h4> <p>在上一讲介绍了使用并发容器等工具解决线程安全的误区. 今天来看看解决线程安全问题的另一种重要手段——<strong>锁</strong>, 在使用上比较容易犯哪些错.</p> <p>先分享一个有趣的案例. 一位同学在群里说 &quot;见鬼了, 疑似遇到了一个 JVM 的 Bug&quot;, 我们都很好奇是什么 Bug.</p> <p>于是, 他贴出了这样一段代码: 在一个类里有两个 int 类型的字段 a 和 b, 有一个 add 方法循环 1 万次对 a 和 b 进行 ++ 操作, 有另一个 compare 方法, 同样循环 1 万次判断 a 是否小于 b, 条件成立就打印 a 和 b 的值, 并判断 a &gt; b 是否成立.</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Interesting</span> <span class="token punctuation">{</span>
    <span class="token keyword">volatile</span> <span class="token keyword">int</span> a <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">volatile</span> <span class="token keyword">int</span> b <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;add start&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10000</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            a<span class="token operator">++</span><span class="token punctuation">;</span>
            b<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;add done&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">compare</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;compare start&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10000</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// a始终等于b吗? </span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>a <span class="token operator">&lt;</span> b<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;a:{},b:{},{}&quot;</span><span class="token punctuation">,</span> a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> a <span class="token operator">&gt;</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 最后的 a&gt;b 应该始终是false吗? </span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;compare done&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><p>他起了两个线程来分别执行 add 和 compare 方法:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">Interesting</span> interesting <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Interesting</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> interesting<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> interesting<span class="token punctuation">.</span><span class="token function">compare</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>按道理, a 和 b 同样进行累加操作, 应该始终相等, compare 中的第一次判断应该始终不会成立, 不会输出任何日志. 但执行代码后发现不但输出了日志, 而且更诡异的是, compare 方法在判断 a&lt;b 成立的情况下还输出了 a&gt;b 也成立:</p> <p><img src="/img/7d2c047887dc87c61d62c11212d5bf24-20230731165210-s1fsgp1.png" alt=""></p> <p>群里一位同学看到这个问题笑了, 说: &quot;这哪是 JVM 的 Bug, 分明是<strong>线程安全问题</strong>嘛. 很明显, 你这是在操作两个字段 a 和 b, 有线程安全问题, 应该为 add 方法加上锁, 确保 a 和 b 的 ++ 是原子性的, 就不会错乱了.&quot; 随后, 他为 add 方法加上了锁:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>但加锁后问题并没有解决.</p> <p>来仔细想一下, 为什么锁可以解决线程安全问题呢. 因为只有一个线程可以拿到锁, 所以加锁后的代码中的资源操作是线程安全的. 但<strong>这个案例中的 add 方法始终只有一个线程在操作, 显然只为 add 方法加锁是没用的</strong>.</p> <p>之所以出现这种错乱, 是因为<strong>两个线程是交错执行 add 和 compare 方法中的业务逻辑</strong>, 而且这些业务逻辑不是原子性的: a++ 和 b++ 操作中可以穿插在 compare 方法的比较代码中; 更需要注意的是, a &lt; b 这种比较操作在字节码层面是加载 a, 加载 b 和比较三步, 代码虽然是一行但也不是原子性的.</p> <p>所以, 正确的做法应该是, <strong>为 add 和 compare 都加上方法锁, 确保 add 方法执行时, compare 无法读取 a 和 b</strong>:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">compare</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>所以, 使用锁解决问题之前一定要理清楚, <strong>要保护的是什么逻辑</strong>, 多线程执行的情况又是怎样的.</p> <h5 id="加锁前要清楚锁和被保护的对象是不是一个层面的"><a href="#加锁前要清楚锁和被保护的对象是不是一个层面的" class="header-anchor">#</a> 加锁前要清楚锁和被保护的对象是不是一个层面的</h5> <p>除了没有分析清线程, 业务逻辑和锁三者之间的关系随意添加无效的方法锁外, 还有一种比较常见的错误是, 没有<strong>理清楚锁和要保护的对象是否是一个层面</strong>的.</p> <p><mark><strong>静态字段属于类, 类级别的锁才能保护; 而非静态字段属于类实例, 实例级别的锁就可以保护.</strong></mark></p> <p>先看看这段代码有什么问题: 在类 Data 中定义了一个静态的 int 字段 counter 和一个非静态的 wrong 方法, 实现 counter 字段的累加操作.</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">class</span> <span class="token class-name">Data</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Getter</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">int</span> counter <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        counter <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> counter<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">wrong</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        counter<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>写一段代码测试下:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;wrong&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">wrong</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;count&quot;</span><span class="token punctuation">,</span> defaultValue <span class="token operator">=</span> <span class="token string">&quot;1000000&quot;</span><span class="token punctuation">)</span> <span class="token keyword">int</span> count<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Data</span><span class="token punctuation">.</span><span class="token function">reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 多线程循环一定次数调用Data类不同实例的wrong方法</span>
    <span class="token class-name">IntStream</span><span class="token punctuation">.</span><span class="token function">rangeClosed</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">parallel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>i <span class="token operator">-&gt;</span> <span class="token keyword">new</span> <span class="token class-name">Data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">wrong</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token class-name">Data</span><span class="token punctuation">.</span><span class="token function">getCounter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>因为默认运行 100 万次, 所以执行后应该输出 100 万, 但得到的输出的是 639242.</p> <p>来分析下为什么会出现这个问题.</p> <p><strong>在非静态的 wrong 方法上加锁, 只能确保多个线程无法执行同一个实例的 wrong 方法, 却不能保证不会执行不同实例的 wrong 方法. 而静态的 counter 在多个实例中共享, 所以必然会出现线程安全问题.</strong></p> <p>理清思路后, 修正方法就很清晰了: 同样<strong>在类中定义一个 Object 类型的静态字段</strong>, 在操作 counter 之前对这个字段加锁.</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">class</span> <span class="token class-name">Data</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Getter</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">int</span> counter <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">Object</span> locker <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">right</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>locker<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            counter<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>你可能要问了, 把 wrong 方法定义为静态不就可以了, 这个时候锁是类级别的. 可以是可以, 但我们不可能为了解决线程安全问题改变代码结构, 把实例方法改为静态方法.</p> <p>感兴趣的同学还可以从字节码以及 JVM 的层面继续探索一下, 代码块级别的 synchronized 和方法上标记 synchronized 关键字, 在实现上有什么区别.</p> <h5 id="加锁要考虑锁的粒度和场景问题"><a href="#加锁要考虑锁的粒度和场景问题" class="header-anchor">#</a> 加锁要考虑锁的粒度和场景问题</h5> <p>在方法上加 synchronized 关键字实现加锁确实简单, 也因此我曾看到一些业务代码中几乎所有方法都加了 synchronized, 但这种滥用 synchronized 的做法:</p> <ol><li>一是, 没必要. 通常情况下 60% 的业务代码是三层架构, 数据经过无状态的 Controller, Service, Repository 流转到数据库, 没必要使用 synchronized 来保护什么数据.</li> <li>二是, 可能会<strong>极大地降低性能</strong>. 使用 Spring 框架时, 默认情况下 Controller, Service, Repository 是单例的, 加上 synchronized 会导致整个程序几乎就只能支持单线程, 造成极大的性能问题.</li></ol> <p><mark><strong>即使确实有一些共享资源需要保护, 也要尽可能降低锁的粒度, 仅对必要的代码块甚至是需要保护的资源本身加锁.</strong></mark></p> <p>比如, 在业务代码中, 有一个 ArrayList 因为会被多个线程操作而需要保护, 又有一段比较耗时的操作(代码中的 slow 方法)不涉及线程安全问题, 应该如何加锁呢?</p> <p>错误的做法是, 给整段业务逻辑加锁, 把 slow 方法和操作 ArrayList 的代码同时纳入 synchronized 代码块; 更合适的做法是, <strong>把加锁的粒度降到最低</strong>, 只在操作 ArrayList 的时候给这个 ArrayList 加锁.</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> data <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 不涉及共享资源的慢方法</span>
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">slow</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">MILLISECONDS</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// 错误的加锁方法</span>
<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;wrong&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">wrong</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">long</span> begin <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">IntStream</span><span class="token punctuation">.</span><span class="token function">rangeClosed</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">parallel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>i <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">// 加锁粒度太粗了</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">slow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            data<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;took:{}&quot;</span><span class="token punctuation">,</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> begin<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> data<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// 正确的加锁方法</span>
<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;right&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">right</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">long</span> begin <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">IntStream</span><span class="token punctuation">.</span><span class="token function">rangeClosed</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">parallel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>i <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        <span class="token function">slow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 只对List加锁</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            data<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;took:{}&quot;</span><span class="token punctuation">,</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> begin<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> data<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br></div></div><p>执行这段代码, 同样是 1000 次业务操作, 正确加锁的版本耗时 1.4 秒, 而对整个业务逻辑加锁的话耗时 11 秒.</p> <p><img src="/img/f7e81a4b232e2f9807fbbbb003054da2-20230731165210-nf4b8n5.png" alt=""></p> <p><strong>如果精细化考虑了锁应用范围后, 性能还无法满足需求的话, 就要考虑另一个维度的粒度问题了, 即:</strong> <mark><strong>区分读写场景以及资源的访问冲突, 考虑使用悲观方式的锁还是乐观方式的锁</strong></mark>​ <strong>.</strong></p> <p>一般业务代码中, 很少需要进一步考虑这两种更细粒度的锁, 所以只分享几个大概的结论, 可以根据自己的需求来考虑是否有必要进一步优化:</p> <ol><li><strong>对于读写比例差异明显的场景, 考虑使用 ReentrantReadWriteLock 细化区分读写锁, 来提高性能.</strong></li> <li>如果 JDK 版本高于 1.8, 共享资源的冲突概率也没那么大的话, 考虑使用 StampedLock 的乐观读的特性, 进一步提高性能.</li> <li>JDK 里 ReentrantLock 和 ReentrantReadWriteLock 都提供了公平锁的版本, <strong>在没有明确需求的情况下不要轻易开启公平锁特性, 在任务很轻的情况下开启公平锁可能会让性能下降上百倍</strong>.</li></ol> <h5 id="多把锁要小心死锁问题"><a href="#多把锁要小心死锁问题" class="header-anchor">#</a> 多把锁要小心死锁问题</h5> <p>刚才聊到锁的粒度够用就好, 这就意味着程序逻辑中有时会存在一些细粒度的锁. <strong>但一个业务逻辑如果涉及多把锁, 容易产生死锁问题</strong>.</p> <p>之前我遇到过这样一个案例: 下单操作需要锁定订单中多个商品的库存, 拿到所有商品的锁之后进行下单扣减库存操作, 全部操作完成之后释放所有的锁. 代码上线后发现, 下单失败概率很高, 失败后需要用户重新下单, 极大影响了用户体验, 还影响到了销量.</p> <p>经排查发现是死锁引起的问题, 背后原因是<strong>扣减库存的顺序不同</strong>, 导致并发的情况下多个线程可能相互持有部分商品的锁, 又等待其他线程释放另一部分商品的锁, 于是出现了死锁问题.</p> <p>接下来剖析一下核心的业务代码.</p> <p>首先, 定义一个商品类型, 包含商品名, 库存剩余和商品的库存锁三个属性, 每一种商品默认库存 1000 个; 然后, 初始化 10 个这样的商品对象来模拟商品清单:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Data</span>
<span class="token annotation punctuation">@RequiredArgsConstructor</span>
<span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Item</span> <span class="token punctuation">{</span>
    <span class="token keyword">final</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span> <span class="token comment">// 商品名</span>
    <span class="token keyword">int</span> remaining <span class="token operator">=</span> <span class="token number">1000</span><span class="token punctuation">;</span> <span class="token comment">// 库存剩余</span>
    <span class="token annotation punctuation">@ToString.Exclude</span> <span class="token comment">// ToString不包含这个字段 </span>
    <span class="token class-name">ReentrantLock</span> lock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReentrantLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>随后写一个方法模拟在购物车进行商品选购, 每次从商品清单(items 字段)中随机选购三个商品(为了逻辑简单, 不考虑每次选购多个同类商品的逻辑, 购物车中不体现商品数量):</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Item</span><span class="token punctuation">&gt;</span></span> <span class="token function">createCart</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token class-name">IntStream</span><span class="token punctuation">.</span><span class="token function">rangeClosed</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">mapToObj</span><span class="token punctuation">(</span>i <span class="token operator">-&gt;</span> <span class="token string">&quot;item&quot;</span> <span class="token operator">+</span> <span class="token class-name">ThreadLocalRandom</span><span class="token punctuation">.</span><span class="token function">current</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span>items<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>name <span class="token operator">-&gt;</span> items<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>下单代码如下: 先声明一个 List 来保存所有获得的锁, 然后遍历购物车中的商品依次尝试获得商品的锁, 最长等待 10 秒, 获得全部锁之后再扣减库存; 如果有无法获得锁的情况则解锁之前获得的所有锁, 返回 false 下单失败.</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">createOrder</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Item</span><span class="token punctuation">&gt;</span></span> order<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 存放所有获得的锁</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ReentrantLock</span><span class="token punctuation">&gt;</span></span> locks <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Item</span> item <span class="token operator">:</span> order<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">// 获得锁10秒超时</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>item<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">tryLock</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                locks<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                locks<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token class-name">ReentrantLock</span><span class="token operator">::</span><span class="token function">unlock</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 锁全部拿到之后执行扣减库存业务逻辑</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        order<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>item <span class="token operator">-&gt;</span> item<span class="token punctuation">.</span>remaining<span class="token operator">--</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        locks<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token class-name">ReentrantLock</span><span class="token operator">::</span><span class="token function">unlock</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><p>写一段代码测试这个下单操作. 模拟在多线程情况下进行 100 次创建购物车和下单操作, 最后通过日志输出成功的下单次数, 总剩余的商品个数, 100 次下单耗时, 以及下单完成后的商品库存明细:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;wrong&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">wrong</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">long</span> begin <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 并发进行100次下单操作, 统计成功次数</span>
    <span class="token keyword">long</span> success <span class="token operator">=</span> <span class="token class-name">IntStream</span><span class="token punctuation">.</span><span class="token function">rangeClosed</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">parallel</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">mapToObj</span><span class="token punctuation">(</span>i <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
                <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Item</span><span class="token punctuation">&gt;</span></span> cart <span class="token operator">=</span> <span class="token function">createCart</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token function">createOrder</span><span class="token punctuation">(</span>cart<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>result <span class="token operator">-&gt;</span> result<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;success:{} totalRemaining:{} took:{}ms items:{}&quot;</span><span class="token punctuation">,</span>
            success<span class="token punctuation">,</span>
            items<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>item <span class="token operator">-&gt;</span> item<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>remaining<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token operator">::</span><span class="token function">sum</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> begin<span class="token punctuation">,</span> items<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> success<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><p>运行程序, 输出如下日志:</p> <p><img src="/img/585c57be6d2cfb51948bd2e3edded4b6-20230731165210-sipnn2n.png" alt=""></p> <p>可以看到, 100 次下单操作成功了 65 次, 10 种商品总计 10000 件, 库存总计为 9805, 消耗了 195 件符合预期(65 次下单成功, 每次下单包含三件商品), 总耗时 50 秒.</p> <p>为什么会这样呢?</p> <p>使用 JDK 自带的 VisualVM 工具来跟踪一下, 重新执行方法后不久就可以看到, 线程 Tab 中提示了<strong>死锁问题</strong>, 根据提示点击右侧线程 Dump 按钮进行线程抓取操作:</p> <p><img src="/img/d54db8ed6e867bcd2c1d48c3e9613fc0-20230731165210-s8w95i1.png" alt=""></p> <p>查看抓取出的线程栈, 在页面中部可以看到如下日志:</p> <p><img src="/img/6d80f2dccb063b70c0369c426e7a7930-20230731165210-bts5hru.png" alt=""></p> <p>显然, <strong>是出现了死锁, 线程 4 在等待的一个锁被线程 3 持有, 线程 3 在等待的另一把锁被线程 4 持有</strong>.</p> <p>那为什么会有死锁问题呢?</p> <p>仔细回忆一下购物车添加商品的逻辑, 随机添加了三种商品, 假设一个购物车中的商品是 item1 和 item2, 另一个购物车中的商品是 item2 和 item1, 一个线程先获取到了 item1 的锁, 同时另一个线程获取到了 item2 的锁, 然后两个线程接下来要分别获取 item2 和 item1 的锁, 这个时候锁已经被对方获取了, 只能相互等待一直到 10 秒超时.</p> <p>其实, 避免死锁的方案很简单, <strong>为购物车中的商品排一下序, 让所有的线程一定是先获取 item1 的锁然后获取 item2 的锁, 就不会有问题了</strong>. 所以只需要修改一行代码, <strong>对 createCart 获得的购物车按照商品名进行排序</strong>即可:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;right&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">right</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ....  </span>
    <span class="token keyword">long</span> success <span class="token operator">=</span> <span class="token class-name">IntStream</span><span class="token punctuation">.</span><span class="token function">rangeClosed</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">parallel</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">mapToObj</span><span class="token punctuation">(</span>i <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
                <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Item</span><span class="token punctuation">&gt;</span></span> cart <span class="token operator">=</span> <span class="token function">createCart</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                        <span class="token comment">// 排个序</span>
                        <span class="token punctuation">.</span><span class="token function">sorted</span><span class="token punctuation">(</span><span class="token class-name">Comparator</span><span class="token punctuation">.</span><span class="token function">comparing</span><span class="token punctuation">(</span><span class="token class-name">Item</span><span class="token operator">::</span><span class="token function">getName</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token function">createOrder</span><span class="token punctuation">(</span>cart<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>result <span class="token operator">-&gt;</span> result<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// ...</span>
    <span class="token keyword">return</span> success<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>测试一下 right 方法, 不管执行多少次都是 100 次成功下单, 而且性能相当高, 达到了 3000 以上的 TPS:</p> <p><img src="/img/1439d5745924a4583810bebf40f3351c-20230731165210-uppy7ye.png" alt=""></p> <p>这个案例中, 虽然产生了死锁问题, 但因为尝试获取锁的操作并不是无限阻塞的, 所以没有造成永久死锁, 之后的改进就是避免循环等待, 通过对购物车的商品进行排序来实现有顺序的加锁, 避免循环等待.</p> <h5 id="重点回顾-2"><a href="#重点回顾-2" class="header-anchor">#</a> 重点回顾</h5> <p>总结回顾下, 使用锁来解决多线程情况下线程安全问题的坑.</p> <p>第一, 使用 synchronized 加锁虽然简单, 但首先要弄清楚共享资源是类还是实例级别的, 会被哪些线程操作, synchronized 关联的锁对象或方法又是什么范围的.</p> <p>第二, <strong>加锁尽可能要考虑粒度和场景, 锁保护的代码意味着无法进行多线程操作</strong>. 对于 Web 类型的天然多线程项目, 对方法进行大范围加锁会显著降级并发能力, 要考虑尽可能地只为必要的代码块加锁, 降低锁的粒度; 而对于要求超高性能的业务, 还要细化考虑锁的读写场景, 以及悲观优先还是乐观优先, 尽可能针对明确场景精细化加锁方案, 可以在适当的场景下考虑使用 ReentrantReadWriteLock, StampedLock 等高级的锁工具类.</p> <p>第三, 业务逻辑中有多把锁时要考虑死锁问题, 通常的规避方案是, 避免无限等待和循环等待. 此外, <strong>如果业务逻辑中锁的实现比较复杂的话, 要仔细看看加锁和释放是否配对, 是否有遗漏释放或重复释放的可能性; 并且要考虑锁自动超时释放了, 而业务逻辑却还在进行的情况下, 如果别的线线程或进程拿到了相同的锁, 可能会导致重复执行</strong>.</p> <p>为演示方便, 今天的案例是在 Controller 的逻辑中开新的线程或使用线程池进行并发模拟, 所以当然可以意识到哪些对象是并发操作的. 但对于 Web 应用程序的天然多线程场景, 可能更容易忽略这点, 并且也可能因为误用锁降低应用整体的吞吐. <strong>如果业务代码涉及复杂的锁操作, 强烈建议 Mock 相关外部接口或数据库操作后对应用代码进行压测, 通过压测排除锁误用带来的性能问题和死锁问题</strong>.</p> <h4 id="_03-线程池-业务代码最常用也最容易犯错的组件"><a href="#_03-线程池-业务代码最常用也最容易犯错的组件" class="header-anchor">#</a> 03-线程池:业务代码最常用也最容易犯错的组件</h4> <p>在程序中, 经常会用各种<strong>池化技术</strong>来缓存创建昂贵的对象, 比如<strong>线程池, 连接池, 内存池</strong>. 一般是预先创建一些对象放入池中, 使用的时候直接取出使用, 用完归还以便复用, 还会通过一定的策略调整池中缓存对象的数量, 实现池的动态伸缩.</p> <p>由于线程的创建比较昂贵, 随意, 没有控制地创建大量线程会造成性能问题, 因此短平快的任务一般考虑使用线程池来处理, 而不是直接创建线程.</p> <p>今天就针对线程池这个话题展开讨论, 通过三个生产事故, 来看看使用线程池应该注意些什么.</p> <h5 id="线程池的声明需要手动进行"><a href="#线程池的声明需要手动进行" class="header-anchor">#</a> 线程池的声明需要手动进行</h5> <p>Java 中的 Executors 类定义了一些快捷的工具方法, 来帮助快速创建线程池. 《阿里巴巴 Java 开发手册》中提到, 禁止使用这些方法来创建线程池, 而应该<strong>手动 new ThreadPoolExecutor 来创建线程池</strong>. 这一条规则的背后, 是大量血淋淋的生产事故, <strong>最典型的就是 newFixedThreadPool 和 newCachedThreadPool, 可能因为资源耗尽导致 OOM 问题</strong>.</p> <p>首先来看一下 newFixedThreadPool 为什么可能会出现 OOM 的问题.</p> <p>写一段测试代码, 来初始化一个单线程的 FixedThreadPool, 循环 1 亿次向线程池提交任务, 每个任务都会创建一个比较大的字符串然后休眠一小时:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;oom1&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">oom1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
    <span class="token class-name">ThreadPoolExecutor</span> threadPool <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">ThreadPoolExecutor</span><span class="token punctuation">)</span> <span class="token class-name">Executors</span><span class="token punctuation">.</span><span class="token function">newFixedThreadPool</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 打印线程池的信息, 稍后我会解释这段代码</span>
    <span class="token function">printStats</span><span class="token punctuation">(</span>threadPool<span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">100000000</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        threadPool<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token class-name">String</span> payload <span class="token operator">=</span> <span class="token class-name">IntStream</span><span class="token punctuation">.</span><span class="token function">rangeClosed</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1000000</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">mapToObj</span><span class="token punctuation">(</span>__ <span class="token operator">-&gt;</span> <span class="token string">&quot;a&quot;</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">joining</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token constant">UUID</span><span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">HOURS</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token punctuation">}</span>
            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span>payload<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    threadPool<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    threadPool<span class="token punctuation">.</span><span class="token function">awaitTermination</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">HOURS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><p>执行程序后不久, 日志中就出现了如下 OOM:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">Exception</span> in thread <span class="token string">&quot;http-nio-45678-ClientPoller&quot;</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>OutOfMemoryError</span><span class="token operator">:</span> <span class="token constant">GC</span> overhead limit exceeded
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>翻看 newFixedThreadPool 方法的源码不难发现, 线程池的工作队列直接 new 了一个 LinkedBlockingQueue, <strong>而默认构造方法的 LinkedBlockingQueue 是一个 Integer.MAX_VALUE 长度的队列, 可以认为是无界的</strong>:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">ExecutorService</span> <span class="token function">newFixedThreadPool</span><span class="token punctuation">(</span><span class="token keyword">int</span> nThreads<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ThreadPoolExecutor</span><span class="token punctuation">(</span>nThreads<span class="token punctuation">,</span> nThreads<span class="token punctuation">,</span>
                                  <span class="token number">0L</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">MILLISECONDS</span><span class="token punctuation">,</span>
                                  <span class="token keyword">new</span> <span class="token class-name">LinkedBlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Runnable</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LinkedBlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">extends</span> <span class="token class-name">AbstractQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span>
        <span class="token keyword">implements</span> <span class="token class-name">BlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">,</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span>Serializable</span> <span class="token punctuation">{</span>
    <span class="token comment">/**
     * Creates a {@code LinkedBlockingQueue} with a capacity of
     * {@link Integer#MAX_VALUE}.
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">LinkedBlockingQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">(</span><span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token constant">MAX_VALUE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>虽然使用 newFixedThreadPool 可以把工作线程控制在固定的数量上, 但<strong>任务队列是无界</strong>的. 如果任务较多并且执行较慢的话, 队列可能会快速积压, 撑爆内存导致 OOM.</p> <p>再把刚才的例子稍微改一下, 改为使用 newCachedThreadPool 方法来获得线程池. 程序运行不久后, 同样看到了如下 OOM 异常:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token punctuation">[</span><span class="token number">11</span><span class="token operator">:</span><span class="token number">30</span><span class="token operator">:</span><span class="token number">30.487</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>http<span class="token operator">-</span>nio<span class="token operator">-</span><span class="token number">45678</span><span class="token operator">-</span>exec<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token constant">ERROR</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token punctuation">.</span>a<span class="token punctuation">.</span>c<span class="token punctuation">.</span>c<span class="token punctuation">.</span>C<span class="token punctuation">.</span><span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">[</span><span class="token operator">/</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token punctuation">[</span>dispatcherServlet<span class="token punctuation">]</span><span class="token operator">:</span><span class="token number">175</span> <span class="token punctuation">]</span> <span class="token operator">-</span> <span class="token class-name">Servlet</span><span class="token punctuation">.</span><span class="token function">service</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">for</span> servlet <span class="token punctuation">[</span>dispatcherServlet<span class="token punctuation">]</span> in context <span class="token keyword">with</span> <span class="token namespace">path</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> threw exception <span class="token punctuation">[</span><span class="token class-name">Handler</span> dispatch failed<span class="token punctuation">;</span> nested exception is <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>OutOfMemoryError</span><span class="token operator">:</span> unable <span class="token keyword">to</span> <span class="token namespace">create</span> <span class="token keyword">new</span> <span class="token keyword">native</span> thread<span class="token punctuation">]</span> <span class="token keyword">with</span> <span class="token namespace">root</span> cause
<span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>OutOfMemoryError</span><span class="token operator">:</span> unable <span class="token keyword">to</span> <span class="token namespace">create</span> <span class="token keyword">new</span> <span class="token keyword">native</span> thread
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>从日志中可以看到, 这次 OOM 的原因是无法创建线程, 翻看 newCachedThreadPool 的源码可以看到, <strong>这种线程池的最大线程数是 Integer.MAX_VALUE, 可以认为是没有上限的, 而其工作队列 SynchronousQueue 是一个没有存储空间的阻塞队列</strong>. 这意味着, 只要有请求到来, 就必须找到一条工作线程来处理, 如果当前没有空闲的线程就再创建一条新的.</p> <p>由于任务需要 1 小时才能执行完成, 大量的任务进来后会创建大量的线程. 线程是需要分配一定的内存空间作为线程栈的, 比如 1MB, 因此无限制创建线程必然会导致 OOM:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">ExecutorService</span> <span class="token function">newCachedThreadPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ThreadPoolExecutor</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token constant">MAX_VALUE</span><span class="token punctuation">,</span> <span class="token number">60L</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">,</span> 
                                    <span class="token keyword">new</span> <span class="token class-name">SynchronousQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Runnable</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>其实, 大部分 Java 开发同学知道这两种线程池的特性, 只是抱有侥幸心理, 觉得只是使用线程池做一些轻量级的任务, 不可能造成队列积压或开启大量线程.</p> <p>但现实往往是残酷的. 我之前就遇到过这么一个事故: 用户注册后, 调用一个外部服务去发送短信, 发送短信接口正常时可以在 100 毫秒内响应, TPS 100 的注册量, CachedThreadPool 能稳定在占用 10 个左右线程的情况下满足需求. 在某个时间点, 外部短信服务不可用了, 所以调用这个服务的超时又特别长,  比如 1 分钟, 1 分钟可能就进来了 6000 用户, 产生 6000 个发送短信的任务, 需要 6000 个线程, 没多久就因为无法创建线程导致了 OOM, 整个应用程序崩溃.</p> <p>因此, <strong>同样不建议使用 Executors 提供的两种快捷的线程池, 原因如下</strong>:</p> <ol><li><mark><strong>需要根据自己的场景, 并发情况来评估线程池的几个核心参数, 包括核心线程数, 最大线程数, 线程回收策略, 工作队列的类型, 以及拒绝策略, 确保线程池的工作行为符合需求, 一般都需要设置有界的工作队列和可控的线程数.</strong></mark></li> <li><strong>任何时候, 都应该为自定义线程池指定有意义的名称, 以方便排查问题</strong>. 当出现线程数量暴增, 线程死锁, 线程占用大量 CPU, 线程执行出现异常等问题时, 往往会抓取线程栈. 此时有意义的线程名称, 就可以方便定位问题.</li></ol> <p>除了建议手动声明线程池以外, 还建议<mark><strong>用一些监控手段来观察线程池的状态</strong></mark>. 线程池这个组件往往会表现得任劳任怨, 默默无闻, 除非是出现了拒绝策略, 否则压力再大都不会抛出一个异常. 如果能提前观察到线程池队列的积压, 或者线程数量的快速膨胀, 往往可以提早发现并解决问题.</p> <h5 id="线程池线程管理策略详解"><a href="#线程池线程管理策略详解" class="header-anchor">#</a> 线程池线程管理策略详解</h5> <p>在之前的 Demo 中, 用一个 printStats 方法实现了最简陋的监控, 每秒输出一次线程池的基本内部信息, 包括线程数, 活跃线程数, 完成了多少任务, 以及队列中还有多少积压任务等信息:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">printStats</span><span class="token punctuation">(</span><span class="token class-name">ThreadPoolExecutor</span> threadPool<span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token class-name">Executors</span><span class="token punctuation">.</span><span class="token function">newSingleThreadScheduledExecutor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">scheduleAtFixedRate</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;&lt;mark&gt;&lt;/mark&gt;&lt;mark&gt;&lt;/mark&gt;&lt;mark&gt;&lt;/mark&gt;&lt;mark&gt;&lt;/mark&gt;&lt;mark&gt;&lt;/mark&gt;&lt;mark&gt;&lt;/mark&gt;=&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;Pool Size: {}&quot;</span><span class="token punctuation">,</span> threadPool<span class="token punctuation">.</span><span class="token function">getPoolSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;Active Threads: {}&quot;</span><span class="token punctuation">,</span> threadPool<span class="token punctuation">.</span><span class="token function">getActiveCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;Number of Tasks Completed: {}&quot;</span><span class="token punctuation">,</span> threadPool<span class="token punctuation">.</span><span class="token function">getCompletedTaskCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;Number of Tasks in Queue: {}&quot;</span><span class="token punctuation">,</span> threadPool<span class="token punctuation">.</span><span class="token function">getQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;&lt;mark&gt;&lt;/mark&gt;&lt;mark&gt;&lt;/mark&gt;&lt;mark&gt;&lt;/mark&gt;&lt;mark&gt;&lt;/mark&gt;&lt;mark&gt;&lt;/mark&gt;&lt;mark&gt;&lt;/mark&gt;=&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>接下来就利用这个方法来观察一下线程池的基本特性.</p> <p>首先, 自定义一个线程池. 这个线程池具有 2 个核心线程, 5 个最大线程, 使用容量为 10 的 ArrayBlockingQueue 阻塞队列作为工作队列, 使用默认的 AbortPolicy 拒绝策略, 也就是任务添加到线程池失败会抛出 RejectedExecutionException. 此外借助了 Jodd 类库的 ThreadFactoryBuilder 方法来构造一个线程工厂, 实现线程池线程的自定义命名.</p> <p>然后写一段测试代码来观察线程池管理线程的策略. 测试代码的逻辑为, 每次间隔 1 秒向线程池提交任务, 循环 20 次, 每个任务需要 10 秒才能执行完成, 代码如下:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;right&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">right</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
    <span class="token comment">// 使用一个计数器跟踪完成的任务数</span>
    <span class="token class-name">AtomicInteger</span> atomicInteger <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicInteger</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 创建一个具有2个核心线程, 5个最大线程, 使用容量为10的ArrayBlockingQueue阻塞队列作为工作队列的线程池, 使用默认的AbortPolicy拒绝策略</span>
    <span class="token class-name">ThreadPoolExecutor</span> threadPool <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadPoolExecutor</span><span class="token punctuation">(</span>
            <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span>
            <span class="token number">5</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">,</span>
            <span class="token keyword">new</span> <span class="token class-name">ArrayBlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token keyword">new</span> <span class="token class-name">ThreadFactoryBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setNameFormat</span><span class="token punctuation">(</span><span class="token string">&quot;demo-threadpool-%d&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token keyword">new</span> <span class="token class-name">ThreadPoolExecutor<span class="token punctuation">.</span>AbortPolicy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printStats</span><span class="token punctuation">(</span>threadPool<span class="token punctuation">)</span><span class="token punctuation">;</span>
  
    <span class="token comment">// 每隔1秒提交一次, 一共提交20次任务</span>
    <span class="token class-name">IntStream</span><span class="token punctuation">.</span><span class="token function">rangeClosed</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>i <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">int</span> id <span class="token operator">=</span> atomicInteger<span class="token punctuation">.</span><span class="token function">incrementAndGet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            threadPool<span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
                log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;{} started&quot;</span><span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 每个任务耗时10秒</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token punctuation">}</span>
                log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;{} finished&quot;</span><span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 提交出现异常的话, 打印出错信息并为计数器减一</span>
            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;error submitting task {}&quot;</span><span class="token punctuation">,</span> id<span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
            atomicInteger<span class="token punctuation">.</span><span class="token function">decrementAndGet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> atomicInteger<span class="token punctuation">.</span><span class="token function">intValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br></div></div><p>60 秒后方法输出了 17, 有 3 次提交失败了.</p> <p>并且日志中也出现了 3 次类似的错误信息:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token punctuation">[</span><span class="token number">14</span><span class="token operator">:</span><span class="token number">24</span><span class="token operator">:</span><span class="token number">52.879</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>http<span class="token operator">-</span>nio<span class="token operator">-</span><span class="token number">45678</span><span class="token operator">-</span>exec<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token constant">ERROR</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token punctuation">.</span>t<span class="token punctuation">.</span>c<span class="token punctuation">.</span>t<span class="token punctuation">.</span>demo1<span class="token punctuation">.</span>ThreadPoolOOMController<span class="token operator">:</span><span class="token number">103</span> <span class="token punctuation">]</span> <span class="token operator">-</span> error submitting task <span class="token number">18</span>
<span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span>RejectedExecutionException</span><span class="token operator">:</span> <span class="token class-name">Task</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span>FutureTask</span><span class="token annotation punctuation">@163a2dec</span> rejected from <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span>ThreadPoolExecutor</span><span class="token annotation punctuation">@18061ad2</span><span class="token punctuation">[</span><span class="token class-name">Running</span><span class="token punctuation">,</span> pool size <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">,</span> active threads <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">,</span> queued tasks <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">,</span> completed tasks <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>把 printStats 方法打印出的日志绘制成图表, 得出如下曲线:</p> <p><img src="/img/7340a23456e0d65857f87a28ee75c8e3-20230731165210-3lypz9o.png" alt=""></p> <p><strong>至此, 可以总结出线程池默认的工作行为</strong>:</p> <ol><li><strong>不会初始化 corePoolSize 个线程, 有任务来了才创建工作线程</strong>;</li> <li><strong>当核心线程满了之后不会立即扩容线程池, 而是把任务堆积到工作队列中</strong>;</li> <li><strong>当工作队列满了后扩容线程池, 一直到线程个数达到 maximumPoolSize 为止</strong>;</li> <li><strong>如果队列已满且达到了最大线程后还有任务进来, 按照拒绝策略处理;</strong></li> <li><strong>当线程数大于核心线程数时, 线程等待 keepAliveTime 后还是没有任务需要处理的话, 收缩线程到核心线程数.</strong></li></ol> <p>了解这个策略, 可以根据实际的容量规划需求, 为线程池设置合适的初始化参数. 当然也可以通过一些手段来改变这些默认工作行为, 比如:</p> <ol><li>声明线程池后立即调用 <strong>prestartAllCoreThreads</strong> 方法, 来<strong>启动所有核心线程</strong>;</li> <li>传入 true 给 allowCoreThreadTimeOut 方法, 来<strong>让线程池在空闲的时候同样回收核心线程</strong>.</li></ol> <p>不知道你有没有想过: <strong>Java 线程池是先用工作队列来存放来不及处理的任务, 满了之后再扩容线程池</strong>. 当工作队列设置得很大时, 最大线程数这个参数显得没有意义, 因为队列很难满, 或者到满的时候再去扩容线程池已经于事无补了.</p> <p>那么, <strong>有没有办法让线程池更激进一点, 优先开启更多的线程, 而把队列当成一个后备方案呢?</strong>  比如这个例子, 任务执行得很慢, 需要 10 秒, 如果线程池可以优先扩容到 5 个最大线程, 那么这些任务最终都可以完成, 而不会因为线程池扩容过晚导致慢任务来不及处理.</p> <p>这里给一个大致思路: 由于线程池在工作队列满了无法入队的情况下会扩容线程池, 那么是否可以<strong>重写队列的 offer 方法, 造成这个队列已满的假象</strong>呢? 由于 Hack 了队列, 在达到了最大线程后势必会触发拒绝策略, 那么能否实现一个自定义的拒绝策略处理程序, 这个时候再把任务真正插入队列呢? Tomcat 线程池也实现了类似的效果, 可供你借鉴.</p> <h5 id="务必确认清楚线程池本身是不是复用的"><a href="#务必确认清楚线程池本身是不是复用的" class="header-anchor">#</a> 务必确认清楚线程池本身是不是复用的</h5> <p>不久之前我遇到了这样一个事故: 某项目生产环境时不时有报警提示线程数过多, 超过 2000 个, 收到报警后查看监控发现, 瞬时线程数比较多但过一会儿又会降下来, 线程数抖动很厉害, 而应用的访问量变化不大.</p> <p>为了定位问题, 我们在线程数比较高的时候进行线程栈抓取, 抓取后发现<strong>内存中有 1000 多个自定义线程池</strong>. 一般而言, 线程池肯定是复用的, 有 5 个以内的线程池都可以认为正常, 而 1000 多个线程池肯定不正常.</p> <p>在项目代码里, 没有搜到声明线程池的地方, 搜索 execute 关键字后定位到, 原来是<strong>业务代码调用了一个类库来获得线程池</strong>, 类似如下的业务代码: 调用 ThreadPoolHelper 的 getThreadPool 方法来获得线程池, 然后提交数个任务到线程池处理, 看不出什么异常.</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;wrong&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">wrong</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
    <span class="token class-name">ThreadPoolExecutor</span> threadPool <span class="token operator">=</span> <span class="token class-name">ThreadPoolHelper</span><span class="token punctuation">.</span><span class="token function">getThreadPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">IntStream</span><span class="token punctuation">.</span><span class="token function">rangeClosed</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>i <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        threadPool<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token comment">// ...</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token string">&quot;OK&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>但是, 来到 ThreadPoolHelper 的实现让人大跌眼镜, <strong>getThreadPool 方法居然是每次都使用 Executors.newCachedThreadPool 来创建一个线程池</strong>.</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">class</span> <span class="token class-name">ThreadPoolHelper</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">ThreadPoolExecutor</span> <span class="token function">getThreadPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 线程池没有复用</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">ThreadPoolExecutor</span><span class="token punctuation">)</span> <span class="token class-name">Executors</span><span class="token punctuation">.</span><span class="token function">newCachedThreadPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>通过上一小节的学习, 可以想到 newCachedThreadPool 会在需要时创建必要多的线程, 业务代码的一次业务操作会向线程池提交多个慢任务, 这样执行一次业务操作就会开启多个线程. 如果业务操作并发量较大的话, 的确有可能一下子开启几千个线程.</p> <p>那, 为什么能在监控中看到线程数量会下降, 而不会撑爆内存呢?</p> <p>回到 newCachedThreadPool 的定义就会发现, 它的核心线程数是 0, 而 keepAliveTime 是 60 秒, 也就是在 60 秒之后所有的线程都是可以回收的. 好吧, 就因为这个特性, 业务程序死得没太难看.</p> <p>要修复这个 Bug 也很简单, 使用一个<strong>静态字段来存放线程池的引用, 返回线程池的代码直接返回这个静态字段即可</strong>. 这里一定要记得最佳实践, <strong>手动创建线程池</strong>. 修复后的 ThreadPoolHelper 类如下:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">class</span> <span class="token class-name">ThreadPoolHelper</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">ThreadPoolExecutor</span> threadPoolExecutor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadPoolExecutor</span><span class="token punctuation">(</span>
            <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">,</span>
            <span class="token number">2</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">,</span>
            <span class="token keyword">new</span> <span class="token class-name">ArrayBlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token keyword">new</span> <span class="token class-name">ThreadFactoryBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setNameFormat</span><span class="token punctuation">(</span><span class="token string">&quot;demo-threadpool-%d&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 复用线程池</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">ThreadPoolExecutor</span> <span class="token function">getRightThreadPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> threadPoolExecutor<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>需要仔细斟酌线程池的混用策略线程池的意义在于复用, 那这是不是意味着程序应该始终使用一个线程池呢?</p> <p>当然不是. 通过第一小节的学习可以知道, <strong>要根据任务的 &quot;轻重缓急&quot; 来指定线程池的核心参数, 包括线程数, 回收策略和任务队列</strong>:</p> <ol><li>对于执行比较慢, 数量不大的 IO 任务, 或许要考虑更多的线程数, 而不需要太大的队列.</li> <li>而对于吞吐量较大的计算型任务, 线程数量不宜过多, 可以是 CPU 核数或核数 * 2(理由是, 线程一定调度到某个 CPU 进行执行, 如果任务本身是 CPU 绑定的任务, 那么过多的线程只会增加线程切换的开销, 并不能提升吞吐量), 但可能需要较长的队列来做缓冲.</li></ol> <p>之前我也遇到过这么一个问题, 业务代码使用了线程池异步处理一些内存中的数据, 但通过监控发现处理得非常慢, 整个处理过程都是内存中的计算不涉及 IO 操作, 也需要数秒的处理时间, 应用程序 CPU 占用也不是特别高, 有点不可思议.</p> <p>经排查发现, 业务代码使用的线程池, 还被一个后台的文件批处理任务用到了.</p> <p>或许是够用就好的原则, 这个线程池只有 2 个核心线程, 最大线程也是 2, 使用了容量为 100 的 ArrayBlockingQueue 作为工作队列, 使用了 CallerRunsPolicy 拒绝策略:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">ThreadPoolExecutor</span> threadPool <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadPoolExecutor</span><span class="token punctuation">(</span>
        <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span>
        <span class="token number">1</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">HOURS</span><span class="token punctuation">,</span>
        <span class="token keyword">new</span> <span class="token class-name">ArrayBlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token keyword">new</span> <span class="token class-name">ThreadFactoryBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setNameFormat</span><span class="token punctuation">(</span><span class="token string">&quot;batchfileprocess-threadpool-%d&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token keyword">new</span> <span class="token class-name">ThreadPoolExecutor<span class="token punctuation">.</span>CallerRunsPolicy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>这里模拟一下文件批处理的代码, 在程序启动后通过一个线程开启死循环逻辑, 不断向线程池提交任务, 任务的逻辑是向一个文件中写入大量的数据:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@PostConstruct</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">printStats</span><span class="token punctuation">(</span>threadPool<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">// 模拟需要写入的大量数据</span>
        <span class="token class-name">String</span> payload <span class="token operator">=</span> <span class="token class-name">IntStream</span><span class="token punctuation">.</span><span class="token function">rangeClosed</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1_000_000</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">mapToObj</span><span class="token punctuation">(</span>__ <span class="token operator">-&gt;</span> <span class="token string">&quot;a&quot;</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">joining</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            threadPool<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span> 
                    <span class="token comment">// 每次都是创建并写入相同的数据到相同的文件</span>
                    <span class="token class-name">Files</span><span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token class-name">Paths</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;demo.txt&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">singletonList</span><span class="token punctuation">(</span><span class="token class-name">LocalTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;:&quot;</span> <span class="token operator">+</span> payload<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant">UTF_8</span><span class="token punctuation">,</span> <span class="token constant">CREATE</span><span class="token punctuation">,</span> <span class="token constant">TRUNCATE_EXISTING</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;batch file processing done&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><p>可以想象到, 这个线程池中的 2 个线程任务是相当重的. 通过 printStats 方法打印出的日志, 观察下线程池的负担:</p> <p><img src="/img/aded6fbac11f64625655a8d12da3e355-20230731165210-4dyy7ui.png" alt=""></p> <p>可以看到, **线程池的 2 个线程始终处于活跃状态, 队列也基本处于打满状态. **因为开启了 CallerRunsPolicy 拒绝处理策略, 所以当线程满载队列也满的情况下, 任务会在提交任务的线程, 或者说调用 execute 方法的线程执行, 也就是说不能认为提交到线程池的任务就一定是异步处理的. 如果使用了 CallerRunsPolicy 策略, 那么有可能异步任务变为同步执行. 从日志的第四行也可以看到这点. 这也是这个拒绝策略比较特别的原因.</p> <p>不知道写代码的同学为什么设置这个策略, 或许是测试时发现线程池因为任务处理不过来出现了异常, 而又不希望线程池丢弃任务, 所以最终选择了这样的拒绝策略. 不管怎样, 这些日志足以说明线程池是饱和状态.</p> <p>可以想象到, 业务代码复用这样的线程池来做内存计算, 命运一定是悲惨的. 写一段代码测试下, 向线程池提交一个简单的任务, 这个任务只是休眠 10 毫秒没有其他逻辑:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token class-name">Callable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> <span class="token function">calcTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">MILLISECONDS</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;wrong&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">wrong</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ExecutionException</span><span class="token punctuation">,</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> threadPool<span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span><span class="token function">calcTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>使用 wrk 工具对这个接口进行一个简单的压测, 可以看到 TPS 为 75, 性能的确非常差.</p> <p><img src="/img/9d83da0658c68c07833f57edd06ef9ae-20230731165210-hbpnk70.png" alt=""></p> <p>细想一下, 问题其实没有这么简单. 因为原来执行 IO 任务的线程池使用的是 CallerRunsPolicy 策略, 所以直接使用这个线程池进行异步计算的话, <strong>当线程池饱和的时候, 计算任务会在执行 Web 请求的 Tomcat 线程执行, 这时就会进一步影响到其他同步处理的线程, 甚至造成整个应用程序崩溃</strong>.</p> <p>解决方案很简单, 使用独立的线程池来做这样的 &quot;计算任务&quot; 即可. 计算任务打了双引号, 是因为模拟代码执行的是休眠操作, 并不属于 CPU 绑定的操作, 更类似 IO 绑定的操作, 如果线程池线程数设置太小会限制吞吐能力:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">ThreadPoolExecutor</span> asyncCalcThreadPool <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadPoolExecutor</span><span class="token punctuation">(</span>
        <span class="token number">200</span><span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">,</span>
        <span class="token number">1</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">HOURS</span><span class="token punctuation">,</span>
        <span class="token keyword">new</span> <span class="token class-name">ArrayBlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token keyword">new</span> <span class="token class-name">ThreadFactoryBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setNameFormat</span><span class="token punctuation">(</span><span class="token string">&quot;asynccalc-threadpool-%d&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;right&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">right</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ExecutionException</span><span class="token punctuation">,</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> asyncCalcThreadPool<span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span><span class="token function">calcTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>使用单独的线程池改造代码后再来测试一下性能, TPS 提高到了 1727:</p> <p><img src="/img/11643501cb567eee481952e05c2213d9-20230731165210-6fwqsx0.png" alt=""></p> <p>可以看到, 盲目复用线程池混用线程的问题在于, <strong>别人定义的线程池属性不一定适合你的任务, 而且混用会相互干扰</strong>. 这就好比, 我们往往会用虚拟化技术来实现资源的隔离, 而不是让所有应用程序都直接使用物理机.</p> <p>就线程池混用问题, 想再补充一个坑: <strong>Java 8 的 parallel stream 功能, 可以很方便地并行处理集合中的元素, 其背后是共享同一个 ForkJoinPool, 默认并行度是 CPU 核数 -1</strong>. 对于 CPU 绑定的任务来说, 使用这样的配置比较合适, 但如果集合操作<strong>涉及同步 IO 操作</strong>的话(比如数据库操作, 外部服务调用等), <strong>建议自定义一个 ForkJoinPool(或普通线程池)</strong> .</p> <h5 id="重点回顾-3"><a href="#重点回顾-3" class="header-anchor">#</a> 重点回顾</h5> <p>线程池管理着线程, 线程又属于宝贵的资源, 有许多应用程序的性能问题都来自线程池的配置和使用不当. 在今天的学习中, 通过三个和线程池相关的生产事故, 分享了使用线程池的几个最佳实践.</p> <p>第一, Executors 类提供的一些快捷声明线程池的方法虽然简单, 但隐藏了线程池的参数细节. 因此, 使用线程池时, <strong>一定要根据场景和需求配置合理的线程数, 任务队列, 拒绝策略, 线程回收策略, 并对线程进行明确的命名方便排查问题</strong>.</p> <p>第二, <strong>既然使用了线程池就需要确保线程池是在复用的</strong>, 每次 new 一个线程池出来可能比不用线程池还糟糕. 如果没有直接声明线程池而是使用其他同学提供的类库来获得一个线程池, 请务必查看源码, 以确认线程池的实例化方式和配置是符合预期的.</p> <p>第三, <strong>复用线程池不代表应用程序始终使用同一个线程池, 应该根据任务的性质来选用不同的线程池</strong>. 特别注意 IO 绑定的任务和 CPU 绑定的任务对于线程池属性的偏好, 如果希望减少任务间的相互干扰, 考虑按需使用隔离的线程池.</p> <p>最后想强调的是, <strong>线程池作为应用程序内部的核心组件往往缺乏监控</strong>(如果使用类似 RabbitMQ 这样的 MQ 中间件, 运维同学一般会帮我们做好中间件监控), 往往到程序崩溃后才发现线程池的问题, 很被动. 在设计篇中会重新谈及这个问题及其解决方案.</p> <h4 id="_04-连接池-别让连接池帮了倒忙"><a href="#_04-连接池-别让连接池帮了倒忙" class="header-anchor">#</a> 04-连接池:别让连接池帮了倒忙</h4> <p>上一讲学习了使用线程池需要注意的问题. 今天再说说另一种很重要的池化技术, 即<strong>连接池</strong>.</p> <p>先说说连接池的结构. <mark><strong>连接池一般对外提供获得连接, 归还连接的接口给客户端使用, 并暴露最小空闲连接数, 最大连接数等可配置参数, 在内部则实现连接建立, 连接心跳保持, 连接管理, 空闲连接回收, 连接可用性检测等功能</strong></mark>. 连接池的结构示意图, 如下所示:</p> <p><img src="/img/0171934e3bcab02f1543e9df7e2c00b9-20230731165210-jyyxqk1.png" alt=""></p> <p>业务项目中经常会用到的连接池, 主要是<strong>数据库连接池, Redis 连接池和 HTTP 连接池</strong>. 所以, 今天就以这三种连接池为例, 聊聊使用和配置连接池容易出错的地方.</p> <h5 id="注意鉴别客户端sdk是否基于连接池"><a href="#注意鉴别客户端sdk是否基于连接池" class="header-anchor">#</a> 注意鉴别客户端SDK是否基于连接池</h5> <p>在使用三方客户端进行网络通信时, 首先要<strong>确定客户端 SDK 是否是基于连接池技术实现</strong>的. TCP 是面向连接的基于字节流的协议:</p> <ol><li>面向连接, 意味着连接需要先创建再使用, 创建连接的三次握手有一定开销;</li> <li>基于字节流, 意味着字节是发送数据的最小单元, TCP 协议本身无法区分哪几个字节是完整的消息体, 也无法感知是否有多个客户端在使用同一个 TCP 连接, TCP 只是一个读写数据的管道.</li></ol> <p>如果客户端 SDK 没有使用连接池, 而直接是 TCP 连接, 那么就需要考虑每次建立 TCP 连接的开销, <strong>并且因为 TCP 基于字节流, 在多线程的情况下对同一连接进行复用, 可能会产生线程安全问题</strong>.</p> <p>先看一下涉及 TCP 连接的客户端 SDK, 对外提供 API 的三种方式. 在面对各种三方客户端的时候, 只有先识别出其属于哪一种, 才能理清楚使用方式.</p> <ol><li><strong>连接池和连接分离的 API</strong>: 有一个 XXXPool 类负责连接池实现, 先从其获得连接 XXXConnection, 然后用获得的连接进行服务端请求, 完成后使用者需要归还连接. 通常, XXXPool 是线程安全的, 可以并发获取和归还连接, 而 XXXConnection 是非线程安全的. 对应到连接池的结构示意图中, XXXPool 就是右边连接池那个框, 左边的客户端是自己的代码.</li> <li><strong>内部带有连接池的 API</strong>: 对外提供一个 XXXClient 类, 通过这个类可以直接进行服务端请求; 这个类内部维护了连接池, SDK 使用者无需考虑连接的获取和归还问题. 一般而言, XXXClient 是线程安全的. 对应到连接池的结构示意图中, 整个 API 就是蓝色框包裹的部分.</li> <li><strong>非连接池的 API</strong>: 一般命名为 XXXConnection, 以区分其是基于连接池还是单连接的, 而不建议命名为 XXXClient 或直接是 XXX. 直接连接方式的 API 基于单一连接, 每次使用都需要创建和断开连接, 性能一般, 且通常不是线程安全的. 对应到连接池的结构示意图中, 这种形式相当于没有右边连接池那个框, 客户端直接连接服务端创建连接.</li></ol> <p>虽然上面提到了 SDK 一般的命名习惯, 但不排除有一些客户端特立独行, 因此在使用三方 SDK 时, 一定要先查看官方文档了解其最佳实践, 或是在类似 Stackoverflow 的网站搜索 XXX threadsafe/singleton 字样看看大家的回复, 也可以一层一层往下看源码, 直到定位到原始 Socket 来判断 Socket 和客户端 API 的对应关系.</p> <p>明确了 SDK 连接池的实现方式后, 就大概知道了使用 SDK 的最佳实践:</p> <ol><li><strong>如果是分离方式, 那么连接池本身一般是线程安全的, 可以复用</strong>. 每次使用需要从连接池获取连接, 使用后归还, 归还的工作由使用者负责.</li> <li>如果是内置连接池, SDK 会负责连接的获取和归还, 使用的时候直接复用客户端.</li> <li>如果 SDK 没有实现连接池(大多数中间件, 数据库的客户端 SDK 都会支持连接池), 那通常不是线程安全的, 而且短连接的方式性能不会很高, 使用的时候需要考虑是否自己封装一个连接池.</li></ol> <p>接下来就以 Java 中用于操作 Redis 最常见的库 Jedis 为例, 从源码角度分析下 Jedis 类到底属于哪种类型的 API, 直接在多线程环境下复用一个连接会产生什么问题, 以及如何用最佳实践来修复这个问题.</p> <p>首先, 向 Redis 初始化 2 组数据, Key=a, Value=1, Key=b, Value=2:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@PostConstruct</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">Jedis</span> jedis <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Jedis</span><span class="token punctuation">(</span><span class="token string">&quot;127.0.0.1&quot;</span><span class="token punctuation">,</span> <span class="token number">6379</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">isTrue</span><span class="token punctuation">(</span><span class="token string">&quot;OK&quot;</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>jedis<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">&quot;a&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;set a = 1 return OK&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">isTrue</span><span class="token punctuation">(</span><span class="token string">&quot;OK&quot;</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>jedis<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">&quot;b&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;set b = 2 return OK&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>然后, 启动两个线程, 共享操作同一个 Jedis 实例, 每一个线程循环 1000 次, 分别读取 Key 为 a 和 b 的 Value, 判断是否分别为 1 和 2:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">Jedis</span> jedis <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Jedis</span><span class="token punctuation">(</span><span class="token string">&quot;127.0.0.1&quot;</span><span class="token punctuation">,</span> <span class="token number">6379</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">1000</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> result <span class="token operator">=</span> jedis<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;a&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>result<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">&quot;1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;Expect a to be 1 but found {}&quot;</span><span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">1000</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> result <span class="token operator">=</span> jedis<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;b&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>result<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">&quot;2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;Expect b to be 2 but found {}&quot;</span><span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><p>执行程序多次, 可以看到日志中出现了各种奇怪的异常信息, 有的是读取 Key 为 b 的 Value 读取到了 1, 有的是流非正常结束, 还有的是连接关闭异常:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// 错误1</span>
<span class="token punctuation">[</span><span class="token number">14</span><span class="token operator">:</span><span class="token number">56</span><span class="token operator">:</span><span class="token number">19.069</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token class-name">Thread</span><span class="token operator">-</span><span class="token number">28</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token constant">WARN</span> <span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token punctuation">.</span>t<span class="token punctuation">.</span>c<span class="token punctuation">.</span>c<span class="token punctuation">.</span>redis<span class="token punctuation">.</span>JedisMisreuseController<span class="token operator">:</span><span class="token number">45</span>  <span class="token punctuation">]</span> <span class="token operator">-</span> <span class="token class-name">Expect</span> b <span class="token keyword">to</span> <span class="token namespace">be</span> <span class="token number">2</span> but found <span class="token number">1</span>
<span class="token comment">// 错误2</span>
<span class="token class-name"><span class="token namespace">redis<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>jedis<span class="token punctuation">.</span>exceptions<span class="token punctuation">.</span></span>JedisConnectionException</span><span class="token operator">:</span> <span class="token class-name">Unexpected</span> end of stream<span class="token punctuation">.</span>
at <span class="token class-name"><span class="token namespace">redis<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>jedis<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span>RedisInputStream</span><span class="token punctuation">.</span><span class="token function">ensureFill</span><span class="token punctuation">(</span><span class="token class-name">RedisInputStream</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">202</span><span class="token punctuation">)</span>
at <span class="token class-name"><span class="token namespace">redis<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>jedis<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span>RedisInputStream</span><span class="token punctuation">.</span><span class="token function">readLine</span><span class="token punctuation">(</span><span class="token class-name">RedisInputStream</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">50</span><span class="token punctuation">)</span>
at <span class="token class-name"><span class="token namespace">redis<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>jedis<span class="token punctuation">.</span></span>Protocol</span><span class="token punctuation">.</span><span class="token function">processError</span><span class="token punctuation">(</span><span class="token class-name">Protocol</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">114</span><span class="token punctuation">)</span>
at <span class="token class-name"><span class="token namespace">redis<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>jedis<span class="token punctuation">.</span></span>Protocol</span><span class="token punctuation">.</span><span class="token function">process</span><span class="token punctuation">(</span><span class="token class-name">Protocol</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">166</span><span class="token punctuation">)</span>
at <span class="token class-name"><span class="token namespace">redis<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>jedis<span class="token punctuation">.</span></span>Protocol</span><span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token class-name">Protocol</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">220</span><span class="token punctuation">)</span>
at <span class="token class-name"><span class="token namespace">redis<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>jedis<span class="token punctuation">.</span></span>Connection</span><span class="token punctuation">.</span><span class="token function">readProtocolWithCheckingBroken</span><span class="token punctuation">(</span><span class="token class-name">Connection</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">318</span><span class="token punctuation">)</span>
at <span class="token class-name"><span class="token namespace">redis<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>jedis<span class="token punctuation">.</span></span>Connection</span><span class="token punctuation">.</span><span class="token function">getBinaryBulkReply</span><span class="token punctuation">(</span><span class="token class-name">Connection</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">255</span><span class="token punctuation">)</span>
at <span class="token class-name"><span class="token namespace">redis<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>jedis<span class="token punctuation">.</span></span>Connection</span><span class="token punctuation">.</span><span class="token function">getBulkReply</span><span class="token punctuation">(</span><span class="token class-name">Connection</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">245</span><span class="token punctuation">)</span>
at <span class="token class-name"><span class="token namespace">redis<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>jedis<span class="token punctuation">.</span></span>Jedis</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">Jedis</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">181</span><span class="token punctuation">)</span>
at <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>geekbang<span class="token punctuation">.</span>time<span class="token punctuation">.</span>commonmistakes<span class="token punctuation">.</span>connectionpool<span class="token punctuation">.</span>redis<span class="token punctuation">.</span></span>JedisMisreuseController</span><span class="token punctuation">.</span>lambda$wrong$<span class="token function">1</span><span class="token punctuation">(</span><span class="token class-name">JedisMisreuseController</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">43</span><span class="token punctuation">)</span>
at <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>Thread</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">748</span><span class="token punctuation">)</span>
<span class="token comment">// 错误3</span>
<span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span>IOException</span><span class="token operator">:</span> <span class="token class-name">Socket</span> <span class="token class-name">Closed</span>
at <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>net<span class="token punctuation">.</span></span>AbstractPlainSocketImpl</span><span class="token punctuation">.</span><span class="token function">getOutputStream</span><span class="token punctuation">(</span><span class="token class-name">AbstractPlainSocketImpl</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">440</span><span class="token punctuation">)</span>
at <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>net<span class="token punctuation">.</span></span>Socket</span>$<span class="token number">3.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">Socket</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">954</span><span class="token punctuation">)</span>
at <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>net<span class="token punctuation">.</span></span>Socket</span>$<span class="token number">3.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">Socket</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">952</span><span class="token punctuation">)</span>
at <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>security<span class="token punctuation">.</span></span>AccessController</span><span class="token punctuation">.</span><span class="token function">doPrivileged</span><span class="token punctuation">(</span><span class="token class-name">Native</span> <span class="token class-name">Method</span><span class="token punctuation">)</span>
at <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>net<span class="token punctuation">.</span></span>Socket</span><span class="token punctuation">.</span><span class="token function">getOutputStream</span><span class="token punctuation">(</span><span class="token class-name">Socket</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">951</span><span class="token punctuation">)</span>
at <span class="token class-name"><span class="token namespace">redis<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>jedis<span class="token punctuation">.</span></span>Connection</span><span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token class-name">Connection</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">200</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token number">7</span> more
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><p>分析一下 Jedis 类的源码, 搞清楚其中缘由.</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Jedis</span> <span class="token keyword">extends</span> <span class="token class-name">BinaryJedis</span> <span class="token keyword">implements</span> <span class="token class-name">JedisCommands</span><span class="token punctuation">,</span> <span class="token class-name">MultiKeyCommands</span><span class="token punctuation">,</span>
        <span class="token class-name">AdvancedJedisCommands</span><span class="token punctuation">,</span> <span class="token class-name">ScriptingCommands</span><span class="token punctuation">,</span> <span class="token class-name">BasicCommands</span><span class="token punctuation">,</span> <span class="token class-name">ClusterCommands</span><span class="token punctuation">,</span> <span class="token class-name">SentinelCommands</span><span class="token punctuation">,</span> <span class="token class-name">ModuleCommands</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">BinaryJedis</span> <span class="token keyword">implements</span> <span class="token class-name">BasicCommands</span><span class="token punctuation">,</span> <span class="token class-name">BinaryJedisCommands</span><span class="token punctuation">,</span> <span class="token class-name">MultiKeyBinaryCommands</span><span class="token punctuation">,</span>
        <span class="token class-name">AdvancedBinaryJedisCommands</span><span class="token punctuation">,</span> <span class="token class-name">BinaryScriptingCommands</span><span class="token punctuation">,</span> <span class="token class-name">Closeable</span> <span class="token punctuation">{</span>
    <span class="token keyword">protected</span> <span class="token class-name">Client</span> client <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
      <span class="token comment">// ...</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Client</span> <span class="token keyword">extends</span> <span class="token class-name">BinaryClient</span> <span class="token keyword">implements</span> <span class="token class-name">Commands</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">BinaryClient</span> <span class="token keyword">extends</span> <span class="token class-name">Connection</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Connection</span> <span class="token keyword">implements</span> <span class="token class-name">Closeable</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token class-name">Socket</span> socket<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">RedisOutputStream</span> outputStream<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">RedisInputStream</span> inputStream<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p>可以看到, Jedis 继承了 BinaryJedis, <strong>BinaryJedis 中保存了单个 Client 的实例, Client 最终继承了 Connection, Connection 中保存了单个 Socket 的实例, 和 Socket 对应的两个读写流</strong>. 因此, 一个 Jedis 对应一个 Socket 连接. 类图如下:</p> <p><img src="/img/a44c24268327ce4813567aa7449aa3ae-20230731165210-8s18hh8.png" alt=""></p> <p><strong>BinaryClient 封装了各种 Redis 命令, 其最终会调用基类 Connection 的方法, 使用 Protocol 类发送命令</strong>. 看一下 Protocol 类的 sendCommand 方法的源码, 可以发现其发送命令时是直接操作 RedisOutputStream 写入字节.</p> <p>在多线程环境下复用 Jedis 对象, 其实就是在复用 RedisOutputStream. <strong>如果多个线程在执行操作, 那么既无法确保整条命令以一个原子操作写入 Socket, 也无法确保写入后, 读取前没有其他数据写到远端</strong>:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">sendCommand</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">RedisOutputStream</span> os<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> command<span class="token punctuation">,</span>
                                <span class="token keyword">final</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        os<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token constant">ASTERISK_BYTE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        os<span class="token punctuation">.</span><span class="token function">writeIntCrLf</span><span class="token punctuation">(</span>args<span class="token punctuation">.</span>length <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        os<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token constant">DOLLAR_BYTE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        os<span class="token punctuation">.</span><span class="token function">writeIntCrLf</span><span class="token punctuation">(</span>command<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
        os<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>command<span class="token punctuation">)</span><span class="token punctuation">;</span>
        os<span class="token punctuation">.</span><span class="token function">writeCrLf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> arg <span class="token operator">:</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            os<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token constant">DOLLAR_BYTE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            os<span class="token punctuation">.</span><span class="token function">writeIntCrLf</span><span class="token punctuation">(</span>arg<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
            os<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
            os<span class="token punctuation">.</span><span class="token function">writeCrLf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">JedisConnectionException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p>看到这里也可以理解了, 为啥<strong>多线程情况下使用 Jedis 对象操作 Redis 会出现各种奇怪的问题</strong>.</p> <p>比如, <strong>写操作互相干扰, 多条命令相互穿插的话, 必然不是合法的 Redis 命令, 那么 Redis 会关闭客户端连接, 导致连接断开</strong>; 又比如, 线程 1 和 2 先后写入了 get a 和 get b 操作的请求, Redis 也返回了值 1 和 2, 但是线程 2 先读取了数据 1 就会出现数据错乱的问题.</p> <p>修复方式是, 使用 Jedis 提供的另一个<strong>线程安全的类 JedisPool 来获得 Jedis 的实例</strong>. JedisPool 可以声明为 static 在多个线程之间共享, 扮演连接池的角色. 使用时按需使用 try-with-resources 模式从 JedisPool 获得和归还 Jedis 实例.</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">JedisPool</span> jedisPool <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JedisPool</span><span class="token punctuation">(</span><span class="token string">&quot;127.0.0.1&quot;</span><span class="token punctuation">,</span> <span class="token number">6379</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">Jedis</span> jedis <span class="token operator">=</span> jedisPool<span class="token punctuation">.</span><span class="token function">getResource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">1000</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">String</span> result <span class="token operator">=</span> jedis<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;a&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>result<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">&quot;1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                log<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;Expect a to be 1 but found {}&quot;</span><span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">Jedis</span> jedis <span class="token operator">=</span> jedisPool<span class="token punctuation">.</span><span class="token function">getResource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">1000</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">String</span> result <span class="token operator">=</span> jedis<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;b&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>result<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">&quot;2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                log<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;Expect b to be 2 but found {}&quot;</span><span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><p>这样修复后, 代码不再有线程安全问题了. 此外最好通过 shutdownhook, 在程序退出之前关闭 JedisPool:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@PostConstruct</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Runtime</span><span class="token punctuation">.</span><span class="token function">getRuntime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addShutdownHook</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        jedisPool<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>看一下 Jedis 类 close 方法的实现可以发现, <strong>如果 Jedis 是从连接池获取的话, 那么 close 方法会调用连接池的 return 方法归还连接</strong>:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Jedis</span> <span class="token keyword">extends</span> <span class="token class-name">BinaryJedis</span> <span class="token keyword">implements</span> <span class="token class-name">JedisCommands</span><span class="token punctuation">,</span> <span class="token class-name">MultiKeyCommands</span><span class="token punctuation">,</span>
        <span class="token class-name">AdvancedJedisCommands</span><span class="token punctuation">,</span> <span class="token class-name">ScriptingCommands</span><span class="token punctuation">,</span> <span class="token class-name">BasicCommands</span><span class="token punctuation">,</span> <span class="token class-name">ClusterCommands</span><span class="token punctuation">,</span> <span class="token class-name">SentinelCommands</span><span class="token punctuation">,</span> <span class="token class-name">ModuleCommands</span> <span class="token punctuation">{</span>

    <span class="token keyword">protected</span> <span class="token class-name">JedisPoolAbstract</span> dataSource <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>dataSource <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">JedisPoolAbstract</span> pool <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>dataSource<span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>dataSource <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>client<span class="token punctuation">.</span><span class="token function">isBroken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                pool<span class="token punctuation">.</span><span class="token function">returnBrokenResource</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                pool<span class="token punctuation">.</span><span class="token function">returnResource</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p>如果<strong>不是, 则直接关闭连接, 其最终调用 Connection 类的 disconnect 方法来关闭 TCP 连接</strong>:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">disconnect</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isConnected</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            outputStream<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            socket<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            broken <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">JedisConnectionException</span><span class="token punctuation">(</span>ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token class-name">IOUtils</span><span class="token punctuation">.</span><span class="token function">closeQuietly</span><span class="token punctuation">(</span>socket<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>可以看到, <strong>Jedis 可以独立使用, 也可以配合连接池使用, 这个连接池就是 JedisPool</strong>. 再看看 JedisPool 的实现.</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">JedisPool</span> <span class="token keyword">extends</span> <span class="token class-name">JedisPoolAbstract</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Jedis</span> <span class="token function">getResource</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Jedis</span> jedis <span class="token operator">=</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">getResource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        jedis<span class="token punctuation">.</span><span class="token function">setDataSource</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> jedis<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">returnResource</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">Jedis</span> resource<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>resource <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                resource<span class="token punctuation">.</span><span class="token function">resetState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">returnResourceObject</span><span class="token punctuation">(</span>resource<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">returnBrokenResource</span><span class="token punctuation">(</span>resource<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">JedisException</span><span class="token punctuation">(</span><span class="token string">&quot;Resource is returned to the pool as broken&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">JedisPoolAbstract</span> <span class="token keyword">extends</span> <span class="token class-name">Pool</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Jedis</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">Pool</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">implements</span> <span class="token class-name">Closeable</span> <span class="token punctuation">{</span>
    <span class="token keyword">protected</span> <span class="token class-name">GenericObjectPool</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> internalPool<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br></div></div><p><strong>JedisPool 的 getResource 方法在拿到 Jedis 对象后, 将自己设置为了连接池</strong>. 连接池 JedisPool, 继承了 JedisPoolAbstract, 而后者继承了抽象类 Pool, Pool 内部维护了 Apache Common 的通用池 GenericObjectPool. JedisPool 的连接池就是基于 GenericObjectPool 的.</p> <p>看到这里就了解了, Jedis 的 API 实现是前面说的三种类型中的第一种, 也就是<strong>连接池和连接分离的 API</strong>, <strong>JedisPool 是线程安全的连接池, Jedis 是非线程安全的单一连接</strong>. 知道了原理之后, 再使用 Jedis 就胸有成竹了.</p> <h5 id="使用连接池务必确保复用"><a href="#使用连接池务必确保复用" class="header-anchor">#</a> 使用连接池务必确保复用</h5> <p>在介绍线程池的时候强调过, <strong>池一定是用来复用的, 否则其使用代价会比每次创建单一对象更大. 对连接池来说更是如此, 原因如下:</strong></p> <ol><li><strong>创建连接池的时候很可能一次性创建了多个连接, 大多数连接池考虑到性能</strong>, 会在初始化的时候维护一定数量的最小连接(毕竟初始化连接池的过程一般是一次性的), 可以直接使用. 如果每次使用连接池都按需创建连接池, 那么很可能只用到一个连接, 但是创建了 N 个连接.</li> <li>连接池一般会有一些管理模块, 也就是连接池的结构示意图中的绿色部分. 举个例子, 大多数的连接池都有闲置超时的概念. 连接池会检测连接的闲置时间, 定期回收闲置的连接, 把活跃连接数降到最低(闲置)连接的配置值, 减轻服务端的压力. 一般情况下, 闲置连接由独立线程管理, 启动了空闲检测的连接池相当于还会启动一个线程. 此外, 有些连接池还需要独立线程负责连接保活等功能. 因此, <strong>启动一个连接池相当于启动了 N 个线程</strong>.</li></ol> <p>除了使用代价, 连接池不释放, 还可能会引起线程泄露. 接下来就以 Apache HttpClient 为例, 说说连接池不复用的问题.</p> <p>首先, 创建一个 CloseableHttpClient, 设置使用 <strong>PoolingHttpClientConnectionManager</strong> 连接池并启用空闲连接驱逐策略, 最大空闲时间为 60 秒, 然后使用这个连接来请求一个会返回 OK 字符串的服务端接口:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;wrong1&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">wrong1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">CloseableHttpClient</span> client <span class="token operator">=</span> <span class="token class-name">HttpClients</span><span class="token punctuation">.</span><span class="token function">custom</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">setConnectionManager</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">PoolingHttpClientConnectionManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">evictIdleConnections</span><span class="token punctuation">(</span><span class="token number">60</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
    <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">CloseableHttpResponse</span> response <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">HttpGet</span><span class="token punctuation">(</span><span class="token string">&quot;http://127.0.0.1:45678/httpclientnotreuse/test&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">EntityUtils</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">getEntity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        ex<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>访问这个接口几次后查看应用线程情况, 可以看到有大量叫作 Connection evictor 的线程, 且这些线程不会销毁:</p> <p><img src="/img/6caa8e5f15a7b353f9d647cd9ebf4324-20230731165210-tdfsokn.png" alt=""></p> <p>对这个接口进行几秒的压测(压测使用 wrk, 1 个并发 1 个连接)可以看到, 已经建立了三千多个 TCP 连接到 45678 端口(其中有 1 个是压测客户端到 Tomcat 的连接, 大部分都是 HttpClient 到 Tomcat 的连接):</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>lsof <span class="token operator">-</span>nP <span class="token operator">-</span>i4TCP<span class="token operator">:</span><span class="token number">45678</span> <span class="token operator">|</span> wc <span class="token operator">-</span>l
<span class="token number">3686</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>好在有了空闲连接回收的策略, 60 秒之后连接处于 CLOSE_WAIT 状态, 最终彻底关闭.</p> <p><img src="/img/fef8abb8824063e952023430a3f89f1b-20230731165210-1iwo7wp.png" alt=""></p> <p>这 2 点证明, CloseableHttpClient 属于第二种模式, 即<strong>内部带有连接池的 API, 其背后是连接池, 最佳实践一定是复用</strong>.</p> <p>复用方式很简单, <strong>可以把 CloseableHttpClient 声明为 static, 只创建一次, 并且在 JVM 关闭之前通过 addShutdownHook 钩子关闭连接池, 在使用的时候直接使用 CloseableHttpClient 即可, 无需每次都创建</strong>.</p> <p>首先, 定义一个 right 接口来实现服务端接口调用:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">CloseableHttpClient</span> httpClient <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

<span class="token keyword">static</span> <span class="token punctuation">{</span>
    <span class="token comment">// 当然, 也可以把CloseableHttpClient定义为Bean, 然后在@PreDestroy标记的方法内close这个HttpClient</span>
    httpClient <span class="token operator">=</span> <span class="token class-name">HttpClients</span><span class="token punctuation">.</span><span class="token function">custom</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setMaxConnPerRoute</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setMaxConnTotal</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">evictIdleConnections</span><span class="token punctuation">(</span><span class="token number">60</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Runtime</span><span class="token punctuation">.</span><span class="token function">getRuntime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addShutdownHook</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            httpClient<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> ignored<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;right&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">right</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">CloseableHttpResponse</span> response <span class="token operator">=</span> httpClient<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">HttpGet</span><span class="token punctuation">(</span><span class="token string">&quot;http://127.0.0.1:45678/httpclientnotreuse/test&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">EntityUtils</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">getEntity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        ex<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><p>然后, 重新定义一个 wrong2 接口, 修复之前按需创建 CloseableHttpClient 的代码, 每次用完之后确保连接池可以关闭:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;wrong2&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">wrong2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">CloseableHttpClient</span> client <span class="token operator">=</span> <span class="token class-name">HttpClients</span><span class="token punctuation">.</span><span class="token function">custom</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">setConnectionManager</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">PoolingHttpClientConnectionManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">evictIdleConnections</span><span class="token punctuation">(</span><span class="token number">60</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token class-name">CloseableHttpResponse</span> response <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">HttpGet</span><span class="token punctuation">(</span><span class="token string">&quot;http://127.0.0.1:45678/httpclientnotreuse/test&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">EntityUtils</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">getEntity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        ex<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>使用 wrk 对 wrong2 和 right 两个接口分别压测 60 秒, 可以看到两种使用方式性能上的差异, 每次创建连接池的 QPS 是 337, 而复用连接池的 QPS 是 2022:</p> <p><img src="/img/fca858457cb83a4b3e3341425ebef1ed-20230731165210-ts7uht3.png" alt=""></p> <p>如此大的性能差异显然是因为 <strong>TCP 连接的复用</strong>. 你可能注意到了, 刚才定义连接池时, 将最大连接数设置为 1. 所以, <strong>复用连接池方式复用的始终应该是同一个连接, 而新建连接池方式应该是每次都会创建新的 TCP 连接</strong>.</p> <p>接下来通过网络抓包工具 Wireshark 来证实这一点.</p> <p>如果调用 wrong2 接口每次创建新的连接池来发起 HTTP 请求, 从 Wireshark 可以看到, 每次请求服务端 45678 的客户端端口都是新的. 这里发起了三次请求, 程序通过 HttpClient 访问服务端 45678 的客户端端口号, 分别是 51677, 51679 和 51681:</p> <p><img src="/img/fa4c460710976593e763ea388b517a8c-20230731165210-1ixw6xa.png" alt=""></p> <p>也就是说, <strong>每次都是新的 TCP 连接, 放开 HTTP 这个过滤条件也可以看到完整的 TCP 握手</strong>, 挥手的过程:</p> <p><img src="/img/1c26841e40989982302b6f2e8869dc32-20230731165210-dwnpr8s.png" alt=""></p> <p>而复用连接池方式的接口 right 的表现就完全不同了. 可以看到, 第二次 HTTP 请求 <code>#41</code>​ 的客户端端口 61468 和第一次连接 <code>#23</code>​ 的<strong>端口是一样</strong>的, Wireshark 也提示了整个 TCP 会话中, 当前 <code>#41</code>​ 请求是第二次请求, 前一次是 <code>#23</code>​, 后面一次是 <code>#75</code>​:</p> <p><img src="/img/17aba99914bdd530ba98c0929e0a4cf0-20230731165210-wiclidp.png" alt=""></p> <p><strong>只有 TCP 连接闲置超过 60 秒后才会断开, 连接池会新建连接</strong>. 可以尝试通过 Wireshark 观察这一过程.</p> <h5 id="连接池的配置不是一成不变的"><a href="#连接池的配置不是一成不变的" class="header-anchor">#</a> 连接池的配置不是一成不变的</h5> <p>接下来继续聊聊<strong>连接池的配置问题</strong>.</p> <p>为方便根据容量规划设置连接处的属性, 连接池提供了许多参数, <strong>包括最小(闲置)连接, 最大连接, 闲置连接生存时间, 连接生存时间</strong>等. 其中, 最重要的参数是最大连接数, 它决定了连接池能使用的连接数量上限, 达到上限后, 新来的请求需要等待其他请求释放连接.</p> <p>但<strong>最大连接数不是设置得越大越好</strong>. 如果设置得太大, 不仅仅是客户端需要耗费过多的资源维护连接, 更重要的是由于服务端对应的是多个客户端, 每一个客户端都保持大量的连接, 会给服务端带来更大的压力. 这个压力又不仅仅是内存压力, 可以想一下如果服务端的网络模型是一个 TCP 连接一个线程, 那么几千个连接意味着几千个线程, 如此多的线程会造成大量的线程切换开销. 当然, <strong>连接池最大连接数设置得太小, 很可能会因为获取连接的等待时间太长, 导致吞吐量低下, 甚至超时无法获取连接</strong>.</p> <p>接下来就模拟下压力增大导致数据库连接池打满的情况, 来实践下如何确认连接池的使用情况, 以及有针对性地进行参数优化.</p> <p>首先, 定义一个用户注册方法, 通过 @Transactional 注解为方法开启事务. 其中包含了 500 毫秒的休眠, 一个数据库事务对应一个 TCP 连接, 所以 500 多毫秒的时间都会占用数据库连接:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Transactional</span>
<span class="token keyword">public</span> <span class="token class-name">User</span> <span class="token function">register</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token class-name">User</span> user <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    user<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">&quot;new-user-&quot;</span><span class="token operator">+</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    userRepository<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">MILLISECONDS</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> user<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>随后修改配置文件启用 register-mbeans, 使 Hikari 连接池能通过 JMX MBean 注册连接池相关统计信息, 方便观察连接池:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>spring<span class="token punctuation">.</span>datasource<span class="token punctuation">.</span>hikari<span class="token punctuation">.</span>register<span class="token operator">-</span>mbeans<span class="token operator">=</span><span class="token boolean">true</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>启动程序并通过 JConsole 连接进程后, 可以看到默认情况下最大连接数为 10:</p> <p><img src="/img/3d03ded75eda2ea6e243c54c1b7ceb67-20230731165210-wcd8t2g.png" alt=""></p> <p>使用 wrk 对应用进行压测, 可以看到连接数一下子从 0 到了 10, 有 20 个线程在等待获取连接:</p> <p><img src="/img/9020e171e08d9e752c02bdb2ad227c22-20230731165210-irvzvfo.png" alt=""></p> <p>不久就出现了无法获取数据库连接的异常, 如下所示:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token punctuation">[</span><span class="token number">15</span><span class="token operator">:</span><span class="token number">37</span><span class="token operator">:</span><span class="token number">56.156</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>http<span class="token operator">-</span>nio<span class="token operator">-</span><span class="token number">45678</span><span class="token operator">-</span>exec<span class="token operator">-</span><span class="token number">15</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token constant">ERROR</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token punctuation">.</span>a<span class="token punctuation">.</span>c<span class="token punctuation">.</span>c<span class="token punctuation">.</span>C<span class="token punctuation">.</span><span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">[</span><span class="token operator">/</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token punctuation">[</span>dispatcherServlet<span class="token punctuation">]</span><span class="token operator">:</span><span class="token number">175</span> <span class="token punctuation">]</span> <span class="token operator">-</span> <span class="token class-name">Servlet</span><span class="token punctuation">.</span><span class="token function">service</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">for</span> servlet <span class="token punctuation">[</span>dispatcherServlet<span class="token punctuation">]</span> in context <span class="token keyword">with</span> <span class="token namespace">path</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> threw exception <span class="token punctuation">[</span><span class="token class-name">Request</span> processing failed<span class="token punctuation">;</span> nested exception is <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>dao<span class="token punctuation">.</span></span>DataAccessResourceFailureException</span><span class="token operator">:</span> unable <span class="token keyword">to</span> <span class="token namespace">obtain</span> isolated <span class="token class-name">JDBC</span> connection<span class="token punctuation">;</span> nested exception is <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>hibernate<span class="token punctuation">.</span>exception<span class="token punctuation">.</span></span>JDBCConnectionException</span><span class="token operator">:</span> unable <span class="token keyword">to</span> <span class="token namespace">obtain</span> isolated <span class="token constant">JDBC</span> connection<span class="token punctuation">]</span> <span class="token keyword">with</span> <span class="token namespace">root</span> cause
<span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>sql<span class="token punctuation">.</span></span>SQLTransientConnectionException</span><span class="token operator">:</span> <span class="token class-name">HikariPool</span><span class="token operator">-</span><span class="token number">1</span> <span class="token operator">-</span> <span class="token class-name">Connection</span> is not available<span class="token punctuation">,</span> request timed out after <span class="token number">30000</span>ms<span class="token punctuation">.</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>从异常信息中可以看到, 数据库连接池是 HikariPool, 解决方式很简单, 修改一下配置文件, <strong>调整数据库连接池最大连接参数到 50 即可</strong>.</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>spring<span class="token punctuation">.</span>datasource<span class="token punctuation">.</span>hikari<span class="token punctuation">.</span>maximum<span class="token operator">-</span>pool<span class="token operator">-</span>size<span class="token operator">=</span><span class="token number">50</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>然后再观察一下这个参数是否适合当前压力, 满足需求的同时也不占用过多资源. 从监控来看这个调整是合理的, 有一半的富余资源, 再也没有线程需要等待连接了:</p> <p><img src="/img/73abc6eee8ef5945198badba076e584b-20230731165210-avqtkux.png" alt=""></p> <p>在这个 Demo 里, 可以知道压测大概能对应使用 25 左右的并发连接, 所以直接把连接池最大连接设置为了 50. 在真实情况下, 只要数据库可以承受, 可以选择在遇到连接超限的时候先设置一个足够大的连接数, 然后观察最终应用的并发, 再<strong>按照实际并发数留出一半的余量来设置最终的最大连接</strong>.</p> <p>其实, 看到错误日志后再调整已经有点儿晚了. 更合适的做法是, <mark><strong>对类似数据库连接池的重要资源进行持续检测, 并设置一半的使用量作为报警阈值, 出现预警后及时扩容</strong></mark>.</p> <p>在这里是为了演示, 才通过 JConsole 查看参数配置后的效果, 生产上需要把相关数据对接到指标监控体系中持续监测.</p> <p><strong>这里要强调的是, 修改配置参数务必验证是否生效, 并且在监控系统中确认参数是否生效, 是否合理. 之所以要 &quot;强调&quot;, 是因为这里有坑</strong>.</p> <p>我之前就遇到过这样一个事故. 应用准备针对大促活动进行扩容, 把数据库配置文件中 Druid 连接池最大连接数 maxActive 从 50 提高到了 100, <strong>修改后并没有通过监控验证</strong>, 结果大促当天应用因为连接池连接数不够爆了. 经排查发现, 当时<strong>修改的连接数并没有生效</strong>. 原因是, 应用<strong>虽然一开始使用的是 Druid 连接池, 但后来框架升级了, 把连接池替换为了 Hikari 实现, 原来的那些配置其实都是无效的, 修改后的参数配置当然也不会生效</strong>.</p> <p>所以说, 对连接池进行调参, 一定要眼见为实.</p> <h5 id="重点回顾-4"><a href="#重点回顾-4" class="header-anchor">#</a> 重点回顾</h5> <p>今天以三种业务代码最常用的 Redis 连接池, HTTP 连接池, 数据库连接池为例, 探讨了有关连接池实现方式, 使用姿势和参数配置的三大问题.</p> <p>客户端 SDK 实现连接池的方式, 包括池和连接分离, 内部带有连接池和非连接池三种. <strong>要正确使用连接池, 就必须首先鉴别连接池的实现方式</strong>. 比如, Jedis 的 API 实现的是池和连接分离的方式, 而 Apache HttpClient 是内置连接池的 API.</p> <p>对于使用姿势其实就是两点, <strong>一是确保连接池是复用的, 二是尽可能在程序退出之前显式关闭连接池释放资源</strong>. 连接池设计的初衷就是为了保持一定量的连接, 这样连接可以随取随用. 从连接池获取连接虽然很快, 但连接池的初始化会比较慢, 需要做一些管理模块的初始化以及初始最小闲置连接. 一旦连接池不是复用的, 那么其性能会比随时创建单一连接更差.</p> <p>最后, 连接池参数配置中, 最重要的是最大连接数, 许多高并发应用往往因为最大连接数不够导致性能问题. 但最大连接数不是设置得越大越好, 够用就好. 需要注意的是, 针对数据库连接池, HTTP 连接池, Redis 连接池等重要连接池, 务必建立完善的监控和报警机制, 根据容量规划及时调整参数配置.</p> <h4 id="_05-http调用-你考虑到超时-重试-并发了吗"><a href="#_05-http调用-你考虑到超时-重试-并发了吗" class="header-anchor">#</a> 05-HTTP调用:你考虑到超时,重试,并发了吗?</h4> <p>今天一起聊聊进行 <strong>HTTP 调用需要注意的超时, 重试, 并发</strong>等问题.</p> <p>与执行本地方法不同, 进行 HTTP 调用本质上是<strong>通过 HTTP 协议进行一次网络请求</strong>. 网络请求必然有超时的可能性, 因此必须考虑到这三点:</p> <ol><li>首先, 框架设置的默认超时是否合理;</li> <li>其次, 考虑到网络的不稳定, 超时后的请求重试是一个不错的选择, 但需要考虑服务端接口的幂等性设计是否允许重试;</li> <li>最后, 需要考虑框架是否会像浏览器那样限制并发连接数, 以免在服务并发很大的情况下, HTTP 调用的并发数限制成为瓶颈.</li></ol> <p>Spring Cloud 是 Java 微服务架构的代表性框架. 如果使用 Spring Cloud 进行微服务开发, 就会<strong>使用 Feign 进行声明式的服务调用</strong>. 如果不使用 Spring Cloud, 而直接使用 Spring Boot 进行微服务开发的话, 可能会直接使用 Java 中最常用的 HTTP 客户端 Apache HttpClient 进行服务调用.</p> <p>接下来就看看使用 Feign 和 Apache HttpClient 进行 HTTP 接口调用时, 可能会遇到的超时, 重试和并发方面的坑.</p> <h5 id="配置连接超时和读取超时参数的学问"><a href="#配置连接超时和读取超时参数的学问" class="header-anchor">#</a> 配置连接超时和读取超时参数的学问</h5> <p>对于 HTTP 调用, 虽然应用层走的是 HTTP 协议, 但网络层面始终是 TCP/IP 协议. TCP/IP 是面向连接的协议, 在传输数据之前需要建立连接. 几乎所有的网络框架都会提供这么两个超时参数:</p> <ol><li><strong>连接超时参数 ConnectTimeout, 让用户配置建连阶段的最长等待时间;</strong></li> <li><strong>读取超时参数 ReadTimeout, 用来控制从 Socket 上读取数据的最长等待时间.</strong></li></ol> <p>这两个参数看似是网络层偏底层的配置参数, 不足以引起开发同学的重视. 但正确理解和配置这两个参数, 对业务应用特别重要, 毕竟超时不是单方面的事情, 需要客户端和服务端对超时有一致的估计, 协同配合方能平衡吞吐量和错误率.</p> <p>**连接超时参数和连接超时的误区有这么两个: **</p> <ol><li><strong>连接超时配置得特别长, 比如 60 秒.</strong>  一般来说, TCP 三次握手建立连接需要的时间非常短, 通常在毫秒级最多到秒级, 不可能需要十几秒甚至几十秒. 如果很久都无法建连, 很可能是网络或防火墙配置的问题. 这种情况下, 如果几秒连接不上, 那么可能永远也连接不上. 因此<strong>设置特别长的连接超时意义不大, 将其配置得短一些(比如 1~5 秒)即可</strong>. 如果是纯内网调用的话, 这个参数可以设置得更短, 在下游服务离线无法连接的时候, 可以快速失败.</li> <li><strong>排查连接超时问题, 却没理清连的是哪里.</strong>  通常情况下, 服务会有多个节点, 如果别的客户端通过客户端负载均衡技术来连接服务端, 那么客户端和服务端会直接建立连接, 此时出现连接超时大概率是服务端的问题; 而如果服务端通过类似 Nginx 的反向代理来负载均衡, 客户端连接的其实是 Nginx, 而不是服务端, 此时出现连接超时应该排查 Nginx.</li></ol> <p>**读取超时参数和读取超时则会有更多的误区, 我将其归纳为如下三个. **</p> <p>**第一个误区: **认为出现了读取超时, 服务端的执行就会中断.</p> <p>来简单测试下. 定义一个 client 接口, 内部通过 HttpClient 调用服务端接口 server, 客户端读取超时 2 秒, 服务端接口执行耗时 5 秒.</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@RestController</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">&quot;clientreadtimeout&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ClientReadTimeoutController</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> <span class="token function">getResponse</span><span class="token punctuation">(</span><span class="token class-name">String</span> url<span class="token punctuation">,</span> <span class="token keyword">int</span> connectTimeout<span class="token punctuation">,</span> <span class="token keyword">int</span> readTimeout<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">Request<span class="token punctuation">.</span>Get</span><span class="token punctuation">(</span><span class="token string">&quot;http://localhost:45678/clientreadtimeout&quot;</span> <span class="token operator">+</span> url<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">connectTimeout</span><span class="token punctuation">(</span>connectTimeout<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">socketTimeout</span><span class="token punctuation">(</span>readTimeout<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">returnContent</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">asString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;client&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">client</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;client1 called&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 服务端5s超时, 客户端读取超时2秒</span>
        <span class="token keyword">return</span> <span class="token function">getResponse</span><span class="token punctuation">(</span><span class="token string">&quot;/server?timeout=5000&quot;</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;server&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">server</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;timeout&quot;</span><span class="token punctuation">)</span> <span class="token keyword">int</span> timeout<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;server called&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">MILLISECONDS</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span>timeout<span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;Done&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><p>调用 client 接口后, 从日志中可以看到, <strong>客户端 2 秒后出现了 SocketTimeoutException, 原因是读取超时, 服务端却丝毫没受影响在 3 秒后执行完成</strong>.</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token punctuation">[</span><span class="token number">11</span><span class="token operator">:</span><span class="token number">35</span><span class="token operator">:</span><span class="token number">11.943</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>http<span class="token operator">-</span>nio<span class="token operator">-</span><span class="token number">45678</span><span class="token operator">-</span>exec<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token constant">INFO</span> <span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token punctuation">.</span>t<span class="token punctuation">.</span>c<span class="token punctuation">.</span>c<span class="token punctuation">.</span>d<span class="token punctuation">.</span>ClientReadTimeoutController<span class="token operator">:</span><span class="token number">29</span>  <span class="token punctuation">]</span> <span class="token operator">-</span> client1 called
<span class="token punctuation">[</span><span class="token number">11</span><span class="token operator">:</span><span class="token number">35</span><span class="token operator">:</span><span class="token number">12.032</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>http<span class="token operator">-</span>nio<span class="token operator">-</span><span class="token number">45678</span><span class="token operator">-</span>exec<span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token constant">INFO</span> <span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token punctuation">.</span>t<span class="token punctuation">.</span>c<span class="token punctuation">.</span>c<span class="token punctuation">.</span>d<span class="token punctuation">.</span>ClientReadTimeoutController<span class="token operator">:</span><span class="token number">36</span>  <span class="token punctuation">]</span> <span class="token operator">-</span> server called
<span class="token punctuation">[</span><span class="token number">11</span><span class="token operator">:</span><span class="token number">35</span><span class="token operator">:</span><span class="token number">14.042</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>http<span class="token operator">-</span>nio<span class="token operator">-</span><span class="token number">45678</span><span class="token operator">-</span>exec<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token constant">ERROR</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token punctuation">.</span>a<span class="token punctuation">.</span>c<span class="token punctuation">.</span>c<span class="token punctuation">.</span>C<span class="token punctuation">.</span><span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">[</span><span class="token operator">/</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token punctuation">[</span>dispatcherServlet<span class="token punctuation">]</span><span class="token operator">:</span><span class="token number">175</span> <span class="token punctuation">]</span> <span class="token operator">-</span> <span class="token class-name">Servlet</span><span class="token punctuation">.</span><span class="token function">service</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">for</span> servlet <span class="token punctuation">[</span>dispatcherServlet<span class="token punctuation">]</span> in context <span class="token keyword">with</span> <span class="token namespace">path</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> threw exception
<span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>net<span class="token punctuation">.</span></span>SocketTimeoutException</span><span class="token operator">:</span> <span class="token class-name">Read</span> timed out
  at <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>net<span class="token punctuation">.</span></span>SocketInputStream</span><span class="token punctuation">.</span><span class="token function">socketRead0</span><span class="token punctuation">(</span><span class="token class-name">Native</span> <span class="token class-name">Method</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">[</span><span class="token number">11</span><span class="token operator">:</span><span class="token number">35</span><span class="token operator">:</span><span class="token number">17.036</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>http<span class="token operator">-</span>nio<span class="token operator">-</span><span class="token number">45678</span><span class="token operator">-</span>exec<span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token constant">INFO</span> <span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token punctuation">.</span>t<span class="token punctuation">.</span>c<span class="token punctuation">.</span>c<span class="token punctuation">.</span>d<span class="token punctuation">.</span>ClientReadTimeoutController<span class="token operator">:</span><span class="token number">38</span>  <span class="token punctuation">]</span> <span class="token operator">-</span> <span class="token class-name">Do</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p><strong>类似 Tomcat 的 Web 服务器都是把服务端请求提交到线程池处理的, 只要服务端收到了请求, 网络层面的超时和断开便不会影响服务端的执行. 因此, 出现读取超时不能随意假设服务端的处理情况, 需要根据业务状态考虑如何进行后续处理.</strong></p> <p>**第二个误区: **认为读取超时只是 Socket 网络层面的概念, 是数据传输的最长耗时, 故将其配置得非常短, 比如 100 毫秒.</p> <p>其实, 发生了读取超时, <strong>网络层面无法区分是服务端没有把数据返回给客户端, 还是数据在网络上耗时较久或丢包</strong>.</p> <p>但因为 TCP 是先建立连接后传输数据, 对于网络情况不是特别糟糕的服务调用, 通常可以认为出现连接超时是网络问题或服务不在线, 而出现读取超时是服务处理超时. 确切地说, 读取超时指的是, 向 Socket 写入数据后, 等到 Socket 返回数据的超时时间, 其中包含的时间或者说绝大部分的时间, 是服务端处理业务逻辑的时间.</p> <p>**第三个误区: **认为超时时间越长任务接口成功率就越高, 将读取超时参数配置得太长.</p> <p>进行 HTTP 请求一般是需要获得结果的, 属于<strong>同步调用</strong>. 如果超时时间很长, 在等待服务端返回数据的同时, 客户端线程(通常是 Tomcat 线程)也在等待, 当下游服务出现大量超时的时候, 程序可能也会受到拖累创建大量线程, 最终崩溃.</p> <p>对定时任务或异步任务来说, 读取超时配置得长些问题不大. <strong>但面向用户响应的请求或是微服务短平快的同步接口调用, 并发量一般较大, 应该设置一个较短的读取超时时间, 以防止被下游服务拖慢</strong>, 通常不会设置超过 30 秒的读取超时.</p> <p>你可能会说, 如果把读取超时设置为 2 秒, 服务端接口需要 3 秒, 岂不是永远都拿不到执行结果了? 的确是这样, 因此设置读取超时一定要根据实际情况, <strong>过长可能会让下游抖动影响到自己, 过短又可能影响成功率</strong>. 甚至, 有些时候还要根据下游服务的 SLA, 为不同的服务端接口设置不同的客户端读取超时.</p> <h5 id="feign和ribbon配合使用-你知道怎么配置超时吗"><a href="#feign和ribbon配合使用-你知道怎么配置超时吗" class="header-anchor">#</a> Feign和Ribbon配合使用,你知道怎么配置超时吗?</h5> <p>刚才强调了根据自己的需求配置连接超时和读取超时的重要性, 你是否尝试过为 Spring Cloud 的 Feign 配置超时参数呢, 有没有被网上的各种资料绕晕呢?</p> <p>在我看来, 为 Feign 配置超时参数的复杂之处在于, <strong>Feign 自己有两个超时参数, 它使用的负载均衡组件 Ribbon 本身还有相关配置</strong>. 那么, 这些配置的优先级是怎样的, 又哪些什么坑呢? 接下来做一些实验.</p> <p>为测试服务端的超时, 假设有这么一个服务端接口, 什么都不干只休眠 10 分钟:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/server&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">server</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
    <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">MINUTES</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>首先, 定义一个 Feign 来调用这个接口:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@FeignClient</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;clientsdk&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">Client</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/feignandribbon/server&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">void</span> <span class="token function">server</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>然后, 通过 Feign Client 进行接口调用:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;client&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">timeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">long</span> begin <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        client<span class="token punctuation">.</span><span class="token function">server</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> ex<span class="token punctuation">)</span><span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;执行耗时: {}ms 错误: {}&quot;</span><span class="token punctuation">,</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> begin<span class="token punctuation">,</span> ex<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>在配置文件仅指定服务端地址的情况下:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>clientsdk<span class="token punctuation">.</span>ribbon<span class="token punctuation">.</span>listOfServers<span class="token operator">=</span>localhost<span class="token operator">:</span><span class="token number">45678</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>得到如下输出:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token punctuation">[</span><span class="token number">15</span><span class="token operator">:</span><span class="token number">40</span><span class="token operator">:</span><span class="token number">16.094</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>http<span class="token operator">-</span>nio<span class="token operator">-</span><span class="token number">45678</span><span class="token operator">-</span>exec<span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token constant">WARN</span> <span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>g<span class="token punctuation">.</span>t<span class="token punctuation">.</span>c<span class="token punctuation">.</span>h<span class="token punctuation">.</span>f<span class="token punctuation">.</span></span>FeignAndRibbonController</span>    <span class="token operator">:</span><span class="token number">26</span>  <span class="token punctuation">]</span> <span class="token operator">-</span> 执行耗时<span class="token operator">:</span> <span class="token number">1007</span>ms 错误<span class="token operator">:</span> <span class="token class-name">Read</span> timed out executing <span class="token constant">POST</span> http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>clientsdk<span class="token operator">/</span>feignandribbon<span class="token operator">/</span>server
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>从这个输出中, 可以得到<strong>结论一, 默认情况下 Feign 的读取超时是 1 秒, 如此短的读取超时算是坑点一</strong>.</p> <p>来分析一下源码. 打开 RibbonClientConfiguration 类后, 会看到 DefaultClientConfigImpl 被创建出来之后, ReadTimeout 和 ConnectTimeout 被设置为 1s:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
 * Ribbon client default connect timeout.
 */</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">DEFAULT_CONNECT_TIMEOUT</span> <span class="token operator">=</span> <span class="token number">1000</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * Ribbon client default read timeout.
 */</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">DEFAULT_READ_TIMEOUT</span> <span class="token operator">=</span> <span class="token number">1000</span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Bean</span>
<span class="token annotation punctuation">@ConditionalOnMissingBean</span>
<span class="token keyword">public</span> <span class="token class-name">IClientConfig</span> <span class="token function">ribbonClientConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">DefaultClientConfigImpl</span> config <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultClientConfigImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    config<span class="token punctuation">.</span><span class="token function">loadProperties</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    config<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token class-name">CommonClientConfigKey<span class="token punctuation">.</span>ConnectTimeout</span><span class="token punctuation">,</span> <span class="token constant">DEFAULT_CONNECT_TIMEOUT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    config<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token class-name">CommonClientConfigKey<span class="token punctuation">.</span>ReadTimeout</span><span class="token punctuation">,</span> <span class="token constant">DEFAULT_READ_TIMEOUT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    config<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token class-name">CommonClientConfigKey<span class="token punctuation">.</span>GZipPayload</span><span class="token punctuation">,</span> <span class="token constant">DEFAULT_GZIP_PAYLOAD</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> config<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><p>如果要修改 Feign 客户端默认的两个全局超时时间, 可以设置 <code>feign.client.config.default.readTimeout</code>​ 和 <code>feign.client.config.default.connectTimeout</code>​ 参数:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>feign<span class="token punctuation">.</span>client<span class="token punctuation">.</span>config<span class="token punctuation">.</span><span class="token keyword">default</span><span class="token punctuation">.</span>readTimeout<span class="token operator">=</span><span class="token number">3000</span>
feign<span class="token punctuation">.</span>client<span class="token punctuation">.</span>config<span class="token punctuation">.</span><span class="token keyword">default</span><span class="token punctuation">.</span>connectTimeout<span class="token operator">=</span><span class="token number">3000</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>修改配置后重试, 得到如下日志:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token punctuation">[</span><span class="token number">15</span><span class="token operator">:</span><span class="token number">43</span><span class="token operator">:</span><span class="token number">39.955</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>http<span class="token operator">-</span>nio<span class="token operator">-</span><span class="token number">45678</span><span class="token operator">-</span>exec<span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token constant">WARN</span> <span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>g<span class="token punctuation">.</span>t<span class="token punctuation">.</span>c<span class="token punctuation">.</span>h<span class="token punctuation">.</span>f<span class="token punctuation">.</span></span>FeignAndRibbonController</span>    <span class="token operator">:</span><span class="token number">26</span>  <span class="token punctuation">]</span> <span class="token operator">-</span> 执行耗时<span class="token operator">:</span> <span class="token number">3006</span>ms 错误<span class="token operator">:</span> <span class="token class-name">Read</span> timed out executing <span class="token constant">POST</span> http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>clientsdk<span class="token operator">/</span>feignandribbon<span class="token operator">/</span>server
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>可见, 3 秒读取超时生效了. 注意: 这里有一个大坑, 如果希望只修改读取超时, 可能会只配置这么一行:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>feign<span class="token punctuation">.</span>client<span class="token punctuation">.</span>config<span class="token punctuation">.</span><span class="token keyword">default</span><span class="token punctuation">.</span>readTimeout<span class="token operator">=</span><span class="token number">3000</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>测试一下就会发现, 这样的配置是无法生效的!</p> <p><strong>结论二, 也是坑点二, 如果要配置 Feign 的读取超时, 就必须同时配置连接超时, 才能生效</strong>.</p> <p>打开 FeignClientFactoryBean 可以看到, <strong>只有同时设置 ConnectTimeout 和 ReadTimeout, Request.Options 才会被覆盖</strong>:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">if</span> <span class="token punctuation">(</span>config<span class="token punctuation">.</span><span class="token function">getConnectTimeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> config<span class="token punctuation">.</span><span class="token function">getReadTimeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   builder<span class="token punctuation">.</span><span class="token function">options</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Request<span class="token punctuation">.</span>Options</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span><span class="token function">getConnectTimeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
         config<span class="token punctuation">.</span><span class="token function">getReadTimeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>更进一步, 如果希望针对单独的 Feign Client 设置超时时间, 可以把 default 替换为 Client 的 name:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>feign<span class="token punctuation">.</span>client<span class="token punctuation">.</span>config<span class="token punctuation">.</span><span class="token keyword">default</span><span class="token punctuation">.</span>readTimeout<span class="token operator">=</span><span class="token number">3000</span>
feign<span class="token punctuation">.</span>client<span class="token punctuation">.</span>config<span class="token punctuation">.</span><span class="token keyword">default</span><span class="token punctuation">.</span>connectTimeout<span class="token operator">=</span><span class="token number">3000</span>
feign<span class="token punctuation">.</span>client<span class="token punctuation">.</span>config<span class="token punctuation">.</span>clientsdk<span class="token punctuation">.</span>readTimeout<span class="token operator">=</span><span class="token number">2000</span>
feign<span class="token punctuation">.</span>client<span class="token punctuation">.</span>config<span class="token punctuation">.</span>clientsdk<span class="token punctuation">.</span>connectTimeout<span class="token operator">=</span><span class="token number">2000</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>可以得出<strong>结论三, 单独的超时可以覆盖全局超时, 这符合预期, 不算坑</strong>:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token punctuation">[</span><span class="token number">15</span><span class="token operator">:</span><span class="token number">45</span><span class="token operator">:</span><span class="token number">51.708</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>http<span class="token operator">-</span>nio<span class="token operator">-</span><span class="token number">45678</span><span class="token operator">-</span>exec<span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token constant">WARN</span> <span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>g<span class="token punctuation">.</span>t<span class="token punctuation">.</span>c<span class="token punctuation">.</span>h<span class="token punctuation">.</span>f<span class="token punctuation">.</span></span>FeignAndRibbonController</span>    <span class="token operator">:</span><span class="token number">26</span>  <span class="token punctuation">]</span> <span class="token operator">-</span> 执行耗时<span class="token operator">:</span> <span class="token number">2006</span>ms 错误<span class="token operator">:</span> <span class="token class-name">Read</span> timed out executing <span class="token constant">POST</span> http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>clientsdk<span class="token operator">/</span>feignandribbon<span class="token operator">/</span>server
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><strong>结论四, 除了可以配置 Feign, 也可以配置 Ribbon 组件的参数来修改两个超时时间. 这里的坑点三是, 参数首字母要大写, 和 Feign 的配置不同</strong>.</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name"><span class="token namespace">ribbon<span class="token punctuation">.</span></span>ReadTimeout</span><span class="token operator">=</span><span class="token number">4000</span>
<span class="token class-name"><span class="token namespace">ribbon<span class="token punctuation">.</span></span>ConnectTimeout</span><span class="token operator">=</span><span class="token number">4000</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>可以通过日志证明参数生效:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token punctuation">[</span><span class="token number">15</span><span class="token operator">:</span><span class="token number">55</span><span class="token operator">:</span><span class="token number">18.019</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>http<span class="token operator">-</span>nio<span class="token operator">-</span><span class="token number">45678</span><span class="token operator">-</span>exec<span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token constant">WARN</span> <span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>g<span class="token punctuation">.</span>t<span class="token punctuation">.</span>c<span class="token punctuation">.</span>h<span class="token punctuation">.</span>f<span class="token punctuation">.</span></span>FeignAndRibbonController</span>    <span class="token operator">:</span><span class="token number">26</span>  <span class="token punctuation">]</span> <span class="token operator">-</span> 执行耗时<span class="token operator">:</span> <span class="token number">4003</span>ms 错误<span class="token operator">:</span> <span class="token class-name">Read</span> timed out executing <span class="token constant">POST</span> http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>clientsdk<span class="token operator">/</span>feignandribbon<span class="token operator">/</span>server
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>最后, 来看看同时配置 Feign 和 Ribbon 的参数, 最终谁会生效? 如下代码的参数配置:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>clientsdk<span class="token punctuation">.</span>ribbon<span class="token punctuation">.</span>listOfServers<span class="token operator">=</span>localhost<span class="token operator">:</span><span class="token number">45678</span>
feign<span class="token punctuation">.</span>client<span class="token punctuation">.</span>config<span class="token punctuation">.</span><span class="token keyword">default</span><span class="token punctuation">.</span>readTimeout<span class="token operator">=</span><span class="token number">3000</span>
feign<span class="token punctuation">.</span>client<span class="token punctuation">.</span>config<span class="token punctuation">.</span><span class="token keyword">default</span><span class="token punctuation">.</span>connectTimeout<span class="token operator">=</span><span class="token number">3000</span>
<span class="token class-name"><span class="token namespace">ribbon<span class="token punctuation">.</span></span>ReadTimeout</span><span class="token operator">=</span><span class="token number">4000</span>
<span class="token class-name"><span class="token namespace">ribbon<span class="token punctuation">.</span></span>ConnectTimeout</span><span class="token operator">=</span><span class="token number">4000</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>日志输出证明, 最终生效的是 Feign 的超时:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token punctuation">[</span><span class="token number">16</span><span class="token operator">:</span><span class="token number">01</span><span class="token operator">:</span><span class="token number">19.972</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>http<span class="token operator">-</span>nio<span class="token operator">-</span><span class="token number">45678</span><span class="token operator">-</span>exec<span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token constant">WARN</span> <span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>g<span class="token punctuation">.</span>t<span class="token punctuation">.</span>c<span class="token punctuation">.</span>h<span class="token punctuation">.</span>f<span class="token punctuation">.</span></span>FeignAndRibbonController</span>    <span class="token operator">:</span><span class="token number">26</span>  <span class="token punctuation">]</span> <span class="token operator">-</span> 执行耗时<span class="token operator">:</span> <span class="token number">3006</span>ms 错误<span class="token operator">:</span> <span class="token class-name">Read</span> timed out executing <span class="token constant">POST</span> http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>clientsdk<span class="token operator">/</span>feignandribbon<span class="token operator">/</span>server
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><strong>结论五, 同时配置 Feign 和 Ribbon 的超时, 以 Feign 为准</strong>. 这有点反直觉, 因为 Ribbon 更底层所以你会觉得后者的配置会生效, 但其实不是这样的.</p> <p>在 LoadBalancerFeignClient 源码中可以看到, 如果 Request.Options 不是默认值, 就会创建一个 FeignOptionsClientConfig 代替原来 Ribbon 的 DefaultClientConfigImpl, 导致 Ribbon 的配置被 Feign 覆盖:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">IClientConfig</span> <span class="token function">getClientConfig</span><span class="token punctuation">(</span><span class="token class-name">Request<span class="token punctuation">.</span>Options</span> options<span class="token punctuation">,</span> <span class="token class-name">String</span> clientName<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">IClientConfig</span> requestConfig<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>options <span class="token operator">==</span> <span class="token constant">DEFAULT_OPTIONS</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        requestConfig <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>clientFactory<span class="token punctuation">.</span><span class="token function">getClientConfig</span><span class="token punctuation">(</span>clientName<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        requestConfig <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FeignOptionsClientConfig</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> requestConfig<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>但如果这么配置最终生效的还是 Ribbon 的超时(4 秒), 这容易让人产生 Ribbon 覆盖了 Feign 的错觉, 其实这还是因为坑二所致, 单独配置 Feign 的读取超时并不能生效:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>clientsdk<span class="token punctuation">.</span>ribbon<span class="token punctuation">.</span>listOfServers<span class="token operator">=</span>localhost<span class="token operator">:</span><span class="token number">45678</span>
feign<span class="token punctuation">.</span>client<span class="token punctuation">.</span>config<span class="token punctuation">.</span><span class="token keyword">default</span><span class="token punctuation">.</span>readTimeout<span class="token operator">=</span><span class="token number">3000</span>
feign<span class="token punctuation">.</span>client<span class="token punctuation">.</span>config<span class="token punctuation">.</span>clientsdk<span class="token punctuation">.</span>readTimeout<span class="token operator">=</span><span class="token number">2000</span>
<span class="token class-name"><span class="token namespace">ribbon<span class="token punctuation">.</span></span>ReadTimeout</span><span class="token operator">=</span><span class="token number">4000</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h5 id="你是否知道ribbon会自动重试请求呢"><a href="#你是否知道ribbon会自动重试请求呢" class="header-anchor">#</a> 你是否知道Ribbon会自动重试请求呢?</h5> <p>一些 HTTP 客户端往往会内置一些<strong>重试策略</strong>, 其初衷是好的, 毕竟因为网络问题导致丢包虽然频繁但持续时间短, 往往重试下第二次就能成功, 但一定要小心这种自作主张是否符合预期.</p> <p>之前遇到过一个短信重复发送的问题, 但短信服务的调用方用户服务, 反复确认代码里没有重试逻辑. 那问题究竟出在哪里了? 来重现一下这个案例.</p> <p>首先, 定义一个 Get 请求的发送短信接口, 里面没有任何逻辑, 休眠 2 秒模拟耗时:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@RestController</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">&quot;ribbonretryissueserver&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RibbonRetryIssueServerController</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;sms&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">sendSmsWrong</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;mobile&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> mobile<span class="token punctuation">,</span> <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;message&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> message<span class="token punctuation">,</span> <span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
        <span class="token comment">// 输出调用参数后休眠2秒</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;{} is called, {}=&gt;{}&quot;</span><span class="token punctuation">,</span> request<span class="token punctuation">.</span><span class="token function">getRequestURL</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> mobile<span class="token punctuation">,</span> message<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>配置一个 Feign 供客户端调用:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@FeignClient</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;SmsClient&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">SmsClient</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/ribbonretryissueserver/sms&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">void</span> <span class="token function">sendSmsWrong</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;mobile&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> mobile<span class="token punctuation">,</span> <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;message&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> message<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>Feign 内部<strong>有一个 Ribbon 组件负责客户端负载均衡</strong>, 通过配置文件设置其调用的服务端为两个节点:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">SmsClient</span><span class="token punctuation">.</span>ribbon<span class="token punctuation">.</span>listOfServers<span class="token operator">=</span>localhost<span class="token operator">:</span><span class="token number">45679</span><span class="token punctuation">,</span>localhost<span class="token operator">:</span><span class="token number">45678</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>写一个客户端接口, 通过 Feign 调用服务端:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@RestController</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">&quot;ribbonretryissueclient&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RibbonRetryIssueClientController</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">SmsClient</span> smsClient<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;wrong&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">wrong</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;client is called&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">// 通过Feign调用发送短信接口</span>
            smsClient<span class="token punctuation">.</span><span class="token function">sendSmsWrong</span><span class="token punctuation">(</span><span class="token string">&quot;13600000000&quot;</span><span class="token punctuation">,</span> <span class="token constant">UUID</span><span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 捕获可能出现的网络错误</span>
            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;send sms failed : {}&quot;</span><span class="token punctuation">,</span> ex<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token string">&quot;done&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><p>在 45678 和 45679 两个端口上分别启动服务端, 然后访问 45678 的客户端接口进行测试. 因为客户端和服务端控制器在一个应用中, 所以 45678 同时扮演了客户端和服务端的角色.</p> <p>在 45678 日志中可以看到, 29 秒时客户端收到请求开始调用服务端接口发短信, 同时服务端收到了请求, 2 秒后(注意对比第一条日志和第三条日志)客户端输出了读取超时的错误信息:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token punctuation">[</span><span class="token number">12</span><span class="token operator">:</span><span class="token number">49</span><span class="token operator">:</span><span class="token number">29.020</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>http<span class="token operator">-</span>nio<span class="token operator">-</span><span class="token number">45678</span><span class="token operator">-</span>exec<span class="token operator">-</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token constant">INFO</span> <span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token class-name"><span class="token namespace">c<span class="token punctuation">.</span>d<span class="token punctuation">.</span></span>RibbonRetryIssueClientController</span><span class="token operator">:</span><span class="token number">23</span>  <span class="token punctuation">]</span> <span class="token operator">-</span> client is called
<span class="token punctuation">[</span><span class="token number">12</span><span class="token operator">:</span><span class="token number">49</span><span class="token operator">:</span><span class="token number">29.026</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>http<span class="token operator">-</span>nio<span class="token operator">-</span><span class="token number">45678</span><span class="token operator">-</span>exec<span class="token operator">-</span><span class="token number">5</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token constant">INFO</span> <span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token class-name"><span class="token namespace">c<span class="token punctuation">.</span>d<span class="token punctuation">.</span></span>RibbonRetryIssueServerController</span><span class="token operator">:</span><span class="token number">16</span>  <span class="token punctuation">]</span> <span class="token operator">-</span> http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>localhost<span class="token operator">:</span><span class="token number">45678</span><span class="token operator">/</span>ribbonretryissueserver<span class="token operator">/</span>sms is called<span class="token punctuation">,</span> <span class="token number">13600000000</span><span class="token operator">=</span><span class="token operator">&gt;</span>a2aa1b32<span class="token operator">-</span>a044<span class="token operator">-</span><span class="token number">40e9</span><span class="token operator">-</span><span class="token number">8950</span><span class="token operator">-</span><span class="token number">7f</span><span class="token number">0189582418</span>
<span class="token punctuation">[</span><span class="token number">12</span><span class="token operator">:</span><span class="token number">49</span><span class="token operator">:</span><span class="token number">31.029</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>http<span class="token operator">-</span>nio<span class="token operator">-</span><span class="token number">45678</span><span class="token operator">-</span>exec<span class="token operator">-</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token constant">ERROR</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token class-name"><span class="token namespace">c<span class="token punctuation">.</span>d<span class="token punctuation">.</span></span>RibbonRetryIssueClientController</span><span class="token operator">:</span><span class="token number">27</span>  <span class="token punctuation">]</span> <span class="token operator">-</span> send sms f
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>而在另一个服务端 45679 的日志中还可以看到一条请求, 30 秒时收到请求, 也就是客户端接口调用后的 1 秒:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token punctuation">[</span><span class="token number">12</span><span class="token operator">:</span><span class="token number">49</span><span class="token operator">:</span><span class="token number">30.029</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>http<span class="token operator">-</span>nio<span class="token operator">-</span><span class="token number">45679</span><span class="token operator">-</span>exec<span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token constant">INFO</span> <span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token class-name"><span class="token namespace">c<span class="token punctuation">.</span>d<span class="token punctuation">.</span></span>RibbonRetryIssueServerController</span><span class="token operator">:</span><span class="token number">16</span>  <span class="token punctuation">]</span> <span class="token operator">-</span> http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>localhost<span class="token operator">:</span><span class="token number">45679</span><span class="token operator">/</span>ribbonretryissueserver<span class="token operator">/</span>sms is called<span class="token punctuation">,</span> <span class="token number">13600000000</span><span class="token operator">=</span><span class="token operator">&gt;</span>a2aa1b32<span class="token operator">-</span>a044<span class="token operator">-</span><span class="token number">40e9</span><span class="token operator">-</span><span class="token number">8950</span><span class="token operator">-</span><span class="token number">7f</span><span class="token number">0189582418</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>客户端接口被调用的日志只输出了一次, 而<strong>服务端的日志输出了两次</strong>. 虽然 Feign 的默认读取超时时间是 1 秒, 但客户端 2 秒后才出现超时错误. <strong>显然这说明客户端自作主张进行了一次重试, 导致短信重复发送.</strong></p> <p>翻看 Ribbon 的源码可以发现, <strong>MaxAutoRetriesNextServer 参数默认为 1, 也就是 Get 请求在某个服务端节点出现问题(比如读取超时)时, Ribbon 会自动重试一次</strong>:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// DefaultClientConfigImpl</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">DEFAULT_MAX_AUTO_RETRIES_NEXT_SERVER</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">DEFAULT_MAX_AUTO_RETRIES</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

<span class="token comment">// RibbonLoadBalancedRetryPolicy</span>
<span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">canRetry</span><span class="token punctuation">(</span><span class="token class-name">LoadBalancedRetryContext</span> context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token class-name">HttpMethod</span> method <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">return</span> <span class="token class-name">HttpMethod</span><span class="token punctuation">.</span><span class="token constant">GET</span> <span class="token operator">==</span> method <span class="token operator">||</span> lbContext<span class="token punctuation">.</span><span class="token function">isOkToRetryOnAllOperations</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">canRetrySameServer</span><span class="token punctuation">(</span><span class="token class-name">LoadBalancedRetryContext</span> context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token keyword">return</span> sameServerCount <span class="token operator">&lt;</span> lbContext<span class="token punctuation">.</span><span class="token function">getRetryHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMaxRetriesOnSameServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
         <span class="token operator">&amp;&amp;</span> <span class="token function">canRetry</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">canRetryNextServer</span><span class="token punctuation">(</span><span class="token class-name">LoadBalancedRetryContext</span> context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token comment">// this will be called after a failure occurs and we increment the counter</span>
   <span class="token comment">// so we check that the count is less than or equals to too make sure</span>
   <span class="token comment">// we try the next server the right number of times</span>
   <span class="token keyword">return</span> nextServerCount <span class="token operator">&lt;=</span> lbContext<span class="token punctuation">.</span><span class="token function">getRetryHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMaxRetriesOnNextServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
         <span class="token operator">&amp;&amp;</span> <span class="token function">canRetry</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><p>解决办法有两个:</p> <ol><li>一是, 把发短信接口从 Get 改为 Post. 其实这里还有一个 API 设计问题, 有状态的 API 接口不应该定义为 Get. 根据 HTTP 协议的规范, Get 请求用于数据查询, 而 Post 才是把数据提交到服务端用于修改或新增. 选择 Get 还是 Post 的依据, 应该是 API 的行为, 而不是参数大小. <strong>这里的一个误区是, Get 请求的参数包含在 Url QueryString 中, 会受浏览器长度限制, 所以一些同学会选择使用 JSON 以 Post 提交大参数, 使用 Get 提交小参数.</strong></li> <li>二是, 将 MaxAutoRetriesNextServer 参数配置为 0, 禁用服务调用失败后在下一个服务端节点的自动重试. 在配置文件中添加一行即可: <code>ribbon.MaxAutoRetriesNextServer = 0</code>​.</li></ol> <p>看到这里, 你觉得问题出在用户服务还是短信服务呢?</p> <p>其实双方都有问题. 就像之前说的, <strong>Get 请求应该是无状态或者幂等的, 短信接口可以设计为支持幂等调用的</strong>; 而用户服务的开发同学, 如果对 Ribbon 的重试机制有所了解的话, 或许就能在排查问题上少走些弯路.</p> <h5 id="并发限制了爬虫的抓取能力"><a href="#并发限制了爬虫的抓取能力" class="header-anchor">#</a> 并发限制了爬虫的抓取能力</h5> <p>除了超时和重试的坑, 进行 HTTP 请求调用还有一个常见的问题是, <strong>并发数的限制导致程序的处理能力上不去</strong>.</p> <p>我之前遇到过一个爬虫项目, 整体爬取数据的效率很低, 增加线程池数量也无济于事, 只能堆更多的机器做分布式的爬虫. 现在就来模拟下这个场景, 看看问题出在了哪里.</p> <p>假设要爬取的服务端是这样的一个简单实现, 休眠 1 秒返回数字 1:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;server&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">server</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
    <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>爬虫需要多次调用这个接口进行数据抓取, 为了确保线程池不是并发的瓶颈, 使用一个没有线程上限的 newCachedThreadPool 作为爬取任务的线程池(再次强调, 除非你非常清楚自己的需求, 否则一般不要使用没有线程数量上限的线程池), 然后使用 HttpClient 实现 HTTP 请求, 把请求任务循环提交到线程池处理, 最后等待所有任务执行完成后输出执行耗时:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">int</span> <span class="token function">sendRequest</span><span class="token punctuation">(</span><span class="token keyword">int</span> count<span class="token punctuation">,</span> <span class="token class-name">Supplier</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CloseableHttpClient</span><span class="token punctuation">&gt;</span></span> client<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
    <span class="token comment">// 用于计数发送的请求个数</span>
    <span class="token class-name">AtomicInteger</span> atomicInteger <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicInteger</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 使用HttpClient从server接口查询数据的任务提交到线程池并行处理</span>
    <span class="token class-name">ExecutorService</span> threadPool <span class="token operator">=</span> <span class="token class-name">Executors</span><span class="token punctuation">.</span><span class="token function">newCachedThreadPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
    <span class="token keyword">long</span> begin <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">IntStream</span><span class="token punctuation">.</span><span class="token function">rangeClosed</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>i <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        threadPool<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">CloseableHttpResponse</span> response <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">HttpGet</span><span class="token punctuation">(</span><span class="token string">&quot;http://127.0.0.1:45678/routelimit/server&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                atomicInteger<span class="token punctuation">.</span><span class="token function">addAndGet</span><span class="token punctuation">(</span><span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span><span class="token class-name">EntityUtils</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">getEntity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                ex<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 等到count个任务全部执行完毕</span>
    threadPool<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    threadPool<span class="token punctuation">.</span><span class="token function">awaitTermination</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">HOURS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;发送 {} 次请求, 耗时 {} ms&quot;</span><span class="token punctuation">,</span> atomicInteger<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> begin<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> atomicInteger<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><p>首先, 使用默认的 PoolingHttpClientConnectionManager 构造的 <strong>CloseableHttpClient</strong>, 测试一下爬取 10 次的耗时:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">static</span> <span class="token class-name">CloseableHttpClient</span> httpClient1<span class="token punctuation">;</span>

<span class="token keyword">static</span> <span class="token punctuation">{</span>
    httpClient1 <span class="token operator">=</span> <span class="token class-name">HttpClients</span><span class="token punctuation">.</span><span class="token function">custom</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setConnectionManager</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">PoolingHttpClientConnectionManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;wrong&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">wrong</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;count&quot;</span><span class="token punctuation">,</span> defaultValue <span class="token operator">=</span> <span class="token string">&quot;10&quot;</span><span class="token punctuation">)</span> <span class="token keyword">int</span> count<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">sendRequest</span><span class="token punctuation">(</span>count<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> httpClient1<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>虽然一个请求需要 1 秒执行完成, 但线程池是可以扩张使用任意数量线程的. 按道理说, 10 个请求并发处理的时间基本相当于 1 个请求的处理时间, 也就是 1 秒, 但日志中显示实际耗时 5 秒:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token punctuation">[</span><span class="token number">12</span><span class="token operator">:</span><span class="token number">48</span><span class="token operator">:</span><span class="token number">48.122</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>http<span class="token operator">-</span>nio<span class="token operator">-</span><span class="token number">45678</span><span class="token operator">-</span>exec<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token constant">INFO</span> <span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>g<span class="token punctuation">.</span>t<span class="token punctuation">.</span>c<span class="token punctuation">.</span>h<span class="token punctuation">.</span>r<span class="token punctuation">.</span></span>RouteLimitController</span>        <span class="token operator">:</span><span class="token number">54</span>  <span class="token punctuation">]</span> <span class="token operator">-</span> 发送 <span class="token number">10</span> 次请求<span class="token punctuation">,</span> 耗时 <span class="token number">5265</span> ms
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>查看 PoolingHttpClientConnectionManager 源码, 可以注意到有两个重要参数:</p> <ol><li><strong>defaultMaxPerRoute = 2, 也就是同一个主机/域名的最大并发请求数为 2. 我们的爬虫需要 10 个并发, 显然是默认值太小限制了爬虫的效率.</strong></li> <li>maxTotal=20, 也就是所有<strong>主机整体最大并发为 20</strong>, 这也是 HttpClient 整体的并发度. 目前, 请求数是 10 最大并发是 10, 20 不会成为瓶颈. 举一个例子, 使用同一个 HttpClient 访问 10 个域名, defaultMaxPerRoute 设置为 10, 为确保每一个域名都能达到 10 并发, 需要把 maxTotal 设置为 100.</li></ol> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">PoolingHttpClientConnectionManager</span><span class="token punctuation">(</span>
    <span class="token keyword">final</span> <span class="token class-name">HttpClientConnectionOperator</span> httpClientConnectionOperator<span class="token punctuation">,</span>
    <span class="token keyword">final</span> <span class="token class-name">HttpConnectionFactory</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">HttpRoute</span><span class="token punctuation">,</span> <span class="token class-name">ManagedHttpClientConnection</span><span class="token punctuation">&gt;</span></span> connFactory<span class="token punctuation">,</span>
    <span class="token keyword">final</span> <span class="token keyword">long</span> timeToLive<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">TimeUnit</span> timeUnit<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...  </span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>pool <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CPool</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">InternalConnectionFactory</span><span class="token punctuation">(</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>configData<span class="token punctuation">,</span> connFactory<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">,</span> timeToLive<span class="token punctuation">,</span> timeUnit<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// ...</span>
<span class="token punctuation">}</span> 

<span class="token keyword">public</span> <span class="token class-name">CPool</span><span class="token punctuation">(</span>
        <span class="token keyword">final</span> <span class="token class-name">ConnFactory</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">HttpRoute</span><span class="token punctuation">,</span> <span class="token class-name">ManagedHttpClientConnection</span><span class="token punctuation">&gt;</span></span> connFactory<span class="token punctuation">,</span>
        <span class="token keyword">final</span> <span class="token keyword">int</span> defaultMaxPerRoute<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">int</span> maxTotal<span class="token punctuation">,</span>
        <span class="token keyword">final</span> <span class="token keyword">long</span> timeToLive<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">TimeUnit</span> timeUnit<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
<span class="token punctuation">}</span><span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>HttpClient 是 Java 非常常用的 HTTP 客户端, 这个问题经常出现. 你可能会问, <strong>为什么默认值限制得这么小</strong>.</p> <p>其实, 这不能完全怪 HttpClient, 很多早期的浏览器也限制了同一个域名两个并发请求. 对于同一个域名并发连接的限制, 其实是 HTTP 1.1 协议要求的, 这里有这么一段话:</p> <blockquote><p>Clients that use persistent connections SHOULD limit the number of simultaneous connections that they maintain to a given server. A single-user client SHOULD NOT maintain more than 2 connections with any server or proxy. A proxy SHOULD use up to 2*N connections to another server or proxy, where N is the number of simultaneously active users. These guidelines are intended to improve HTTP response times and avoid congestion.</p></blockquote> <p>HTTP 1.1 协议是 20 年前制定的, 现在 HTTP 服务器的能力强很多了, 所以有些新的浏览器没有完全遵从 2 并发这个限制, 放开并发数到了 8 甚至更大. 如果需要通过 HTTP 客户端发起大量并发请求, 不管使用什么客户端, 请务必确认客户端的实现默认的并发度是否满足需求.</p> <p>既然知道了问题所在, 就尝试声明一个新的 HttpClient 放开相关限制, <strong>设置 maxPerRoute 为 50, maxTotal 为 100</strong>, 然后修改一下刚才的 wrong 方法, 使用新的客户端进行测试:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>httpClient2 <span class="token operator">=</span> <span class="token class-name">HttpClients</span><span class="token punctuation">.</span><span class="token function">custom</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setMaxConnPerRoute</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setMaxConnTotal</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>输出如下, 10 次请求在 1 秒左右执行完成. 可以看到, 因为放开了一个 Host 2 个并发的默认限制, 爬虫效率得到了大幅提升:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token punctuation">[</span><span class="token number">12</span><span class="token operator">:</span><span class="token number">58</span><span class="token operator">:</span><span class="token number">11.333</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>http<span class="token operator">-</span>nio<span class="token operator">-</span><span class="token number">45678</span><span class="token operator">-</span>exec<span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token constant">INFO</span> <span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>g<span class="token punctuation">.</span>t<span class="token punctuation">.</span>c<span class="token punctuation">.</span>h<span class="token punctuation">.</span>r<span class="token punctuation">.</span></span>RouteLimitController</span>        <span class="token operator">:</span><span class="token number">54</span>  <span class="token punctuation">]</span> <span class="token operator">-</span> 发送 <span class="token number">10</span> 次请求<span class="token punctuation">,</span> 耗时 <span class="token number">1023</span> ms
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h5 id="重点回顾-5"><a href="#重点回顾-5" class="header-anchor">#</a> 重点回顾</h5> <p>今天分享了 HTTP 调用最常遇到的超时, 重试和并发问题.</p> <p>连接超时代表建立 TCP 连接的时间, 读取超时代表了等待远端返回数据的时间, 也包括远端程序处理的时间. 在解决连接超时问题时, 要搞清楚连的是谁; 在遇到读取超时问题的时候, 要综合考虑下游服务的服务标准和自己的服务标准, 设置合适的读取超时时间. 此外, 在使用诸如 Spring Cloud Feign 等框架时务必确认, 连接和读取超时参数的配置是否正确生效.</p> <p>对于重试, 因为 HTTP 协议认为 Get 请求是数据查询操作, 是无状态的, 又考虑到网络出现丢包是比较常见的事情, 有些 HTTP 客户端或代理服务器会自动重试 Get/Head 请求. 如果接口设计不支持幂等, 需要关闭自动重试. 但更好的解决方案是, 遵从 HTTP 协议的建议来使用合适的 HTTP 方法.</p> <p>最后看到, 包括 HttpClient 在内的 HTTP 客户端以及浏览器, 都会限制客户端调用的最大并发数. 如果客户端有比较大的请求调用并发, 比如做爬虫, 或是扮演类似代理的角色, 又或者是程序本身并发较高, 如此小的默认值很容易成为吞吐量的瓶颈, 需要及时调整.</p> <h4 id="_06-20-的业务代码的spring声明式事务-可能都没处理正确"><a href="#_06-20-的业务代码的spring声明式事务-可能都没处理正确" class="header-anchor">#</a> 06-20%的业务代码的Spring声明式事务,可能都没处理正确</h4> <p>今天聊聊<strong>业务代码中与数据库事务</strong>相关的坑.</p> <p>Spring 针对 Java Transaction API (JTA), JDBC, Hibernate 和 Java Persistence API (JPA) 等事务 API, 实现了一致的编程模型, 而 Spring 的声明式事务功能更是提供了极其方便的事务配置方式, 配合 Spring Boot 的自动配置, 大多数 Spring Boot 项目只需要在方法上标记 @Transactional 注解, 即可一键开启方法的事务性配置.</p> <p>据我观察, 大多数业务开发同学都有事务的概念, 也知道如果整体考虑多个数据库操作要么成功要么失败时, 需要通过数据库事务来实现多个操作的一致性和原子性. 但<strong>在使用上大多仅限于为方法标记 @Transactional, 不会去关注事务是否有效, 出错后事务是否正确回滚, 也不会考虑复杂的业务代码中涉及多个子业务逻辑时, 怎么正确处理事务</strong>.</p> <p>事务没有被正确处理, 一般来说不会过于影响正常流程, 也不容易在测试阶段被发现. 但当系统越来越复杂, 压力越来越大之后, <strong>就会带来大量的数据不一致问题</strong>, 随后就是大量的人工介入查看和修复数据.</p> <p>所以说, 一个成熟的业务系统和一个基本可用能完成功能的业务系统, 在事务处理细节上的差异非常大. 要确保事务的配置符合业务功能的需求, 往往不仅仅是技术问题, 还涉及产品流程和架构设计的问题. 今天这一讲的标题 &quot;20% 的业务代码的 Spring 声明式事务, 可能都没处理正确&quot; 中, 20% 这个数字在我看来还是比较保守的.</p> <p>今天要分享的内容, 就是帮助你在技术问题上理清思路, 避免因为事务处理不当让业务逻辑的实现产生大量偶发 Bug.</p> <h5 id="小心spring的事务可能没有生效"><a href="#小心spring的事务可能没有生效" class="header-anchor">#</a> 小心Spring的事务可能没有生效</h5> <p>在使用 @Transactional 注解开启声明式事务时, 第一个最容易忽略的问题是, 很<strong>可能事务并没有生效</strong>.</p> <p>实现下面的 Demo 需要一些基础类, 首先定义一个具有 ID 和姓名属性的 UserEntity, 也就是一个包含两个字段的用户表:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Entity</span>
<span class="token annotation punctuation">@Data</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserEntity</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Id</span>
    <span class="token annotation punctuation">@GeneratedValue</span><span class="token punctuation">(</span>strategy <span class="token operator">=</span> <span class="token constant">AUTO</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> id<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token class-name">UserEntity</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token class-name">UserEntity</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>为了方便理解, 使用 Spring JPA 做数据库访问, 实现这样一个 Repository, 新增一个根据用户名查询所有数据的方法:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Repository</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">UserRepository</span> <span class="token keyword">extends</span> <span class="token class-name">JpaRepository</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">UserEntity</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">UserEntity</span><span class="token punctuation">&gt;</span></span> <span class="token function">findByName</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>定义一个 UserService 类, 负责业务逻辑处理. 如果不清楚 @Transactional 的实现方式, 只考虑代码逻辑的话, 这段代码看起来没有问题.</p> <p>定义一个入口方法 createUserWrong1 来调用另一个私有方法 createUserPrivate, 私有方法上标记了 @Transactional 注解. 当传入的用户名包含 test 关键字时判断为用户名不合法, 抛出异常, 让用户创建操作失败, 期望事务可以回滚:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Service</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserService</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">UserRepository</span> userRepository<span class="token punctuation">;</span>

    <span class="token comment">// 一个公共方法供Controller调用, 内部调用事务性的私有方法</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">createUserWrong1</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">createUserPrivate</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">UserEntity</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;create user failed because {}&quot;</span><span class="token punctuation">,</span> ex<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> userRepository<span class="token punctuation">.</span><span class="token function">findByName</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 标记了@Transactional的private方法</span>
    <span class="token annotation punctuation">@Transactional</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">createUserPrivate</span><span class="token punctuation">(</span><span class="token class-name">UserEntity</span> entity<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        userRepository<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>entity<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>entity<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token string">&quot;test&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;invalid username!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 根据用户名查询用户数</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getUserCount</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> userRepository<span class="token punctuation">.</span><span class="token function">findByName</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br></div></div><p>下面是 Controller 的实现, 只是调用一下刚才定义的 UserService 中的入口方法 createUserWrong1.</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Autowired</span>
<span class="token keyword">private</span> <span class="token class-name">UserService</span> userService<span class="token punctuation">;</span>

<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;wrong1&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">wrong1</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> userService<span class="token punctuation">.</span><span class="token function">createUserWrong1</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>调用接口后发现, 即便用户名不合法, 用户也能创建成功. 刷新浏览器, 多次发现有十几个的非法用户注册.</p> <p>这里给出 @Transactional 生效原则 1, <strong>除非特殊配置(比如使用 AspectJ 静态织入实现 AOP), 否则只有定义在</strong> <mark><strong>public</strong></mark> <strong>方法上的 @Transactional 才能生效</strong>. 原因是, <strong>Spring 默认通过动态代理的方式实现 AOP, 对目标方法进行增强, private 方法无法代理到, Spring 自然也无法动态增强事务处理逻辑</strong>.</p> <p>你可能会说, 修复方式很简单, 把标记了事务注解的 createUserPrivate 方法改为 public 即可. 在 UserService 中再建一个入口方法 createUserWrong2, 来调用这个 public 方法再次尝试:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">createUserWrong2</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">createUserPublic</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">UserEntity</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;create user failed because {}&quot;</span><span class="token punctuation">,</span> ex<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> userRepository<span class="token punctuation">.</span><span class="token function">findByName</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 标记了@Transactional的public方法</span>
<span class="token annotation punctuation">@Transactional</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">createUserPublic</span><span class="token punctuation">(</span><span class="token class-name">UserEntity</span> entity<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    userRepository<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>entity<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>entity<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token string">&quot;test&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;invalid username!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>测试发现, 调用新的 createUserWrong2 方法事务<strong>同样不生效</strong>. 这里给出 @Transactional 生效原则 2, <strong>必须通过代理过的类从外部调用目标方法才能生效</strong>.</p> <p><strong>Spring 通过 AOP 技术对方法进行增强, 要调用增强过的方法必然是调用代理后的对象</strong>. 尝试修改下 UserService 的代码, 注入一个 self, 然后再通过 self 实例调用标记有 @Transactional 注解的 createUserPublic 方法. 设置断点可以看到, self 是由 Spring 通过 CGLIB 方式增强过的类:</p> <ol><li>CGLIB 通过继承方式实现代理类, private 方法在子类不可见, 自然也就无法进行事务增强;</li> <li>this 指针代表对象自己, Spring 不可能注入 this, 所以通过 this 访问方法必然不是代理.</li></ol> <p><img src="/img/0a179b90dad4cda79b04ca1ad72b9636-20230731165210-arxuvw4.png" alt=""></p> <p>把 this 改为 self 后测试发现, 在 Controller 中调用 createUserRight 方法可以验证事务是生效的, 非法的用户注册操作可以回滚.</p> <p>虽然在 UserService 内部注入自己调用自己的 createUserPublic 可以正确实现事务, 但更合理的实现方式是, 让 Controller 直接调用之前定义的 UserService 的 createUserPublic 方法, 因为注入自己调用自己很奇怪, 也不符合分层实现的规范:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;right2&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">right2</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        userService<span class="token punctuation">.</span><span class="token function">createUserPublic</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">UserEntity</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;create user failed because {}&quot;</span><span class="token punctuation">,</span> ex<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> userService<span class="token punctuation">.</span><span class="token function">getUserCount</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>再通过一张图来回顾下 <strong>this 自调用</strong>, 通过 self 调用, 以及在 Controller 中调用 UserService 三种实现的区别:</p> <p><img src="/img/1ade6f631690a4ed8f1db14e70e3d170-20230731165210-v9l6qh4.png" alt=""></p> <p>通过 this 自调用, 没有机会走到 Spring 的代理类; 后两种改进方案调用的是 Spring 注入的 UserService, 通过代理调用才有机会对 createUserPublic 方法进行动态增强.</p> <p>这里还有一个小技巧, <strong>强烈建议在开发时打开相关的 Debug 日志, 以方便了解 Spring 事务实现的细节, 并及时判断事务的执行情况</strong>.</p> <p>我们的 Demo 代码使用 JPA 进行数据库访问, 可以这么开启 Debug 日志:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>logging<span class="token punctuation">.</span>level<span class="token punctuation">.</span>org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>orm<span class="token punctuation">.</span>jpa<span class="token operator">=</span><span class="token constant">DEBUG</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>开启日志后, 再比较下在 UserService 中通过 this 调用和在 Controller 中通过注入的 UserService Bean 调用 createUserPublic 区别. 很明显, <strong>this 调用因为没有走代理, 事务没有在 createUserPublic 方法上生效, 只在 Repository 的 save 方法层面生效</strong>:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// 在UserService中通过this调用public的createUserPublic</span>
<span class="token punctuation">[</span><span class="token number">10</span><span class="token operator">:</span><span class="token number">10</span><span class="token operator">:</span><span class="token number">19.913</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>http<span class="token operator">-</span>nio<span class="token operator">-</span><span class="token number">45678</span><span class="token operator">-</span>exec<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token constant">DEBUG</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>s<span class="token punctuation">.</span>orm<span class="token punctuation">.</span>jpa<span class="token punctuation">.</span></span>JpaTransactionManager</span>       <span class="token operator">:</span><span class="token number">370</span> <span class="token punctuation">]</span> <span class="token operator">-</span> <span class="token class-name">Creating</span> <span class="token keyword">new</span> transaction <span class="token keyword">with</span> <span class="token namespace">name</span> <span class="token punctuation">[</span><span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>data<span class="token punctuation">.</span>jpa<span class="token punctuation">.</span>repository<span class="token punctuation">.</span>support<span class="token punctuation">.</span></span>SimpleJpaRepository</span><span class="token punctuation">.</span>save<span class="token punctuation">]</span><span class="token operator">:</span> <span class="token constant">PROPAGATION_REQUIRED</span><span class="token punctuation">,</span><span class="token constant">ISOLATION_DEFAULT</span>
<span class="token comment">// 在Controller中通过注入的UserService Bean调用createUserPublic</span>
<span class="token punctuation">[</span><span class="token number">10</span><span class="token operator">:</span><span class="token number">10</span><span class="token operator">:</span><span class="token number">47.750</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>http<span class="token operator">-</span>nio<span class="token operator">-</span><span class="token number">45678</span><span class="token operator">-</span>exec<span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token constant">DEBUG</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>s<span class="token punctuation">.</span>orm<span class="token punctuation">.</span>jpa<span class="token punctuation">.</span></span>JpaTransactionManager</span>       <span class="token operator">:</span><span class="token number">370</span> <span class="token punctuation">]</span> <span class="token operator">-</span> <span class="token class-name">Creating</span> <span class="token keyword">new</span> transaction <span class="token keyword">with</span> <span class="token namespace">name</span> <span class="token punctuation">[</span><span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>geekbang<span class="token punctuation">.</span>time<span class="token punctuation">.</span>commonmistakes<span class="token punctuation">.</span>transaction<span class="token punctuation">.</span>demo1<span class="token punctuation">.</span></span>UserService</span><span class="token punctuation">.</span>createUserPublic<span class="token punctuation">]</span><span class="token operator">:</span> <span class="token constant">PROPAGATION_REQUIRED</span><span class="token punctuation">,</span><span class="token constant">ISOLATION_DEFAULT</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>你可能还会考虑一个问题, 这种实现在 Controller 里处理了异常显得有点繁琐, 还不如直接把 createUserWrong2 方法加上 @Transactional 注解, 然后在 Controller 中直接调用这个方法. 这样一来, 既能从外部(Controller 中)调用 UserService 中的方法, 方法又是 public 的能够被动态代理 AOP 增强.</p> <p>可以试一下这种方法, 但很容易就会踩第二个坑, 即因为没有正确处理异常, 导致事务即便生效也不一定能回滚.</p> <h5 id="事务即便生效也不一定能回滚"><a href="#事务即便生效也不一定能回滚" class="header-anchor">#</a> 事务即便生效也不一定能回滚</h5> <p>通过 AOP 实现事务处理可以理解为, 使用 try...catch... 来包裹标记了 @Transactional 注解的方法, <strong>当方法出现了异常并且满足一定条件的时候</strong>, 在 catch 里面可以设置事务回滚, 没有异常则直接提交事务.</p> <p>这里的 &quot;一定条件&quot;, 主要包括两点.</p> <p>第一, <strong>只有异常传播出了标记了 @Transactional 注解的方法, 事务才能回滚</strong>. 在 Spring 的 TransactionAspectSupport 里有个 <strong>invokeWithinTransaction</strong> 方法, 里面就是处理事务的逻辑. 可以看到, 只有捕获到异常才能进行后续事务处理:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">try</span> <span class="token punctuation">{</span>
   <span class="token comment">// This is an around advice: Invoke the next interceptor in the chain.</span>
   <span class="token comment">// This will normally result in a target object being invoked.</span>
   retVal <span class="token operator">=</span> invocation<span class="token punctuation">.</span><span class="token function">proceedWithInvocation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token comment">// target invocation exception</span>
   <span class="token function">completeTransactionAfterThrowing</span><span class="token punctuation">(</span>txInfo<span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">throw</span> ex<span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
   <span class="token function">cleanupTransactionInfo</span><span class="token punctuation">(</span>txInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>第二, <strong>默认情况下, 出现 RuntimeException(非受检异常)或 Error 的时候, Spring 才会回滚事务</strong>.</p> <p>打开 Spring 的 DefaultTransactionAttribute 类能看到如下代码块, 可以发现相关证据, 通过注释也能看到 Spring 这么做的原因, 大概的意思是受检异常一般是业务异常, 或者说是类似另一种方法的返回值, 出现这样的异常可能业务还能完成, 所以不会主动回滚; <strong>而 Error 或 RuntimeException 代表了非预期的结果, 应该回滚</strong>:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
 * The default behavior is as with EJB: rollback on unchecked exception
 * ({@link RuntimeException}), assuming an unexpected outcome outside of any
 * business rules. Additionally, we also attempt to rollback on {@link Error} which
 * is clearly an unexpected outcome as well. By contrast, a checked exception is
 * considered a business exception and therefore a regular expected outcome of the
 * transactional business method, i.e. a kind of alternative return value which
 * still allows for regular completion of resource operations.
 * &lt;p&gt;This is largely consistent with TransactionTemplate's default behavior,
 * except that TransactionTemplate also rolls back on undeclared checked exceptions
 * (a corner case). For declarative transactions, we expect checked exceptions to be
 * intentionally declared as business exceptions, leading to a commit by default.
 * @see org.springframework.transaction.support.TransactionTemplate#execute
 */</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">rollbackOn</span><span class="token punctuation">(</span><span class="token class-name">Throwable</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>ex <span class="token keyword">instanceof</span> <span class="token class-name">RuntimeException</span> <span class="token operator">||</span> ex <span class="token keyword">instanceof</span> <span class="token class-name">Error</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>接下来分享 2 个反例.</p> <p>重新实现一下 UserService 中的注册用户操作:</p> <ol><li>在 createUserWrong1 方法中会抛出一个 RuntimeException, 但<strong>由于方法内 catch 了所有异常, 异常无法从方法传播出去, 事务自然无法回滚</strong>.</li> <li>在 createUserWrong2 方法中, 注册用户的同时会有一次 otherTask 文件读取操作, 如果文件读取失败, 则希望用户注册的数据库操作回滚. 虽然这里没有捕获异常, 但因为 otherTask 方法抛出的是<strong>受检异常</strong>, createUserWrong2 传播出去的也是受检异常, 事务同样<strong>不会回滚</strong>.</li></ol> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Service</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserService</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">UserRepository</span> userRepository<span class="token punctuation">;</span>
  
    <span class="token comment">// 异常无法传播出方法, 导致事务无法回滚</span>
    <span class="token annotation punctuation">@Transactional</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">createUserWrong1</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            userRepository<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">UserEntity</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;error&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// catch住了异常不会回滚</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;create user failed&quot;</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 即使出了受检异常也无法让事务回滚</span>
    <span class="token annotation punctuation">@Transactional</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">createUserWrong2</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        userRepository<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">UserEntity</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">otherTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 因为文件不存在, 一定会抛出一个IOException</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">otherTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        <span class="token class-name">Files</span><span class="token punctuation">.</span><span class="token function">readAllLines</span><span class="token punctuation">(</span><span class="token class-name">Paths</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;file-that-not-exist&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br></div></div><p>Controller 中的实现, 仅仅是调用 UserService 的 createUserWrong1 和 createUserWrong2 方法, 这里就贴出实现了. 这 2 个方法的实现和调用, 虽然完全避开了事务不生效的坑, 但因为异常处理不当, 导致程序没有如期望的文件操作出现异常时回滚事务.</p> <p>现在来看下修复方式, 以及如何通过日志来验证是否修复成功. 针对这 2 种情况, 对应的修复方法如下.</p> <p>第一, 如果你希望自己捕获异常进行处理的话, 也没关系, 可以<strong>手动设置让当前事务处于回滚状态</strong>:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Transactional</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">createUserRight1</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        userRepository<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">UserEntity</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;error&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;create user failed&quot;</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 手动设置回滚状态</span>
        <span class="token class-name">TransactionAspectSupport</span><span class="token punctuation">.</span><span class="token function">currentTransactionStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setRollbackOnly</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>运行后可以在日志中看到 Rolling back 字样, 确认事务回滚了. 同时, 还注意到 &quot;Transactional code has requested rollback&quot; 的提示, 表明<strong>手动请求回滚</strong>:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token punctuation">[</span><span class="token number">22</span><span class="token operator">:</span><span class="token number">14</span><span class="token operator">:</span><span class="token number">49.352</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>http<span class="token operator">-</span>nio<span class="token operator">-</span><span class="token number">45678</span><span class="token operator">-</span>exec<span class="token operator">-</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token constant">DEBUG</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>s<span class="token punctuation">.</span>orm<span class="token punctuation">.</span>jpa<span class="token punctuation">.</span></span>JpaTransactionManager</span>       <span class="token operator">:</span><span class="token number">698</span> <span class="token punctuation">]</span> <span class="token operator">-</span> <span class="token class-name">Transactional</span> code has requested rollback
<span class="token punctuation">[</span><span class="token number">22</span><span class="token operator">:</span><span class="token number">14</span><span class="token operator">:</span><span class="token number">49.353</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>http<span class="token operator">-</span>nio<span class="token operator">-</span><span class="token number">45678</span><span class="token operator">-</span>exec<span class="token operator">-</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token constant">DEBUG</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>s<span class="token punctuation">.</span>orm<span class="token punctuation">.</span>jpa<span class="token punctuation">.</span></span>JpaTransactionManager</span>       <span class="token operator">:</span><span class="token number">834</span> <span class="token punctuation">]</span> <span class="token operator">-</span> <span class="token class-name">Initiating</span> transaction rollback
<span class="token punctuation">[</span><span class="token number">22</span><span class="token operator">:</span><span class="token number">14</span><span class="token operator">:</span><span class="token number">49.353</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>http<span class="token operator">-</span>nio<span class="token operator">-</span><span class="token number">45678</span><span class="token operator">-</span>exec<span class="token operator">-</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token constant">DEBUG</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>s<span class="token punctuation">.</span>orm<span class="token punctuation">.</span>jpa<span class="token punctuation">.</span></span>JpaTransactionManager</span>       <span class="token operator">:</span><span class="token number">555</span> <span class="token punctuation">]</span> <span class="token operator">-</span> <span class="token class-name">Rolling</span> back <span class="token constant">JPA</span> transaction on <span class="token class-name">EntityManager</span> <span class="token punctuation">[</span><span class="token class-name">SessionImpl</span><span class="token punctuation">(</span><span class="token number">1906719643</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token keyword">open</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span><span class="token punctuation">]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>第二, 在<strong>注解中声明, 期望遇到所有的 Exception 都回滚事务(来突破默认不回滚受检异常的限制)</strong> :</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Transactional</span><span class="token punctuation">(</span>rollbackFor <span class="token operator">=</span> <span class="token class-name">Exception</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">createUserRight2</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
    userRepository<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">UserEntity</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">otherTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>运行后, 同样可以在日志中看到回滚的提示:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token punctuation">[</span><span class="token number">22</span><span class="token operator">:</span><span class="token number">10</span><span class="token operator">:</span><span class="token number">47.980</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>http<span class="token operator">-</span>nio<span class="token operator">-</span><span class="token number">45678</span><span class="token operator">-</span>exec<span class="token operator">-</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token constant">DEBUG</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>s<span class="token punctuation">.</span>orm<span class="token punctuation">.</span>jpa<span class="token punctuation">.</span></span>JpaTransactionManager</span>       <span class="token operator">:</span><span class="token number">834</span> <span class="token punctuation">]</span> <span class="token operator">-</span> <span class="token class-name">Initiating</span> transaction rollback
<span class="token punctuation">[</span><span class="token number">22</span><span class="token operator">:</span><span class="token number">10</span><span class="token operator">:</span><span class="token number">47.981</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>http<span class="token operator">-</span>nio<span class="token operator">-</span><span class="token number">45678</span><span class="token operator">-</span>exec<span class="token operator">-</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token constant">DEBUG</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>s<span class="token punctuation">.</span>orm<span class="token punctuation">.</span>jpa<span class="token punctuation">.</span></span>JpaTransactionManager</span>       <span class="token operator">:</span><span class="token number">555</span> <span class="token punctuation">]</span> <span class="token operator">-</span> <span class="token class-name">Rolling</span> back <span class="token constant">JPA</span> transaction on <span class="token class-name">EntityManager</span> <span class="token punctuation">[</span><span class="token class-name">SessionImpl</span><span class="token punctuation">(</span><span class="token number">1419329213</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token keyword">open</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span><span class="token punctuation">]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>在这个例子中, 展现的是一个复杂的业务逻辑, 其中有数据库操作, IO 操作, 在 IO 操作出现问题时希望让数据库事务也回滚, 以确保逻辑的一致性. 在有些业务逻辑中, 可能会包含多次数据库操作, 所以不一定希望将两次操作作为一个事务来处理, 这时候就需要仔细考虑<strong>事务传播的配置</strong>了, 否则也可能踩坑.</p> <h5 id="请确认事务传播配置是否符合自己的业务逻辑"><a href="#请确认事务传播配置是否符合自己的业务逻辑" class="header-anchor">#</a> 请确认事务传播配置是否符合自己的业务逻辑</h5> <p>有这么一个场景: 一个用户注册的操作, 会插入一个主用户到用户表, 还会注册一个关联的子用户. 业务上希望将子用户注册的数据库操作作为一个独立事务来处理, 即使失败也不会影响主流程, 即<strong>不影响主用户的注册</strong>.</p> <p>接下来模拟一个实现类似业务逻辑的 UserService:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Autowired</span>
<span class="token keyword">private</span> <span class="token class-name">UserRepository</span> userRepository<span class="token punctuation">;</span>

<span class="token annotation punctuation">@Autowired</span>
<span class="token keyword">private</span> <span class="token class-name">SubUserService</span> subUserService<span class="token punctuation">;</span>

<span class="token annotation punctuation">@Transactional</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">createUserWrong</span><span class="token punctuation">(</span><span class="token class-name">UserEntity</span> entity<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 创建主用户</span>
    <span class="token function">createMainUser</span><span class="token punctuation">(</span>entity<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 创建子用户</span>
    subUserService<span class="token punctuation">.</span><span class="token function">createSubUserWithExceptionWrong</span><span class="token punctuation">(</span>entity<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">createMainUser</span><span class="token punctuation">(</span><span class="token class-name">UserEntity</span> entity<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    userRepository<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>entity<span class="token punctuation">)</span><span class="token punctuation">;</span>
    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;createMainUser finish&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>SubUserService 的 createSubUserWithExceptionWrong 实现正如其名, 因为最后抛出了一个运行时异常, 错误原因是用户状态无效, 所以子用户的注册肯定是失败的. 业务上期望<strong>子用户的注册作为一个事务单独回滚, 不影响主用户的注册, 这样的逻辑可以实现</strong>吗?</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Service</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SubUserService</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">UserRepository</span> userRepository<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Transactional</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">createSubUserWithExceptionWrong</span><span class="token punctuation">(</span><span class="token class-name">UserEntity</span> entity<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;createSubUserWithExceptionWrong start&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        userRepository<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>entity<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 注册子用户时模拟抛出异常</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;invalid status&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>在 Controller 里实现一段测试代码, 调用 UserService:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;wrong&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">wrong</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        userService<span class="token punctuation">.</span><span class="token function">createUserWrong</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">UserEntity</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;createUserWrong failed, reason:{}&quot;</span><span class="token punctuation">,</span> ex<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> userService<span class="token punctuation">.</span><span class="token function">getUserCount</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>调用后可以在日志中发现如下信息, 很明显<strong>事务回滚了, 最后 Controller 打出了创建子用户抛出的运行时异常</strong>:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token punctuation">[</span><span class="token number">22</span><span class="token operator">:</span><span class="token number">50</span><span class="token operator">:</span><span class="token number">42.866</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>http<span class="token operator">-</span>nio<span class="token operator">-</span><span class="token number">45678</span><span class="token operator">-</span>exec<span class="token operator">-</span><span class="token number">8</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token constant">DEBUG</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>s<span class="token punctuation">.</span>orm<span class="token punctuation">.</span>jpa<span class="token punctuation">.</span></span>JpaTransactionManager</span>       <span class="token operator">:</span><span class="token number">555</span> <span class="token punctuation">]</span> <span class="token operator">-</span> <span class="token class-name">Rolling</span> back <span class="token constant">JPA</span> transaction on <span class="token class-name">EntityManager</span> <span class="token punctuation">[</span><span class="token class-name">SessionImpl</span><span class="token punctuation">(</span><span class="token number">103972212</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token keyword">open</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span><span class="token punctuation">]</span>
<span class="token punctuation">[</span><span class="token number">22</span><span class="token operator">:</span><span class="token number">50</span><span class="token operator">:</span><span class="token number">42.869</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>http<span class="token operator">-</span>nio<span class="token operator">-</span><span class="token number">45678</span><span class="token operator">-</span>exec<span class="token operator">-</span><span class="token number">8</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token constant">DEBUG</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>s<span class="token punctuation">.</span>orm<span class="token punctuation">.</span>jpa<span class="token punctuation">.</span></span>JpaTransactionManager</span>       <span class="token operator">:</span><span class="token number">620</span> <span class="token punctuation">]</span> <span class="token operator">-</span> <span class="token class-name">Closing</span> <span class="token constant">JPA</span> <span class="token class-name">EntityManager</span> <span class="token punctuation">[</span><span class="token class-name">SessionImpl</span><span class="token punctuation">(</span><span class="token number">103972212</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token keyword">open</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span><span class="token punctuation">]</span> after transaction
<span class="token punctuation">[</span><span class="token number">22</span><span class="token operator">:</span><span class="token number">50</span><span class="token operator">:</span><span class="token number">42.869</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>http<span class="token operator">-</span>nio<span class="token operator">-</span><span class="token number">45678</span><span class="token operator">-</span>exec<span class="token operator">-</span><span class="token number">8</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token constant">ERROR</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token class-name"><span class="token namespace">t<span class="token punctuation">.</span>d<span class="token punctuation">.</span></span>TransactionPropagationController</span><span class="token operator">:</span><span class="token number">23</span>  <span class="token punctuation">]</span> <span class="token operator">-</span> createUserWrong failed<span class="token punctuation">,</span> reason<span class="token operator">:</span>invalid status
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>你马上就会意识到, 不对呀, 因为运行时异常逃出了 @Transactional 注解标记的 createUserWrong 方法, Spring 当然会回滚事务了. 如果希望主方法不回滚, 应该把子方法抛出的异常捕获了.</p> <p>也就是这么改, 把 subUserService.createSubUserWithExceptionWrong 包裹上 catch, 这样外层主方法就不会出现异常了:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Transactional</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">createUserWrong2</span><span class="token punctuation">(</span><span class="token class-name">UserEntity</span> entity<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">createMainUser</span><span class="token punctuation">(</span>entity<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span><span class="token punctuation">{</span>
        subUserService<span class="token punctuation">.</span><span class="token function">createSubUserWithExceptionWrong</span><span class="token punctuation">(</span>entity<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 虽然捕获了异常, 但是因为没有开启新事务, 而当前事务因为异常已经被标记为rollback了, 所以最终还是会回滚. </span>
        log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;create sub user error:{}&quot;</span><span class="token punctuation">,</span> ex<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>运行程序后可以看到如下日志:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token punctuation">[</span><span class="token number">22</span><span class="token operator">:</span><span class="token number">57</span><span class="token operator">:</span><span class="token number">21.722</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>http<span class="token operator">-</span>nio<span class="token operator">-</span><span class="token number">45678</span><span class="token operator">-</span>exec<span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token constant">DEBUG</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>s<span class="token punctuation">.</span>orm<span class="token punctuation">.</span>jpa<span class="token punctuation">.</span></span>JpaTransactionManager</span>       <span class="token operator">:</span><span class="token number">370</span> <span class="token punctuation">]</span> <span class="token operator">-</span> <span class="token class-name">Creating</span> <span class="token keyword">new</span> transaction <span class="token keyword">with</span> <span class="token namespace">name</span> <span class="token punctuation">[</span><span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>geekbang<span class="token punctuation">.</span>time<span class="token punctuation">.</span>commonmistakes<span class="token punctuation">.</span>transaction<span class="token punctuation">.</span>demo3<span class="token punctuation">.</span></span>UserService</span><span class="token punctuation">.</span>createUserWrong2<span class="token punctuation">]</span><span class="token operator">:</span> <span class="token constant">PROPAGATION_REQUIRED</span><span class="token punctuation">,</span><span class="token constant">ISOLATION_DEFAULT</span>
<span class="token punctuation">[</span><span class="token number">22</span><span class="token operator">:</span><span class="token number">57</span><span class="token operator">:</span><span class="token number">21.739</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>http<span class="token operator">-</span>nio<span class="token operator">-</span><span class="token number">45678</span><span class="token operator">-</span>exec<span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token constant">INFO</span> <span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token class-name"><span class="token namespace">t<span class="token punctuation">.</span>c<span class="token punctuation">.</span>transaction<span class="token punctuation">.</span>demo3<span class="token punctuation">.</span></span>SubUserService</span><span class="token operator">:</span><span class="token number">19</span>  <span class="token punctuation">]</span> <span class="token operator">-</span> createSubUserWithExceptionWrong start
<span class="token punctuation">[</span><span class="token number">22</span><span class="token operator">:</span><span class="token number">57</span><span class="token operator">:</span><span class="token number">21.739</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>http<span class="token operator">-</span>nio<span class="token operator">-</span><span class="token number">45678</span><span class="token operator">-</span>exec<span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token constant">DEBUG</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>s<span class="token punctuation">.</span>orm<span class="token punctuation">.</span>jpa<span class="token punctuation">.</span></span>JpaTransactionManager</span>       <span class="token operator">:</span><span class="token number">356</span> <span class="token punctuation">]</span> <span class="token operator">-</span> <span class="token class-name">Found</span> thread<span class="token operator">-</span>bound <span class="token class-name">EntityManager</span> <span class="token punctuation">[</span><span class="token class-name">SessionImpl</span><span class="token punctuation">(</span><span class="token number">1794007607</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token keyword">open</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token keyword">for</span> <span class="token constant">JPA</span> transaction
<span class="token punctuation">[</span><span class="token number">22</span><span class="token operator">:</span><span class="token number">57</span><span class="token operator">:</span><span class="token number">21.739</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>http<span class="token operator">-</span>nio<span class="token operator">-</span><span class="token number">45678</span><span class="token operator">-</span>exec<span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token constant">DEBUG</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>s<span class="token punctuation">.</span>orm<span class="token punctuation">.</span>jpa<span class="token punctuation">.</span></span>JpaTransactionManager</span>       <span class="token operator">:</span><span class="token number">471</span> <span class="token punctuation">]</span> <span class="token operator">-</span> <span class="token class-name">Participating</span> in existing transaction
<span class="token punctuation">[</span><span class="token number">22</span><span class="token operator">:</span><span class="token number">57</span><span class="token operator">:</span><span class="token number">21.740</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>http<span class="token operator">-</span>nio<span class="token operator">-</span><span class="token number">45678</span><span class="token operator">-</span>exec<span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token constant">DEBUG</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>s<span class="token punctuation">.</span>orm<span class="token punctuation">.</span>jpa<span class="token punctuation">.</span></span>JpaTransactionManager</span>       <span class="token operator">:</span><span class="token number">843</span> <span class="token punctuation">]</span> <span class="token operator">-</span> <span class="token class-name">Participating</span> transaction failed <span class="token operator">-</span> marking existing transaction as rollback<span class="token operator">-</span>only
<span class="token punctuation">[</span><span class="token number">22</span><span class="token operator">:</span><span class="token number">57</span><span class="token operator">:</span><span class="token number">21.740</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>http<span class="token operator">-</span>nio<span class="token operator">-</span><span class="token number">45678</span><span class="token operator">-</span>exec<span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token constant">DEBUG</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>s<span class="token punctuation">.</span>orm<span class="token punctuation">.</span>jpa<span class="token punctuation">.</span></span>JpaTransactionManager</span>       <span class="token operator">:</span><span class="token number">580</span> <span class="token punctuation">]</span> <span class="token operator">-</span> <span class="token class-name">Setting</span> <span class="token constant">JPA</span> transaction on <span class="token class-name">EntityManager</span> <span class="token punctuation">[</span><span class="token class-name">SessionImpl</span><span class="token punctuation">(</span><span class="token number">1794007607</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token keyword">open</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span><span class="token punctuation">]</span> rollback<span class="token operator">-</span>only
<span class="token punctuation">[</span><span class="token number">22</span><span class="token operator">:</span><span class="token number">57</span><span class="token operator">:</span><span class="token number">21.740</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>http<span class="token operator">-</span>nio<span class="token operator">-</span><span class="token number">45678</span><span class="token operator">-</span>exec<span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token constant">ERROR</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token punctuation">.</span>g<span class="token punctuation">.</span>t<span class="token punctuation">.</span>c<span class="token punctuation">.</span>transaction<span class="token punctuation">.</span>demo3<span class="token punctuation">.</span>UserService<span class="token operator">:</span><span class="token number">37</span>  <span class="token punctuation">]</span> <span class="token operator">-</span> create sub user error<span class="token operator">:</span>invalid status
<span class="token punctuation">[</span><span class="token number">22</span><span class="token operator">:</span><span class="token number">57</span><span class="token operator">:</span><span class="token number">21.740</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>http<span class="token operator">-</span>nio<span class="token operator">-</span><span class="token number">45678</span><span class="token operator">-</span>exec<span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token constant">DEBUG</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>s<span class="token punctuation">.</span>orm<span class="token punctuation">.</span>jpa<span class="token punctuation">.</span></span>JpaTransactionManager</span>       <span class="token operator">:</span><span class="token number">741</span> <span class="token punctuation">]</span> <span class="token operator">-</span> <span class="token class-name">Initiating</span> transaction commit
<span class="token punctuation">[</span><span class="token number">22</span><span class="token operator">:</span><span class="token number">57</span><span class="token operator">:</span><span class="token number">21.740</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>http<span class="token operator">-</span>nio<span class="token operator">-</span><span class="token number">45678</span><span class="token operator">-</span>exec<span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token constant">DEBUG</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>s<span class="token punctuation">.</span>orm<span class="token punctuation">.</span>jpa<span class="token punctuation">.</span></span>JpaTransactionManager</span>       <span class="token operator">:</span><span class="token number">529</span> <span class="token punctuation">]</span> <span class="token operator">-</span> <span class="token class-name">Committing</span> <span class="token constant">JPA</span> transaction on <span class="token class-name">EntityManager</span> <span class="token punctuation">[</span><span class="token class-name">SessionImpl</span><span class="token punctuation">(</span><span class="token number">1794007607</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token keyword">open</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span><span class="token punctuation">]</span>
<span class="token punctuation">[</span><span class="token number">22</span><span class="token operator">:</span><span class="token number">57</span><span class="token operator">:</span><span class="token number">21.743</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>http<span class="token operator">-</span>nio<span class="token operator">-</span><span class="token number">45678</span><span class="token operator">-</span>exec<span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token constant">DEBUG</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>s<span class="token punctuation">.</span>orm<span class="token punctuation">.</span>jpa<span class="token punctuation">.</span></span>JpaTransactionManager</span>       <span class="token operator">:</span><span class="token number">620</span> <span class="token punctuation">]</span> <span class="token operator">-</span> <span class="token class-name">Closing</span> <span class="token constant">JPA</span> <span class="token class-name">EntityManager</span> <span class="token punctuation">[</span><span class="token class-name">SessionImpl</span><span class="token punctuation">(</span><span class="token number">1794007607</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token keyword">open</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span><span class="token punctuation">]</span> after transaction
<span class="token punctuation">[</span><span class="token number">22</span><span class="token operator">:</span><span class="token number">57</span><span class="token operator">:</span><span class="token number">21.743</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>http<span class="token operator">-</span>nio<span class="token operator">-</span><span class="token number">45678</span><span class="token operator">-</span>exec<span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token constant">ERROR</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token class-name"><span class="token namespace">t<span class="token punctuation">.</span>d<span class="token punctuation">.</span></span>TransactionPropagationController</span><span class="token operator">:</span><span class="token number">33</span>  <span class="token punctuation">]</span> <span class="token operator">-</span> createUserWrong2 failed<span class="token punctuation">,</span> reason<span class="token operator">:</span><span class="token class-name">Transaction</span> silently rolled back because it has been marked as rollback<span class="token operator">-</span>only
<span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>transaction<span class="token punctuation">.</span></span>UnexpectedRollbackException</span><span class="token operator">:</span> <span class="token class-name">Transaction</span> silently rolled back because it has been marked as rollback<span class="token operator">-</span>only
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>需要注意以下几点:</p> <ol><li>如第 1 行所示, 对 createUserWrong2 方法<strong>开启了异常处理</strong>;</li> <li>如第 5 行所示, <strong>子方法因为出现了运行时异常, 标记当前事务为回滚</strong>;</li> <li>如第 7 行所示, 主方法的确捕获了异常打印出了 create sub user error 字样;</li> <li>如第 9 行所示, <strong>主方法提交了事务</strong>;</li> <li>奇怪的是, 如第 11 行和 12 行所示, <strong>Controller 里出现了一个 UnexpectedRollbackException, 异常描述提示最终这个事务回滚了, 而且是静默回滚的</strong>. 之所以说是静默, 是因为 createUserWrong2 方法本身并没有出异常, 只不过提交后发现子方法已经把当前事务设置为了回滚, 无法完成提交.</li></ol> <p>这挺反直觉的. <strong>之前说, 出了异常事务不一定回滚, 这里说的却是不出异常, 事务也不一定可以提交</strong>. 原因是, <strong>主方法注册主用户的逻辑和子方法注册子用户的逻辑是同一个事务, 子逻辑标记了事务需要回滚, 主逻辑自然也不能提交了</strong>.</p> <p>看到这里, 修复方式就很明确了, 想办法<strong>让子逻辑在独立事务中运行</strong>, 也就是改一下 SubUserService 注册子用户的方法, 为注解加上 <code>propagation = Propagation.REQUIRES_NEW</code>​ 来设置 REQUIRES_NEW 方式的事务传播策略, 也就是<strong>执行到这个方法时需要开启新的事务, 并挂起当前事务</strong>:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// 配置事务传播方式</span>
<span class="token annotation punctuation">@Transactional</span><span class="token punctuation">(</span>propagation <span class="token operator">=</span> <span class="token class-name">Propagation</span><span class="token punctuation">.</span><span class="token constant">REQUIRES_NEW</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">createSubUserWithExceptionRight</span><span class="token punctuation">(</span><span class="token class-name">UserEntity</span> entity<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;createSubUserWithExceptionRight start&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    userRepository<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>entity<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;invalid status&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p><strong>主方法没什么变化, 同样需要捕获异常, 防止异常漏出去导致主事务回滚</strong>, 重新命名为 createUserRight:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Transactional</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">createUserRight</span><span class="token punctuation">(</span><span class="token class-name">UserEntity</span> entity<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 创建主用户</span>
    <span class="token function">createMainUser</span><span class="token punctuation">(</span>entity<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment">// 创建子用户</span>
        subUserService<span class="token punctuation">.</span><span class="token function">createSubUserWithExceptionRight</span><span class="token punctuation">(</span>entity<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 捕获异常, 防止主方法回滚</span>
        log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;create sub user error:{}&quot;</span><span class="token punctuation">,</span> ex<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>改造后, 重新运行程序可以看到如下的关键日志:</p> <ol><li>第 1 行日志提示针对 createUserRight 方法开启了主方法的事务;</li> <li>第 2 行日志提示<strong>创建主用户完成</strong>;</li> <li>第 3 行日志可以看到<strong>主事务挂起了, 开启了一个新的事务</strong>, 针对 createSubUserWithExceptionRight 方案, 也就是我们的创建子用户的逻辑;</li> <li>第 4 行日志提示子方法事务回滚;</li> <li>第 5 行日志提示子方法事务完成, 继续主方法之前挂起的事务;</li> <li>第 6 行日志提示主方法捕获到了子方法的异常;</li> <li>第 8 行日志提示主方法的事务提交了, 随后我们在 Controller 里没看到静默回滚的异常.</li></ol> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token punctuation">[</span><span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>s<span class="token punctuation">.</span>orm<span class="token punctuation">.</span>jpa<span class="token punctuation">.</span></span>JpaTransactionManager</span>       <span class="token operator">:</span><span class="token number">370</span> <span class="token punctuation">]</span> <span class="token operator">-</span> <span class="token class-name">Creating</span> <span class="token keyword">new</span> transaction <span class="token keyword">with</span> <span class="token namespace">name</span> <span class="token punctuation">[</span><span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>geekbang<span class="token punctuation">.</span>time<span class="token punctuation">.</span>commonmistakes<span class="token punctuation">.</span>transaction<span class="token punctuation">.</span>demo3<span class="token punctuation">.</span></span>UserService</span><span class="token punctuation">.</span>createUserRight<span class="token punctuation">]</span><span class="token operator">:</span> <span class="token constant">PROPAGATION_REQUIRED</span><span class="token punctuation">,</span><span class="token constant">ISOLATION_DEFAULT</span>
<span class="token punctuation">[</span><span class="token punctuation">.</span>g<span class="token punctuation">.</span>t<span class="token punctuation">.</span>c<span class="token punctuation">.</span>transaction<span class="token punctuation">.</span>demo3<span class="token punctuation">.</span>UserService<span class="token operator">:</span><span class="token number">55</span>  <span class="token punctuation">]</span> <span class="token operator">-</span> createMainUser finish
<span class="token punctuation">[</span><span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>s<span class="token punctuation">.</span>orm<span class="token punctuation">.</span>jpa<span class="token punctuation">.</span></span>JpaTransactionManager</span>       <span class="token operator">:</span><span class="token number">420</span> <span class="token punctuation">]</span> <span class="token operator">-</span> <span class="token class-name">Suspending</span> current transaction<span class="token punctuation">,</span> creating <span class="token keyword">new</span> transaction <span class="token keyword">with</span> <span class="token namespace">name</span> <span class="token punctuation">[</span><span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>geekbang<span class="token punctuation">.</span>time<span class="token punctuation">.</span>commonmistakes<span class="token punctuation">.</span>transaction<span class="token punctuation">.</span>demo3<span class="token punctuation">.</span></span>SubUserService</span><span class="token punctuation">.</span>createSubUserWithExceptionRight<span class="token punctuation">]</span>
<span class="token punctuation">[</span><span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>s<span class="token punctuation">.</span>orm<span class="token punctuation">.</span>jpa<span class="token punctuation">.</span></span>JpaTransactionManager</span>       <span class="token operator">:</span><span class="token number">834</span> <span class="token punctuation">]</span> <span class="token operator">-</span> <span class="token class-name">Initiating</span> transaction rollback
<span class="token punctuation">[</span><span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>s<span class="token punctuation">.</span>orm<span class="token punctuation">.</span>jpa<span class="token punctuation">.</span></span>JpaTransactionManager</span>       <span class="token operator">:</span><span class="token number">1009</span><span class="token punctuation">]</span> <span class="token operator">-</span> <span class="token class-name">Resuming</span> suspended transaction after completion of inner transaction
<span class="token punctuation">[</span><span class="token punctuation">.</span>g<span class="token punctuation">.</span>t<span class="token punctuation">.</span>c<span class="token punctuation">.</span>transaction<span class="token punctuation">.</span>demo3<span class="token punctuation">.</span>UserService<span class="token operator">:</span><span class="token number">49</span>  <span class="token punctuation">]</span> <span class="token operator">-</span> create sub user error<span class="token operator">:</span>invalid status
<span class="token punctuation">[</span><span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>s<span class="token punctuation">.</span>orm<span class="token punctuation">.</span>jpa<span class="token punctuation">.</span></span>JpaTransactionManager</span>       <span class="token operator">:</span><span class="token number">741</span> <span class="token punctuation">]</span> <span class="token operator">-</span> <span class="token class-name">Initiating</span> transaction commit
<span class="token punctuation">[</span><span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>s<span class="token punctuation">.</span>orm<span class="token punctuation">.</span>jpa<span class="token punctuation">.</span></span>JpaTransactionManager</span>       <span class="token operator">:</span><span class="token number">529</span> <span class="token punctuation">]</span> <span class="token operator">-</span> <span class="token class-name">Committing</span> <span class="token constant">JPA</span> transaction on <span class="token class-name">EntityManager</span> <span class="token punctuation">[</span><span class="token class-name">SessionImpl</span><span class="token punctuation">(</span><span class="token number">396441411</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token keyword">open</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span><span class="token punctuation">]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>运行测试程序看到如下结果, getUserCount 得到的用户数量为 1, 代表只有一个用户也就是主用户注册完成了, 符合预期:</p> <p>​<img src="/img/a4ebbdc0b679c8790edf728a7509e5d2-20230731165210-6ijrw7l.png" alt="">​</p> <h5 id="重点回顾-6"><a href="#重点回顾-6" class="header-anchor">#</a> 重点回顾</h5> <p>今天针对业务代码中最常见的使用数据库事务的方式, 即 <strong>Spring 声明式事务</strong>, 总结了使用上可能遇到的三类坑, 包括:</p> <p>第一, <strong>因为配置不正确, 导致方法上的事务没生效</strong>. 务必<strong>确认调用 @Transactional 注解标记的方法是 public 的, 并且是通过 Spring 注入的 Bean 进行调用的</strong>.</p> <p>第二, <strong>因为异常处理不正确, 导致事务虽然生效但出现异常时没回滚</strong>. Spring 默认只会对标记 @Transactional 注解的方法出现了 RuntimeException 和 Error 的时候回滚, 如果方法捕获了异常, 那么需要通过手动编码处理事务回滚. 如果希望 Spring 针对其他异常也可以回滚, 那么可以相应配置 @Transactional 注解的 rollbackFor 和 noRollbackFor 属性来覆盖其默认设置.</p> <p>第三, 如果方法涉及多次数据库操作, 并希望将它们作为独立的事务进行提交或回滚, 那么需要考虑进一步细化配置事务<strong>传播方式</strong>, 也就是 @Transactional 注解的 Propagation 属性.</p> <p>可见, 正确配置事务可以提高业务项目的健壮性. 但又因为健壮性问题往往体现在异常情况或一些细节处理上, 很难在主流程的运行和测试中发现, 导致业务代码的事务处理逻辑往往容易被忽略, 因此<strong>我在代码审查环节一直很关注事务是否正确处理</strong>.</p> <p>如果无法确认事务是否真正生效, 是否按照预期的逻辑进行, 可以尝试<strong>打开 Spring 的部分 Debug 日志</strong>, 通过事务的运作细节来验证. 也建议在单元测试时尽量覆盖多的异常场景, 这样在重构时, 也能及时发现因为方法的调用方式, 异常处理逻辑的调整, 导致的事务失效问题.</p> <h4 id="_07-数据库索引-索引并不是万能药"><a href="#_07-数据库索引-索引并不是万能药" class="header-anchor">#</a> 07-数据库索引:索引并不是万能药</h4> <p>今天要分享的主题是<strong>数据库的索引并不是万能药</strong>.</p> <p>几乎所有的业务项目都会涉及数据存储, 虽然当前各种 NoSQL 和文件系统大行其道, 但 MySQL 等关系型数据库因为满足 ACID, 可靠性高, 对开发友好等特点, 仍然最常被用于存储重要数据. 在关系型数据库中, 索引是优化查询性能的重要手段.</p> <p>为此, 我经常看到一些同学一遇到查询性能问题, 就盲目要求运维或 DBA 给数据表相关字段创建大量索引. 显然, 这种想法是错误的. 今天就以 MySQL 为例来深入理解下索引的原理, 以及相关误区.</p> <h5 id="innodb是如何存储数据的"><a href="#innodb是如何存储数据的" class="header-anchor">#</a> InnoDB是如何存储数据的?</h5> <p>MySQL 把数据存储和查询操作抽象成了存储引擎, 不同的存储引擎, 对数据的存储和读取方式各不相同. MySQL 支持多种存储引擎, 并且可以以表为粒度设置存储引擎. 因为支持事务, 最常使用的是 InnoDB. 为方便理解下面的内容, 先简单说说 <strong>InnoDB 是如何存储数据</strong>的.</p> <p><mark><strong>虽然数据保存在磁盘中, 但其处理是在内存中进行的. 为了减少磁盘随机读取次数, InnoDB 采用页而不是行的粒度来保存数据, 即数据被分成若干页, 以页为单位保存在磁盘中. InnoDB 的页大小, 一般是 16KB</strong></mark>.</p> <p>各个<strong>数据页组成一个双向链表, 每个数据页中的记录按照主键顺序组成单向链表; 每一个数据页中有一个页目录, 方便按照主键查询记录</strong>. 数据页的结构如下:</p> <p><img src="/img/6e995e20eea8f9564473b66c0bfaf7aa-20230731165210-ltrm3eg.png" alt=""></p> <p><strong>页目录通过槽把记录分成不同的小组, 每个小组有若干条记录</strong>. 如图所示, 记录中最前面的小方块中的数字, 代表的是当前分组的记录条数, 最小和最大的槽指向 2 个特殊的伪记录. 有了槽之后, 按照主键搜索页中记录时, 就可以采用二分法快速搜索, 无需从最小记录开始遍历整个页中的记录链表.</p> <p>举一个例子, 如果要搜索主键(PK)=15 的记录:</p> <ol><li>先二分得出槽中间位是 (0+6)/2=3, 看到其指向的记录是 12 ＜ 15, 所以需要从 <code>#3</code>​ 槽后继续搜索记录;</li> <li>再使用二分搜索出 <code>#3</code>​ 槽和 <code>#6</code>​ 槽的中间位是 (3+6)/2=4.5 取整 4, <code>#4</code>​ 槽对应的记录是 16＞15, 所以记录一定在 <code>#4</code>​ 槽中;</li> <li>再从 <code>#3</code>​ 槽指向的 12 号记录开始向下搜索 3 次, 定位到 15 号记录.</li></ol> <p>理解了 InnoDB 存储数据的原理后, 就可以继续学习 MySQL 索引相关的原理和坑了.</p> <h5 id="聚簇索引和二级索引"><a href="#聚簇索引和二级索引" class="header-anchor">#</a> 聚簇索引和二级索引</h5> <p>说到索引, 页目录就是最简单的索引, 是通过对记录进行一级分组来降低搜索的时间复杂度. 但这样能够降低的时间复杂度数量级, 非常有限. 当有无数个数据页来存储表数据的时候, 就需要考虑如何建立合适的索引, 才能方便定位记录所在的页.</p> <p>为了解决这个问题, InnoDB 引入了 B+ 树. 如下图所示, B+ 树是一棵倒过来的树:</p> <p><img src="/img/24c4870477f9f5ae2f3cae920238a6ff-20230731165210-mgc92z2.png" alt=""></p> <p>B+ 树的特点包括:</p> <ol><li><strong>最底层的节点叫作叶子节点, 用来存放数据</strong>;</li> <li><strong>其他上层节点叫作非叶子节点, 仅用来存放目录项, 作为索引</strong>;</li> <li>非叶子节点分为不同层次, 通过分层来降低每一层的搜索量;</li> <li><strong>所有节点按照索引键大小排序, 构成一个双向链表, 加速范围查找</strong>.</li></ol> <p>因此, InnoDB 使用 B+ 树, 既可以保存实际数据, 也可以加速数据搜索, 这就是<strong>聚簇索引</strong>. 如果把上图叶子节点下面方块中的省略号看作实际数据的话, 那么它就是聚簇索引的示意图. <strong>由于数据在物理上只会保存一份, 所以包含实际数据的聚簇索引只能有一个</strong>.</p> <p><strong>InnoDB 会自动使用主键(唯一定义一条记录的单个或多个字段)作为聚簇索引的索引键</strong>(如果没有主键, 就选择第一个不包含 NULL 值的唯一列). 上图方框中的数字代表了索引键的值, 对聚簇索引而言一般就是主键.</p> <p>再看看 B+ 树如何实现快速查找主键. 比如要搜索 PK=4 的数据, 通过根节点中的索引可以知道数据在第一个记录指向的 2 号页中, 通过 2 号页的索引又可以知道数据在 5 号页, 5 号页就是实际的数据页, 然后再通过二分法查找页目录马上可以找到记录的指针.</p> <p>为了实现<strong>非主键字段的快速搜索, 就引出了二级索引, 也叫作非聚簇索引</strong>, 辅助索引. 二级索引, 也是利用的 B+ 树的数据结构, 如下图所示:</p> <p><img src="/img/886008cda21d2e68fc8c238b64c00f5d-20230731165210-mx3j5kd.png" alt=""></p> <p><strong>这次二级索引的叶子节点中保存的不是实际数据, 而是主键, 获得主键值后去聚簇索引中获得数据行. 这个过程就叫作回表.</strong></p> <p>举个例子, 有个索引是针对用户名字段创建的, 索引记录上面方块中的字母是用户名, 按照顺序形成链表. 如果要搜索用户名为 b 的数据, 经过两次定位可以得出在 <code>#5</code>​ 数据页中, 查出所有的主键为 7 和 6, 再拿着这两个主键继续使用聚簇索引进行两次回表得到完整数据.</p> <h5 id="考虑额外创建二级索引的代价"><a href="#考虑额外创建二级索引的代价" class="header-anchor">#</a> 考虑额外创建二级索引的代价</h5> <p>创建二级索引的代价, 主要表现在<mark><strong>维护代价, 空间代价和回表代价</strong></mark>三个方面. 接下来就仔细分析下.</p> <p><strong>首先是维护代价</strong>. 创建 N 个二级索引, 就需要再创建 N 棵 B+ 树, <strong>新增数据时不仅要修改聚簇索引, 还需要修改这 N 个二级索引</strong>.</p> <p>下面通过实验测试一下创建索引的代价. 假设有一个 person 表, 有主键 ID, 以及 name, score, create_time 三个字段:</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">`</span>person<span class="token punctuation">`</span></span> <span class="token punctuation">(</span>
    <span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span> <span class="token keyword">bigint</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>name<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>score<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>create_time<span class="token punctuation">`</span></span> <span class="token keyword">timestamp</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8mb4<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>通过下面的存储过程循环创建 10 万条测试数据, 我的机器的耗时是 140 秒:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">CREATE</span> <span class="token constant">DEFINER</span><span class="token operator">=</span>`root`@`<span class="token operator">%</span>` <span class="token constant">PROCEDURE</span> `insert_person`<span class="token punctuation">(</span><span class="token punctuation">)</span>
begin
    declare c_id integer <span class="token keyword">default</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> c_id<span class="token operator">&lt;=</span><span class="token number">100000</span> <span class="token keyword">do</span>
    insert into person <span class="token function">values</span><span class="token punctuation">(</span>c_id<span class="token punctuation">,</span> <span class="token function">concat</span><span class="token punctuation">(</span><span class="token char">'name'</span><span class="token punctuation">,</span>c_id<span class="token punctuation">)</span><span class="token punctuation">,</span> c_id<span class="token operator">+</span><span class="token number">100</span><span class="token punctuation">,</span> <span class="token function">date_sub</span><span class="token punctuation">(</span><span class="token function">NOW</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> interval c_id second<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    set c_id<span class="token operator">=</span>c_id<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">;</span>
    end <span class="token keyword">while</span><span class="token punctuation">;</span>
end
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>如果<strong>再创建两个索引</strong>, 一个是 name 和 score 构成的联合索引, 另一个是单一列 create_time 的索引, 那么创建 10 万条记录的耗时提高到 154 秒:</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>KEY <span class="token variable"><span class="token variable">`</span>name_score<span class="token variable">`</span></span> <span class="token punctuation">(</span><span class="token variable"><span class="token variable">`</span>name<span class="token variable">`</span></span>,<span class="token variable"><span class="token variable">`</span>score<span class="token variable">`</span></span><span class="token punctuation">)</span> USING BTREE,
KEY <span class="token variable"><span class="token variable">`</span>create_time<span class="token variable">`</span></span> <span class="token punctuation">(</span><span class="token variable"><span class="token variable">`</span>create_time<span class="token variable">`</span></span><span class="token punctuation">)</span> USING BTREE
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>这里再额外提一下, 页中的记录都是按照索引值从小到大的顺序存放的, 新增记录就需要往页中插入数据, 现有的页满了就需要新创建一个页, 把现有页的部分数据移过去, 这就是<strong>页分裂</strong>; 如果删除了许多数据使得页比较空闲, 还需要进行<strong>页合并</strong>. 页分裂和合并, 都会有 IO 代价, 并且可能在操作过程中产生死锁.</p> <p><strong>其次是空间代价</strong>. 虽然二级索引不保存原始数据, 但要<strong>保存索引列的数据, 所以会占用更多的空间</strong>. 比如, person 表创建了两个索引后, 使用下面的 SQL 查看数据和索引占用的磁盘:</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>SELECT DATA_LENGTH, INDEX_LENGTH FROM information_schema.TABLES WHERE <span class="token assign-left variable">TABLE_NAME</span><span class="token operator">=</span><span class="token string">'person'</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>结果显示, 数据本身只占用了 4.7M, 而索引占用了 8.4M.</p> <p><strong>最后是回表的代价</strong>. 二级索引不保存原始数据, <strong>通过索引找到主键后需要再查询聚簇索引, 才能得到要的数据</strong>. 比如, 使用 <code>SELECT *</code>​ 按照 name 字段查询用户, 使用 EXPLAIN 查看执行计划:</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> person <span class="token keyword">WHERE</span> NAME<span class="token operator">=</span><span class="token string">'name1'</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>执行计划如下, 可以发现:</p> <p><img src="/img/6641fa970313a8a89e479595b2e3b6bb-20230731165210-d7ldshi.png" alt=""></p> <ol><li>key 字段代表实际走的是哪个索引, 其值是 name_score, 说明走的是 name_score 这个索引.</li> <li>type 字段代表了访问表的方式, 其值 ref 说明是二级索引等值匹配, 符合我们的查询.</li></ol> <p>把 SQL 中的 * 修改为 NAME 和 SCORE, 也就是 SELECT name_score 联合索引包含的两列:</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>EXPLAIN SELECT NAME,SCORE FROM person WHERE <span class="token assign-left variable">NAME</span><span class="token operator">=</span><span class="token string">'name1'</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>再来看看执行计划:</p> <p><img src="/img/d2cfae1756e79ee079da0970b4a08721-20230731165210-g8oq814.png" alt=""></p> <p>可以看到, Extra 列多了一行 Using index 的提示, 证明这次查询<strong>直接查的是二级索引, 免去了回表</strong>.</p> <p>原因很简单, <strong>联合索引中其实保存了多个索引列的值, 对于页中的记录先按照字段 1 排序, 如果相同再按照字段 2 排序</strong>, 如图所示:</p> <p><img src="/img/35766771bc2cbb26390138aa84756411-20230731165210-kqv72j4.png" alt=""></p> <p>图中, 叶子节点每一条记录的第一和第二个方块是索引列的数据, 第三个方块是记录的主键. <strong>如果需要查询的是索引列索引或联合索引能覆盖的数据, 那么查询索引本身已经 &quot;覆盖&quot; 了需要的数据, 不再需要回表查询</strong>. 因此, 这种情况也叫作<mark><strong>索引覆盖</strong></mark>. 会在最后一小节介绍如何查看不同查询的成本, 并一起看看索引覆盖和索引查询后回表的代价差异.</p> <p>最后总结下关于<strong>索引开销的最佳实践</strong>.</p> <p>第一, 无需一开始就建立索引, 可以等到业务场景明确后, 或者是数据量超过 1 万, 查询变慢后, 再针对需要查询, 排序或分组的字段创建索引. 创建索引后可以使用 EXPLAIN 命令, 确认查询是否可以使用索引.</p> <p>第二, <strong>尽量索引轻量级的字段</strong>, 比如能索引 int 字段就不要索引 varchar 字段. 索引字段也可以是<strong>部分前缀</strong>, 在创建的时候指定字段索引长度. 针对长文本的搜索, 可以考虑使用 Elasticsearch 等专门用于文本搜索的索引数据库.</p> <p>第三, *<em>尽量不要在 SQL 语句中 SELECT <em>, 而是 SELECT 必要的字段, 甚至可以考虑使用联合索引来包含要搜索的字段, 既能实现索引加速, 又可以避免回表的开销</em></em>.</p> <h5 id="不是所有针对索引列的查询都能用上索引"><a href="#不是所有针对索引列的查询都能用上索引" class="header-anchor">#</a> 不是所有针对索引列的查询都能用上索引</h5> <p>在上一个案例创建了一个 name + score 的联合索引, 仅搜索 name 时就能够用上这个联合索引. 这就引出两个问题:</p> <ol><li>是不是建了索引一定可以用上?</li> <li>怎么选择创建联合索引还是多个独立索引?</li></ol> <p>首先, 通过几个案例来分析一下索引失效的情况.</p> <p>第一, <strong>索引只能匹配列前缀</strong>. 比如下面的 LIKE 语句, 搜索 name 后缀为 name123 的用户无法走索引, 执行计划的 type=ALL 代表了全表扫描:</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> person <span class="token keyword">WHERE</span> NAME <span class="token operator">LIKE</span> <span class="token string">'%name123'</span> <span class="token keyword">LIMIT</span> <span class="token number">100</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><img src="/img/2a46ab74ec7ae5b6038dcaac2d112c57-20230731165210-2988clu.png" alt=""></p> <p>把百分号放到后面走前缀匹配, <strong>type=range 表示走索引扫描, key=name_score 看到实际走了 name_score 索引</strong>:</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> person <span class="token keyword">WHERE</span> NAME <span class="token operator">LIKE</span> <span class="token string">'name123%'</span> <span class="token keyword">LIMIT</span> <span class="token number">100</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><img src="/img/431335e3831e1c9c8cbc0f7ef0a0b48e-20230731165210-k9nbud2.png" alt=""></p> <p>原因很简单, 索引 B+ 树中行数据<strong>按照索引值排序, 只能根据前缀进行比较</strong>. 如果要按照后缀搜索也希望走索引的话, 并且永远只是按照后缀搜索的话, 可以把数据反过来存, 用的时候再倒过来.</p> <p>第二, <strong>条件涉及函数操作无法走索引</strong>. 比如搜索条件用到了 LENGTH 函数, 肯定无法走索引:</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> person <span class="token keyword">WHERE</span> LENGTH<span class="token punctuation">(</span>NAME<span class="token punctuation">)</span><span class="token operator">=</span><span class="token number">7</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><img src="/img/377c6d911988ae48988ffacf7e1416b0-20230731165210-1xexd8p.png" alt=""></p> <p>同样的原因, 索引保存的是索引列的原始值, 而不是经过函数计算后的值. 如果需要针对函数调用走数据库索引的话, 只能保存一份函数变换后的值, 然后重新针对这个计算列做索引.</p> <p>第三, <strong>联合索引只能匹配左边的列</strong>. 也就是说, 虽然对 name 和 score 建了联合索引, 但是仅按照 score 列搜索无法走索引:</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> person <span class="token keyword">WHERE</span> SCORE <span class="token operator">&gt;</span> <span class="token number">45678</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><img src="/img/2bd938a75d135b29b4cee9c5bc4fed8c-20230731165210-dd8tex5.png" alt=""></p> <p>原因也很简单, 在联合索引的情况下, 数据是按照索引第一列排序, 第一列数据相同时才会按照第二列排序. 也就是说, 如果我们想使用联合索引中尽可能多的列, 查询条件中的各个列必须是联合索引中从最左边开始连续的列. 如果仅仅按照第二列搜索, 肯定无法走索引. 尝试把搜索条件加入 name 列, 可以看到走了 name_score 索引:</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> person <span class="token keyword">WHERE</span> SCORE<span class="token operator">&gt;</span><span class="token number">45678</span> <span class="token operator">AND</span> NAME <span class="token operator">LIKE</span> <span class="token string">'NAME45%'</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><img src="/img/3df4dbf3b80f73aabea1de260ec2d05a-20230731165210-h6o5798.png" alt=""></p> <p>需要注意的是, 因为有查询优化器, 所以 name 作为 WHERE 子句的第几个条件并不是很重要.</p> <p>现在回到最开始的两个问题.</p> <ol><li>是不是建了索引一定可以用上? 并不是, 只有当查询能符合索引存储的实际结构时, 才能用上. 这里只给出了三个肯定用不上索引的反例. 其实, <strong>有的时候即使可以走索引, MySQL 也不一定会选择使用索引</strong>. 下一小节会展开这一点.</li> <li>怎么选择建联合索引还是多个独立索引? <strong>如果搜索条件经常会使用多个字段进行搜索, 那么可以考虑针对这几个字段建联合索引; 同时, 针对多字段建立联合索引, 使用索引覆盖的可能更大</strong>. 如果只会查询单个字段, 可以考虑建单独的索引, 毕竟联合索引保存了不必要字段也有成本.</li></ol> <h5 id="数据库基于成本决定是否走索引"><a href="#数据库基于成本决定是否走索引" class="header-anchor">#</a> 数据库基于成本决定是否走索引</h5> <p>通过前面的案例可以看到, 查询数据可以直接在聚簇索引上进行全表扫描, 也可以走二级索引扫描后到聚簇索引回表. 看到这里, 你不禁要问了, <strong>MySQL 到底是怎么确定走哪种方案的</strong>呢.</p> <p>其实, <strong>MySQL 在查询数据之前, 会先对可能的方案做执行计划, 然后依据成本决定走哪个执行计划</strong>.</p> <p>这里的成本, 包括 <mark><strong>IO 成本和 CPU 成本</strong></mark>:</p> <ol><li><strong>IO 成本, 是从磁盘把数据加载到内存的成本</strong>. 默认情况下, 读取数据页的 IO 成本常数是 1(也就是读取 1 个页成本是 1).</li> <li><strong>CPU 成本, 是检测数据是否满足条件和排序等 CPU 操作的成本</strong>. 默认情况下, 检测记录的成本是 0.2.</li></ol> <p>基于此, 来分析下全表扫描的成本.</p> <p>全表扫描, 就是把聚簇索引中的记录依次和给定的搜索条件做比较, 把符合搜索条件的记录加入结果集的过程. 那么要计算全表扫描的代价需要两个信息:</p> <ol><li>聚簇索引占用的页面数, 用来计算读取数据的 IO 成本;</li> <li>表中的记录数, 用来计算搜索的 CPU 成本.</li></ol> <p>那么, MySQL 是实时统计这些信息的吗? 其实并不是, MySQL <strong>维护了表的统计信息</strong>, 可以使用下面的命令查看:</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">SHOW</span> <span class="token keyword">TABLE</span> <span class="token keyword">STATUS</span> <span class="token operator">LIKE</span> <span class="token string">'person'</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>输出如下:</p> <p><img src="/img/fef3d767260f397294c089dffb043fe5-20230731165210-wjbvtrm.png" alt=""></p> <p>可以看到:</p> <ol><li>总行数是 100086 行(之前 EXPLAIN 时, 也看到 rows 为 100086). 你可能说, person 表不是有 10 万行记录吗, 为什么这里多了 86 行? 其实, MySQL 的统计信息是一个<strong>估算</strong>, 其统计方式比较复杂就不再展开了. 但不妨碍根据这个值估算 CPU 成本, 是 <code>100086 * 0.2=20017</code>​ 左右.</li> <li>数据长度是 4734976 字节. 对于 InnoDB 来说, 这就是<strong>聚簇索引占用的空间</strong>, 等于聚簇索引的页面数量 * 每个页面的大小. InnoDB 每个页面的大小是 16KB, 大概计算出页面数量是 289, 因此 IO 成本是 289 左右.</li></ol> <p>所以, 全表扫描的总成本是 20306 左右.</p> <p>接下来, 还是用 person 表这个例子, 分析下 MySQL 如何基于成本来制定执行计划. 现在要用下面的 SQL 查询 <code>name &gt; 'name84059' AND create_time &gt; '2020-01-24 05:00:00'</code>​;</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> person <span class="token keyword">WHERE</span> NAME <span class="token operator">&gt;</span> <span class="token string">'name84059'</span> <span class="token operator">AND</span> create_time <span class="token operator">&gt;</span> <span class="token string">'2020-01-24 05:00:00'</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>其执行计划是<strong>全表扫描</strong>:</p> <p><img src="/img/ea994d4f89b8dd90a6154aa2e6aba51e-20230731165210-sh53xm9.png" alt=""></p> <p>只要把 create_time 条件中的 5 点改为 6 点就变为走索引了, 并且走的是 create_time 索引而不是 name_score 联合索引:</p> <p><img src="/img/020fa73e5953ecae9f1fb3535db4b667-20230731165210-sk46wgc.png" alt=""></p> <p><strong>可以得到两个结论:</strong></p> <ol><li><strong>MySQL 选择索引, 并不是按照 WHERE 条件中列的顺序进行的</strong>;</li> <li><strong>即便列有索引, 甚至有多个可能的索引方案, MySQL 也可能不走索引</strong>.</li></ol> <p>其原因就是, MySQL 并不是猜拳决定是否走索引的, 而是<strong>根据成本来判断</strong>的. 虽然表的统计信息不完全准确, 但足够用于策略的判断了.</p> <p>不过, 有时会因为统计信息的不准确或成本估算的问题, 实际开销会和 MySQL 统计出来的差距较大, 导致 MySQL <strong>选择错误的索引或是直接选择走全表扫描</strong>, 这个时候就需要人工干预, 使用强制索引了. 比如像这样强制走 name_score 索引:</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> person <span class="token keyword">FORCE</span> <span class="token keyword">INDEX</span><span class="token punctuation">(</span>name_score<span class="token punctuation">)</span> <span class="token keyword">WHERE</span> NAME <span class="token operator">&gt;</span> <span class="token string">'name84059'</span> <span class="token operator">AND</span> create_time <span class="token operator">&gt;</span> <span class="token string">'2020-01-24 05:00:00'</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>前面介绍了 MySQL 会根据成本选择执行计划, 也通过 EXPLAIN 知道了优化器最终会选择怎样的执行计划, 但 MySQL 如何制定执行计划始终是一个<strong>黑盒</strong>. 那有没有什么办法可以<strong>了解各种执行计划的成本, 以及 MySQL 做出选择的依据</strong>呢?</p> <p>在 MySQL 5.6 及之后的版本中, 可以<strong>使用 optimizer trace 功能查看优化器生成执行计划的整个过程</strong>. 有了这个功能, 不仅可以了解优化器的选择过程, 更可以了解每一个执行环节的成本, 然后依靠这些信息进一步优化查询.</p> <p>如下代码所示, 打开 optimizer_trace 后, 再执行 SQL 就可以查询 information_schema.OPTIMIZER_TRACE 表查看执行计划了, 最后可以关闭 optimizer_trace 功能:</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">SET</span> optimizer_trace<span class="token operator">=</span><span class="token string">&quot;enabled=on&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> person <span class="token keyword">WHERE</span> NAME <span class="token operator">&gt;</span> <span class="token string">'name84059'</span> <span class="token operator">AND</span> create_time <span class="token operator">&gt;</span> <span class="token string">'2020-01-24 05:00:00'</span><span class="token punctuation">;</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> information_schema<span class="token punctuation">.</span>OPTIMIZER_TRACE<span class="token punctuation">;</span>
<span class="token keyword">SET</span> optimizer_trace<span class="token operator">=</span><span class="token string">&quot;enabled=off&quot;</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>对于按照 <code>create_time &gt; '2020-01-24 05:00:00'</code>​ 条件走全表扫描的 SQL, 从 OPTIMIZER_TRACE 的执行结果中, 摘出了几个重要片段来重点分析:</p> <ul><li>使用 name_score 对 <code>name84059 &lt; name</code>​ 条件进行索引扫描需要扫描 25362 行, 成本是 30435, 因此最终没有选择这个方案. 这里的 30435 是查询二级索引的 IO 成本和 CPU 成本之和, 再加上回表查询聚簇索引的 IO 成本和 CPU 成本之和, 就不再具体分析了:</li></ul> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token punctuation">{</span>
  <span class="token string">&quot;index&quot;</span><span class="token operator">:</span> <span class="token string">&quot;name_score&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;ranges&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token string">&quot;name84059 &lt; name&quot;</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token string">&quot;rows&quot;</span><span class="token operator">:</span> <span class="token number">25362</span><span class="token punctuation">,</span>
  <span class="token string">&quot;cost&quot;</span><span class="token operator">:</span> <span class="token number">30435</span><span class="token punctuation">,</span>
  <span class="token string">&quot;chosen&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  <span class="token string">&quot;cause&quot;</span><span class="token operator">:</span> <span class="token string">&quot;cost&quot;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><ul><li>使用 create_time 进行索引扫描需要扫描 23758 行, 成本是 28511, 同样因为成本原因没有选择这个方案:</li></ul> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token punctuation">{</span>
  <span class="token string">&quot;index&quot;</span><span class="token operator">:</span> <span class="token string">&quot;create_time&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;ranges&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token string">&quot;0x5e2a79d0 &lt; create_time&quot;</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token string">&quot;rows&quot;</span><span class="token operator">:</span> <span class="token number">23758</span><span class="token punctuation">,</span>
  <span class="token string">&quot;cost&quot;</span><span class="token operator">:</span> <span class="token number">28511</span><span class="token punctuation">,</span>
  <span class="token string">&quot;chosen&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  <span class="token string">&quot;cause&quot;</span><span class="token operator">:</span> <span class="token string">&quot;cost&quot;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><ul><li>最终选择了<strong>全表扫描</strong>方式作为执行计划. 可以看到, 全表扫描 100086 条记录的成本是 20306, 和之前计算的一致, 显然是小于其他两个方案的 28511 和 30435:</li></ul> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token punctuation">{</span>
  <span class="token string">&quot;considered_execution_plans&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>
    <span class="token string">&quot;table&quot;</span><span class="token operator">:</span> <span class="token string">&quot;`person`&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;best_access_path&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token string">&quot;considered_access_paths&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>
        <span class="token string">&quot;rows_to_scan&quot;</span><span class="token operator">:</span> <span class="token number">100086</span><span class="token punctuation">,</span>
        <span class="token string">&quot;access_type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;scan&quot;</span><span class="token punctuation">,</span>
        <span class="token string">&quot;resulting_rows&quot;</span><span class="token operator">:</span> <span class="token number">100086</span><span class="token punctuation">,</span>
        <span class="token string">&quot;cost&quot;</span><span class="token operator">:</span> <span class="token number">20306</span><span class="token punctuation">,</span>
        <span class="token string">&quot;chosen&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span>
      <span class="token punctuation">}</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string">&quot;rows_for_plan&quot;</span><span class="token operator">:</span> <span class="token number">100086</span><span class="token punctuation">,</span>
    <span class="token string">&quot;cost_for_plan&quot;</span><span class="token operator">:</span> <span class="token number">20306</span><span class="token punctuation">,</span>
    <span class="token string">&quot;chosen&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span>
  <span class="token punctuation">}</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>把 SQL 中的 create_time 条件从 05:00 改为 06:00, 再次分析 OPTIMIZER_TRACE 可以看到, 这次执行计划选择的是走 create_time 索引. <strong>因为是查询更晚时间的数据, 走 create_time 索引需要扫描的行数从 23758 减少到了 16588</strong>. 这次走这个索引的成本 19907 小于全表扫描的 20306, 更小于走 name_score 索引的 30435:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token punctuation">{</span>
  <span class="token string">&quot;index&quot;</span><span class="token operator">:</span> <span class="token string">&quot;create_time&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;ranges&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token string">&quot;0x5e2a87e0 &lt; create_time&quot;</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token string">&quot;rows&quot;</span><span class="token operator">:</span> <span class="token number">16588</span><span class="token punctuation">,</span>
  <span class="token string">&quot;cost&quot;</span><span class="token operator">:</span> <span class="token number">19907</span><span class="token punctuation">,</span>
  <span class="token string">&quot;chosen&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>有关 optimizer trace 的更多信息, 可以参考MySQL 的文档.</p> <h5 id="重点回顾-7"><a href="#重点回顾-7" class="header-anchor">#</a> 重点回顾</h5> <p>今天分析了 MySQL InnoDB 存储引擎页, 聚簇索引和二级索引的结构, 然后分析了关于索引的两个误区.</p> <p>第一个误区是, 考虑到索引的维护代价, 空间占用和查询时回表的代价, 不能认为索引越多越好. <strong>索引一定是按需创建的, 并且要尽可能确保足够轻量. 一旦创建了多字段的联合索引, 要考虑尽可能利用索引本身完成数据查询, 减少回表的成本</strong>.</p> <p>第二个误区是, <strong>不能认为建了索引就一定有效, 对于后缀的匹配查询, 查询中不包含联合索引的第一列, 查询条件涉及函数计算等情况无法使用索引</strong>. 此外, 即使 SQL 本身符合索引的使用条件, MySQL 也会通过评估各种查询方式的代价, 来决定是否走索引, 以及走哪个索引.</p> <p>因此, 在尝试通过索引进行 SQL 性能优化的时候, 务必通过执行计划或实际的效果来确认索引是否能有效改善性能问题, 否则增加了索引不但没解决性能问题, 还增加了数据库增删改的负担. <strong>如果对 EXPLAIN 给出的执行计划有疑问的话, 还可以利用 optimizer_trace 查看详细的执行计划做进一步分析</strong>.</p> <h4 id="_08-判等问题-程序里如何确定你就是你"><a href="#_08-判等问题-程序里如何确定你就是你" class="header-anchor">#</a> 08-判等问题:程序里如何确定你就是你?</h4> <p>今天来聊聊程序里的判等问题.</p> <p>你可能会说, 判等不就是一行代码的事情吗, 有什么好说的. 但这一行代码如果处理不当, 不仅会出现 Bug, 还可能会引起内存泄露等问题. 涉及判等的 Bug, 即使是使用 == 这种错误的判等方式, 也不是所有时候都会出问题. 所以类似的判等问题不太容易发现, 可能会被隐藏很久.</p> <p>今天就 equals, compareTo 和 Java 的数值缓存, 字符串驻留等问题展开讨论, 希望你可以理解其原理, 彻底消除业务代码中的相关 Bug.</p> <h5 id="注意equals和-的区别"><a href="#注意equals和-的区别" class="header-anchor">#</a> 注意equals和==的区别</h5> <p>在业务代码中, 通常使用 equals 或 <mark> 进行判等操作. equals 是方法而 </mark> 是操作符, 它们的使用是有区别的:</p> <ol><li><strong>对基本类型, 比如 int, long, 进行判等, 只能使用 ==, 比较的是直接值</strong>. 因为基本类型的值就是其数值.</li> <li>对引用类型, 比如 Integer, Long 和 String, 进行判等, 需要<strong>使用 equals 进行内容判等</strong>. 因为引用类型的直接值是指针, <strong>使用 == 的话, 比较的是指针, 也就是两个对象在内存中的地址</strong>, 即比较它们是不是同一个对象, 而不是比较对象的内容.</li></ol> <p>这就引出了必须必须要知道的第一个结论: <strong>比较值的内容, 除了基本类型只能使用 == 外, 其他类型都需要使用 equals</strong>.</p> <p>在开篇提到了, 即使使用 == 对 Integer 或 String 进行判等, 有些时候也能得到正确结果. 这又是为什么呢?</p> <p>用下面的测试用例深入研究下:</p> <ol><li>使用 == 对两个值为 127 的直接赋值的 Integer 对象判等;</li> <li>使用 == 对两个值为 128 的直接赋值的 Integer 对象判等;</li> <li>使用 == 对一个值为 127 的直接赋值的 Integer 和另一个通过 new Integer 声明的值为 127 的对象判等;</li> <li>使用 == 对两个通过 new Integer 声明的值为 127 的对象判等;</li> <li>使用 == 对一个值为 128 的直接赋值的 Integer 对象和另一个值为 128 的 int 基本类型判等.</li></ol> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">Integer</span> a <span class="token operator">=</span> <span class="token number">127</span><span class="token punctuation">;</span> <span class="token comment">//Integer.valueOf(127)</span>
<span class="token class-name">Integer</span> b <span class="token operator">=</span> <span class="token number">127</span><span class="token punctuation">;</span> <span class="token comment">//Integer.valueOf(127)</span>
log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;\nInteger a = 127;\n&quot;</span> <span class="token operator">+</span>
        <span class="token string">&quot;Integer b = 127;\n&quot;</span> <span class="token operator">+</span>
        <span class="token string">&quot;a &lt;mark&gt; b ? {}&quot;</span><span class="token punctuation">,</span>a <span class="token operator">&lt;</span><span class="token operator">/</span>mark<span class="token operator">&gt;</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// true</span>
<span class="token class-name">Integer</span> c <span class="token operator">=</span> <span class="token number">128</span><span class="token punctuation">;</span> <span class="token comment">//Integer.valueOf(128)</span>
<span class="token class-name">Integer</span> d <span class="token operator">=</span> <span class="token number">128</span><span class="token punctuation">;</span> <span class="token comment">//Integer.valueOf(128)</span>
log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;\nInteger c = 128;\n&quot;</span> <span class="token operator">+</span>
        <span class="token string">&quot;Integer d = 128;\n&quot;</span> <span class="token operator">+</span>
        <span class="token string">&quot;c &lt;mark&gt; d ? {}&quot;</span><span class="token punctuation">,</span> c <span class="token operator">&lt;</span><span class="token operator">/</span>mark<span class="token operator">&gt;</span> d<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//false</span>
<span class="token class-name">Integer</span> e <span class="token operator">=</span> <span class="token number">127</span><span class="token punctuation">;</span> <span class="token comment">//Integer.valueOf(127)</span>
<span class="token class-name">Integer</span> f <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Integer</span><span class="token punctuation">(</span><span class="token number">127</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//new instance</span>
log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;\nInteger e = 127;\n&quot;</span> <span class="token operator">+</span>
        <span class="token string">&quot;Integer f = new Integer(127);\n&quot;</span> <span class="token operator">+</span>
        <span class="token string">&quot;e &lt;mark&gt; f ? {}&quot;</span><span class="token punctuation">,</span> e <span class="token operator">&lt;</span><span class="token operator">/</span>mark<span class="token operator">&gt;</span> f<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//false</span>
<span class="token class-name">Integer</span> g <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Integer</span><span class="token punctuation">(</span><span class="token number">127</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//new instance</span>
<span class="token class-name">Integer</span> h <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Integer</span><span class="token punctuation">(</span><span class="token number">127</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//new instance</span>
log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;\nInteger g = new Integer(127);\n&quot;</span> <span class="token operator">+</span>
        <span class="token string">&quot;Integer h = new Integer(127);\n&quot;</span> <span class="token operator">+</span>
        <span class="token string">&quot;g &lt;mark&gt; h ? {}&quot;</span><span class="token punctuation">,</span> g <span class="token operator">&lt;</span><span class="token operator">/</span>mark<span class="token operator">&gt;</span> h<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//false</span>
<span class="token class-name">Integer</span> i <span class="token operator">=</span> <span class="token number">128</span><span class="token punctuation">;</span> <span class="token comment">//unbox</span>
<span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">128</span><span class="token punctuation">;</span>
log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;\nInteger i = 128;\n&quot;</span> <span class="token operator">+</span>
        <span class="token string">&quot;int j = 128;\n&quot;</span> <span class="token operator">+</span>
        <span class="token string">&quot;i &lt;mark&gt; j ? {}&quot;</span><span class="token punctuation">,</span> i <span class="token operator">&lt;</span><span class="token operator">/</span>mark<span class="token operator">&gt;</span> j<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//true</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><p>通过运行结果可以看到, 虽然看起来永远是在对 127 和 127, 128 和 128 判等, 但 == 却没有永远给我们 true 的答复. 原因是什么呢?</p> <p>第一个案例中, 编译器会把 Integer a = 127 转换为 Integer.valueOf(127). 查看源码可以发现, 这个<strong>转换在内部其实做了缓存, 使得两个 Integer 指向同一个对象</strong>, 所以 == 返回 true.</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Integer</span> <span class="token function">valueOf</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">&gt;=</span> <span class="token class-name">IntegerCache</span><span class="token punctuation">.</span>low <span class="token operator">&amp;&amp;</span> i <span class="token operator">&lt;=</span> <span class="token class-name">IntegerCache</span><span class="token punctuation">.</span>high<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token class-name">IntegerCache</span><span class="token punctuation">.</span>cache<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token operator">-</span><span class="token class-name">IntegerCache</span><span class="token punctuation">.</span>low<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Integer</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>第二个案例中, 之所以同样的代码 128 就返回 false 的原因是, 默认情况下会缓存 <code>[-128, 127]</code>​ 的数值, 而 128 处于这个区间之外. 设置 JVM 参数加上 <code>-XX:AutoBoxCacheMax=1000</code>​ 再试试, 是不是就返回 true 了呢?</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">IntegerCache</span> <span class="token punctuation">{</span>
    <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> low <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">128</span><span class="token punctuation">;</span>
    <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> high<span class="token punctuation">;</span>
    <span class="token keyword">static</span> <span class="token punctuation">{</span>
        <span class="token comment">// high value may be configured by property</span>
        <span class="token keyword">int</span> h <span class="token operator">=</span> <span class="token number">127</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> integerCacheHighPropValue <span class="token operator">=</span>
            sun<span class="token punctuation">.</span>misc<span class="token punctuation">.</span><span class="token constant">VM</span><span class="token punctuation">.</span><span class="token function">getSavedProperty</span><span class="token punctuation">(</span><span class="token string">&quot;java.lang.Integer.IntegerCache.high&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>integerCacheHighPropValue <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token function">parseInt</span><span class="token punctuation">(</span>integerCacheHighPropValue<span class="token punctuation">)</span><span class="token punctuation">;</span>
                i <span class="token operator">=</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> <span class="token number">127</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// Maximum array size is Integer.MAX_VALUE</span>
                h <span class="token operator">=</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token constant">MAX_VALUE</span> <span class="token operator">-</span> <span class="token punctuation">(</span><span class="token operator">-</span>low<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span> <span class="token class-name">NumberFormatException</span> nfe<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// If the property cannot be parsed into an int, ignore it.</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        high <span class="token operator">=</span> h<span class="token punctuation">;</span>
        cache <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Integer</span><span class="token punctuation">[</span><span class="token punctuation">(</span>high <span class="token operator">-</span> low<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> j <span class="token operator">=</span> low<span class="token punctuation">;</span>
        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> k <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> k <span class="token operator">&lt;</span> cache<span class="token punctuation">.</span>length<span class="token punctuation">;</span> k<span class="token operator">++</span><span class="token punctuation">)</span>
            cache<span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Integer</span><span class="token punctuation">(</span>j<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// range [-128, 127] must be interned (JLS7 5.1.7)</span>
        <span class="token keyword">assert</span> <span class="token class-name">IntegerCache</span><span class="token punctuation">.</span>high <span class="token operator">&gt;=</span> <span class="token number">127</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><p>第三和第四个案例中, New 出来的 Integer 始终是不走缓存的新对象. <strong>比较两个新对象</strong>, 或者比较一个新对象和一个来自缓存的对象, 结果肯定不是相同的对象, 因此返回 false.</p> <p>第五个案例中, 把装箱的 Integer 和基本类型 int 比较, 前者会先拆箱再比较, 比较的肯定是数值而不是引用, 因此返回 true.</p> <p>看到这里, 对于 Integer 什么时候是相同对象什么时候是不同对象, 就很清楚了吧. 但知道这些其实意义不大, 因为在大多数时候, 并不关心 Integer 对象是否是同一个, <strong>只需要记得比较 Integer 的值请使用 equals</strong>, 而不是 <code>&lt;mark&gt;</code>​(对于基本类型 int 的比较当然只能使用 <code>&lt;/mark&gt;</code>​).</p> <p>其实大家应该都知道这个原则, 只是有的时候特别容易忽略. 以我之前遇到过的一个生产事故为例, 有这么一个枚举定义了订单状态和对于状态的描述:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">enum</span> <span class="token class-name">StatusEnum</span> <span class="token punctuation">{</span>
    <span class="token function">CREATED</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">,</span> <span class="token string">&quot;已创建&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">PAID</span><span class="token punctuation">(</span><span class="token number">1001</span><span class="token punctuation">,</span> <span class="token string">&quot;已支付&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">DELIVERED</span><span class="token punctuation">(</span><span class="token number">1002</span><span class="token punctuation">,</span> <span class="token string">&quot;已送到&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">FINISHED</span><span class="token punctuation">(</span><span class="token number">1003</span><span class="token punctuation">,</span> <span class="token string">&quot;已完成&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Integer</span> status<span class="token punctuation">;</span> <span class="token comment">// 注意这里的Integer</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">String</span> desc<span class="token punctuation">;</span>
    <span class="token class-name">StatusEnum</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> status<span class="token punctuation">,</span> <span class="token class-name">String</span> desc<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">=</span> status<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>desc <span class="token operator">=</span> desc<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>在业务代码中, 开发同学使用了 <code>==</code>​ 对枚举和入参 OrderQuery 中的 status 属性进行判等:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Data</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderQuery</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token class-name">Integer</span> status<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;enumcompare&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">enumcompare</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">OrderQuery</span> orderQuery<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token class-name">StatusEnum</span> statusEnum <span class="token operator">=</span> <span class="token class-name">StatusEnum</span><span class="token punctuation">.</span><span class="token constant">DELIVERED</span><span class="token punctuation">;</span>
    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;orderQuery:{} statusEnum:{} result:{}&quot;</span><span class="token punctuation">,</span> orderQuery<span class="token punctuation">,</span> statusEnum<span class="token punctuation">,</span> statusEnum<span class="token punctuation">.</span>status <span class="token operator">==</span> orderQuery<span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p><strong>因为枚举和入参 OrderQuery 中的 status 都是包装类型, 所以通过 == 判等肯定是有问题的. 只是这个问题比较隐晦</strong>, 究其原因在于:</p> <ol><li>只看枚举的定义 CREATED(1000, &quot;已创建&quot;), 容易让人误解 status 值是基本类型;</li> <li>因为有 Integer 缓存机制的存在, 所以使用 <code>==</code>​ 判等并不是所有情况下都有问题. 在这次事故中, 订单状态的值从 100 开始增长, 程序一开始不出问题, 直到订单状态超过 127 后才出现 Bug.</li></ol> <p>在了解清楚为什么 Integer 使用 <code>==</code>​ 判等有时候也有效的原因之后, 再来看看为什么 String 也有这个问题. 使用几个用例来测试下:</p> <ol><li>对两个直接声明的值都为 1 的 String 使用 <code>==</code>​ 判等;</li> <li>对两个 new 出来的值都为 2 的 String 使用 <code>==</code>​ 判等;</li> <li>对两个 new 出来的值都为 3 的 String 先进行 intern 操作, 再使用 <code>==</code>​ 判等;</li> <li>对两个 new 出来的值都为 4 的 String 通过 equals 判等.</li></ol> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">String</span> a <span class="token operator">=</span> <span class="token string">&quot;1&quot;</span><span class="token punctuation">;</span>
<span class="token class-name">String</span> b <span class="token operator">=</span> <span class="token string">&quot;1&quot;</span><span class="token punctuation">;</span>
log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;\nString a = \&quot;1\&quot;;\n&quot;</span> <span class="token operator">+</span>
        <span class="token string">&quot;String b = \&quot;1\&quot;;\n&quot;</span> <span class="token operator">+</span>
        <span class="token string">&quot;a &lt;mark&gt; b ? {}&quot;</span><span class="token punctuation">,</span> a <span class="token operator">&lt;</span><span class="token operator">/</span>mark<span class="token operator">&gt;</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// true</span>
<span class="token class-name">String</span> c <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span><span class="token string">&quot;2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">String</span> d <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span><span class="token string">&quot;2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;\nString c = new String(\&quot;2\&quot;);\n&quot;</span> <span class="token operator">+</span>
        <span class="token string">&quot;String d = new String(\&quot;2\&quot;);&quot;</span> <span class="token operator">+</span>
        <span class="token string">&quot;c &lt;mark&gt; d ? {}&quot;</span><span class="token punctuation">,</span> c <span class="token operator">&lt;</span><span class="token operator">/</span>mark<span class="token operator">&gt;</span> d<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// false</span>
<span class="token class-name">String</span> e <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span><span class="token string">&quot;3&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">intern</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">String</span> f <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span><span class="token string">&quot;3&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">intern</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;\nString e = new String(\&quot;3\&quot;).intern();\n&quot;</span> <span class="token operator">+</span>
        <span class="token string">&quot;String f = new String(\&quot;3\&quot;).intern();\n&quot;</span> <span class="token operator">+</span>
        <span class="token string">&quot;e &lt;mark&gt; f ? {}&quot;</span><span class="token punctuation">,</span> e <span class="token operator">&lt;</span><span class="token operator">/</span>mark<span class="token operator">&gt;</span> f<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// true</span>
<span class="token class-name">String</span> g <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span><span class="token string">&quot;4&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">String</span> h <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span><span class="token string">&quot;4&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;\nString g = new String(\&quot;4\&quot;);\n&quot;</span> <span class="token operator">+</span>
        <span class="token string">&quot;String h = new String(\&quot;4\&quot;);\n&quot;</span> <span class="token operator">+</span>
        <span class="token string">&quot;g == h ? {}&quot;</span><span class="token punctuation">,</span> g<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>h<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// true</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><p>在分析这个结果之前, 先说说 Java 的字符串常量池机制. 首先要明确的是其设计初衷是节省内存. <strong>当代码中出现双引号形式创建字符串对象时, JVM 会先对这个字符串进行检查, 如果字符串常量池中存在相同内容的字符串对象的引用, 则将这个引用返回; 否则, 创建新的字符串对象, 然后将这个引用放入字符串常量池, 并返回该引用. 这种机制, 就是字符串驻留或池化</strong>.</p> <p>再回到刚才的例子, 再来分析一下运行结果:</p> <ol><li>第一个案例返回 true, 因为 Java 的字符串驻留机制, 直接使用双引号声明出来的两个 String 对象指向常量池中的相同字符串.</li> <li>第二个案例, new 出来的两个 String 是不同对象, 引用当然不同, 所以得到 false 的结果.</li> <li>第三个案例, 使用 String 提供的 intern 方法也会走常量池机制, 所以同样能得到 true.</li> <li>第四个案例, 通过 equals 对值内容判等, 是正确的处理方式, 当然会得到 true.</li></ol> <p><strong>虽然使用 new 声明的字符串调用 intern 方法, 也可以让字符串进行驻留, 但在业务代码中滥用 intern, 可能会产生性能问题</strong>.</p> <p>写代码测试一下, 通过循环把 1 到 1000 万之间的数字以字符串形式 intern 后, 存入一个 List:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;internperformance&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">internperformance</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;size&quot;</span><span class="token punctuation">,</span> defaultValue <span class="token operator">=</span> <span class="token string">&quot;10000000&quot;</span><span class="token punctuation">)</span><span class="token keyword">int</span> size<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// -XX:+PrintStringTableStatistics</span>
    <span class="token comment">// -XX:StringTableSize=10000000</span>
    <span class="token keyword">long</span> begin <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    list <span class="token operator">=</span> <span class="token class-name">IntStream</span><span class="token punctuation">.</span><span class="token function">rangeClosed</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> size<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">mapToObj</span><span class="token punctuation">(</span>i<span class="token operator">-&gt;</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">intern</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;size:{} took:{}&quot;</span><span class="token punctuation">,</span> size<span class="token punctuation">,</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> begin<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> list<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>在启动程序时设置 JVM 参数 <code>-XX:+PrintStringTableStatistic</code>​, 程序退出时可以打印出字符串常量表的统计信息. 调用接口后关闭程序, 输出如下:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token punctuation">[</span><span class="token number">11</span><span class="token operator">:</span><span class="token number">01</span><span class="token operator">:</span><span class="token number">57.770</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>http<span class="token operator">-</span>nio<span class="token operator">-</span><span class="token number">45678</span><span class="token operator">-</span>exec<span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token constant">INFO</span> <span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token punctuation">.</span>t<span class="token punctuation">.</span>c<span class="token punctuation">.</span>e<span class="token punctuation">.</span>d<span class="token punctuation">.</span>IntAndStringEqualController<span class="token operator">:</span><span class="token number">54</span>  <span class="token punctuation">]</span> <span class="token operator">-</span> size<span class="token operator">:</span><span class="token number">10000000</span> took<span class="token operator">:</span><span class="token number">44907</span>
<span class="token class-name">StringTable</span> statistics<span class="token operator">:</span>
<span class="token class-name">Number</span> of buckets       <span class="token operator">:</span>     <span class="token number">60013</span> <span class="token operator">=</span>    <span class="token number">480104</span> bytes<span class="token punctuation">,</span> avg   <span class="token number">8.000</span>
<span class="token class-name">Number</span> of entries       <span class="token operator">:</span>  <span class="token number">10030230</span> <span class="token operator">=</span> <span class="token number">240725520</span> bytes<span class="token punctuation">,</span> avg  <span class="token number">24.000</span>
<span class="token class-name">Number</span> of literals      <span class="token operator">:</span>  <span class="token number">10030230</span> <span class="token operator">=</span> <span class="token number">563005568</span> bytes<span class="token punctuation">,</span> avg  <span class="token number">56.131</span>
<span class="token class-name">Total</span> footprint         <span class="token operator">:</span>           <span class="token operator">=</span> <span class="token number">804211192</span> bytes
<span class="token class-name">Average</span> bucket size     <span class="token operator">:</span>   <span class="token number">167.134</span>
<span class="token class-name">Variance</span> of bucket size <span class="token operator">:</span>    <span class="token number">55.808</span>
<span class="token class-name">Std</span><span class="token punctuation">.</span> dev<span class="token punctuation">.</span> of bucket size<span class="token operator">:</span>     <span class="token number">7.471</span>
<span class="token class-name">Maximum</span> bucket size     <span class="token operator">:</span>       <span class="token number">198</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>可以看到, 1000 万次 intern 操作耗时居然超过了 44 秒.</p> <p>其实, 原因在于<strong>字符串常量池是一个固定容量的 Map</strong>. 如果容量太小(Number of buckets=60013), 字符串太多(1000 万个字符串), 那么每一个桶中的字符串数量会非常多, 所以搜索起来就很慢. 输出结果中的 Average bucket size=167, 代表了 Map 中桶的平均长度是 167.</p> <p>解决方式是, 设置 JVM 参数 <code>-XX:StringTableSize</code>​, 指定更多的桶. 设置 <code>-XX:StringTableSize=10000000</code>​ 后, 重启应用:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token punctuation">[</span><span class="token number">11</span><span class="token operator">:</span><span class="token number">09</span><span class="token operator">:</span><span class="token number">04.475</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>http<span class="token operator">-</span>nio<span class="token operator">-</span><span class="token number">45678</span><span class="token operator">-</span>exec<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token constant">INFO</span> <span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token punctuation">.</span>t<span class="token punctuation">.</span>c<span class="token punctuation">.</span>e<span class="token punctuation">.</span>d<span class="token punctuation">.</span>IntAndStringEqualController<span class="token operator">:</span><span class="token number">54</span>  <span class="token punctuation">]</span> <span class="token operator">-</span> size<span class="token operator">:</span><span class="token number">10000000</span> took<span class="token operator">:</span><span class="token number">5557</span>
<span class="token class-name">StringTable</span> statistics<span class="token operator">:</span>
<span class="token class-name">Number</span> of buckets       <span class="token operator">:</span>  <span class="token number">10000000</span> <span class="token operator">=</span>  <span class="token number">80000000</span> bytes<span class="token punctuation">,</span> avg   <span class="token number">8.000</span>
<span class="token class-name">Number</span> of entries       <span class="token operator">:</span>  <span class="token number">10030156</span> <span class="token operator">=</span> <span class="token number">240723744</span> bytes<span class="token punctuation">,</span> avg  <span class="token number">24.000</span>
<span class="token class-name">Number</span> of literals      <span class="token operator">:</span>  <span class="token number">10030156</span> <span class="token operator">=</span> <span class="token number">562999472</span> bytes<span class="token punctuation">,</span> avg  <span class="token number">56.131</span>
<span class="token class-name">Total</span> footprint         <span class="token operator">:</span>           <span class="token operator">=</span> <span class="token number">883723216</span> bytes
<span class="token class-name">Average</span> bucket size     <span class="token operator">:</span>     <span class="token number">1.003</span>
<span class="token class-name">Variance</span> of bucket size <span class="token operator">:</span>     <span class="token number">1.587</span>
<span class="token class-name">Std</span><span class="token punctuation">.</span> dev<span class="token punctuation">.</span> of bucket size<span class="token operator">:</span>     <span class="token number">1.260</span>
<span class="token class-name">Maximum</span> bucket size     <span class="token operator">:</span>        <span class="token number">10</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>可以看到, 1000 万次调用耗时只有 5.5 秒, Average bucket size 降到了 1, 效果明显.</p> <p>好了, 是时候给出第二原则了: <strong>没事别轻易用 intern(), 如果要用一定要注意控制驻留的字符串的数量, 并留意常量表的各项指标</strong>.</p> <h5 id="实现一个equals没有这么简单"><a href="#实现一个equals没有这么简单" class="header-anchor">#</a> 实现一个equals没有这么简单</h5> <p>如果看过 Object 类源码, 你可能就知道, <strong>equals 的实现其实是比较对象引用</strong>:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">equals</span><span class="token punctuation">(</span><span class="token class-name">Object</span> obj<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token operator">==</span> obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>之所以 Integer 或 String 能通过 equals 实现内容判等, 是因为它们都重写了这个方法. 比如 String 的 equals 的实现:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">equals</span><span class="token punctuation">(</span><span class="token class-name">Object</span> anObject<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token operator">==</span> anObject<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>anObject <span class="token keyword">instanceof</span> <span class="token class-name">String</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> anotherString <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span>anObject<span class="token punctuation">;</span>
        <span class="token keyword">int</span> n <span class="token operator">=</span> value<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>n <span class="token operator">==</span> anotherString<span class="token punctuation">.</span>value<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">char</span> v1<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> value<span class="token punctuation">;</span>
            <span class="token keyword">char</span> v2<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> anotherString<span class="token punctuation">.</span>value<span class="token punctuation">;</span>
            <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span>n<span class="token operator">--</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>v1<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">!=</span> v2<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
                    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                i<span class="token operator">++</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p>对于<strong>自定义类型, 如果不重写 equals 的话, 默认就是使用 Object 基类的按引用的比较方式</strong>. 下面写一个自定义类测试一下.</p> <p>假设有这样一个描述点的类 Point, 有 x, y 和描述三个属性:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">class</span> <span class="token class-name">Point</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">int</span> x<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> y<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">String</span> desc<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">Point</span><span class="token punctuation">(</span><span class="token keyword">int</span> x<span class="token punctuation">,</span> <span class="token keyword">int</span> y<span class="token punctuation">,</span> <span class="token class-name">String</span> desc<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>x <span class="token operator">=</span> x<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>y <span class="token operator">=</span> y<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>desc <span class="token operator">=</span> desc<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>定义三个点 p1, p2 和 p3, 其中 p1 和 p2 的描述属性不同, p1 和 p3 的三个属性完全相同, 并写一段代码测试一下默认行为:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">Point</span> p1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Point</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">&quot;a&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Point</span> p2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Point</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">&quot;b&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Point</span> p3 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Point</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">&quot;a&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;p1.equals(p2) ? {}&quot;</span><span class="token punctuation">,</span> p1<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>p2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;p1.equals(p3) ? {}&quot;</span><span class="token punctuation">,</span> p1<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>p3<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>通过 equals 方法比较 p1 和 p2, p1 和 p3 均得到 false, 原因正如刚才所说, 并没有为 Point 类实现自定义的 equals 方法, Object 超类中的 equals 默认使用 <code>==</code>​ 判等, 比较的是对象的引用.</p> <p>这里期望的逻辑是, 只要 x 和 y 这 2 个属性一致就代表是同一个点, 所以写出了如下的改进代码, 重写 equals 方法, 把参数中的 Object 转换为 Point 比较其 x 和 y 属性:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">class</span> <span class="token class-name">PointWrong</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> x<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> y<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">String</span> desc<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">PointWrong</span><span class="token punctuation">(</span><span class="token keyword">int</span> x<span class="token punctuation">,</span> <span class="token keyword">int</span> y<span class="token punctuation">,</span> <span class="token class-name">String</span> desc<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>x <span class="token operator">=</span> x<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>y <span class="token operator">=</span> y<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>desc <span class="token operator">=</span> desc<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">equals</span><span class="token punctuation">(</span><span class="token class-name">Object</span> o<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">PointWrong</span> that <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">PointWrong</span><span class="token punctuation">)</span> o<span class="token punctuation">;</span>
        <span class="token keyword">return</span> x <span class="token generics"><span class="token punctuation">&lt;</span>mark<span class="token punctuation">&gt;</span></span> that<span class="token punctuation">.</span>x <span class="token operator">&amp;&amp;</span> y <span class="token operator">&lt;</span><span class="token operator">/</span>mark<span class="token operator">&gt;</span> that<span class="token punctuation">.</span>y<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>为测试改进后的 Point 是否可以满足需求, 定义了三个用例:</p> <ol><li>比较一个 Point 对象和 null;</li> <li>比较一个 Object 对象和一个 Point 对象;</li> <li>比较两个 x 和 y 属性值相同的 Point 对象.</li></ol> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">PointWrong</span> p1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PointWrong</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">&quot;a&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">try</span> <span class="token punctuation">{</span>
    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;p1.equals(null) ? {}&quot;</span><span class="token punctuation">,</span> p1<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>ex<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token class-name">Object</span> o <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">try</span> <span class="token punctuation">{</span>
    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;p1.equals(expression) ? {}&quot;</span><span class="token punctuation">,</span> p1<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>o<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>ex<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token class-name">PointWrong</span> p2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PointWrong</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">&quot;b&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;p1.equals(p2) ? {}&quot;</span><span class="token punctuation">,</span> p1<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>p2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p>通过日志中的结果可以看到, 第一次比较出现了空指针异常, 第二次比较出现了类型转换异常, 第三次比较符合预期输出了 true.</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token punctuation">[</span><span class="token number">17</span><span class="token operator">:</span><span class="token number">54</span><span class="token operator">:</span><span class="token number">39.120</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>http<span class="token operator">-</span>nio<span class="token operator">-</span><span class="token number">45678</span><span class="token operator">-</span>exec<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token constant">ERROR</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token class-name"><span class="token namespace">t<span class="token punctuation">.</span>c<span class="token punctuation">.</span>e<span class="token punctuation">.</span>demo1<span class="token punctuation">.</span></span>EqualityMethodController</span><span class="token operator">:</span><span class="token number">32</span>  <span class="token punctuation">]</span> <span class="token operator">-</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>NullPointerException</span>
<span class="token punctuation">[</span><span class="token number">17</span><span class="token operator">:</span><span class="token number">54</span><span class="token operator">:</span><span class="token number">39.120</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>http<span class="token operator">-</span>nio<span class="token operator">-</span><span class="token number">45678</span><span class="token operator">-</span>exec<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token constant">ERROR</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token class-name"><span class="token namespace">t<span class="token punctuation">.</span>c<span class="token punctuation">.</span>e<span class="token punctuation">.</span>demo1<span class="token punctuation">.</span></span>EqualityMethodController</span><span class="token operator">:</span><span class="token number">39</span>  <span class="token punctuation">]</span> <span class="token operator">-</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>ClassCastException</span><span class="token operator">:</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>Object</span> cannot be cast <span class="token keyword">to</span> <span class="token namespace">org<span class="token punctuation">.</span>geekbang<span class="token punctuation">.</span>time<span class="token punctuation">.</span>commonmistakes<span class="token punctuation">.</span>equals<span class="token punctuation">.</span>demo1<span class="token punctuation">.</span></span><span class="token class-name">EqualityMethodController</span>$<span class="token class-name">PointWrong</span>
<span class="token punctuation">[</span><span class="token number">17</span><span class="token operator">:</span><span class="token number">54</span><span class="token operator">:</span><span class="token number">39.120</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>http<span class="token operator">-</span>nio<span class="token operator">-</span><span class="token number">45678</span><span class="token operator">-</span>exec<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token constant">INFO</span> <span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token class-name"><span class="token namespace">t<span class="token punctuation">.</span>c<span class="token punctuation">.</span>e<span class="token punctuation">.</span>demo1<span class="token punctuation">.</span></span>EqualityMethodController</span><span class="token operator">:</span><span class="token number">43</span>  <span class="token punctuation">]</span> <span class="token operator">-</span> p1<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>p2<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token boolean">true</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p><strong>通过这些失效的用例, 大概可以总结出实现一个更好的 equals 应该注意的点:</strong></p> <ol><li>考虑到性能, <strong>可以先进行指针判等, 如果对象是同一个那么直接返回 true</strong>;</li> <li><strong>需要对另一方进行判空, 空对象和自身进行比较</strong>, 结果一定是 fasle;</li> <li>需要判断两个对象的类型, 如果类型都不同, 那么直接返回 false;</li> <li>确保类型相同的情况下再进行类型强制转换, 然后逐一判断所有字段.</li></ol> <p>修复和改进后的 equals 方法如下:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">equals</span><span class="token punctuation">(</span><span class="token class-name">Object</span> o<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token generics"><span class="token punctuation">&lt;</span>mark<span class="token punctuation">&gt;</span></span> o<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>o <span class="token operator">&lt;</span><span class="token operator">/</span>mark<span class="token operator">&gt;</span> <span class="token keyword">null</span> <span class="token operator">||</span> <span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> o<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token class-name">PointRight</span> that <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">PointRight</span><span class="token punctuation">)</span> o<span class="token punctuation">;</span>
    <span class="token keyword">return</span> x <span class="token generics"><span class="token punctuation">&lt;</span>mark<span class="token punctuation">&gt;</span></span> that<span class="token punctuation">.</span>x <span class="token operator">&amp;&amp;</span> y <span class="token operator">&lt;</span><span class="token operator">/</span>mark<span class="token operator">&gt;</span> that<span class="token punctuation">.</span>y<span class="token punctuation">;</span>
<span class="token punctuation">}</span>  
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>改进后的 equals 看起来完美了, 但还没完. 继续往下看.</p> <h5 id="hashcode和equals要配对实现"><a href="#hashcode和equals要配对实现" class="header-anchor">#</a> hashCode和equals要配对实现</h5> <p>来试试下面这个用例, 定义两个 x 和 y 属性值完全一致的 Point 对象 p1 和 p2, 把 p1 加入 HashSet, 然后判断这个 Set 中是否存在 p2:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">PointWrong</span> p1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PointWrong</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">&quot;a&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">PointWrong</span> p2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PointWrong</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">&quot;b&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">HashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PointWrong</span><span class="token punctuation">&gt;</span></span> points <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
points<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>p1<span class="token punctuation">)</span><span class="token punctuation">;</span>

log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;points.contains(p2) ? {}&quot;</span><span class="token punctuation">,</span> points<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>p2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>按照改进后的 equals 方法, 这 2 个对象可以认为是同一个, Set 中已经存在了 p1 就应该包含 p2, 但结果却是 false.</p> <p>出现这个 Bug 的原因是, <strong>散列表需要使用 hashCode 来定位元素放到哪个桶</strong>. 如果自定义对象没有实现自定义的 hashCode 方法, 就会使用 Object 超类的默认实现, <strong>得到的两个 hashCode 是不同的, 导致无法满足需求</strong>.</p> <p>要自定义 hashCode, 可以直接使用 <strong>Objects.hash</strong> 方法来实现, 改进后的 Point 类如下:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">class</span> <span class="token class-name">PointRight</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">int</span> x<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">int</span> y<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">String</span> desc<span class="token punctuation">;</span>

    <span class="token comment">// ...</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">equals</span><span class="token punctuation">(</span><span class="token class-name">Object</span> o<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// ...</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">hashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">hash</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>改进 equals 和 hashCode 后, 再测试下之前的四个用例, 结果全部符合预期.</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token punctuation">[</span><span class="token number">18</span><span class="token operator">:</span><span class="token number">25</span><span class="token operator">:</span><span class="token number">23.091</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>http<span class="token operator">-</span>nio<span class="token operator">-</span><span class="token number">45678</span><span class="token operator">-</span>exec<span class="token operator">-</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token constant">INFO</span> <span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token class-name"><span class="token namespace">t<span class="token punctuation">.</span>c<span class="token punctuation">.</span>e<span class="token punctuation">.</span>demo1<span class="token punctuation">.</span></span>EqualityMethodController</span><span class="token operator">:</span><span class="token number">54</span>  <span class="token punctuation">]</span> <span class="token operator">-</span> p1<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token boolean">false</span>
<span class="token punctuation">[</span><span class="token number">18</span><span class="token operator">:</span><span class="token number">25</span><span class="token operator">:</span><span class="token number">23.093</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>http<span class="token operator">-</span>nio<span class="token operator">-</span><span class="token number">45678</span><span class="token operator">-</span>exec<span class="token operator">-</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token constant">INFO</span> <span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token class-name"><span class="token namespace">t<span class="token punctuation">.</span>c<span class="token punctuation">.</span>e<span class="token punctuation">.</span>demo1<span class="token punctuation">.</span></span>EqualityMethodController</span><span class="token operator">:</span><span class="token number">61</span>  <span class="token punctuation">]</span> <span class="token operator">-</span> p1<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>expression<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token boolean">false</span>
<span class="token punctuation">[</span><span class="token number">18</span><span class="token operator">:</span><span class="token number">25</span><span class="token operator">:</span><span class="token number">23.094</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>http<span class="token operator">-</span>nio<span class="token operator">-</span><span class="token number">45678</span><span class="token operator">-</span>exec<span class="token operator">-</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token constant">INFO</span> <span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token class-name"><span class="token namespace">t<span class="token punctuation">.</span>c<span class="token punctuation">.</span>e<span class="token punctuation">.</span>demo1<span class="token punctuation">.</span></span>EqualityMethodController</span><span class="token operator">:</span><span class="token number">67</span>  <span class="token punctuation">]</span> <span class="token operator">-</span> p1<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>p2<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token boolean">true</span>
<span class="token punctuation">[</span><span class="token number">18</span><span class="token operator">:</span><span class="token number">25</span><span class="token operator">:</span><span class="token number">23.094</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>http<span class="token operator">-</span>nio<span class="token operator">-</span><span class="token number">45678</span><span class="token operator">-</span>exec<span class="token operator">-</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token constant">INFO</span> <span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token class-name"><span class="token namespace">t<span class="token punctuation">.</span>c<span class="token punctuation">.</span>e<span class="token punctuation">.</span>demo1<span class="token punctuation">.</span></span>EqualityMethodController</span><span class="token operator">:</span><span class="token number">71</span>  <span class="token punctuation">]</span> <span class="token operator">-</span> points<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>p2<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token boolean">true</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>看到这里, 你可能会觉得自己实现 equals 和 hashCode 很麻烦, 实现 equals 有很多注意点而且代码量很大. 不过, 实现这两个方法也有简单的方式, 一是后面要讲到的 Lombok 方法, 二是使用 IDE 的代码生成功能.</p> <h5 id="注意compareto和equals的逻辑一致性"><a href="#注意compareto和equals的逻辑一致性" class="header-anchor">#</a> 注意compareTo和equals的逻辑一致性</h5> <p>除了自定义类型需要确保 equals 和 hashCode 要逻辑一致外, 还有一个更容易被忽略的问题, <strong>即 compareTo 同样需要和 equals 确保逻辑一致性</strong>.</p> <p>我之前遇到过这么一个问题, 代码里本来使用了 ArrayList 的 indexOf 方法进行元素搜索, 但是一位好心的开发同学觉得逐一比较的时间复杂度是 O(n), 效率太低了, 于是改为了排序后通过 Collections.binarySearch 方法进行搜索, 实现了 O(log n) 的时间复杂度. 没想到这么一改却出现了 Bug.</p> <p>来重现下这个问题. 首先定义一个 Student 类, 有 id 和 name 两个属性, 并实现了一个 Comparable 接口来返回两个 id 的值:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Data</span>
<span class="token annotation punctuation">@AllArgsConstructor</span>
<span class="token keyword">class</span> <span class="token class-name">Student</span> <span class="token keyword">implements</span> <span class="token class-name">Comparable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Student</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> id<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">compareTo</span><span class="token punctuation">(</span><span class="token class-name">Student</span> other<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> result <span class="token operator">=</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">compare</span><span class="token punctuation">(</span>other<span class="token punctuation">.</span>id<span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token generics"><span class="token punctuation">&lt;</span>mark<span class="token punctuation">&gt;</span></span> <span class="token number">0</span><span class="token punctuation">)</span>
            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;this {} &lt;/mark&gt; other {}&quot;</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">,</span> other<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>然后, 写一段测试代码分别通过 indexOf 方法和 Collections.binarySearch 方法进行搜索. 列表中存放了两个学生, 第一个学生 id 是 1 叫 zhang, 第二个学生 id 是 2 叫 wang, 搜索这个列表是否存在一个 id 是 2 叫 li 的学生:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;wrong&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">wrong</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Student</span><span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Student</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">&quot;zhang&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Student</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">&quot;wang&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">Student</span> student <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Student</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">&quot;li&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;ArrayList.indexOf&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">int</span> index1 <span class="token operator">=</span> list<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>student<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span>list<span class="token punctuation">)</span><span class="token punctuation">;</span>
    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;Collections.binarySearch&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">int</span> index2 <span class="token operator">=</span> <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">binarySearch</span><span class="token punctuation">(</span>list<span class="token punctuation">,</span> student<span class="token punctuation">)</span><span class="token punctuation">;</span>
    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;index1 = &quot;</span> <span class="token operator">+</span> index1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;index2 = &quot;</span> <span class="token operator">+</span> index2<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>代码输出的日志如下:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token punctuation">[</span><span class="token number">18</span><span class="token operator">:</span><span class="token number">46</span><span class="token operator">:</span><span class="token number">50.226</span><span class="token punctuation">]</span> <span class="token operator">-</span> <span class="token class-name">ArrayList</span><span class="token punctuation">.</span>indexOf
<span class="token punctuation">[</span><span class="token number">18</span><span class="token operator">:</span><span class="token number">46</span><span class="token operator">:</span><span class="token number">50.226</span><span class="token punctuation">]</span> <span class="token operator">-</span> <span class="token class-name">Collections</span><span class="token punctuation">.</span>binarySearch
<span class="token punctuation">[</span><span class="token number">18</span><span class="token operator">:</span><span class="token number">46</span><span class="token operator">:</span><span class="token number">50.227</span><span class="token punctuation">]</span> <span class="token operator">-</span> <span class="token keyword">this</span> <span class="token class-name">CompareToController<span class="token punctuation">.</span>Student</span><span class="token punctuation">(</span>id<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> name<span class="token operator">=</span>wang<span class="token punctuation">)</span> <span class="token operator">==</span> other <span class="token class-name">CompareToController<span class="token punctuation">.</span>Student</span><span class="token punctuation">(</span>id<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> name<span class="token operator">=</span>li<span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token number">18</span><span class="token operator">:</span><span class="token number">46</span><span class="token operator">:</span><span class="token number">50.227</span><span class="token punctuation">]</span> <span class="token operator">-</span> index1 <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span>
<span class="token punctuation">[</span><span class="token number">18</span><span class="token operator">:</span><span class="token number">46</span><span class="token operator">:</span><span class="token number">50.227</span><span class="token punctuation">]</span> <span class="token operator">-</span> index2 <span class="token operator">=</span> <span class="token number">1</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>可以注意到如下几点:</p> <ol><li><strong>binarySearch 方法内部调用了元素的 compareTo 方法进行比较</strong>;</li> <li>indexOf 的结果没问题, 列表中搜索不到 id 为 2, name 是 li 的学生;</li> <li>binarySearch 返回了索引 1, 代表搜索到的结果是 id 为 2, name 是 wang 的学生.</li></ol> <p>修复方式很简单, <strong>确保 compareTo 的比较逻辑和 equals 的实现一致即可</strong>. 重新实现一下 Student 类, 通过 Comparator.comparing 这个便捷的方法来实现两个字段的比较:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Data</span>
<span class="token annotation punctuation">@AllArgsConstructor</span>
<span class="token keyword">class</span> <span class="token class-name">StudentRight</span> <span class="token keyword">implements</span> <span class="token class-name">Comparable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">StudentRight</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">int</span> id<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">compareTo</span><span class="token punctuation">(</span><span class="token class-name">StudentRight</span> other<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">Comparator</span><span class="token punctuation">.</span><span class="token function">comparing</span><span class="token punctuation">(</span><span class="token class-name">StudentRight</span><span class="token operator">::</span><span class="token function">getName</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">thenComparingInt</span><span class="token punctuation">(</span><span class="token class-name">StudentRight</span><span class="token operator">::</span><span class="token function">getId</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">compare</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> other<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>其实, 这个问题容易被忽略的原因在于两方面:</p> <ol><li>一是, 使用了 Lombok 的 @Data 标记了 Student,  <strong>@Data 注解(详见这里)其实包含了 @EqualsAndHashCode 注解(详见这里)的作用, 也就是默认情况下使用类型所有的字段(不包括 static 和 transient 字段)参与到 equals 和 hashCode 方法的实现中</strong>. 因为这两个方法的实现不是我们自己实现的, 所以容易忽略其逻辑.</li> <li>二是, compareTo 方法需要返回数值, 作为排序的依据, 容易让人使用数值类型的字段随意实现.</li></ol> <p>再强调下, <mark><strong>对于自定义的类型, 如果要实现 Comparable, 请记得 equals, hashCode, compareTo 三者逻辑一致</strong></mark>.</p> <h5 id="小心lombok生成代码的-坑"><a href="#小心lombok生成代码的-坑" class="header-anchor">#</a> 小心Lombok生成代码的&quot;坑&quot;</h5> <p>Lombok 的 @Data 注解会帮助实现 equals 和 hashcode 方法, 但是有<strong>继承关系</strong>时, Lombok 自动生成的方法可能就不是我们期望的了.</p> <p>先来研究一下其实现: 定义一个 Person 类型, 包含姓名和身份证两个字段:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Data</span>
<span class="token keyword">class</span> <span class="token class-name">Person</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> identity<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">Person</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">,</span> <span class="token class-name">String</span> identity<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>identity <span class="token operator">=</span> identity<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>对于身份证相同, 姓名不同的两个 Person 对象:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">Person</span> person1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Person</span><span class="token punctuation">(</span><span class="token string">&quot;zhuye&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;001&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Person</span> person2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Person</span><span class="token punctuation">(</span><span class="token string">&quot;Joseph&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;001&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;person1.equals(person2) ? {}&quot;</span><span class="token punctuation">,</span> person1<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>person2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>使用 equals 判等会得到 false. 如果希望只要身份证一致就认为是同一个人的话, 可以使用  <strong>@EqualsAndHashCode.Exclude</strong> 注解来修饰 name 字段, 从 equals 和 hashCode 的实现中排除 name 字段:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@EqualsAndHashCode.Exclude</span>
<span class="token keyword">private</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>修改后得到 true. 打开编译后的代码可以看到, Lombok 为 Person 生成的 equals 方法的实现, 确实只包含了 identity 属性:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">equals</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">Object</span> o<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>o <span class="token operator">==</span> <span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>o <span class="token keyword">instanceof</span> <span class="token class-name">LombokEquealsController<span class="token punctuation">.</span>Person</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token class-name">LombokEquealsController<span class="token punctuation">.</span>Person</span> other <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">LombokEquealsController<span class="token punctuation">.</span>Person</span><span class="token punctuation">)</span>o<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>other<span class="token punctuation">.</span><span class="token function">canEqual</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token class-name">Object</span> <span class="token keyword">this</span>$identity <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getIdentity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Object</span> other$identity <span class="token operator">=</span> other<span class="token punctuation">.</span><span class="token function">getIdentity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span>$identity <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>other$identity <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span>$identity<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>other$identity<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><p>但到这里还没完, <strong>如果类型之间有继承, Lombok 会怎么处理子类的 equals 和 hashCode</strong> 呢? 来测试一下, 写一个 Employee 类继承 Person, 并新定义一个公司属性:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Data</span>
<span class="token keyword">class</span> <span class="token class-name">Employee</span> <span class="token keyword">extends</span> <span class="token class-name">Person</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> company<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">Employee</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">,</span> <span class="token class-name">String</span> identity<span class="token punctuation">,</span> <span class="token class-name">String</span> company<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> identity<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>company <span class="token operator">=</span> company<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>在如下的测试代码中, 声明两个 Employee 实例, 它们具有相同的公司名称, 但姓名和身份证均不同:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">Employee</span> employee1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Employee</span><span class="token punctuation">(</span><span class="token string">&quot;zhuye&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;001&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;bkjk.com&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Employee</span> employee2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Employee</span><span class="token punctuation">(</span><span class="token string">&quot;Joseph&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;002&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;bkjk.com&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;employee1.equals(employee2) ? {}&quot;</span><span class="token punctuation">,</span> employee1<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>employee2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>很遗憾, 结果是 true, 显然是<strong>没有考虑父类的属性</strong>, 而认为这两个员工是同一人, <strong>说明 @EqualsAndHashCode 默认实现没有使用父类属性.</strong></p> <p>为解决这个问题, 可以<mark><strong>手动设置 callSuper 开关为 true</strong></mark>, 来覆盖这种默认行为:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Data</span>
<span class="token annotation punctuation">@EqualsAndHashCode</span><span class="token punctuation">(</span>callSuper <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
<span class="token keyword">class</span> <span class="token class-name">Employee</span> <span class="token keyword">extends</span> <span class="token class-name">Person</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>修改后的代码, <strong>实现了同时以子类的属性 company 加上父类中的属性 identity, 作为 equals 和 hashCode 方法的实现条件(实现上其实是调用了父类的 equals 和 hashCode)</strong> .</p> <h5 id="重点回顾-8"><a href="#重点回顾-8" class="header-anchor">#</a> 重点回顾</h5> <p>现在来回顾下对象判等和比较的重点内容.</p> <p>首先, 要注意 equals 和 <code>&lt;mark&gt;</code>​ 的区别. 业务代码中进行内容的比较, 针对基本类型只能使用 <code>&lt;/mark&gt;</code>​, 针对 Integer, String 在内的引用类型, 需要使用 equals. Integer 和 String 的坑在于, 使用 <code>==</code>​ 判等有时也能获得正确结果.</p> <p>其次, 对于自定义类型, 如果类型需要参与判等, 那么务必<strong>同时实现 equals 和 hashCode 方法</strong>, 并确保逻辑一致. 如果希望快速实现 equals, hashCode 方法, 可以借助 IDE 的代码生成功能, 或使用 Lombok 来生成. 如果类型也要参与比较, <strong>那么 compareTo 方法的逻辑同样需要和 equals, hashCode 方法一致</strong>.</p> <p>最后, Lombok 的 @EqualsAndHashCode 注解实现 equals 和 hashCode 的时候, 默认使用类型所有非 static, 非 transient 的字段, 且不考虑父类. 如果希望改变这种默认行为, 可以使用 @EqualsAndHashCode.Exclude 排除一些字段, 并设置 callSuper = true 来让子类的 equals 和 hashCode 调用父类的相应方法.</p> <h4 id="_09-数值计算-注意精度-舍入和溢出问题"><a href="#_09-数值计算-注意精度-舍入和溢出问题" class="header-anchor">#</a> 09-数值计算:注意精度,舍入和溢出问题</h4> <p>今天要说说<strong>数值计算的精度, 舍入和溢出问题</strong>.</p> <p>之所以要单独分享数值计算, 是因为很多时候大家习惯的或者说认为理所当然的计算, 在计算器或计算机看来并不是那么回事儿. 就比如前段时间爆出的一条新闻, 说是手机计算器把 10% + 10% 算成了 0.11 而不是 0.2.</p> <p>出现这种问题的原因在于, 国外的计算程序使用的是单步计算法. 在单步计算法中, <code>a + b%</code>​ 代表的是 <code>a * (1 + b%)</code>​. 所以, 手机计算器计算 10% + 10% 时, 其实计算的是 <code>10% * (1 + 10%)</code>​, 所以得到的是 0.11 而不是 0.2.</p> <p>在我看来, 计算器或计算机会得到反直觉的计算结果的原因, 可以归结为:</p> <ol><li>在人看来, 浮点数只是具有小数点的数字, 0.1 和 1 都是一样精确的数字. 但<strong>计算机其实无法精确保存浮点数, 因此浮点数的计算结果也不可能精确</strong>.</li> <li>在人看来, 一个超大的数字只是位数多一点而已, 多写几个 1 并不会让大脑死机. 但<strong>计算机是把数值保存在了变量中, 不同类型的数值变量能保存的数值范围不同, 当数值超过类型能表达的数值上限则会发生溢出问题</strong>.</li></ol> <p>接下来就具体看看这些问题.</p> <h5 id="危险-的double"><a href="#危险-的double" class="header-anchor">#</a> &quot;危险&quot;的Double</h5> <p>先从简单的反直觉的四则运算看起. 对几个简单的浮点数进行加减乘除运算:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token number">0.1</span> <span class="token operator">+</span> <span class="token number">0.2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token number">1.0</span> <span class="token operator">-</span> <span class="token number">0.8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token number">4.015</span> <span class="token operator">*</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token number">123.3</span> <span class="token operator">/</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">double</span> amount1 <span class="token operator">=</span> <span class="token number">2.15</span><span class="token punctuation">;</span>
<span class="token keyword">double</span> amount2 <span class="token operator">=</span> <span class="token number">1.10</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>amount1 <span class="token operator">-</span> amount2 <span class="token operator">==</span> <span class="token number">1.05</span><span class="token punctuation">)</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;OK&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>输出结果如下:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token number">0.30000000000000004</span>
<span class="token number">0.19999999999999996</span>
<span class="token number">401.49999999999994</span>
<span class="token number">1.2329999999999999</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>可以看到, 0.1 + 0.2 输出的不是 0.3 而是 0.30000000000000004; 再比如, 对 2.15 - 1.10 和 1.05 判等, 结果判等不成立.</p> <p>出现这种问题的主要原因是, <strong>计算机是以二进制存储数值的, 浮点数也不例外</strong>. Java 采用了IEEE 754 标准实现浮点数的表达和运算.</p> <p>比如, 0.1 的二进制表示为 0.0 0011 0011 0011... (0011 无限循环), 再转换为十进制就是 0.1000000000000000055511151231257827021181583404541015625. <strong>对于计算机而言,</strong> <mark><strong>0.1 无法精确表达, 这是浮点数计算造成精度损失的根源</strong></mark>​ <strong>.</strong></p> <p>你可能会说, 以 0.1 为例, 其十进制和二进制间转换后相差非常小, 不会对计算产生什么影响. 但所谓积土成山, 如果大量使用 double 来作大量的金钱计算, 最终损失的精度就是大量的资金出入. 比如, 每天有一百万次交易, 每次交易都差一分钱, 一个月下来就差 30 万. 这就不是小事儿了. 那如何解决这个问题呢?</p> <p>大都听说过 <strong>BigDecimal 类型, 浮点数精确表达和运算的场景, 一定要使用这个类型</strong>. 不过, 在使用 BigDecimal 时有几个坑需要避开. 下面用 BigDecimal 把之前的四则运算改一下:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BigDecimal</span><span class="token punctuation">(</span><span class="token number">0.1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BigDecimal</span><span class="token punctuation">(</span><span class="token number">0.2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BigDecimal</span><span class="token punctuation">(</span><span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">subtract</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BigDecimal</span><span class="token punctuation">(</span><span class="token number">0.8</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BigDecimal</span><span class="token punctuation">(</span><span class="token number">4.015</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">multiply</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BigDecimal</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BigDecimal</span><span class="token punctuation">(</span><span class="token number">123.3</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">divide</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BigDecimal</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>输出如下:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token number">0.3000000000000000166533453693773481063544750213623046875</span>
<span class="token number">0.1999999999999999555910790149937383830547332763671875</span>
<span class="token number">401.49999999999996802557689079549163579940795898437500</span>
<span class="token number">1.232999999999999971578290569595992565155029296875</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>可以看到, 运算结果还是不精确, 只不过是<strong>精度高了</strong>而已. 这里给出浮点数运算避坑第一原则: <mark><strong>使用 BigDecimal 表示和计算浮点数, 且务必使用字符串的构造方法来初始化 BigDecimal</strong></mark>:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BigDecimal</span><span class="token punctuation">(</span><span class="token string">&quot;0.1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BigDecimal</span><span class="token punctuation">(</span><span class="token string">&quot;0.2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BigDecimal</span><span class="token punctuation">(</span><span class="token string">&quot;1.0&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">subtract</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BigDecimal</span><span class="token punctuation">(</span><span class="token string">&quot;0.8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BigDecimal</span><span class="token punctuation">(</span><span class="token string">&quot;4.015&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">multiply</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BigDecimal</span><span class="token punctuation">(</span><span class="token string">&quot;100&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BigDecimal</span><span class="token punctuation">(</span><span class="token string">&quot;123.3&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">divide</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BigDecimal</span><span class="token punctuation">(</span><span class="token string">&quot;100&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>改进后, 就能得到想要的输出了:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token number">0.3</span>
<span class="token number">0.2</span>
<span class="token number">401.500</span>
<span class="token number">1.233</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>到这里, 你可能会继续问, 不能调用 BigDecimal 传入 Double 的构造方法, 但手头只有一个 Double, 如何转换为精确表达的 BigDecimal 呢?</p> <p>试试用 Double.toString 把 double 转换为字符串, 看看行不行?</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BigDecimal</span><span class="token punctuation">(</span><span class="token string">&quot;4.015&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">multiply</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BigDecimal</span><span class="token punctuation">(</span><span class="token class-name">Double</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>输出为 401.5000. 与上面字符串初始化 100 和 4.015 相乘得到的结果 401.500 相比, 这里<strong>为什么多了 1 个 0 呢</strong>? 原因就是, <strong>BigDecimal 有 scale 和 precision 的概念, scale 表示小数点右边的位数, 而 precision 表示精度, 也就是有效数字的长度</strong>.</p> <p>调试一下可以发现, new BigDecimal(Double.toString(100)) 得到的 BigDecimal 的 scale = 1, precision = 4; 而 new BigDecimal(&quot;100&quot;) 得到的 BigDecimal 的 scale = 0, precision = 3. 对于 BigDecimal 乘法操作, 返回值的 scale 是两个数的 scale 相加. 所以, 初始化 100 的两种不同方式, 导致最后结果的 scale 分别是 4 和 3.</p> <p><strong>如果一定要用 Double 来初始化 BigDecimal 的话, 可以使用 BigDecimal.valueOf 方法</strong>, 以确保其表现和字符串形式的构造方法一致, 这也是官方文档更推荐的方式:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BigDecimal</span><span class="token punctuation">(</span><span class="token string">&quot;4.015&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">multiply</span><span class="token punctuation">(</span><span class="token class-name">BigDecimal</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>BigDecimal 的 toString 方法得到的字符串和 scale 相关, 又会引出了另一个问题: 对于浮点数的字符串形式输出和格式化, 应该考虑显式进行, 通过格式化表达式或格式化工具来明确小数位数和舍入方式. 接下来就聊聊<strong>浮点数舍入和格式化</strong>.</p> <h5 id="考虑浮点数舍入和格式化的方式"><a href="#考虑浮点数舍入和格式化的方式" class="header-anchor">#</a> 考虑浮点数舍入和格式化的方式</h5> <p>除了使用 Double 保存浮点数可能带来精度问题外, 更匪夷所思的是这种精度问题, 加上 String.format 的格式化舍入方式, 可能得到让人摸不着头脑的结果.</p> <p>看一个例子. 首先用 double 和 float 初始化两个 3.35 的浮点数, 然后通过 String.format 使用 <code>%.1f</code>​ 来格式化这 2 个数字:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">double</span> num1 <span class="token operator">=</span> <span class="token number">3.35</span><span class="token punctuation">;</span>
<span class="token keyword">float</span> num2 <span class="token operator">=</span> <span class="token number">3.35f</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;%.1f&quot;</span><span class="token punctuation">,</span> num1<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 四舍五入</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;%.1f&quot;</span><span class="token punctuation">,</span> num2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>得到的结果居然是 3.4 和 3.3.</p> <p>这是由<strong>精度问题和舍入方式</strong>共同导致的, double 和 float 的 3.35 其实相当于 <code>3.350xxx</code>​ 和 <code>3.349xxx</code>​:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token number">3.350000000000000088817841970012523233890533447265625</span>
<span class="token number">3.349999904632568359375</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p><strong>String.format</strong> 采用<strong>四舍五入</strong>的方式进行舍入, 取 1 位小数, double 的 3.350 四舍五入为 3.4, 而 float 的 3.349 四舍五入为 3.3.</p> <p><strong>看一下 Formatter 类的相关源码, 可以发现使用的舍入模式是 HALF_UP</strong>(代码第 11 行):</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>c <span class="token operator">==</span> <span class="token class-name">Conversion</span><span class="token punctuation">.</span><span class="token constant">DECIMAL_FLOAT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Create a new BigDecimal with the desired precision.</span>
    <span class="token keyword">int</span> prec <span class="token operator">=</span> <span class="token punctuation">(</span>precision <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">?</span> <span class="token number">6</span> <span class="token operator">:</span> precision<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> scale <span class="token operator">=</span> value<span class="token punctuation">.</span><span class="token function">scale</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>scale <span class="token operator">&gt;</span> prec<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// more &quot;scale&quot; digits than the requested &quot;precision&quot;</span>
        <span class="token keyword">int</span> compPrec <span class="token operator">=</span> value<span class="token punctuation">.</span><span class="token function">precision</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>compPrec <span class="token operator">&lt;=</span> scale<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// case of 0.xxxxxx</span>
            value <span class="token operator">=</span> value<span class="token punctuation">.</span><span class="token function">setScale</span><span class="token punctuation">(</span>prec<span class="token punctuation">,</span> <span class="token class-name">RoundingMode</span><span class="token punctuation">.</span><span class="token constant">HALF_UP</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            compPrec <span class="token operator">-=</span> <span class="token punctuation">(</span>scale <span class="token operator">-</span> prec<span class="token punctuation">)</span><span class="token punctuation">;</span>
            value <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BigDecimal</span><span class="token punctuation">(</span>value<span class="token punctuation">.</span><span class="token function">unscaledValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                   scale<span class="token punctuation">,</span>
                                   <span class="token keyword">new</span> <span class="token class-name">MathContext</span><span class="token punctuation">(</span>compPrec<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>如果希望使用其他舍入方式来格式化字符串的话, 可以设置 DecimalFormat, 如下代码所示:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">double</span> num1 <span class="token operator">=</span> <span class="token number">3.35</span><span class="token punctuation">;</span>
<span class="token keyword">float</span> num2 <span class="token operator">=</span> <span class="token number">3.35f</span><span class="token punctuation">;</span>
<span class="token class-name">DecimalFormat</span> format <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DecimalFormat</span><span class="token punctuation">(</span><span class="token string">&quot;#.##&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

format<span class="token punctuation">.</span><span class="token function">setRoundingMode</span><span class="token punctuation">(</span><span class="token class-name">RoundingMode</span><span class="token punctuation">.</span><span class="token constant">DOWN</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>format<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span>num1<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

format<span class="token punctuation">.</span><span class="token function">setRoundingMode</span><span class="token punctuation">(</span><span class="token class-name">RoundingMode</span><span class="token punctuation">.</span><span class="token constant">DOWN</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>format<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span>num2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>当把这 2 个浮点数向下舍入取 2 位小数时, 输出分别是 3.35 和 3.34, 还是之前说的浮点数无法精确存储的问题.</p> <p>因此, 即使通过 DecimalFormat 来精确控制舍入方式, double 和 float 的问题也可能产生意想不到的结果, 所以浮点数避坑第二原则: <mark><strong>浮点数的字符串格式化也要通过 BigDecimal 进行</strong></mark>​ <strong>.</strong></p> <p>比如下面这段代码, 使用 BigDecimal 来格式化数字 3.35, 分别使用向下舍入和四舍五入方式取 1 位小数进行格式化:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">BigDecimal</span> num1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BigDecimal</span><span class="token punctuation">(</span><span class="token string">&quot;3.35&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">BigDecimal</span> num2 <span class="token operator">=</span> num1<span class="token punctuation">.</span><span class="token function">setScale</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token class-name">BigDecimal</span><span class="token punctuation">.</span><span class="token constant">ROUND_DOWN</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>num2<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">BigDecimal</span> num3 <span class="token operator">=</span> num1<span class="token punctuation">.</span><span class="token function">setScale</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token class-name">BigDecimal</span><span class="token punctuation">.</span><span class="token constant">ROUND_HALF_UP</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>num3<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>这次得到的结果是 3.3 和 3.4, 符合预期.</p> <h5 id="用equals做判等-就一定是对的吗"><a href="#用equals做判等-就一定是对的吗" class="header-anchor">#</a> 用equals做判等,就一定是对的吗?</h5> <p>现在知道了, <strong>应该使用 BigDecimal 来进行浮点数的表示, 计算, 格式化</strong>. 在上一讲介绍判等问题时, 提到一个原则: 包装类的比较要通过 equals 进行, 而不能使用 <code>==</code>​. 那使用 equals 方法对两个 BigDecimal 判等, 一定能得到想要的结果吗?</p> <p>来看下面的例子. 使用 equals 方法比较 1.0 和 1 这两个 BigDecimal:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BigDecimal</span><span class="token punctuation">(</span><span class="token string">&quot;1.0&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BigDecimal</span><span class="token punctuation">(</span><span class="token string">&quot;1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>你可能已经猜到我要说什么了, 结果当然是 false. BigDecimal 的 equals 方法的注释中说明了原因, <strong>equals 比较的是 BigDecimal 的 value 和 scale</strong>, 1.0 的 scale 是 1, 1 的 scale 是 0, 所以结果一定是 false:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
* Compares this {@code BigDecimal} with the specified
* {@code Object} for equality.  Unlike {@link
* #compareTo(BigDecimal)# compareTo}, this method considers two
* {@code BigDecimal} objects equal only if they are equal in
* value and scale (thus 2.0 is not equal to 2.00 when compared by
* this method).
*
* @param  x {@code Object} to which this {@code BigDecimal} is
*         to be compared.
* @return {@code true} if and only if the specified {@code Object} is a
*         {@code BigDecimal} whose value and scale are equal to this
*         {@code BigDecimal}'s.
* @see    #compareTo(java.math.BigDecimal)#
* @see    #hashCode#
*/</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">equals</span><span class="token punctuation">(</span><span class="token class-name">Object</span> x<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p><strong>如果希望只比较 BigDecimal 的 value, 可以使用 compareTo 方法</strong>, 修改后代码如下:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BigDecimal</span><span class="token punctuation">(</span><span class="token string">&quot;1.0&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">compareTo</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BigDecimal</span><span class="token punctuation">(</span><span class="token string">&quot;1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>学过上一讲, 你可能会意识到 BigDecimal 的 equals 和 hashCode 方法会<strong>同时考虑 value 和 scale</strong>, 如果结合 HashSet 或 HashMap 使用的话就可能会出现麻烦. 比如把值为 1.0 的 BigDecimal 加入 HashSet, 然后判断其是否存在值为 1 的 BigDecimal, 得到的结果是 false:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BigDecimal</span><span class="token punctuation">&gt;</span></span> hashSet1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
hashSet1<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BigDecimal</span><span class="token punctuation">(</span><span class="token string">&quot;1.0&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>hashSet1<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BigDecimal</span><span class="token punctuation">(</span><span class="token string">&quot;1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 返回false</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>解决这个问题的办法有两个:</p> <ul><li>第一个方法是, 使用 <strong>TreeSet</strong> 替换 HashSet. TreeSet 不使用 hashCode 方法, 也不使用 equals 比较元素, 而是使用 compareTo 方法, 所以不会有问题.</li></ul> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BigDecimal</span><span class="token punctuation">&gt;</span></span> treeSet <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TreeSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
treeSet<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BigDecimal</span><span class="token punctuation">(</span><span class="token string">&quot;1.0&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>treeSet<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BigDecimal</span><span class="token punctuation">(</span><span class="token string">&quot;1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 返回true</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><ul><li>第二个方法是, 把 BigDecimal 存入 HashSet 或 HashMap 前, 先使用 stripTrailingZeros 方法去掉尾部的零, 比较的时候也去掉尾部的 0, 确保 value 相同的 BigDecimal, scale 也是一致的:</li></ul> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BigDecimal</span><span class="token punctuation">&gt;</span></span> hashSet2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
hashSet2<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BigDecimal</span><span class="token punctuation">(</span><span class="token string">&quot;1.0&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">stripTrailingZeros</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>hashSet2<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BigDecimal</span><span class="token punctuation">(</span><span class="token string">&quot;1.000&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">stripTrailingZeros</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//  返回true</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h5 id="小心数值溢出问题"><a href="#小心数值溢出问题" class="header-anchor">#</a> 小心数值溢出问题</h5> <p>数值计算还有一个要小心的点是<strong>溢出</strong>, 不管是 int 还是 long, <strong>所有的基本数值类型都有超出表达范围的可能性</strong>.</p> <p>比如对 Long 的最大值进行 +1 操作:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">long</span> l <span class="token operator">=</span> <span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token constant">MAX_VALUE</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>l <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>l <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">==</span> <span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token constant">MIN_VALUE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>输出结果是一个负数, 因为 <strong>Long 的最大值 +1 变为了 Long 的最小值</strong>:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token operator">-</span><span class="token number">9223372036854775808</span>
<span class="token boolean">true</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p><strong>显然这是发生了溢出, 而且是默默的溢出, 并没有任何异常</strong>. 这类问题非常容易被忽略, 改进方式有下面 2 种.</p> <p>方法一是, 考虑<strong>使用 Math 类的 addExact, subtractExact 等 xxExact 方法进行数值运算</strong>, 这些方法可以在数值溢出时主动抛出异常. 来测试一下, 使用 Math.addExact 对 Long 最大值做 +1 操作:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">long</span> l <span class="token operator">=</span> <span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token constant">MAX_VALUE</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">addExact</span><span class="token punctuation">(</span>l<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    ex<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>执行后, 可以得到 ArithmeticException, 这是一个 RuntimeException:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>ArithmeticException</span><span class="token operator">:</span> <span class="token keyword">long</span> overflow
at <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>Math</span><span class="token punctuation">.</span><span class="token function">addExact</span><span class="token punctuation">(</span><span class="token class-name">Math</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">809</span><span class="token punctuation">)</span>
at <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>geekbang<span class="token punctuation">.</span>time<span class="token punctuation">.</span>commonmistakes<span class="token punctuation">.</span>numeralcalculations<span class="token punctuation">.</span>demo3<span class="token punctuation">.</span></span>CommonMistakesApplication</span><span class="token punctuation">.</span><span class="token function">right2</span><span class="token punctuation">(</span><span class="token class-name">CommonMistakesApplication</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">25</span><span class="token punctuation">)</span>
at <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>geekbang<span class="token punctuation">.</span>time<span class="token punctuation">.</span>commonmistakes<span class="token punctuation">.</span>numeralcalculations<span class="token punctuation">.</span>demo3<span class="token punctuation">.</span></span>CommonMistakesApplication</span><span class="token punctuation">.</span><span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">CommonMistakesApplication</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">13</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>方法二是, <strong>使用大数类 BigInteger. BigDecimal 是处理浮点数的专家, 而 BigInteger 则是对大数进行科学计算的专家</strong>.</p> <p>如下代码, 使用 BigInteger 对 Long 最大值进行 +1 操作; 如果希望把计算结果转换一个 Long 变量的话, 可以使用 BigInteger 的 longValueExact 方法, 在转换出现溢出时, 同样会抛出 ArithmeticException:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">BigInteger</span> i <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BigInteger</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span><span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token constant">MAX_VALUE</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>i<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">BigInteger</span><span class="token punctuation">.</span><span class="token constant">ONE</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">long</span> l <span class="token operator">=</span> i<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">BigInteger</span><span class="token punctuation">.</span><span class="token constant">ONE</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">longValueExact</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    ex<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>输出结果如下:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token number">9223372036854775808</span>
<span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>ArithmeticException</span><span class="token operator">:</span> <span class="token class-name">BigInteger</span> out of <span class="token keyword">long</span> range
at <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>math<span class="token punctuation">.</span></span>BigInteger</span><span class="token punctuation">.</span><span class="token function">longValueExact</span><span class="token punctuation">(</span><span class="token class-name">BigInteger</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">4632</span><span class="token punctuation">)</span>
at <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>geekbang<span class="token punctuation">.</span>time<span class="token punctuation">.</span>commonmistakes<span class="token punctuation">.</span>numeralcalculations<span class="token punctuation">.</span>demo3<span class="token punctuation">.</span></span>CommonMistakesApplication</span><span class="token punctuation">.</span><span class="token function">right1</span><span class="token punctuation">(</span><span class="token class-name">CommonMistakesApplication</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">37</span><span class="token punctuation">)</span>
at <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>geekbang<span class="token punctuation">.</span>time<span class="token punctuation">.</span>commonmistakes<span class="token punctuation">.</span>numeralcalculations<span class="token punctuation">.</span>demo3<span class="token punctuation">.</span></span>CommonMistakesApplication</span><span class="token punctuation">.</span><span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">CommonMistakesApplication</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">11</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>可以看到, 通过 BigInteger 对 Long 的最大值加 1 一点问题都没有, 当尝试把结果转换为 Long 类型时, 则会提示 BigInteger out of long range.</p> <h5 id="重点回顾-9"><a href="#重点回顾-9" class="header-anchor">#</a> 重点回顾</h5> <p>今天分享了浮点数的表示, 计算, 舍入和格式化, 溢出等涉及的一些坑.</p> <p>第一, 切记, <strong>要精确表示浮点数应该使用 BigDecimal</strong>. 并且使用 BigDecimal 的 Double 入参的构造方法同样存在精度丢失问题, 应该使用 String 入参的构造方法或者 BigDecimal.valueOf 方法来初始化.</p> <p>第二, 对浮点数做精确计算, 参与计算的各种数值应该始终使用 BigDecimal, 所有的计算都要通过 BigDecimal 的方法进行, 切勿只是让 BigDecimal 来走过场. 任何一个环节出现精度损失, 最后的计算结果可能都会出现误差.</p> <p>第三, 对于浮点数的格式化, 如果使用 String.format 的话, 需要认识到它使用的是四舍五入, 可以考虑使用 DecimalFormat 来明确指定舍入方式. 但考虑到精度问题, 更建议使用 BigDecimal 来表示浮点数, 并使用其 setScale 方法指定舍入的位数和方式.</p> <p>第四, <strong>进行数值运算时要小心溢出问题</strong>, 虽然溢出后不会出现异常, 但得到的计算结果是完全错误的. 可以考虑使用 Math.xxxExact 方法来进行运算, 在溢出时能抛出异常, 更建议对于可能会出现溢出的大数运算使用 BigInteger 类.</p> <p>总之, <strong>对于金融, 科学计算等场景, 请尽可能使用 BigDecimal 和 BigInteger, 避免出现精度和溢出问题</strong>.</p> <h4 id="_10-集合类-坑满地的list列表操作"><a href="#_10-集合类-坑满地的list列表操作" class="header-anchor">#</a> 10-集合类:坑满地的List列表操作</h4> <p>今天来说说 List 列表操作有哪些坑.</p> <p>现代编程语言一般都会提供各种数据结构的实现, 供我们开箱即用. Java 也是一样, 比如提供了集合类的各种实现. Java 的集合类包括 Map 和 Collection 两大类. Collection 包括 List, Set 和 Queue 三个小类, 其中 List 列表集合是最重要也是所有业务代码都会用到的. 所以今天会重点介绍 <strong>List 的内容</strong>, 而不会集中介绍 Map 以及 Collection 中其他小类的坑.</p> <p>今天就从把数组转换为 List 集合, 对 List 进行切片操作, List 搜索的性能问题等几个方面着手, 来聊聊其中最可能遇到的一些坑.</p> <h5 id="使用arrays-aslist把数据转换为list的三个坑"><a href="#使用arrays-aslist把数据转换为list的三个坑" class="header-anchor">#</a> 使用Arrays.asList把数据转换为List的三个坑</h5> <p>Java 8 中 Stream 流式处理的各种功能, 大大减少了集合类各种操作(投影, 过滤, 转换)的代码量. 所以, 在业务开发中, 常常会把原始的数组转换为 Lis 类数据结构, 来继续展开各种 Stream 操作.</p> <p>你可能也想到了使用 Arrays.asList 方法可以把数组一键转换为 List, 但其实没这么简单. 接下来, 就看看其中的缘由, 以及<strong>使用 Arrays.asList 把数组转换为 List 的几个坑</strong>.</p> <p>在如下代码中, 初始化三个数字的 <code>int[]</code>​ 数组, 然后使用 Arrays.asList 把数组转换为 List:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> arr <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token class-name">List</span> list <span class="token operator">=</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span>arr<span class="token punctuation">)</span><span class="token punctuation">;</span>
log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;list:{} size:{} class:{}&quot;</span><span class="token punctuation">,</span> list<span class="token punctuation">,</span> list<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> list<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>但这样初始化的 List 并不是期望的包含 3 个数字的 List. 通过日志可以发现, <strong>这个 List 包含的其实是一个 int 数组, 整个 List 的元素个数是 1, 元素类型是整数数组</strong>.</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token number">12</span><span class="token operator">:</span><span class="token number">50</span><span class="token operator">:</span><span class="token number">39.445</span> <span class="token punctuation">[</span>main<span class="token punctuation">]</span> <span class="token constant">INFO</span> <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>geekbang<span class="token punctuation">.</span>time<span class="token punctuation">.</span>commonmistakes<span class="token punctuation">.</span>collection<span class="token punctuation">.</span>aslist<span class="token punctuation">.</span></span>AsListApplication</span> <span class="token operator">-</span> list<span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token class-name">I</span><span class="token annotation punctuation">@1c53fd30</span><span class="token punctuation">]</span> size<span class="token operator">:</span><span class="token number">1</span> <span class="token keyword">class</span><span class="token operator">:</span><span class="token keyword">class</span> <span class="token punctuation">[</span><span class="token class-name">I</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>其原因是, 只能是把 int 装箱为 Integer, 不可能把 int 数组装箱为 Integer 数组. Arrays.asList 方法传入的是一个泛型 T 类型可变参数, <strong>最终 int 数组整体作为了一个对象成为了泛型类型 T</strong>:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">asList</span><span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> a<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>直接遍历这样的 List 必然会出现 Bug, 修复方式有两种, 如果使用 Java8 以上版本可以使用 <strong>Arrays.stream</strong> 方法来转换, 否则可以把 int 数组声明为包装类型 Integer 数组:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> arr1 <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token class-name">List</span> list1 <span class="token operator">=</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span>arr1<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">boxed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;list:{} size:{} class:{}&quot;</span><span class="token punctuation">,</span> list1<span class="token punctuation">,</span> list1<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> list1<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">Integer</span><span class="token punctuation">[</span><span class="token punctuation">]</span> arr2 <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token class-name">List</span> list2 <span class="token operator">=</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span>arr2<span class="token punctuation">)</span><span class="token punctuation">;</span>
log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;list:{} size:{} class:{}&quot;</span><span class="token punctuation">,</span> list2<span class="token punctuation">,</span> list2<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> list2<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>修复后的代码得到如下日志, 可以看到 List 具有三个元素, 元素类型是 Integer:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token number">13</span><span class="token operator">:</span><span class="token number">10</span><span class="token operator">:</span><span class="token number">57.373</span> <span class="token punctuation">[</span>main<span class="token punctuation">]</span> <span class="token constant">INFO</span> <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>geekbang<span class="token punctuation">.</span>time<span class="token punctuation">.</span>commonmistakes<span class="token punctuation">.</span>collection<span class="token punctuation">.</span>aslist<span class="token punctuation">.</span></span>AsListApplication</span> <span class="token operator">-</span> list<span class="token operator">:</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span> size<span class="token operator">:</span><span class="token number">3</span> <span class="token keyword">class</span><span class="token operator">:</span><span class="token keyword">class</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>Integer</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>可以看到第一个坑是, <strong>不能直接使用 Arrays.asList 来转换基本类型数组</strong>. 那么获得了正确的 List, 是不是就可以像普通的 List 那样使用了呢? 继续往下看.</p> <p>把三个字符串 1, 2, 3 构成的字符串数组, 使用 Arrays.asList 转换为 List 后, 将原始字符串数组的第二个字符修改为 4, 然后为 List 增加一个字符串 5, 最后数组和 List 会是怎样呢?</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> arr <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;1&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;2&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;3&quot;</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token class-name">List</span> list <span class="token operator">=</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span>arr<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 修改元素</span>
arr<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">&quot;4&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token comment">// 新增元素</span>
    list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">&quot;5&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    ex<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;arr:{} list:{}&quot;</span><span class="token punctuation">,</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span>arr<span class="token punctuation">)</span><span class="token punctuation">,</span> list<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>可以看到, 日志里有一个 <strong>UnsupportedOperationException</strong>, 为 List 新增字符串 5 的操作失败了, 而且把原始数组的第二个元素从 2 修改为 4 后, <strong>asList 获得的 List 中的第二个元素也被修改为 4 了</strong>:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>UnsupportedOperationException</span>
  at <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span>AbstractList</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">AbstractList</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">148</span><span class="token punctuation">)</span>
  at <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span>AbstractList</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">AbstractList</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">108</span><span class="token punctuation">)</span>
  at <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>geekbang<span class="token punctuation">.</span>time<span class="token punctuation">.</span>commonmistakes<span class="token punctuation">.</span>collection<span class="token punctuation">.</span>aslist<span class="token punctuation">.</span></span>AsListApplication</span><span class="token punctuation">.</span><span class="token function">wrong2</span><span class="token punctuation">(</span><span class="token class-name">AsListApplication</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">41</span><span class="token punctuation">)</span>
  at <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>geekbang<span class="token punctuation">.</span>time<span class="token punctuation">.</span>commonmistakes<span class="token punctuation">.</span>collection<span class="token punctuation">.</span>aslist<span class="token punctuation">.</span></span>AsListApplication</span><span class="token punctuation">.</span><span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">AsListApplication</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">15</span><span class="token punctuation">)</span>
<span class="token number">13</span><span class="token operator">:</span><span class="token number">15</span><span class="token operator">:</span><span class="token number">34.699</span> <span class="token punctuation">[</span>main<span class="token punctuation">]</span> <span class="token constant">INFO</span> <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>geekbang<span class="token punctuation">.</span>time<span class="token punctuation">.</span>commonmistakes<span class="token punctuation">.</span>collection<span class="token punctuation">.</span>aslist<span class="token punctuation">.</span></span>AsListApplica</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>这里, 又引出了两个坑.</p> <p>第二个坑, <mark><strong>Arrays.asList 返回的 List 不支持增删操作</strong></mark>​ <strong>.</strong>  Arrays.asList 返回的 List 并不是期望的 java.util.ArrayList, 而是 <strong>Arrays 的内部类 ArrayList</strong>. ArrayList 内部类继承自 AbstractList 类, 并没有覆写父类的 add 方法, 而父类中 add 方法的实现, 就是抛出 UnsupportedOperationException. 相关源码如下所示:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">asList</span><span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> a<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">extends</span> <span class="token class-name">AbstractList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span>
    <span class="token keyword">implements</span> <span class="token class-name">RandomAccess</span><span class="token punctuation">,</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span>Serializable</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">E</span><span class="token punctuation">[</span><span class="token punctuation">]</span> a<span class="token punctuation">;</span>
    <span class="token class-name">ArrayList</span><span class="token punctuation">(</span><span class="token class-name">E</span><span class="token punctuation">[</span><span class="token punctuation">]</span> array<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        a <span class="token operator">=</span> <span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">requireNonNull</span><span class="token punctuation">(</span>array<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// ...</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">E</span> <span class="token function">set</span><span class="token punctuation">(</span><span class="token keyword">int</span> index<span class="token punctuation">,</span> <span class="token class-name">E</span> element<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">E</span> oldValue <span class="token operator">=</span> a<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">;</span>
        a<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">=</span> element<span class="token punctuation">;</span>
        <span class="token keyword">return</span> oldValue<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// ...</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">AbstractList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">extends</span> <span class="token class-name">AbstractCollection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">implements</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
    <span class="token comment">// 直接抛异常</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">int</span> index<span class="token punctuation">,</span> <span class="token class-name">E</span> element<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">UnsupportedOperationException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br></div></div><p>第三个坑, <strong>对原始数组的修改会影响到获得的那个 List</strong>. 看一下 ArrayList 的实现, 可以发现 ArrayList 其实是直接使用了原始的数组. 所以要特别小心, 把通过 Arrays.asList 获得的 List 交给其他方法处理, 很容易因为<strong>共享了数组</strong>, 相互修改产生 Bug.</p> <p>修复方式比较简单, <strong>重新 new 一个 ArrayList 初始化 Arrays.asList 返回的 List 即可</strong>:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> arr <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;1&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;2&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;3&quot;</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token class-name">List</span> list <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token punctuation">(</span><span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span>arr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

arr<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">&quot;4&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">try</span> <span class="token punctuation">{</span>
    list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">&quot;5&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    ex<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;arr:{} list:{}&quot;</span><span class="token punctuation">,</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span>arr<span class="token punctuation">)</span><span class="token punctuation">,</span> list<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>修改后的代码实现了原始数组和 List 的 &quot;解耦&quot;, 不再相互影响. 同时因为操作的是真正的 ArrayList, add 也不再出错:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token number">13</span><span class="token operator">:</span><span class="token number">34</span><span class="token operator">:</span><span class="token number">50.829</span> <span class="token punctuation">[</span>main<span class="token punctuation">]</span> <span class="token constant">INFO</span> <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>geekbang<span class="token punctuation">.</span>time<span class="token punctuation">.</span>commonmistakes<span class="token punctuation">.</span>collection<span class="token punctuation">.</span>aslist<span class="token punctuation">.</span></span>AsListApplication</span> <span class="token operator">-</span> arr<span class="token operator">:</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span> list<span class="token operator">:</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>使用 List.subList 进行切片操作居然会导致 OOM? 业务开发时常常要<strong>对 List 做切片处理</strong>, 即取出其中部分元素构成一个新的 List, 通常会想到使用 List.subList 方法. 但和 Arrays.asList 的问题类似, <strong>List.subList 返回的子 List 不是一个普通的 ArrayList</strong>. 这个子 List 可以认为是原始 List 的视图, 会和原始 List 相互影响. 如果不注意, 很可能会因此产生 OOM 问题. 接下来就一起分析下其中的坑.</p> <p>如下代码所示, 定义一个名为 data 的静态 List 来存放 Integer 的 List, 也就是说 data 的成员本身是包含了多个数字的 List. 循环 1000 次, 每次都从一个具有 10 万个 Integer 的 List 中, 使用 subList 方法获得一个只包含一个数字的子 List, 并把这个子 List 加入 data 变量:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> data <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">oom</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">1000</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> rawList <span class="token operator">=</span> <span class="token class-name">IntStream</span><span class="token punctuation">.</span><span class="token function">rangeClosed</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">100000</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">boxed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        data<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>rawList<span class="token punctuation">.</span><span class="token function">subList</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>你可能会觉得, 这个 data 变量里面最终保存的只是 1000 个具有 1 个元素的 List, 不会占用很大空间, 但程序运行不久就出现了 OOM:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">Exception</span> in thread <span class="token string">&quot;main&quot;</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>OutOfMemoryError</span><span class="token operator">:</span> <span class="token class-name">Java</span> heap space
at <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span>Arrays</span><span class="token punctuation">.</span><span class="token function">copyOf</span><span class="token punctuation">(</span><span class="token class-name">Arrays</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">3181</span><span class="token punctuation">)</span>
at <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span>ArrayList</span><span class="token punctuation">.</span><span class="token function">grow</span><span class="token punctuation">(</span><span class="token class-name">ArrayList</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">265</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p><strong>出现 OOM 的原因是, 循环中的 1000 个具有 10 万个元素的 List 始终得不到回收, 因为它始终被 subList 方法返回的 List 强引用.</strong>  那么返回的<strong>子 List 为什么会强引用原始的 List</strong>, 它们又有什么关系呢? 再继续做实验观察一下这个子 List 的特性.</p> <p>首先初始化一个包含数字 1 到 10 的 ArrayList, 然后通过调用 subList 方法取出 2, 3, 4; 随后删除这个 SubList 中的元素数字 3, 并打印原始的 ArrayList; 最后为原始的 ArrayList 增加一个元素数字 0, 遍历 SubList 输出所有元素:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> <span class="token class-name">IntStream</span><span class="token punctuation">.</span><span class="token function">rangeClosed</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">boxed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> subList <span class="token operator">=</span> list<span class="token punctuation">.</span><span class="token function">subList</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>subList<span class="token punctuation">)</span><span class="token punctuation">;</span>

subList<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>list<span class="token punctuation">)</span><span class="token punctuation">;</span>

list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">try</span> <span class="token punctuation">{</span>
    subList<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token operator">::</span><span class="token function">println</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    ex<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>代码运行后得到如下输出:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span>
<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">]</span>
<span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span>ConcurrentModificationException</span>
  at <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span>ArrayList</span>$<span class="token class-name">SubList</span><span class="token punctuation">.</span><span class="token function">checkForComodification</span><span class="token punctuation">(</span><span class="token class-name">ArrayList</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">1239</span><span class="token punctuation">)</span>
  at <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span>ArrayList</span>$<span class="token class-name">SubList</span><span class="token punctuation">.</span><span class="token function">listIterator</span><span class="token punctuation">(</span><span class="token class-name">ArrayList</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">1099</span><span class="token punctuation">)</span>
  at <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span>AbstractList</span><span class="token punctuation">.</span><span class="token function">listIterator</span><span class="token punctuation">(</span><span class="token class-name">AbstractList</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">299</span><span class="token punctuation">)</span>
  at <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span>ArrayList</span>$<span class="token class-name">SubList</span><span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token class-name">ArrayList</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">1095</span><span class="token punctuation">)</span>
  at <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>Iterable</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token class-name">Iterable</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">74</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>可以看到两个现象:</p> <ol><li>原始 List 中数字 3 被删除了, <strong>说明删除子 List 中的元素影响到了原始 List</strong>;</li> <li><strong>尝试为原始 List 增加数字 0 之后再遍历子 List, 会出现 ConcurrentModificationException</strong>.</li></ol> <p>分析下 ArrayList 的源码, 看看为什么会是这样.</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">extends</span> <span class="token class-name">AbstractList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span>
        <span class="token keyword">implements</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">,</span> <span class="token class-name">RandomAccess</span><span class="token punctuation">,</span> <span class="token class-name">Cloneable</span><span class="token punctuation">,</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span>Serializable</span> <span class="token punctuation">{</span>

    <span class="token keyword">protected</span> <span class="token keyword">transient</span> <span class="token keyword">int</span> modCount <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">ensureExplicitCapacity</span><span class="token punctuation">(</span><span class="token keyword">int</span> minCapacity<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        modCount<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token comment">// overflow-conscious code</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>minCapacity <span class="token operator">-</span> elementData<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token function">grow</span><span class="token punctuation">(</span>minCapacity<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">int</span> index<span class="token punctuation">,</span> <span class="token class-name">E</span> element<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">rangeCheckForAdd</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">ensureCapacityInternal</span><span class="token punctuation">(</span>size <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// Increments modCount!!</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">arraycopy</span><span class="token punctuation">(</span>elementData<span class="token punctuation">,</span> index<span class="token punctuation">,</span> elementData<span class="token punctuation">,</span> index <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span>
                size <span class="token operator">-</span> index<span class="token punctuation">)</span><span class="token punctuation">;</span>
        elementData<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">=</span> element<span class="token punctuation">;</span>
        size<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span> <span class="token function">subList</span><span class="token punctuation">(</span><span class="token keyword">int</span> fromIndex<span class="token punctuation">,</span> <span class="token keyword">int</span> toIndex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">subListRangeCheck</span><span class="token punctuation">(</span>fromIndex<span class="token punctuation">,</span> toIndex<span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">SubList</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> offset<span class="token punctuation">,</span> fromIndex<span class="token punctuation">,</span> toIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">class</span> <span class="token class-name">SubList</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">implements</span> <span class="token class-name">RandomAccess</span> <span class="token punctuation">{</span>
        <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">AbstractList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span> parent<span class="token punctuation">;</span>
        <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">int</span> parentOffset<span class="token punctuation">;</span>
        <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">int</span> offset<span class="token punctuation">;</span>
        <span class="token keyword">int</span> size<span class="token punctuation">;</span>
        <span class="token class-name">SubList</span><span class="token punctuation">(</span><span class="token class-name">AbstractList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span> parent<span class="token punctuation">,</span>
                <span class="token keyword">int</span> offset<span class="token punctuation">,</span> <span class="token keyword">int</span> fromIndex<span class="token punctuation">,</span> <span class="token keyword">int</span> toIndex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>parent <span class="token operator">=</span> parent<span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>parentOffset <span class="token operator">=</span> fromIndex<span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>offset <span class="token operator">=</span> offset <span class="token operator">+</span> fromIndex<span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>size <span class="token operator">=</span> toIndex <span class="token operator">-</span> fromIndex<span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>modCount <span class="token operator">=</span> <span class="token class-name">ArrayList</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>modCount<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">public</span> <span class="token class-name">E</span> <span class="token function">set</span><span class="token punctuation">(</span><span class="token keyword">int</span> index<span class="token punctuation">,</span> <span class="token class-name">E</span> element<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">rangeCheck</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">checkForComodification</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> l<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>index<span class="token operator">+</span>offset<span class="token punctuation">,</span> element<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">public</span> <span class="token class-name">ListIterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span> <span class="token function">listIterator</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token keyword">int</span> index<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">checkForComodification</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">checkForComodification</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">ArrayList</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>modCount <span class="token operator">!=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>modCount<span class="token punctuation">)</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentModificationException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token comment">// ...</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br></div></div><p>第一, ArrayList <strong>维护了一个叫作 modCount 的字段, 表示集合结构性修改的次数</strong>. 所谓结构性修改, 指的是影响 List 大小的修改, 所以 add 操作必然会改变 modCount 的值.</p> <p>第二, 分析 subList 方法可以看到, 获得的 List 其实是<strong>内部类 SubList</strong>, 并不是普通的 ArrayList, 在初始化的时候传入了 <strong>this</strong>.</p> <p>第三, 这个 SubList 中的 <strong>parent 字段就是原始的 List</strong>. SubList 初始化的时候, 并没有把原始 List 中的元素复制到独立的变量中保存. 可以认为 SubList 是原始 List 的视图, 并不是独立的 List. <strong>双方对元素的修改会相互影响, 而且 SubList 强引用了原始的 List, 所以大量保存这样的 SubList 会导致 OOM</strong>.</p> <p>第四, 遍历 SubList 的时候会先获得迭代器, 比较原始 ArrayList modCount 的值和 SubList 当前 modCount 的值. 获得了 SubList 后, 为原始 List 新增了一个元素修改了其 modCount, 所以判等失败抛出 ConcurrentModificationException 异常.</p> <p>既然 SubList 相当于原始 List 的视图, 那么<strong>避免相互影响的修复方式</strong>有两种:</p> <ol><li>一种是, 不直接使用 subList 方法返回的 SubList, 而是重新使用 new ArrayList, 在构造方法传入 SubList, 来<strong>构建一个独立的 ArrayList</strong>;</li> <li>另一种是, 对于 Java 8 使用 Stream 的 skip 和 limit API 来跳过流中的元素, 以及限制流中元素的个数, 同样可以达到 SubList 切片的目的.</li></ol> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// 方式一: </span>
<span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> subList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>list<span class="token punctuation">.</span><span class="token function">subList</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 方式二: </span>
<span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> subList <span class="token operator">=</span> list<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">skip</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">limit</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>修复后代码输出如下:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span>
<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">]</span>
<span class="token number">2</span>
<span class="token number">4</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>可以看到, 删除 SubList 的元素不再影响原始 List, 而对原始 List 的修改也不会再出现 List 迭代异常.</p> <h5 id="一定要让合适的数据结构做合适的事情"><a href="#一定要让合适的数据结构做合适的事情" class="header-anchor">#</a> 一定要让合适的数据结构做合适的事情</h5> <p>在介绍并发工具时, 提到要根据业务场景选择合适的并发工具或容器. 在使用 List 集合类的时候, 不注意使用场景也会遇见两个常见误区.</p> <p><strong>第一个误区是, 使用数据结构不考虑平衡时间和空间</strong>.</p> <p>首先, 定义一个只有一个 int 类型订单号字段的 Order 类:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Data</span>
<span class="token annotation punctuation">@NoArgsConstructor</span>
<span class="token annotation punctuation">@AllArgsConstructor</span>
<span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Order</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> orderId<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>然后, 定义一个包含 elementCount 和 loopCount 两个参数的 listSearch 方法, 初始化一个具有 elementCount 个订单对象的 ArrayList, 循环 loopCount 次搜索这个 ArrayList, 每次随机搜索一个订单号:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">Object</span> <span class="token function">listSearch</span><span class="token punctuation">(</span><span class="token keyword">int</span> elementCount<span class="token punctuation">,</span> <span class="token keyword">int</span> loopCount<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Order</span><span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> <span class="token class-name">IntStream</span><span class="token punctuation">.</span><span class="token function">rangeClosed</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> elementCount<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">mapToObj</span><span class="token punctuation">(</span>i <span class="token operator">-&gt;</span> <span class="token keyword">new</span> <span class="token class-name">Order</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">IntStream</span><span class="token punctuation">.</span><span class="token function">rangeClosed</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> loopCount<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>i <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> search <span class="token operator">=</span> <span class="token class-name">ThreadLocalRandom</span><span class="token punctuation">.</span><span class="token function">current</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span>elementCount<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Order</span> result <span class="token operator">=</span> list<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>order <span class="token operator">-&gt;</span> order<span class="token punctuation">.</span><span class="token function">getOrderId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> search<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">findFirst</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">orElse</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">assertTrue</span><span class="token punctuation">(</span>result <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> result<span class="token punctuation">.</span><span class="token function">getOrderId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> search<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> list<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>随后, 定义另一个 mapSearch 方法, 从一个具有 elementCount 个元素的 Map 中循环 loopCount 次查找随机订单号. Map 的 Key 是订单号, Value 是订单对象:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">Object</span> <span class="token function">mapSearch</span><span class="token punctuation">(</span><span class="token keyword">int</span> elementCount<span class="token punctuation">,</span> <span class="token keyword">int</span> loopCount<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">,</span> <span class="token class-name">Order</span><span class="token punctuation">&gt;</span></span> map <span class="token operator">=</span> <span class="token class-name">IntStream</span><span class="token punctuation">.</span><span class="token function">rangeClosed</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> elementCount<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">boxed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toMap</span><span class="token punctuation">(</span><span class="token class-name">Function</span><span class="token punctuation">.</span><span class="token function">identity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> i <span class="token operator">-&gt;</span> <span class="token keyword">new</span> <span class="token class-name">Order</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">IntStream</span><span class="token punctuation">.</span><span class="token function">rangeClosed</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> loopCount<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>i <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> search <span class="token operator">=</span> <span class="token class-name">ThreadLocalRandom</span><span class="token punctuation">.</span><span class="token function">current</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span>elementCount<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Order</span> result <span class="token operator">=</span> map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>search<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">assertTrue</span><span class="token punctuation">(</span>result <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> result<span class="token punctuation">.</span><span class="token function">getOrderId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> search<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> map<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>搜索 ArrayList 的时间复杂度是 O(n), 而 HashMap 的 get 操作的时间复杂度是 O(1). <strong>所以, 要对大 List 进行单值搜索的话, 可以考虑使用 HashMap, 其中 Key 是要搜索的值, Value 是原始对象, 会比使用 ArrayList 有非常明显的性能优势.</strong></p> <p>如下代码所示, 对 100 万个元素的 ArrayList 和 HashMap, 分别调用 listSearch 和 mapSearch 方法进行 1000 次搜索:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">int</span> elementCount <span class="token operator">=</span> <span class="token number">1000000</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> loopCount <span class="token operator">=</span> <span class="token number">1000</span><span class="token punctuation">;</span>

<span class="token class-name">StopWatch</span> stopWatch <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StopWatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
stopWatch<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token string">&quot;listSearch&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">Object</span> list <span class="token operator">=</span> <span class="token function">listSearch</span><span class="token punctuation">(</span>elementCount<span class="token punctuation">,</span> loopCount<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">ObjectSizeCalculator</span><span class="token punctuation">.</span><span class="token function">getObjectSize</span><span class="token punctuation">(</span>list<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
stopWatch<span class="token punctuation">.</span><span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
stopWatch<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token string">&quot;mapSearch&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">Object</span> map <span class="token operator">=</span> <span class="token function">mapSearch</span><span class="token punctuation">(</span>elementCount<span class="token punctuation">,</span> loopCount<span class="token punctuation">)</span><span class="token punctuation">;</span>
stopWatch<span class="token punctuation">.</span><span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">ObjectSizeCalculator</span><span class="token punctuation">.</span><span class="token function">getObjectSize</span><span class="token punctuation">(</span>map<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>stopWatch<span class="token punctuation">.</span><span class="token function">prettyPrint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>可以看到, 仅仅是 1000 次搜索, listSearch 方法耗时 3.3 秒, 而 mapSearch 耗时仅仅 108 毫秒.</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token number">20861992</span>
<span class="token number">72388672</span>
<span class="token class-name">StopWatch</span> ''<span class="token operator">:</span> running time <span class="token operator">=</span> <span class="token number">3506699764</span> ns
<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span>
ns         <span class="token operator">%</span>     <span class="token class-name">Task</span> name
<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span>
<span class="token number">3398413176</span>  <span class="token number">097</span><span class="token operator">%</span>  listSearch
<span class="token number">108286588</span>  <span class="token number">003</span><span class="token operator">%</span>  mapSearch
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>即使要搜索的不是单值而是条件区间, 也可以尝试使用 HashMap 来进行 &quot;搜索性能优化&quot;. 如果条件区间是固定的话, 可以提前把 HashMap 按照条件区间进行分组, Key 就是不同的区间.</p> <p>的确, 如果业务代码中有频繁的大 ArrayList 搜索, 使用 HashMap 性能会好很多. 类似, 如果要对大 ArrayList 进行去重操作, 也不建议使用 contains 方法, 而是可以<strong>考虑使用 HashSet 进行去重</strong>. 说到这里, 还有一个问题, 使用 HashMap 是否会牺牲空间呢?</p> <p>为此, 使用 ObjectSizeCalculator 工具打印 ArrayList 和 HashMap 的<strong>内存占用</strong>, 可以看到 ArrayList 占用内存 21M, 而 HashMap 占用的内存达到了 72M, 是 List 的三倍多. 进一步使用 MAT 工具分析堆可以再次证明, ArrayList 在内存占用上性价比很高, 77% 是实际的数据(如第 1 个图所示, 16000000/20861992), <strong>而 HashMap 的 &quot;含金量&quot; 只有 22%</strong> (如第 2 个图所示, 16000000/72386640).</p> <p><img src="/img/006bf7ea9d1f574df64a19013ac6d5bd-20230731165210-ifs0ecb.png" alt=""></p> <p><img src="/img/366d1d6a3903ce3421a1cbd175971c8e-20230731165210-k682uiu.png" alt=""></p> <p>所以, <strong>在应用内存吃紧的情况下, 需要考虑是否值得使用更多的内存消耗来换取更高的性能</strong>. 这里看到的是平衡的艺术, <mark><strong>空间换时间, 还是时间换空间, 只考虑任何一个方面都是不对的</strong></mark>.</p> <p><strong>第二个误区是, 过于迷信教科书的大 O 时间复杂度</strong>.</p> <p>数据结构中要实现一个列表, 有基于连续存储的数组和基于指针串联的链表两种方式. 在 Java 中, 有代表性的实现是 ArrayList 和 LinkedList, 前者背后的数据结构是数组, 后者则是(双向)链表.</p> <p>在选择数据结构的时候, 通常会考虑每种数据结构不同操作的时间复杂度, 以及使用场景两个因素. 数组和链表大 O 时间复杂度的显著差异:</p> <ol><li>对于数组, 随机元素访问的时间复杂度是 O(1), 元素插入操作是 O(n);</li> <li>对于链表, 随机元素访问的时间复杂度是 O(n), 元素插入操作是 O(1).</li></ol> <p>那在大量的元素插入, 很少的随机访问的业务场景下, 是不是就应该使用 LinkedList 呢? 接下来写一段代码测试下两者随机访问和插入的性能.</p> <p>定义四个参数一致的方法, 分别对元素个数为 elementCount 的 <strong>LinkedList 和 ArrayList</strong>, 循环 loopCount 次, 进行随机访问和增加元素到随机位置的操作:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// LinkedList访问</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">linkedListGet</span><span class="token punctuation">(</span><span class="token keyword">int</span> elementCount<span class="token punctuation">,</span> <span class="token keyword">int</span> loopCount<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> <span class="token class-name">IntStream</span><span class="token punctuation">.</span><span class="token function">rangeClosed</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> elementCount<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">boxed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toCollection</span><span class="token punctuation">(</span><span class="token class-name">LinkedList</span><span class="token operator">::</span><span class="token keyword">new</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">IntStream</span><span class="token punctuation">.</span><span class="token function">rangeClosed</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> loopCount<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>i <span class="token operator">-&gt;</span> list<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">ThreadLocalRandom</span><span class="token punctuation">.</span><span class="token function">current</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span>elementCount<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// ArrayList访问</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">arrayListGet</span><span class="token punctuation">(</span><span class="token keyword">int</span> elementCount<span class="token punctuation">,</span> <span class="token keyword">int</span> loopCount<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> <span class="token class-name">IntStream</span><span class="token punctuation">.</span><span class="token function">rangeClosed</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> elementCount<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">boxed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toCollection</span><span class="token punctuation">(</span><span class="token class-name">ArrayList</span><span class="token operator">::</span><span class="token keyword">new</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">IntStream</span><span class="token punctuation">.</span><span class="token function">rangeClosed</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> loopCount<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>i <span class="token operator">-&gt;</span> list<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">ThreadLocalRandom</span><span class="token punctuation">.</span><span class="token function">current</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span>elementCount<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// LinkedList插入</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">linkedListAdd</span><span class="token punctuation">(</span><span class="token keyword">int</span> elementCount<span class="token punctuation">,</span> <span class="token keyword">int</span> loopCount<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> <span class="token class-name">IntStream</span><span class="token punctuation">.</span><span class="token function">rangeClosed</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> elementCount<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">boxed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toCollection</span><span class="token punctuation">(</span><span class="token class-name">LinkedList</span><span class="token operator">::</span><span class="token keyword">new</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">IntStream</span><span class="token punctuation">.</span><span class="token function">rangeClosed</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> loopCount<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>i <span class="token operator">-&gt;</span> list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">ThreadLocalRandom</span><span class="token punctuation">.</span><span class="token function">current</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span>elementCount<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// ArrayList插入</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">arrayListAdd</span><span class="token punctuation">(</span><span class="token keyword">int</span> elementCount<span class="token punctuation">,</span> <span class="token keyword">int</span> loopCount<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> <span class="token class-name">IntStream</span><span class="token punctuation">.</span><span class="token function">rangeClosed</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> elementCount<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">boxed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toCollection</span><span class="token punctuation">(</span><span class="token class-name">ArrayList</span><span class="token operator">::</span><span class="token keyword">new</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">IntStream</span><span class="token punctuation">.</span><span class="token function">rangeClosed</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> loopCount<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>i <span class="token operator">-&gt;</span> list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">ThreadLocalRandom</span><span class="token punctuation">.</span><span class="token function">current</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span>elementCount<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><p>测试代码如下, 10 万个元素, 循环 10 万次:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">int</span> elementCount <span class="token operator">=</span> <span class="token number">100000</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> loopCount <span class="token operator">=</span> <span class="token number">100000</span><span class="token punctuation">;</span>

<span class="token class-name">StopWatch</span> stopWatch <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StopWatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
stopWatch<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token string">&quot;linkedListGet&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">linkedListGet</span><span class="token punctuation">(</span>elementCount<span class="token punctuation">,</span> loopCount<span class="token punctuation">)</span><span class="token punctuation">;</span>
stopWatch<span class="token punctuation">.</span><span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

stopWatch<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token string">&quot;arrayListGet&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">arrayListGet</span><span class="token punctuation">(</span>elementCount<span class="token punctuation">,</span> loopCount<span class="token punctuation">)</span><span class="token punctuation">;</span>
stopWatch<span class="token punctuation">.</span><span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>stopWatch<span class="token punctuation">.</span><span class="token function">prettyPrint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">StopWatch</span> stopWatch2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StopWatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
stopWatch2<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token string">&quot;linkedListAdd&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">linkedListAdd</span><span class="token punctuation">(</span>elementCount<span class="token punctuation">,</span> loopCount<span class="token punctuation">)</span><span class="token punctuation">;</span>
stopWatch2<span class="token punctuation">.</span><span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

stopWatch2<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token string">&quot;arrayListAdd&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">arrayListAdd</span><span class="token punctuation">(</span>elementCount<span class="token punctuation">,</span> loopCount<span class="token punctuation">)</span><span class="token punctuation">;</span>
stopWatch2<span class="token punctuation">.</span><span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>stopWatch2<span class="token punctuation">.</span><span class="token function">prettyPrint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><p>运行结果可能会让你大跌眼镜. 在随机访问方面, 可以看到 ArrayList 的绝对优势, 耗时只有 11 毫秒, 而 LinkedList 耗时 6.6 秒, 这符合上面所说的时间复杂度; <strong>但随机插入操作居然也是 LinkedList 落败, 耗时 9.3 秒, ArrayList 只要 1.5 秒</strong>:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span>
ns         <span class="token operator">%</span>     <span class="token class-name">Task</span> name
<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span>
<span class="token number">6604199591</span>  <span class="token number">100</span><span class="token operator">%</span>  linkedListGet
<span class="token number">011494583</span>  <span class="token number">000</span><span class="token operator">%</span>  arrayListGet
<span class="token class-name">StopWatch</span> ''<span class="token operator">:</span> running time <span class="token operator">=</span> <span class="token number">10729378832</span> ns
<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span>
ns         <span class="token operator">%</span>     <span class="token class-name">Task</span> name
<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span>
<span class="token number">9253355484</span>  <span class="token number">086</span><span class="token operator">%</span>  linkedListAdd
<span class="token number">1476023348</span>  <span class="token number">014</span><span class="token operator">%</span>  arrayListAdd
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>翻看 LinkedList 源码发现, 插入操作的时间复杂度是 O(1) 的前提是<strong>已经有了那个要插入节点的指针</strong>. 但在实现的时候, 需要先通过循环获取到那个节点的 Node, 然后再执行插入操作. 前者也是有开销的, 不可能只考虑插入操作本身的代价:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">int</span> index<span class="token punctuation">,</span> <span class="token class-name">E</span> element<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">checkPositionIndex</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>index <span class="token operator">==</span> size<span class="token punctuation">)</span>
        <span class="token function">linkLast</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span>
        <span class="token function">linkBefore</span><span class="token punctuation">(</span>element<span class="token punctuation">,</span> <span class="token function">node</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span> <span class="token function">node</span><span class="token punctuation">(</span><span class="token keyword">int</span> index<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// assert isElementIndex(index);</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>index <span class="token operator">&lt;</span> <span class="token punctuation">(</span>size <span class="token operator">&gt;&gt;</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span> x <span class="token operator">=</span> first<span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> index<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
            x <span class="token operator">=</span> x<span class="token punctuation">.</span>next<span class="token punctuation">;</span>
        <span class="token keyword">return</span> x<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span> x <span class="token operator">=</span> last<span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> size <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&gt;</span> index<span class="token punctuation">;</span> i<span class="token operator">--</span><span class="token punctuation">)</span>
            x <span class="token operator">=</span> x<span class="token punctuation">.</span>prev<span class="token punctuation">;</span>
        <span class="token keyword">return</span> x<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><p>所以, 对于插入操作, LinkedList 的时间复杂度其实也是 O(n). 继续做更多实验的话会发现, 在各种常用场景下, LinkedList 几乎都不能在性能上胜出 ArrayList.</p> <p>讽刺的是, LinkedList 的作者约书亚 · 布洛克(Josh Bloch), 在其推特上回复别人时说, 虽然 LinkedList 是我写的但我从来不用, 有谁会真的用吗?</p> <p><img src="/img/cc94eb01989817018a5d833516d34463-20230731165210-nulcieu.png" alt=""></p> <p>这告诉我们, 任何东西理论上和实际上是有差距的, <strong>请勿迷信教科书的理论, 最好在下定论之前实际测试一下</strong>. 抛开算法层面不谈, 由于 CPU 缓存, 内存连续性等问题, 链表这种数据结构的实现方式对性能并不友好, 即使在它最擅长的场景都不一定可以发挥威力.</p> <h5 id="重点回顾-10"><a href="#重点回顾-10" class="header-anchor">#</a> 重点回顾</h5> <p>今天分享了若干和 List 列表相关的错误案例, 基本都是由 &quot;想当然&quot; 导致的.</p> <p>第一, 想当然认为, Arrays.asList 和 List.subList 得到的 List 是普通的, 独立的 ArrayList, 在使用时出现各种奇怪的问题.</p> <ol><li><strong>Arrays.asList 得到的是 Arrays 的内部类 ArrayList, List.subList 得到的是 ArrayList 的内部类 SubList, 不能把这两个内部类转换为 ArrayList 使用.</strong></li> <li>Arrays.asList 直接使用了原始数组, 可以认为是共享 &quot;<strong>存储</strong>&quot;, 而且不支持增删元素; List.subList 直接引用了原始的 List, 也可以认为是共享 &quot;存储&quot;, 而且对原始 List 直接进行结构性修改会导致 SubList 出现异常.</li> <li>对 Arrays.asList 和 List.subList 容易忽略的是, 新的 List 持有了原始数据的引用, 可能会导致原始数据也无法 GC 的问题, 最终导致 OOM.</li></ol> <p>第二, 想当然认为, Arrays.asList 一定可以把所有数组转换为正确的 List. 当传入基本类型数组的时候, List 的元素是数组本身, 而不是数组中的元素.</p> <p>第三, 想当然认为, 内存中任何集合的搜索都是很快的, 结果在搜索超大 ArrayList 的时候遇到性能问题. 可以考虑利用 HashMap 哈希表随机查找的时间复杂度为 O(1) 这个特性来优化性能, 不过也要考虑 HashMap 存储空间上的代价, 要平衡时间和空间.</p> <p>第四, 想当然认为, 链表适合元素增删的场景, 选用 LinkedList 作为数据结构. 在真实场景中读写增删一般是平衡的, 而且增删不可能只是对头尾对象进行操作, 可能在 90% 的情况下都得不到性能增益, 建议使用之前通过性能测试评估一下.</p> <h4 id="_11-空值处理-分不清楚的null和恼人的空指针"><a href="#_11-空值处理-分不清楚的null和恼人的空指针" class="header-anchor">#</a> 11-空值处理:分不清楚的null和恼人的空指针</h4> <p>今天要分享的主题是, <strong>空值处理</strong>: 分不清楚的 null 和恼人的空指针.</p> <p>有一天我收到一条短信, 内容是 &quot;尊敬的 null 你好, XXX&quot;. 当时我就笑了, 这是程序员都能 Get 的笑点, 程序没有获取到我的姓名, 然后把空格式化为了 null. 很明显, 这是没处理好 null. 哪怕把 null 替换为贵宾, 顾客, 也不会引发这样的笑话.</p> <p>程序中的变量是 null, 就意味着它没有引用指向或者说没有指针. 对这个变量进行任何操作, 都必然会引发空指针异常, 在 Java 中就是 NullPointerException. 空指针异常容易在哪些情况下出现, 又应该如何修复呢?</p> <p>空指针异常虽然恼人但好在容易定位, 更麻烦的是要<strong>弄清楚 null 的含义</strong>. 比如, 客户端给服务端的一个数据是 null, 那么其意图到底是给一个空值, 还是没提供值呢? 再比如, 数据库中字段的 NULL 值, 是否有特殊的含义呢, 针对数据库中的 NULL 值, 写 SQL 需要特别注意什么呢?</p> <h5 id="修复和定位恼人的空指针问题"><a href="#修复和定位恼人的空指针问题" class="header-anchor">#</a> 修复和定位恼人的空指针问题</h5> <p><strong>NullPointerException 是 Java 代码中最常见的异常, 我将其最可能出现的场景归为以下 5 种</strong>:</p> <ol><li>参数值是 Integer 等包装类型, 使用时因为自动拆箱出现了空指针异常;</li> <li>字符串比较出现空指针异常;</li> <li>诸如 ConcurrentHashMap 这样的容器不支持 Key 和 Value 为 null, 强行 put null 的 Key 或 Value 会出现空指针异常;</li> <li>A 对象包含了 B, 在通过 A 对象的字段获得 B 之后, 没有对字段判空就级联调用 B 的方法出现空指针异常;</li> <li>方法或远程服务返回的 List 不是空而是 null, 没有进行判空就直接调用 List 的方法出现空指针异常.</li></ol> <p>为模拟说明这 5 种场景, 下面写了一个 wrongMethod 方法, 并一个 wrong 方法来调用它. wrong 方法的入参 test 是一个由 0 和 1 构成的, 长度为 4 的字符串, 第几位设置为 1 就代表第几个参数为 null, 用来控制 wrongMethod 方法的 4 个入参, 以模拟各种空指针情况:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token function">wrongMethod</span><span class="token punctuation">(</span><span class="token class-name">FooService</span> fooService<span class="token punctuation">,</span> <span class="token class-name">Integer</span> i<span class="token punctuation">,</span> <span class="token class-name">String</span> s<span class="token punctuation">,</span> <span class="token class-name">String</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;result {} {} {} {}&quot;</span><span class="token punctuation">,</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> s<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">&quot;OK&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> s<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token keyword">new</span> <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>fooService<span class="token punctuation">.</span><span class="token function">getBarService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">&quot;OK&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;OK&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;wrong&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">wrong</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;test&quot;</span><span class="token punctuation">,</span> defaultValue <span class="token operator">=</span> <span class="token string">&quot;1111&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> test<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">wrongMethod</span><span class="token punctuation">(</span>test<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token generics"><span class="token punctuation">&lt;</span>mark<span class="token punctuation">&gt;</span></span> <span class="token char">'1'</span> <span class="token operator">?</span> <span class="token keyword">null</span> <span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">FooService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            test<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span><span class="token operator">/</span>mark<span class="token operator">&gt;</span> <span class="token char">'1'</span> <span class="token operator">?</span> <span class="token keyword">null</span> <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
            test<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token generics"><span class="token punctuation">&lt;</span>mark<span class="token punctuation">&gt;</span></span> <span class="token char">'1'</span> <span class="token operator">?</span> <span class="token keyword">null</span> <span class="token operator">:</span> <span class="token string">&quot;OK&quot;</span><span class="token punctuation">,</span>
            test<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span><span class="token operator">/</span>mark<span class="token operator">&gt;</span> <span class="token char">'1'</span> <span class="token operator">?</span> <span class="token keyword">null</span> <span class="token operator">:</span> <span class="token string">&quot;OK&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">FooService</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Getter</span>
    <span class="token keyword">private</span> <span class="token class-name">BarService</span> barService<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">BarService</span> <span class="token punctuation">{</span>
    <span class="token class-name">String</span> <span class="token function">bar</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">&quot;OK&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br></div></div><p>很明显, 这个案例出现空指针异常是因为<strong>变量是一个空指针</strong>, 尝试获得变量的值或访问变量的成员会获得空指针异常. 但, 这个异常的定位比较麻烦.</p> <p>在测试方法 wrongMethod 中, 通过一行日志记录的操作, 在一行代码中模拟了 4 处空指针异常:</p> <ol><li>对入参 Integer i 进行 +1 操作;</li> <li>对入参 String s 进行比较操作, 判断内容是否等于 &quot;OK&quot;;</li> <li>对入参 String s 和入参 String t 进行比较操作, 判断两者是否相等;</li> <li>对 new 出来的 ConcurrentHashMap 进行 put 操作, Key 和 Value 都设置为 null.</li></ol> <p>输出的异常信息如下:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>NullPointerException</span><span class="token operator">:</span> <span class="token keyword">null</span>
at <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>geekbang<span class="token punctuation">.</span>time<span class="token punctuation">.</span>commonmistakes<span class="token punctuation">.</span>nullvalue<span class="token punctuation">.</span>demo2<span class="token punctuation">.</span></span>AvoidNullPointerExceptionController</span><span class="token punctuation">.</span><span class="token function">wrongMethod</span><span class="token punctuation">(</span><span class="token class-name">AvoidNullPointerExceptionController</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">37</span><span class="token punctuation">)</span>
at <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>geekbang<span class="token punctuation">.</span>time<span class="token punctuation">.</span>commonmistakes<span class="token punctuation">.</span>nullvalue<span class="token punctuation">.</span>demo2<span class="token punctuation">.</span></span>AvoidNullPointerExceptionController</span><span class="token punctuation">.</span><span class="token function">wrong</span><span class="token punctuation">(</span><span class="token class-name">AvoidNullPointerExceptionController</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">20</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>这段信息确实提示了这行代码出现了空指针异常, 但很难定位出到底是哪里出现了空指针, 可能是把入参 Integer 拆箱为 int 的时候出现的, 也可能是入参的两个字符串任意一个为 null, 也可能是因为把 null 加入了 ConcurrentHashMap.</p> <p>你可能会想到, 要排查这样的问题, 只要设置一个断点看一下入参即可. 但在真实的业务场景中, 空指针问题往往是在特定的入参和代码分支下才会出现, 本地难以重现. 如果要排查生产上出现的空指针问题, 设置代码断点不现实, 通常是要么把代码进行拆分, 要么增加更多的日志, 但都比较麻烦.</p> <p>在这里推荐使用阿里开源的 Java 故障诊断神器 Arthas. Arthas 简单易用功能强大, 可以定位出大多数的 Java 生产问题.</p> <p>接下来就演示下如何在 30 秒内知道 wrongMethod 方法的入参, 从而定位到空指针到底是哪个入参引起的. 如下截图中有三个红框, 先分析第二和第三个红框:</p> <ol><li>第二个红框表示, <strong>Arthas 启动后被附加到了 JVM 进程</strong>;</li> <li>第三个红框表示, <strong>通过 watch 命令监控 wrongMethod 方法的入参</strong>.</li></ol> <p><img src="/img/24d2d94bacbdac7a1aae1b1895e8c934-20230731165210-jisedpt.png" alt=""></p> <p><strong>watch 命令的参数包括类名表达式, 方法表达式和观察表达式</strong>. 这里设置观察类为 AvoidNullPointerExceptionController, 观察方法为 wrongMethod, 观察表达式为 params 表示观察入参:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>watch <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>geekbang<span class="token punctuation">.</span>time<span class="token punctuation">.</span>commonmistakes<span class="token punctuation">.</span>nullvalue<span class="token punctuation">.</span>demo2<span class="token punctuation">.</span></span>AvoidNullPointerExceptionController</span> wrongMethod params
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>开启 watch 后, 执行 2 次 wrong 方法分别设置 test 入参为 1111 和 1101, 也就是第一次传入 wrongMethod 的 4 个参数都为 null, 第二次传入的第 1, 2 和 4 个参数为 null.</p> <p>配合图中第一和第四个红框可以看到, 第二次调用时, 第三个参数是字符串 OK 其他参数是 null, Archas 正确输出了方法的所有入参, 这样很容易就能定位到空指针的问题了.</p> <p>到这里, 如果是简单的业务逻辑的话, 就可以定位到空指针异常了; 如果是分支复杂的业务逻辑, 需要再借助 <strong>stack 命令来查看 wrongMethod 方法的调用栈</strong>, 并配合 watch 命令查看各方法的入参, 就可以很方便地定位到空指针的根源了.</p> <p>下图演示了通过 stack 命令观察 wrongMethod 的调用路径:</p> <p><img src="/img/ae95209b0a6ca986bd7c11a5e13c2ac5-20230731165210-bqtu5iq.png" alt=""></p> <p>接下来看看如何修复上面出现的 5 种空指针异常.</p> <p>其实, 对于任何空指针异常的处理, 最直白的方式是先判空后操作. 不过这只能让异常不再出现, 还是要找到程序逻辑中出现的空指针究竟是来源于入参还是 Bug:</p> <ol><li>如果是来源于入参, 还要进一步分析入参是否合理等;</li> <li>如果是来源于 Bug, 那空指针不一定是纯粹的程序 Bug, 可能还涉及业务属性和接口调用规范等.</li></ol> <p>在这里, 因为是 Demo, 所以只考虑纯粹的空指针判空这种修复方式. 如果要先判空后处理, 大多数人会想到使用 if-else 代码块. 但这种方式既增加代码量又会降低易读性, 可以尝试利用 Java 8 的 Optional 类来消除这样的 if-else 逻辑, 使用一行代码进行判空和处理.</p> <p>修复思路如下:</p> <ol><li>对于 Integer 的判空, <strong>可以使用 Optional.ofNullable 来构造一个 Optional, 然后使用 orElse(0) 把 null 替换为默认值再进行 +1 操作</strong>.</li> <li>对于 String 和字面量的比较, 可以把字面量放在前面, 比如 &quot;OK&quot;.equals(s), 这样即使 s 是 null 也不会出现空指针异常; 而对于两个可能为 null 的字符串变量的 equals 比较, 可以使用 Objects.equals, 它会做判空处理.</li> <li>对于 ConcurrentHashMap, 既然其 Key 和 Value 都不支持 null, 修复方式就是<strong>不要把 null 存进去</strong>. HashMap 的 Key 和 Value 可以存入 null, 而 ConcurrentHashMap 看似是 HashMap 的线程安全版本, 却不支持 null 值的 Key 和 Value, 这是容易产生误区的一个地方.</li> <li>对于类似 fooService.getBarService().bar().equals(&quot;OK&quot;) 的级联调用, 需要判空的地方有很多, 包括 fooService, getBarService() 方法的返回值, 以及 bar 方法返回的字符串. 如果使用 if-else 来判空的话可能需要好几行代码, 但使用 Optional 的话一行代码就够了.</li> <li>对于 rightMethod 返回的 List, 由于<strong>不能确认其是否为 null, 所以在调用 size 方法获得列表大小之前, 同样可以使用 Optional.ofNullable 包装一下返回值</strong>, 然后通过 <code>.orElse(Collections.emptyList())</code>​ 实现在 List 为 null 的时候获得一个空的 List, 最后再调用 size 方法.</li></ol> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token function">rightMethod</span><span class="token punctuation">(</span><span class="token class-name">FooService</span> fooService<span class="token punctuation">,</span> <span class="token class-name">Integer</span> i<span class="token punctuation">,</span> <span class="token class-name">String</span> s<span class="token punctuation">,</span> <span class="token class-name">String</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;result {} {} {} {}&quot;</span><span class="token punctuation">,</span> 
            <span class="token class-name">Optional</span><span class="token punctuation">.</span><span class="token function">ofNullable</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">orElse</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> 
            <span class="token string">&quot;OK&quot;</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> t<span class="token punctuation">)</span><span class="token punctuation">,</span> 
            <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">Optional</span><span class="token punctuation">.</span><span class="token function">ofNullable</span><span class="token punctuation">(</span>fooService<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">FooService</span><span class="token operator">::</span><span class="token function">getBarService</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>barService <span class="token operator">-&gt;</span> <span class="token string">&quot;OK&quot;</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>barService<span class="token punctuation">.</span><span class="token function">bar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">ifPresent</span><span class="token punctuation">(</span>result <span class="token operator">-&gt;</span> log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;OK&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;right&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">right</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;test&quot;</span><span class="token punctuation">,</span> defaultValue <span class="token operator">=</span> <span class="token string">&quot;1111&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> test<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token class-name">Optional</span><span class="token punctuation">.</span><span class="token function">ofNullable</span><span class="token punctuation">(</span><span class="token function">rightMethod</span><span class="token punctuation">(</span>test<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token generics"><span class="token punctuation">&lt;</span>mark<span class="token punctuation">&gt;</span></span> <span class="token char">'1'</span> <span class="token operator">?</span> <span class="token keyword">null</span> <span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">FooService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            test<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span><span class="token operator">/</span>mark<span class="token operator">&gt;</span> <span class="token char">'1'</span> <span class="token operator">?</span> <span class="token keyword">null</span> <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
            test<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token generics"><span class="token punctuation">&lt;</span>mark<span class="token punctuation">&gt;</span></span> <span class="token char">'1'</span> <span class="token operator">?</span> <span class="token keyword">null</span> <span class="token operator">:</span> <span class="token string">&quot;OK&quot;</span><span class="token punctuation">,</span>
            test<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span><span class="token operator">/</span>mark<span class="token operator">&gt;</span> <span class="token char">'1'</span> <span class="token operator">?</span> <span class="token keyword">null</span> <span class="token operator">:</span> <span class="token string">&quot;OK&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">orElse</span><span class="token punctuation">(</span><span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">emptyList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p>经过修复后, 调用 right 方法传入 1111, 也就是给 rightMethod 的 4 个参数都设置为 null, 日志中也看不到任何空指针异常了:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token punctuation">[</span><span class="token number">21</span><span class="token operator">:</span><span class="token number">43</span><span class="token operator">:</span><span class="token number">40.619</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>http<span class="token operator">-</span>nio<span class="token operator">-</span><span class="token number">45678</span><span class="token operator">-</span>exec<span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token constant">INFO</span> <span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token punctuation">.</span>AvoidNullPointerExceptionController<span class="token operator">:</span><span class="token number">45</span>  <span class="token punctuation">]</span> <span class="token operator">-</span> result <span class="token number">1</span> <span class="token boolean">false</span> <span class="token boolean">true</span> <span class="token keyword">null</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>但是, 如果修改 right 方法入参为 0000, 即传给 rightMethod 方法的 4 个参数都不可能是 null, 最后日志中也无法出现 OK 字样. 这又是为什么呢, BarService 的 bar 方法不是返回了 OK 字符串吗?</p> <p>还是用 Arthas 来定位问题, <strong>使用 watch 命令来观察方法 rightMethod 的入参, -x 参数设置为 2 代表参数打印的深度为 2 层</strong>:</p> <p><img src="/img/225779188b35709056cfdeedc84d48be-20230731165210-dbc0hni.png" alt=""></p> <p>可以看到, FooService 中的 barService 字段为 null, 这也就可以理解为什么最终出现这个 Bug 了.</p> <p>这又引申出一个问题, <strong>使用判空方式或 Optional 方式来避免出现空指针异常, 不一定是解决问题的最好方式, 空指针没出现可能隐藏了更深的 Bug</strong>. 因此, 解决空指针异常, 还是要真正 case by case 地定位分析案例, 然后再去做判空处理, 而处理时也并不只是判断非空然后进行正常业务流程这么简单, 同样需要考虑为空的时候是应该出异常, 设默认值还是记录日志等.</p> <h5 id="pojo中属性的null到底代表了什么"><a href="#pojo中属性的null到底代表了什么" class="header-anchor">#</a> POJO中属性的null到底代表了什么?</h5> <p>在我看来, 相比判空避免空指针异常, 更容易出错的是 null 的定位问题. 对程序来说, null 就是指针没有任何指向, 而结合业务逻辑情况就复杂得多, 需要考虑:</p> <ol><li>DTO 中字段的 null 到底意味着什么? 是客户端没有传给我们这个信息吗?</li> <li>既然空指针问题很讨厌, 那么 DTO 中的字段要设置默认值么?</li> <li>如果数据库实体中的字段有 null, 那么通过数据访问框架保存数据是否会覆盖数据库中的既有数据?</li></ol> <p>如果不能明确地回答这些问题, 那么写出的程序逻辑很可能会混乱不堪. 接下来看一个实际案例.</p> <p>有一个 User 的 POJO, <strong>同时扮演 DTO 和数据库 Entity 角色</strong>, 包含用户 ID, 姓名, 昵称, 年龄, 注册时间等属性:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Data</span>
<span class="token annotation punctuation">@Entity</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">User</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Id</span>
    <span class="token annotation punctuation">@GeneratedValue</span><span class="token punctuation">(</span>strategy <span class="token operator">=</span> <span class="token constant">IDENTITY</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> id<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> nickname<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Integer</span> age<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Date</span> createDate <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>有一个 Post 接口用于更新用户数据, 更新逻辑非常简单, 根据用户姓名自动设置一个昵称, 昵称的规则是 &quot;用户类型 + 姓名&quot;, 然后直接把客户端在 RequestBody 中使用 JSON 传过来的 User 对象通过 JPA 更新到数据库中, 最后返回保存到数据库的数据.</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Autowired</span>
<span class="token keyword">private</span> <span class="token class-name">UserRepository</span> userRepository<span class="token punctuation">;</span>

<span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;wrong&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">User</span> <span class="token function">wrong</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">User</span> user<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    user<span class="token punctuation">.</span><span class="token function">setNickname</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;guest%s&quot;</span><span class="token punctuation">,</span> user<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> userRepository<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@Repository</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">UserRepository</span> <span class="token keyword">extends</span> <span class="token class-name">JpaRepository</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">User</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>首先, 在数据库中初始化一个用户, age=36, name=zhuye, create_date=2020 年 1 月 4 日, nickname 是 NULL:</p> <p><img src="/img/0b43e019f1421075f7751e3f7995312b-20230731165210-76uue6j.png" alt=""></p> <p>然后, 使用 cURL 测试一下用户信息更新接口 Post, 传入一个 id=1, name=null 的 JSON 字符串, 期望把 ID 为 1 的用户姓名设置为空:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>curl <span class="token operator">-</span><span class="token class-name">H</span> <span class="token string">&quot;Content-Type:application/json&quot;</span> <span class="token operator">-</span><span class="token class-name">X</span> <span class="token constant">POST</span> <span class="token operator">-</span>d '<span class="token punctuation">{</span> <span class="token string">&quot;id&quot;</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">&quot;name&quot;</span><span class="token operator">:</span><span class="token keyword">null</span><span class="token punctuation">}</span>' http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>localhost<span class="token operator">:</span><span class="token number">45678</span><span class="token operator">/</span>pojonull<span class="token operator">/</span>wrong

<span class="token punctuation">{</span><span class="token string">&quot;id&quot;</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">&quot;name&quot;</span><span class="token operator">:</span><span class="token keyword">null</span><span class="token punctuation">,</span><span class="token string">&quot;nickname&quot;</span><span class="token operator">:</span><span class="token string">&quot;guestnull&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;age&quot;</span><span class="token operator">:</span><span class="token keyword">null</span><span class="token punctuation">,</span><span class="token string">&quot;createDate&quot;</span><span class="token operator">:</span><span class="token string">&quot;2020-01-05T02:01:03.784+0000&quot;</span><span class="token punctuation">}</span><span class="token operator">%</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>接口返回的结果和数据库中记录一致:</p> <p><img src="/img/e848937e75cceb7821c33f8f3a8f1033-20230731165210-ilv8yvy.png" alt=""></p> <p>可以看到, 这里存在如下三个问题:</p> <ol><li>调用方只希望重置用户名, 但 age 也被设置为了 null;</li> <li>nickname 是用户类型加姓名, name 重置为 null 的话, 访客用户的昵称应该是 guest, 而不是 guestnull, 重现了文首提到的那个笑点;</li> <li>用户的创建时间原来是 1 月 4 日, 更新了用户信息后变为了 1 月 5 日.</li></ol> <p>归根结底, 这是如下 5 个方面的问题:</p> <ol><li>明确 DTO 种 null 的含义. <strong>对于 JSON 到 DTO 的反序列化过程, null 的表达是有歧义的, 客户端不传某个属性, 或者传 null, 这个属性在 DTO 中都是 null.</strong>  但对于用户信息更新操作, 不传意味着客户端不需要更新这个属性, 维持数据库原先的值; 传了 null, 意味着客户端希望重置这个属性. 因为 Java 中的 null 就是没有这个数据, 无法区分这两种表达, 所以本例中的 age 属性也被设置为了 null, 或许可以借助 Optional 来解决这个问题.</li> <li><strong>POJO 中的字段有默认值. 如果客户端不传值, 就会赋值为默认值, 导致创建时间也被更新到了数据库中.</strong></li> <li><strong>注意字符串格式化时可能会把 null 值格式化为 null 字符串.</strong>  比如昵称的设置, 只是进行了简单的字符串格式化, 存入数据库变为了 guestnull. 显然这是不合理的, 也是开头说的笑话的来源, 还需要进行判断.</li> <li><strong>DTO 和 Entity 共用了一个 POJO</strong>. 对于用户昵称的设置是程序控制的, 不应该把它们暴露在 DTO 中, 否则很容易把客户端随意设置的值更新到数据库中. 此外, 创建时间最好让数据库设置为当前时间, 不用程序控制, 可以通过在字段上设置 columnDefinition 来实现.</li> <li><strong>数据库字段允许保存 null, 会进一步增加出错的可能性和复杂度</strong>. 因为如果数据真正落地的时候也支持 NULL 的话, 可能就有 NULL, 空字符串和字符串 null 三种状态. 这一点会在下一小节展开. 如果所有属性都有默认值, 问题会简单一点.</li></ol> <p>按照这个思路, <strong>对 DTO 和 Entity 进行拆分</strong>, 修改后代码如下所示:</p> <ol><li>UserDto 中只保留 id, name 和 age 三个属性, 且 name 和 age 使用 Optional 来包装, 以区分客户端不传数据还是故意传 null.</li> <li>在 UserEntity 的字段上使用 @Column 注解, 把数据库字段 name, nickname, age 和 createDate 都设置为 NOT NULL, 并设置 createDate 的默认值为 CURRENT_TIMESTAMP, 由数据库来生成创建时间.</li> <li>使用 Hibernate 的 @DynamicUpdate 注解实现更新 SQL 的动态生成, 实现只更新修改后的字段, 不过需要先查询一次实体, 让 Hibernate 可以 &quot;跟踪&quot; 实体属性的当前状态, 以确保有效.</li></ol> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Data</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserDto</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> id<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Optional</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> name<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Optional</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> age<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
 
<span class="token annotation punctuation">@Data</span>
<span class="token annotation punctuation">@Entity</span>
<span class="token annotation punctuation">@DynamicUpdate</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserEntity</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Id</span>
    <span class="token annotation punctuation">@GeneratedValue</span><span class="token punctuation">(</span>strategy <span class="token operator">=</span> <span class="token constant">IDENTITY</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> id<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Column</span><span class="token punctuation">(</span>nullable <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Column</span><span class="token punctuation">(</span>nullable <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> nickname<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Column</span><span class="token punctuation">(</span>nullable <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">Integer</span> age<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Column</span><span class="token punctuation">(</span>nullable <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">,</span> columnDefinition <span class="token operator">=</span> <span class="token string">&quot;TIMESTAMP DEFAULT CURRENT_TIMESTAMP&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">Date</span> createDate<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><p>在重构了 DTO 和 Entity 后, 重新定义一个 right 接口, 以便对更新操作进行更精细化的处理. 首先是参数校验:</p> <ol><li>对传入的 UserDto 和 ID 属性<strong>先判空</strong>, 如果为空直接抛出 IllegalArgumentException.</li> <li>根据 id 从数据库中查询出实体后进行判空, 如果为空直接抛出 IllegalArgumentException.</li></ol> <p>然后, 由于 DTO 中已经巧妙使用了 Optional 来区分客户端不传值和传 null 值, 那么业务逻辑实现上就可以按照客户端的意图来分别实现逻辑. 如果不传值, 那么 Optional 本身为 null, 直接跳过 Entity 字段的更新即可, 这样动态生成的 SQL 就不会包含这个列; 如果传了值, 那么进一步判断传的是不是 null.</p> <p>下面根据业务需要分别对姓名, 年龄和昵称进行更新:</p> <ol><li>对于姓名, 认为客户端传 null 是希望把姓名重置为空, 允许这样的操作, 使用 Optional 的 orElse 方法一键把空转换为空字符串即可.</li> <li>对于年龄, 认为如果客户端希望更新年龄就必须传一个有效的年龄, 年龄不存在重置操作, 可以使用 Optional 的 orElseThrow 方法在值为空的时候抛出 IllegalArgumentException.</li> <li>对于昵称, 因为数据库中姓名不可能为 null, 所以可以放心地把昵称设置为 guest 加上数据库取出来的姓名.</li></ol> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;right&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">UserEntity</span> <span class="token function">right</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">UserDto</span> user<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>user <span class="token generics"><span class="token punctuation">&lt;</span>mark<span class="token punctuation">&gt;</span></span> <span class="token keyword">null</span> <span class="token operator">||</span> user<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span><span class="token operator">/</span>mark<span class="token operator">&gt;</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">&quot;用户Id不能为空&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">UserEntity</span> userEntity <span class="token operator">=</span> userEntityRepository<span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">orElseThrow</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">&quot;用户不存在&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        userEntity<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">orElse</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    userEntity<span class="token punctuation">.</span><span class="token function">setNickname</span><span class="token punctuation">(</span><span class="token string">&quot;guest&quot;</span> <span class="token operator">+</span> userEntity<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getAge</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        userEntity<span class="token punctuation">.</span><span class="token function">setAge</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getAge</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">orElseThrow</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">&quot;年龄不能为空&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> userEntityRepository<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>userEntity<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><p>假设数据库中已经有这么一条记录, id=1, age=36, create_date=2020 年 1 月 4 日, name=zhuye, nickname=guestzhuye:</p> <p><img src="/img/1d9e95acc43cea1be834d3feb35419e1-20230731165210-8dodqc3.png" alt=""></p> <p>使用相同的参数调用 right 接口, 再来试试是否解决了所有问题. 传入一个 id=1, name=null 的 JSON 字符串, 期望把 id 为 1 的用户姓名设置为空:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>curl <span class="token operator">-</span><span class="token class-name">H</span> <span class="token string">&quot;Content-Type:application/json&quot;</span> <span class="token operator">-</span><span class="token class-name">X</span> <span class="token constant">POST</span> <span class="token operator">-</span>d '<span class="token punctuation">{</span> <span class="token string">&quot;id&quot;</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">&quot;name&quot;</span><span class="token operator">:</span><span class="token keyword">null</span><span class="token punctuation">}</span>' http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>localhost<span class="token operator">:</span><span class="token number">45678</span><span class="token operator">/</span>pojonull<span class="token operator">/</span>right

<span class="token punctuation">{</span><span class="token string">&quot;id&quot;</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">&quot;name&quot;</span><span class="token operator">:</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;nickname&quot;</span><span class="token operator">:</span><span class="token string">&quot;guest&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;age&quot;</span><span class="token operator">:</span><span class="token number">36</span><span class="token punctuation">,</span><span class="token string">&quot;createDate&quot;</span><span class="token operator">:</span><span class="token string">&quot;2020-01-04T11:09:20.000+0000&quot;</span><span class="token punctuation">}</span><span class="token operator">%</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>结果如下:</p> <p><img src="/img/6c30d310d1ef2092a36ac1a3e982ac3a-20230731165210-zj8t6ll.png" alt=""></p> <p>可以看到, right 接口完美实现了仅重置 name 属性的操作, 昵称也不再有 null 字符串, 年龄和创建时间字段也没被修改.</p> <p>通过日志可以看到, Hibernate 生成的 SQL 语句只更新了 name 和 nickname 两个字段:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">Hibernate</span><span class="token operator">:</span> update user_entity set name<span class="token operator">=</span><span class="token operator">?</span><span class="token punctuation">,</span> nickname<span class="token operator">=</span><span class="token operator">?</span> where id<span class="token operator">=</span><span class="token operator">?</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>接下来, 为了测试使用 Optional 是否可以有效区分 JSON 中没传属性还是传了 null, 在 JSON 中设置了一个 null 的 age, 结果是正确得到了年龄不能为空的错误提示:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>curl <span class="token operator">-</span><span class="token class-name">H</span> <span class="token string">&quot;Content-Type:application/json&quot;</span> <span class="token operator">-</span><span class="token class-name">X</span> <span class="token constant">POST</span> <span class="token operator">-</span>d '<span class="token punctuation">{</span> <span class="token string">&quot;id&quot;</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">&quot;age&quot;</span><span class="token operator">:</span><span class="token keyword">null</span><span class="token punctuation">}</span>' http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>localhost<span class="token operator">:</span><span class="token number">45678</span><span class="token operator">/</span>pojonull<span class="token operator">/</span>right

<span class="token punctuation">{</span><span class="token string">&quot;timestamp&quot;</span><span class="token operator">:</span><span class="token string">&quot;2020-01-05T03:14:40.324+0000&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;status&quot;</span><span class="token operator">:</span><span class="token number">500</span><span class="token punctuation">,</span><span class="token string">&quot;error&quot;</span><span class="token operator">:</span><span class="token string">&quot;Internal Server Error&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;message&quot;</span><span class="token operator">:</span><span class="token string">&quot;年龄不能为空&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;path&quot;</span><span class="token operator">:</span><span class="token string">&quot;/pojonull/right&quot;</span><span class="token punctuation">}</span><span class="token operator">%</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h5 id="小心mysql中有关null的三个坑"><a href="#小心mysql中有关null的三个坑" class="header-anchor">#</a> 小心MySQL中有关NULL的三个坑</h5> <p>前面提到, 数据库表字段允许存 NULL 除了会让我们困惑外, 还容易有坑. 这里会结合 NULL 字段, 着重说明 sum 函数, count 函数, 以及 NULL 值条件可能踩的坑.</p> <p>为方便演示, 首先定义一个只有 id 和 score 两个字段的实体:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Entity</span>
<span class="token annotation punctuation">@Data</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">User</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Id</span>
    <span class="token annotation punctuation">@GeneratedValue</span><span class="token punctuation">(</span>strategy <span class="token operator">=</span> <span class="token constant">IDENTITY</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> id<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> score<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>程序启动的时候, 往实体初始化一条数据, 其 id 是自增列自动设置的 1, score 是 NULL:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Autowired</span>
<span class="token keyword">private</span> <span class="token class-name">UserRepository</span> userRepository<span class="token punctuation">;</span>

<span class="token annotation punctuation">@PostConstruct</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    userRepository<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>然后测试下面三个用例, 来看看结合数据库中的 null 值可能会出现的坑:</p> <ol><li>通过 sum 函数统计一个只有 NULL 值的列的总和, 比如 SUM(score);</li> <li>select 记录数量, count 使用一个允许 NULL 的字段, 比如 COUNT(score);</li> <li>使用 <code>=NULL</code>​ 条件查询字段值为 NULL 的记录, 比如 <code>score=null</code>​ 条件.</li></ol> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Repository</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">UserRepository</span> <span class="token keyword">extends</span> <span class="token class-name">JpaRepository</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">User</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Query</span><span class="token punctuation">(</span>nativeQuery<span class="token operator">=</span><span class="token boolean">true</span><span class="token punctuation">,</span>value <span class="token operator">=</span> <span class="token string">&quot;SELECT SUM(score) FROM `user`&quot;</span><span class="token punctuation">)</span>
    <span class="token class-name">Long</span> <span class="token function">wrong1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Query</span><span class="token punctuation">(</span>nativeQuery <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span> value <span class="token operator">=</span> <span class="token string">&quot;SELECT COUNT(score) FROM `user`&quot;</span><span class="token punctuation">)</span>
    <span class="token class-name">Long</span> <span class="token function">wrong2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Query</span><span class="token punctuation">(</span>nativeQuery <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span> value <span class="token operator">=</span> <span class="token string">&quot;SELECT * FROM `user` WHERE score=null&quot;</span><span class="token punctuation">)</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">User</span><span class="token punctuation">&gt;</span></span> <span class="token function">wrong3</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>得到的结果, 分别是 null, 0 和空 List:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token punctuation">[</span><span class="token number">11</span><span class="token operator">:</span><span class="token number">38</span><span class="token operator">:</span><span class="token number">50.137</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>http<span class="token operator">-</span>nio<span class="token operator">-</span><span class="token number">45678</span><span class="token operator">-</span>exec<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token constant">INFO</span> <span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token class-name"><span class="token namespace">t<span class="token punctuation">.</span>c<span class="token punctuation">.</span>nullvalue<span class="token punctuation">.</span>demo3<span class="token punctuation">.</span></span>DbNullController</span><span class="token operator">:</span><span class="token number">26</span>  <span class="token punctuation">]</span> <span class="token operator">-</span> result<span class="token operator">:</span> <span class="token keyword">null</span> <span class="token number">0</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>显然, 这三条 SQL 语句的执行结果和期望不同:</p> <ol><li>虽然记录的 score 都是 NULL, 但 sum 的结果应该是 0 才对;</li> <li>虽然这条记录的 score 是 NULL, 但记录总数应该是 1 才对;</li> <li>使用 <code>=NULL</code>​ 并没有查询到 id=1 的记录, 查询条件失效.</li></ol> <p>原因是:</p> <ol><li><strong>MySQL 中 sum 函数没统计到任何记录时, 会返回 null 而不是 0</strong>, 可以使用 IFNULL 函数把 null 转换为 0;</li> <li><strong>MySQL 中 count 字段不统计 null 值</strong>, <code>COUNT(*)</code>​ 才是统计所有记录数量的正确方式.</li> <li><strong>MySQL 中 =NULL 并不是判断条件而是赋值</strong>, 对 NULL 进行判断只能使用 IS NULL 或者 IS NOT NULL.</li></ol> <p>修改一下 SQL:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Query</span><span class="token punctuation">(</span>nativeQuery <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span> value <span class="token operator">=</span> <span class="token string">&quot;SELECT IFNULL(SUM(score),0) FROM `user`&quot;</span><span class="token punctuation">)</span>
<span class="token class-name">Long</span> <span class="token function">right1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Query</span><span class="token punctuation">(</span>nativeQuery <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span> value <span class="token operator">=</span> <span class="token string">&quot;SELECT COUNT(*) FROM `user`&quot;</span><span class="token punctuation">)</span>
<span class="token class-name">Long</span> <span class="token function">right2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Query</span><span class="token punctuation">(</span>nativeQuery <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span> value <span class="token operator">=</span> <span class="token string">&quot;SELECT * FROM `user` WHERE score IS NULL&quot;</span><span class="token punctuation">)</span>
<span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">User</span><span class="token punctuation">&gt;</span></span> <span class="token function">right3</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>可以得到三个正确结果, 分别为 0, 1, [User(id=1, score=null)] :</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token punctuation">[</span><span class="token number">14</span><span class="token operator">:</span><span class="token number">50</span><span class="token operator">:</span><span class="token number">35.768</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>http<span class="token operator">-</span>nio<span class="token operator">-</span><span class="token number">45678</span><span class="token operator">-</span>exec<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token constant">INFO</span> <span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token class-name"><span class="token namespace">t<span class="token punctuation">.</span>c<span class="token punctuation">.</span>nullvalue<span class="token punctuation">.</span>demo3<span class="token punctuation">.</span></span>DbNullController</span><span class="token operator">:</span><span class="token number">31</span>  <span class="token punctuation">]</span> <span class="token operator">-</span> result<span class="token operator">:</span> <span class="token number">0</span> <span class="token number">1</span> <span class="token punctuation">[</span><span class="token class-name">User</span><span class="token punctuation">(</span>id<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> score<span class="token operator">=</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h5 id="重点回顾-11"><a href="#重点回顾-11" class="header-anchor">#</a> 重点回顾</h5> <p>今天讨论了做好空值处理需要注意的几个问题.</p> <p>首先总结了业务代码中 5 种最容易出现空指针异常的写法, 以及相应的修复方式. 针对判空, 通过 Optional 配合 Stream 可以避免大多数冗长的 if-else 判空逻辑, 实现一行代码优雅判空. 另外, 要定位和修复空指针异常, 除了可以通过增加日志进行排查外, 在生产上使用 Arthas 来查看方法的调用栈和入参会更快捷.</p> <p>在我看来, 业务系统最基本的标准是不能出现未处理的空指针异常, 因为它往往代表了业务逻辑的中断, 所以建议每天查询一次生产日志来排查空指针异常, 有条件的话建议订阅空指针异常报警, 以便及时发现及时处理.</p> <p>POJO 中字段的 null 定位, 从服务端的角度往往很难分清楚, 到底是客户端希望忽略这个字段还是有意传了 null, 因此尝试用 Optional类来区分 null 的定位. 同时为避免把空值更新到数据库中, 可以实现动态 SQL, 只更新必要的字段.</p> <p>最后分享了数据库字段使用 NULL 可能会带来的三个坑(包括 sum 函数, count 函数, 以及 NULL 值条件), 以及解决方式.</p> <p>总结来讲, null 的正确处理以及避免空指针异常, 绝不是判空这么简单, 还要根据业务属性从前到后仔细考虑, 客户端传入的 null 代表了什么, 出现了 null 是否允许使用默认值替代, 入库的时候应该传入 null 还是空值, 并确保整个逻辑处理的一致性, 才能尽量避免 Bug.</p> <p>为处理好 null, 作为客户端的开发者, 需要和服务端对齐字段 null 的含义以及降级逻辑; 而作为服务端的开发者, 需要对入参进行前置判断, 提前挡掉服务端不可接受的空值, 同时在整个业务逻辑过程中进行完善的空值处理.</p> <h4 id="_12-异常处理-别让自己在出问题的时候变为瞎子"><a href="#_12-异常处理-别让自己在出问题的时候变为瞎子" class="header-anchor">#</a> 12-异常处理:别让自己在出问题的时候变为瞎子</h4> <p>今天来聊聊异常处理容易踩的坑.</p> <p>应用程序避免不了出异常, 捕获和处理异常是考验编程功力的一个精细活. 一些业务项目中, 我曾看到开发同学在开发业务逻辑时不考虑任何异常处理, 项目接近完成时再采用 &quot;流水线&quot; 的方式进行异常处理, 也就是统一为所有方法打上 try..catch.. 捕获所有异常记录日志, 有些技巧的同学可能会使用 AOP 来进行类似的 &quot;统一异常处理&quot;.</p> <p>其实, 这种处理异常的方式非常不可取. 今天就分享下不可取的原因, 与<strong>异常处理相关的坑和最佳实践</strong>.</p> <h5 id="捕获和处理异常容易犯的错"><a href="#捕获和处理异常容易犯的错" class="header-anchor">#</a> 捕获和处理异常容易犯的错</h5> <p>&quot;统一异常处理&quot; 方式正是我要说的第一个错: <strong>不在业务代码层面考虑异常处理, 仅在框架层面粗犷捕获和处理异常</strong>.</p> <p>为了理解错在何处, 先来看看大多数业务应用都采用的三层架构:</p> <ol><li>Controller 层负责信息收集, 参数校验, 转换服务层处理的数据适配前端, 轻业务逻辑;</li> <li>Service 层负责核心业务逻辑, 包括各种外部服务调用, 访问数据库, 缓存处理, 消息处理等;</li> <li>Repository 层负责数据访问实现, 一般没有业务逻辑.</li></ol> <p><img src="/img/4efad6cbc4afedbac0e507a85a54598d-20230731165210-2r9bm4s.png" alt=""></p> <p>每层架构的工作性质不同, 且从业务性质上异常可能分为业务异常和系统异常两大类, 这就决定了很难进行统一的异常处理. 我们从底向上看一下三层架构:</p> <ol><li>Repository 层出现异常或许可以忽略, 或许可以降级, 或许需要转化为一个友好的异常. 如果一律捕获异常仅记录日志, 很可能业务逻辑已经出错, 而用户和程序本身完全感知不到.</li> <li>Service 层往往涉及数据库事务, 出现<strong>异常同样不适合捕获, 否则事务无法自动回滚</strong>. 此外 Service 层涉及业务逻辑, 有些业务逻辑执行中遇到业务异常, 可能需要在异常后转入分支业务流程. 如果业务异常都被框架捕获了, 业务功能就会不正常.</li> <li>如果下层异常上升到 Controller 层还是无法处理的话, Controller 层往往会给予用户友好提示, 或是根据每一个 API 的异常表返回指定的异常类型, 同样无法对所有异常一视同仁.</li></ol> <p>因此, <mark><strong>不建议在框架层面进行异常的自动, 统一处理, 尤其不要随意捕获异常</strong></mark>. 但框架可以做兜底工作. 如果异常上升到最上层逻辑还是无法处理的话, 可以以统一的方式进行异常转换, 比如通过 @RestControllerAdvice + @ExceptionHandler, 来捕获这些 &quot;未处理&quot; 异常:</p> <ol><li>对于自定义的业务异常, 以 Warn 级别的日志记录异常以及当前 URL, 执行方法等信息后, 提取异常中的错误码和消息等信息, 转换为合适的 API 包装体返回给 API 调用方;</li> <li>对于无法处理的系统异常, 以 Error 级别的日志记录异常和上下文信息(比如 URL, 参数, 用户 ID)后, 转换为普适的 &quot;服务器忙, 请稍后再试&quot; 异常信息, 同样以 API 包装体返回给调用方.</li></ol> <p>比如下面这段代码的做法:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@RestControllerAdvice</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RestControllerExceptionHandler</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token constant">GENERIC_SERVER_ERROR_CODE</span> <span class="token operator">=</span> <span class="token number">2000</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token constant">GENERIC_SERVER_ERROR_MESSAGE</span> <span class="token operator">=</span> <span class="token string">&quot;服务器忙, 请稍后再试&quot;</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@ExceptionHandler</span>
    <span class="token keyword">public</span> <span class="token class-name">APIResponse</span> <span class="token function">handle</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> req<span class="token punctuation">,</span> <span class="token class-name">HandlerMethod</span> method<span class="token punctuation">,</span> <span class="token class-name">Exception</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ex <span class="token keyword">instanceof</span> <span class="token class-name">BusinessException</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">BusinessException</span> exception <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">BusinessException</span><span class="token punctuation">)</span> ex<span class="token punctuation">;</span>
            log<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;访问 %s -&gt; %s 出现业务异常! &quot;</span><span class="token punctuation">,</span> req<span class="token punctuation">.</span><span class="token function">getRequestURI</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> method<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">APIResponse</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> exception<span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> exception<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;访问 %s -&gt; %s 出现系统异常! &quot;</span><span class="token punctuation">,</span> req<span class="token punctuation">.</span><span class="token function">getRequestURI</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> method<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">APIResponse</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token constant">GENERIC_SERVER_ERROR_CODE</span><span class="token punctuation">,</span> <span class="token constant">GENERIC_SERVER_ERROR_MESSAGE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>出现运行时系统异常后, 异常处理程序会直接把异常转换为 JSON 返回给调用方:</p> <p>​<img src="/img/6acd2851eaa88f70aa7f3adb3e71a825-20230731165210-x6fymts.png" alt="">​</p> <p>要做得更好, 可以<strong>把相关出入参, 用户信息在脱敏后记录到日志中, 方便出现问题时根据上下文进一步排查</strong>.</p> <p>第二个错, <strong>捕获了异常后直接生吞</strong>. 在任何时候, 捕获了异常都不应该生吞, 也就是直接丢弃异常不记录, 不抛出. 这样的处理方式还不如不捕获异常, 因为被生吞掉的异常一旦导致 Bug, 就很难在程序中找到蛛丝马迹, 使得 Bug 排查工作难上加难. 通常情况下, 生吞异常的原因, 可能是不希望自己的方法抛出受检异常, 只是为了把异常 &quot;处理掉&quot; 而捕获并生吞异常, 也可能是想当然地认为异常并不重要或不可能产生. 但不管是什么原因, 不管是你认为多么不重要的异常, <strong>都不应该生吞, 哪怕是一个日志也好</strong>.</p> <p>第三个错, <strong>丢弃异常的原始信息</strong>. 来看两个不太合适的异常处理方式, 虽然没有完全生吞异常, 但也丢失了宝贵的异常信息.</p> <p>比如有这么一个会抛出受检异常的方法 readFile:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">readFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
    <span class="token class-name">Files</span><span class="token punctuation">.</span><span class="token function">readAllLines</span><span class="token punctuation">(</span><span class="token class-name">Paths</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;a_file&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>像这样调用 readFile 方法, 捕获异常后, 完全不记录原始异常, <strong>直接抛出一个转换后异常</strong>, 导致出了问题不知道 IOException 具体是哪里引起的:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;wrong1&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">wrong1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token function">readFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 原始异常信息丢失  </span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;系统忙请稍后再试&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>或者是这样, 只记录了异常消息, <strong>却丢失了异常的类型, 栈等重要信息</strong>:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 只保留了异常消息, 栈没有记录</span>
    log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;文件读取错误, {}&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;系统忙请稍后再试&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>留下的日志是这样的, 看完一脸茫然, 只知道文件读取错误的文件名, 至于为什么读取错误, 是不存在还是没权限, 完全不知道.</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token punctuation">[</span><span class="token constant">ERROR</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token punctuation">.</span>g<span class="token punctuation">.</span>t<span class="token punctuation">.</span>c<span class="token punctuation">.</span>e<span class="token punctuation">.</span>d<span class="token punctuation">.</span>HandleExceptionController<span class="token operator">:</span><span class="token number">35</span>  <span class="token punctuation">]</span> <span class="token operator">-</span> 文件读取错误<span class="token punctuation">,</span> a_file
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>这两种处理方式都不太合理, 可以改为如下方式:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;文件读取错误&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;系统忙请稍后再试&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>或者把原始异常作为转换后新异常的 cause, 原始异常信息同样不会丢:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;系统忙请稍后再试&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>其实, JDK 内部也会犯类似的错. 之前我遇到一个使用 JDK10 的应用偶发启动失败的案例, 日志中可以看到出现类似的错误信息:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">Caused</span> by<span class="token operator">:</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>SecurityException</span><span class="token operator">:</span> <span class="token class-name">Couldn</span>'t parse jurisdiction policy files in<span class="token operator">:</span> unlimited
at java<span class="token punctuation">.</span>base<span class="token operator">/</span><span class="token class-name"><span class="token namespace">javax<span class="token punctuation">.</span>crypto<span class="token punctuation">.</span></span>JceSecurity</span><span class="token punctuation">.</span><span class="token function">setupJurisdictionPolicies</span><span class="token punctuation">(</span><span class="token class-name">JceSecurity</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">355</span><span class="token punctuation">)</span>
at java<span class="token punctuation">.</span>base<span class="token operator">/</span><span class="token class-name"><span class="token namespace">javax<span class="token punctuation">.</span>crypto<span class="token punctuation">.</span></span>JceSecurity</span><span class="token punctuation">.</span>access$<span class="token function">000</span><span class="token punctuation">(</span><span class="token class-name">JceSecurity</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">73</span><span class="token punctuation">)</span>
at java<span class="token punctuation">.</span>base<span class="token operator">/</span><span class="token class-name"><span class="token namespace">javax<span class="token punctuation">.</span>crypto<span class="token punctuation">.</span></span>JceSecurity</span>$<span class="token number">1.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">JceSecurity</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">109</span><span class="token punctuation">)</span>
at java<span class="token punctuation">.</span>base<span class="token operator">/</span><span class="token class-name"><span class="token namespace">javax<span class="token punctuation">.</span>crypto<span class="token punctuation">.</span></span>JceSecurity</span>$<span class="token number">1.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">JceSecurity</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">106</span><span class="token punctuation">)</span>
at java<span class="token punctuation">.</span>base<span class="token operator">/</span><span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>security<span class="token punctuation">.</span></span>AccessController</span><span class="token punctuation">.</span><span class="token function">doPrivileged</span><span class="token punctuation">(</span><span class="token class-name">Native</span> <span class="token class-name">Method</span><span class="token punctuation">)</span>
at java<span class="token punctuation">.</span>base<span class="token operator">/</span><span class="token class-name"><span class="token namespace">javax<span class="token punctuation">.</span>crypto<span class="token punctuation">.</span></span>JceSecurity</span><span class="token punctuation">.</span><span class="token generics"><span class="token punctuation">&lt;</span>clinit<span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token class-name">JceSecurity</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">105</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token number">20</span> more
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>查看 JDK JceSecurity 类 setupJurisdictionPolicies 方法源码, 发现异常 e 没有记录, 也没有作为新抛出异常的 cause, 当时读取文件具体出现什么异常(权限问题又或是 IO 问题)可能永远都无法知道了, 对问题定位造成了很大困扰:</p> <p><img src="/img/365938c12dd2a28a099ad41aeada0b92-20230731165210-rctz3iy.png" alt=""></p> <p>第四个错, <strong>抛出异常时不指定任何消息</strong>. 我见过一些代码中的偷懒做法, 直接抛出没有 message 的异常:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>这么写的同学可能觉得永远不会走到这个逻辑, 永远不会出现这样的异常. 但这样的异常却出现了, 被 ExceptionHandler 拦截到后输出了下面的日志信息:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token punctuation">[</span><span class="token number">13</span><span class="token operator">:</span><span class="token number">25</span><span class="token operator">:</span><span class="token number">18.031</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>http<span class="token operator">-</span>nio<span class="token operator">-</span><span class="token number">45678</span><span class="token operator">-</span>exec<span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token constant">ERROR</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token class-name"><span class="token namespace">c<span class="token punctuation">.</span>e<span class="token punctuation">.</span>d<span class="token punctuation">.</span></span>RestControllerExceptionHandler</span><span class="token operator">:</span><span class="token number">24</span>  <span class="token punctuation">]</span> <span class="token operator">-</span> 访问 <span class="token operator">/</span>handleexception<span class="token operator">/</span>wrong3 <span class="token operator">-&gt;</span> <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>geekbang<span class="token punctuation">.</span>time<span class="token punctuation">.</span>commonmistakes<span class="token punctuation">.</span>exception<span class="token punctuation">.</span>demo1<span class="token punctuation">.</span></span>HandleExceptionController</span>#<span class="token function">wrong3</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> 出现系统异常<span class="token operator">!</span> 
<span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>RuntimeException</span><span class="token operator">:</span> <span class="token keyword">null</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>这里的 null 非常容易引起误解. 按照空指针问题排查半天才发现, 其实是异常的 message 为空.</p> <p>总之, 如果捕获了异常打算处理的话, <strong>除了通过日志正确记录异常原始信息外, 通常还有三种处理模式</strong>:</p> <ol><li><strong>转换, 即转换新的异常抛出</strong>. 对于新抛出的异常, 最好具有特定的分类和明确的异常消息, 而不是随便抛一个无关或没有任何信息的异常, 并最好通过 cause 关联老异常.</li> <li><strong>重试, 即重试之前的操作</strong>. 比如远程调用服务端过载超时的情况, 盲目重试会让问题更严重, 需要考虑当前情况是否适合重试.</li> <li><strong>恢复, 即尝试进行降级处理, 或使用默认值来替代原始数据</strong>.</li></ol> <p>以上就是通过 catch 捕获处理异常的一些最佳实践.</p> <h5 id="小心finally中的异常"><a href="#小心finally中的异常" class="header-anchor">#</a> 小心finally中的异常</h5> <p>有些时候, 希望不管是否遇到异常, 逻辑完成后都要释放资源, 这时可以使用 finally 代码块而跳过使用 catch 代码块.</p> <p>但要千万小心 finally 代码块中的异常, 因为资源释放处理等收尾操作同样也可能出现异常. 比如下面这段代码, 在 finally 中抛出一个异常:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;wrong&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">wrong</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;try&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 异常丢失</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;try&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;finally&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;finally&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>最后在日志中只能看到 finally 中的异常, <strong>虽然 try 中的逻辑出现了异常, 但却被 finally 中的异常覆盖了</strong>. 这是非常危险的, 特别是 finally 中出现的异常是偶发的, 就会在部分时候覆盖 try 中的异常, 让问题更不明显:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token punctuation">[</span><span class="token number">13</span><span class="token operator">:</span><span class="token number">34</span><span class="token operator">:</span><span class="token number">42.247</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>http<span class="token operator">-</span>nio<span class="token operator">-</span><span class="token number">45678</span><span class="token operator">-</span>exec<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token constant">ERROR</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token punctuation">.</span>a<span class="token punctuation">.</span>c<span class="token punctuation">.</span>c<span class="token punctuation">.</span>C<span class="token punctuation">.</span><span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">[</span><span class="token operator">/</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token punctuation">[</span>dispatcherServlet<span class="token punctuation">]</span><span class="token operator">:</span><span class="token number">175</span> <span class="token punctuation">]</span> <span class="token operator">-</span> <span class="token class-name">Servlet</span><span class="token punctuation">.</span><span class="token function">service</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">for</span> servlet <span class="token punctuation">[</span>dispatcherServlet<span class="token punctuation">]</span> in context <span class="token keyword">with</span> <span class="token namespace">path</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> threw exception <span class="token punctuation">[</span><span class="token class-name">Request</span> processing failed<span class="token punctuation">;</span> nested exception is <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>RuntimeException</span><span class="token operator">:</span> <span class="token keyword">finally</span><span class="token punctuation">]</span> <span class="token keyword">with</span> <span class="token namespace">root</span> cause
<span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>RuntimeException</span><span class="token operator">:</span> <span class="token keyword">finally</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>至于异常为什么被覆盖, 原因也很简单, 因为一个方法无法出现两个异常. 修复方式是, finally 代码块自己负责异常捕获和处理:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;right&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">right</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;try&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;try&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;finally&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;finally&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;finally&quot;</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>或者可以把 try 中的异常作为主异常抛出, 使用 addSuppressed 方法把 finally 中的异常附加到主异常上:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;right2&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">right2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token class-name">Exception</span> e <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;try&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;try&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        e <span class="token operator">=</span> ex<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;finally&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;finally&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>e<span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                e<span class="token punctuation">.</span><span class="token function">addSuppressed</span><span class="token punctuation">(</span>ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                e <span class="token operator">=</span> ex<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">throw</span> e<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><p>运行方法可以得到如下异常信息, 其中同时包含了主异常和被屏蔽的异常:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>RuntimeException</span><span class="token operator">:</span> <span class="token keyword">try</span>
at <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>geekbang<span class="token punctuation">.</span>time<span class="token punctuation">.</span>commonmistakes<span class="token punctuation">.</span>exception<span class="token punctuation">.</span>finallyissue<span class="token punctuation">.</span></span>FinallyIssueController</span><span class="token punctuation">.</span><span class="token function">right2</span><span class="token punctuation">(</span><span class="token class-name">FinallyIssueController</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">69</span><span class="token punctuation">)</span>
at <span class="token class-name"><span class="token namespace">sun<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span></span>NativeMethodAccessorImpl</span><span class="token punctuation">.</span><span class="token function">invoke0</span><span class="token punctuation">(</span><span class="token class-name">Native</span> <span class="token class-name">Method</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token class-name">Suppressed</span><span class="token operator">:</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>RuntimeException</span><span class="token operator">:</span> <span class="token keyword">finally</span>
at <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>geekbang<span class="token punctuation">.</span>time<span class="token punctuation">.</span>commonmistakes<span class="token punctuation">.</span>exception<span class="token punctuation">.</span>finallyissue<span class="token punctuation">.</span></span>FinallyIssueController</span><span class="token punctuation">.</span><span class="token function">right2</span><span class="token punctuation">(</span><span class="token class-name">FinallyIssueController</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">75</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token number">54</span> common frames omitted
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>其实这正是 try-with-resources 语句的做法, 对于实现了 AutoCloseable 接口的资源, <strong>建议使用 try-with-resources 来释放资源</strong>, 否则也可能会产生刚才提到的, 释放资源时出现的异常覆盖主异常的问题. 比如如下定义一个测试资源, 其 read 和 close 方法都会抛出异常:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TestResource</span> <span class="token keyword">implements</span> <span class="token class-name">AutoCloseable</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Exception</span><span class="token punctuation">(</span><span class="token string">&quot;read error&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Exception</span><span class="token punctuation">(</span><span class="token string">&quot;close error&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>使用传统的 try-finally 语句, 在 try 中调用 read 方法, 在 finally 中调用 close 方法:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;useresourcewrong&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">useresourcewrong</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token class-name">TestResource</span> testResource <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TestResource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        testResource<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        testResource<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>可以看到, 同样出现了 finally 中的异常覆盖了 try 中异常的问题:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>Exception</span><span class="token operator">:</span> close error
at <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>geekbang<span class="token punctuation">.</span>time<span class="token punctuation">.</span>commonmistakes<span class="token punctuation">.</span>exception<span class="token punctuation">.</span>finallyissue<span class="token punctuation">.</span></span>TestResource</span><span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token class-name">TestResource</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">10</span><span class="token punctuation">)</span>
at <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>geekbang<span class="token punctuation">.</span>time<span class="token punctuation">.</span>commonmistakes<span class="token punctuation">.</span>exception<span class="token punctuation">.</span>finallyissue<span class="token punctuation">.</span></span>FinallyIssueController</span><span class="token punctuation">.</span><span class="token function">useresourcewrong</span><span class="token punctuation">(</span><span class="token class-name">FinallyIssueController</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">27</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>而改为 try-with-resources 模式之后:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;useresourceright&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">useresourceright</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">TestResource</span> testResource <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TestResource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        testResource<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>try 和 finally 中的异常信息都可以得到保留:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>Exception</span><span class="token operator">:</span> read error
at <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>geekbang<span class="token punctuation">.</span>time<span class="token punctuation">.</span>commonmistakes<span class="token punctuation">.</span>exception<span class="token punctuation">.</span>finallyissue<span class="token punctuation">.</span></span>TestResource</span><span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token class-name">TestResource</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">6</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token class-name">Suppressed</span><span class="token operator">:</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>Exception</span><span class="token operator">:</span> close error
at <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>geekbang<span class="token punctuation">.</span>time<span class="token punctuation">.</span>commonmistakes<span class="token punctuation">.</span>exception<span class="token punctuation">.</span>finallyissue<span class="token punctuation">.</span></span>TestResource</span><span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token class-name">TestResource</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">10</span><span class="token punctuation">)</span>
at <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>geekbang<span class="token punctuation">.</span>time<span class="token punctuation">.</span>commonmistakes<span class="token punctuation">.</span>exception<span class="token punctuation">.</span>finallyissue<span class="token punctuation">.</span></span>FinallyIssueController</span><span class="token punctuation">.</span><span class="token function">useresourceright</span><span class="token punctuation">(</span><span class="token class-name">FinallyIssueController</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">35</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token number">54</span> common frames omitted
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h5 id="千万别把异常定义为静态变量"><a href="#千万别把异常定义为静态变量" class="header-anchor">#</a> 千万别把异常定义为静态变量</h5> <p>既然通常会自定义一个业务异常类型, 来包含更多的异常信息, 比如异常错误码, 友好的错误提示等, 那就需要在业务逻辑各处, 手动抛出各种业务异常来返回指定的错误码描述(比如对于下单操作, 用户不存在返回 2001, 商品缺货返回 2002 等).</p> <p>对于这些异常的错误代码和消息, 我们期望能够统一管理, 而不是散落在程序各处定义. 这个想法很好, 但稍有不慎就可能会出现把异常定义为静态变量的坑.</p> <p>我在救火排查某项目生产问题时, 遇到了一件非常诡异的事情: 我发现异常堆信息显示的方法调用路径, 在当前入参的情况下根本不可能产生, 项目的业务逻辑又很复杂, 就始终没往异常信息是错的这方面想, 总觉得是因为某个分支流程导致业务没有按照期望的流程进行.</p> <p><strong>经过艰难的排查, 最终定位到原因是把异常定义为了静态变量, 导致异常栈信息错乱</strong>, 类似于定义一个 Exceptions 类来汇总所有的异常, 把异常存放在静态字段中:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Exceptions</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">BusinessException</span> <span class="token constant">ORDEREXISTS</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BusinessException</span><span class="token punctuation">(</span><span class="token string">&quot;订单已经存在&quot;</span><span class="token punctuation">,</span> <span class="token number">3001</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p><strong>把异常定义为静态变量会导致异常信息固化, 这就和异常的栈一定是需要根据当前调用来动态获取相矛盾</strong>.</p> <p>下面写段代码来模拟下这个问题: 定义两个方法 createOrderWrong 和 cancelOrderWrong 方法, 它们内部都会通过 Exceptions 类来获得一个订单不存在的异常; 先后调用两个方法, 然后抛出.</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;wrong&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">wrong</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token function">createOrderWrong</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;createOrder got error&quot;</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token function">cancelOrderWrong</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;cancelOrder got error&quot;</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">createOrderWrong</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 这里有问题</span>
    <span class="token keyword">throw</span> <span class="token class-name">Exceptions</span><span class="token punctuation">.</span><span class="token constant">ORDEREXISTS</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">cancelOrderWrong</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 这里有问题</span>
    <span class="token keyword">throw</span> <span class="token class-name">Exceptions</span><span class="token punctuation">.</span><span class="token constant">ORDEREXISTS</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><p>运行程序后看到如下日志, cancelOrder got error 的提示对应了 createOrderWrong 方法. 显然, cancelOrderWrong 方法在出错后抛出的异常, 其实是 createOrderWrong 方法出错的异常:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token punctuation">[</span><span class="token number">14</span><span class="token operator">:</span><span class="token number">05</span><span class="token operator">:</span><span class="token number">25.782</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>http<span class="token operator">-</span>nio<span class="token operator">-</span><span class="token number">45678</span><span class="token operator">-</span>exec<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token constant">ERROR</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token punctuation">.</span>c<span class="token punctuation">.</span>e<span class="token punctuation">.</span>d<span class="token punctuation">.</span>PredefinedExceptionController<span class="token operator">:</span><span class="token number">25</span>  <span class="token punctuation">]</span> <span class="token operator">-</span> cancelOrder got error
<span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>geekbang<span class="token punctuation">.</span>time<span class="token punctuation">.</span>commonmistakes<span class="token punctuation">.</span>exception<span class="token punctuation">.</span>demo2<span class="token punctuation">.</span></span>BusinessException</span><span class="token operator">:</span> 订单已经存在
at <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>geekbang<span class="token punctuation">.</span>time<span class="token punctuation">.</span>commonmistakes<span class="token punctuation">.</span>exception<span class="token punctuation">.</span>demo2<span class="token punctuation">.</span></span>Exceptions</span><span class="token punctuation">.</span><span class="token generics"><span class="token punctuation">&lt;</span>clinit<span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token class-name">Exceptions</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">5</span><span class="token punctuation">)</span>
at <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>geekbang<span class="token punctuation">.</span>time<span class="token punctuation">.</span>commonmistakes<span class="token punctuation">.</span>exception<span class="token punctuation">.</span>demo2<span class="token punctuation">.</span></span>PredefinedExceptionController</span><span class="token punctuation">.</span><span class="token function">createOrderWrong</span><span class="token punctuation">(</span><span class="token class-name">PredefinedExceptionController</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">50</span><span class="token punctuation">)</span>
at <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>geekbang<span class="token punctuation">.</span>time<span class="token punctuation">.</span>commonmistakes<span class="token punctuation">.</span>exception<span class="token punctuation">.</span>demo2<span class="token punctuation">.</span></span>PredefinedExceptionController</span><span class="token punctuation">.</span><span class="token function">wrong</span><span class="token punctuation">(</span><span class="token class-name">PredefinedExceptionController</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">18</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>修复方式很简单, 改一下 Exceptions 类的实现, 通过不同的方法把每一种异常都 new 出来抛出即可:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Exceptions</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">BusinessException</span> <span class="token function">orderExists</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">BusinessException</span><span class="token punctuation">(</span><span class="token string">&quot;订单已经存在&quot;</span><span class="token punctuation">,</span> <span class="token number">3001</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h5 id="提交线程池的任务出了异常会怎么样"><a href="#提交线程池的任务出了异常会怎么样" class="header-anchor">#</a> 提交线程池的任务出了异常会怎么样?</h5> <p>前面介绍线程池时提到, 线程池常用作异步处理或并行处理. 那么把任务提交到线程池处理, <strong>任务本身出现异常时会怎样</strong>呢?</p> <p>来看一个例子: 提交 10 个任务到线程池异步处理, 第 5 个任务抛出一个 RuntimeException, 每个任务完成后都会输出一行日志:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;execute&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
    <span class="token class-name">String</span> prefix <span class="token operator">=</span> <span class="token string">&quot;test&quot;</span><span class="token punctuation">;</span>
    <span class="token class-name">ExecutorService</span> threadPool <span class="token operator">=</span> <span class="token class-name">Executors</span><span class="token punctuation">.</span><span class="token function">newFixedThreadPool</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> 
            <span class="token keyword">new</span> <span class="token class-name">ThreadFactoryBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setNameFormat</span><span class="token punctuation">(</span>prefix <span class="token operator">+</span> <span class="token string">&quot;%d&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 提交10个任务到线程池处理, 第5个任务会抛出运行时异常</span>
    <span class="token class-name">IntStream</span><span class="token punctuation">.</span><span class="token function">rangeClosed</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>i <span class="token operator">-&gt;</span> threadPool<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">==</span> <span class="token number">5</span><span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;error&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;I'm done : {}&quot;</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    threadPool<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    threadPool<span class="token punctuation">.</span><span class="token function">awaitTermination</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">HOURS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>观察日志可以发现两点:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">[</span><span class="token number">14</span><span class="token operator">:</span><span class="token number">33</span><span class="token operator">:</span><span class="token number">55.990</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>test0<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token constant">INFO</span> <span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token class-name"><span class="token namespace">e<span class="token punctuation">.</span>d<span class="token punctuation">.</span></span>ThreadPoolAndExceptionController</span><span class="token operator">:</span><span class="token number">26</span>  <span class="token punctuation">]</span> <span class="token operator">-</span> <span class="token class-name">I</span>'m done <span class="token operator">:</span> <span class="token number">4</span>
<span class="token class-name">Exception</span> in thread <span class="token string">&quot;test0&quot;</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>RuntimeException</span><span class="token operator">:</span> error
at <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>geekbang<span class="token punctuation">.</span>time<span class="token punctuation">.</span>commonmistakes<span class="token punctuation">.</span>exception<span class="token punctuation">.</span>demo3<span class="token punctuation">.</span></span>ThreadPoolAndExceptionController</span><span class="token punctuation">.</span>lambda$<span class="token keyword">null</span>$<span class="token function">0</span><span class="token punctuation">(</span><span class="token class-name">ThreadPoolAndExceptionController</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">25</span><span class="token punctuation">)</span>
at <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span>ThreadPoolExecutor</span><span class="token punctuation">.</span><span class="token function">runWorker</span><span class="token punctuation">(</span><span class="token class-name">ThreadPoolExecutor</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">1149</span><span class="token punctuation">)</span>
at <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span>ThreadPoolExecutor</span>$<span class="token class-name">Worker</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">ThreadPoolExecutor</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">624</span><span class="token punctuation">)</span>
at <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>Thread</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">748</span><span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token number">14</span><span class="token operator">:</span><span class="token number">33</span><span class="token operator">:</span><span class="token number">55.990</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>test1<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token constant">INFO</span> <span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token class-name"><span class="token namespace">e<span class="token punctuation">.</span>d<span class="token punctuation">.</span></span>ThreadPoolAndExceptionController</span><span class="token operator">:</span><span class="token number">26</span>  <span class="token punctuation">]</span> <span class="token operator">-</span> <span class="token class-name">I</span>'m done <span class="token operator">:</span> <span class="token number">6</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><ol><li>任务 1 到 4 所在的线程是 test0, 任务 6 开始运行在线程 test1. 由于线程池通过线程工厂为线程使用统一的前缀 test 加上计数器进行命名, 因此<mark><strong>从线程名的改变可以知道因为异常的抛出老线程退出了, 线程池只能重新创建一个线程. 如果每个异步任务都以异常结束, 那么线程池可能完全起不到线程重用的作用</strong></mark>​.</li> <li>因为没有手动捕获异常进行处理, ThreadGroup 进行了未捕获异常的默认处理, 向标准错误输出打印了出现异常的线程名称和异常信息. <strong>显然这种没有以统一的错误日志格式记录错误信息打印出来的形式, 对生产级代码是不合适的</strong>, ThreadGroup 的相关源码如下所示:</li></ol> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">uncaughtException</span><span class="token punctuation">(</span><span class="token class-name">Thread</span> t<span class="token punctuation">,</span> <span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>parent <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        parent<span class="token punctuation">.</span><span class="token function">uncaughtException</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token class-name">Thread<span class="token punctuation">.</span>UncaughtExceptionHandler</span> ueh <span class="token operator">=</span>
            <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">getDefaultUncaughtExceptionHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ueh <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            ueh<span class="token punctuation">.</span><span class="token function">uncaughtException</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>e <span class="token keyword">instanceof</span> <span class="token class-name">ThreadDeath</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>err<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">&quot;Exception in thread \&quot;&quot;</span> <span class="token operator">+</span> t<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;\&quot; &quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>修复方式有 2 步:</p> <ul><li><strong>以 execute 方法提交到线程池的异步任务, 最好在任务内部做好异常处理;</strong></li> <li><strong>设置自定义的异常处理程序作为保底, 比如在声明线程池时自定义线程池的未捕获异常处理程序</strong>:</li></ul> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">new</span> <span class="token class-name">ThreadFactoryBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">setNameFormat</span><span class="token punctuation">(</span>prefix <span class="token operator">+</span> <span class="token string">&quot;%d&quot;</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">setUncaughtExceptionHandler</span><span class="token punctuation">(</span><span class="token punctuation">(</span>thread<span class="token punctuation">,</span> throwable<span class="token punctuation">)</span>
        <span class="token operator">-&gt;</span> log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;ThreadPool {} got exception&quot;</span><span class="token punctuation">,</span> thread<span class="token punctuation">,</span> throwable<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>或者<strong>设置全局的默认未捕获异常处理程序</strong>:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">static</span> <span class="token punctuation">{</span>
    <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">setDefaultUncaughtExceptionHandler</span><span class="token punctuation">(</span><span class="token punctuation">(</span>thread<span class="token punctuation">,</span> throwable<span class="token punctuation">)</span>
        <span class="token operator">-&gt;</span> log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;Thread {} got exception&quot;</span><span class="token punctuation">,</span> thread<span class="token punctuation">,</span> throwable<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>通过线程池 ExecutorService 的 execute 方法提交任务到线程池处理, 如果出现异常会导致线程退出, 控制台输出中可以看到异常信息. 那么把 execute 方法改为 submit, 线程还会退出吗, 异常还能被处理程序捕获到吗?</p> <p>**修改代码后重新执行程序可以看到如下日志, 说明线程没退出, 异常也没记录被生吞了: **</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token punctuation">[</span><span class="token number">15</span><span class="token operator">:</span><span class="token number">44</span><span class="token operator">:</span><span class="token number">33.769</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>test0<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token constant">INFO</span> <span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token class-name"><span class="token namespace">e<span class="token punctuation">.</span>d<span class="token punctuation">.</span></span>ThreadPoolAndExceptionController</span><span class="token operator">:</span><span class="token number">47</span>  <span class="token punctuation">]</span> <span class="token operator">-</span> <span class="token class-name">I</span>'m done <span class="token operator">:</span> <span class="token number">1</span>
<span class="token punctuation">[</span><span class="token number">15</span><span class="token operator">:</span><span class="token number">44</span><span class="token operator">:</span><span class="token number">33.770</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>test0<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token constant">INFO</span> <span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token class-name"><span class="token namespace">e<span class="token punctuation">.</span>d<span class="token punctuation">.</span></span>ThreadPoolAndExceptionController</span><span class="token operator">:</span><span class="token number">47</span>  <span class="token punctuation">]</span> <span class="token operator">-</span> <span class="token class-name">I</span>'m done <span class="token operator">:</span> <span class="token number">2</span>
<span class="token punctuation">[</span><span class="token number">15</span><span class="token operator">:</span><span class="token number">44</span><span class="token operator">:</span><span class="token number">33.770</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>test0<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token constant">INFO</span> <span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token class-name"><span class="token namespace">e<span class="token punctuation">.</span>d<span class="token punctuation">.</span></span>ThreadPoolAndExceptionController</span><span class="token operator">:</span><span class="token number">47</span>  <span class="token punctuation">]</span> <span class="token operator">-</span> <span class="token class-name">I</span>'m done <span class="token operator">:</span> <span class="token number">3</span>
<span class="token punctuation">[</span><span class="token number">15</span><span class="token operator">:</span><span class="token number">44</span><span class="token operator">:</span><span class="token number">33.770</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>test0<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token constant">INFO</span> <span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token class-name"><span class="token namespace">e<span class="token punctuation">.</span>d<span class="token punctuation">.</span></span>ThreadPoolAndExceptionController</span><span class="token operator">:</span><span class="token number">47</span>  <span class="token punctuation">]</span> <span class="token operator">-</span> <span class="token class-name">I</span>'m done <span class="token operator">:</span> <span class="token number">4</span>
<span class="token punctuation">[</span><span class="token number">15</span><span class="token operator">:</span><span class="token number">44</span><span class="token operator">:</span><span class="token number">33.770</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>test0<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token constant">INFO</span> <span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token class-name"><span class="token namespace">e<span class="token punctuation">.</span>d<span class="token punctuation">.</span></span>ThreadPoolAndExceptionController</span><span class="token operator">:</span><span class="token number">47</span>  <span class="token punctuation">]</span> <span class="token operator">-</span> <span class="token class-name">I</span>'m done <span class="token operator">:</span> <span class="token number">6</span>
<span class="token punctuation">[</span><span class="token number">15</span><span class="token operator">:</span><span class="token number">44</span><span class="token operator">:</span><span class="token number">33.770</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>test0<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token constant">INFO</span> <span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token class-name"><span class="token namespace">e<span class="token punctuation">.</span>d<span class="token punctuation">.</span></span>ThreadPoolAndExceptionController</span><span class="token operator">:</span><span class="token number">47</span>  <span class="token punctuation">]</span> <span class="token operator">-</span> <span class="token class-name">I</span>'m done <span class="token operator">:</span> <span class="token number">7</span>
<span class="token punctuation">[</span><span class="token number">15</span><span class="token operator">:</span><span class="token number">44</span><span class="token operator">:</span><span class="token number">33.770</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>test0<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token constant">INFO</span> <span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token class-name"><span class="token namespace">e<span class="token punctuation">.</span>d<span class="token punctuation">.</span></span>ThreadPoolAndExceptionController</span><span class="token operator">:</span><span class="token number">47</span>  <span class="token punctuation">]</span> <span class="token operator">-</span> <span class="token class-name">I</span>'m done <span class="token operator">:</span> <span class="token number">8</span>
<span class="token punctuation">[</span><span class="token number">15</span><span class="token operator">:</span><span class="token number">44</span><span class="token operator">:</span><span class="token number">33.771</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>test0<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token constant">INFO</span> <span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token class-name"><span class="token namespace">e<span class="token punctuation">.</span>d<span class="token punctuation">.</span></span>ThreadPoolAndExceptionController</span><span class="token operator">:</span><span class="token number">47</span>  <span class="token punctuation">]</span> <span class="token operator">-</span> <span class="token class-name">I</span>'m done <span class="token operator">:</span> <span class="token number">9</span>
<span class="token punctuation">[</span><span class="token number">15</span><span class="token operator">:</span><span class="token number">44</span><span class="token operator">:</span><span class="token number">33.771</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>test0<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token constant">INFO</span> <span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token class-name"><span class="token namespace">e<span class="token punctuation">.</span>d<span class="token punctuation">.</span></span>ThreadPoolAndExceptionController</span><span class="token operator">:</span><span class="token number">47</span>  <span class="token punctuation">]</span> <span class="token operator">-</span> <span class="token class-name">I</span>'m done <span class="token operator">:</span> <span class="token number">10</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>为什么会这样呢?</p> <p>查看 FutureTask 源码可以发现, 在执行任务出现异常之后, 异常存到了一个 outcome 字段中, 只有在调用 get 方法获取 FutureTask 结果的时候, 才会以 ExecutionException 的形式重新抛出异常:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token class-name">Callable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> c <span class="token operator">=</span> callable<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>c <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> state <span class="token operator">==</span> <span class="token constant">NEW</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">V</span> result<span class="token punctuation">;</span>
            <span class="token keyword">boolean</span> ran<span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                result <span class="token operator">=</span> c<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                ran <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                result <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                ran <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                <span class="token function">setException</span><span class="token punctuation">(</span>ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
    <span class="token comment">// ...</span>
<span class="token punctuation">}</span>

<span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">setException</span><span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">UNSAFE</span><span class="token punctuation">.</span><span class="token function">compareAndSwapInt</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> stateOffset<span class="token punctuation">,</span> <span class="token constant">NEW</span><span class="token punctuation">,</span> <span class="token constant">COMPLETING</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        outcome <span class="token operator">=</span> t<span class="token punctuation">;</span>
        <span class="token constant">UNSAFE</span><span class="token punctuation">.</span><span class="token function">putOrderedInt</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> stateOffset<span class="token punctuation">,</span> <span class="token constant">EXCEPTIONAL</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// final state</span>
        <span class="token function">finishCompletion</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token class-name">V</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span><span class="token punctuation">,</span> <span class="token class-name">ExecutionException</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> s <span class="token operator">=</span> state<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>s <span class="token operator">&lt;=</span> <span class="token constant">COMPLETING</span><span class="token punctuation">)</span>
        s <span class="token operator">=</span> <span class="token function">awaitDone</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token number">0L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">report</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token class-name">V</span> <span class="token function">report</span><span class="token punctuation">(</span><span class="token keyword">int</span> s<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ExecutionException</span> <span class="token punctuation">{</span>
    <span class="token class-name">Object</span> x <span class="token operator">=</span> outcome<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>s <span class="token operator">==</span> <span class="token constant">NORMAL</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">V</span><span class="token punctuation">)</span>x<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>s <span class="token operator">&gt;=</span> <span class="token constant">CANCELLED</span><span class="token punctuation">)</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">CancellationException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ExecutionException</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">Throwable</span><span class="token punctuation">)</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br></div></div><p>修改后的代码如下所示, 把 submit 返回的 Future 放到了 List 中, 随后遍历 List 来捕获所有任务的异常. 这么做确实合乎情理. 既然是以 submit 方式来提交任务, 那么应该关心任务的执行结果, 否则应该以 execute 来提交任务:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Future</span><span class="token punctuation">&gt;</span></span> tasks <span class="token operator">=</span> <span class="token class-name">IntStream</span><span class="token punctuation">.</span><span class="token function">rangeClosed</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">mapToObj</span><span class="token punctuation">(</span>i <span class="token operator">-&gt;</span> threadPool<span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">==</span> <span class="token number">5</span><span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;error&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;I'm done : {}&quot;</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

tasks<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>task<span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        task<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;Got exception&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>执行这段程序可以看到如下的日志输出:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token punctuation">[</span><span class="token number">15</span><span class="token operator">:</span><span class="token number">44</span><span class="token operator">:</span><span class="token number">13.543</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>http<span class="token operator">-</span>nio<span class="token operator">-</span><span class="token number">45678</span><span class="token operator">-</span>exec<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token constant">ERROR</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token class-name"><span class="token namespace">e<span class="token punctuation">.</span>d<span class="token punctuation">.</span></span>ThreadPoolAndExceptionController</span><span class="token operator">:</span><span class="token number">69</span>  <span class="token punctuation">]</span> <span class="token operator">-</span> <span class="token class-name">Got</span> exception
<span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span>ExecutionException</span><span class="token operator">:</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>RuntimeException</span><span class="token operator">:</span> error
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h5 id="重点回顾-12"><a href="#重点回顾-12" class="header-anchor">#</a> 重点回顾</h5> <p>今天介绍了处理异常容易犯的几个错和最佳实践.</p> <p>第一, 注意捕获和处理异常的最佳实践. 首先不应该用 AOP 对所有方法进行统一异常处理, 异常要么不捕获不处理, 要么根据不同的业务逻辑, 不同的异常类型进行精细化, 针对性处理; 其次, 处理异常应该杜绝生吞, 并确保异常栈信息得到保留; 最后, 如果需要重新抛出异常的话, 请使用具有意义的异常类型和异常消息.</p> <p>第二, 务必小心 finally 代码块中资源回收逻辑, 确保 finally 代码块不出现异常, 内部把异常处理完毕, 避免 finally 中的异常覆盖 try 中的异常; 或者考虑使用 addSuppressed 方法把 finally 中的异常附加到 try 中的异常上, 确保主异常信息不丢失. 此外, 使用实现了 AutoCloseable 接口的资源, 务必使用 try-with-resources 模式来使用资源, 确保资源可以正确释放, 也同时确保异常可以正确处理.</p> <p>第三, 虽然在统一的地方定义收口所有的业务异常是一个不错的实践, 但务必确保异常是每次 new 出来的, 而不能使用一个预先定义的 static 字段存放异常, 否则可能会引起栈信息的错乱.</p> <p>第四, <strong>确保正确处理了线程池中任务的异常, 如果任务通过 execute 提交, 那么出现异常会导致线程退出, 大量的异常会导致线程重复创建引起性能问题</strong>, 应该尽可能确保任务不出异常, 同时设置默认的未捕获异常处理程序来兜底; 如果任务通过 submit 提交意味着我们关心任务的执行结果, 应该通过拿到的 Future 调用其 get 方法来获得任务运行结果和可能出现的异常, 否则异常可能就被生吞了.</p> <h4 id="_13-日志-日志记录真没你想象的那么简单"><a href="#_13-日志-日志记录真没你想象的那么简单" class="header-anchor">#</a> 13-日志:日志记录真没你想象的那么简单</h4> <p>今天分享的是<strong>记录日志可能会踩的坑</strong>.</p> <p>一些同学可能要说了, 记录日志还不简单, 无非是几个常用的 API 方法, 比如 debug, info, warn, error; 但我就见过不少坑都是记录日志引起的, <strong>容易出错主要在于三个方面</strong>:</p> <ol><li>日志框架众多, 不同的类库可能会使用不同的日志框架, 如何兼容是一个问题.</li> <li><strong>配置复杂且容易出错</strong>. 日志配置文件通常很复杂, 因此有些开发同学会从其他项目或者网络上复制一份配置文件, 但却不知道如何修改, 甚至是胡乱修改, 造成很多问题. 比如重复记录日志的问题, 同步日志的性能问题, 异步记录的错误配置问题.</li> <li>日志记录本身就有些误区, 比如没考虑到日志内容获取的代价, 胡乱使用日志级别等.</li></ol> <p>Logback, Log4j, Log4j2, commons-logging, JDK 自带的 java.util.logging 等, 都是 Java 体系的日志框架, 确实非常多. 而不同的类库, 还可能选择使用不同的日志框架. 这样一来, 日志的统一管理就变得非常困难. 为了解决这个问题, 就有了 <strong>SLF4J</strong>(Simple Logging Facade For Java), 如下图所示:</p> <p><img src="/img/000d113b085db9e512619d355e36b716-20230731165210-gadxnq9.png" alt=""></p> <p>SLF4J 实现了三种功能:</p> <ol><li>一是提供了统一的<strong>日志门面 API</strong>, 即图中紫色部分, 实现了中立的日志记录 API.</li> <li>二是<strong>桥接功能</strong>, 即图中蓝色部分, 用来把各种日志框架的 API(图中绿色部分)桥接到 SLF4J API. 这样一来, 即便程序中使用了各种日志 API 记录日志, 最终都可以桥接到 SLF4J 门面 API.</li> <li>三是<strong>适配功能</strong>, 即图中红色部分, 可以实现 SLF4J API 和实际日志框架(图中灰色部分)的绑定. SLF4J 只是日志标准, 还是需要一个实际的日志框架. 日志框架本身没有实现 SLF4J API, 所以需要有一个前置转换. <strong>Logback 就是按照 SLF4J API 标准实现的, 因此不需要绑定模块做转换</strong>.</li></ol> <p>需要理清楚的是, 虽然可以使用 log4j-over-slf4j 来实现 Log4j 桥接到 SLF4J, 也可以使用 slf4j-log4j12 实现 SLF4J 适配到 Log4j, 也把它们画到了一列, <strong>但是它不能同时使用它们, 否则就会产生死循环. jcl 和 jul 也是同样的道理.</strong></p> <p>虽然图中有 4 个灰色的日志实现框架, 但我看到的业务系统使用最广泛的是 <strong>Logback 和 Log4j</strong>, 它们是同一人开发的. Logback 可以认为是 Log4j 的改进版本, 更推荐使用. 所以, 关于日志框架配置的案例, 都会围绕 <strong>Logback</strong> 展开.</p> <p>Spring Boot 是目前最流行的 Java 框架, 它的日志框架也用的是 Logback. 那为什么没有手动引入 Logback 的包, 就可以直接使用 Logback 了呢?</p> <p>查看 Spring Boot 的 Maven 依赖树, 可以发现 spring-boot-starter 模块依赖了 spring-boot-starter-logging 模块, 而 spring-boot-starter-logging 模块又自动引入了 logback-classic(包含了 SLF4J 和 Logback 日志框架)和 SLF4J 的一些适配器. 其中, log4j-to-slf4j 用于实现 Log4j2 API 到 SLF4J 的桥接, jul-to-slf4j 则是实现 java.util.logging API 到 SLF4J 的桥接:</p> <p><img src="/img/ce2a28af389880f9b8ae970464649cd5-20230731165210-o33ms0r.png" alt=""></p> <p>接下来就用几个实际的案例说说<strong>日志配置和记录这两大问题</strong>, 顺便以 Logback 为例复习一下常见的日志配置.</p> <h5 id="为什么我的日志会重复记录"><a href="#为什么我的日志会重复记录" class="header-anchor">#</a> 为什么我的日志会重复记录?</h5> <p>日志重复记录在业务上非常常见, 不但给查看日志和统计工作带来不必要的麻烦, 还会增加磁盘和日志收集系统的负担. 接下来分享<strong>两个重复记录</strong>的案例, 同时帮助梳理 Logback 配置的基本结构.</p> <p><strong>第一个案例是, logger 配置继承关系导致日志重复记录</strong>. 首先, 定义一个方法实现 debug, info, warn 和 error 四种日志的记录:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Log4j2</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">&quot;logging&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@RestController</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LoggingController</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;log&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">log</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;debug&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;info&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;warn&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;error&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>然后, 使用下面的 Logback 配置:</p> <ol><li>第 11 和 12 行设置了<strong>全局的日志级别为 INFO, 日志输出使用 CONSOLE Appender</strong>.</li> <li>第 3 到 7 行, 首先将 CONSOLE Appender 定义为 <strong>ConsoleAppender</strong>, 也就是把日志输出到控制台<code>(System.out/System.err)</code>​; 然后通过 PatternLayout 定义了日志的输出格式. 关于格式化字符串的各种使用方式, 可以进一步查阅官方文档.</li> <li>第 8 到 10 行实现了一个 Logger 配置, 将应用包的日志级别设置为 DEBUG, 日志输出同样使用 CONSOLE Appender.</li></ol> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token prolog">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>configuration</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>appender</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>CONSOLE<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>ch.qos.logback.core.ConsoleAppender<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>layout</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>ch.qos.logback.classic.PatternLayout<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>pattern</span><span class="token punctuation">&gt;</span></span>[%d{yyyy-MM-dd HH:mm:ss.SSS}] [%thread] [%-5level] [%logger{40}:%line] - %msg%n<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>pattern</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>layout</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>appender</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>logger</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>org.geekbang.time.commonmistakes.logging<span class="token punctuation">&quot;</span></span> <span class="token attr-name">level</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>DEBUG<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>appender-ref</span> <span class="token attr-name">ref</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>CONSOLE<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>logger</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>root</span> <span class="token attr-name">level</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>INFO<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>appender-ref</span> <span class="token attr-name">ref</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>CONSOLE<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>root</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>configuration</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>这段配置看起来没啥问题, 但执行方法后出现了<strong>日志重复记录</strong>的问题:</p> <p><img src="/img/d294be8b28d934b459582fa39104ee37-20230731165210-7qotmcz.png" alt=""></p> <p>从配置文件的第 9 和 12 行可以看到, CONSOLE 这个 <strong>Appender 同时挂载到了两个 Logger 上</strong>, 一个是我们定义的, 一个是由于我们定义的继承自自定义的 logger, <strong>所以同一条日志既会通过 logger 记录, 也会发送到 root 记录, 因此应用 package 下的日志出现了重复记录.</strong></p> <p>后来我了解到, 这个同学如此配置的初衷是实现自定义的 logger 配置, 让应用内的日志暂时开启 DEBUG 级别的日志记录. 其实, <strong>他完全不需要重复挂载 Appender, 去掉下挂载的 Appender 即可</strong>:</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>logger</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>org.geekbang.time.commonmistakes.logging<span class="token punctuation">&quot;</span></span> <span class="token attr-name">level</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>DEBUG<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>如果自定义的需要把日志输出到不同的 Appender, 比如将应用的日志输出到文件 app.log, 把其他框架的日志输出到控制台, 可以<strong>设置的 additivity 属性为 false</strong>, 这样就不会继承的 Appender 了:</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token prolog">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>configuration</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>appender</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>FILE<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>ch.qos.logback.core.FileAppender<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>file</span><span class="token punctuation">&gt;</span></span>app.log<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>file</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>encoder</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>ch.qos.logback.classic.encoder.PatternLayoutEncoder<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>pattern</span><span class="token punctuation">&gt;</span></span>[%d{yyyy-MM-dd HH:mm:ss.SSS}] [%thread] [%-5level] [%logger{40}:%line] - %msg%n<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>pattern</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>encoder</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>appender</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>appender</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>CONSOLE<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>ch.qos.logback.core.ConsoleAppender<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>layout</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>ch.qos.logback.classic.PatternLayout<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>pattern</span><span class="token punctuation">&gt;</span></span>[%d{yyyy-MM-dd HH:mm:ss.SSS}] [%thread] [%-5level] [%logger{40}:%line] - %msg%n<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>pattern</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>layout</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>appender</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>logger</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>org.geekbang.time.commonmistakes.logging<span class="token punctuation">&quot;</span></span> <span class="token attr-name">level</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>DEBUG<span class="token punctuation">&quot;</span></span> <span class="token attr-name">additivity</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>false<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>appender-ref</span> <span class="token attr-name">ref</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>FILE<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>logger</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>root</span> <span class="token attr-name">level</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>INFO<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>appender-ref</span> <span class="token attr-name">ref</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>CONSOLE<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>root</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>configuration</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><p>**第二个案例是, 错误配置 LevelFilter 造成日志重复记录. **</p> <p>一般互联网公司都会使用 ELK 三件套来统一收集日志, 有一次我们发现 Kibana 上展示的日志有部分重复, 一直怀疑是 Logstash 配置错误, 但最后发现还是 Logback 的配置错误引起的.</p> <p>这个项目的日志是这样配置的: <strong>在记录日志到控制台的同时, 把日志记录按照不同的级别记录到两个文件</strong>中:</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token prolog">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>configuration</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>logDir<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>./logs<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>app.name<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>common-mistakes<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>appender</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>CONSOLE<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>ch.qos.logback.core.ConsoleAppender<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>layout</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>ch.qos.logback.classic.PatternLayout<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
         <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>pattern</span><span class="token punctuation">&gt;</span></span>[%d{yyyy-MM-dd HH:mm:ss.SSS}] [%thread] [%-5level] [%logger{40}:%line] - %msg%n<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>pattern</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>layout</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>appender</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>appender</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>INFO_FILE<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>ch.qos.logback.core.FileAppender<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>File</span><span class="token punctuation">&gt;</span></span>${logDir}/${app.name}_info.log<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>File</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>filter</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>ch.qos.logback.classic.filter.LevelFilter<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
         <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>level</span><span class="token punctuation">&gt;</span></span>INFO<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>level</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>filter</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>encoder</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>ch.qos.logback.classic.encoder.PatternLayoutEncoder<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
         <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>pattern</span><span class="token punctuation">&gt;</span></span>[%d{yyyy-MM-dd HH:mm:ss.SSS}] [%thread] [%-5level] [%logger{40}:%line] - %msg%n<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>pattern</span><span class="token punctuation">&gt;</span></span>
         <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>charset</span><span class="token punctuation">&gt;</span></span>UTF-8<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>charset</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>encoder</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>appender</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>appender</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>ERROR_FILE<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>ch.qos.logback.core.FileAppender<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>File</span><span class="token punctuation">&gt;</span></span>${logDir}/${app.name}_error.log<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>File</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>filter</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>ch.qos.logback.classic.filter.ThresholdFilter<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
         <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>level</span><span class="token punctuation">&gt;</span></span>WARN<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>level</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>filter</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>encoder</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>ch.qos.logback.classic.encoder.PatternLayoutEncoder<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
         <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>pattern</span><span class="token punctuation">&gt;</span></span>[%d{yyyy-MM-dd HH:mm:ss.SSS}] [%thread] [%-5level] [%logger{40}:%line] - %msg%n<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>pattern</span><span class="token punctuation">&gt;</span></span>
         <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>charset</span><span class="token punctuation">&gt;</span></span>UTF-8<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>charset</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>encoder</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>appender</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>root</span> <span class="token attr-name">level</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>INFO<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>appender-ref</span> <span class="token attr-name">ref</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>CONSOLE<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>appender-ref</span> <span class="token attr-name">ref</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>INFO_FILE<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>appender-ref</span> <span class="token attr-name">ref</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>ERROR_FILE<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>root</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>configuration</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br></div></div><p>这个配置文件比较长, 一段一段地看:</p> <ol><li>第 31 到 35 行定义的 <strong>root 引用了三个 Appender</strong>.</li> <li>第 5 到 9 行是第一个 <strong>ConsoleAppender</strong>, 用于把所有日志输出到控制台.</li> <li>第 10 到 19 行定义了一个 <strong>FileAppender</strong>, 用于记录文件日志, 并定义了文件名, 记录日志的格式和编码等信息. 最关键的是, 第 12 到 14 行定义的 <strong>LevelFilter 过滤日志, 将过滤级别设置为 INFO, 目的是希望 _info.log 文件中可以记录 INFO 级别的日志</strong>.</li> <li>第 20 到 30 行定义了一个类似的 FileAppender, 并使用 ThresholdFilter 来过滤日志, 过滤级别设置为 WARN, 目的是把 WARN 以上级别的日志记录到另一个 _error.log 文件中.</li></ol> <p>运行一下测试程序:</p> <p><img src="/img/5f2c1f203eba52d5fcd9b7c966cd7165-20230731165210-yhkbjzz.png" alt=""></p> <p>可以看到, _info.log 中包含了 INFO, WARN 和 ERROR 三个级别的日志, 不符合我们的预期; error.log 包含了 WARN 和 ERROR 两个级别的日志. 因此造成了日志的重复收集.</p> <p>你可能会问, 这么明显的日志重复为什么没有及时发现? 一些公司使用自动化的 ELK 方案收集日志, 日志会同时输出到控制台和文件, 开发人员在本机测试时不太会关心文件中记录的日志, 而在测试和生产环境又因为开发人员没有服务器访问权限, 所以原始日志文件中的重复问题并不容易发现.</p> <p>为了分析日志重复的原因, 下面来复习一下 <strong>ThresholdFilter 和 LevelFilter</strong> 的配置方式.</p> <p>分析 ThresholdFilter 的源码发现, <strong>当日志级别大于等于配置的级别时返回 NEUTRAL, 继续调用过滤器链上的下一个过滤器; 否则, 返回 DENY 直接拒绝记录日志</strong>:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ThresholdFilter</span> <span class="token keyword">extends</span> <span class="token class-name">Filter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ILoggingEvent</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token class-name">FilterReply</span> <span class="token function">decide</span><span class="token punctuation">(</span><span class="token class-name">ILoggingEvent</span> event<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isStarted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token class-name">FilterReply</span><span class="token punctuation">.</span><span class="token constant">NEUTRAL</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
  
        <span class="token keyword">if</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span><span class="token function">getLevel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isGreaterOrEqual</span><span class="token punctuation">(</span>level<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token class-name">FilterReply</span><span class="token punctuation">.</span><span class="token constant">NEUTRAL</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token class-name">FilterReply</span><span class="token punctuation">.</span><span class="token constant">DENY</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>在这个案例中, 把 ThresholdFilter 设置为 WARN, <strong>可以记录 WARN 和 ERROR 级别的日志</strong>.</p> <p>LevelFilter 用来比较日志级别, 然后进行相应处理: 如果匹配就调用 onMatch 定义的处理方式, 默认是交给下一个过滤器处理(AbstractMatcherFilter 基类中定义的默认值); 否则, 调用 onMismatch 定义的处理方式, 默认也是交给下一个过滤器处理.</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LevelFilter</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractMatcherFilter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ILoggingEvent</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token class-name">FilterReply</span> <span class="token function">decide</span><span class="token punctuation">(</span><span class="token class-name">ILoggingEvent</span> event<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isStarted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token class-name">FilterReply</span><span class="token punctuation">.</span><span class="token constant">NEUTRAL</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span><span class="token function">getLevel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>level<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> onMatch<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> onMismatch<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">AbstractMatcherFilter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">extends</span> <span class="token class-name">Filter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
    <span class="token keyword">protected</span> <span class="token class-name">FilterReply</span> onMatch <span class="token operator">=</span> <span class="token class-name">FilterReply</span><span class="token punctuation">.</span><span class="token constant">NEUTRAL</span><span class="token punctuation">;</span>
    <span class="token keyword">protected</span> <span class="token class-name">FilterReply</span> onMismatch <span class="token operator">=</span> <span class="token class-name">FilterReply</span><span class="token punctuation">.</span><span class="token constant">NEUTRAL</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>和 ThresholdFilter 不同的是, LevelFilter 仅仅配置 level 是无法真正起作用的. **由于没有配置 onMatch 和 onMismatch 属性, 所以相当于这个过滤器是无用的, 导致 INFO 以上级别的日志都记录了. **</p> <p>定位到问题后, 修改方式就很明显了: <strong>配置 LevelFilter 的 onMatch 属性为 ACCEPT, 表示接收 INFO 级别的日志; 配置 onMismatch 属性为 DENY, 表示除了 INFO 级别都不记录</strong>:</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>appender</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>INFO_FILE<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>ch.qos.logback.core.FileAppender<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>File</span><span class="token punctuation">&gt;</span></span>${logDir}/${app.name}_info.log<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>File</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>filter</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>ch.qos.logback.classic.filter.LevelFilter<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>level</span><span class="token punctuation">&gt;</span></span>INFO<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>level</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>onMatch</span><span class="token punctuation">&gt;</span></span>ACCEPT<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>onMatch</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>onMismatch</span><span class="token punctuation">&gt;</span></span>DENY<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>onMismatch</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>filter</span><span class="token punctuation">&gt;</span></span>
  ...
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>appender</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>这样修改后, _info.log 文件中只会有 INFO 级别的日志, 不会出现日志重复的问题了.</p> <h5 id="使用异步日志改善性能的坑"><a href="#使用异步日志改善性能的坑" class="header-anchor">#</a> 使用异步日志改善性能的坑</h5> <p>掌握了把日志输出到文件中的方法后, 接下来面临的问题是, 如何<strong>避免日志记录成为应用的性能瓶颈</strong>. 这可以帮助解决, 磁盘(比如机械磁盘)IO 性能较差, 日志量又很大的情况下, 如何记录日志的问题.</p> <p>先来测试一下, 记录日志的性能问题, 定义如下的日志配置, 一共有两个 Appender:</p> <ol><li>FILE 是一个 FileAppender, 用于记录所有的日志;</li> <li>CONSOLE 是一个 ConsoleAppender, 用于记录带有 time 标记的日志.</li></ol> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token prolog">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>configuration</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>appender</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>FILE<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>ch.qos.logback.core.FileAppender<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>file</span><span class="token punctuation">&gt;</span></span>app.log<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>file</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>encoder</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>ch.qos.logback.classic.encoder.PatternLayoutEncoder<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>pattern</span><span class="token punctuation">&gt;</span></span>[%d{yyyy-MM-dd HH:mm:ss.SSS}] [%thread] [%-5level] [%logger{40}:%line] - %msg%n<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>pattern</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>encoder</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>appender</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>appender</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>CONSOLE<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>ch.qos.logback.core.ConsoleAppender<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>layout</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>ch.qos.logback.classic.PatternLayout<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>pattern</span><span class="token punctuation">&gt;</span></span>[%d{yyyy-MM-dd HH:mm:ss.SSS}] [%thread] [%-5level] [%logger{40}:%line] - %msg%n<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>pattern</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>layout</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>filter</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>ch.qos.logback.core.filter.EvaluatorFilter<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>evaluator</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>ch.qos.logback.classic.boolex.OnMarkerEvaluator<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>marker</span><span class="token punctuation">&gt;</span></span>time<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>marker</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>evaluator</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>onMismatch</span><span class="token punctuation">&gt;</span></span>DENY<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>onMismatch</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>onMatch</span><span class="token punctuation">&gt;</span></span>ACCEPT<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>onMatch</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>filter</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>appender</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>root</span> <span class="token attr-name">level</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>INFO<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>appender-ref</span> <span class="token attr-name">ref</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>FILE<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>appender-ref</span> <span class="token attr-name">ref</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>CONSOLE<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>root</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>configuration</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><p>不知道你有没有注意到, 这段代码中有个 <strong>EvaluatorFilter</strong>(求值过滤器), 用于判断日志是否符合某个条件.</p> <p>在后续的测试代码中, 会把大量日志输出到文件中, 日志文件会非常大, 如果性能测试结果也混在其中的话, 就很难找到那条日志. 所以这里使用 EvaluatorFilter 对日志按照标记进行过滤, 并将过滤出的日志单独输出到控制台上. 在这个案例中, 给输出测试结果的那条日志上做了 time 标记.</p> <p><strong>配合使用标记和 EvaluatorFilter, 实现日志的按标签过滤, 是一个不错的小技巧</strong>.</p> <p>如下测试代码中, 实现了记录指定次数的大日志, 每条日志包含 1MB 字节的模拟数据, 最后记录一条以 time 为标记的方法执行耗时日志:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;performance&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">performance</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;count&quot;</span><span class="token punctuation">,</span> defaultValue <span class="token operator">=</span> <span class="token string">&quot;1000&quot;</span><span class="token punctuation">)</span> <span class="token keyword">int</span> count<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">long</span> begin <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> payload <span class="token operator">=</span> <span class="token class-name">IntStream</span><span class="token punctuation">.</span><span class="token function">rangeClosed</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1000000</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">mapToObj</span><span class="token punctuation">(</span>__ <span class="token operator">-&gt;</span> <span class="token string">&quot;a&quot;</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">joining</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token constant">UUID</span><span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">IntStream</span><span class="token punctuation">.</span><span class="token function">rangeClosed</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>i <span class="token operator">-&gt;</span> log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;{} {}&quot;</span><span class="token punctuation">,</span> i<span class="token punctuation">,</span> payload<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Marker</span> timeMarker <span class="token operator">=</span> <span class="token class-name">MarkerFactory</span><span class="token punctuation">.</span><span class="token function">getMarker</span><span class="token punctuation">(</span><span class="token string">&quot;time&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span>timeMarker<span class="token punctuation">,</span> <span class="token string">&quot;took {} ms&quot;</span><span class="token punctuation">,</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> begin<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>执行程序后可以看到, 记录 1000 次日志和 10000 次日志的调用耗时, 分别是 6.3 秒和 44.5 秒:</p> <p>​<img src="/img/4628a1eb89bc6705457be4b80b356e83-20230731165210-r7c5y54.png" alt="">​</p> <p>对于只记录文件日志的代码了来说, 这个耗时挺长的. 为了分析其中原因, 需要分析下 FileAppender 的源码.</p> <p>FileAppender 继承自 OutputStreamAppender, 查看 OutputStreamAppender 源码的第 30 到 33 行发现, <strong>在追加日志的时候, 是直接把日志写入 OutputStream 中, 属于</strong>​<mark><strong>同步记录日志</strong></mark>​ <strong>:</strong></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OutputStreamAppender</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">extends</span> <span class="token class-name">UnsynchronizedAppenderBase</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token class-name">OutputStream</span> outputStream<span class="token punctuation">;</span>
    <span class="token keyword">boolean</span> immediateFlush <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">append</span><span class="token punctuation">(</span><span class="token class-name">E</span> eventObject<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isStarted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">subAppend</span><span class="token punctuation">(</span>eventObject<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">subAppend</span><span class="token punctuation">(</span><span class="token class-name">E</span> event<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isStarted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">// 编码LoggingEvent</span>
            <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> byteArray <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>encoder<span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 写字节流</span>
            <span class="token function">writeBytes</span><span class="token punctuation">(</span>byteArray<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> ioe<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// ...</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">writeBytes</span><span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> byteArray<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>byteArray <span class="token generics"><span class="token punctuation">&lt;</span>mark<span class="token punctuation">&gt;</span></span> <span class="token keyword">null</span> <span class="token operator">||</span> byteArray<span class="token punctuation">.</span>length <span class="token operator">&lt;</span><span class="token operator">/</span>mark<span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>

        lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">// 这个OutputStream其实是一个ResilientFileOutputStream</span>
            <span class="token comment">// 其内部使用的是带缓冲的BufferedOutputStream</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>outputStream<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>byteArray<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>immediateFlush<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>outputStream<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 刷入OS</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br></div></div><p>分析到这里, 就明白为什么日志大量写入时会耗时这么久了. 那有没有办法实现大量日志写入时, 不会过多影响业务逻辑执行耗时, 影响吞吐量呢?</p> <p>办法当然有了, <strong>使用 Logback 提供的 AsyncAppender 即可实现异步的日志记录</strong>. AsyncAppende 类似装饰模式, 也就是在不改变类原有基本功能的情况下为其增添新功能. 这样就可以把 AsyncAppender 附加在其他的 Appender 上, 将其变为异步的.</p> <p>定义一个<strong>异步 Appender ASYNCFILE, 包装之前的同步文件日志记录的 FileAppender</strong>, 就可以实现异步记录日志到文件:</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>appender</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>ASYNCFILE<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>ch.qos.logback.classic.AsyncAppender<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>appender-ref</span> <span class="token attr-name">ref</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>FILE<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>appender</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>root</span> <span class="token attr-name">level</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>INFO<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>appender-ref</span> <span class="token attr-name">ref</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>ASYNCFILE<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>appender-ref</span> <span class="token attr-name">ref</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>CONSOLE<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>root</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>测试一下可以发现, 记录 1000 次日志和 10000 次日志的调用耗时, 分别是 735 毫秒和 668 毫秒:</p> <p><img src="/img/c5009cfc82ee56bdf69f8e72eee4df5c-20230731165210-xsy2411.png" alt=""></p> <p>性能居然这么好, 你觉得其中有什么问题吗? 异步日志真的如此神奇和万能吗? 当然不是, 因为这样并没有记录下所有日志. **我之前就遇到过很多关于 AsyncAppender 异步日志的坑, 这些坑可以归结为三类: **</p> <ol><li><strong>记录异步日志撑爆内存;</strong></li> <li><strong>记录异步日志出现日志丢失;</strong></li> <li><strong>记录异步日志出现阻塞.</strong></li></ol> <p>为了解释这三种坑, 来模拟一个慢日志记录场景: 首先, 自定义一个继承自 ConsoleAppender 的 MySlowAppender, 作为记录到控制台的输出器, <strong>写入日志时休眠 1 秒</strong>.</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MySlowAppender</span> <span class="token keyword">extends</span> <span class="token class-name">ConsoleAppender</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">subAppend</span><span class="token punctuation">(</span><span class="token class-name">Object</span> event<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">// 模拟慢日志</span>
            <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">MILLISECONDS</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">subAppend</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>然后, 在配置文件中使用 AsyncAppender, 将 MySlowAppender 包装为异步日志记录:</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token prolog">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>configuration</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>appender</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>CONSOLE<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>org.geekbang.time.commonmistakes.logging.async.MySlowAppender<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>layout</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>ch.qos.logback.classic.PatternLayout<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>pattern</span><span class="token punctuation">&gt;</span></span>[%d{yyyy-MM-dd HH:mm:ss.SSS}] [%thread] [%-5level] [%logger{40}:%line] - %msg%n<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>pattern</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>layout</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>appender</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>appender</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>ASYNC<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>ch.qos.logback.classic.AsyncAppender<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>appender-ref</span> <span class="token attr-name">ref</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>CONSOLE<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>appender</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>root</span> <span class="token attr-name">level</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>INFO<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>appender-ref</span> <span class="token attr-name">ref</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>ASYNC<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>root</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>configuration</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>定义一段测试代码, 循环记录一定次数的日志, 最后输出方法执行耗时:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;manylog&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">manylog</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;count&quot;</span><span class="token punctuation">,</span> defaultValue <span class="token operator">=</span> <span class="token string">&quot;1000&quot;</span><span class="token punctuation">)</span> <span class="token keyword">int</span> count<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">long</span> begin <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">IntStream</span><span class="token punctuation">.</span><span class="token function">rangeClosed</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>i <span class="token operator">-&gt;</span> log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;log-{}&quot;</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;took &quot;</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> begin<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; ms&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>执行方法后发现, 耗时很短但出现了<strong>日志丢失</strong>: 要记录 1000 条日志, 最终控制台只能搜索到 215 条日志, 而且日志的行号变为了一个问号.</p> <p><img src="/img/5b1f2dbf3268f56073ed76579af56bc4-20230731165210-czwtqcp.png" alt=""></p> <p>出现这个问题的原因在于, AsyncAppender 提供了一些配置参数, 而我们没用对. 结合相关源码分析一下:</p> <ol><li><strong>includeCallerData 用于控制是否收集调用方数据</strong>, 默认是 false, 此时方法行号, 方法名等信息将不能显示(源码第 2 行以及 7 到 11 行).</li> <li><strong>queueSize 用于控制阻塞队列大小</strong>, 使用的 ArrayBlockingQueue 阻塞队列(源码第 15 到 17 行), 默认大小是 256, 即内存中最多保存 256 条日志.</li> <li><strong>discardingThreshold 是控制丢弃日志的阈值, 主要是防止队列满后阻塞</strong>. 默认情况下, 队列剩余量低于队列长度的 20%, 就会丢弃 TRACE, DEBUG 和 INFO 级别的日志. (参见源码第 3 到 6 行, 18 到 19 行, 26 到 27 行, 33 到 34 行, 40 到 42 行)</li> <li><strong>neverBlock 用于控制队列满的时候, 加入的数据是否直接丢弃, 不会阻塞等待</strong>, 默认是 false(源码第 44 到 68 行). 这里需要注意一下 offer 方法和 put 方法的区别, 当队列满的时候 offer 方法不阻塞, 而 put 方法会阻塞; neverBlock 为 true 时, 使用 offer 方法.</li></ol> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AsyncAppender</span> <span class="token keyword">extends</span> <span class="token class-name">AsyncAppenderBase</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ILoggingEvent</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>

    <span class="token keyword">boolean</span> includeCallerData <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>  <span class="token comment">// 是否收集调用方数据</span>

    <span class="token keyword">protected</span> <span class="token keyword">boolean</span> <span class="token function">isDiscardable</span><span class="token punctuation">(</span><span class="token class-name">ILoggingEvent</span> event<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Level</span> level <span class="token operator">=</span> event<span class="token punctuation">.</span><span class="token function">getLevel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> level<span class="token punctuation">.</span><span class="token function">toInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token class-name">Level</span><span class="token punctuation">.</span><span class="token constant">INFO_INT</span><span class="token punctuation">;</span>  <span class="token comment">// 丢弃&lt;=INFO级别的日志</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">preprocess</span><span class="token punctuation">(</span><span class="token class-name">ILoggingEvent</span> eventObject<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        eventObject<span class="token punctuation">.</span><span class="token function">prepareForDeferredProcessing</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>includeCallerData<span class="token punctuation">)</span>
            eventObject<span class="token punctuation">.</span><span class="token function">getCallerData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AsyncAppenderBase</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">extends</span> <span class="token class-name">UnsynchronizedAppenderBase</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span> 
            <span class="token keyword">implements</span> <span class="token class-name">AppenderAttachable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>

    <span class="token class-name">BlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span> blockingQueue<span class="token punctuation">;</span>  <span class="token comment">// 异步日志的关键, 阻塞队列</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">DEFAULT_QUEUE_SIZE</span> <span class="token operator">=</span> <span class="token number">256</span><span class="token punctuation">;</span>  <span class="token comment">// 默认队列大小</span>
    <span class="token keyword">int</span> queueSize <span class="token operator">=</span> <span class="token constant">DEFAULT_QUEUE_SIZE</span><span class="token punctuation">;</span>
    <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">UNDEFINED</span> <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> discardingThreshold <span class="token operator">=</span> <span class="token constant">UNDEFINED</span><span class="token punctuation">;</span>
    <span class="token keyword">boolean</span> neverBlock <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>  <span class="token comment">// 控制队列满的时候加入数据时是否直接丢弃, 不会阻塞等待</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        blockingQueue <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayBlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>queueSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>discardingThreshold <span class="token operator">==</span> <span class="token constant">UNDEFINED</span><span class="token punctuation">)</span>
            <span class="token comment">// 默认丢弃阈值是队列剩余量低于队列长度的20%, 参见isQueueBelowDiscardingThreshold方法</span>
            discardingThreshold <span class="token operator">=</span> queueSize <span class="token operator">/</span> <span class="token number">5</span><span class="token punctuation">;</span>  
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">append</span><span class="token punctuation">(</span><span class="token class-name">E</span> eventObject<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 判断是否可以丢数据</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isQueueBelowDiscardingThreshold</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isDiscardable</span><span class="token punctuation">(</span>eventObject<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">preprocess</span><span class="token punctuation">(</span>eventObject<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">put</span><span class="token punctuation">(</span>eventObject<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">isQueueBelowDiscardingThreshold</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span>blockingQueue<span class="token punctuation">.</span><span class="token function">remainingCapacity</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> discardingThreshold<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">E</span> eventObject<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>neverBlock<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 根据neverBlock决定使用不阻塞的offer还是阻塞的put方法</span>
            blockingQueue<span class="token punctuation">.</span><span class="token function">offer</span><span class="token punctuation">(</span>eventObject<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token function">putUninterruptibly</span><span class="token punctuation">(</span>eventObject<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 以阻塞方式添加数据到队列</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">putUninterruptibly</span><span class="token punctuation">(</span><span class="token class-name">E</span> eventObject<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">boolean</span> interrupted <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    blockingQueue<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>eventObject<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    interrupted <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>interrupted<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">interrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br></div></div><p>看到默认队列大小为 256, <strong>达到 80% 容量后开始丢弃 &lt;=INFO 级别的日志后</strong>, 这样就可以理解日志中为什么只有 215 条 INFO 日志了.</p> <p>可以继续分析下异步记录日志出现坑的原因.</p> <ol><li><strong>queueSize 设置得特别大, 就可能会导致 OOM</strong>.</li> <li>queueSize 设置得比较小(默认值就非常小), 且 discardingThreshold 设置为大于 0 的值(或者为默认值), 队列剩余容量少于 discardingThreshold 的配置就会丢弃 &lt;=INFO 的日志. 这里的坑点有两个. 一是, 因为 discardingThreshold 的存在, 设置 queueSize 时容易踩坑. 比如, 本例中最大日志并发是 1000, 即便设置 queueSize 为 1000 同样会导致日志丢失. 二是 discardingThreshold 参数容易有歧义, 它不是百分比, 而是日志条数. 对于总容量 10000 的队列, 如果希望队列剩余容量少于 1000 条的时候丢弃, 需要配置为 1000.</li> <li>neverBlock 默认为 false, 意味着总可能会出现<strong>阻塞</strong>. 如果 discardingThreshold 为 0, 那么队列满时再有日志写入就会阻塞; 如果 discardingThreshold 不为 0, 也只会丢弃 &lt;=INFO 级别的日志, 那么出现大量错误日志时, 还是会阻塞程序.</li></ol> <p>可以看出 queueSize, discardingThreshold 和 neverBlock 这三个参数息息相关, 务必按需进行设置和取舍, 到底是性能为先, 还是数据不丢为先:</p> <ol><li><strong>如果考虑绝对性能为先, 那就设置 neverBlock 为 true, 永不阻塞.</strong></li> <li><strong>如果考虑绝对不丢数据为先, 那就设置 discardingThreshold 为 0</strong>, 即使是 &lt;=INFO 的级别日志也不会丢, 但最好把 queueSize 设置大一点, 毕竟默认的 queueSize 显然太小, 太容易阻塞.</li> <li><strong>如果希望兼顾两者, 可以丢弃不重要的日志, 把 queueSize 设置大一点, 再设置一个合理的 discardingThreshold</strong>.</li></ol> <p>以上就是日志配置最常见的两个误区了. 接下来再看一个日志记录本身的误区.</p> <h5 id="使用日志占位符就不需要进行日志级别判断了"><a href="#使用日志占位符就不需要进行日志级别判断了" class="header-anchor">#</a> 使用日志占位符就不需要进行日志级别判断了?</h5> <p>不知道你有没有听人说过: SLF4J 的 <code>{}</code>​ 占位符语法, 到真正记录日志时才会获取实际参数, 因此解决了日志数据获取的性能问题. 你觉得, 这种说法对吗?</p> <p>为了验证这个问题, 写一段测试代码: 有一个 slowString 方法, 返回结果耗时 1 秒:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token class-name">String</span> <span class="token function">slowString</span><span class="token punctuation">(</span><span class="token class-name">String</span> s<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;slowString called via &quot;</span> <span class="token operator">+</span> s<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token string">&quot;OK&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>如果记录 DEBUG 日志, 并设置只记录 &gt;=INFO 级别的日志, 程序是否也会耗时 1 秒呢? 下面使用三种方法来测试:</p> <ol><li><strong>拼接字符串</strong>方式记录 slowString;</li> <li><strong>使用占位符</strong>方式记录 slowString;</li> <li>先判断日志级别是否启用 DEBUG.</li></ol> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">StopWatch</span> stopWatch <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StopWatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
stopWatch<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token string">&quot;debug1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;debug1:&quot;</span> <span class="token operator">+</span> <span class="token function">slowString</span><span class="token punctuation">(</span><span class="token string">&quot;debug1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
stopWatch<span class="token punctuation">.</span><span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

stopWatch<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token string">&quot;debug2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;debug2:{}&quot;</span><span class="token punctuation">,</span> <span class="token function">slowString</span><span class="token punctuation">(</span><span class="token string">&quot;debug2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
stopWatch<span class="token punctuation">.</span><span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

stopWatch<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token string">&quot;debug3&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>log<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;debug3:{}&quot;</span><span class="token punctuation">,</span> <span class="token function">slowString</span><span class="token punctuation">(</span><span class="token string">&quot;debug3&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
stopWatch<span class="token punctuation">.</span><span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>可以看到, 前两种方式都调用了 slowString 方法, 所以耗时都是 1 秒:</p> <p>​<img src="/img/142760f5cecac759f8be825510d5f258-20230731165210-x8m60oa.png" alt="">​</p> <p>使用占位符方式记录 slowString 的方式, 同样需要耗时 1 秒, 是因为这种方式虽然允许传入 Object, 不用拼接字符串, 但也只是<strong>延迟</strong>(如果日志不记录那么就是省去)了日志参数对象 <code>.toString()</code>​ 和字符串拼接的耗时.</p> <p>在这个案例中, 除非事先判断日志级别, 否则必然会调用 slowString 方法. <strong>回到之前提的问题, 使用 {} 占位符语法不能通过延迟参数值获取, 来解决日志数据获取的性能问题.</strong></p> <p>除了事先判断日志级别, 还可以通过 lambda 表达式进行延迟参数内容获取. 但 SLF4J 的 API 还不支持 lambda, 因此需要使用 Log4j2 日志 API, 把 Lombok 的 @Slf4j 注解替换为 @Log4j2 注解, 这样就可以提供一个 lambda 表达式作为提供参数数据的方法:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Log4j2</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LoggingController</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
    log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;debug4:{}&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token function">slowString</span><span class="token punctuation">(</span><span class="token string">&quot;debug4&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>像这样调用 debug 方法, 签名是 <code>Supplier&lt;?&gt;</code>​, <strong>参数会延迟到真正需要记录日志时再获取</strong>:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">void</span> <span class="token function">debug</span><span class="token punctuation">(</span><span class="token class-name">String</span> message<span class="token punctuation">,</span> <span class="token class-name">Supplier</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> paramSuppliers<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">logIfEnabled</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">String</span> fqcn<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">Level</span> level<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">Marker</span> marker<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">String</span> message<span class="token punctuation">,</span>
        <span class="token keyword">final</span> <span class="token class-name">Supplier</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> paramSuppliers<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isEnabled</span><span class="token punctuation">(</span>level<span class="token punctuation">,</span> marker<span class="token punctuation">,</span> message<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">logMessage</span><span class="token punctuation">(</span>fqcn<span class="token punctuation">,</span> level<span class="token punctuation">,</span> marker<span class="token punctuation">,</span> message<span class="token punctuation">,</span> paramSuppliers<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">logMessage</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">String</span> fqcn<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">Level</span> level<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">Marker</span> marker<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">String</span> message<span class="token punctuation">,</span>
        <span class="token keyword">final</span> <span class="token class-name">Supplier</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> paramSuppliers<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">final</span> <span class="token class-name">Message</span> msg <span class="token operator">=</span> messageFactory<span class="token punctuation">.</span><span class="token function">newMessage</span><span class="token punctuation">(</span>message<span class="token punctuation">,</span> <span class="token class-name">LambdaUtil</span><span class="token punctuation">.</span><span class="token function">getAll</span><span class="token punctuation">(</span>paramSuppliers<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">logMessageSafely</span><span class="token punctuation">(</span>fqcn<span class="token punctuation">,</span> level<span class="token punctuation">,</span> marker<span class="token punctuation">,</span> msg<span class="token punctuation">,</span> msg<span class="token punctuation">.</span><span class="token function">getThrowable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>修改后再次运行测试, 可以看到这次 debug4 <strong>并不会调用 slowString 方法</strong>:</p> <p>​<img src="/img/e88d925486ee6eebd77ebc461434b5b9-20230731165210-r3pmtu8.png" alt="">​</p> <p>其实, 只是换成了 Log4j2 API, 真正的日志记录还是走的 Logback 框架. 没错这就是 SLF4J 适配的一个好处.</p> <h5 id="重点回顾-13"><a href="#重点回顾-13" class="header-anchor">#</a> 重点回顾</h5> <p>我将记录日志的坑, 总结为框架<strong>使用配置和记录本身</strong>两个方面.</p> <p>Java 的日志框架众多, SLF4J 实现了这些框架记录日志的统一. 在使用 SLF4J 时, 需要理清楚其桥接 API 和绑定这两个模块. 如果程序启动时出现 SLF4J 的错误提示, 那很可能是配置出现了问题, 可以使用 Maven 的 dependency:tree 命令梳理依赖关系.</p> <p>Logback 是 Java 最常用的日志框架, 其配置比较复杂, <strong>可以参考官方文档中关于 Appender, Layout, Filter 的配置, 切记不要随意从其他地方复制别人的配置, 避免出现错误或与当前需求不符</strong>.</p> <p><strong>使用异步日志解决性能问题, 是用空间换时间</strong>. 但空间毕竟有限, 当空间满了之后, 要考虑是阻塞等待, 还是丢弃日志. 如果更希望不丢弃重要日志, 那么选择阻塞等待; 如果更希望程序不要因为日志记录而阻塞, 那么就需要丢弃日志.</p> <p>最后强调的是, <strong>日志框架提供的参数化日志记录方式不能完全取代日志级别的判断</strong>. 如果日志量很大, 获取日志参数代价也很大, 就要进行相应日志级别的判断, 避免不记录日志也要花费时间获取日志参数的问题.</p> <h4 id="_14-文件io-实现高效正确的文件读写并非易事"><a href="#_14-文件io-实现高效正确的文件读写并非易事" class="header-anchor">#</a> 14-文件IO:实现高效正确的文件读写并非易事</h4> <p>今天来聊聊如何实现高效, 正确的文件操作.</p> <p>随着数据库系统的成熟和普及, 需要直接做文件 IO 操作的需求越来越少, 这就导致大家对相关 API 不够熟悉, 以至于遇到类似文件导出, 三方文件对账等需求时, 只能临时抱佛脚, 随意搜索一些代码完成需求, 出现性能问题或者 Bug 后不知从何处入手.</p> <p>今天就会从<strong>字符编码, 缓冲区和文件句柄释放</strong>这 3 个常见问题出发, 分享如何解决与文件操作相关的性能问题或者 Bug.</p> <h5 id="文件读写需要确保字符编码一致"><a href="#文件读写需要确保字符编码一致" class="header-anchor">#</a> 文件读写需要确保字符编码一致</h5> <p>有一个项目需要读取三方的对账文件定时对账, 原先一直是单机处理的, 没什么问题. 后来为了提升性能, 使用双节点同时处理对账, 每一个节点处理部分对账数据, 但新增的节点在处理文件中中文的时候总是读取到乱码.</p> <p>程序代码都是一致的, 为什么老节点就不会有问题呢? 我们知道, 这很可能是写代码时没有注意<strong>编码问题</strong>导致的. 接下来就分析下这个问题.</p> <p>为模拟这个场景, 使用 GBK 编码把 &quot;你好 hi&quot; 写入一个名为 hello.txt 的文本文件, 然后直接以字节数组形式读取文件内容, 转换为十六进制字符串输出到日志中:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">Files</span><span class="token punctuation">.</span><span class="token function">deleteIfExists</span><span class="token punctuation">(</span><span class="token class-name">Paths</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;hello.txt&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Files</span><span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token class-name">Paths</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;hello.txt&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;你好hi&quot;</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token class-name">Charset</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span><span class="token string">&quot;GBK&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;bytes:{}&quot;</span><span class="token punctuation">,</span> <span class="token class-name">Hex</span><span class="token punctuation">.</span><span class="token function">encodeHexString</span><span class="token punctuation">(</span><span class="token class-name">Files</span><span class="token punctuation">.</span><span class="token function">readAllBytes</span><span class="token punctuation">(</span><span class="token class-name">Paths</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;hello.txt&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>输出如下:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token number">13</span><span class="token operator">:</span><span class="token number">06</span><span class="token operator">:</span><span class="token number">28.955</span> <span class="token punctuation">[</span>main<span class="token punctuation">]</span> <span class="token constant">INFO</span> <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>geekbang<span class="token punctuation">.</span>time<span class="token punctuation">.</span>commonmistakes<span class="token punctuation">.</span>io<span class="token punctuation">.</span>demo3<span class="token punctuation">.</span></span>FileBadEncodingIssueApplication</span> <span class="token operator">-</span> bytes<span class="token operator">:</span><span class="token constant">C4E3BAC36869</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>虽然打开文本文件时看到的是 &quot;你好 hi&quot;, 但不管是什么文字, 计算机中都是按照一定的规则将其以二进制保存的. 这个规则就是<strong>字符集</strong>, 字符集枚举了所有支持的字符映射成二进制的映射表. 在处理文件读写的时候, 如果是在字节层面进行操作, 那么不会涉及字符编码问题; 而如果需要在字符层面进行读写的话, 就需要明确字符的编码方式也就是字符集了.</p> <p>当时出现问题的文件读取代码是这样的:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">char</span><span class="token punctuation">[</span><span class="token punctuation">]</span> chars <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">char</span><span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token class-name">String</span> content <span class="token operator">=</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">FileReader</span> fileReader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileReader</span><span class="token punctuation">(</span><span class="token string">&quot;hello.txt&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> count<span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>count <span class="token operator">=</span> fileReader<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>chars<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        content <span class="token operator">+=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>chars<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;result:{}&quot;</span><span class="token punctuation">,</span> content<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>可以看到, 是使用了 FileReader 类以<strong>字符方式</strong>进行文件读取, 日志中读取出来的 &quot;你好&quot; 变为了乱码:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token number">13</span><span class="token operator">:</span><span class="token number">06</span><span class="token operator">:</span><span class="token number">28.961</span> <span class="token punctuation">[</span>main<span class="token punctuation">]</span> <span class="token constant">INFO</span> <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>geekbang<span class="token punctuation">.</span>time<span class="token punctuation">.</span>commonmistakes<span class="token punctuation">.</span>io<span class="token punctuation">.</span>demo3<span class="token punctuation">.</span></span>FileBadEncodingIssueApplication</span> <span class="token operator">-</span> result<span class="token operator">:</span>���hi
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>显然, 这里并没有指定以什么字符集来读取文件中的字符. 查看 JDK 文档可以发现, <strong>FileReader 是以当前机器的默认字符集来读取文件的</strong>, 如果希望指定字符集的话, 需要直接使用 InputStreamReader 和 FileInputStream.</p> <p>到这里就明白了, FileReader 虽然方便但因为<strong>使用了默认字符集对环境产生了依赖</strong>, 这就是为什么老的机器上程序可以正常运作, 在新节点上读取中文时却产生了乱码.</p> <p>那怎么确定当前机器的默认字符集呢? 写一段代码输出当前机器的默认字符集, 以及 UTF-8 方式编码的 &quot;你好 hi&quot; 的十六进制字符串:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;charset: {}&quot;</span><span class="token punctuation">,</span> <span class="token class-name">Charset</span><span class="token punctuation">.</span><span class="token function">defaultCharset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Files</span><span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token class-name">Paths</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;hello2.txt&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;你好hi&quot;</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token class-name">Charsets</span><span class="token punctuation">.</span><span class="token constant">UTF_8</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;bytes:{}&quot;</span><span class="token punctuation">,</span> <span class="token class-name">Hex</span><span class="token punctuation">.</span><span class="token function">encodeHexString</span><span class="token punctuation">(</span><span class="token class-name">Files</span><span class="token punctuation">.</span><span class="token function">readAllBytes</span><span class="token punctuation">(</span><span class="token class-name">Paths</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;hello2.txt&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>toUpperCa
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>输出结果如下:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token number">13</span><span class="token operator">:</span><span class="token number">06</span><span class="token operator">:</span><span class="token number">28.961</span> <span class="token punctuation">[</span>main<span class="token punctuation">]</span> <span class="token constant">INFO</span> <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>geekbang<span class="token punctuation">.</span>time<span class="token punctuation">.</span>commonmistakes<span class="token punctuation">.</span>io<span class="token punctuation">.</span>demo3<span class="token punctuation">.</span></span>FileBadEncodingIssueApplication</span> <span class="token operator">-</span> charset<span class="token operator">:</span> <span class="token constant">UTF</span><span class="token operator">-</span><span class="token number">8</span>
<span class="token number">13</span><span class="token operator">:</span><span class="token number">06</span><span class="token operator">:</span><span class="token number">28.962</span> <span class="token punctuation">[</span>main<span class="token punctuation">]</span> <span class="token constant">INFO</span> <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>geekbang<span class="token punctuation">.</span>time<span class="token punctuation">.</span>commonmistakes<span class="token punctuation">.</span>io<span class="token punctuation">.</span>demo3<span class="token punctuation">.</span></span>FileBadEncodingIssueApplication</span> <span class="token operator">-</span> bytes<span class="token operator">:</span><span class="token constant">E4BDA0E5A5BD6869</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>可以看到, 当前机器默认字符集是 UTF-8, 当然无法读取 GBK 编码的汉字. UTF-8 编码的 &quot;你好&quot; 的十六进制是 E4BDA0E5A5BD, 每一个汉字需要三个字节; 而 GBK 编码的汉字, 每一个汉字两个字节. 字节长度都不一样, 以 GBK 编码后保存的汉字, 以 UTF8 进行解码读取, 必然不会成功.</p> <p>定位到问题后, 修复就很简单了. 按照文档所说, 直接使用 FileInputStream 拿文件流, 然后使用 InputStreamReader 读取字符流, 并指定字符集为 GBK:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">right1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
    <span class="token keyword">char</span><span class="token punctuation">[</span><span class="token punctuation">]</span> chars <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">char</span><span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> content <span class="token operator">=</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">FileInputStream</span> fileInputStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileInputStream</span><span class="token punctuation">(</span><span class="token string">&quot;hello.txt&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">InputStreamReader</span> inputStreamReader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">InputStreamReader</span><span class="token punctuation">(</span>fileInputStream<span class="token punctuation">,</span>
                 <span class="token class-name">Charset</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span><span class="token string">&quot;GBK&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> count<span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>count <span class="token operator">=</span> inputStreamReader<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>chars<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            content <span class="token operator">+=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>chars<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;result: {}&quot;</span><span class="token punctuation">,</span> content<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>从日志中看到, 修复后的代码正确读取到了 &quot;你好 Hi&quot;.</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token number">13</span><span class="token operator">:</span><span class="token number">06</span><span class="token operator">:</span><span class="token number">28.963</span> <span class="token punctuation">[</span>main<span class="token punctuation">]</span> <span class="token constant">INFO</span> <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>geekbang<span class="token punctuation">.</span>time<span class="token punctuation">.</span>commonmistakes<span class="token punctuation">.</span>io<span class="token punctuation">.</span>demo3<span class="token punctuation">.</span></span>FileBadEncodingIssueApplication</span> <span class="token operator">-</span> result<span class="token operator">:</span> 你好hi
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>如果你觉得这种方式比较麻烦的话, 使用 JDK1.7 推出的 Files 类的 readAllLines 方法, 可以很方便地用一行代码完成文件内容读取:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;result: {}&quot;</span><span class="token punctuation">,</span> <span class="token class-name">Files</span><span class="token punctuation">.</span><span class="token function">readAllLines</span><span class="token punctuation">(</span><span class="token class-name">Paths</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;hello.txt&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Charset</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span><span class="token string">&quot;GBK&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">findFirst</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">orElse</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><strong>但这种方式有个问题是, 读取超出内存大小的大文件时会出现 OOM</strong>. 为什么呢?</p> <p>打开 readAllLines 方法的源码可以看到, readAllLines 读取文件所有内容后, 放到一个 <code>List&lt;String&gt;</code>​ 中返回, 如果内存无法容纳这个 List, 就会 OOM:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token function">readAllLines</span><span class="token punctuation">(</span><span class="token class-name">Path</span> path<span class="token punctuation">,</span> <span class="token class-name">Charset</span> cs<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">BufferedReader</span> reader <span class="token operator">=</span> <span class="token function">newBufferedReader</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> cs<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">String</span> line <span class="token operator">=</span> reader<span class="token punctuation">.</span><span class="token function">readLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>line <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            result<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>line<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>那有没有办法实现按需的流式读取呢? 比如需要消费某行数据时再读取, 而不是把整个文件一次性读取到内存?</p> <p>当然有, 解决方案就是 <strong>File 类的 lines 方法</strong>. 接下来, 就说说使用 lines 方法时需要注意的一些问题.</p> <h5 id="使用files类静态方法进行文件操作注意释放文件句柄"><a href="#使用files类静态方法进行文件操作注意释放文件句柄" class="header-anchor">#</a> 使用Files类静态方法进行文件操作注意释放文件句柄</h5> <p>与 readAllLines 方法返回 <code>List&lt;String&gt;</code>​ 不同, lines 方法返回的是 <code>Stream&lt;String&gt;</code>​. 这使得我们在需要时<strong>可以不断读取, 使用文件中的内容, 而不是一次性地把所有内容都读取到内存中, 因此避免了 OOM</strong>.</p> <p>接下来通过一段代码测试一下. 尝试读取一个 1 亿 1 万行的文件, 文件占用磁盘空间超过 4GB. 如果使用 <code>-Xmx512m -Xms512m</code>​ 启动 JVM 控制最大堆内存为 512M 的话, 肯定无法一次性读取这样的大文件, 但通过 Files.lines 方法就没问题.</p> <p>在下面的代码中, 首先输出这个文件的大小, 然后计算读取 20 万行数据和 200 万行数据的耗时差异, 最后逐行读取文件, 统计文件的总行数:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// 输出文件大小</span>
log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;file size:{}&quot;</span><span class="token punctuation">,</span> <span class="token class-name">Files</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token class-name">Paths</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;test.txt&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">StopWatch</span> stopWatch <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StopWatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
stopWatch<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token string">&quot;read 200000 lines&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 使用Files.lines方法读取20万行数据</span>
log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;lines {}&quot;</span><span class="token punctuation">,</span> <span class="token class-name">Files</span><span class="token punctuation">.</span><span class="token function">lines</span><span class="token punctuation">(</span><span class="token class-name">Paths</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;test.txt&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">limit</span><span class="token punctuation">(</span><span class="token number">200000</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
stopWatch<span class="token punctuation">.</span><span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
stopWatch<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token string">&quot;read 2000000 lines&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 使用Files.lines方法读取200万行数据</span>
log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;lines {}&quot;</span><span class="token punctuation">,</span> <span class="token class-name">Files</span><span class="token punctuation">.</span><span class="token function">lines</span><span class="token punctuation">(</span><span class="token class-name">Paths</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;test.txt&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">limit</span><span class="token punctuation">(</span><span class="token number">2000000</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
stopWatch<span class="token punctuation">.</span><span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span>stopWatch<span class="token punctuation">.</span><span class="token function">prettyPrint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">AtomicLong</span> atomicLong <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicLong</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 使用Files.lines方法统计文件总行数</span>
<span class="token class-name">Files</span><span class="token punctuation">.</span><span class="token function">lines</span><span class="token punctuation">(</span><span class="token class-name">Paths</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;test.txt&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>line<span class="token operator">-&gt;</span>atomicLong<span class="token punctuation">.</span><span class="token function">incrementAndGet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;total lines {}&quot;</span><span class="token punctuation">,</span> atomicLong<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p>输出结果如下:</p> <p><img src="/img/2fd09a66fbdc5631a69377f6e8ee02e8-20230731165210-0c5cyui.png" alt=""></p> <p>可以看到, 实现了全文件的读取, 统计了整个文件的行数, 并没有出现 OOM; 读取 200 万行数据耗时 760ms, 读取 20 万行数据仅需 267ms. 这些都可以说明, File.lines 方法并不是一次性读取整个文件的, 而是按需读取.</p> <p>到这里, 你觉得这段代码有什么问题吗?</p> <p>问题在于读取完文件后没有关闭. 通常会认为静态方法的调用不涉及资源释放, 因为方法调用结束自然代表资源使用完成, 由 API 释放资源, 但对于 Files 类的一些返回 Stream 的方法并不是这样. 这是一个很容易被忽略的严重问题.</p> <p>我就曾遇到过一个案例: 程序在生产上运行一段时间后就会出现 <strong>too many files</strong> 的错误, 我们想当然地认为是 OS 设置的最大文件句柄太小了, 就让运维放开这个限制, 但放开后还是会出现这样的问题. 经排查发现, <strong>其实是文件句柄没有释放导致的, 问题就出在 Files.lines 方法上</strong>.</p> <p>来重现一下这个问题, 随便写入 10 行数据到一个 demo.txt 文件中:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">Files</span><span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token class-name">Paths</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;demo.txt&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token class-name">IntStream</span><span class="token punctuation">.</span><span class="token function">rangeClosed</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span>
         <span class="token punctuation">.</span><span class="token function">mapToObj</span><span class="token punctuation">(</span>i <span class="token operator">-&gt;</span> <span class="token constant">UUID</span><span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
         <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant">UTF_8</span><span class="token punctuation">,</span> <span class="token constant">CREATE</span><span class="token punctuation">,</span> <span class="token constant">TRUNCATE_EXISTING</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>然后使用 Files.lines 方法读取这个文件 100 万次, 每读取一行计数器 +1:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">LongAdder</span> longAdder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LongAdder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">IntStream</span><span class="token punctuation">.</span><span class="token function">rangeClosed</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1000000</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>i <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token class-name">Files</span><span class="token punctuation">.</span><span class="token function">lines</span><span class="token punctuation">(</span><span class="token class-name">Paths</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;demo.txt&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>line <span class="token operator">-&gt;</span> longAdder<span class="token punctuation">.</span><span class="token function">increment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;total : {}&quot;</span><span class="token punctuation">,</span> longAdder<span class="token punctuation">.</span><span class="token function">longValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>运行后马上可以在日志中看到如下错误:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>nio<span class="token punctuation">.</span>file<span class="token punctuation">.</span></span>FileSystemException</span><span class="token operator">:</span> demo<span class="token punctuation">.</span>txt<span class="token operator">:</span> <span class="token class-name">Too</span> many <span class="token keyword">open</span> <span class="token namespace">files</span>
at <span class="token class-name"><span class="token namespace">sun<span class="token punctuation">.</span>nio<span class="token punctuation">.</span>fs<span class="token punctuation">.</span></span>UnixException</span><span class="token punctuation">.</span><span class="token function">translateToIOException</span><span class="token punctuation">(</span><span class="token class-name">UnixException</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">91</span><span class="token punctuation">)</span>
at <span class="token class-name"><span class="token namespace">sun<span class="token punctuation">.</span>nio<span class="token punctuation">.</span>fs<span class="token punctuation">.</span></span>UnixException</span><span class="token punctuation">.</span><span class="token function">rethrowAsIOException</span><span class="token punctuation">(</span><span class="token class-name">UnixException</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">102</span><span class="token punctuation">)</span>
at <span class="token class-name"><span class="token namespace">sun<span class="token punctuation">.</span>nio<span class="token punctuation">.</span>fs<span class="token punctuation">.</span></span>UnixException</span><span class="token punctuation">.</span><span class="token function">rethrowAsIOException</span><span class="token punctuation">(</span><span class="token class-name">UnixException</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">107</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>使用 lsof 命令查看进程打开的文件, 可以看到打开了 1 万多个 demo.txt:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>lsof <span class="token operator">-</span>p <span class="token number">63937</span>
<span class="token comment">// ...</span>
java    <span class="token number">63902</span> zhuye <span class="token operator">*</span><span class="token number">238</span>r   <span class="token class-name">REG</span>                <span class="token number">1</span><span class="token punctuation">,</span><span class="token number">4</span>      <span class="token number">370</span>         <span class="token number">12934160647</span> <span class="token operator">/</span><span class="token class-name">Users</span><span class="token operator">/</span>zhuye<span class="token operator">/</span><span class="token class-name">Documents</span><span class="token operator">/</span>common<span class="token operator">-</span>mistakes<span class="token operator">/</span>demo<span class="token punctuation">.</span>txt
java    <span class="token number">63902</span> zhuye <span class="token operator">*</span><span class="token number">239</span>r   <span class="token class-name">REG</span>                <span class="token number">1</span><span class="token punctuation">,</span><span class="token number">4</span>      <span class="token number">370</span>         <span class="token number">12934160647</span> <span class="token operator">/</span><span class="token class-name">Users</span><span class="token operator">/</span>zhuye<span class="token operator">/</span><span class="token class-name">Documents</span><span class="token operator">/</span>common<span class="token operator">-</span>mistakes<span class="token operator">/</span>demo<span class="token punctuation">.</span>txt
<span class="token comment">// ...</span>

lsof <span class="token operator">-</span>p <span class="token number">63937</span> <span class="token operator">|</span> grep demo<span class="token punctuation">.</span>txt <span class="token operator">|</span> wc <span class="token operator">-</span>l
<span class="token number">10007</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p><strong>其实在</strong> ******JDK 文档**<strong><strong>​</strong>中有提到, 注意使用 try-with-resources 方式来配合, 确保流的 close 方法可以调用释放资源.</strong></p> <p>这也很容易理解, 使用流式处理, 如果不显式地告诉程序什么时候用完了流, 程序又如何知道呢, 它也不能帮我们做主何时关闭文件.</p> <p>修复方式很简单, 使用 try 来包裹 Stream 即可:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">LongAdder</span> longAdder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LongAdder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">IntStream</span><span class="token punctuation">.</span><span class="token function">rangeClosed</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1000000</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>i <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">Stream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> lines <span class="token operator">=</span> <span class="token class-name">Files</span><span class="token punctuation">.</span><span class="token function">lines</span><span class="token punctuation">(</span><span class="token class-name">Paths</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;demo.txt&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        lines<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>line <span class="token operator">-&gt;</span> longAdder<span class="token punctuation">.</span><span class="token function">increment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;total : {}&quot;</span><span class="token punctuation">,</span> longAdder<span class="token punctuation">.</span><span class="token function">longValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>修改后的代码不再出现错误日志, 因为读取了 100 万次包含 10 行数据的文件, 所以最终正确输出了 1000 万:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token number">14</span><span class="token operator">:</span><span class="token number">19</span><span class="token operator">:</span><span class="token number">29.410</span> <span class="token punctuation">[</span>main<span class="token punctuation">]</span> <span class="token constant">INFO</span> <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>geekbang<span class="token punctuation">.</span>time<span class="token punctuation">.</span>commonmistakes<span class="token punctuation">.</span>io<span class="token punctuation">.</span>demo2<span class="token punctuation">.</span></span>FilesStreamOperationNeedCloseApplication</span> <span class="token operator">-</span> total <span class="token operator">:</span> <span class="token number">10000000</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>查看 lines 方法源码可以发现, Stream 的 close 注册了一个回调, <strong>来关闭 BufferedReader 进行资源释放</strong>:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Stream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token function">lines</span><span class="token punctuation">(</span><span class="token class-name">Path</span> path<span class="token punctuation">,</span> <span class="token class-name">Charset</span> cs<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
    <span class="token class-name">BufferedReader</span> br <span class="token operator">=</span> <span class="token class-name">Files</span><span class="token punctuation">.</span><span class="token function">newBufferedReader</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> cs<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> br<span class="token punctuation">.</span><span class="token function">lines</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">onClose</span><span class="token punctuation">(</span><span class="token function">asUncheckedRunnable</span><span class="token punctuation">(</span>br<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Error</span><span class="token operator">|</span><span class="token class-name">RuntimeException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            br<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                e<span class="token punctuation">.</span><span class="token function">addSuppressed</span><span class="token punctuation">(</span>ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> ignore<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">throw</span> e<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">Runnable</span> <span class="token function">asUncheckedRunnable</span><span class="token punctuation">(</span><span class="token class-name">Closeable</span> c<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            c<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">UncheckedIOException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><p>从命名上可以看出, 使用 BufferedReader 进行字符流读取时, 用到了缓冲. 这里缓冲 Buffer 的意思是, 使用一块内存区域作为直接操作的中转.</p> <p>比如读取文件操作就是一次性读取一大块数据(比如 8KB)到缓冲区, 后续的读取可以直接从缓冲区返回数据, 而不是每次都直接对应文件 IO. 写操作也是类似. 如果每次写几十字节到文件都对应一次 IO 操作, 那么写一个几百兆的大文件可能就需要千万次的 IO 操作, 耗时会非常久.</p> <p>接下来就通过几个实验, 说明使用缓冲 Buffer 的重要性, 并对比下不同使用方式的文件读写性能, 来帮助你用对, 用好 Buffer.</p> <h5 id="注意读写文件要考虑设置缓冲区"><a href="#注意读写文件要考虑设置缓冲区" class="header-anchor">#</a> 注意读写文件要考虑设置缓冲区</h5> <p>我曾遇到过这么一个案例, 一段先进行文件读入再简单处理后写入另一个文件的业务代码, 由于开发人员使用了单字节的读取写入方式, 导致执行得巨慢, 业务量上来后需要数小时才能完成.</p> <p>来模拟一下相关实现. 创建一个文件随机写入 100 万行数据, 文件大小在 35MB 左右:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">Files</span><span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token class-name">Paths</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;src.txt&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token class-name">IntStream</span><span class="token punctuation">.</span><span class="token function">rangeClosed</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1000000</span><span class="token punctuation">)</span>
         <span class="token punctuation">.</span><span class="token function">mapToObj</span><span class="token punctuation">(</span>i <span class="token operator">-&gt;</span> <span class="token constant">UUID</span><span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
         <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant">UTF_8</span><span class="token punctuation">,</span> <span class="token constant">CREATE</span><span class="token punctuation">,</span> <span class="token constant">TRUNCATE_EXISTING</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>当时开发人员写的文件处理代码大概是这样的: <strong>使用 FileInputStream 获得一个文件输入流, 然后调用其 read 方法每次读取一个字节, 最后通过一个 FileOutputStream 文件输出流把处理后的结果写入另一个文件</strong>.</p> <p>为了简化逻辑便于理解, 这里不对数据进行处理, 直接把原文件数据写入目标文件, 相当于文件复制:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">perByteOperation</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">FileInputStream</span> fileInputStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileInputStream</span><span class="token punctuation">(</span><span class="token string">&quot;src.txt&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token class-name">FileOutputStream</span> fileOutputStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileOutputStream</span><span class="token punctuation">(</span><span class="token string">&quot;dest.txt&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> i<span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>i <span class="token operator">=</span> fileInputStream<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            fileOutputStream<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>这样的实现, 复制一个 35MB 的文件居然耗时 190 秒.</p> <p><strong>显然, 每读取一个字节, 每写入一个字节都进行一次 IO 操作, 代价太大了</strong>. 解决方案就是, 考虑使用<strong>缓冲区</strong>作为过渡, 一次性从原文件读取一定数量的数据到缓冲区, 一次性写入一定数量的数据到目标文件.</p> <p>改良后, 使用 100 字节作为缓冲区, 使用 FileInputStream 的 <code>byte[]</code>​ 的重载来一次性读取一定字节的数据, 同时使用 FileOutputStream 的 <code>byte[]</code>​ 的重载实现一次性从缓冲区写入一定字节的数据到文件:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">bufferOperationWith100Buffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">FileInputStream</span> fileInputStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileInputStream</span><span class="token punctuation">(</span><span class="token string">&quot;src.txt&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token class-name">FileOutputStream</span> fileOutputStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileOutputStream</span><span class="token punctuation">(</span><span class="token string">&quot;dest.txt&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> buffer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token number">100</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> len <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>len <span class="token operator">=</span> fileInputStream<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            fileOutputStream<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>buffer<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>仅仅使用了 100 个字节的缓冲区作为过渡, 完成 35M 文件的复制耗时缩短到了 26 秒, 是无缓冲时性能的 7 倍; 如果把缓冲区放大到 1000 字节, 耗时可以进一步缩短到 342 毫秒. 可以看到, <strong>在进行文件 IO 处理的时候, 使用合适的缓冲区可以明显提高性能</strong>.</p> <p>你可能会说, 实现文件读写还要自己 new 一个缓冲区出来, 太麻烦了, 不是有一个 BufferedInputStream 和 BufferedOutputStream 可以实现输入输出流的缓冲处理吗?</p> <p>是的, 它们在内部实现了一个默认 8KB 大小的缓冲区. 但是在使用 BufferedInputStream 和 BufferedOutputStream 时, 还是建议再使用一个缓冲进行读写, 不要因为它们实现了内部缓冲就进行逐字节的操作.</p> <p>接下来写一段代码比较下使用下面三种方式读写一个字节的性能:</p> <ol><li><strong>直接使用 BufferedInputStream 和 BufferedOutputStream;</strong></li> <li><strong>额外使用一个 8KB 缓冲, 使用 BufferedInputStream 和 BufferedOutputStream;</strong></li> <li><strong>直接使用 FileInputStream 和 FileOutputStream, 再使用一个 8KB 的缓冲.</strong></li></ol> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// 使用BufferedInputStream和BufferedOutputStream</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">bufferedStreamByteOperation</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
   <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">BufferedInputStream</span> bufferedInputStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BufferedInputStream</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">FileInputStream</span><span class="token punctuation">(</span><span class="token string">&quot;src.txt&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">BufferedOutputStream</span> bufferedOutputStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BufferedOutputStream</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">FileOutputStream</span><span class="token punctuation">(</span><span class="token string">&quot;dest.txt&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> i<span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>i <span class="token operator">=</span> bufferedInputStream<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            bufferedOutputStream<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 额外使用一个8KB缓冲, 再使用BufferedInputStream和BufferedOutputStream</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">bufferedStreamBufferOperation</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">BufferedInputStream</span> bufferedInputStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BufferedInputStream</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">FileInputStream</span><span class="token punctuation">(</span><span class="token string">&quot;src.txt&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token class-name">BufferedOutputStream</span> bufferedOutputStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BufferedOutputStream</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">FileOutputStream</span><span class="token punctuation">(</span><span class="token string">&quot;dest.txt&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> buffer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token number">8192</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> len <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>len <span class="token operator">=</span> bufferedInputStream<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            bufferedOutputStream<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>buffer<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 直接使用FileInputStream和FileOutputStream, 再使用一个8KB的缓冲</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">largerBufferOperation</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">FileInputStream</span> fileInputStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileInputStream</span><span class="token punctuation">(</span><span class="token string">&quot;src.txt&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">FileOutputStream</span> fileOutputStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileOutputStream</span><span class="token punctuation">(</span><span class="token string">&quot;dest.txt&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> buffer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token number">8192</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> len <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>len <span class="token operator">=</span> fileInputStream<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            fileOutputStream<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>buffer<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br></div></div><p>结果如下:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span>
ns         <span class="token operator">%</span>     <span class="token class-name">Task</span> name
<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span>
<span class="token number">1424649223</span>  <span class="token number">086</span><span class="token operator">%</span>  bufferedStreamByteOperation
<span class="token number">117807808</span>  <span class="token number">007</span><span class="token operator">%</span>  bufferedStreamBufferOperation
<span class="token number">112153174</span>  <span class="token number">007</span><span class="token operator">%</span>  largerBufferOperation
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>可以看到, 第一种方式虽然使用了缓冲流, 但逐字节的操作因为方法调用次数实在太多还是慢, 耗时 1.4 秒; 后面两种方式的性能差不多, 耗时 110 毫秒左右. 虽然第三种方式没有使用缓冲流, 但使用了 8KB 大小的缓冲区, 和缓冲流默认的缓冲区大小相同.</p> <p>看到这里, 你可能会疑惑了, 既然这样使用 BufferedInputStream 和 BufferedOutputStream 有什么意义呢?</p> <p>其实, 这里是为了演示所以示例三使用了固定大小的缓冲区, 但在实际代码中每次需要读取的字节数很可能不是固定的, 有的时候读取几个字节, 有的时候读取几百字节, 这个时候有一个固定大小较大的缓冲, 也就是使用 BufferedInputStream 和 BufferedOutputStream 做为后备的稳定的二次缓冲, 就非常有意义了.</p> <p>最后要补充说明的是, 对于类似的文件复制操作, 如果希望有更高性能, 可以使用 FileChannel 的 transfreTo 方法进行流的复制. 在一些操作系统(比如高版本的 Linux 和 UNIX)上可以实现 DMA(直接内存访问), 也就是数据从磁盘经过总线直接发送到目标文件, 无需经过内存和 CPU 进行数据中转:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">fileChannelOperation</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
    <span class="token class-name">FileChannel</span> in <span class="token operator">=</span> <span class="token class-name">FileChannel</span><span class="token punctuation">.</span><span class="token keyword">open</span><span class="token punctuation">(</span><span class="token class-name">Paths</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;src.txt&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">StandardOpenOption</span><span class="token punctuation">.</span><span class="token constant">READ</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">FileChannel</span> out <span class="token operator">=</span> <span class="token class-name">FileChannel</span><span class="token punctuation">.</span><span class="token keyword">open</span><span class="token punctuation">(</span><span class="token class-name">Paths</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;dest.txt&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant">CREATE</span><span class="token punctuation">,</span> <span class="token constant">WRITE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    in<span class="token punctuation">.</span><span class="token function">transferTo</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> in<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> out<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>你可以通过这篇文章, 了解 transferTo 方法的更多细节.</p> <p>在测试 FileChannel 性能的同时, 再运行一下这一小节中的所有实现, 比较一下读写 35MB 文件的耗时.</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span>
ns         <span class="token operator">%</span>     <span class="token class-name">Task</span> name
<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span>
<span class="token number">183673362265</span>  <span class="token number">098</span><span class="token operator">%</span>  perByteOperation
<span class="token number">2034504694</span>  <span class="token number">001</span><span class="token operator">%</span>  bufferOperationWith100Buffer
<span class="token number">749967898</span>  <span class="token number">000</span><span class="token operator">%</span>  bufferedStreamByteOperation
<span class="token number">110602155</span>  <span class="token number">000</span><span class="token operator">%</span>  bufferedStreamBufferOperation
<span class="token number">114542834</span>  <span class="token number">000</span><span class="token operator">%</span>  largerBufferOperation
<span class="token number">050068602</span>  <span class="token number">000</span><span class="token operator">%</span>  fileChannelOperation
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>可以看到, 最慢的是单字节读写文件流的方式, 耗时 183 秒, 最快的是 FileChannel.transferTo 方式进行流转发的方式, 耗时 50 毫秒. 两者耗时相差达到 3600 倍!</p> <h5 id="重点回顾-14"><a href="#重点回顾-14" class="header-anchor">#</a> 重点回顾</h5> <p>今天通过三个案例分享了文件读写操作中最重要的几个方面.</p> <p>第一, 如果需要读写字符流, 那么需要确保文件中字符的字符集和字符流的字符集是一致的, 否则可能产生乱码.</p> <p>第二, 使用 Files 类的一些流式处理操作, 注意使用 try-with-resources 包装 Stream, 确保底层文件资源可以释放, 避免产生 too many open files 的问题.</p> <p>第三, 进行文件字节流操作的时候, 一般情况下不考虑进行逐字节操作, 使用缓冲区进行批量读写减少 IO 次数, 性能会好很多. 一般可以考虑直接使用缓冲输入输出流 BufferedXXXStream, 追求极限性能的话可以考虑使用 FileChannel 进行流转发.</p> <p>最后要强调的是, 文件操作因为涉及操作系统和文件系统的实现, JDK 并不能确保所有 IO API 在所有平台的逻辑一致性, 代码迁移到新的操作系统或文件系统时, 要重新进行功能测试和性能测试.</p> <h4 id="_15-序列化-一来一回你还是原来的你吗"><a href="#_15-序列化-一来一回你还是原来的你吗" class="header-anchor">#</a> 15-序列化:一来一回你还是原来的你吗?</h4> <p>今天来聊聊序列化相关的坑和最佳实践.</p> <p><strong>序列化是把对象转换为字节流的过程, 以方便传输或存储. 反序列化, 则是反过来把字节流转换为对象的过程</strong>. 在介绍文件 IO 的时候, 提到字符编码是把字符转换为二进制的过程, 至于怎么转换需要由字符集制定规则. 同样地, 对象的序列化和反序列化, 也需要由<strong>序列化算法制定规则</strong>.</p> <p>关于序列化算法, 几年前常用的有 JDK(Java)序列化, XML 序列化等, 但前者不能跨语言, 后者性能较差(时间空间开销大); 现在 RESTful 应用最常用的是 JSON 序列化, 追求性能的 RPC 框架(比如 gRPC)使用 <strong>protobuf</strong> 序列化, 这 2 种方法都是跨语言的, 而且性能不错, 应用广泛.</p> <p>在架构设计阶段, 可能会重点关注算法选型, 在性能, 易用性和跨平台性等中权衡, 不过这里的坑比较少. 通常情况下, 序列化问题常见的坑会集中在业务场景中, 比如 Redis, 参数和响应序列化反序列化.</p> <p>今天就一起聊聊开发中序列化常见的一些坑.</p> <h5 id="序列化和反序列化需要确保算法一致"><a href="#序列化和反序列化需要确保算法一致" class="header-anchor">#</a> 序列化和反序列化需要确保算法一致</h5> <p>业务代码中涉及序列化时, 很重要的一点是<mark><strong>要确保序列化和反序列化的算法一致性</strong></mark>. 有一次我要排查缓存命中率问题, 需要运维同学帮忙拉取 Redis 中的 Key, 结果他反馈 Redis 中存的都是乱码, 怀疑 Redis 被攻击了. 其实这个问题就是序列化算法导致的, 来看下吧.</p> <p>在这个案例中, 开发同学使用 RedisTemplate 来操作 Redis 进行数据缓存. 因为相比于 Jedis, 使用 Spring 提供的 RedisTemplate 操作 Redis, 除了无需考虑连接池, 更方便外, 还可以与 Spring Cache 等其他组件无缝整合. 如果使用 Spring Boot 的话, 无需任何配置就可以直接使用.</p> <p>数据(包含 Key 和 Value)要保存到 Redis, 需要经过序列化算法来序列化成字符串. 虽然 Redis 支持多种数据结构, 比如 Hash, 但其每一个 field 的 Value 还是字符串. 如果 Value 本身也是字符串的话, 能否有便捷的方式来使用 RedisTemplate, 而无需考虑序列化呢?</p> <p>其实是有的, 那就是 <strong>StringRedisTemplate</strong>. 那 StringRedisTemplate 和 RedisTemplate 的区别是什么呢? 开头提到的乱码又是怎么回事呢? 带着这些问题来研究一下.</p> <p>写一段测试代码, 在应用初始化完成后向 Redis 设置两组数据, 第一次使用 RedisTemplate 设置 Key 为 redisTemplate, Value 为 User 对象, 第二次使用 StringRedisTemplate 设置 Key 为 stringRedisTemplate, Value 为 JSON 序列化后的 User 对象:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Autowired</span>
<span class="token keyword">private</span> <span class="token class-name">RedisTemplate</span> redisTemplate<span class="token punctuation">;</span>

<span class="token annotation punctuation">@Autowired</span>
<span class="token keyword">private</span> <span class="token class-name">StringRedisTemplate</span> stringRedisTemplate<span class="token punctuation">;</span>

<span class="token annotation punctuation">@Autowired</span>
<span class="token keyword">private</span> <span class="token class-name">ObjectMapper</span> objectMapper<span class="token punctuation">;</span>

<span class="token annotation punctuation">@PostConstruct</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">JsonProcessingException</span> <span class="token punctuation">{</span>
    redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">&quot;redisTemplate&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token string">&quot;zhuye&quot;</span><span class="token punctuation">,</span> <span class="token number">36</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">&quot;stringRedisTemplate&quot;</span><span class="token punctuation">,</span> objectMapper<span class="token punctuation">.</span><span class="token function">writeValueAsString</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token string">&quot;zhuye&quot;</span><span class="token punctuation">,</span> <span class="token number">36</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>如果你认为, StringRedisTemplate 和 RedisTemplate 的区别, 无非是读取的 Value 是 String 和 Object, 那就大错特错了, 因为<strong>使用这两种方式存取的数据完全无法通用</strong>.</p> <p>做个小实验, 通过 RedisTemplate 读取 Key 为 stringRedisTemplate 的 Value, 使用 StringRedisTemplate 读取 Key 为 redisTemplate 的 Value:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;redisTemplate get {}&quot;</span><span class="token punctuation">,</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;stringRedisTemplate&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;stringRedisTemplate get {}&quot;</span><span class="token punctuation">,</span> stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;redisTemplate&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>结果是, 两次都无法读取到 Value:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token punctuation">[</span><span class="token number">11</span><span class="token operator">:</span><span class="token number">49</span><span class="token operator">:</span><span class="token number">38.478</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>http<span class="token operator">-</span>nio<span class="token operator">-</span><span class="token number">45678</span><span class="token operator">-</span>exec<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token constant">INFO</span> <span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token punctuation">.</span>t<span class="token punctuation">.</span>c<span class="token punctuation">.</span>s<span class="token punctuation">.</span>demo1<span class="token punctuation">.</span>RedisTemplateController<span class="token operator">:</span><span class="token number">38</span>  <span class="token punctuation">]</span> <span class="token operator">-</span> redisTemplate get <span class="token keyword">null</span>
<span class="token punctuation">[</span><span class="token number">11</span><span class="token operator">:</span><span class="token number">49</span><span class="token operator">:</span><span class="token number">38.481</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>http<span class="token operator">-</span>nio<span class="token operator">-</span><span class="token number">45678</span><span class="token operator">-</span>exec<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token constant">INFO</span> <span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token punctuation">.</span>t<span class="token punctuation">.</span>c<span class="token punctuation">.</span>s<span class="token punctuation">.</span>demo1<span class="token punctuation">.</span>RedisTemplateController<span class="token operator">:</span><span class="token number">39</span>  <span class="token punctuation">]</span> <span class="token operator">-</span> stringRedisTemplate get <span class="token keyword">null</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>通过 redis-cli 客户端工具连接到 Redis, 会发现根本就没有叫作 redisTemplate 的 Key, 所以 StringRedisTemplate 无法查到数据:</p> <p>​<img src="/img/4795d30c82db5d7bd79cda37d263af6e-20230731165210-lr8fzo2.png" alt="">​</p> <p>查看 RedisTemplate 的源码发现, <strong>默认情况下 RedisTemplate 针对 Key 和 Value 使用了 JDK 序列化</strong>:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">afterPropertiesSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>defaultSerializer <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        defaultSerializer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JdkSerializationRedisSerializer</span><span class="token punctuation">(</span>
                classLoader <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> classLoader <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>enableDefaultSerializer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>keySerializer <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            keySerializer <span class="token operator">=</span> defaultSerializer<span class="token punctuation">;</span>
            defaultUsed <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>valueSerializer <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            valueSerializer <span class="token operator">=</span> defaultSerializer<span class="token punctuation">;</span>
            defaultUsed <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>hashKeySerializer <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            hashKeySerializer <span class="token operator">=</span> defaultSerializer<span class="token punctuation">;</span>
            defaultUsed <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>hashValueSerializer <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            hashValueSerializer <span class="token operator">=</span> defaultSerializer<span class="token punctuation">;</span>
            defaultUsed <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><p><strong>redis-cli 看到的类似一串乱码的 &quot;\xac\xed\x00\x05t\x00\rredisTemplate&quot; 字符串, 其实就是字符串 redisTemplate 经过 JDK 序列化后的结果</strong>. 这就回答了之前提到的乱码问题. 而 RedisTemplate 尝试读取 Key 为 stringRedisTemplate 数据时, 也会对这个字符串进行 JDK 序列化处理, 所以同样无法读取到数据.</p> <p>而 StringRedisTemplate 对于 Key 和 Value, 使用的<strong>是 String 序列化方式, Key 和 Value 只能是 String</strong>:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">StringRedisTemplate</span> <span class="token keyword">extends</span> <span class="token class-name">RedisTemplate</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token class-name">StringRedisTemplate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">setKeySerializer</span><span class="token punctuation">(</span><span class="token class-name">RedisSerializer</span><span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">setValueSerializer</span><span class="token punctuation">(</span><span class="token class-name">RedisSerializer</span><span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">setHashKeySerializer</span><span class="token punctuation">(</span><span class="token class-name">RedisSerializer</span><span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">setHashValueSerializer</span><span class="token punctuation">(</span><span class="token class-name">RedisSerializer</span><span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">StringRedisSerializer</span> <span class="token keyword">implements</span> <span class="token class-name">RedisSerializer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">deserialize</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Nullable</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> bytes<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span>bytes <span class="token generics"><span class="token punctuation">&lt;</span>mark<span class="token punctuation">&gt;</span></span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token keyword">null</span> <span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>bytes<span class="token punctuation">,</span> charset<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">serialize</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Nullable</span> <span class="token class-name">String</span> string<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span>string <span class="token operator">&lt;</span><span class="token operator">/</span>mark<span class="token operator">&gt;</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token keyword">null</span> <span class="token operator">:</span> string<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span>charset<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><p>看到这里, 应该知道 RedisTemplate 和 StringRedisTemplate 保存的数据无法通用. 修复方式就是, <strong>让它们读取自己存的数据</strong>:</p> <ol><li>使用 RedisTemplate 读出的数据, 由于是 Object 类型的, 使用时可以先强制转换为 User 类型;</li> <li>使用 StringRedisTemplate 读取出的字符串, 需要手动将 JSON 反序列化为 User 类型.</li></ol> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// 使用RedisTemplate获取Value, 无需反序列化就可以拿到实际对象, 虽然方便, 但是Redis中保存的Key和Value不易读</span>
<span class="token class-name">User</span> userFromRedisTemplate <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">User</span><span class="token punctuation">)</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;redisTemplate&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;redisTemplate get {}&quot;</span><span class="token punctuation">,</span> userFromRedisTemplate<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 使用StringRedisTemplate, 虽然Key正常, 但是Value存取需要手动序列化成字符串</span>
<span class="token class-name">User</span> userFromStringRedisTemplate <span class="token operator">=</span> objectMapper<span class="token punctuation">.</span><span class="token function">readValue</span><span class="token punctuation">(</span>stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;stringRedisTemplate&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">User</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;stringRedisTemplate get {}&quot;</span><span class="token punctuation">,</span> userFromStringRedisTemplate<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>这样就可以得到正确输出:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token punctuation">[</span><span class="token number">13</span><span class="token operator">:</span><span class="token number">32</span><span class="token operator">:</span><span class="token number">09.087</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>http<span class="token operator">-</span>nio<span class="token operator">-</span><span class="token number">45678</span><span class="token operator">-</span>exec<span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token constant">INFO</span> <span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token punctuation">.</span>t<span class="token punctuation">.</span>c<span class="token punctuation">.</span>s<span class="token punctuation">.</span>demo1<span class="token punctuation">.</span>RedisTemplateController<span class="token operator">:</span><span class="token number">45</span>  <span class="token punctuation">]</span> <span class="token operator">-</span> redisTemplate get <span class="token class-name">User</span><span class="token punctuation">(</span>name<span class="token operator">=</span>zhuye<span class="token punctuation">,</span> age<span class="token operator">=</span><span class="token number">36</span><span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token number">13</span><span class="token operator">:</span><span class="token number">32</span><span class="token operator">:</span><span class="token number">09.092</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>http<span class="token operator">-</span>nio<span class="token operator">-</span><span class="token number">45678</span><span class="token operator">-</span>exec<span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token constant">INFO</span> <span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token punctuation">.</span>t<span class="token punctuation">.</span>c<span class="token punctuation">.</span>s<span class="token punctuation">.</span>demo1<span class="token punctuation">.</span>RedisTemplateController<span class="token operator">:</span><span class="token number">47</span>  <span class="token punctuation">]</span> <span class="token operator">-</span> stringRedisTemplate get <span class="token class-name">User</span><span class="token punctuation">(</span>name<span class="token operator">=</span>zhuye<span class="token punctuation">,</span> age<span class="token operator">=</span><span class="token number">36</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>看到这里你可能会说, 使用 RedisTemplate 获取 Value 虽然方便, 但是 Key 和 Value 不易读; 而使用 StringRedisTemplate 虽然 Key 是普通字符串, 但是 Value 存取需要手动序列化成字符串, 有没有两全其美的方式呢?</p> <p>当然有, 自己定义 RedisTemplate 的 Key 和 Value 的序列化方式即可: <strong>Key 的序列化使用 RedisSerializer.string()(也就是 StringRedisSerializer 方式)实现字符串序列化, 而 Value 的序列化使用 Jackson2JsonRedisSerializer</strong>:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Bean</span>
<span class="token keyword">public</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">RedisTemplate</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">redisTemplate</span><span class="token punctuation">(</span><span class="token class-name">RedisConnectionFactory</span> redisConnectionFactory<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">RedisTemplate</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> redisTemplate <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RedisTemplate</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    redisTemplate<span class="token punctuation">.</span><span class="token function">setConnectionFactory</span><span class="token punctuation">(</span>redisConnectionFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Jackson2JsonRedisSerializer</span> jackson2JsonRedisSerializer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Jackson2JsonRedisSerializer</span><span class="token punctuation">(</span><span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    redisTemplate<span class="token punctuation">.</span><span class="token function">setKeySerializer</span><span class="token punctuation">(</span><span class="token class-name">RedisSerializer</span><span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    redisTemplate<span class="token punctuation">.</span><span class="token function">setValueSerializer</span><span class="token punctuation">(</span>jackson2JsonRedisSerializer<span class="token punctuation">)</span><span class="token punctuation">;</span>
    redisTemplate<span class="token punctuation">.</span><span class="token function">setHashKeySerializer</span><span class="token punctuation">(</span><span class="token class-name">RedisSerializer</span><span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    redisTemplate<span class="token punctuation">.</span><span class="token function">setHashValueSerializer</span><span class="token punctuation">(</span>jackson2JsonRedisSerializer<span class="token punctuation">)</span><span class="token punctuation">;</span>
    redisTemplate<span class="token punctuation">.</span><span class="token function">afterPropertiesSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> redisTemplate<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>写代码测试一下存取, 直接注入类型为 <code>RedisTemplate&lt;String, User&gt;</code>​ 的 userRedisTemplate 字段, 然后在 right2 方法中, 使用注入的 userRedisTemplate 存入一个 User 对象, 再分别使用 userRedisTemplate 和 StringRedisTemplate 取出这个对象:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Autowired</span>
<span class="token keyword">private</span> <span class="token class-name">RedisTemplate</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">User</span><span class="token punctuation">&gt;</span></span> userRedisTemplate<span class="token punctuation">;</span>

<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;right2&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">right2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">User</span> user <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token string">&quot;zhuye&quot;</span><span class="token punctuation">,</span> <span class="token number">36</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    userRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> user<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Object</span> userFromRedis <span class="token operator">=</span> userRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;userRedisTemplate get {} {}&quot;</span><span class="token punctuation">,</span> userFromRedis<span class="token punctuation">,</span> userFromRedis<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;stringRedisTemplate get {}&quot;</span><span class="token punctuation">,</span> stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>乍一看没啥问题, StringRedisTemplate 成功查出了存入的数据:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token punctuation">[</span><span class="token number">14</span><span class="token operator">:</span><span class="token number">07</span><span class="token operator">:</span><span class="token number">41.315</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>http<span class="token operator">-</span>nio<span class="token operator">-</span><span class="token number">45678</span><span class="token operator">-</span>exec<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token constant">INFO</span> <span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token punctuation">.</span>t<span class="token punctuation">.</span>c<span class="token punctuation">.</span>s<span class="token punctuation">.</span>demo1<span class="token punctuation">.</span>RedisTemplateController<span class="token operator">:</span><span class="token number">55</span>  <span class="token punctuation">]</span> <span class="token operator">-</span> userRedisTemplate get <span class="token punctuation">{</span>name<span class="token operator">=</span>zhuye<span class="token punctuation">,</span> age<span class="token operator">=</span><span class="token number">36</span><span class="token punctuation">}</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span>LinkedHashMap</span>
<span class="token punctuation">[</span><span class="token number">14</span><span class="token operator">:</span><span class="token number">07</span><span class="token operator">:</span><span class="token number">41.318</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>http<span class="token operator">-</span>nio<span class="token operator">-</span><span class="token number">45678</span><span class="token operator">-</span>exec<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token constant">INFO</span> <span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token punctuation">.</span>t<span class="token punctuation">.</span>c<span class="token punctuation">.</span>s<span class="token punctuation">.</span>demo1<span class="token punctuation">.</span>RedisTemplateController<span class="token operator">:</span><span class="token number">56</span>  <span class="token punctuation">]</span> <span class="token operator">-</span> stringRedisTemplate get <span class="token punctuation">{</span><span class="token string">&quot;name&quot;</span><span class="token operator">:</span><span class="token string">&quot;zhuye&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;age&quot;</span><span class="token operator">:</span><span class="token number">36</span><span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>Redis 里也可以查到 Key 是纯字符串, Value 是 JSON 序列化后的 User 对象:</p> <p>​<img src="/img/fa3bcbcafaca6718d6509fc3b19dec84-20230731165210-4er6w6o.png" alt="">​</p> <p>但值得注意的是, 这里有一个坑. <strong>第一行的日志输出显示, userRedisTemplate 获取到的 Value, 是 LinkedHashMap 类型的</strong>, 完全不是泛型的 RedisTemplate 设置的 User 类型.</p> <p>如果把代码里从 Redis 中获取到的 Value 变量类型由 Object 改为 User, 编译不会出现问题, 但会出现 ClassCastException:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>ClassCastException</span><span class="token operator">:</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span>LinkedHashMap</span> cannot be cast <span class="token keyword">to</span> <span class="token namespace">org<span class="token punctuation">.</span>geekbang<span class="token punctuation">.</span>time<span class="token punctuation">.</span>commonmistakes<span class="token punctuation">.</span>serialization<span class="token punctuation">.</span>demo1<span class="token punctuation">.</span></span><span class="token class-name">User</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>修复方式是, 修改自定义 RestTemplate 的代码, 把 new 出来的 <strong>Jackson2JsonRedisSerializer</strong> 设置一个自定义的 ObjectMapper, 启用 activateDefaultTyping 方法把类型信息作为属性写入序列化后的数据中(当然也可以调整 JsonTypeInfo.As 枚举以其他形式保存类型信息):</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// ...</span>
<span class="token class-name">Jackson2JsonRedisSerializer</span> jackson2JsonRedisSerializer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Jackson2JsonRedisSerializer</span><span class="token punctuation">(</span><span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">ObjectMapper</span> objectMapper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectMapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 把类型信息作为属性写入Value</span>
objectMapper<span class="token punctuation">.</span><span class="token function">activateDefaultTyping</span><span class="token punctuation">(</span>objectMapper<span class="token punctuation">.</span><span class="token function">getPolymorphicTypeValidator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">ObjectMapper<span class="token punctuation">.</span>DefaultTyping</span><span class="token punctuation">.</span><span class="token constant">NON_FINAL</span><span class="token punctuation">,</span> <span class="token class-name">JsonTypeInfo<span class="token punctuation">.</span>As</span><span class="token punctuation">.</span><span class="token constant">PROPERTY</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
jackson2JsonRedisSerializer<span class="token punctuation">.</span><span class="token function">setObjectMapper</span><span class="token punctuation">(</span>objectMapper<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// ...</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>或者直接使用 RedisSerializer.json() 快捷方法, 它内部使用的 GenericJackson2JsonRedisSerializer 直接设置了把类型作为属性保存到 Value 中:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>redisTemplate<span class="token punctuation">.</span><span class="token function">setKeySerializer</span><span class="token punctuation">(</span><span class="token class-name">RedisSerializer</span><span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
redisTemplate<span class="token punctuation">.</span><span class="token function">setValueSerializer</span><span class="token punctuation">(</span><span class="token class-name">RedisSerializer</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
redisTemplate<span class="token punctuation">.</span><span class="token function">setHashKeySerializer</span><span class="token punctuation">(</span><span class="token class-name">RedisSerializer</span><span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
redisTemplate<span class="token punctuation">.</span><span class="token function">setHashValueSerializer</span><span class="token punctuation">(</span><span class="token class-name">RedisSerializer</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>重启程序调用 right2 方法进行测试, 可以看到, 从自定义的 RedisTemplate 中获取到的 Value 是 User 类型的(第一行日志), 而且 Redis 中实际保存的 Value 包含了类型完全限定名(第二行日志):</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token punctuation">[</span><span class="token number">15</span><span class="token operator">:</span><span class="token number">10</span><span class="token operator">:</span><span class="token number">50.396</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>http<span class="token operator">-</span>nio<span class="token operator">-</span><span class="token number">45678</span><span class="token operator">-</span>exec<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token constant">INFO</span> <span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token punctuation">.</span>t<span class="token punctuation">.</span>c<span class="token punctuation">.</span>s<span class="token punctuation">.</span>demo1<span class="token punctuation">.</span>RedisTemplateController<span class="token operator">:</span><span class="token number">55</span>  <span class="token punctuation">]</span> <span class="token operator">-</span> userRedisTemplate get <span class="token class-name">User</span><span class="token punctuation">(</span>name<span class="token operator">=</span>zhuye<span class="token punctuation">,</span> age<span class="token operator">=</span><span class="token number">36</span><span class="token punctuation">)</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>geekbang<span class="token punctuation">.</span>time<span class="token punctuation">.</span>commonmistakes<span class="token punctuation">.</span>serialization<span class="token punctuation">.</span>demo1<span class="token punctuation">.</span></span>User</span>
<span class="token punctuation">[</span><span class="token number">15</span><span class="token operator">:</span><span class="token number">10</span><span class="token operator">:</span><span class="token number">50.399</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>http<span class="token operator">-</span>nio<span class="token operator">-</span><span class="token number">45678</span><span class="token operator">-</span>exec<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token constant">INFO</span> <span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token punctuation">.</span>t<span class="token punctuation">.</span>c<span class="token punctuation">.</span>s<span class="token punctuation">.</span>demo1<span class="token punctuation">.</span>RedisTemplateController<span class="token operator">:</span><span class="token number">56</span>  <span class="token punctuation">]</span> <span class="token operator">-</span> stringRedisTemplate get <span class="token punctuation">[</span><span class="token string">&quot;org.geekbang.time.commonmistakes.serialization.demo1.User&quot;</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token string">&quot;name&quot;</span><span class="token operator">:</span><span class="token string">&quot;zhuye&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;age&quot;</span><span class="token operator">:</span><span class="token number">36</span><span class="token punctuation">}</span><span class="token punctuation">]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>因此, 反序列化时可以直接得到 User 类型的 Value.</p> <p>通过对 RedisTemplate 组件的分析, 可以看到, <strong>当数据需要序列化后保存时, 读写数据使用一致的序列化算法的必要性</strong>, 否则就像对牛弹琴.</p> <p>这里再总结下 Spring 提供的 4 种 RedisSerializer(Redis 序列化器):</p> <ol><li><strong>默认情况下, RedisTemplate 使用 JdkSerializationRedisSerializer, 也就是 JDK 序列化</strong>, 容易产生 Redis 中保存了乱码的错觉.</li> <li>通常考虑到易读性, 可以<strong>设置 Key 的序列化器为 StringRedisSerializer</strong>. 但直接使用 RedisSerializer.string(), 相当于使用了 UTF_8 编码的 StringRedisSerializer, 需要注意字符集问题.</li> <li>如果希望 Value 也是使用 JSON 序列化的话, 可以把 Value 序列化器设置为 <strong>Jackson2JsonRedisSerializer</strong>. 默认情况下, 不会把类型信息保存在 Value 中, 即使定义 RedisTemplate 的 Value 泛型为实际类型, 查询出的 Value 也只能是 LinkedHashMap 类型. 如果希望直接获取真实的数据类型, 可以启用 Jackson ObjectMapper 的 activateDefaultTyping 方法, 把类型信息一起序列化保存在 Value 中.</li> <li>如果希望 Value 以 JSON 保存并带上类型信息, 更简单的方式是, 直接使用 RedisSerializer.json() 快捷方法来获取序列化器.</li></ol> <h5 id="注意jackson-json反序列化对额外字段的处理"><a href="#注意jackson-json反序列化对额外字段的处理" class="header-anchor">#</a> 注意Jackson JSON反序列化对额外字段的处理</h5> <p>前面提到, 通过设置 JSON 序列化工具 Jackson 的 activateDefaultTyping 方法, 可以在序列化数据时写入对象类型. 其实, Jackson 还有很多参数可以控制序列化和反序列化, 是一个功能强大而完善的序列化工具. 因此, 很多框架都将 Jackson 作为 JDK 序列化工具, 比如 Spring Web. 但也正是这个原因, 使用时要小心各个参数的配置.</p> <p>比如, 在开发 Spring Web 应用程序时, 如果自定义了 ObjectMapper, 并把它注册成了 Bean, 那很可能会导致 Spring Web 使用的 ObjectMapper 也被替换, 导致 Bug.</p> <p>来看一个案例. 程序一开始是正常的, 某一天开发同学希望修改一下 ObjectMapper 的行为, 让枚举序列化为索引值而不是字符串值, 比如默认情况下序列化一个 Color 枚举中的 Color.BLUE 会得到字符串 BLUE:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Autowired</span>
<span class="token keyword">private</span> <span class="token class-name">ObjectMapper</span> objectMapper<span class="token punctuation">;</span>

<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;test&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">JsonProcessingException</span> <span class="token punctuation">{</span>
  log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;color:{}&quot;</span><span class="token punctuation">,</span> objectMapper<span class="token punctuation">.</span><span class="token function">writeValueAsString</span><span class="token punctuation">(</span><span class="token class-name">Color</span><span class="token punctuation">.</span><span class="token constant">BLUE</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">enum</span> <span class="token class-name">Color</span> <span class="token punctuation">{</span>
    <span class="token constant">RED</span><span class="token punctuation">,</span> <span class="token constant">BLUE</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>于是, 这位同学就重新定义了一个 ObjectMapper Bean, 开启了 WRITE_ENUMS_USING_INDEX 功能特性:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Bean</span>
<span class="token keyword">public</span> <span class="token class-name">ObjectMapper</span> <span class="token function">objectMapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token class-name">ObjectMapper</span> objectMapper<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">ObjectMapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    objectMapper<span class="token punctuation">.</span><span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">SerializationFeature</span><span class="token punctuation">.</span><span class="token constant">WRITE_ENUMS_USING_INDEX</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> objectMapper<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>开启这个特性后, Color.BLUE 枚举序列化成索引值 1:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token punctuation">[</span><span class="token number">16</span><span class="token operator">:</span><span class="token number">11</span><span class="token operator">:</span><span class="token number">37.382</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>http<span class="token operator">-</span>nio<span class="token operator">-</span><span class="token number">45678</span><span class="token operator">-</span>exec<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token constant">INFO</span> <span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token class-name"><span class="token namespace">c<span class="token punctuation">.</span>s<span class="token punctuation">.</span>d<span class="token punctuation">.</span></span>JsonIgnorePropertiesController</span><span class="token operator">:</span><span class="token number">19</span>  <span class="token punctuation">]</span> <span class="token operator">-</span> color<span class="token operator">:</span><span class="token number">1</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>修改后处理枚举序列化的逻辑是满足了要求, 但线上爆出了大量 400 错误, 日志中也出现了很多 UnrecognizedPropertyException:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token constant">JSON</span> parse error<span class="token operator">:</span> <span class="token class-name">Unrecognized</span> field \&quot;ver\&quot; <span class="token punctuation">(</span><span class="token keyword">class</span> <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>geekbang<span class="token punctuation">.</span>time<span class="token punctuation">.</span>commonmistakes<span class="token punctuation">.</span>serialization<span class="token punctuation">.</span>demo4<span class="token punctuation">.</span></span>UserWrong</span><span class="token punctuation">)</span><span class="token punctuation">,</span> not marked as ignorable<span class="token punctuation">;</span> nested exception is <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>fasterxml<span class="token punctuation">.</span>jackson<span class="token punctuation">.</span>databind<span class="token punctuation">.</span>exc<span class="token punctuation">.</span></span>UnrecognizedPropertyException</span><span class="token operator">:</span> <span class="token class-name">Unrecognized</span> field \&quot;version\&quot; <span class="token punctuation">(</span><span class="token keyword">class</span> <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>geekbang<span class="token punctuation">.</span>time<span class="token punctuation">.</span>commonmistakes<span class="token punctuation">.</span>serialization<span class="token punctuation">.</span>demo4<span class="token punctuation">.</span></span>UserWrong</span><span class="token punctuation">)</span><span class="token punctuation">,</span> not marked as ignorable <span class="token punctuation">(</span>one known property<span class="token operator">:</span> \&quot;name\&quot;<span class="token punctuation">]</span><span class="token punctuation">)</span>\n at <span class="token punctuation">[</span><span class="token class-name">Source</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token class-name">PushbackInputStream</span><span class="token punctuation">)</span><span class="token punctuation">;</span> line<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> column<span class="token operator">:</span> <span class="token number">22</span><span class="token punctuation">]</span> <span class="token punctuation">(</span>through reference chain<span class="token operator">:</span> <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>geekbang<span class="token punctuation">.</span>time<span class="token punctuation">.</span>commonmistakes<span class="token punctuation">.</span>serialization<span class="token punctuation">.</span>demo4<span class="token punctuation">.</span></span>UserWrong</span><span class="token punctuation">[</span>\&quot;ver\&quot;<span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>从异常信息中可以看到, 这是因为<strong>反序列化的时候, 原始数据多了一个 version 属性</strong>. 进一步分析发现, 使用了 UserWrong 类型作为 Web 控制器 wrong 方法的入参, 其中只有一个 name 属性:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Data</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserWrong</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;wrong&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">UserWrong</span> <span class="token function">wrong</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">UserWrong</span> user<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> user<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>而客户端实际传过来的数据多了一个 version 属性. 那为什么之前没这个问题呢?</p> <p>问题就出在, <strong>自定义 ObjectMapper 启用 WRITE_ENUMS_USING_INDEX 序列化功能特性时, 覆盖了 Spring Boot 自动创建的 ObjectMapper</strong>; 而这个自动创建的 ObjectMapper 设置过 FAIL_ON_UNKNOWN_PROPERTIES 反序列化特性为 false, 以确保出现未知字段时不要抛出异常. 源码如下:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">MappingJackson2HttpMessageConverter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">(</span><span class="token class-name">Jackson2ObjectMapperBuilder</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Jackson2ObjectMapperBuilder</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">customizeDefaultFeatures</span><span class="token punctuation">(</span><span class="token class-name">ObjectMapper</span> objectMapper<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>features<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span><span class="token class-name">MapperFeature</span><span class="token punctuation">.</span><span class="token constant">DEFAULT_VIEW_INCLUSION</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">configureFeature</span><span class="token punctuation">(</span>objectMapper<span class="token punctuation">,</span> <span class="token class-name">MapperFeature</span><span class="token punctuation">.</span><span class="token constant">DEFAULT_VIEW_INCLUSION</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>features<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span><span class="token class-name">DeserializationFeature</span><span class="token punctuation">.</span><span class="token constant">FAIL_ON_UNKNOWN_PROPERTIES</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">configureFeature</span><span class="token punctuation">(</span>objectMapper<span class="token punctuation">,</span> <span class="token class-name">DeserializationFeature</span><span class="token punctuation">.</span><span class="token constant">FAIL_ON_UNKNOWN_PROPERTIES</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>要修复这个问题, 有三种方式:</p> <ul><li>第一种, 同样禁用自定义的 ObjectMapper 的 FAIL_ON_UNKNOWN_PROPERTIES:</li></ul> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Bean</span>
<span class="token keyword">public</span> <span class="token class-name">ObjectMapper</span> <span class="token function">objectMapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token class-name">ObjectMapper</span> objectMapper<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">ObjectMapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    objectMapper<span class="token punctuation">.</span><span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">SerializationFeature</span><span class="token punctuation">.</span><span class="token constant">WRITE_ENUMS_USING_INDEX</span><span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    objectMapper<span class="token punctuation">.</span><span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">DeserializationFeature</span><span class="token punctuation">.</span><span class="token constant">FAIL_ON_UNKNOWN_PROPERTIES</span><span class="token punctuation">,</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> objectMapper<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><ul><li>第二种, 设置自定义类型, 加上 @JsonIgnoreProperties 注解, 开启 ignoreUnknown 属性, 以实现反序列化时忽略额外的数据:</li></ul> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Data</span>
<span class="token annotation punctuation">@JsonIgnoreProperties</span><span class="token punctuation">(</span>ignoreUnknown <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserRight</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><ul><li>第三种, 不要自定义 ObjectMapper, 而是直接在配置文件设置相关参数, 来修改 Spring 默认的 ObjectMapper 的功能. 比如, 直接在配置文件启用把枚举序列化为索引号:</li></ul> <div class="language-java line-numbers-mode"><pre class="language-java"><code>spring<span class="token punctuation">.</span>jackson<span class="token punctuation">.</span>serialization<span class="token punctuation">.</span>write_enums_using_index<span class="token operator">=</span><span class="token boolean">true</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>或者可以直接定义 Jackson2ObjectMapperBuilderCustomizer Bean 来启用新特性:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Bean</span>
<span class="token keyword">public</span> <span class="token class-name">Jackson2ObjectMapperBuilderCustomizer</span> <span class="token function">customizer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> builder <span class="token operator">-&gt;</span> builder<span class="token punctuation">.</span><span class="token function">featuresToEnable</span><span class="token punctuation">(</span><span class="token class-name">SerializationFeature</span><span class="token punctuation">.</span><span class="token constant">WRITE_ENUMS_USING_INDEX</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>这个案例告诉我们两点:</p> <ol><li>Jackson 针对序列化和反序列化有大量的细节功能特性, 可以参考 Jackson 官方文档来了解这些特性, 详见SerializationFeature, DeserializationFeature 和 MapperFeature.</li> <li>忽略多余字段, 是写业务代码时最容易遇到的一个配置项. Spring Boot 在自动配置时贴心地做了全局设置. 如果需要设置更多的特性, 可以直接修改配置文件 <code>spring.jackson.**</code>​ 或设置 Jackson2ObjectMapperBuilderCustomizer 回调接口来启用更多设置, 无需重新定义 ObjectMapper Bean.</li></ol> <h5 id="反序列化时要小心类的构造方法"><a href="#反序列化时要小心类的构造方法" class="header-anchor">#</a> 反序列化时要小心类的构造方法</h5> <p>使用 Jackson 反序列化时, 除了要注意忽略额外字段的问题外, 还要<strong>小心类的构造方法</strong>. 看一个踩坑案例.</p> <p>有一个 APIResult 类包装了 REST 接口的返回体(作为 Web 控制器的出参), 其中 boolean 类型的 success 字段代表是否处理成功, int 类型的 code 字段代表处理状态码.</p> <p>开始时, 在返回 APIResult 的时候每次都根据 code 来设置 success. 如果 code 是 2000, 那么 success 是 true, 否则是 false. 后来为了减少重复代码, 把这个逻辑<strong>放到了 APIResult 类的构造方法</strong>中处理:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Data</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">APIResultWrong</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">boolean</span> success<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> code<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">APIResultWrong</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">APIResultWrong</span><span class="token punctuation">(</span><span class="token keyword">int</span> code<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>code <span class="token operator">=</span> code<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>code <span class="token operator">==</span> <span class="token number">2000</span><span class="token punctuation">)</span> success <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span> success <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>经过改动后发现, 即使 code 为 2000, 返回 APIResult 的 success 也是 false. 比如反序列化两次 APIResult, 一次使用 <code>code &lt;mark&gt; 1234</code>​, 一次使用 <code>code &lt;/mark&gt; 2000</code>​:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Autowired</span>
<span class="token class-name">ObjectMapper</span> objectMapper<span class="token punctuation">;</span>

<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;wrong&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">wrong</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">JsonProcessingException</span> <span class="token punctuation">{</span>
    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;result :{}&quot;</span><span class="token punctuation">,</span> objectMapper<span class="token punctuation">.</span><span class="token function">readValue</span><span class="token punctuation">(</span><span class="token string">&quot;{\&quot;code\&quot;:1234}&quot;</span><span class="token punctuation">,</span> <span class="token class-name">APIResultWrong</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;result :{}&quot;</span><span class="token punctuation">,</span> objectMapper<span class="token punctuation">.</span><span class="token function">readValue</span><span class="token punctuation">(</span><span class="token string">&quot;{\&quot;code\&quot;:2000}&quot;</span><span class="token punctuation">,</span> <span class="token class-name">APIResultWrong</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>日志输出如下:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token punctuation">[</span><span class="token number">17</span><span class="token operator">:</span><span class="token number">36</span><span class="token operator">:</span><span class="token number">14.591</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>http<span class="token operator">-</span>nio<span class="token operator">-</span><span class="token number">45678</span><span class="token operator">-</span>exec<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token constant">INFO</span> <span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token class-name">DeserializationConstructorController</span><span class="token operator">:</span><span class="token number">20</span>  <span class="token punctuation">]</span> <span class="token operator">-</span> result <span class="token operator">:</span><span class="token class-name">APIResultWrong</span><span class="token punctuation">(</span>success<span class="token operator">=</span><span class="token boolean">false</span><span class="token punctuation">,</span> code<span class="token operator">=</span><span class="token number">1234</span><span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token number">17</span><span class="token operator">:</span><span class="token number">36</span><span class="token operator">:</span><span class="token number">14.591</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>http<span class="token operator">-</span>nio<span class="token operator">-</span><span class="token number">45678</span><span class="token operator">-</span>exec<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token constant">INFO</span> <span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token class-name">DeserializationConstructorController</span><span class="token operator">:</span><span class="token number">21</span>  <span class="token punctuation">]</span> <span class="token operator">-</span> result <span class="token operator">:</span><span class="token class-name">APIResultWrong</span><span class="token punctuation">(</span>success<span class="token operator">=</span><span class="token boolean">false</span><span class="token punctuation">,</span> code<span class="token operator">=</span><span class="token number">2000</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>可以看到, 两次的 APIResult 的 success 字段都是 false.</p> <p>出现这个问题的原因是, <mark><strong>默认情况下, 在反序列化的时候, Jackson 框架只会调用无参构造方法创建对象</strong></mark>. 如果走自定义的构造方法创建对象, 需要<strong>通过 @JsonCreator 来指定构造方法, 并通过 @JsonProperty 设置构造方法中参数对应的 JSON 属性名</strong>:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Data</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">APIResultRight</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
    <span class="token annotation punctuation">@JsonCreator</span>
    <span class="token keyword">public</span> <span class="token class-name">APIResultRight</span><span class="token punctuation">(</span><span class="token annotation punctuation">@JsonProperty</span><span class="token punctuation">(</span><span class="token string">&quot;code&quot;</span><span class="token punctuation">)</span> <span class="token keyword">int</span> code<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>code <span class="token operator">=</span> code<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>code <span class="token operator">==</span> <span class="token number">2000</span><span class="token punctuation">)</span> success <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span> success <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>重新运行程序, 可以得到正确输出:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token punctuation">[</span><span class="token number">17</span><span class="token operator">:</span><span class="token number">41</span><span class="token operator">:</span><span class="token number">23.188</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>http<span class="token operator">-</span>nio<span class="token operator">-</span><span class="token number">45678</span><span class="token operator">-</span>exec<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token constant">INFO</span> <span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token class-name">DeserializationConstructorController</span><span class="token operator">:</span><span class="token number">26</span>  <span class="token punctuation">]</span> <span class="token operator">-</span> result <span class="token operator">:</span><span class="token class-name">APIResultRight</span><span class="token punctuation">(</span>success<span class="token operator">=</span><span class="token boolean">false</span><span class="token punctuation">,</span> code<span class="token operator">=</span><span class="token number">1234</span><span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token number">17</span><span class="token operator">:</span><span class="token number">41</span><span class="token operator">:</span><span class="token number">23.188</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>http<span class="token operator">-</span>nio<span class="token operator">-</span><span class="token number">45678</span><span class="token operator">-</span>exec<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token constant">INFO</span> <span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token class-name">DeserializationConstructorController</span><span class="token operator">:</span><span class="token number">27</span>  <span class="token punctuation">]</span> <span class="token operator">-</span> result <span class="token operator">:</span><span class="token class-name">APIResultRight</span><span class="token punctuation">(</span>success<span class="token operator">=</span><span class="token boolean">true</span><span class="token punctuation">,</span> code<span class="token operator">=</span><span class="token number">2000</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>可以看到, 这次传入 <code>code == 2000</code>​ 时, success 可以设置为 true.</p> <h5 id="枚举作为api接口参数或返回值的两个大坑"><a href="#枚举作为api接口参数或返回值的两个大坑" class="header-anchor">#</a> 枚举作为API接口参数或返回值的两个大坑</h5> <p>在前面的例子中, 演示了如何把枚举序列化为索引值. 但对于枚举, 建议<strong>尽量在程序内部使用</strong>, 而不是作为 API 接口的参数或返回值, 原因是<strong>枚举涉及序列化和反序列化时会有两个大坑</strong>.</p> <p><strong>第一个坑是, 客户端和服务端的枚举定义不一致时, 会出异常.</strong>  比如客户端版本的枚举定义了 4 个枚举值:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Getter</span>
<span class="token keyword">enum</span> <span class="token class-name">StatusEnumClient</span> <span class="token punctuation">{</span>
    <span class="token function">CREATED</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">&quot;已创建&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">PAID</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">&quot;已支付&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">DELIVERED</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">&quot;已送到&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">FINISHED</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token string">&quot;已完成&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">int</span> status<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">String</span> desc<span class="token punctuation">;</span>

    <span class="token class-name">StatusEnumClient</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> status<span class="token punctuation">,</span> <span class="token class-name">String</span> desc<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">=</span> status<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>desc <span class="token operator">=</span> desc<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>服务端定义了 5 个枚举值:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Getter</span>
<span class="token keyword">enum</span> <span class="token class-name">StatusEnumServer</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
    <span class="token function">CANCELED</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token string">&quot;已取消&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">int</span> status<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">String</span> desc<span class="token punctuation">;</span>

    <span class="token class-name">StatusEnumServer</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> status<span class="token punctuation">,</span> <span class="token class-name">String</span> desc<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">=</span> status<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>desc <span class="token operator">=</span> desc<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>写代码测试一下, 使用 RestTemplate 来发起请求, 让服务端返回客户端不存在的枚举值:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;getOrderStatusClient&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">getOrderStatusClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">StatusEnumClient</span> result <span class="token operator">=</span> restTemplate<span class="token punctuation">.</span><span class="token function">getForObject</span><span class="token punctuation">(</span><span class="token string">&quot;http://localhost:45678/enumusedinapi/getOrderStatus&quot;</span><span class="token punctuation">,</span> <span class="token class-name">StatusEnumClient</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;result {}&quot;</span><span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;getOrderStatus&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">StatusEnumServer</span> <span class="token function">getOrderStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token class-name">StatusEnumServer</span><span class="token punctuation">.</span><span class="token constant">CANCELED</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>访问接口会出现如下异常信息, 提示在枚举 StatusEnumClient 中找不到 CANCELED:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token constant">JSON</span> parse error<span class="token operator">:</span> <span class="token class-name">Cannot</span> deserialize value of type `<span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>geekbang<span class="token punctuation">.</span>time<span class="token punctuation">.</span>commonmistakes<span class="token punctuation">.</span>enums<span class="token punctuation">.</span>enumusedinapi<span class="token punctuation">.</span></span>StatusEnumClient</span>` from <span class="token class-name">String</span> <span class="token string">&quot;CANCELED&quot;</span><span class="token operator">:</span> not one of the values accepted <span class="token keyword">for</span> <span class="token class-name">Enum</span> <span class="token keyword">class</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token constant">CREATED</span><span class="token punctuation">,</span> <span class="token constant">FINISHED</span><span class="token punctuation">,</span> <span class="token constant">DELIVERED</span><span class="token punctuation">,</span> <span class="token constant">PAID</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>要解决这个问题, 可以开启 Jackson 的 read_unknown_enum_values_using_default_value 反序列化特性, 也就是在枚举值未知的时候使用默认值:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>spring<span class="token punctuation">.</span>jackson<span class="token punctuation">.</span>deserialization<span class="token punctuation">.</span>read_unknown_enum_values_using_default_value<span class="token operator">=</span><span class="token boolean">true</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>并为枚举添加一个默认值, 使用  <strong>@JsonEnumDefaultValue</strong> 注解注释:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@JsonEnumDefaultValue</span>
<span class="token function">UNKNOWN</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">&quot;未知&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>需要注意的是, 这个枚举值一定是添加在客户端 StatusEnumClient 中的, 因为反序列化使用的是客户端枚举.</p> <p>这里还有一个小坑是, 仅仅这样配置还不能让 RestTemplate 生效这个反序列化特性, 还需要配置 RestTemplate, 来使用 Spring Boot 的 <strong>MappingJackson2HttpMessageConverter</strong> 才行:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Bean</span>
<span class="token keyword">public</span> <span class="token class-name">RestTemplate</span> <span class="token function">restTemplate</span><span class="token punctuation">(</span><span class="token class-name">MappingJackson2HttpMessageConverter</span> mappingJackson2HttpMessageConverter<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">RestTemplateBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">additionalMessageConverters</span><span class="token punctuation">(</span>mappingJackson2HttpMessageConverter<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>现在, 请求接口可以返回默认值了:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token punctuation">[</span><span class="token number">21</span><span class="token operator">:</span><span class="token number">49</span><span class="token operator">:</span><span class="token number">03.887</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>http<span class="token operator">-</span>nio<span class="token operator">-</span><span class="token number">45678</span><span class="token operator">-</span>exec<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token constant">INFO</span> <span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>g<span class="token punctuation">.</span>t<span class="token punctuation">.</span>c<span class="token punctuation">.</span>e<span class="token punctuation">.</span>e<span class="token punctuation">.</span></span>EnumUsedInAPIController</span><span class="token operator">:</span><span class="token number">25</span>  <span class="token punctuation">]</span> <span class="token operator">-</span> result <span class="token constant">UNKNOWN</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><strong>第二个坑, 也是更大的坑, 枚举序列化反序列化实现自定义的字段非常麻烦, 会涉及 Jackson 的 Bug</strong>. 比如下面这个接口, 传入枚举 List, 为 List 增加一个 CENCELED 枚举值然后返回:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;queryOrdersByStatusList&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">StatusEnumServer</span><span class="token punctuation">&gt;</span></span> <span class="token function">queryOrdersByStatus</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">StatusEnumServer</span><span class="token punctuation">&gt;</span></span> enumServers<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    enumServers<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">StatusEnumServer</span><span class="token punctuation">.</span><span class="token constant">CANCELED</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> enumServers<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>如果希望根据枚举的 Desc 字段来序列化, 传入 &quot;已送到&quot; 作为入参:</p> <p><img src="/img/35211eaf865ce4a5bb37c9c699a2ccae-20230731165210-sr1le8x.png" alt=""></p> <p>会得到异常, 提示 &quot;已送到&quot; 不是正确的枚举值:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token constant">JSON</span> parse error<span class="token operator">:</span> <span class="token class-name">Cannot</span> deserialize value of type `<span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>geekbang<span class="token punctuation">.</span>time<span class="token punctuation">.</span>commonmistakes<span class="token punctuation">.</span>enums<span class="token punctuation">.</span>enumusedinapi<span class="token punctuation">.</span></span>StatusEnumServer</span>` from <span class="token class-name">String</span> <span class="token string">&quot;已送到&quot;</span><span class="token operator">:</span> not one of the values accepted <span class="token keyword">for</span> <span class="token class-name">Enum</span> <span class="token keyword">class</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token constant">CREATED</span><span class="token punctuation">,</span> <span class="token constant">CANCELED</span><span class="token punctuation">,</span> <span class="token constant">FINISHED</span><span class="token punctuation">,</span> <span class="token constant">DELIVERED</span><span class="token punctuation">,</span> <span class="token constant">PAID</span><span class="token punctuation">]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>显然, 这里反序列化使用的是枚举的 name, 序列化也是一样:</p> <p><img src="/img/608458e5aa3c30b34c556d2a4eaf602c-20230731165210-pszi1b0.png" alt=""></p> <p>你可能也知道, 要让枚举的序列化和反序列化走 desc 字段, 可以在字段上加 <code>@JsonValue</code>​ 注解, 修改 StatusEnumServer 和 StatusEnumClient:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@JsonValue</span>
<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">String</span> desc<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>然后再尝试下, 果然可以用 desc 作为入参了, 而且出参也使用了枚举的 desc:</p> <p><img src="/img/9a8704eeab0be2fd83bbd2d17a3927be-20230731165210-rzojcfa.png" alt=""></p> <p>但如果你认为这样就完美解决问题了, 那就大错特错了. 可以再尝试把 @JsonValue 注解加在 int 类型的 status 字段上, 也就是希望序列化反序列化走 status 字段:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@JsonValue</span>
<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">int</span> status<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>写一个客户端测试一下, 传入 CREATED 和 PAID 两个枚举值:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;queryOrdersByStatusListClient&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">queryOrdersByStatusListClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">StatusEnumClient</span><span class="token punctuation">&gt;</span></span> request <span class="token operator">=</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span><span class="token class-name">StatusEnumClient</span><span class="token punctuation">.</span><span class="token constant">CREATED</span><span class="token punctuation">,</span> <span class="token class-name">StatusEnumClient</span><span class="token punctuation">.</span><span class="token constant">PAID</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">HttpEntity</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">StatusEnumClient</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> entity <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HttpEntity</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">HttpHeaders</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">StatusEnumClient</span><span class="token punctuation">&gt;</span></span> response <span class="token operator">=</span> restTemplate<span class="token punctuation">.</span><span class="token function">exchange</span><span class="token punctuation">(</span><span class="token string">&quot;http://localhost:45678/enumusedinapi/queryOrdersByStatusList&quot;</span><span class="token punctuation">,</span>
            <span class="token class-name">HttpMethod</span><span class="token punctuation">.</span><span class="token constant">POST</span><span class="token punctuation">,</span> entity<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">ParameterizedTypeReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">StatusEnumClient</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;result {}&quot;</span><span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>请求接口可以看到, 传入的是 CREATED 和 PAID, 返回的居然是 DELIVERED 和 FINISHED. 果然如标题所说, 一来一回你已不是原来的你:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token punctuation">[</span><span class="token number">22</span><span class="token operator">:</span><span class="token number">03</span><span class="token operator">:</span><span class="token number">03.579</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>http<span class="token operator">-</span>nio<span class="token operator">-</span><span class="token number">45678</span><span class="token operator">-</span>exec<span class="token operator">-</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token constant">INFO</span> <span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>g<span class="token punctuation">.</span>t<span class="token punctuation">.</span>c<span class="token punctuation">.</span>e<span class="token punctuation">.</span>e<span class="token punctuation">.</span></span>EnumUsedInAPIController</span><span class="token operator">:</span><span class="token number">34</span>  <span class="token punctuation">]</span> <span class="token operator">-</span> result <span class="token punctuation">[</span><span class="token constant">DELIVERED</span><span class="token punctuation">,</span> <span class="token constant">FINISHED</span><span class="token punctuation">,</span> <span class="token constant">UNKNOWN</span><span class="token punctuation">]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>出现这个问题的原因是, <strong>序列化走了 status 的值, 而反序列化并没有根据 status 来, 还是使用了枚举的 ordinal() 索引值</strong>. 这是 Jackson 至今(2.10)没有解决的 Bug, 应该会在 2.11 解决.</p> <p>如下图所示, 调用服务端接口, 传入一个不存在的 status 值 0, 也能反序列化成功, 最后服务端的返回是 1:</p> <p><img src="/img/bfb118578a0a5bc1e8da7a9d8c9fe283-20230731165210-ee3tlmp.png" alt=""></p> <p>有一个解决办法是, 设置  <strong>@JsonCreator 来强制反序列化时使用自定义的工厂方法</strong>, 可以实现使用枚举的 status 字段来取值. 我们把这段代码加在 StatusEnumServer 枚举类中:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@JsonCreator</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">StatusEnumServer</span> <span class="token function">parse</span><span class="token punctuation">(</span><span class="token class-name">Object</span> o<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token class-name">StatusEnumServer</span><span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>value<span class="token operator">-&gt;</span>o<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>value<span class="token punctuation">.</span>status<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">findFirst</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">orElse</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>要特别注意的是, 同样要为 StatusEnumClient 也添加相应的方法. 因为除了服务端接口接收 StatusEnumServer 参数涉及一次反序列化外, 从服务端返回值转换为 List 还会有一次反序列化:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@JsonCreator</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">StatusEnumClient</span> <span class="token function">parse</span><span class="token punctuation">(</span><span class="token class-name">Object</span> o<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token class-name">StatusEnumClient</span><span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>value <span class="token operator">-&gt;</span> o<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>value<span class="token punctuation">.</span>status<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">findFirst</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">orElse</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>重新调用接口发现, 虽然结果正确了, 但是服务端不存在的枚举值 CANCELED 被设置为了 null, 而不是 @JsonEnumDefaultValue 设置的 UNKNOWN.</p> <p>这个问题, 之前已经通过设置 @JsonEnumDefaultValue 注解解决了, 但现在又出现了:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token punctuation">[</span><span class="token number">22</span><span class="token operator">:</span><span class="token number">20</span><span class="token operator">:</span><span class="token number">13.727</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>http<span class="token operator">-</span>nio<span class="token operator">-</span><span class="token number">45678</span><span class="token operator">-</span>exec<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token constant">INFO</span> <span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>g<span class="token punctuation">.</span>t<span class="token punctuation">.</span>c<span class="token punctuation">.</span>e<span class="token punctuation">.</span>e<span class="token punctuation">.</span></span>EnumUsedInAPIController</span><span class="token operator">:</span><span class="token number">34</span>  <span class="token punctuation">]</span> <span class="token operator">-</span> result <span class="token punctuation">[</span><span class="token constant">CREATED</span><span class="token punctuation">,</span> <span class="token constant">PAID</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>原因也很简单, 自定义的 parse 方法实现的是找不到枚举值时返回 null.</p> <p>为彻底解决这个问题, 并避免通过 @JsonCreator 在枚举中自定义一个非常复杂的工厂方法, 可以实现一个自定义的反序列化器. 这段代码比较复杂, 我特意加了详细的注释:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">class</span> <span class="token class-name">EnumDeserializer</span> <span class="token keyword">extends</span> <span class="token class-name">JsonDeserializer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Enum</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">implements</span>
        <span class="token class-name">ContextualDeserializer</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Enum</span><span class="token punctuation">&gt;</span></span> targetClass<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">EnumDeserializer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">EnumDeserializer</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Enum</span><span class="token punctuation">&gt;</span></span> targetClass<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>targetClass <span class="token operator">=</span> targetClass<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Enum</span> <span class="token function">deserialize</span><span class="token punctuation">(</span><span class="token class-name">JsonParser</span> p<span class="token punctuation">,</span> <span class="token class-name">DeserializationContext</span> ctxt<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 找枚举中带有@JsonValue注解的字段, 这是我们反序列化的基准字段</span>
        <span class="token class-name">Optional</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Field</span><span class="token punctuation">&gt;</span></span> valueFieldOpt <span class="token operator">=</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span>targetClass<span class="token punctuation">.</span><span class="token function">getDeclaredFields</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>m <span class="token operator">-&gt;</span> m<span class="token punctuation">.</span><span class="token function">isAnnotationPresent</span><span class="token punctuation">(</span><span class="token class-name">JsonValue</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">findFirst</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>valueFieldOpt<span class="token punctuation">.</span><span class="token function">isPresent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">Field</span> valueField <span class="token operator">=</span> valueFieldOpt<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>valueField<span class="token punctuation">.</span><span class="token function">isAccessible</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                valueField<span class="token punctuation">.</span><span class="token function">setAccessible</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// 遍历枚举项, 查找字段的值等于反序列化的字符串的那个枚举项</span>
            <span class="token keyword">return</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span>targetClass<span class="token punctuation">.</span><span class="token function">getEnumConstants</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>e <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span> valueField<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span><span class="token function">getValueAsString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    ex<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">findFirst</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">orElseGet</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span>targetClass<span class="token punctuation">.</span><span class="token function">getEnumConstants</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>e <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
                <span class="token comment">// 如果找不到, 就需要寻找默认枚举值来替代, 同样遍历所有枚举项, 查找@JsonEnumDefaultValue注解标识的枚举项</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span> targetClass<span class="token punctuation">.</span><span class="token function">getField</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isAnnotationPresent</span><span class="token punctuation">(</span><span class="token class-name">JsonEnumDefaultValue</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    ex<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">findFirst</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">orElse</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">JsonDeserializer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> <span class="token function">createContextual</span><span class="token punctuation">(</span><span class="token class-name">DeserializationContext</span> ctxt<span class="token punctuation">,</span>
                                                <span class="token class-name">BeanProperty</span> property<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">JsonMappingException</span> <span class="token punctuation">{</span>
        targetClass <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Enum</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span> ctxt<span class="token punctuation">.</span><span class="token function">getContextualType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getRawClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">EnumDeserializer</span><span class="token punctuation">(</span>targetClass<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br></div></div><p>然后, 把这个<strong>自定义反序列化器注册到 Jackson 中</strong>:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Bean</span>
<span class="token keyword">public</span> <span class="token class-name">Module</span> <span class="token function">enumModule</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">SimpleModule</span> <span class="token keyword">module</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SimpleModule</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">module</span><span class="token punctuation">.</span><span class="token function">addDeserializer</span><span class="token punctuation">(</span><span class="token class-name">Enum</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">EnumDeserializer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">module</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>第二个大坑终于被完美地解决了:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token punctuation">[</span><span class="token number">22</span><span class="token operator">:</span><span class="token number">32</span><span class="token operator">:</span><span class="token number">28.327</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>http<span class="token operator">-</span>nio<span class="token operator">-</span><span class="token number">45678</span><span class="token operator">-</span>exec<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token constant">INFO</span> <span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>g<span class="token punctuation">.</span>t<span class="token punctuation">.</span>c<span class="token punctuation">.</span>e<span class="token punctuation">.</span>e<span class="token punctuation">.</span></span>EnumUsedInAPIController</span><span class="token operator">:</span><span class="token number">34</span>  <span class="token punctuation">]</span> <span class="token operator">-</span> result <span class="token punctuation">[</span><span class="token constant">CREATED</span><span class="token punctuation">,</span> <span class="token constant">PAID</span><span class="token punctuation">,</span> <span class="token constant">UNKNOWN</span><span class="token punctuation">]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>这样做虽然解决了序列化反序列化使用枚举中自定义字段的问题, 也解决了找不到枚举值时使用默认值的问题, 但解决方案很复杂. 因此还是<strong>建议在 DTO 中直接使用 int 或 String 等简单的数据类型, 而不是使用枚举再配合各种复杂的序列化配置, 来实现枚举到枚举中字段的映射, 会更加清晰明了</strong>.</p> <h5 id="重点回顾-15"><a href="#重点回顾-15" class="header-anchor">#</a> 重点回顾</h5> <p>今天基于 Redis 和 Web API 的入参和出参两个场景, 介绍了序列化和反序列化时需要避开的几个坑.</p> <p>第一, 要确保序列化和反序列化算法的一致性. 因为不同序列化算法输出必定不同, 要正确处理序列化后的数据就要使用相同的反序列化算法.</p> <p>第二, Jackson 有大量的序列化和反序列化特性, 可以用来微调序列化和反序列化的细节. 需要注意的是, 如果自定义 ObjectMapper 的 Bean, 小心不要和 Spring Boot 自动配置的 Bean 冲突.</p> <p>第三, 在调试序列化反序列化问题时, 一定要捋清楚三点: <strong>是哪个组件在做序列化反序列化, 整个过程有几次序列化反序列化, 以及目前到底是序列化还是反序列化</strong>.</p> <p>第四, 对于反序列化默认情况下, 框架调用的是无参构造方法, 如果要调用自定义的有参构造方法, 那么需要告知框架如何调用. 更合理的方式是, 对于需要序列化的 POJO 考虑尽量不要自定义构造方法.</p> <p>第五, 枚举不建议定义在 DTO 中跨服务传输, 因为会有版本问题, 并且涉及序列化反序列化时会很复杂, 容易出错. 因此只建议在程序内部使用枚举.</p> <p>最后还有一点需要注意, 如果需要跨平台使用序列化的数据, 那么除了两端使用的算法要一致外, 还可能会遇到不同语言对数据类型的兼容问题. 这也是经常踩坑的一个地方.</p> <h4 id="_16-用好java-8的日期时间类-少踩一些-老三样-的坑"><a href="#_16-用好java-8的日期时间类-少踩一些-老三样-的坑" class="header-anchor">#</a> 16-用好Java 8的日期时间类,少踩一些&quot;老三样&quot;的坑</h4> <p>今天来说说恼人的时间错乱问题.</p> <p>在 Java 8 之前, 处理日期时间需求时, 使用 Date, Calender 和 SimpleDateFormat, 来声明时间戳, 使用日历处理日期和格式化解析日期时间. 但这些类的 API 的缺点比较明显, 比如可读性差, 易用性差, 使用起来冗余繁琐, 还有线程安全问题.</p> <p>因此, Java 8 推出了新的日期时间类. 每一个类功能明确清晰, 类之间协作简单, API 定义清晰不踩坑, API 功能强大无需借助外部工具类即可完成操作, 并且线程安全.</p> <p>但 Java 8 刚推出的时候, 诸如序列化, 数据访问等类库都还不支持 Java 8 的日期时间类型, 需要在新老类中来回转换. 比如, 在业务逻辑层使用 LocalDateTime, 存入数据库或者返回前端的时候还要切换回 Date. 因此, 很多同学还是选择使用老的日期时间类.</p> <p>现在几年时间过去了, 几乎所有的类库都支持了新日期时间类型, 使用起来也不会有来回切换等问题了. 但很多代码中因为还是用的遗留的日期时间类, 因此出现了很多时间错乱的错误实践. 比如, 试图通过随意修改时区, 使读取到的数据匹配当前时钟; 再比如, 试图直接对读取到的数据做加, 减几个小时的操作, 来 &quot;修正数据&quot;.</p> <p>今天就重点分析下<strong>时间错乱问题背后的原因</strong>, 看看使用遗留的日期时间类, 来处理日期时间初始化, 格式化, 解析, 计算等可能会遇到的问题, 以及如何使用新日期时间类来解决.</p> <h5 id="初始化日期时间"><a href="#初始化日期时间" class="header-anchor">#</a> 初始化日期时间</h5> <p>先从日期时间的初始化看起. 如果要初始化一个 2019 年 12 月 31 日 11 点 12 分 13 秒这样的时间, 可以使用下面的两行代码吗?</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">Date</span> date <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token number">2019</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">,</span> <span class="token number">31</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">,</span> <span class="token number">13</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>date<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>可以看到, 输出的时间是 3029 年 1 月 31 日 11 点 12 分 13 秒:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">Sat</span> <span class="token class-name">Jan</span> <span class="token number">31</span> <span class="token number">11</span><span class="token operator">:</span><span class="token number">12</span><span class="token operator">:</span><span class="token number">13</span> <span class="token constant">CST</span> <span class="token number">3920</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>相信看到这里, 你会说这是新手才会犯的低级错误: 年应该是和 1900 的差值, 月应该是从 0 到 11 而不是从 1 到 12.</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">Date</span> date <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token number">2019</span> <span class="token operator">-</span> <span class="token number">1900</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">,</span> <span class="token number">31</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">,</span> <span class="token number">13</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>没错, 但更重要的问题是, 当有<strong>国际化需求时, 需要使用 Calendar 类来初始化时间</strong>.</p> <p>使用 Calendar 改造之后, 初始化时年参数直接使用当前年即可, 不过月需要注意是从 0 到 11. 当然, 也可以直接使用 Calendar.DECEMBER 来初始化月份, 更不容易犯错. 为了说明时区的问题, 分别使用当前时区和纽约时区初始化了两次相同的日期:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">Calendar</span> calendar <span class="token operator">=</span> <span class="token class-name">Calendar</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
calendar<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token number">2019</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">,</span> <span class="token number">31</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">,</span> <span class="token number">13</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>calendar<span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">Calendar</span> calendar2 <span class="token operator">=</span> <span class="token class-name">Calendar</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token class-name">TimeZone</span><span class="token punctuation">.</span><span class="token function">getTimeZone</span><span class="token punctuation">(</span><span class="token string">&quot;America/New_York&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
calendar2<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token number">2019</span><span class="token punctuation">,</span> <span class="token class-name">Calendar</span><span class="token punctuation">.</span><span class="token constant">DECEMBER</span><span class="token punctuation">,</span> <span class="token number">31</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">,</span> <span class="token number">13</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>calendar2<span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>输出显示了两个时间, 说明时区产生了作用. 但大家更习惯年/月/日 时:分:秒这样的日期时间格式, 对现在输出的日期格式还不满意:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">Tue</span> <span class="token class-name">Dec</span> <span class="token number">31</span> <span class="token number">11</span><span class="token operator">:</span><span class="token number">12</span><span class="token operator">:</span><span class="token number">13</span> <span class="token constant">CST</span> <span class="token number">2019</span>
<span class="token class-name">Wed</span> <span class="token class-name">Jan</span> <span class="token number">01</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">12</span><span class="token operator">:</span><span class="token number">13</span> <span class="token constant">CST</span> <span class="token number">2020</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>那时区的问题是怎么回事, 又怎么格式化需要输出的日期时间呢? 接下来就逐一分析下这两个问题.</p> <h5 id="恼人-的时区问题"><a href="#恼人-的时区问题" class="header-anchor">#</a> &quot;恼人&quot;的时区问题</h5> <p>全球有 24 个时区, 同一个时刻不同时区(比如中国上海和美国纽约)的时间是不一样的. 对于需要全球化的项目, 如果初始化时间时没有提供时区, 那就不是一个真正意义上的时间, 只能认为是我看到的当前时间的一个表示.</p> <p>关于 Date 类, 要有两点认识:</p> <ol><li>一是, <strong>Date 并无时区问题, 世界上任何一台计算机使用 new Date() 初始化得到的时间都一样</strong>. 因为, Date 中保存的是 UTC 时间, UTC 是以原子钟为基础的统一时间, 不以太阳参照计时, 并无时区划分.</li> <li>二是, <strong>Date 中保存的是一个时间戳, 代表的是从 1970 年 1 月 1 日 0 点(Epoch 时间)到现在的毫秒数</strong>. 尝试输出 Date(0):</li></ol> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">TimeZone</span><span class="token punctuation">.</span><span class="token function">getDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getID</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> 
    <span class="token string">&quot;:&quot;</span> <span class="token operator">+</span> <span class="token class-name">TimeZone</span><span class="token punctuation">.</span><span class="token function">getDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getRawOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">3600</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>我得到的是 1970 年 1 月 1 日 8 点. 因为我机器当前的时区是中国上海, 相比 UTC 时差 +8 小时:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">Thu</span> <span class="token class-name">Jan</span> <span class="token number">01</span> <span class="token number">08</span><span class="token operator">:</span><span class="token number">00</span><span class="token operator">:</span><span class="token number">00</span> <span class="token constant">CST</span> <span class="token number">1970</span>
<span class="token class-name">Asia</span><span class="token operator">/</span><span class="token class-name">Shanghai</span><span class="token operator">:</span><span class="token number">8</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>对于国际化(世界各国的人都在使用)的项目, 处理好时间和时区问题首先就是要正确保存日期时间. 这里有两种保存方式:</p> <ol><li>方式一, 以 UTC 保存, 保存的时间没有时区属性, 是不涉及时区时间差问题的世界统一时间. 通常说的时间戳, 或 Java 中的 Date 类就是用的这种方式, 这也是推荐的方式.</li> <li>方式二, 以字面量保存, 比如年 / 月 / 日 时: 分: 秒, 一定要同时保存时区信息. 只有有了时区信息, 才能知道这个字面量时间真正的时间点, 否则它只是一个给人看的时间表示, 只在当前时区有意义. Calendar 是有时区概念的, 所以通过不同的时区初始化 Calendar, 得到了不同的时间.</li></ol> <p>正确保存日期时间之后, 就是正确展示, 即要使用正确的时区, 把时间点展示为符合当前时区的时间表示. 到这里, 就能理解为什么会有所谓的 &quot;时间错乱&quot; 问题了. 接下来再通过实际案例分析一下, 从字面量解析成时间和从时间格式化为字面量这两类问题.</p> <p><strong>第一类是</strong>, 对于同一个时间表示, 比如 2020-01-02 22:00:00, 不同时区的人转换成 Date 会得到不同的时间(时间戳):</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">String</span> stringDate <span class="token operator">=</span> <span class="token string">&quot;2020-01-02 22:00:00&quot;</span><span class="token punctuation">;</span>
<span class="token class-name">SimpleDateFormat</span> inputFormat <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SimpleDateFormat</span><span class="token punctuation">(</span><span class="token string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 默认时区解析时间表示</span>
<span class="token class-name">Date</span> date1 <span class="token operator">=</span> inputFormat<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>stringDate<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>date1 <span class="token operator">+</span> <span class="token string">&quot;:&quot;</span> <span class="token operator">+</span> date1<span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 纽约时区解析时间表示</span>
inputFormat<span class="token punctuation">.</span><span class="token function">setTimeZone</span><span class="token punctuation">(</span><span class="token class-name">TimeZone</span><span class="token punctuation">.</span><span class="token function">getTimeZone</span><span class="token punctuation">(</span><span class="token string">&quot;America/New_York&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Date</span> date2 <span class="token operator">=</span> inputFormat<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>stringDate<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>date2 <span class="token operator">+</span> <span class="token string">&quot;:&quot;</span> <span class="token operator">+</span> date2<span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>可以看到, 把 2020-01-02 22:00:00 这样的时间表示, 对于当前的上海时区和纽约时区, 转化为 UTC 时间戳是不同的时间:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">Thu</span> <span class="token class-name">Jan</span> <span class="token number">02</span> <span class="token number">22</span><span class="token operator">:</span><span class="token number">00</span><span class="token operator">:</span><span class="token number">00</span> <span class="token constant">CST</span> <span class="token number">2020</span><span class="token operator">:</span><span class="token number">1577973600000</span>
<span class="token class-name">Fri</span> <span class="token class-name">Jan</span> <span class="token number">03</span> <span class="token number">11</span><span class="token operator">:</span><span class="token number">00</span><span class="token operator">:</span><span class="token number">00</span> <span class="token constant">CST</span> <span class="token number">2020</span><span class="token operator">:</span><span class="token number">1578020400000</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>这正是 UTC 的意义, 并不是时间错乱. 对于同一个本地时间的表示, 不同时区的人解析得到的 UTC 时间一定是不同的, 反过来不同的本地时间可能对应同一个 UTC.</p> <p><strong>第二类问题是</strong>, 格式化后出现的错乱, 即同一个 Date, 在不同的时区下格式化得到不同的时间表示. 比如, 在我的当前时区和纽约时区格式化 2020-01-02 22:00:00:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">String</span> stringDate <span class="token operator">=</span> <span class="token string">&quot;2020-01-02 22:00:00&quot;</span><span class="token punctuation">;</span>
<span class="token class-name">SimpleDateFormat</span> inputFormat <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SimpleDateFormat</span><span class="token punctuation">(</span><span class="token string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 同一Date</span>
<span class="token class-name">Date</span> date <span class="token operator">=</span> inputFormat<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>stringDate<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 默认时区格式化输出: </span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">SimpleDateFormat</span><span class="token punctuation">(</span><span class="token string">&quot;[yyyy-MM-dd HH:mm:ss Z]&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span>date<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 纽约时区格式化输出</span>
<span class="token class-name">TimeZone</span><span class="token punctuation">.</span><span class="token function">setDefault</span><span class="token punctuation">(</span><span class="token class-name">TimeZone</span><span class="token punctuation">.</span><span class="token function">getTimeZone</span><span class="token punctuation">(</span><span class="token string">&quot;America/New_York&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">SimpleDateFormat</span><span class="token punctuation">(</span><span class="token string">&quot;[yyyy-MM-dd HH:mm:ss Z]&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span>date<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>输出如下, 当前时区的 Offset(时差)是 +8 小时, 对于 -5 小时的纽约, 晚上 10 点对应早上 9 点:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token punctuation">[</span><span class="token number">2020</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">02</span> <span class="token number">22</span><span class="token operator">:</span><span class="token number">00</span><span class="token operator">:</span><span class="token number">00</span> <span class="token operator">+</span><span class="token number">0800</span><span class="token punctuation">]</span>
<span class="token punctuation">[</span><span class="token number">2020</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">02</span> <span class="token number">09</span><span class="token operator">:</span><span class="token number">00</span><span class="token operator">:</span><span class="token number">00</span> <span class="token operator">-</span><span class="token number">0500</span><span class="token punctuation">]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>因此, 有些时候数据库中相同的时间, <strong>由于服务器的时区设置不同, 读取到的时间表示不同</strong>. 这不是时间错乱, 正是时区发挥了作用, 因为 UTC 时间需要根据当前时区解析为正确的本地时间.</p> <p>所以, <strong>要正确处理时区, 在于存进去和读出来两方面</strong>: 存的时候, 需要使用正确的当前时区来保存, 这样 UTC 时间才会正确; 读的时候, 也只有正确设置本地时区, 才能把 UTC 时间转换为正确的当地时间.</p> <p>Java 8 推出了新的时间日期类 ZoneId, ZoneOffset, LocalDateTime, ZonedDateTime 和 DateTimeFormatter, 处理时区问题更简单清晰. 再用这些类配合一个完整的例子, 来理解一下时间的解析和展示:</p> <ol><li>首先初始化上海, 纽约和东京三个时区. 可以使用 <strong>ZoneId.of 来初始化一个标准的时区</strong>, 也可以使用 ZoneOffset.ofHours 通过一个 offset, 来初始化一个具有指定时间差的自定义时区.</li> <li>对于<strong>日期时间</strong>表示, <strong>LocalDateTime 不带有时区属性, 所以命名为本地时区的日期时间</strong>; 而 <code>ZonedDateTime = LocalDateTime + ZoneId</code>​, 具有时区属性. 因此, LocalDateTime 只能认为是一个时间表示, ZonedDateTime 才是一个有效的时间. 在这里把 2020-01-02 22:00:00 这个时间表示, 使用东京时区来解析得到一个 ZonedDateTime.</li> <li>使用 DateTimeFormatter 格式化时间的时候, 可以<strong>直接通过 withZone 方法直接设置格式化使用的时区</strong>. 最后, 分别以上海, 纽约和东京三个时区来格式化这个时间输出:</li></ol> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// 一个时间表示</span>
<span class="token class-name">String</span> stringDate <span class="token operator">=</span> <span class="token string">&quot;2020-01-02 22:00:00&quot;</span><span class="token punctuation">;</span>

<span class="token comment">// 初始化三个时区</span>
<span class="token class-name">ZoneId</span> timeZoneSH <span class="token operator">=</span> <span class="token class-name">ZoneId</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token string">&quot;Asia/Shanghai&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">ZoneId</span> timeZoneNY <span class="token operator">=</span> <span class="token class-name">ZoneId</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token string">&quot;America/New_York&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">ZoneId</span> timeZoneJST <span class="token operator">=</span> <span class="token class-name">ZoneOffset</span><span class="token punctuation">.</span><span class="token function">ofHours</span><span class="token punctuation">(</span><span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 格式化器</span>
<span class="token class-name">DateTimeFormatter</span> dateTimeFormatter <span class="token operator">=</span> <span class="token class-name">DateTimeFormatter</span><span class="token punctuation">.</span><span class="token function">ofPattern</span><span class="token punctuation">(</span><span class="token string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">ZonedDateTime</span> date <span class="token operator">=</span> <span class="token class-name">ZonedDateTime</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>stringDate<span class="token punctuation">,</span> dateTimeFormatter<span class="token punctuation">)</span><span class="token punctuation">,</span> timeZoneJST<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 使用DateTimeFormatter格式化时间, 可以通过withZone方法直接设置格式化使用的时区</span>
<span class="token class-name">DateTimeFormatter</span> outputFormat <span class="token operator">=</span> <span class="token class-name">DateTimeFormatter</span><span class="token punctuation">.</span><span class="token function">ofPattern</span><span class="token punctuation">(</span><span class="token string">&quot;yyyy-MM-dd HH:mm:ss Z&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>timeZoneSH<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> outputFormat<span class="token punctuation">.</span><span class="token function">withZone</span><span class="token punctuation">(</span>timeZoneSH<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span>date<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>timeZoneNY<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> outputFormat<span class="token punctuation">.</span><span class="token function">withZone</span><span class="token punctuation">(</span>timeZoneNY<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span>date<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>timeZoneJST<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> outputFormat<span class="token punctuation">.</span><span class="token function">withZone</span><span class="token punctuation">(</span>timeZoneJST<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span>date<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>可以看到, 相同的时区, 经过解析存进去和读出来的时间表示是一样的(比如最后一行); 而对于不同的时区, 比如上海和纽约, 最后输出的本地时间不同. +9 小时时区的晚上 10 点, 对于上海是 +8 小时, 所以上海本地时间是晚上 9 点; 而对于纽约是 -5 小时, 差 14 小时, 所以是早上 8 点:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">Asia</span><span class="token operator">/</span><span class="token class-name">Shanghai2020</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">02</span> <span class="token number">21</span><span class="token operator">:</span><span class="token number">00</span><span class="token operator">:</span><span class="token number">00</span> <span class="token operator">+</span><span class="token number">0800</span>
<span class="token class-name">America</span><span class="token operator">/</span><span class="token class-name">New_York2020</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">02</span> <span class="token number">08</span><span class="token operator">:</span><span class="token number">00</span><span class="token operator">:</span><span class="token number">00</span> <span class="token operator">-</span><span class="token number">0500</span>
<span class="token operator">+</span><span class="token number">09</span><span class="token operator">:</span><span class="token number">002020</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">02</span> <span class="token number">22</span><span class="token operator">:</span><span class="token number">00</span><span class="token operator">:</span><span class="token number">00</span> <span class="token operator">+</span><span class="token number">0900</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>到这里来小结下. 要正确处理国际化时间问题, 推荐<strong>使用 Java 8 的日期时间类, 即使用 ZonedDateTime 保存时间, 然后使用设置了 ZoneId 的 DateTimeFormatter 配合 ZonedDateTime 进行时间格式化得到本地时间表示</strong>. 这样的划分十分清晰, 细化, 也不容易出错.</p> <p>接下来, 继续看看对于日期时间的格式化和解析, 使用遗留的 SimpleDateFormat, 会遇到哪些问题.</p> <h5 id="日期时间格式化和解析"><a href="#日期时间格式化和解析" class="header-anchor">#</a> 日期时间格式化和解析</h5> <p>每到年底, 就有很多开发同学踩时间格式化的坑, 比如 &quot;这明明是一个 2019 年的日期, <strong>怎么使用 SimpleDateFormat 格式化后就提前跨年了</strong>&quot;. 来重现一个这个问题.</p> <p>初始化一个 Calendar, 设置日期时间为 2019 年 12 月 29 日, 使用大写的 YYYY 来初始化 SimpleDateFormat:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">Locale</span><span class="token punctuation">.</span><span class="token function">setDefault</span><span class="token punctuation">(</span><span class="token class-name">Locale</span><span class="token punctuation">.</span><span class="token constant">SIMPLIFIED_CHINESE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;defaultLocale:&quot;</span> <span class="token operator">+</span> <span class="token class-name">Locale</span><span class="token punctuation">.</span><span class="token function">getDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Calendar</span> calendar <span class="token operator">=</span> <span class="token class-name">Calendar</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
calendar<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token number">2019</span><span class="token punctuation">,</span> <span class="token class-name">Calendar</span><span class="token punctuation">.</span><span class="token constant">DECEMBER</span><span class="token punctuation">,</span> <span class="token number">29</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">SimpleDateFormat</span> <span class="token constant">YYYY</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SimpleDateFormat</span><span class="token punctuation">(</span><span class="token string">&quot;YYYY-MM-dd&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;格式化: &quot;</span> <span class="token operator">+</span> <span class="token constant">YYYY</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span>calendar<span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;weekYear:&quot;</span> <span class="token operator">+</span> calendar<span class="token punctuation">.</span><span class="token function">getWeekYear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;firstDayOfWeek:&quot;</span> <span class="token operator">+</span> calendar<span class="token punctuation">.</span><span class="token function">getFirstDayOfWeek</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;minimalDaysInFirstWeek:&quot;</span> <span class="token operator">+</span> calendar<span class="token punctuation">.</span><span class="token function">getMinimalDaysInFirstWeek</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>得到的输出却是 2020 年 12 月 29 日:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>defaultLocale<span class="token operator">:</span>zh_CN
格式化<span class="token operator">:</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">12</span><span class="token operator">-</span><span class="token number">29</span>
weekYear<span class="token operator">:</span><span class="token number">2020</span>
firstDayOfWeek<span class="token operator">:</span><span class="token number">1</span>
minimalDaysInFirstWeek<span class="token operator">:</span><span class="token number">1</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>出现这个问题的原因在于, 这位同学混淆了 SimpleDateFormat 的各种格式化模式. JDK 的文档中有说明: 小写 y 是年, 而大写 Y 是 week year, 也就是所在的周属于哪一年.</p> <p>一年第一周的判断方式是, 从 getFirstDayOfWeek() 开始, 完整的 7 天, 并且包含那一年至少 getMinimalDaysInFirstWeek() 天. 这个计算方式和区域相关, 对于当前 zh_CN 区域来说, 2020 年第一周的条件是, 从周日开始的完整 7 天, 2020 年包含 1 天即可. 显然, 2019 年 12 月 29 日周日到 2020 年 1 月 4 日周六是 2020 年第一周, 得出的 week year 就是 2020 年.</p> <p>如果把区域改为法国:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">Locale</span><span class="token punctuation">.</span><span class="token function">setDefault</span><span class="token punctuation">(</span><span class="token class-name">Locale</span><span class="token punctuation">.</span><span class="token constant">FRANCE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>那么 week yeay 就还是 2019 年, 因为一周的第一天从周一开始算, 2020 年的第一周是 2019 年 12 月 30 日周一开始, 29 日还是属于去年:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>defaultLocale<span class="token operator">:</span>fr_FR
格式化<span class="token operator">:</span> <span class="token number">2019</span><span class="token operator">-</span><span class="token number">12</span><span class="token operator">-</span><span class="token number">29</span>
weekYear<span class="token operator">:</span><span class="token number">2019</span>
firstDayOfWeek<span class="token operator">:</span><span class="token number">2</span>
minimalDaysInFirstWeek<span class="token operator">:</span><span class="token number">4</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>这个案例告诉我们, 没有特殊需求, <strong>针对年份的日期格式化, 应该一律使用 &quot;y&quot; 而非 &quot;Y&quot;</strong> .</p> <p>除了格式化表达式容易踩坑外, SimpleDateFormat 还有两个著名的坑.</p> <p>第一个坑是, **定义的 static 的 SimpleDateFormat 可能会出现线程安全问题. **比如像这样, 使用一个 100 线程的线程池, 循环 20 次把时间格式化任务提交到线程池处理, 每个任务中又循环 10 次解析 2020-01-01 11:12:13 这样一个时间表示:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">ExecutorService</span> threadPool <span class="token operator">=</span> <span class="token class-name">Executors</span><span class="token punctuation">.</span><span class="token function">newFixedThreadPool</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">20</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 提交20个并发解析时间的任务到线程池, 模拟并发环境</span>
    threadPool<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>simpleDateFormat<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token string">&quot;2020-01-01 11:12:13&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ParseException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

threadPool<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
threadPool<span class="token punctuation">.</span><span class="token function">awaitTermination</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">HOURS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>运行程序后<strong>大量报错</strong>, 且没有报错的输出结果也不正常, 比如 2020 年解析成了 1212 年:</p> <p><img src="/img/88b0c1a437f4135ebe73a4fdebb439f1-20230731165210-ktxoemc.png" alt=""></p> <p>SimpleDateFormat 的作用是定义解析和格式化日期时间的模式. 这看起来这是一次性的工作, 应该复用, 但它的<strong>解析和格式化操作是非线程安全的</strong>. 来分析一下相关源码:</p> <ol><li>SimpleDateFormat 继承了 DateFormat, DateFormat 有一个字段 Calendar;</li> <li>SimpleDateFormat 的 parse 方法调用 CalendarBuilder 的 establish 方法, 来构建 Calendar;</li> <li><strong>establish 方法内部先清空 Calendar 再构建 Calendar, 整个操作没有加锁</strong>.</li></ol> <p>显然, 如果多线程池调用 parse 方法, 也就意味着<strong>多线程在并发操作一个 Calendar, 可能会产生一个线程还没来得及处理 Calendar 就被另一个线程清空了的情况</strong>:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">DateFormat</span> <span class="token keyword">extends</span> <span class="token class-name">Format</span> <span class="token punctuation">{</span>
    <span class="token keyword">protected</span> <span class="token class-name">Calendar</span> calendar<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SimpleDateFormat</span> <span class="token keyword">extends</span> <span class="token class-name">DateFormat</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Date</span> <span class="token function">parse</span><span class="token punctuation">(</span><span class="token class-name">String</span> text<span class="token punctuation">,</span> <span class="token class-name">ParsePosition</span> pos<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">CalendarBuilder</span> calb <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CalendarBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        parsedDate <span class="token operator">=</span> calb<span class="token punctuation">.</span><span class="token function">establish</span><span class="token punctuation">(</span>calendar<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> parsedDate<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">CalendarBuilder</span> <span class="token punctuation">{</span>
  <span class="token class-name">Calendar</span> <span class="token function">establish</span><span class="token punctuation">(</span><span class="token class-name">Calendar</span> cal<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// ...</span>
        cal<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 清空</span>
  
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> stamp <span class="token operator">=</span> <span class="token constant">MINIMUM_USER_STAMP</span><span class="token punctuation">;</span> stamp <span class="token operator">&lt;</span> nextStamp<span class="token punctuation">;</span> stamp<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> index <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> index <span class="token operator">&lt;=</span> maxFieldIndex<span class="token punctuation">;</span> index<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>field<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">==</span> stamp<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    cal<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span> field<span class="token punctuation">[</span><span class="token constant">MAX_FIELD</span> <span class="token operator">+</span> index<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 构建</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> cal<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br></div></div><p>format 方法也类似, 可以自己分析. 因此<strong>只能在同一个线程复用 SimpleDateFormat</strong>, 比较好的解决方式是, <mark><strong>通过 ThreadLocal 来存放 SimpleDateFormat</strong></mark>:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SimpleDateFormat</span><span class="token punctuation">&gt;</span></span> threadSafeSimpleDateFormat 
        <span class="token operator">=</span> <span class="token class-name">ThreadLocal</span><span class="token punctuation">.</span><span class="token function">withInitial</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token keyword">new</span> <span class="token class-name">SimpleDateFormat</span><span class="token punctuation">(</span><span class="token string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>第二个坑是, <strong>当需要解析的字符串和格式不匹配的时候, SimpleDateFormat 表现得很宽容</strong>, 还是能得到结果. 比如, 我们期望使用 yyyyMM 来解析 20160901 字符串:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">String</span> dateString <span class="token operator">=</span> <span class="token string">&quot;20160901&quot;</span><span class="token punctuation">;</span>
<span class="token class-name">SimpleDateFormat</span> dateFormat <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SimpleDateFormat</span><span class="token punctuation">(</span><span class="token string">&quot;yyyyMM&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;result:&quot;</span> <span class="token operator">+</span> dateFormat<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>dateString<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>居然输出了 2091 年 1 月 1 日, 原因是把 0901 当成了月份, 相当于 75 年:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>result<span class="token operator">:</span><span class="token class-name">Mon</span> <span class="token class-name">Jan</span> <span class="token number">01</span> <span class="token number">00</span><span class="token operator">:</span><span class="token number">00</span><span class="token operator">:</span><span class="token number">00</span> <span class="token constant">CST</span> <span class="token number">2091</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>对于 SimpleDateFormat 的这三个坑, 使用 Java 8 中的 <strong>DateTimeFormatter</strong> 就可以避过去. 首先, 使用 DateTimeFormatterBuilder 来定义格式化字符串, 不用去记忆使用大写的 Y 还是小写的 Y, 大写的 M 还是小写的 m:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">DateTimeFormatter</span> dateTimeFormatter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DateTimeFormatterBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">appendValue</span><span class="token punctuation">(</span><span class="token class-name">ChronoField</span><span class="token punctuation">.</span><span class="token constant">YEAR</span><span class="token punctuation">)</span> <span class="token comment">// 年</span>
    <span class="token punctuation">.</span><span class="token function">appendLiteral</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">appendValue</span><span class="token punctuation">(</span><span class="token class-name">ChronoField</span><span class="token punctuation">.</span><span class="token constant">MONTH_OF_YEAR</span><span class="token punctuation">)</span> <span class="token comment">// 月</span>
    <span class="token punctuation">.</span><span class="token function">appendLiteral</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">appendValue</span><span class="token punctuation">(</span><span class="token class-name">ChronoField</span><span class="token punctuation">.</span><span class="token constant">DAY_OF_MONTH</span><span class="token punctuation">)</span> <span class="token comment">// 日</span>
    <span class="token punctuation">.</span><span class="token function">appendLiteral</span><span class="token punctuation">(</span><span class="token string">&quot; &quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">appendValue</span><span class="token punctuation">(</span><span class="token class-name">ChronoField</span><span class="token punctuation">.</span><span class="token constant">HOUR_OF_DAY</span><span class="token punctuation">)</span> <span class="token comment">// 时</span>
    <span class="token punctuation">.</span><span class="token function">appendLiteral</span><span class="token punctuation">(</span><span class="token string">&quot;:&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">appendValue</span><span class="token punctuation">(</span><span class="token class-name">ChronoField</span><span class="token punctuation">.</span><span class="token constant">MINUTE_OF_HOUR</span><span class="token punctuation">)</span> <span class="token comment">// 分</span>
    <span class="token punctuation">.</span><span class="token function">appendLiteral</span><span class="token punctuation">(</span><span class="token string">&quot;:&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">appendValue</span><span class="token punctuation">(</span><span class="token class-name">ChronoField</span><span class="token punctuation">.</span><span class="token constant">SECOND_OF_MINUTE</span><span class="token punctuation">)</span> <span class="token comment">// 秒</span>
    <span class="token punctuation">.</span><span class="token function">appendLiteral</span><span class="token punctuation">(</span><span class="token string">&quot;.&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">appendValue</span><span class="token punctuation">(</span><span class="token class-name">ChronoField</span><span class="token punctuation">.</span><span class="token constant">MILLI_OF_SECOND</span><span class="token punctuation">)</span> <span class="token comment">// 毫秒</span>
    <span class="token punctuation">.</span><span class="token function">toFormatter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>其次, DateTimeFormatter 是<strong>线程安全</strong>的, 可以定义为 static 使用; 最后, DateTimeFormatter 的解析比较严格, 需要解析的字符串和格式不匹配时, 会直接报错, 而不会把 0901 解析为月份. 测试一下:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// 使用刚才定义的DateTimeFormatterBuilder构建的DateTimeFormatter来解析这个时间</span>
<span class="token class-name">LocalDateTime</span> localDateTime <span class="token operator">=</span> <span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token string">&quot;2020/1/2 12:34:56.789&quot;</span><span class="token punctuation">,</span> dateTimeFormatter<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 解析成功</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>localDateTime<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span>dateTimeFormatter<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 使用yyyyMM格式解析20160901是否可以成功呢? </span>
<span class="token class-name">String</span> dt <span class="token operator">=</span> <span class="token string">&quot;20160901&quot;</span><span class="token punctuation">;</span>
<span class="token class-name">DateTimeFormatter</span> dateTimeFormatter <span class="token operator">=</span> <span class="token class-name">DateTimeFormatter</span><span class="token punctuation">.</span><span class="token function">ofPattern</span><span class="token punctuation">(</span><span class="token string">&quot;yyyyMM&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;result:&quot;</span> <span class="token operator">+</span> dateTimeFormatter<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>dt<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>输出日志如下:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token number">2020</span><span class="token operator">/</span><span class="token number">1</span><span class="token operator">/</span><span class="token number">2</span> <span class="token number">12</span><span class="token operator">:</span><span class="token number">34</span><span class="token operator">:</span><span class="token number">56.789</span>
<span class="token class-name">Exception</span> in thread <span class="token string">&quot;main&quot;</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>time<span class="token punctuation">.</span>format<span class="token punctuation">.</span></span>DateTimeParseException</span><span class="token operator">:</span> <span class="token class-name">Text</span> '<span class="token number">20160901</span>' could not be parsed at index <span class="token number">0</span>
at <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>time<span class="token punctuation">.</span>format<span class="token punctuation">.</span></span>DateTimeFormatter</span><span class="token punctuation">.</span><span class="token function">parseResolved0</span><span class="token punctuation">(</span><span class="token class-name">DateTimeFormatter</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">1949</span><span class="token punctuation">)</span>
at <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>time<span class="token punctuation">.</span>format<span class="token punctuation">.</span></span>DateTimeFormatter</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token class-name">DateTimeFormatter</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">1777</span><span class="token punctuation">)</span>
at <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>geekbang<span class="token punctuation">.</span>time<span class="token punctuation">.</span>commonmistakes<span class="token punctuation">.</span>datetime<span class="token punctuation">.</span>dateformat<span class="token punctuation">.</span></span>CommonMistakesApplication</span><span class="token punctuation">.</span><span class="token function">better</span><span class="token punctuation">(</span><span class="token class-name">CommonMistakesApplication</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">80</span><span class="token punctuation">)</span>
at <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>geekbang<span class="token punctuation">.</span>time<span class="token punctuation">.</span>commonmistakes<span class="token punctuation">.</span>datetime<span class="token punctuation">.</span>dateformat<span class="token punctuation">.</span></span>CommonMistakesApplication</span><span class="token punctuation">.</span><span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">CommonMistakesApplication</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">41</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>到这里可以发现, <strong>使用 Java 8 中的 DateTimeFormatter 进行日期时间的格式化和解析, 显然更让人放心</strong>. 那么, 对于日期时间的运算, 使用 Java 8 中的日期时间类会不会更简单呢?</p> <h5 id="日期时间的计算"><a href="#日期时间的计算" class="header-anchor">#</a> 日期时间的计算</h5> <p>关于日期时间的计算, 先说一个常踩的坑. 有些同学喜欢直接使用时间戳进行时间计算, 比如希望得到当前时间之后 30 天的时间, 会这么写代码: 直接把 new Date().getTime 方法得到的时间戳加 30 天对应的毫秒数, 也就是 30 天 * 1000 毫秒 * 3600 秒 * 24 小时:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">Date</span> today <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Date</span> nextMonth <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span>today<span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">30</span> <span class="token operator">*</span> <span class="token number">1000</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">24</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>today<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>nextMonth<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>得到的日期居然比当前日期还要早, 根本不是晚 30 天的时间:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">Sat</span> <span class="token class-name">Feb</span> <span class="token number">01</span> <span class="token number">14</span><span class="token operator">:</span><span class="token number">17</span><span class="token operator">:</span><span class="token number">41</span> <span class="token constant">CST</span> <span class="token number">2020</span>
<span class="token class-name">Sun</span> <span class="token class-name">Jan</span> <span class="token number">12</span> <span class="token number">21</span><span class="token operator">:</span><span class="token number">14</span><span class="token operator">:</span><span class="token number">54</span> <span class="token constant">CST</span> <span class="token number">2020</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>出现这个问题, <strong>其实是因为 int 发生了溢出</strong>. 修复方式就是把 30 改为 30L, 让其成为一个 long:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">Date</span> today <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Date</span> nextMonth <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span>today<span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">30L</span> <span class="token operator">*</span> <span class="token number">1000</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">24</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>today<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>nextMonth<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>这样就可以得到正确结果了:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">Sat</span> <span class="token class-name">Feb</span> <span class="token number">01</span> <span class="token number">14</span><span class="token operator">:</span><span class="token number">17</span><span class="token operator">:</span><span class="token number">41</span> <span class="token constant">CST</span> <span class="token number">2020</span>
<span class="token class-name">Mon</span> <span class="token class-name">Mar</span> <span class="token number">02</span> <span class="token number">14</span><span class="token operator">:</span><span class="token number">17</span><span class="token operator">:</span><span class="token number">41</span> <span class="token constant">CST</span> <span class="token number">2020</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>不难发现, <strong>手动在时间戳上进行计算操作的方式非常容易出错</strong>. 对于 Java 8 之前的代码, 更建议使用 Calendar:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">Calendar</span> c <span class="token operator">=</span> <span class="token class-name">Calendar</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
c<span class="token punctuation">.</span><span class="token function">setTime</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
c<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">Calendar</span><span class="token punctuation">.</span><span class="token constant">DAY_OF_MONTH</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>使用 Java 8 的日期时间类型, 可以直接进行各种计算, 更加简洁和方便:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">LocalDateTime</span> localDateTime <span class="token operator">=</span> <span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>localDateTime<span class="token punctuation">.</span><span class="token function">plusDays</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>并且<strong>对日期时间做计算操作, Java 8 日期时间 API 会比 Calendar 功能强大很多</strong>.</p> <p>第一, 可以使用各种 minus 和 plus 方法直接<strong>对日期进行加减操作</strong>, 比如如下代码实现了减一天和加一天, 以及减一个月和加一个月:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;// 测试操作日期&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">LocalDate</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">minus</span><span class="token punctuation">(</span><span class="token class-name">Period</span><span class="token punctuation">.</span><span class="token function">ofDays</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">plus</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token class-name">ChronoUnit</span><span class="token punctuation">.</span><span class="token constant">DAYS</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">minusMonths</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">plus</span><span class="token punctuation">(</span><span class="token class-name">Period</span><span class="token punctuation">.</span><span class="token function">ofMonths</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>可以得到:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// 测试操作日期</span>
<span class="token number">2020</span><span class="token operator">-</span><span class="token number">02</span><span class="token operator">-</span><span class="token number">01</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>第二, 还可以通过 <strong>with 方法进行快捷时间调节</strong>, 比如:</p> <ol><li>使用 TemporalAdjusters.firstDayOfMonth 得到当前月的第一天;</li> <li>使用 TemporalAdjusters.firstDayOfYear() 得到当前年的第一天;</li> <li>使用 TemporalAdjusters.previous(DayOfWeek.SATURDAY) 得到上一个周六;</li> <li>使用 TemporalAdjusters.lastInMonth(DayOfWeek.FRIDAY) 得到本月最后一个周五.</li></ol> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;//本月的第一天&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">LocalDate</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">with</span><span class="token punctuation">(</span><span class="token class-name">TemporalAdjusters</span><span class="token punctuation">.</span><span class="token function">firstDayOfMonth</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;//今年的程序员日&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">LocalDate</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">with</span><span class="token punctuation">(</span><span class="token class-name">TemporalAdjusters</span><span class="token punctuation">.</span><span class="token function">firstDayOfYear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">plusDays</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;//今天之前的一个周六&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">LocalDate</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">with</span><span class="token punctuation">(</span><span class="token class-name">TemporalAdjusters</span><span class="token punctuation">.</span><span class="token function">previous</span><span class="token punctuation">(</span><span class="token class-name">DayOfWeek</span><span class="token punctuation">.</span><span class="token constant">SATURDAY</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;//本月最后一个工作日&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">LocalDate</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">with</span><span class="token punctuation">(</span><span class="token class-name">TemporalAdjusters</span><span class="token punctuation">.</span><span class="token function">lastInMonth</span><span class="token punctuation">(</span><span class="token class-name">DayOfWeek</span><span class="token punctuation">.</span><span class="token constant">FRIDAY</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>输出如下:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">//本月的第一天</span>
<span class="token number">2020</span><span class="token operator">-</span><span class="token number">02</span><span class="token operator">-</span><span class="token number">01</span>
<span class="token comment">//今年的程序员日</span>
<span class="token number">2020</span><span class="token operator">-</span><span class="token number">09</span><span class="token operator">-</span><span class="token number">12</span>
<span class="token comment">//今天之前的一个周六</span>
<span class="token number">2020</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">25</span>
<span class="token comment">//本月最后一个工作日</span>
<span class="token number">2020</span><span class="token operator">-</span><span class="token number">02</span><span class="token operator">-</span><span class="token number">28</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>第三, 可以直接使用 lambda 表达式进行自定义的时间调整. 比如, 为当前时间增加 100 天以内的随机天数:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">LocalDate</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">with</span><span class="token punctuation">(</span>temporal <span class="token operator">-&gt;</span> temporal<span class="token punctuation">.</span><span class="token function">plus</span><span class="token punctuation">(</span><span class="token class-name">ThreadLocalRandom</span><span class="token punctuation">.</span><span class="token function">current</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">ChronoUnit</span><span class="token punctuation">.</span><span class="token constant">DAYS</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>得到:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token number">2020</span><span class="token operator">-</span><span class="token number">03</span><span class="token operator">-</span><span class="token number">15</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>除了计算外, 还可以判断日期是否符合某个条件. 比如自定义函数, 判断指定日期是否是家庭成员的生日:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Boolean</span> <span class="token function">isFamilyBirthday</span><span class="token punctuation">(</span><span class="token class-name">TemporalAccessor</span> date<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> month <span class="token operator">=</span> date<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token constant">MONTH_OF_YEAR</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> day <span class="token operator">=</span> date<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token constant">DAY_OF_MONTH</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>month <span class="token generics"><span class="token punctuation">&lt;</span>mark<span class="token punctuation">&gt;</span></span> <span class="token class-name">Month</span><span class="token punctuation">.</span><span class="token constant">FEBRUARY</span><span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> day <span class="token operator">&lt;</span><span class="token operator">/</span>mark<span class="token operator">&gt;</span> <span class="token number">17</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token class-name">Boolean</span><span class="token punctuation">.</span><span class="token constant">TRUE</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>month <span class="token generics"><span class="token punctuation">&lt;</span>mark<span class="token punctuation">&gt;</span></span> <span class="token class-name">Month</span><span class="token punctuation">.</span><span class="token constant">SEPTEMBER</span><span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> day <span class="token operator">&lt;</span><span class="token operator">/</span>mark<span class="token operator">&gt;</span> <span class="token number">21</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token class-name">Boolean</span><span class="token punctuation">.</span><span class="token constant">TRUE</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>month <span class="token generics"><span class="token punctuation">&lt;</span>mark<span class="token punctuation">&gt;</span></span> <span class="token class-name">Month</span><span class="token punctuation">.</span><span class="token constant">MAY</span><span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> day <span class="token operator">&lt;</span><span class="token operator">/</span>mark<span class="token operator">&gt;</span> <span class="token number">22</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token class-name">Boolean</span><span class="token punctuation">.</span><span class="token constant">TRUE</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token class-name">Boolean</span><span class="token punctuation">.</span><span class="token constant">FALSE</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>然后, 使用 query 方法查询是否匹配条件:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;//查询是否是今天要举办生日&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">LocalDate</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token class-name">CommonMistakesApplication</span><span class="token operator">::</span><span class="token function">isFamilyBirthday</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>使用 Java 8 操作和计算日期时间虽然方便, 但计算两个日期差时可能会踩坑: <strong>Java 8 中有一个专门的类 Period 定义了日期间隔, 通过 Period.between 得到了两个 LocalDate 的差, 返回的是两个日期差几年零几月零几天. 如果希望得知两个日期之间差几天, 直接调用 Period 的 getDays() 方法得到的只是最后的 &quot;零几天&quot;, 而不是算总的间隔天数</strong>.</p> <p>比如, 计算 2019 年 12 月 12 日和 2019 年 10 月 1 日的日期间隔, 很明显日期差是 2 个月零 11 天, 但获取 getDays 方法得到的结果只是 11 天, 而不是 72 天:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;//计算日期差&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">LocalDate</span> today <span class="token operator">=</span> <span class="token class-name">LocalDate</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token number">2019</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">LocalDate</span> specifyDate <span class="token operator">=</span> <span class="token class-name">LocalDate</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token number">2019</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Period</span><span class="token punctuation">.</span><span class="token function">between</span><span class="token punctuation">(</span>specifyDate<span class="token punctuation">,</span> today<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDays</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Period</span><span class="token punctuation">.</span><span class="token function">between</span><span class="token punctuation">(</span>specifyDate<span class="token punctuation">,</span> today<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">ChronoUnit</span><span class="token punctuation">.</span><span class="token constant">DAYS</span><span class="token punctuation">.</span><span class="token function">between</span><span class="token punctuation">(</span>specifyDate<span class="token punctuation">,</span> today<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>可以使用 ChronoUnit.DAYS.between 解决这个问题:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// 计算日期差</span>
<span class="token number">11</span>
<span class="token constant">P2M11D</span>
<span class="token number">72</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>从日期时间的时区到格式化再到计算, 你是不是体会到 Java 8 日期时间类的强大了呢?</p> <h5 id="重点回顾-16"><a href="#重点回顾-16" class="header-anchor">#</a> 重点回顾</h5> <p>今天一起看了日期时间的初始化, 时区, 格式化, 解析和计算的问题. 使用 Java 8 中的日期时间包 Java.time 的类进行各种操作, 会比使用遗留的 Date, Calender 和 SimpleDateFormat 更简单, 清晰, 功能也更丰富, 坑也比较少.</p> <p>如果有条件的话, <strong>还是建议全面改为使用 Java 8 的日期时间类型</strong>. 下面把 Java 8 前后的日期时间类型, 汇总到了一张思维导图上, 图中箭头代表的是新老类型在概念上等价的类型:</p> <p><img src="/img/e5df643c529c6cb10c99a74042a8031c-20230731165210-peufrr0.png" alt=""></p> <p>这里有个误区是, 认为 java.util.Date 类似于新 API 中的 LocalDateTime. 其实不是, 虽然它们都没有时区概念, 但 java.util.Date 类是因为使用 UTC 表示, 所以没有时区概念, 其本质是时间戳; 而 <strong>LocalDateTime, 严格上可以认为是一个日期时间的表示, 而不是一个时间点</strong>.</p> <p>因此, 在把 Date 转换为 LocalDateTime 的时候, 需要通过 Date 的 toInstant 方法得到一个 UTC 时间戳进行转换, 并需要提供当前的时区, 这样才能把 UTC 时间转换为本地日期时间(的表示). 反过来, 把 LocalDateTime 的时间表示转换为 Date 时, 也需要提供时区, 用于指定是哪个时区的时间表示, 也就是先通过 atZone 方法把 LocalDateTime 转换为 ZonedDateTime, 然后才能获得 UTC 时间戳:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">Date</span> in <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">LocalDateTime</span> ldt <span class="token operator">=</span> <span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">ofInstant</span><span class="token punctuation">(</span>in<span class="token punctuation">.</span><span class="token function">toInstant</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">ZoneId</span><span class="token punctuation">.</span><span class="token function">systemDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Date</span> out <span class="token operator">=</span> <span class="token class-name">Date</span><span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>ldt<span class="token punctuation">.</span><span class="token function">atZone</span><span class="token punctuation">(</span><span class="token class-name">ZoneId</span><span class="token punctuation">.</span><span class="token function">systemDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toInstant</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>很多同学说使用新 API 很麻烦, 还需要考虑时区的概念, 一点都不简洁. 但其实并不是因为 API 需要设计得这么繁琐, 而<strong>是 UTC 时间要变为当地时间, 必须考虑时区</strong>.</p> <h4 id="_17-别以为-自动挡-就不可能出现oom"><a href="#_17-别以为-自动挡-就不可能出现oom" class="header-anchor">#</a> 17-别以为&quot;自动挡&quot;就不可能出现OOM</h4> <p>今天要分享的是, 别以为&quot;自动挡&quot;就不可能出现 OOM.</p> <p>这里的 &quot;自动挡&quot;, 是我对 Java 自动垃圾收集器的戏称. 经过这么多年的发展, Java 的垃圾收集器已经非常成熟了. 有了自动垃圾收集器, 绝大多数情况下我们写程序时可以专注于业务逻辑, 无需过多考虑对象的分配和释放, 一般也不会出现 OOM.</p> <p>但内存空间始终是有限的, Java 的几大内存区域始终都有 OOM 的可能. 相应地, Java 程序的常见 OOM 类型, 可以分为堆内存的 OOM, 栈 OOM, 元空间 OOM, 直接内存 OOM 等. 几乎每一种 OOM 都可以使用几行代码模拟, 市面上也有很多资料在堆, 元空间, 直接内存中分配超大对象或是无限分配对象, 尝试创建无限个线程或是进行方法无限递归调用来模拟.</p> <p>但值得注意的是, 一般业务代码并不会这么干. 所以今天, 会从内存分配意识的角度通过一些案例, <strong>展示业务代码中可能导致 OOM 的一些坑</strong>. 这些坑, 或是因为大家意识不到对象的分配, 或是因为不合理的资源使用, 或是没有控制缓存的数据量等.</p> <p>前面介绍线程时, 已经看到了两种 OOM 的情况, 一是因为使用无界队列导致的堆 OOM, 二是因为使用没有最大线程数量限制的线程池导致无限创建线程的 OOM. 接下来再一起看看, <strong>在写业务代码的过程中, 还有哪些意识上的疏忽可能会导致 OOM</strong>.</p> <h5 id="太多份相同的对象导致oom"><a href="#太多份相同的对象导致oom" class="header-anchor">#</a> 太多份相同的对象导致OOM</h5> <p>第一个案例是这样的. 有一个项目在内存中<strong>缓存了全量用户数据</strong>, 在搜索用户时可以直接从缓存中返回用户信息. 现在为了改善用户体验, 需要实现输入部分用户名自动在下拉框提示补全用户名的功能(也就是所谓的自动完成功能).</p> <p>对于这种快速检索的需求, 最好使用 Map 来实现, 会比直接从 List 搜索快得多.</p> <p>为实现这个功能, 需要一个 HashMap 来存放这些用户数据, Key 是用户姓名索引, Value 是索引下对应的用户列表. 举一个例子, 如果有两个用户 aa 和 ab, 那么 Key 就有三个, 分别是 a, aa 和 ab. 用户输入字母 a 时, 就能从 Value 这个 List 中拿到所有字母 a 开头的用户, 即 aa 和 ab.</p> <p>在代码中, 在数据库中存入 1 万个测试用户, 用户名由 a~j 这 6 个字母随机构成, 然后把每一个用户名的前 1 个字母, 前 2 个字母以此类推直到完整用户名作为 Key 存入缓存中, 缓存的 Value 是一个 UserDTO 的 List, 存放的是所有相同的用户名索引, 以及对应的用户信息:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// 自动完成的索引, Key是用户输入的部分用户名, Value是对应的用户数据</span>
<span class="token keyword">private</span> <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">UserDTO</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> autoCompleteIndex <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Autowired</span>
<span class="token keyword">private</span> <span class="token class-name">UserRepository</span> userRepository<span class="token punctuation">;</span>

<span class="token annotation punctuation">@PostConstruct</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">wrong</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 先保存10000个用户名随机的用户到数据库中</span>
    userRepository<span class="token punctuation">.</span><span class="token function">saveAll</span><span class="token punctuation">(</span><span class="token class-name">LongStream</span><span class="token punctuation">.</span><span class="token function">rangeClosed</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">10000</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">mapToObj</span><span class="token punctuation">(</span>i <span class="token operator">-&gt;</span> <span class="token keyword">new</span> <span class="token class-name">UserEntity</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> <span class="token function">randomName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 从数据库加载所有用户</span>
    userRepository<span class="token punctuation">.</span><span class="token function">findAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>userEntity <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> len <span class="token operator">=</span> userEntity<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 对于每一个用户, 对其用户名的前N位进行索引, N可能是1~6六种长度类型</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> len<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">String</span> key <span class="token operator">=</span> userEntity<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            autoCompleteIndex<span class="token punctuation">.</span><span class="token function">computeIfAbsent</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> s <span class="token operator">-&gt;</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">UserDTO</span><span class="token punctuation">(</span>userEntity<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;autoCompleteIndex size:{} count:{}&quot;</span><span class="token punctuation">,</span> autoCompleteIndex<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            autoCompleteIndex<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>item <span class="token operator">-&gt;</span> item<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token operator">::</span><span class="token function">sum</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><p>对于每一个用户对象 UserDTO, 除了有用户名, 还加入了 10K 左右的数据模拟其用户信息:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Data</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserDTO</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@EqualsAndHashCode.Exclude</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> payload<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">UserDTO</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>payload <span class="token operator">=</span> <span class="token class-name">IntStream</span><span class="token punctuation">.</span><span class="token function">rangeClosed</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">10_000</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">mapToObj</span><span class="token punctuation">(</span>__ <span class="token operator">-&gt;</span> <span class="token string">&quot;a&quot;</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">joining</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>运行程序后, 日志输出如下:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token punctuation">[</span><span class="token number">11</span><span class="token operator">:</span><span class="token number">11</span><span class="token operator">:</span><span class="token number">22.982</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>main<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token constant">INFO</span> <span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token punctuation">.</span>t<span class="token punctuation">.</span>c<span class="token punctuation">.</span>o<span class="token punctuation">.</span>d<span class="token punctuation">.</span>UsernameAutoCompleteService<span class="token operator">:</span><span class="token number">37</span>  <span class="token punctuation">]</span> <span class="token operator">-</span> autoCompleteIndex size<span class="token operator">:</span><span class="token number">26838</span> count<span class="token operator">:</span><span class="token number">60000</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>可以看到, 一共有 26838 个索引(也就是所有用户名的 1 位, 2 位一直到 6 位有 26838 个组合), HashMap 的 Value, 也就是 List一共有 1 万个用户 * 6 = 6 万个 UserDTO 对象.</p> <p>使用内存分析工具 MAT 打开堆 dump 发现, 6 万个 UserDTO 占用了约 1.2GB 的内存:</p> <p><img src="/img/a10988143a2db2dd0dc318cf2a17d7bd-20230731165210-7yh3fhw.png" alt=""></p> <p>看到这里发现, <strong>虽然真正的用户只有 1 万个, 但因为使用部分用户名作为索引的 Key, 导致缓存的 Key 有 26838 个, 缓存的用户信息多达 6 万个</strong>. 如果用户名不是 6 位而是 10 位, 20 位, 那么缓存的用户信息可能就是 10 万, 20 万个, 必然会产生堆 OOM.</p> <p>尝试调大用户名的最大长度, 重启程序可以看到类似如下的错误:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token punctuation">[</span><span class="token number">17</span><span class="token operator">:</span><span class="token number">30</span><span class="token operator">:</span><span class="token number">29.858</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>main<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token constant">ERROR</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token class-name"><span class="token namespace">ringframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span></span>SpringApplication</span><span class="token operator">:</span><span class="token number">826</span> <span class="token punctuation">]</span> <span class="token operator">-</span> <span class="token class-name">Application</span> run failed
<span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span></span>BeanCreationException</span><span class="token operator">:</span> <span class="token class-name">Error</span> creating bean <span class="token keyword">with</span> <span class="token namespace">name</span> 'usernameAutoCompleteService'<span class="token operator">:</span> <span class="token class-name">Invocation</span> of init method failed<span class="token punctuation">;</span> nested exception is <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>OutOfMemoryError</span><span class="token operator">:</span> <span class="token class-name">Java</span> heap space
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>我们可能会想当然地认为, 数据库中有 1 万个用户, 内存中也应该只有 1 万个 UserDTO 对象, 但实现的时候每次都会 new 出来 UserDTO 加入缓存, 当然在内存中都是新对象. 在实际的项目中, 用户信息的缓存可能是随着用户输入增量缓存的, 而不是像这个案例一样在程序初始化的时候全量缓存, 所以问题暴露得不会这么早.</p> <p>知道原因后, 解决起来就比较简单了. 把所有 UserDTO 先加入 HashSet 中, 因为 UserDTO 以 name 来标识唯一性, <strong>所以重复用户名会被过滤掉</strong>, 最终加入 HashSet 的 UserDTO 就不足 1 万个.</p> <p>有了 HashSet 来缓存所有可能的 UserDTO 信息, 再构建自动完成索引 autoCompleteIndex 这个 HashMap 时, 就可以直接从 HashSet 获取所有用户信息来构建了. 这样一来, 同一个用户名前缀的不同组合(比如用户名为 abc 的用户, a, ab 和 abc 三个 Key)关联到 UserDTO 是同一份:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@PostConstruct</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">right</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
    <span class="token class-name">HashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">UserDTO</span><span class="token punctuation">&gt;</span></span> cache <span class="token operator">=</span> userRepository<span class="token punctuation">.</span><span class="token function">findAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>item <span class="token operator">-&gt;</span> <span class="token keyword">new</span> <span class="token class-name">UserDTO</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toCollection</span><span class="token punctuation">(</span><span class="token class-name">HashSet</span><span class="token operator">::</span><span class="token keyword">new</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    cache<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>userDTO <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> len <span class="token operator">=</span> userDTO<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> len<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">String</span> key <span class="token operator">=</span> userDTO<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            autoCompleteIndex<span class="token punctuation">.</span><span class="token function">computeIfAbsent</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> s <span class="token operator">-&gt;</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>userDTO<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>再次分析堆内存, 可以看到 UserDTO 只有 9945 份, 总共占用的内存不到 200M. 这才是想要的结果.</p> <p><img src="/img/0ecea0e3069b338870872243fefd46b2-20230731165210-vel4ybt.png" alt=""></p> <p>修复后的程序, 不仅相同的 UserDTO 只有一份, 总副本数变为了原来的六分之一; 而且因为 HashSet 的去重特性, 双重节约了内存.</p> <p>值得注意的是, 我们虽然清楚数据总量, 但却忽略了<strong>每一份数据在内存中可能有多份</strong>. 我之前还遇到一个案例, 一个后台程序需要从数据库加载大量信息用于数据导出, 这些数据在数据库中占用 100M 内存, 但是 1GB 的 JVM 堆却无法完成导出操作.</p> <p>来分析下原因. 100M 的数据加载到程序内存中, 变为 Java 的数据结构就已经占用了 200M 堆内存; 这些数据经过 JDBC, MyBatis 等框架其实是加载了 2 份, 然后领域模型, DTO 再进行转换可能又加载了 2 次; 最终, 占用的内存达到了 200M * 4 = 800M.</p> <p>所以, <strong>在进行容量评估时, 不能认为一份数据在程序内存中也是一份</strong>.</p> <h5 id="使用weakhashmap不等于不会oom"><a href="#使用weakhashmap不等于不会oom" class="header-anchor">#</a> 使用WeakHashMap不等于不会OOM</h5> <p>对于上一节实现快速检索的案例, 为了防止缓存中堆积大量数据导致 OOM, 一些同学可能会想到使用 WeakHashMap 作为缓存容器.</p> <p>WeakHashMap 的特点是 Key 在哈希表内部是弱引用的, 当没有强引用指向这个 Key 之后, Entry 会被 GC, 即使我们无限往 WeakHashMap 加入数据, 只要 Key 不再使用, 也就不会 OOM.</p> <p>说到了强引用和弱引用, 先回顾下 Java 中引用类型和垃圾回收的关系:</p> <ol><li><strong>垃圾回收器不会回收有强引用的对象;</strong></li> <li><strong>在内存充足时, 垃圾回收器不会回收具有软引用的对象;</strong></li> <li><strong>垃圾回收器只要扫描到了具有弱引用的对象就会回收, WeakHashMap 就是利用了这个特点.</strong></li></ol> <p>不过要分享的第二个案例, 恰巧就是不久前我遇到的一个使用 WeakHashMap 却最终 OOM 的案例. 这里暂且不论使用 WeakHashMap 作为缓存是否合适, 先分析一下这个 OOM 问题.</p> <p>声明一个 Key 是 User 类型, Value 是 UserProfile 类型的 WeakHashMap, 作为用户数据缓存, 往其中添加 200 万个 Entry, 然后使用 ScheduledThreadPoolExecutor 发起一个定时任务, 每隔 1 秒输出缓存中的 Entry 个数:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">User</span><span class="token punctuation">,</span> <span class="token class-name">UserProfile</span><span class="token punctuation">&gt;</span></span> cache <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WeakHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;wrong&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">wrong</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">String</span> userName <span class="token operator">=</span> <span class="token string">&quot;zhuye&quot;</span><span class="token punctuation">;</span>

    <span class="token comment">// 间隔1秒定时输出缓存中的条目数</span>
    <span class="token class-name">Executors</span><span class="token punctuation">.</span><span class="token function">newSingleThreadScheduledExecutor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">scheduleAtFixedRate</span><span class="token punctuation">(</span>
            <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;cache size:{}&quot;</span><span class="token punctuation">,</span> cache<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">LongStream</span><span class="token punctuation">.</span><span class="token function">rangeClosed</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2000000</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>i <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        <span class="token class-name">User</span> user <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span>userName <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
        cache<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>user<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">UserProfile</span><span class="token punctuation">(</span>user<span class="token punctuation">,</span> <span class="token string">&quot;location&quot;</span> <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>执行程序后日志如下:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token punctuation">[</span><span class="token number">10</span><span class="token operator">:</span><span class="token number">30</span><span class="token operator">:</span><span class="token number">28.509</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>pool<span class="token operator">-</span><span class="token number">3</span><span class="token operator">-</span>thread<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token constant">INFO</span> <span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token class-name"><span class="token namespace">t<span class="token punctuation">.</span>c<span class="token punctuation">.</span>o<span class="token punctuation">.</span>demo3<span class="token punctuation">.</span></span>WeakHashMapOOMController</span><span class="token operator">:</span><span class="token number">29</span>  <span class="token punctuation">]</span> <span class="token operator">-</span> cache size<span class="token operator">:</span><span class="token number">2000000</span>
<span class="token punctuation">[</span><span class="token number">10</span><span class="token operator">:</span><span class="token number">30</span><span class="token operator">:</span><span class="token number">29.507</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>pool<span class="token operator">-</span><span class="token number">3</span><span class="token operator">-</span>thread<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token constant">INFO</span> <span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token class-name"><span class="token namespace">t<span class="token punctuation">.</span>c<span class="token punctuation">.</span>o<span class="token punctuation">.</span>demo3<span class="token punctuation">.</span></span>WeakHashMapOOMController</span><span class="token operator">:</span><span class="token number">29</span>  <span class="token punctuation">]</span> <span class="token operator">-</span> cache size<span class="token operator">:</span><span class="token number">2000000</span>
<span class="token punctuation">[</span><span class="token number">10</span><span class="token operator">:</span><span class="token number">30</span><span class="token operator">:</span><span class="token number">30.509</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>pool<span class="token operator">-</span><span class="token number">3</span><span class="token operator">-</span>thread<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token constant">INFO</span> <span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token class-name"><span class="token namespace">t<span class="token punctuation">.</span>c<span class="token punctuation">.</span>o<span class="token punctuation">.</span>demo3<span class="token punctuation">.</span></span>WeakHashMapOOMController</span><span class="token operator">:</span><span class="token number">29</span>  <span class="token punctuation">]</span> <span class="token operator">-</span> cache size<span class="token operator">:</span><span class="token number">2000000</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>可以看到, 输出的 cache size 始终是 200 万, 即使通过 jvisualvm 进行手动 GC 还是这样. 这就说明, 这些 <strong>Entry 无法通过 GC 回收</strong>. 如果把 200 万改为 1000 万, 就可以在日志中看到如下的 OOM 错误:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">Exception</span> in thread <span class="token string">&quot;http-nio-45678-exec-1&quot;</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>OutOfMemoryError</span><span class="token operator">:</span> <span class="token constant">GC</span> overhead limit exceeded
<span class="token class-name">Exception</span> in thread <span class="token string">&quot;Catalina-utility-2&quot;</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>OutOfMemoryError</span><span class="token operator">:</span> <span class="token constant">GC</span> overhead limit exceeded
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>来分析一下这个问题. 进行堆转储后可以看到, 堆内存中有 200 万个 UserProfie 和 User:</p> <p><img src="/img/e0d39994e0571b195a0387db8994cf2e-20230731165210-4kd4kuy.png" alt=""></p> <p>如下是 User 和 UserProfile 类的定义, 需要注意的是, <strong>WeakHashMap 的 Key 是 User 对象, 而其 Value 是 UserProfile 对象, 持有了 User 的引用</strong>:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Data</span>
<span class="token annotation punctuation">@AllArgsConstructor</span>
<span class="token annotation punctuation">@NoArgsConstructor</span>
<span class="token keyword">class</span> <span class="token class-name">User</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@Data</span>
<span class="token annotation punctuation">@AllArgsConstructor</span>
<span class="token annotation punctuation">@NoArgsConstructor</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserProfile</span> <span class="token punctuation">{</span>
    <span class="token comment">// 这里引用了User对象</span>
    <span class="token keyword">private</span> <span class="token class-name">User</span> user<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> location<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>没错, 这就是问题的所在. 分析一下 WeakHashMap 的源码, 会发现 WeakHashMap 和 HashMap 的最大区别, 是 Entry 对象的实现. 接下来暂且忽略 HashMap 的实现, 来看下 Entry 对象:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">extends</span> <span class="token class-name">WeakReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

<span class="token comment">/**
 * Creates new entry.
 */</span>
<span class="token class-name">Entry</span><span class="token punctuation">(</span><span class="token class-name">Object</span> key<span class="token punctuation">,</span> <span class="token class-name">V</span> value<span class="token punctuation">,</span> <span class="token class-name">ReferenceQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> queue<span class="token punctuation">,</span> <span class="token keyword">int</span> hash<span class="token punctuation">,</span> <span class="token class-name">Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> next<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> queue<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> value<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>hash  <span class="token operator">=</span> hash<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>next  <span class="token operator">=</span> next<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>Entry 对象继承了 WeakReference, Entry 的构造函数调用了 super (key,queue), 这是父类的构造函数. 其中, key 是执行 put 方法时的 key; queue 是一个 <strong>ReferenceQueue</strong>. 如果你了解 Java 的引用就会知道, <strong>被 GC 的对象会被丢进这个 queue 里面</strong>.</p> <p>再来看看对象被丢进 queue 后是如何被销毁的:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">V</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">Object</span> key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Object</span> k <span class="token operator">=</span> <span class="token function">maskNull</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> h <span class="token operator">=</span> <span class="token function">hash</span><span class="token punctuation">(</span>k<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> tab <span class="token operator">=</span> <span class="token function">getTable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> index <span class="token operator">=</span> <span class="token function">indexFor</span><span class="token punctuation">(</span>h<span class="token punctuation">,</span> tab<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> e <span class="token operator">=</span> tab<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>e <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span>hash <span class="token operator">==</span> h <span class="token operator">&amp;&amp;</span> <span class="token function">eq</span><span class="token punctuation">(</span>k<span class="token punctuation">,</span> e<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> e<span class="token punctuation">.</span>value<span class="token punctuation">;</span>
        e <span class="token operator">=</span> e<span class="token punctuation">.</span>next<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token class-name">Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">getTable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">expungeStaleEntries</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> table<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 * Expunges stale entries from the table.
 */</span>
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">expungeStaleEntries</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Object</span> x<span class="token punctuation">;</span> <span class="token punctuation">(</span>x <span class="token operator">=</span> queue<span class="token punctuation">.</span><span class="token function">poll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">;</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>queue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">&quot;unchecked&quot;</span><span class="token punctuation">)</span>
                <span class="token class-name">Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> e <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span> x<span class="token punctuation">;</span>
            <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token function">indexFor</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>hash<span class="token punctuation">,</span> table<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> prev <span class="token operator">=</span> table<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token class-name">Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> p <span class="token operator">=</span> prev<span class="token punctuation">;</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span>p <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> next <span class="token operator">=</span> p<span class="token punctuation">.</span>next<span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>p <span class="token generics"><span class="token punctuation">&lt;</span>mark<span class="token punctuation">&gt;</span></span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>prev <span class="token operator">&lt;</span><span class="token operator">/</span>mark<span class="token operator">&gt;</span> e<span class="token punctuation">)</span>
                        table<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> next<span class="token punctuation">;</span>
                    <span class="token keyword">else</span>
                        prev<span class="token punctuation">.</span>next <span class="token operator">=</span> next<span class="token punctuation">;</span>
                    <span class="token comment">// Must not null out e.next;</span>
                    <span class="token comment">// stale entries may be in use by a HashIterator</span>
                    e<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span> <span class="token comment">// Help GC</span>
                    size<span class="token operator">--</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                prev <span class="token operator">=</span> p<span class="token punctuation">;</span>
                p <span class="token operator">=</span> next<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br></div></div><p>从源码中可以看到, <strong>每次调用 get, put, size 等方法时, 都会从 queue 里拿出所有已经被 GC 掉的 key 并删除对应的 Entry 对象</strong>. 再来回顾下这个逻辑:</p> <ol><li>put 一个对象进 Map 时, <strong>它的 key 会被封装成弱引用对象</strong>;</li> <li>发生 GC 时, <strong>弱引用的 key 被发现并放入 queue</strong>;</li> <li>调用 get 等方法时, <strong>扫描 queue 删除 key, 以及包含 key 和 value 的 Entry 对象</strong>.</li></ol> <p><strong>WeakHashMap 的 Key 虽然是弱引用, 但是其 Value 却持有 Key 中对象的强引用, Value 被 Entry 引用, Entry 被 WeakHashMap 引用, 最终导致 Key 无法回收</strong>. 解决方案就是<strong>让 Value 变为弱引用</strong>, 使用 WeakReference 来包装 UserProfile 即可:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// 使用 WeakReference 来包装 UserProfile</span>
<span class="token keyword">private</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">User</span><span class="token punctuation">,</span> <span class="token class-name">WeakReference</span><span class="token punctuation">&lt;</span><span class="token class-name">UserProfile</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> cache2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WeakHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;right&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">right</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">String</span> userName <span class="token operator">=</span> <span class="token string">&quot;zhuye&quot;</span><span class="token punctuation">;</span>

    <span class="token comment">// 间隔1秒定时输出缓存中的条目数</span>
    <span class="token class-name">Executors</span><span class="token punctuation">.</span><span class="token function">newSingleThreadScheduledExecutor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">scheduleAtFixedRate</span><span class="token punctuation">(</span>
            <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;cache size:{}&quot;</span><span class="token punctuation">,</span> cache2<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">LongStream</span><span class="token punctuation">.</span><span class="token function">rangeClosed</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2000000</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>i <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        <span class="token class-name">User</span> user <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span>userName <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 这次使用弱引用来包装UserProfile</span>
        cache2<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>user<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">WeakReference</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">UserProfile</span><span class="token punctuation">(</span>user<span class="token punctuation">,</span> <span class="token string">&quot;location&quot;</span> <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>重新运行程序, 从日志中观察到 cache size 不再是固定的 200 万, 而是在<strong>不断减少</strong>, 甚至在手动 GC 后所有的 Entry 都被回收了:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token punctuation">[</span><span class="token number">10</span><span class="token operator">:</span><span class="token number">40</span><span class="token operator">:</span><span class="token number">05.792</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>pool<span class="token operator">-</span><span class="token number">3</span><span class="token operator">-</span>thread<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token constant">INFO</span> <span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token class-name"><span class="token namespace">t<span class="token punctuation">.</span>c<span class="token punctuation">.</span>o<span class="token punctuation">.</span>demo3<span class="token punctuation">.</span></span>WeakHashMapOOMController</span><span class="token operator">:</span><span class="token number">40</span>  <span class="token punctuation">]</span> <span class="token operator">-</span> cache size<span class="token operator">:</span><span class="token number">1367402</span>
<span class="token punctuation">[</span><span class="token number">10</span><span class="token operator">:</span><span class="token number">40</span><span class="token operator">:</span><span class="token number">05.795</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>pool<span class="token operator">-</span><span class="token number">3</span><span class="token operator">-</span>thread<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token constant">INFO</span> <span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token class-name"><span class="token namespace">t<span class="token punctuation">.</span>c<span class="token punctuation">.</span>o<span class="token punctuation">.</span>demo3<span class="token punctuation">.</span></span>WeakHashMapOOMController</span><span class="token operator">:</span><span class="token number">40</span>  <span class="token punctuation">]</span> <span class="token operator">-</span> cache size<span class="token operator">:</span><span class="token number">1367846</span>
<span class="token punctuation">[</span><span class="token number">10</span><span class="token operator">:</span><span class="token number">40</span><span class="token operator">:</span><span class="token number">06.773</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>pool<span class="token operator">-</span><span class="token number">3</span><span class="token operator">-</span>thread<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token constant">INFO</span> <span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token class-name"><span class="token namespace">t<span class="token punctuation">.</span>c<span class="token punctuation">.</span>o<span class="token punctuation">.</span>demo3<span class="token punctuation">.</span></span>WeakHashMapOOMController</span><span class="token operator">:</span><span class="token number">40</span>  <span class="token punctuation">]</span> <span class="token operator">-</span> cache size<span class="token operator">:</span><span class="token number">549551</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">[</span><span class="token number">10</span><span class="token operator">:</span><span class="token number">40</span><span class="token operator">:</span><span class="token number">20.742</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>pool<span class="token operator">-</span><span class="token number">3</span><span class="token operator">-</span>thread<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token constant">INFO</span> <span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token class-name"><span class="token namespace">t<span class="token punctuation">.</span>c<span class="token punctuation">.</span>o<span class="token punctuation">.</span>demo3<span class="token punctuation">.</span></span>WeakHashMapOOMController</span><span class="token operator">:</span><span class="token number">40</span>  <span class="token punctuation">]</span> <span class="token operator">-</span> cache size<span class="token operator">:</span><span class="token number">549551</span>
<span class="token punctuation">[</span><span class="token number">10</span><span class="token operator">:</span><span class="token number">40</span><span class="token operator">:</span><span class="token number">22.862</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>pool<span class="token operator">-</span><span class="token number">3</span><span class="token operator">-</span>thread<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token constant">INFO</span> <span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token class-name"><span class="token namespace">t<span class="token punctuation">.</span>c<span class="token punctuation">.</span>o<span class="token punctuation">.</span>demo3<span class="token punctuation">.</span></span>WeakHashMapOOMController</span><span class="token operator">:</span><span class="token number">40</span>  <span class="token punctuation">]</span> <span class="token operator">-</span> cache size<span class="token operator">:</span><span class="token number">547937</span>
<span class="token punctuation">[</span><span class="token number">10</span><span class="token operator">:</span><span class="token number">40</span><span class="token operator">:</span><span class="token number">22.865</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>pool<span class="token operator">-</span><span class="token number">3</span><span class="token operator">-</span>thread<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token constant">INFO</span> <span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token class-name"><span class="token namespace">t<span class="token punctuation">.</span>c<span class="token punctuation">.</span>o<span class="token punctuation">.</span>demo3<span class="token punctuation">.</span></span>WeakHashMapOOMController</span><span class="token operator">:</span><span class="token number">40</span>  <span class="token punctuation">]</span> <span class="token operator">-</span> cache size<span class="token operator">:</span><span class="token number">542134</span>
<span class="token punctuation">[</span><span class="token number">10</span><span class="token operator">:</span><span class="token number">40</span><span class="token operator">:</span><span class="token number">23.779</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>pool<span class="token operator">-</span><span class="token number">3</span><span class="token operator">-</span>thread<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token constant">INFO</span> <span class="token punctuation">]</span>
<span class="token comment">// 手动进行GC</span>
<span class="token punctuation">[</span><span class="token class-name"><span class="token namespace">t<span class="token punctuation">.</span>c<span class="token punctuation">.</span>o<span class="token punctuation">.</span>demo3<span class="token punctuation">.</span></span>WeakHashMapOOMController</span><span class="token operator">:</span><span class="token number">40</span>  <span class="token punctuation">]</span> <span class="token operator">-</span> cache size<span class="token operator">:</span><span class="token number">0</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>当然, 还有一种办法就是, <strong>让 Value 也就是 UserProfile 不再引用 Key, 而是重新 new 出一个新的 User 对象赋值给 UserProfile</strong>:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;right2&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">right2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">String</span> userName <span class="token operator">=</span> <span class="token string">&quot;zhuye&quot;</span><span class="token punctuation">;</span>

    <span class="token comment">// new一个User对象</span>
    <span class="token class-name">User</span> user <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span>userName <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
    cache<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>user<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">UserProfile</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;location&quot;</span> <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>此外, Spring 提供的 ConcurrentReferenceHashMap 类可以使用弱引用, <strong>软引用做缓存, Key 和 Value 同时被软引用或弱引用包装, 也能解决相互引用导致的数据不能释放问题</strong>. 与 WeakHashMap 相比, ConcurrentReferenceHashMap 不但性能更好, 还可以确保线程安全.</p> <h5 id="tomcat参数配置不合理导致oom"><a href="#tomcat参数配置不合理导致oom" class="header-anchor">#</a> Tomcat参数配置不合理导致OOM</h5> <p>再来看看第三个案例. 有一次运维同学反馈, 有个应用在业务量大的情况下会出现假死, 日志中也有大量 OOM 异常:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token punctuation">[</span><span class="token number">13</span><span class="token operator">:</span><span class="token number">18</span><span class="token operator">:</span><span class="token number">17.597</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>http<span class="token operator">-</span>nio<span class="token operator">-</span><span class="token number">45678</span><span class="token operator">-</span>exec<span class="token operator">-</span><span class="token number">70</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token constant">ERROR</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token class-name"><span class="token namespace">ache<span class="token punctuation">.</span>coyote<span class="token punctuation">.</span>http11<span class="token punctuation">.</span></span>Http11NioProtocol</span><span class="token operator">:</span><span class="token number">175</span> <span class="token punctuation">]</span> <span class="token operator">-</span> <span class="token class-name">Failed</span> <span class="token keyword">to</span> <span class="token namespace">complete</span> processing of a request
<span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>OutOfMemoryError</span><span class="token operator">:</span> <span class="token class-name">Java</span> heap space
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>于是, 我让运维同学进行生产堆 Dump. 通过 MAT 打开 dump 文件后, 一眼就看到 OOM 的原因是, 有接近 <strong>1.7GB 的 byte 数组分配</strong>, 而 JVM 进程的最大堆内存只配置了 2GB:</p> <p><img src="/img/ada677a79dee6d94b16e660a4bd0cc4b-20230731165210-upvt6wv.png" alt=""></p> <p>通过查看引用可以发现, <strong>大量引用都是 Tomcat 的工作线程</strong>. 大部分工作线程都分配了两个 10M 左右的数组, 100 个左右工作线程吃满了内存. <strong>第一个红框是 Http11InputBuffer, 其 buffer 大小是 10008192 字节; 而第二个红框的 Http11OutputBuffer 的 buffer, 正好占用 10000000 字节</strong>:</p> <p><img src="/img/5a343956824d23eb1589827f090c07a2-20230731165210-chr32ks.png" alt=""></p> <p>先来看看第一个 Http11InputBuffer 为什么会占用这么多内存. 查看 Http11InputBuffer 类的 init 方法注意到, 其中一个<strong>初始化方法会分配 headerBufferSize+readBuffer 大小的内存</strong>:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token class-name">SocketWrapperBase</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> socketWrapper<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    wrapper <span class="token operator">=</span> socketWrapper<span class="token punctuation">;</span>
    wrapper<span class="token punctuation">.</span><span class="token function">setAppReadBufHandler</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">int</span> bufLength <span class="token operator">=</span> headerBufferSize <span class="token operator">+</span>
            wrapper<span class="token punctuation">.</span><span class="token function">getSocketBufferHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getReadBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">capacity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>byteBuffer <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> byteBuffer<span class="token punctuation">.</span><span class="token function">capacity</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> bufLength<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 分配内存</span>
        byteBuffer <span class="token operator">=</span> <span class="token class-name">ByteBuffer</span><span class="token punctuation">.</span><span class="token function">allocate</span><span class="token punctuation">(</span>bufLength<span class="token punctuation">)</span><span class="token punctuation">;</span>
        byteBuffer<span class="token punctuation">.</span><span class="token function">position</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">limit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>在 Tomcat 文档中有提到, 这个 Socket 的<strong>读缓冲</strong>, 也就是 readBuffer 默认是 8192 字节. 显然, 问题出在了 <strong>headerBufferSize</strong> 上:</p> <p><img src="/img/57a5210741b834d7f2fdc14440f03e7d-20230731165210-54e63ft.png" alt=""></p> <p>向上追溯初始化 Http11InputBuffer 的 Http11Processor 类, 可以看到, 传入的 headerBufferSize 配置的是 <strong>MaxHttpHeaderSize</strong>:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>inputBuffer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Http11InputBuffer</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> protocol<span class="token punctuation">.</span><span class="token function">getMaxHttpHeaderSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
protocol<span class="token punctuation">.</span><span class="token function">getRejectIllegalHeaderName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> httpParser<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>Http11OutputBuffer 中的 buffer 正好占用了 10000000 字节, 这又是为什么? 通过 Http11OutputBuffer 的构造方法, 可以看到它是<strong>直接根据 headerBufferSize 分配了固定大小的 headerBuffer</strong>:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">protected</span> <span class="token class-name">Http11OutputBuffer</span><span class="token punctuation">(</span><span class="token class-name">Response</span> response<span class="token punctuation">,</span> <span class="token keyword">int</span> headerBufferSize<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
    headerBuffer <span class="token operator">=</span> <span class="token class-name">ByteBuffer</span><span class="token punctuation">.</span><span class="token function">allocate</span><span class="token punctuation">(</span>headerBufferSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>那么就可以想到, 一定是应用把 Tomcat 头相关的参数配置为 10000000 了, 使得<strong>每一个请求对于 Request 和 Response 都占用了 20M 内存</strong>, 最终在并发较多的情况下引起了 OOM.</p> <p>果不其然, 查看项目代码发现配置文件中有这样的配置项:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>server<span class="token punctuation">.</span>max<span class="token operator">-</span>http<span class="token operator">-</span>header<span class="token operator">-</span>size<span class="token operator">=</span><span class="token number">10000000</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>翻看源码提交记录可以看到, 当时开发同学遇到了这样的异常:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>IllegalArgumentException</span><span class="token operator">:</span> <span class="token class-name">Request</span> header is too large
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>于是他就到网上搜索了一下解决方案, 随意将 <code>server.max-http-header-size</code>​ 修改为了一个超大值, 期望永远不会再出现类似问题. 但没想到这个修改却引起了这么大的问题. 把这个参数改为比较合适的 20000 再进行压测, 就可以发现应用的各项指标都比较稳定.</p> <p>这个案例告诉我们, <mark><strong>一定要根据实际需求来修改参数配置, 可以考虑预留 2 到 5 倍的量. 容量类的参数背后往往代表了资源, 设置超大的参数就有可能占用不必要的资源, 在并发量大的时候因为资源大量分配导致 OOM</strong></mark>.</p> <h5 id="重点回顾-17"><a href="#重点回顾-17" class="header-anchor">#</a> 重点回顾</h5> <p>今天从内存分配意识的角度分享了 OOM 的问题. 通常而言, Java 程序的 OOM 有如下几种可能.</p> <p><strong>一是, 程序确实需要超出 JVM 配置的内存上限的内存</strong>. 不管是程序实现的不合理, 还是因为各种框架对数据的重复处理, 加工和转换, 相同的数据在内存中不一定只占用一份空间. 针对内存量使用超大的业务逻辑, 比如缓存逻辑, 文件上传下载和导出逻辑, 在做容量评估时, 可能还需要实际做一下 Dump, 而不是进行简单的假设.</p> <p><strong>二是, 出现内存泄露, 其实就是我们认为没有用的对象最终会被 GC, 但却没有</strong>. GC 并不会回收强引用对象, 可能经常在程序中定义一些容器作为缓存, 但如果容器中的数据无限增长, 要特别小心最终会导致 OOM. 使用 WeakHashMap 是解决这个问题的好办法, 但值得注意的是, 如果强引用的 Value 有引用 Key, 也无法回收 Entry.</p> <p><strong>三是, 不合理的资源需求配置, 在业务量小的时候可能不会出现问题, 但业务量一大可能很快就会撑爆内存</strong>. 比如, 随意配置 Tomcat 的 max-http-header-size 参数, 会导致一个请求使用过多的内存, 请求量大的时候出现 OOM. 在进行参数配置的时候, 要认识到, 很多限制类参数限制的是背后资源的使用, 资源始终是有限的, <strong>需要根据实际需求来合理设置参数</strong>.</p> <p>最后想说的是, 在出现 OOM 之后, 也不用过于紧张. 可以根据错误日志中的异常信息, 再结合 jstat 等命令行工具观察内存使用情况, 以及程序的 GC 日志, 来大致定位出现 OOM 的内存区块和类型. 其实, 我们遇到的 90% 的 OOM 都是堆 OOM, 对 JVM 进程进行堆内存 Dump, 或使用 jmap 命令分析对象内存占用排行, 一般都可以很容易定位到问题.</p> <p>这里, <strong>建议为生产系统的程序配置 JVM 参数启用详细的 GC 日志, 方便观察垃圾收集器的行为, 并开启 HeapDumpOnOutOfMemoryError, 以便在出现 OOM 时能自动 Dump 留下第一问题现场</strong>. 对于 JDK8, 可以这么设置:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token constant">XX</span><span class="token operator">:</span><span class="token operator">+</span><span class="token class-name">HeapDumpOnOutOfMemoryError</span> 
<span class="token operator">-</span><span class="token constant">XX</span><span class="token operator">:</span><span class="token class-name">HeapDumpPath</span><span class="token operator">=</span><span class="token punctuation">.</span> 
<span class="token operator">-</span><span class="token constant">XX</span><span class="token operator">:</span><span class="token operator">+</span><span class="token class-name">PrintGCDateStamps</span> 
<span class="token operator">-</span><span class="token constant">XX</span><span class="token operator">:</span><span class="token operator">+</span><span class="token class-name">PrintGCDetails</span> 
<span class="token operator">-</span><span class="token class-name">Xloggc</span><span class="token operator">:</span>gc<span class="token punctuation">.</span>log 
<span class="token operator">-</span><span class="token constant">XX</span><span class="token operator">:</span><span class="token operator">+</span><span class="token class-name">UseGCLogFileRotation</span> 
<span class="token operator">-</span><span class="token constant">XX</span><span class="token operator">:</span><span class="token class-name">NumberOfGCLogFiles</span><span class="token operator">=</span><span class="token number">10</span> 
<span class="token operator">-</span><span class="token constant">XX</span><span class="token operator">:</span><span class="token class-name">GCLogFileSize</span><span class="token operator">=</span><span class="token number">100</span>M
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h4 id="_18-当反射-注解和泛型遇到oop时-会有哪些坑"><a href="#_18-当反射-注解和泛型遇到oop时-会有哪些坑" class="header-anchor">#</a> 18-当反射,注解和泛型遇到OOP时,会有哪些坑?</h4> <p>今天聊聊 Java 高级特性的话题, 看看<strong>反射, 注解和泛型遇到重载和继承</strong>时可能会产生的坑.</p> <p>你可能说, 业务项目中几乎都是增删改查, 用到反射, 注解和泛型这些高级特性的机会少之又少, 没啥好学的. 但只有学好, 用好这些高级特性, 才能开发出更简洁易读的代码, 而且<strong>几乎所有的框架都使用了这三大高级特性</strong>. 比如, 要减少重复代码, 就得用到反射和注解.</p> <p>接下来就通过几个案例, 看看这三大特性结合 OOP 使用时会有哪些坑.</p> <h5 id="反射调用方法不是以传参决定重载"><a href="#反射调用方法不是以传参决定重载" class="header-anchor">#</a> 反射调用方法不是以传参决定重载</h5> <p><strong>反射的功能包括, 在运行时动态获取类和类成员定义, 以及动态读取属性调用方法</strong>. 也就是说, 针对类动态调用方法, 不管类中字段和方法怎么变动, 都可以用相同的规则来读取信息和执行方法. 因此, 几乎所有的 ORM(对象关系映射), 对象映射, MVC 框架都使用了反射.</p> <p><strong>反射的起点是 Class 类, Class 类提供了各种方法来查询它的信息</strong>.</p> <p>接下来, 先看一个<strong>反射调用方法遇到重载</strong>的坑: 有两个叫 age 的方法, 入参分别是基本类型 int 和包装类型 Integer.</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ReflectionIssueApplication</span> <span class="token punctuation">{</span>
  <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">age</span><span class="token punctuation">(</span><span class="token keyword">int</span> age<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;int age = {}&quot;</span><span class="token punctuation">,</span> age<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">age</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> age<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;Integer age = {}&quot;</span><span class="token punctuation">,</span> age<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>如果不通过反射调用, 走哪个重载方法很清晰, 比如传入 36 走 int 参数的重载方法, 传入 Integer.valueOf(&quot;36&quot;) 走 Integer 重载:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">ReflectionIssueApplication</span> application <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReflectionIssueApplication</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
application<span class="token punctuation">.</span><span class="token function">age</span><span class="token punctuation">(</span><span class="token number">36</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
application<span class="token punctuation">.</span><span class="token function">age</span><span class="token punctuation">(</span><span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span><span class="token string">&quot;36&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p><strong>但使用反射时的误区是, 认为反射调用方法还是根据入参确定方法重载</strong>. 比如, 使用 getDeclaredMethod 来获取 age 方法, 然后传入 Integer.valueOf(&quot;36&quot;):</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDeclaredMethod</span><span class="token punctuation">(</span><span class="token string">&quot;age&quot;</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token constant">TYPE</span><span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span><span class="token string">&quot;36&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>输出的日志证明, <strong>走的是 int 重载方法</strong>:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token number">14</span><span class="token operator">:</span><span class="token number">23</span><span class="token operator">:</span><span class="token number">09.801</span> <span class="token punctuation">[</span>main<span class="token punctuation">]</span> <span class="token constant">INFO</span> <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>geekbang<span class="token punctuation">.</span>time<span class="token punctuation">.</span>commonmistakes<span class="token punctuation">.</span>advancedfeatures<span class="token punctuation">.</span>demo1<span class="token punctuation">.</span></span>ReflectionIssueApplication</span> <span class="token operator">-</span> <span class="token keyword">int</span> age <span class="token operator">=</span> <span class="token number">36</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>其实, 要通过反射进行方法调用, <strong>第一步就是通过方法签名来确定方法</strong>. 具体到这个案例, <strong>getDeclaredMethod 传入的参数类型 Integer.TYPE 代表的是 int, 所以实际执行方法时无论传的是包装类型还是基本类型, 都会调用 int 入参的 age 方法</strong>.</p> <p><strong>把 Integer.TYPE 改为 Integer.class, 执行的参数类型就是包装类型的 Integer</strong>. 这时, 无论传入的是 Integer.valueOf(&quot;36&quot;) 还是基本类型的 36, 都会调用 Integer 为入参的 age 方法:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDeclaredMethod</span><span class="token punctuation">(</span><span class="token string">&quot;age&quot;</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span><span class="token string">&quot;36&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDeclaredMethod</span><span class="token punctuation">(</span><span class="token string">&quot;age&quot;</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token number">36</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>输出:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token number">14</span><span class="token operator">:</span><span class="token number">25</span><span class="token operator">:</span><span class="token number">18.028</span> <span class="token punctuation">[</span>main<span class="token punctuation">]</span> <span class="token constant">INFO</span> <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>geekbang<span class="token punctuation">.</span>time<span class="token punctuation">.</span>commonmistakes<span class="token punctuation">.</span>advancedfeatures<span class="token punctuation">.</span>demo1<span class="token punctuation">.</span></span>ReflectionIssueApplication</span> <span class="token operator">-</span> <span class="token class-name">Integer</span> age <span class="token operator">=</span> <span class="token number">36</span>
<span class="token number">14</span><span class="token operator">:</span><span class="token number">25</span><span class="token operator">:</span><span class="token number">18.029</span> <span class="token punctuation">[</span>main<span class="token punctuation">]</span> <span class="token constant">INFO</span> <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>geekbang<span class="token punctuation">.</span>time<span class="token punctuation">.</span>commonmistakes<span class="token punctuation">.</span>advancedfeatures<span class="token punctuation">.</span>demo1<span class="token punctuation">.</span></span>ReflectionIssueApplication</span> <span class="token operator">-</span> <span class="token class-name">Integer</span> age <span class="token operator">=</span> <span class="token number">36</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>现在非常清楚了, <strong>反射调用方法, 是以反射获取方法时传入的方法名称和参数类型来确定调用方法的</strong>. 接下来再来看一下反射, 泛型擦除和继承结合在一起会碰撞出什么坑.</p> <h5 id="泛型经过类型擦除多出桥接方法的坑"><a href="#泛型经过类型擦除多出桥接方法的坑" class="header-anchor">#</a> 泛型经过类型擦除多出桥接方法的坑</h5> <p>泛型是一种风格或范式, 一般用于强类型程序设计语言, 允许开发者使用类型参数替代明确的类型, 实例化时再指明具体的类型. 它是代码重用的有效手段, 允许把一套代码应用到多种数据类型上, 避免针对每一种数据类型实现重复的代码.</p> <p>Java 编译器对泛型应用了强大的类型检测, 如果代码违反了类型安全就会报错, 可以在编译时暴露大多数泛型的编码错误. 但总有一部分编码错误, 比如<strong>泛型类型擦除</strong>的坑, 在运行时才会暴露. 接下来就分享一个案例.</p> <p>有一个项目希望在类字段内容变动时记录日志, 于是开发同学就想到定义一个泛型父类, 并在父类中定义一个统一的日志记录方法, 子类可以通过继承重用这个方法. 代码上线后业务没啥问题, 但总是出现日志<strong>重复记录</strong>的问题. 开始时, 我们怀疑是日志框架的问题, 排查到最后才发现是泛型的问题, 反复修改多次才解决了这个问题.</p> <p>父类是这样的: 有一个泛型占位符 T; 有一个 AtomicInteger 计数器, 用来记录 value 字段更新的次数, 其中 value 字段是泛型 T 类型的, setValue 方法每次为 value 赋值时对计数器进行 +1 操作. 我重写了 toString 方法, 输出 value 字段的值和计数器的值:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">class</span> <span class="token class-name">Parent</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
    <span class="token comment">// 用于记录value更新的次数, 模拟日志记录的逻辑</span>
    <span class="token class-name">AtomicInteger</span> updateCount <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicInteger</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">T</span> value<span class="token punctuation">;</span>

    <span class="token comment">// 重写toString, 输出值和值更新次数</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;value: %s updateCount: %d&quot;</span><span class="token punctuation">,</span> value<span class="token punctuation">,</span> updateCount<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 设置值</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setValue</span><span class="token punctuation">(</span><span class="token class-name">T</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> value<span class="token punctuation">;</span>
        updateCount<span class="token punctuation">.</span><span class="token function">incrementAndGet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>子类 Child1 的实现是这样的: <strong>继承父类, 但没有提供父类泛型参数</strong>; 定义了一个参数为 String 的 setValue 方法, 通过 super.setValue 调用父类方法实现日志记录. 我们也能明白, 开发同学这么设计是希望覆盖父类的 setValue 实现:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">class</span> <span class="token class-name">Child1</span> <span class="token keyword">extends</span> <span class="token class-name">Parent</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setValue</span><span class="token punctuation">(</span><span class="token class-name">String</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Child1.setValue called&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">setValue</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>在实现的时候, 子类方法的调用是<strong>通过反射</strong>进行的. 实例化 Child1 类型后, 通过 getClass().getMethods 方法获得所有的方法; 然后按照方法名过滤出 setValue 方法进行调用, 传入字符串 test 作为参数:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">Child1</span> child1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Child1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span>child1<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMethods</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>method <span class="token operator">-&gt;</span> method<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">&quot;setValue&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>method <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                method<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>child1<span class="token punctuation">,</span> <span class="token string">&quot;test&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>child1<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>运行代码后可以看到, <strong>虽然 Parent 的 value 字段正确设置了 test, 但父类的 setValue 方法调用了两次</strong>, 计数器也显示 2 而不是 1:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">Child1</span><span class="token punctuation">.</span>setValue called
<span class="token class-name">Parent</span><span class="token punctuation">.</span>setValue called
<span class="token class-name">Parent</span><span class="token punctuation">.</span>setValue called
value<span class="token operator">:</span> test updateCount<span class="token operator">:</span> <span class="token number">2</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>显然, 两次 Parent 的 setValue 方法调用, 是<strong>因为 getMethods 方法找到了两个名为 setValue 的方法, 分别是父类和子类的 setValue 方法</strong>.</p> <p>这个案例中, 子类方法重写父类方法失败的原因, 包括两方面:</p> <ol><li>一是, 子类没有指定 String 泛型参数, 父类的泛型方法 setValue(T value) 在泛型擦除后是 setValue(Object value), 子类中入参是 String 的 setValue 方法被当作了新方法;</li> <li>二是, <strong>子类的 setValue 方法没有增加 @Override 注解, 因此编译器没能检测到重写失败的问题. 这就说明, 重写子类方法时, 标记 @Override 是一个好习惯</strong>.</li></ol> <p>但是, 开发同学认为问题出在反射 API 使用不当, 却没意识到重写失败. 他查文档后发现, getMethods 方法能获得当前类和父类的所有 public 方法, 而 getDeclaredMethods 只能获得当前类所有的 public, protected, package 和 private 方法.</p> <p>于是, 他就用 getDeclaredMethods 替代了 getMethods:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span>child1<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDeclaredMethods</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>method <span class="token operator">-&gt;</span> method<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">&quot;setValue&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>method <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            method<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>child1<span class="token punctuation">,</span> <span class="token string">&quot;test&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>这样虽然能解决重复记录日志的问题, 但<strong>没有解决子类方法重写父类方法失败的问题</strong>, 得到如下输出:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">Child1</span><span class="token punctuation">.</span>setValue called
<span class="token class-name">Parent</span><span class="token punctuation">.</span>setValue called
value<span class="token operator">:</span> test updateCount<span class="token operator">:</span> <span class="token number">1</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>其实这治标不治本, 其他人使用 Child1 时还是会发现有两个 setValue 方法, 非常容易让人困惑.</p> <p>幸好, 架构师在修复上线前发现了这个问题, 让开发同学重新实现了 Child2, 继承 Parent 的时候提供了 String 作为泛型 T 类型, 并使用 @Override 关键字注释了 setValue 方法, 实现了真正有效的方法重写:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">class</span> <span class="token class-name">Child2</span> <span class="token keyword">extends</span> <span class="token class-name">Parent</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setValue</span><span class="token punctuation">(</span><span class="token class-name">String</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Child2.setValue called&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">setValue</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>但很可惜, 修复代码上线后, 还是出现了日志重复记录:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">Child2</span><span class="token punctuation">.</span>setValue called
<span class="token class-name">Parent</span><span class="token punctuation">.</span>setValue called
<span class="token class-name">Child2</span><span class="token punctuation">.</span>setValue called
<span class="token class-name">Parent</span><span class="token punctuation">.</span>setValue called
value<span class="token operator">:</span> test updateCount<span class="token operator">:</span> <span class="token number">2</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>可以看到, 这次是 Child2 类的 setValue 方法被调用了两次. 开发同学惊讶地说, 肯定是反射出 Bug 了, 通过 getDeclaredMethods 查找到的方法一定是来自 Child2 类本身; 而且, 怎么看 Child2 类中也只有一个 setValue 方法, 为什么还会重复呢?</p> <p>调试一下可以发现, <strong>Child2 类其实有 2 个 setValue 方法, 入参分别是 String 和 Object</strong>.</p> <p><img src="/img/0a37a2bab22db7cc49b131aac2bc5f2c-20230731165210-928i14p.png" alt=""></p> <p>如果不通过反射来调用方法, 确实很难发现这个问题. <strong>其实, 这就是泛型类型擦除导致的问题</strong>. 来分析一下.</p> <p><strong>Java 的泛型类型在编译后擦除为 Object</strong>. 虽然子类指定了父类泛型 T 类型是 String, 但编译后 T 会被擦除成为 Object, 所以<strong>父类 setValue 方法的入参是 Object, value 也是 Object</strong>. 如果子类 Child2 的 setValue 方法要覆盖父类的 setValue 方法, 那入参也必须是 Object. 所以, <strong>编译器会生成一个所谓的 bridge 桥接方法</strong>, 可以使用 javap 命令来反编译编译后的 Child2 类的 class 字节码:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>javap <span class="token operator">-</span>c <span class="token operator">/</span><span class="token class-name">Users</span><span class="token operator">/</span>zhuye<span class="token operator">/</span><span class="token class-name">Documents</span><span class="token operator">/</span>common<span class="token operator">-</span>mistakes<span class="token operator">/</span>target<span class="token operator">/</span>classes<span class="token operator">/</span>org<span class="token operator">/</span>geekbang<span class="token operator">/</span>time<span class="token operator">/</span>commonmistakes<span class="token operator">/</span>advancedfeatures<span class="token operator">/</span>demo3<span class="token operator">/</span><span class="token class-name">Child2</span><span class="token punctuation">.</span><span class="token keyword">class</span>
<span class="token class-name">Compiled</span> from <span class="token string">&quot;GenericAndInheritanceApplication.java&quot;</span>
<span class="token keyword">class</span> <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>geekbang<span class="token punctuation">.</span>time<span class="token punctuation">.</span>commonmistakes<span class="token punctuation">.</span>advancedfeatures<span class="token punctuation">.</span>demo3<span class="token punctuation">.</span></span>Child2</span> <span class="token keyword">extends</span> <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>geekbang<span class="token punctuation">.</span>time<span class="token punctuation">.</span>commonmistakes<span class="token punctuation">.</span>advancedfeatures<span class="token punctuation">.</span>demo3<span class="token punctuation">.</span></span>Parent</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>String</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
  <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>geekbang<span class="token punctuation">.</span>time<span class="token punctuation">.</span>commonmistakes<span class="token punctuation">.</span>advancedfeatures<span class="token punctuation">.</span>demo3<span class="token punctuation">.</span></span>Child2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Code</span><span class="token operator">:</span>
       <span class="token number">0</span><span class="token operator">:</span> aload_0
       <span class="token number">1</span><span class="token operator">:</span> invokespecial #<span class="token number">1</span>                  <span class="token comment">// Method org/geekbang/time/commonmistakes/advancedfeatures/demo3/Parent.&quot;&lt;init&gt;&quot;:()V</span>
       <span class="token number">4</span><span class="token operator">:</span> <span class="token keyword">return</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setValue</span><span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>String</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Code</span><span class="token operator">:</span>
       <span class="token number">0</span><span class="token operator">:</span> getstatic     #<span class="token number">2</span>                  <span class="token comment">// Field java/lang/System.out:Ljava/io/PrintStream;</span>
       <span class="token number">3</span><span class="token operator">:</span> ldc           #<span class="token number">3</span>                  <span class="token comment">// String Child2.setValue called</span>
       <span class="token number">5</span><span class="token operator">:</span> invokevirtual #<span class="token number">4</span>                  <span class="token comment">// Method java/io/PrintStream.println:(Ljava/lang/String;)V</span>
       <span class="token number">8</span><span class="token operator">:</span> aload_0
       <span class="token number">9</span><span class="token operator">:</span> aload_1
      <span class="token number">10</span><span class="token operator">:</span> invokespecial #<span class="token number">5</span>                  <span class="token comment">// Method org/geekbang/time/commonmistakes/advancedfeatures/demo3/Parent.setValue:(Ljava/lang/Object;)V</span>
      <span class="token number">13</span><span class="token operator">:</span> <span class="token keyword">return</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setValue</span><span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>Object</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Code</span><span class="token operator">:</span>
       <span class="token number">0</span><span class="token operator">:</span> aload_0
       <span class="token number">1</span><span class="token operator">:</span> aload_1
       <span class="token number">2</span><span class="token operator">:</span> checkcast     #<span class="token number">6</span>                  <span class="token comment">// class java/lang/String</span>
       <span class="token number">5</span><span class="token operator">:</span> invokevirtual #<span class="token number">7</span>                  <span class="token comment">// Method setValue:(Ljava/lang/String;)V</span>
       <span class="token number">8</span><span class="token operator">:</span> <span class="token keyword">return</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><p>可以看到, 入参为 Object 的 setValue 方法在内部调用了入参为 String 的 setValue 方法(第 27 行), 也就是代码里实现的那个方法. 如果编译器没有实现这个桥接方法, 那么 Child2 子类重写的是父类经过泛型类型擦除后, 入参是 Object 的 setValue 方法. <strong>这两个方法的参数, 一个是 String 一个是 Object, 明显不符合 Java 的语义</strong>:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">class</span> <span class="token class-name">Parent</span> <span class="token punctuation">{</span>
    <span class="token class-name">AtomicInteger</span> updateCount <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicInteger</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Object</span> value<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setValue</span><span class="token punctuation">(</span><span class="token class-name">Object</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Parent.setValue called&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> value<span class="token punctuation">;</span>
        updateCount<span class="token punctuation">.</span><span class="token function">incrementAndGet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">Child2</span> <span class="token keyword">extends</span> <span class="token class-name">Parent</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setValue</span><span class="token punctuation">(</span><span class="token class-name">String</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Child2.setValue called&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">setValue</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>使用 jclasslib 工具打开 Child2 类, 同样可以看到入参为 Object 的桥接方法上标记了 public + synthetic + bridge 三个属性. synthetic 代表由编译器生成的不可见代码, <strong>bridge 代表这是泛型类型擦除后生成的桥接代码</strong>:</p> <p><img src="/img/1be05386f86109f22c2716be4484b3a7-20230731165210-2jikhdg.png" alt=""></p> <p>知道这个问题之后, 修改方式就明朗了, 可以使用 method 的 isBridge 方法, 来判断方法<strong>是不是桥接方法</strong>:</p> <ol><li><strong>通过 getDeclaredMethods 方法获取到所有方法后, 必须同时根据方法名 setValue 和非 isBridge 两个条件过滤, 才能实现唯一过滤</strong>;</li> <li>使用 Stream 时, 如果希望只匹配 0 或 1 项的话, 可以考虑配合 ifPresent 来使用 findFirst 方法.</li></ol> <p>修复代码如下:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span>child2<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDeclaredMethods</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token comment">// 判断一下是否桥接方法</span>
        <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>method <span class="token operator">-&gt;</span> method<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">&quot;setValue&quot;</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>method<span class="token punctuation">.</span><span class="token function">isBridge</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">findFirst</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ifPresent</span><span class="token punctuation">(</span>method <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        method<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>chi2<span class="token punctuation">,</span> <span class="token string">&quot;test&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>这样就可以得到正确输出了:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">Child2</span><span class="token punctuation">.</span>setValue called
<span class="token class-name">Parent</span><span class="token punctuation">.</span>setValue called
value<span class="token operator">:</span> test updateCount<span class="token operator">:</span> <span class="token number">1</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p><strong>最后小结下, 使用反射查询类方法清单时, 要注意两点</strong>:</p> <ol><li><strong>getMethods 和 getDeclaredMethods 是有区别的, 前者可以查询到父类方法, 后者只能查询到当前类</strong>.</li> <li><strong>反射进行方法调用要注意过滤桥接方法.</strong></li></ol> <h5 id="注解可以继承吗"><a href="#注解可以继承吗" class="header-anchor">#</a> 注解可以继承吗?</h5> <p>注解可以为 Java 代码提供元数据, 各种框架也都会利用注解来暴露功能, 比如 Spring 框架中的 @Service, @Controller, @Bean 注解, Spring Boot 的 @SpringBootApplication 注解.</p> <p><mark><strong>框架可以通过类或方法等元素上标记的注解, 来了解它们的功能或特性, 并以此来启用或执行相应的功能. 通过注解而不是 API 调用来配置框架, 属于声明式交互, 可以简化框架的配置工作, 也可以和框架解耦.</strong></mark></p> <p>开发同学可能会认为, 类继承后, 类的注解也可以继承, 子类重写父类方法后, 父类方法上的注解也能作用于子类, 但这些观点其实是错误或者说是不全面的. 来验证下.</p> <p>首先, 定义一个包含 value 属性的 MyAnnotation 注解, 可以标记在<strong>方法或类</strong>上:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Target</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token class-name">ElementType</span><span class="token punctuation">.</span><span class="token constant">METHOD</span><span class="token punctuation">,</span> <span class="token class-name">ElementType</span><span class="token punctuation">.</span><span class="token constant">TYPE</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Retention</span><span class="token punctuation">(</span><span class="token class-name">RetentionPolicy</span><span class="token punctuation">.</span><span class="token constant">RUNTIME</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token annotation punctuation">@interface</span> <span class="token class-name">MyAnnotation</span> <span class="token punctuation">{</span>
    <span class="token class-name">String</span> <span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>然后, 定义一个标记了 @MyAnnotation 注解的父类 Parent, 设置 value 为 Class 字符串; 同时这个类的 foo 方法也标记了 @MyAnnotation 注解, 设置 value 为 Method 字符串. 接下来, 定义一个<strong>子类 Child 继承 Parent 父类, 并重写父类的 foo 方法</strong>, 子类的 foo 方法和类上都没有 @MyAnnotation 注解.</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@MyAnnotation</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;Class&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Parent</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@MyAnnotation</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;Method&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Child</span> <span class="token keyword">extends</span> <span class="token class-name">Parent</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>再接下来, 通过<strong>反射分别获取 Parent 和 Child 的类和方法的注解信息</strong>, 并输出注解的 value 属性的值(如果注解不存在则输出空字符串):</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">getAnnotationValue</span><span class="token punctuation">(</span><span class="token class-name">MyAnnotation</span> annotation<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>annotation <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> annotation<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">wrong</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">NoSuchMethodException</span> <span class="token punctuation">{</span>
    <span class="token comment">// 获取父类的类和方法上的注解</span>
    <span class="token class-name">Parent</span> parent <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Parent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;ParentClass:{}&quot;</span><span class="token punctuation">,</span> <span class="token function">getAnnotationValue</span><span class="token punctuation">(</span>parent<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAnnotation</span><span class="token punctuation">(</span><span class="token class-name">MyAnnotation</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;ParentMethod:{}&quot;</span><span class="token punctuation">,</span> <span class="token function">getAnnotationValue</span><span class="token punctuation">(</span>parent<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token string">&quot;foo&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAnnotation</span><span class="token punctuation">(</span><span class="token class-name">MyAnnotation</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 获取子类的类和方法上的注解</span>
    <span class="token class-name">Child</span> child <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Child</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;ChildClass:{}&quot;</span><span class="token punctuation">,</span> <span class="token function">getAnnotationValue</span><span class="token punctuation">(</span>child<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAnnotation</span><span class="token punctuation">(</span><span class="token class-name">MyAnnotation</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;ChildMethod:{}&quot;</span><span class="token punctuation">,</span> <span class="token function">getAnnotationValue</span><span class="token punctuation">(</span>child<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token string">&quot;foo&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAnnotation</span><span class="token punctuation">(</span><span class="token class-name">MyAnnotation</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>输出如下:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token punctuation">[</span>main<span class="token punctuation">]</span> <span class="token constant">INFO</span> <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>geekbang<span class="token punctuation">.</span>time<span class="token punctuation">.</span>commonmistakes<span class="token punctuation">.</span>advancedfeatures<span class="token punctuation">.</span>demo2<span class="token punctuation">.</span></span>AnnotationInheritanceApplication</span> <span class="token operator">-</span> <span class="token class-name">ParentClass</span><span class="token operator">:</span><span class="token class-name">Class</span>
<span class="token punctuation">[</span>main<span class="token punctuation">]</span> <span class="token constant">INFO</span> <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>geekbang<span class="token punctuation">.</span>time<span class="token punctuation">.</span>commonmistakes<span class="token punctuation">.</span>advancedfeatures<span class="token punctuation">.</span>demo2<span class="token punctuation">.</span></span>AnnotationInheritanceApplication</span> <span class="token operator">-</span> <span class="token class-name">ParentMethod</span><span class="token operator">:</span><span class="token class-name">Method</span>
<span class="token punctuation">[</span>main<span class="token punctuation">]</span> <span class="token constant">INFO</span> <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>geekbang<span class="token punctuation">.</span>time<span class="token punctuation">.</span>commonmistakes<span class="token punctuation">.</span>advancedfeatures<span class="token punctuation">.</span>demo2<span class="token punctuation">.</span></span>AnnotationInheritanceApplication</span> <span class="token operator">-</span> <span class="token class-name">ChildClass</span><span class="token operator">:</span>
<span class="token punctuation">[</span>main<span class="token punctuation">]</span> <span class="token constant">INFO</span> <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>geekbang<span class="token punctuation">.</span>time<span class="token punctuation">.</span>commonmistakes<span class="token punctuation">.</span>advancedfeatures<span class="token punctuation">.</span>demo2<span class="token punctuation">.</span></span>AnnotationInheritanceApplication</span> <span class="token operator">-</span> <span class="token class-name">ChildMethod</span><span class="token operator">:</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>可以看到, 父类的类和方法上的注解都可以正确获得, 但是子类的类和方法却不能. 这说明, <mark><strong>子类以及子类的方法, 无法自动继承父类和父类方法上的注解</strong></mark>.</p> <p>如果你详细了解过注解应该知道, 在<strong>注解上标记 @Inherited 元注解可以实现注解的继承</strong>. 那么, 把 @MyAnnotation 注解标记了 @Inherited, 就可以一键解决问题了吗?</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Target</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token class-name">ElementType</span><span class="token punctuation">.</span><span class="token constant">METHOD</span><span class="token punctuation">,</span> <span class="token class-name">ElementType</span><span class="token punctuation">.</span><span class="token constant">TYPE</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Retention</span><span class="token punctuation">(</span><span class="token class-name">RetentionPolicy</span><span class="token punctuation">.</span><span class="token constant">RUNTIME</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Inherited</span>
<span class="token keyword">public</span> <span class="token annotation punctuation">@interface</span> <span class="token class-name">MyAnnotation</span> <span class="token punctuation">{</span>
    <span class="token class-name">String</span> <span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>重新运行代码输出如下:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token punctuation">[</span>main<span class="token punctuation">]</span> <span class="token constant">INFO</span> <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>geekbang<span class="token punctuation">.</span>time<span class="token punctuation">.</span>commonmistakes<span class="token punctuation">.</span>advancedfeatures<span class="token punctuation">.</span>demo2<span class="token punctuation">.</span></span>AnnotationInheritanceApplication</span> <span class="token operator">-</span> <span class="token class-name">ParentClass</span><span class="token operator">:</span><span class="token class-name">Class</span>
<span class="token punctuation">[</span>main<span class="token punctuation">]</span> <span class="token constant">INFO</span> <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>geekbang<span class="token punctuation">.</span>time<span class="token punctuation">.</span>commonmistakes<span class="token punctuation">.</span>advancedfeatures<span class="token punctuation">.</span>demo2<span class="token punctuation">.</span></span>AnnotationInheritanceApplication</span> <span class="token operator">-</span> <span class="token class-name">ParentMethod</span><span class="token operator">:</span><span class="token class-name">Method</span>
<span class="token punctuation">[</span>main<span class="token punctuation">]</span> <span class="token constant">INFO</span> <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>geekbang<span class="token punctuation">.</span>time<span class="token punctuation">.</span>commonmistakes<span class="token punctuation">.</span>advancedfeatures<span class="token punctuation">.</span>demo2<span class="token punctuation">.</span></span>AnnotationInheritanceApplication</span> <span class="token operator">-</span> <span class="token class-name">ChildClass</span><span class="token operator">:</span><span class="token class-name">Class</span>
<span class="token punctuation">[</span>main<span class="token punctuation">]</span> <span class="token constant">INFO</span> <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>geekbang<span class="token punctuation">.</span>time<span class="token punctuation">.</span>commonmistakes<span class="token punctuation">.</span>advancedfeatures<span class="token punctuation">.</span>demo2<span class="token punctuation">.</span></span>AnnotationInheritanceApplication</span> <span class="token operator">-</span> <span class="token class-name">ChildMethod</span><span class="token operator">:</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>可以看到, <strong>子类可以获得父类类上的注解; 子类 foo 方法虽然是重写父类方法, 并且注解本身也支持继承, 但还是无法获得方法上的注解</strong>.</p> <p>如果再仔细阅读一下 @Inherited 的文档就会发现,  <mark><strong>@Inherited 只能实现类上的注解继承</strong></mark>. 要想实现方法上注解的继承, 可以<strong>通过反射在继承链上找到方法上的注解</strong>. 但这样实现起来很繁琐, 而且需要考虑桥接方法.</p> <p>好在 Spring 提供了 <strong>AnnotatedElementUtils</strong> 类, 来方便处理注解的继承问题. 这个类的 findMergedAnnotation 工具方法, 可以帮助找出父类和接口, 父类方法和接口方法上的注解, 并可以处理桥接方法, 实现一键找到继承链的注解:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">Child</span> child <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Child</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;ChildClass:{}&quot;</span><span class="token punctuation">,</span> <span class="token function">getAnnotationValue</span><span class="token punctuation">(</span><span class="token class-name">AnnotatedElementUtils</span><span class="token punctuation">.</span><span class="token function">findMergedAnnotation</span><span class="token punctuation">(</span>child<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">MyAnnotation</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;ChildMethod:{}&quot;</span><span class="token punctuation">,</span> <span class="token function">getAnnotationValue</span><span class="token punctuation">(</span><span class="token class-name">AnnotatedElementUtils</span><span class="token punctuation">.</span><span class="token function">findMergedAnnotation</span><span class="token punctuation">(</span>child<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token string">&quot;foo&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">MyAnnotation</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>修改后, 可以得到如下输出:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token punctuation">[</span>main<span class="token punctuation">]</span> <span class="token constant">INFO</span> <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>geekbang<span class="token punctuation">.</span>time<span class="token punctuation">.</span>commonmistakes<span class="token punctuation">.</span>advancedfeatures<span class="token punctuation">.</span>demo2<span class="token punctuation">.</span></span>AnnotationInheritanceApplication</span> <span class="token operator">-</span> <span class="token class-name">ChildClass</span><span class="token operator">:</span><span class="token class-name">Class</span>
<span class="token punctuation">[</span>main<span class="token punctuation">]</span> <span class="token constant">INFO</span> <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>geekbang<span class="token punctuation">.</span>time<span class="token punctuation">.</span>commonmistakes<span class="token punctuation">.</span>advancedfeatures<span class="token punctuation">.</span>demo2<span class="token punctuation">.</span></span>AnnotationInheritanceApplication</span> <span class="token operator">-</span> <span class="token class-name">ChildMethod</span><span class="token operator">:</span><span class="token class-name">Method</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>可以看到, 子类 foo 方法也获得了父类方法上的注解.</p> <h5 id="重点回顾-18"><a href="#重点回顾-18" class="header-anchor">#</a> 重点回顾</h5> <p>今天分享了使用 Java 反射, 注解和泛型高级特性配合 OOP 时, 可能会遇到的一些坑.</p> <p>第一, <strong>反射调用方法并不是通过调用时的传参确定方法重载, 而是在获取方法的时候通过方法名和参数类型来确定的</strong>. 遇到方法有包装类型和基本类型重载的时候, 需要特别注意这一点.</p> <p>第二, 反射获取类成员, 需要注意 getXXX 和 getDeclaredXXX 方法的区别, 其中 XXX 包括 Methods, Fields, Constructors, Annotations. 这两类方法, 针对不同的成员类型 XXX 和对象, 在实现上都有一些细节差异, 详情请查看官方文档. 今天提到的 getDeclaredMethods 方法无法获得父类定义的方法, 而 getMethods 方法可以, 只是差异之一, 不能适用于所有的 XXX.</p> <p>第三, <strong>泛型因为类型擦除会导致泛型方法 T 占位符被替换为 Object, 子类如果使用具体类型覆盖父类实现, 编译器会生成桥接方法</strong>. 这样既满足子类方法重写父类方法的定义, 又满足子类实现的方法有具体的类型. 使用反射来获取方法清单时, 需要特别注意这一点.</p> <p>第四, <strong>自定义注解可以通过标记元注解 @Inherited 实现注解的继承, 不过这只适用于类</strong>. 如果要继承定义在接口或方法上的注解, 可以使用 Spring 的工具类 AnnotatedElementUtils, 并注意各种 getXXX 方法和 findXXX 方法的区别, 详情查看 Spring 的文档.</p> <p>最后要说的是. <strong>编译后的代码和原始代码并不完全一致, 编译器可能会做一些优化, 加上还有诸如 AspectJ 等编译时增强框架, 使用反射动态获取类型的元数据可能会和编写的源码有差异, 这点需要特别注意</strong>. 可以在反射中多写断言, 遇到非预期的情况直接抛异常, 避免通过反射实现的业务逻辑不符合预期.</p> <h4 id="_19-spring框架-ioc和aop是扩展的核心"><a href="#_19-spring框架-ioc和aop是扩展的核心" class="header-anchor">#</a> 19-Spring框架:IoC和AOP是扩展的核心</h4> <p>今天来聊聊 Spring 框架中的 IoC 和 AOP, 及其容易出错的地方.</p> <p>熟悉 Java 的同学都知道, Spring 的家族庞大, 常用的模块就有 Spring Data, Spring Security, Spring Boot, Spring Cloud 等. 其实 Spring 体系虽然庞大, 但都是围绕 Spring Core 展开的, 而 <strong>Spring Core 中最核心的就是 IoC(控制反转)和 AOP(面向切面编程)</strong> .</p> <p>概括地说, IoC 和 AOP 的初衷是<strong>解耦和扩展</strong>. 理解这两个核心技术, 就可以让代码变得更灵活, 可随时替换, 以及业务组件间更解耦. 在接下来的两讲会深入剖析几个案例, 带你绕过业务中通过 Spring 实现 IoC 和 AOP 相关的坑.</p> <p>为了便于理解这两讲中的案例, 先回顾下 IoC 和 AOP 的基础知识.</p> <p>IoC, 其实就是一种设计思想. 使用 Spring 来实现 IoC, 意味着将设计好的对象交给 Spring 容器控制, 而不是直接在对象内部控制. 那为什么要让容器来管理对象呢? 或许你能想到的是, 使用 IoC 方便, 可以实现解耦. 但在我看来, 相比于这两个原因, 更重要的是 IoC 带来了更多的<strong>可能性</strong>.</p> <p><strong>如果以容器为依托来管理所有的框架和业务对象, 就不仅可以无侵入地调整对象的关系, 还可以无侵入地随时调整对象的属性, 甚至是实现对象的替换</strong>. 这就使得框架开发者在程序背后实现一些扩展不再是问题, 带来的可能性是无限的. 比如要监控的对象如果是 Bean, 实现就会非常简单. 所以这套容器体系, 不仅被 Spring Core 和 Spring Boot 大量依赖, 还实现了一些外部框架和 Spring 的无缝整合.</p> <p>AOP, 体现了松耦合, 高内聚的精髓, 在切面集中实现横切关注点(缓存, 权限, 日志等), 然后通过切点配置把代码注入合适的地方. 切面, 切点, 增强, 连接点, 是 AOP 中非常重要的概念, 也是这两讲会大量提及的.</p> <p>为方便理解, 可以把 Spring AOP 技术看作为蛋糕做奶油夹层的工序. 如果希望找到一个合适的地方把奶油注入蛋糕胚子中, 那应该如何指导工人完成操作呢?</p> <p><img src="/img/d5629e4fb5bf9efad9037a665b844305-20230731165210-mra68qz.png" alt=""></p> <ol><li>首先要提醒他, 只能往蛋糕胚子里面加奶油, 而不能上面或下面加奶油. 这就是<strong>连接点</strong>(Join point), 对于 Spring AOP 来说, <strong>连接点就是方法执行</strong>.</li> <li>然后要告诉他, <strong>在什么点切开蛋糕加奶油</strong>. 比如, 可以在蛋糕坯子中间加入一层奶油, 在中间切一次; 也可以在中间加两层奶油, 在 1/3 和 2/3 的地方切两次. 这就是<strong>切点</strong>(Pointcut), Spring AOP 中默认使用 AspectJ 查询表达式, <strong>通过在连接点运行查询表达式来匹配切入点</strong>.</li> <li>接下来也是最重要的, 要告诉他, 切开蛋糕后要做什么, 也就是加入奶油. 这就是<strong>增强(Advice)</strong> , 也叫作通知, 定义了切入切点后增强的方式, 包括<strong>前, 后, 环绕</strong>等. Spring AOP 中, 把增强定义为<strong>拦截器</strong>.</li> <li>最后要告诉他, 找到蛋糕胚子中要加奶油的地方并加入奶油. 为蛋糕做奶油夹层的操作, 对 Spring AOP 来说就是<strong>切面</strong>(Aspect), 也叫作方面. <strong>切面 = 切点 + 增强</strong>.</li></ol> <p>理解了这几个核心概念, 就可以继续分析案例了.</p> <p>要首先说明的是, Spring 相关问题的问题比较复杂, 一方面是 Spring 提供的 IoC 和 AOP 本就灵活, 另一方面 Spring Boot 的自动装配, Spring Cloud 复杂的模块会让问题排查变得更复杂. 因此, 今天这一讲, 会带你先打好基础, 通过两个案例来重点聊聊 IoC 和 AOP; 然后会在下一讲中分享 Spring 相关的坑.</p> <h5 id="单例的bean如何注入prototype的bean"><a href="#单例的bean如何注入prototype的bean" class="header-anchor">#</a> 单例的Bean如何注入Prototype的Bean?</h5> <p>大家虽然知道 Spring 创建的 Bean 默认是单例的, 但当 Bean 遇到继承的时候, 可能会忽略这一点. 为什么呢? 忽略这一点又会造成什么影响呢? 接下来就分享一个<strong>由单例引起内存泄露的案例</strong>.</p> <p>架构师一开始定义了这么一个 SayService 抽象类, 其中维护了一个类型是 ArrayList 的字段 data, 用于保存方法处理的中间数据. <strong>每次调用 say 方法都会往 data 加入新数据, 可以认为 SayService 是有状态, 如果 SayService 是单例的话必然会 OOM</strong>:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">SayService</span> <span class="token punctuation">{</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> data <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">say</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        data<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">IntStream</span><span class="token punctuation">.</span><span class="token function">rangeClosed</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1000000</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">mapToObj</span><span class="token punctuation">(</span>__ <span class="token operator">-&gt;</span> <span class="token string">&quot;a&quot;</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">joining</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token constant">UUID</span><span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;I'm {} size:{}&quot;</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">,</span> data<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>但实际开发的时候, 开发同学没有过多思考就把 SayHello 和 SayBye 类加上了  <strong>@Service 注解</strong>, 让它们成为了 Bean, 也没有考虑到父类是有状态的:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Service</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SayHello</span> <span class="token keyword">extends</span> <span class="token class-name">SayService</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">say</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">say</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;hello&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@Service</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SayBye</span> <span class="token keyword">extends</span> <span class="token class-name">SayService</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">say</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">say</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;bye&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p>许多开发同学认为, @Service 注解的意义在于, 能通过 @Autowired 注解让 Spring 自动注入对象, 就比如可以直接使用注入的 List 获取到 SayHello 和 SayBye, 而没想过<strong>类的生命周期</strong>:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Autowired</span>
<span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SayService</span><span class="token punctuation">&gt;</span></span> sayServiceList<span class="token punctuation">;</span>

<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;test&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;&lt;mark&gt;&lt;/mark&gt;&lt;mark&gt;&lt;/mark&gt;&lt;mark&gt;&lt;/mark&gt;&lt;mark&gt;&lt;/mark&gt;&lt;mark&gt;&lt;/mark&gt;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    sayServiceList<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token class-name">SayService</span><span class="token operator">::</span><span class="token function">say</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>这一个点非常容易忽略. <strong>开发基类的架构师将基类设计为有状态的, 但并不知道子类是怎么使用基类的</strong>; 而开发子类的同学, 没多想就直接标记了 @Service, 让类成为了 Bean, 通过 @Autowired 注解来注入这个服务. 但这样设置后, <strong>有状态的基类就可能产生内存泄露或线程安全问题</strong>.</p> <p>正确的方式是, <mark><strong>在为类标记上 @Service 注解把类型交由容器管理前, 首先评估一下类是否有状态, 然后为 Bean 设置合适的 Scope</strong></mark>. 好在上线前, 架构师发现了这个内存泄露问题, 开发同学也做了修改, 为 SayHello 和 SayBye 两个类都标记了 @Scope 注解, 设置了 PROTOTYPE 的生命周期, 也就是<strong>多例</strong>:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Scope</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token class-name">ConfigurableBeanFactory</span><span class="token punctuation">.</span><span class="token constant">SCOPE_PROTOTYPE</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>但上线后还是出现了内存泄漏, 证明修改是无效的.</p> <p>从日志可以看到, 第一次调用和第二次调用的时候, SayBye 对象都是 4c0bfe9e, SayHello 也是一样的问题. 从日志第 7 到 10 行还可以看到, 第二次调用后 List 的元素个数变为了 2, 说明父类 SayService 维护的 List 在不断增长, 不断调用必然出现 OOM:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token punctuation">[</span><span class="token number">15</span><span class="token operator">:</span><span class="token number">01</span><span class="token operator">:</span><span class="token number">09.349</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>http<span class="token operator">-</span>nio<span class="token operator">-</span><span class="token number">45678</span><span class="token operator">-</span>exec<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token constant">INFO</span> <span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token punctuation">.</span>s<span class="token punctuation">.</span>d<span class="token punctuation">.</span>BeanSingletonAndOrderController<span class="token operator">:</span><span class="token number">22</span>  <span class="token punctuation">]</span> <span class="token operator">-</span> <span class="token generics"><span class="token punctuation">&lt;</span>mark<span class="token punctuation">&gt;</span></span><span class="token operator">&lt;</span><span class="token operator">/</span>mark<span class="token operator">&gt;</span><span class="token generics"><span class="token punctuation">&lt;</span>mark<span class="token punctuation">&gt;</span></span><span class="token operator">&lt;</span><span class="token operator">/</span>mark<span class="token operator">&gt;</span><span class="token generics"><span class="token punctuation">&lt;</span>mark<span class="token punctuation">&gt;</span></span><span class="token operator">&lt;</span><span class="token operator">/</span>mark<span class="token operator">&gt;</span><span class="token generics"><span class="token punctuation">&lt;</span>mark<span class="token punctuation">&gt;</span></span><span class="token operator">&lt;</span><span class="token operator">/</span>mark<span class="token operator">&gt;</span><span class="token generics"><span class="token punctuation">&lt;</span>mark<span class="token punctuation">&gt;</span></span><span class="token operator">&lt;</span><span class="token operator">/</span>mark<span class="token operator">&gt;</span>
<span class="token punctuation">[</span><span class="token number">15</span><span class="token operator">:</span><span class="token number">01</span><span class="token operator">:</span><span class="token number">09.401</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>http<span class="token operator">-</span>nio<span class="token operator">-</span><span class="token number">45678</span><span class="token operator">-</span>exec<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token constant">INFO</span> <span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>g<span class="token punctuation">.</span>t<span class="token punctuation">.</span>c<span class="token punctuation">.</span>spring<span class="token punctuation">.</span>demo1<span class="token punctuation">.</span></span>SayService</span>         <span class="token operator">:</span><span class="token number">19</span>  <span class="token punctuation">]</span> <span class="token operator">-</span> <span class="token class-name">I</span>'m <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>geekbang<span class="token punctuation">.</span>time<span class="token punctuation">.</span>commonmistakes<span class="token punctuation">.</span>spring<span class="token punctuation">.</span>demo1<span class="token punctuation">.</span></span>SayBye</span><span class="token annotation punctuation">@4c0bfe9e</span> size<span class="token operator">:</span><span class="token number">1</span>
<span class="token punctuation">[</span><span class="token number">15</span><span class="token operator">:</span><span class="token number">01</span><span class="token operator">:</span><span class="token number">09.402</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>http<span class="token operator">-</span>nio<span class="token operator">-</span><span class="token number">45678</span><span class="token operator">-</span>exec<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token constant">INFO</span> <span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token class-name"><span class="token namespace">t<span class="token punctuation">.</span>commonmistakes<span class="token punctuation">.</span>spring<span class="token punctuation">.</span>demo1<span class="token punctuation">.</span></span>SayBye</span><span class="token operator">:</span><span class="token number">16</span>  <span class="token punctuation">]</span> <span class="token operator">-</span> bye
<span class="token punctuation">[</span><span class="token number">15</span><span class="token operator">:</span><span class="token number">01</span><span class="token operator">:</span><span class="token number">09.469</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>http<span class="token operator">-</span>nio<span class="token operator">-</span><span class="token number">45678</span><span class="token operator">-</span>exec<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token constant">INFO</span> <span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>g<span class="token punctuation">.</span>t<span class="token punctuation">.</span>c<span class="token punctuation">.</span>spring<span class="token punctuation">.</span>demo1<span class="token punctuation">.</span></span>SayService</span>         <span class="token operator">:</span><span class="token number">19</span>  <span class="token punctuation">]</span> <span class="token operator">-</span> <span class="token class-name">I</span>'m <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>geekbang<span class="token punctuation">.</span>time<span class="token punctuation">.</span>commonmistakes<span class="token punctuation">.</span>spring<span class="token punctuation">.</span>demo1<span class="token punctuation">.</span></span>SayHello</span><span class="token annotation punctuation">@490fbeaa</span> size<span class="token operator">:</span><span class="token number">1</span>
<span class="token punctuation">[</span><span class="token number">15</span><span class="token operator">:</span><span class="token number">01</span><span class="token operator">:</span><span class="token number">09.469</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>http<span class="token operator">-</span>nio<span class="token operator">-</span><span class="token number">45678</span><span class="token operator">-</span>exec<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token constant">INFO</span> <span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>g<span class="token punctuation">.</span>t<span class="token punctuation">.</span>c<span class="token punctuation">.</span>spring<span class="token punctuation">.</span>demo1<span class="token punctuation">.</span></span>SayHello</span>           <span class="token operator">:</span><span class="token number">17</span>  <span class="token punctuation">]</span> <span class="token operator">-</span> hello
<span class="token punctuation">[</span><span class="token number">15</span><span class="token operator">:</span><span class="token number">01</span><span class="token operator">:</span><span class="token number">15.167</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>http<span class="token operator">-</span>nio<span class="token operator">-</span><span class="token number">45678</span><span class="token operator">-</span>exec<span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token constant">INFO</span> <span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token punctuation">.</span>s<span class="token punctuation">.</span>d<span class="token punctuation">.</span>BeanSingletonAndOrderController<span class="token operator">:</span><span class="token number">22</span>  <span class="token punctuation">]</span> <span class="token operator">-</span> <span class="token generics"><span class="token punctuation">&lt;</span>mark<span class="token punctuation">&gt;</span></span><span class="token operator">&lt;</span><span class="token operator">/</span>mark<span class="token operator">&gt;</span><span class="token generics"><span class="token punctuation">&lt;</span>mark<span class="token punctuation">&gt;</span></span><span class="token operator">&lt;</span><span class="token operator">/</span>mark<span class="token operator">&gt;</span><span class="token generics"><span class="token punctuation">&lt;</span>mark<span class="token punctuation">&gt;</span></span><span class="token operator">&lt;</span><span class="token operator">/</span>mark<span class="token operator">&gt;</span><span class="token generics"><span class="token punctuation">&lt;</span>mark<span class="token punctuation">&gt;</span></span><span class="token operator">&lt;</span><span class="token operator">/</span>mark<span class="token operator">&gt;</span><span class="token generics"><span class="token punctuation">&lt;</span>mark<span class="token punctuation">&gt;</span></span><span class="token operator">&lt;</span><span class="token operator">/</span>mark<span class="token operator">&gt;</span>
<span class="token punctuation">[</span><span class="token number">15</span><span class="token operator">:</span><span class="token number">01</span><span class="token operator">:</span><span class="token number">15.197</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>http<span class="token operator">-</span>nio<span class="token operator">-</span><span class="token number">45678</span><span class="token operator">-</span>exec<span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token constant">INFO</span> <span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>g<span class="token punctuation">.</span>t<span class="token punctuation">.</span>c<span class="token punctuation">.</span>spring<span class="token punctuation">.</span>demo1<span class="token punctuation">.</span></span>SayService</span>         <span class="token operator">:</span><span class="token number">19</span>  <span class="token punctuation">]</span> <span class="token operator">-</span> <span class="token class-name">I</span>'m <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>geekbang<span class="token punctuation">.</span>time<span class="token punctuation">.</span>commonmistakes<span class="token punctuation">.</span>spring<span class="token punctuation">.</span>demo1<span class="token punctuation">.</span></span>SayBye</span><span class="token annotation punctuation">@4c0bfe9e</span> size<span class="token operator">:</span><span class="token number">2</span>
<span class="token punctuation">[</span><span class="token number">15</span><span class="token operator">:</span><span class="token number">01</span><span class="token operator">:</span><span class="token number">15.198</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>http<span class="token operator">-</span>nio<span class="token operator">-</span><span class="token number">45678</span><span class="token operator">-</span>exec<span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token constant">INFO</span> <span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token class-name"><span class="token namespace">t<span class="token punctuation">.</span>commonmistakes<span class="token punctuation">.</span>spring<span class="token punctuation">.</span>demo1<span class="token punctuation">.</span></span>SayBye</span><span class="token operator">:</span><span class="token number">16</span>  <span class="token punctuation">]</span> <span class="token operator">-</span> bye
<span class="token punctuation">[</span><span class="token number">15</span><span class="token operator">:</span><span class="token number">01</span><span class="token operator">:</span><span class="token number">15.224</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>http<span class="token operator">-</span>nio<span class="token operator">-</span><span class="token number">45678</span><span class="token operator">-</span>exec<span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token constant">INFO</span> <span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>g<span class="token punctuation">.</span>t<span class="token punctuation">.</span>c<span class="token punctuation">.</span>spring<span class="token punctuation">.</span>demo1<span class="token punctuation">.</span></span>SayService</span>         <span class="token operator">:</span><span class="token number">19</span>  <span class="token punctuation">]</span> <span class="token operator">-</span> <span class="token class-name">I</span>'m <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>geekbang<span class="token punctuation">.</span>time<span class="token punctuation">.</span>commonmistakes<span class="token punctuation">.</span>spring<span class="token punctuation">.</span>demo1<span class="token punctuation">.</span></span>SayHello</span><span class="token annotation punctuation">@490fbeaa</span> size<span class="token operator">:</span><span class="token number">2</span>
<span class="token punctuation">[</span><span class="token number">15</span><span class="token operator">:</span><span class="token number">01</span><span class="token operator">:</span><span class="token number">15.224</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>http<span class="token operator">-</span>nio<span class="token operator">-</span><span class="token number">45678</span><span class="token operator">-</span>exec<span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token constant">INFO</span> <span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>g<span class="token punctuation">.</span>t<span class="token punctuation">.</span>c<span class="token punctuation">.</span>spring<span class="token punctuation">.</span>demo1<span class="token punctuation">.</span></span>SayHello</span>           <span class="token operator">:</span><span class="token number">17</span>  <span class="token punctuation">]</span> <span class="token operator">-</span> hello
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>这就引出了<strong>单例的 Bean 如何注入 Prototype 的 Bean 这个问题</strong>. Controller 标记了 @RestController 注解, 而 @RestController 注解 = @Controller 注解 + @ResponseBody 注解, 又因为 @Controller 标记了 @Component 元注解, 所以 @RestController 注解其实也是一个 Spring Bean:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// @RestController注解=@Controller注解+@ResponseBody注解@Target(ElementType.TYPE)</span>
<span class="token annotation punctuation">@Retention</span><span class="token punctuation">(</span><span class="token class-name">RetentionPolicy</span><span class="token punctuation">.</span><span class="token constant">RUNTIME</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Documented</span>
<span class="token annotation punctuation">@Controller</span>
<span class="token annotation punctuation">@ResponseBody</span>
<span class="token keyword">public</span> <span class="token annotation punctuation">@interface</span> <span class="token class-name">RestController</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>

<span class="token comment">// @Controller又标记了@Component元注解</span>
<span class="token annotation punctuation">@Target</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token class-name">ElementType</span><span class="token punctuation">.</span><span class="token constant">TYPE</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Retention</span><span class="token punctuation">(</span><span class="token class-name">RetentionPolicy</span><span class="token punctuation">.</span><span class="token constant">RUNTIME</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Documented</span>
<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token annotation punctuation">@interface</span> <span class="token class-name">Controller</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p><strong>Bean 默认是单例的,</strong> <mark><strong>所以单例的 Controller 注入的 Service 也是一次性创建的, 即使 Service 本身标识了 prototype 的范围也没用</strong></mark>​ <strong>.</strong></p> <p>修复方式是, 让 Service 以代理方式注入. 这样虽然 Controller 本身是单例的, <strong>但每次都能从代理获取 Service</strong>. 这样一来, prototype 范围的配置才能真正生效:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Scope</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token class-name">ConfigurableBeanFactory</span><span class="token punctuation">.</span><span class="token constant">SCOPE_PROTOTYPE</span><span class="token punctuation">,</span> proxyMode <span class="token operator">=</span> <span class="token class-name">ScopedProxyMode</span><span class="token punctuation">.</span><span class="token constant">TARGET_CLASS</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>通过日志可以确认这种修复方式有效:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token punctuation">[</span><span class="token number">15</span><span class="token operator">:</span><span class="token number">08</span><span class="token operator">:</span><span class="token number">42.649</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>http<span class="token operator">-</span>nio<span class="token operator">-</span><span class="token number">45678</span><span class="token operator">-</span>exec<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token constant">INFO</span> <span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token punctuation">.</span>s<span class="token punctuation">.</span>d<span class="token punctuation">.</span>BeanSingletonAndOrderController<span class="token operator">:</span><span class="token number">22</span>  <span class="token punctuation">]</span> <span class="token operator">-</span> <span class="token generics"><span class="token punctuation">&lt;</span>mark<span class="token punctuation">&gt;</span></span><span class="token operator">&lt;</span><span class="token operator">/</span>mark<span class="token operator">&gt;</span><span class="token generics"><span class="token punctuation">&lt;</span>mark<span class="token punctuation">&gt;</span></span><span class="token operator">&lt;</span><span class="token operator">/</span>mark<span class="token operator">&gt;</span><span class="token generics"><span class="token punctuation">&lt;</span>mark<span class="token punctuation">&gt;</span></span><span class="token operator">&lt;</span><span class="token operator">/</span>mark<span class="token operator">&gt;</span><span class="token generics"><span class="token punctuation">&lt;</span>mark<span class="token punctuation">&gt;</span></span><span class="token operator">&lt;</span><span class="token operator">/</span>mark<span class="token operator">&gt;</span><span class="token generics"><span class="token punctuation">&lt;</span>mark<span class="token punctuation">&gt;</span></span><span class="token operator">&lt;</span><span class="token operator">/</span>mark<span class="token operator">&gt;</span>
<span class="token punctuation">[</span><span class="token number">15</span><span class="token operator">:</span><span class="token number">08</span><span class="token operator">:</span><span class="token number">42.747</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>http<span class="token operator">-</span>nio<span class="token operator">-</span><span class="token number">45678</span><span class="token operator">-</span>exec<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token constant">INFO</span> <span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>g<span class="token punctuation">.</span>t<span class="token punctuation">.</span>c<span class="token punctuation">.</span>spring<span class="token punctuation">.</span>demo1<span class="token punctuation">.</span></span>SayService</span>         <span class="token operator">:</span><span class="token number">19</span>  <span class="token punctuation">]</span> <span class="token operator">-</span> <span class="token class-name">I</span>'m <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>geekbang<span class="token punctuation">.</span>time<span class="token punctuation">.</span>commonmistakes<span class="token punctuation">.</span>spring<span class="token punctuation">.</span>demo1<span class="token punctuation">.</span></span>SayBye</span><span class="token annotation punctuation">@3fa64743</span> size<span class="token operator">:</span><span class="token number">1</span>
<span class="token punctuation">[</span><span class="token number">15</span><span class="token operator">:</span><span class="token number">08</span><span class="token operator">:</span><span class="token number">42.747</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>http<span class="token operator">-</span>nio<span class="token operator">-</span><span class="token number">45678</span><span class="token operator">-</span>exec<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token constant">INFO</span> <span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token class-name"><span class="token namespace">t<span class="token punctuation">.</span>commonmistakes<span class="token punctuation">.</span>spring<span class="token punctuation">.</span>demo1<span class="token punctuation">.</span></span>SayBye</span><span class="token operator">:</span><span class="token number">17</span>  <span class="token punctuation">]</span> <span class="token operator">-</span> bye
<span class="token punctuation">[</span><span class="token number">15</span><span class="token operator">:</span><span class="token number">08</span><span class="token operator">:</span><span class="token number">42.871</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>http<span class="token operator">-</span>nio<span class="token operator">-</span><span class="token number">45678</span><span class="token operator">-</span>exec<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token constant">INFO</span> <span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>g<span class="token punctuation">.</span>t<span class="token punctuation">.</span>c<span class="token punctuation">.</span>spring<span class="token punctuation">.</span>demo1<span class="token punctuation">.</span></span>SayService</span>         <span class="token operator">:</span><span class="token number">19</span>  <span class="token punctuation">]</span> <span class="token operator">-</span> <span class="token class-name">I</span>'m <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>geekbang<span class="token punctuation">.</span>time<span class="token punctuation">.</span>commonmistakes<span class="token punctuation">.</span>spring<span class="token punctuation">.</span>demo1<span class="token punctuation">.</span></span>SayHello</span><span class="token annotation punctuation">@2f0b779</span> size<span class="token operator">:</span><span class="token number">1</span>
<span class="token punctuation">[</span><span class="token number">15</span><span class="token operator">:</span><span class="token number">08</span><span class="token operator">:</span><span class="token number">42.872</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>http<span class="token operator">-</span>nio<span class="token operator">-</span><span class="token number">45678</span><span class="token operator">-</span>exec<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token constant">INFO</span> <span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>g<span class="token punctuation">.</span>t<span class="token punctuation">.</span>c<span class="token punctuation">.</span>spring<span class="token punctuation">.</span>demo1<span class="token punctuation">.</span></span>SayHello</span>           <span class="token operator">:</span><span class="token number">17</span>  <span class="token punctuation">]</span> <span class="token operator">-</span> hello
<span class="token punctuation">[</span><span class="token number">15</span><span class="token operator">:</span><span class="token number">08</span><span class="token operator">:</span><span class="token number">42.932</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>http<span class="token operator">-</span>nio<span class="token operator">-</span><span class="token number">45678</span><span class="token operator">-</span>exec<span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token constant">INFO</span> <span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token punctuation">.</span>s<span class="token punctuation">.</span>d<span class="token punctuation">.</span>BeanSingletonAndOrderController<span class="token operator">:</span><span class="token number">22</span>  <span class="token punctuation">]</span> <span class="token operator">-</span> <span class="token generics"><span class="token punctuation">&lt;</span>mark<span class="token punctuation">&gt;</span></span><span class="token operator">&lt;</span><span class="token operator">/</span>mark<span class="token operator">&gt;</span><span class="token generics"><span class="token punctuation">&lt;</span>mark<span class="token punctuation">&gt;</span></span><span class="token operator">&lt;</span><span class="token operator">/</span>mark<span class="token operator">&gt;</span><span class="token generics"><span class="token punctuation">&lt;</span>mark<span class="token punctuation">&gt;</span></span><span class="token operator">&lt;</span><span class="token operator">/</span>mark<span class="token operator">&gt;</span><span class="token generics"><span class="token punctuation">&lt;</span>mark<span class="token punctuation">&gt;</span></span><span class="token operator">&lt;</span><span class="token operator">/</span>mark<span class="token operator">&gt;</span><span class="token generics"><span class="token punctuation">&lt;</span>mark<span class="token punctuation">&gt;</span></span><span class="token operator">&lt;</span><span class="token operator">/</span>mark<span class="token operator">&gt;</span>
<span class="token punctuation">[</span><span class="token number">15</span><span class="token operator">:</span><span class="token number">08</span><span class="token operator">:</span><span class="token number">42.991</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>http<span class="token operator">-</span>nio<span class="token operator">-</span><span class="token number">45678</span><span class="token operator">-</span>exec<span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token constant">INFO</span> <span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>g<span class="token punctuation">.</span>t<span class="token punctuation">.</span>c<span class="token punctuation">.</span>spring<span class="token punctuation">.</span>demo1<span class="token punctuation">.</span></span>SayService</span>         <span class="token operator">:</span><span class="token number">19</span>  <span class="token punctuation">]</span> <span class="token operator">-</span> <span class="token class-name">I</span>'m <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>geekbang<span class="token punctuation">.</span>time<span class="token punctuation">.</span>commonmistakes<span class="token punctuation">.</span>spring<span class="token punctuation">.</span>demo1<span class="token punctuation">.</span></span>SayBye</span><span class="token annotation punctuation">@7319b18e</span> size<span class="token operator">:</span><span class="token number">1</span>
<span class="token punctuation">[</span><span class="token number">15</span><span class="token operator">:</span><span class="token number">08</span><span class="token operator">:</span><span class="token number">42.992</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>http<span class="token operator">-</span>nio<span class="token operator">-</span><span class="token number">45678</span><span class="token operator">-</span>exec<span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token constant">INFO</span> <span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token class-name"><span class="token namespace">t<span class="token punctuation">.</span>commonmistakes<span class="token punctuation">.</span>spring<span class="token punctuation">.</span>demo1<span class="token punctuation">.</span></span>SayBye</span><span class="token operator">:</span><span class="token number">17</span>  <span class="token punctuation">]</span> <span class="token operator">-</span> bye
<span class="token punctuation">[</span><span class="token number">15</span><span class="token operator">:</span><span class="token number">08</span><span class="token operator">:</span><span class="token number">43.046</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>http<span class="token operator">-</span>nio<span class="token operator">-</span><span class="token number">45678</span><span class="token operator">-</span>exec<span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token constant">INFO</span> <span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>g<span class="token punctuation">.</span>t<span class="token punctuation">.</span>c<span class="token punctuation">.</span>spring<span class="token punctuation">.</span>demo1<span class="token punctuation">.</span></span>SayService</span>         <span class="token operator">:</span><span class="token number">19</span>  <span class="token punctuation">]</span> <span class="token operator">-</span> <span class="token class-name">I</span>'m <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>geekbang<span class="token punctuation">.</span>time<span class="token punctuation">.</span>commonmistakes<span class="token punctuation">.</span>spring<span class="token punctuation">.</span>demo1<span class="token punctuation">.</span></span>SayHello</span><span class="token annotation punctuation">@77262b35</span> size<span class="token operator">:</span><span class="token number">1</span>
<span class="token punctuation">[</span><span class="token number">15</span><span class="token operator">:</span><span class="token number">08</span><span class="token operator">:</span><span class="token number">43.046</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>http<span class="token operator">-</span>nio<span class="token operator">-</span><span class="token number">45678</span><span class="token operator">-</span>exec<span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token constant">INFO</span> <span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>g<span class="token punctuation">.</span>t<span class="token punctuation">.</span>c<span class="token punctuation">.</span>spring<span class="token punctuation">.</span>demo1<span class="token punctuation">.</span></span>SayHello</span>           <span class="token operator">:</span><span class="token number">17</span>  <span class="token punctuation">]</span> <span class="token operator">-</span> hello
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>调试一下也可以发现, <strong>注入的 Service 都是 Spring 生成的代理类</strong>:</p> <p><img src="/img/ebc60c41cb5e3d8d1d4cd474743b30cf-20230731165210-d4ogcyo.png" alt=""></p> <p>当然, 如果不希望走代理的话还有一种方式是, <strong>每次直接从 ApplicationContext 中获取 Bean</strong>:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Autowired</span>
<span class="token keyword">private</span> <span class="token class-name">ApplicationContext</span> applicationContext<span class="token punctuation">;</span>

<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;test2&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">test2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    applicationContext<span class="token punctuation">.</span><span class="token function">getBeansOfType</span><span class="token punctuation">(</span><span class="token class-name">SayService</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token class-name">SayService</span><span class="token operator">::</span><span class="token function">say</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>如果细心的话, 可以发现另一个潜在的问题. 这里 Spring 注入的 SayService 的 List, 第一个元素是 SayBye, 第二个元素是 SayHello. 但我们更希望的是先执行 Hello 再执行 Bye, 所以注入一个 List Bean 时, 需要进一步考虑 Bean 的顺序或者说优先级.</p> <p>大多数情况下顺序并不是那么重要, 但对于 AOP, 顺序可能会引发致命问题. 继续往下看这个问题.</p> <h5 id="监控切面因为顺序问题导致spring事务失效"><a href="#监控切面因为顺序问题导致spring事务失效" class="header-anchor">#</a> 监控切面因为顺序问题导致Spring事务失效</h5> <p>实现横切关注点, 是 AOP 非常常见的一个应用. 我曾看到过一个不错的 AOP 实践, 通过 AOP 实现了一个整合日志记录, 异常处理和方法耗时打点为一体的统一切面. 但后来发现, 使用了 AOP 切面后, 这个应用的声明式事务处理居然都是无效的. 可以先回顾下第 6 讲提到的, Spring 事务失效的几种可能性.</p> <p>现在来看下这个案例, <strong>分析下 AOP 实现的监控组件和事务失效有什么关系, 以及通过 AOP 实现监控组件是否还有其他坑</strong>.</p> <p>首先, 定义一个自定义注解 Metrics, 打上了该注解的方法<strong>可以实现各种监控功能</strong>:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Retention</span><span class="token punctuation">(</span><span class="token class-name">RetentionPolicy</span><span class="token punctuation">.</span><span class="token constant">RUNTIME</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Target</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token class-name">ElementType</span><span class="token punctuation">.</span><span class="token constant">METHOD</span><span class="token punctuation">,</span> <span class="token class-name">ElementType</span><span class="token punctuation">.</span><span class="token constant">TYPE</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token annotation punctuation">@interface</span> <span class="token class-name">Metrics</span> <span class="token punctuation">{</span>
    <span class="token comment">/**
     * 在方法成功执行后打点, 记录方法的执行时间发送到指标系统, 默认开启
     */</span>
    <span class="token keyword">boolean</span> <span class="token function">recordSuccessMetrics</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * 在方法成功失败后打点, 记录方法的执行时间发送到指标系统, 默认开启
     */</span>
    <span class="token keyword">boolean</span> <span class="token function">recordFailMetrics</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * 通过日志记录请求参数, 默认开启
     */</span>
    <span class="token keyword">boolean</span> <span class="token function">logParameters</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * 通过日志记录方法返回值, 默认开启
     */</span>
    <span class="token keyword">boolean</span> <span class="token function">logReturn</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * 出现异常后通过日志记录异常信息, 默认开启
     */</span>
    <span class="token keyword">boolean</span> <span class="token function">logException</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * 出现异常后忽略异常返回默认值, 默认关闭
     */</span>
    <span class="token keyword">boolean</span> <span class="token function">ignoreException</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br></div></div><p>然后, 实现一个切面完成 Metrics 注解提供的功能. 这个<strong>切面可以实现标记了 @RestController 注解的 Web 控制器的自动切入, 如果还需要对更多 Bean 进行切入的话, 再自行标记 @Metrics 注解</strong>.</p> <blockquote><p>备注: 这段代码有些长, 里面还用到了一些小技巧, 需要仔细阅读代码中的注释.</p></blockquote> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Aspect</span>
<span class="token annotation punctuation">@Component</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MetricsAspect</span> <span class="token punctuation">{</span>
    <span class="token comment">// 让Spring注入ObjectMapper, 以方便通过JSON序列化来记录方法入参和出参</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">ObjectMapper</span> objectMapper<span class="token punctuation">;</span>

    <span class="token comment">// 实现一个返回Java基本类型默认值的工具. 其实, 也可以逐一写很多if-else判断类型, 然后手动设置其默认值. 这里为了减少代码量用了一个小技巧, 即通过初始化一个具有1个元素的数组, 然后通过获取这个数组的值来获取基本类型默认值</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Class</span><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> <span class="token constant">DEFAULT_VALUES</span> <span class="token operator">=</span> <span class="token class-name">Stream</span>
            <span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token keyword">boolean</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token keyword">byte</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token keyword">double</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token keyword">float</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token keyword">long</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token keyword">short</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token function">toMap</span><span class="token punctuation">(</span>clazz <span class="token operator">-&gt;</span> <span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span> clazz<span class="token punctuation">,</span> clazz <span class="token operator">-&gt;</span> <span class="token class-name">Array</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">Array</span><span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span>clazz<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">T</span> <span class="token function">getDefaultValue</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> clazz<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">)</span> <span class="token constant">DEFAULT_VALUES</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>clazz<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// @annotation指示器实现对标记了Metrics注解的方法进行匹配</span>
    <span class="token annotation punctuation">@Pointcut</span><span class="token punctuation">(</span><span class="token string">&quot;within(@org.geekbang.time.commonmistakes.springpart1.aopmetrics.Metrics *)&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">withMetricsAnnotation</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// within指示器实现了匹配那些类型上标记了@RestController注解的方法</span>
    <span class="token annotation punctuation">@Pointcut</span><span class="token punctuation">(</span><span class="token string">&quot;within(@org.springframework.web.bind.annotation.RestController *)&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">controllerBean</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Around</span><span class="token punctuation">(</span><span class="token string">&quot;controllerBean() || withMetricsAnnotation()&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">metrics</span><span class="token punctuation">(</span><span class="token class-name">ProceedingJoinPoint</span> pjp<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">{</span>
        <span class="token comment">// 通过连接点获取方法签名和方法上Metrics注解, 并根据方法签名生成日志中要输出的方法定义描述</span>
        <span class="token class-name">MethodSignature</span> signature <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">MethodSignature</span><span class="token punctuation">)</span> pjp<span class="token punctuation">.</span><span class="token function">getSignature</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Metrics</span> metrics <span class="token operator">=</span> signature<span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAnnotation</span><span class="token punctuation">(</span><span class="token class-name">Metrics</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
        <span class="token class-name">String</span> name <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;【%s】【%s】&quot;</span><span class="token punctuation">,</span> signature<span class="token punctuation">.</span><span class="token function">getDeclaringType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> signature<span class="token punctuation">.</span><span class="token function">toLongString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 因为需要默认对所有@RestController标记的Web控制器实现@Metrics注解的功能, 在这种情况下方法上必然是没有@Metrics注解的, 我们需要获取一个默认注解. 虽然可以手动实例化一个@Metrics注解的实例出来, 但为了节省代码行数, 我们通过在一个内部类上定义@Metrics注解方式, 然后通过反射获取注解的小技巧, 来获得一个默认的@Metrics注解的实例</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>metrics <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token annotation punctuation">@Metrics</span>
            <span class="token keyword">final</span> <span class="token keyword">class</span> c <span class="token punctuation">{</span><span class="token punctuation">}</span>
            metrics <span class="token operator">=</span> c<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getAnnotation</span><span class="token punctuation">(</span><span class="token class-name">Metrics</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 尝试从请求上下文(如果有的话)获得请求URL, 以方便定位问题</span>
        <span class="token class-name">RequestAttributes</span> requestAttributes <span class="token operator">=</span> <span class="token class-name">RequestContextHolder</span><span class="token punctuation">.</span><span class="token function">getRequestAttributes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>requestAttributes <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">HttpServletRequest</span> request <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">ServletRequestAttributes</span><span class="token punctuation">)</span> requestAttributes<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>request <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
                name <span class="token operator">+=</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;【%s】&quot;</span><span class="token punctuation">,</span> request<span class="token punctuation">.</span><span class="token function">getRequestURL</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 实现的是入参的日志输出</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>metrics<span class="token punctuation">.</span><span class="token function">logParameters</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;【入参日志】调用 %s 的参数是: 【%s】&quot;</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> objectMapper<span class="token punctuation">.</span><span class="token function">writeValueAsString</span><span class="token punctuation">(</span>pjp<span class="token punctuation">.</span><span class="token function">getArgs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 实现连接点方法的执行, 以及成功失败的打点, 出现异常的时候还会记录日志</span>
        <span class="token class-name">Object</span> returnValue<span class="token punctuation">;</span>
        <span class="token class-name">Instant</span> start <span class="token operator">=</span> <span class="token class-name">Instant</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            returnValue <span class="token operator">=</span> pjp<span class="token punctuation">.</span><span class="token function">proceed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>metrics<span class="token punctuation">.</span><span class="token function">recordSuccessMetrics</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token comment">// 在生产级代码中, 我们应考虑使用类似Micrometer的指标框架, 把打点信息记录到时间序列数据库中, 实现通过图表来查看方法的调用次数和执行时间, 在设计篇我们会重点介绍</span>
                log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;【成功打点】调用 %s 成功, 耗时: %d ms&quot;</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> <span class="token class-name">Duration</span><span class="token punctuation">.</span><span class="token function">between</span><span class="token punctuation">(</span>start<span class="token punctuation">,</span> <span class="token class-name">Instant</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>metrics<span class="token punctuation">.</span><span class="token function">recordFailMetrics</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;【失败打点】调用 %s 失败, 耗时: %d ms&quot;</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> <span class="token class-name">Duration</span><span class="token punctuation">.</span><span class="token function">between</span><span class="token punctuation">(</span>start<span class="token punctuation">,</span> <span class="token class-name">Instant</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>metrics<span class="token punctuation">.</span><span class="token function">logException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;【异常日志】调用 %s 出现异常! &quot;</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 忽略异常的时候, 使用一开始定义的getDefaultValue方法, 来获取基本类型的默认值</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>metrics<span class="token punctuation">.</span><span class="token function">ignoreException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                returnValue <span class="token operator">=</span> <span class="token function">getDefaultValue</span><span class="token punctuation">(</span>signature<span class="token punctuation">.</span><span class="token function">getReturnType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">else</span>
                <span class="token keyword">throw</span> ex<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 实现了返回值的日志输出</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>metrics<span class="token punctuation">.</span><span class="token function">logReturn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;【出参日志】调用 %s 的返回是: 【%s】&quot;</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> returnValue<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> returnValue<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br></div></div><p>接下来, 分别定义最简单的 Controller, Service 和 Repository, 来测试 MetricsAspect 的功能.</p> <p>其中, Service 中实现创建用户的时候做了事务处理, 当用户名包含 test 字样时会抛出异常, 导致事务回滚. 同时, 为 Service 中的 createUser 标记了 @Metrics 注解. 这样一来, 还可以手动为类或方法标记 @Metrics 注解, 实现 Controller 之外的其他组件的自动监控.</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@RestController</span> <span class="token comment">// 自动进行监控</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">&quot;metricstest&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MetricsController</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">UserService</span> userService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;transaction&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">transaction</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            userService<span class="token punctuation">.</span><span class="token function">createUser</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">UserEntity</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;create user failed because {}&quot;</span><span class="token punctuation">,</span> ex<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> userService<span class="token punctuation">.</span><span class="token function">getUserCount</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token annotation punctuation">@Service</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserService</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">UserRepository</span> userRepository<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Transactional</span>
    <span class="token annotation punctuation">@Metrics</span> <span class="token comment">// 启用方法监控</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">createUser</span><span class="token punctuation">(</span><span class="token class-name">UserEntity</span> entity<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        userRepository<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>entity<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 抛异常</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>entity<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token string">&quot;test&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;invalid username!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getUserCount</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> userRepository<span class="token punctuation">.</span><span class="token function">findByName</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@Repository</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">UserRepository</span> <span class="token keyword">extends</span> <span class="token class-name">JpaRepository</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">UserEntity</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">UserEntity</span><span class="token punctuation">&gt;</span></span> <span class="token function">findByName</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br></div></div><p>使用用户名 &quot;test&quot; 测试一下注册功能:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token punctuation">[</span><span class="token number">16</span><span class="token operator">:</span><span class="token number">27</span><span class="token operator">:</span><span class="token number">52.586</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>http<span class="token operator">-</span>nio<span class="token operator">-</span><span class="token number">45678</span><span class="token operator">-</span>exec<span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token constant">INFO</span> <span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>g<span class="token punctuation">.</span>t<span class="token punctuation">.</span>c<span class="token punctuation">.</span>spring<span class="token punctuation">.</span>demo2<span class="token punctuation">.</span></span>MetricsAspect</span>      <span class="token operator">:</span><span class="token number">85</span>  <span class="token punctuation">]</span> <span class="token operator">-</span> 【入参日志】调用 【<span class="token keyword">class</span> <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>geekbang<span class="token punctuation">.</span>time<span class="token punctuation">.</span>commonmistakes<span class="token punctuation">.</span>spring<span class="token punctuation">.</span>demo2<span class="token punctuation">.</span></span>MetricsController</span>】【<span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>geekbang<span class="token punctuation">.</span>time<span class="token punctuation">.</span>commonmistakes<span class="token punctuation">.</span>spring<span class="token punctuation">.</span>demo2<span class="token punctuation">.</span></span>MetricsController</span><span class="token punctuation">.</span><span class="token function">transaction</span><span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>String</span><span class="token punctuation">)</span>】【http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>localhost<span class="token operator">:</span><span class="token number">45678</span><span class="token operator">/</span>metricstest<span class="token operator">/</span>transaction】 的参数是<span class="token operator">:</span> 【<span class="token punctuation">[</span><span class="token string">&quot;test&quot;</span><span class="token punctuation">]</span>】
<span class="token punctuation">[</span><span class="token number">16</span><span class="token operator">:</span><span class="token number">27</span><span class="token operator">:</span><span class="token number">52.590</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>http<span class="token operator">-</span>nio<span class="token operator">-</span><span class="token number">45678</span><span class="token operator">-</span>exec<span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token constant">INFO</span> <span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>g<span class="token punctuation">.</span>t<span class="token punctuation">.</span>c<span class="token punctuation">.</span>spring<span class="token punctuation">.</span>demo2<span class="token punctuation">.</span></span>MetricsAspect</span>      <span class="token operator">:</span><span class="token number">85</span>  <span class="token punctuation">]</span> <span class="token operator">-</span> 【入参日志】调用 【<span class="token keyword">class</span> <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>geekbang<span class="token punctuation">.</span>time<span class="token punctuation">.</span>commonmistakes<span class="token punctuation">.</span>spring<span class="token punctuation">.</span>demo2<span class="token punctuation">.</span></span>UserService</span>】【<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>geekbang<span class="token punctuation">.</span>time<span class="token punctuation">.</span>commonmistakes<span class="token punctuation">.</span>spring<span class="token punctuation">.</span>demo2<span class="token punctuation">.</span></span>UserService</span><span class="token punctuation">.</span><span class="token function">createUser</span><span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>geekbang<span class="token punctuation">.</span>time<span class="token punctuation">.</span>commonmistakes<span class="token punctuation">.</span>spring<span class="token punctuation">.</span>demo2<span class="token punctuation">.</span></span>UserEntity</span><span class="token punctuation">)</span>】【http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>localhost<span class="token operator">:</span><span class="token number">45678</span><span class="token operator">/</span>metricstest<span class="token operator">/</span>transaction】 的参数是<span class="token operator">:</span> 【<span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token string">&quot;id&quot;</span><span class="token operator">:</span><span class="token keyword">null</span><span class="token punctuation">,</span><span class="token string">&quot;name&quot;</span><span class="token operator">:</span><span class="token string">&quot;test&quot;</span><span class="token punctuation">}</span><span class="token punctuation">]</span>】
<span class="token punctuation">[</span><span class="token number">16</span><span class="token operator">:</span><span class="token number">27</span><span class="token operator">:</span><span class="token number">52.609</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>http<span class="token operator">-</span>nio<span class="token operator">-</span><span class="token number">45678</span><span class="token operator">-</span>exec<span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token constant">INFO</span> <span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>g<span class="token punctuation">.</span>t<span class="token punctuation">.</span>c<span class="token punctuation">.</span>spring<span class="token punctuation">.</span>demo2<span class="token punctuation">.</span></span>MetricsAspect</span>      <span class="token operator">:</span><span class="token number">96</span>  <span class="token punctuation">]</span> <span class="token operator">-</span> 【失败打点】调用 【<span class="token keyword">class</span> <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>geekbang<span class="token punctuation">.</span>time<span class="token punctuation">.</span>commonmistakes<span class="token punctuation">.</span>spring<span class="token punctuation">.</span>demo2<span class="token punctuation">.</span></span>UserService</span>】【<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>geekbang<span class="token punctuation">.</span>time<span class="token punctuation">.</span>commonmistakes<span class="token punctuation">.</span>spring<span class="token punctuation">.</span>demo2<span class="token punctuation">.</span></span>UserService</span><span class="token punctuation">.</span><span class="token function">createUser</span><span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>geekbang<span class="token punctuation">.</span>time<span class="token punctuation">.</span>commonmistakes<span class="token punctuation">.</span>spring<span class="token punctuation">.</span>demo2<span class="token punctuation">.</span></span>UserEntity</span><span class="token punctuation">)</span>】【http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>localhost<span class="token operator">:</span><span class="token number">45678</span><span class="token operator">/</span>metricstest<span class="token operator">/</span>transaction】 失败<span class="token punctuation">,</span> 耗时<span class="token operator">:</span> <span class="token number">19</span> ms
<span class="token punctuation">[</span><span class="token number">16</span><span class="token operator">:</span><span class="token number">27</span><span class="token operator">:</span><span class="token number">52.610</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>http<span class="token operator">-</span>nio<span class="token operator">-</span><span class="token number">45678</span><span class="token operator">-</span>exec<span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token constant">ERROR</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>g<span class="token punctuation">.</span>t<span class="token punctuation">.</span>c<span class="token punctuation">.</span>spring<span class="token punctuation">.</span>demo2<span class="token punctuation">.</span></span>MetricsAspect</span>      <span class="token operator">:</span><span class="token number">98</span>  <span class="token punctuation">]</span> <span class="token operator">-</span> 【异常日志】调用 【<span class="token keyword">class</span> <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>geekbang<span class="token punctuation">.</span>time<span class="token punctuation">.</span>commonmistakes<span class="token punctuation">.</span>spring<span class="token punctuation">.</span>demo2<span class="token punctuation">.</span></span>UserService</span>】【<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>geekbang<span class="token punctuation">.</span>time<span class="token punctuation">.</span>commonmistakes<span class="token punctuation">.</span>spring<span class="token punctuation">.</span>demo2<span class="token punctuation">.</span></span>UserService</span><span class="token punctuation">.</span><span class="token function">createUser</span><span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>geekbang<span class="token punctuation">.</span>time<span class="token punctuation">.</span>commonmistakes<span class="token punctuation">.</span>spring<span class="token punctuation">.</span>demo2<span class="token punctuation">.</span></span>UserEntity</span><span class="token punctuation">)</span>】【http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>localhost<span class="token operator">:</span><span class="token number">45678</span><span class="token operator">/</span>metricstest<span class="token operator">/</span>transaction】 出现异常<span class="token operator">!</span> 
<span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>RuntimeException</span><span class="token operator">:</span> invalid username<span class="token operator">!</span>
at <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>geekbang<span class="token punctuation">.</span>time<span class="token punctuation">.</span>commonmistakes<span class="token punctuation">.</span>spring<span class="token punctuation">.</span>demo2<span class="token punctuation">.</span></span>UserService</span><span class="token punctuation">.</span><span class="token function">createUser</span><span class="token punctuation">(</span><span class="token class-name">UserService</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">18</span><span class="token punctuation">)</span>
at <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>geekbang<span class="token punctuation">.</span>time<span class="token punctuation">.</span>commonmistakes<span class="token punctuation">.</span>spring<span class="token punctuation">.</span>demo2<span class="token punctuation">.</span></span>UserService</span>
$$
<span class="token class-name">FastClassBySpringCGLIB</span>
$$

<span class="token number">9</span>eec91f<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span><span class="token generics"><span class="token punctuation">&lt;</span>generated<span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token number">16</span><span class="token operator">:</span><span class="token number">27</span><span class="token operator">:</span><span class="token number">52.614</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>http<span class="token operator">-</span>nio<span class="token operator">-</span><span class="token number">45678</span><span class="token operator">-</span>exec<span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token constant">ERROR</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token class-name"><span class="token namespace">g<span class="token punctuation">.</span>t<span class="token punctuation">.</span>c<span class="token punctuation">.</span>spring<span class="token punctuation">.</span>demo2<span class="token punctuation">.</span></span>MetricsController</span><span class="token operator">:</span><span class="token number">21</span>  <span class="token punctuation">]</span> <span class="token operator">-</span> create user failed because invalid username<span class="token operator">!</span>
<span class="token punctuation">[</span><span class="token number">16</span><span class="token operator">:</span><span class="token number">27</span><span class="token operator">:</span><span class="token number">52.617</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>http<span class="token operator">-</span>nio<span class="token operator">-</span><span class="token number">45678</span><span class="token operator">-</span>exec<span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token constant">INFO</span> <span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>g<span class="token punctuation">.</span>t<span class="token punctuation">.</span>c<span class="token punctuation">.</span>spring<span class="token punctuation">.</span>demo2<span class="token punctuation">.</span></span>MetricsAspect</span>      <span class="token operator">:</span><span class="token number">93</span>  <span class="token punctuation">]</span> <span class="token operator">-</span> 【成功打点】调用 【<span class="token keyword">class</span> <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>geekbang<span class="token punctuation">.</span>time<span class="token punctuation">.</span>commonmistakes<span class="token punctuation">.</span>spring<span class="token punctuation">.</span>demo2<span class="token punctuation">.</span></span>MetricsController</span>】【<span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>geekbang<span class="token punctuation">.</span>time<span class="token punctuation">.</span>commonmistakes<span class="token punctuation">.</span>spring<span class="token punctuation">.</span>demo2<span class="token punctuation">.</span></span>MetricsController</span><span class="token punctuation">.</span><span class="token function">transaction</span><span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>String</span><span class="token punctuation">)</span>】【http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>localhost<span class="token operator">:</span><span class="token number">45678</span><span class="token operator">/</span>metricstest<span class="token operator">/</span>transaction】 成功<span class="token punctuation">,</span> 耗时<span class="token operator">:</span> <span class="token number">31</span> ms
<span class="token punctuation">[</span><span class="token number">16</span><span class="token operator">:</span><span class="token number">27</span><span class="token operator">:</span><span class="token number">52.618</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>http<span class="token operator">-</span>nio<span class="token operator">-</span><span class="token number">45678</span><span class="token operator">-</span>exec<span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token constant">INFO</span> <span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>g<span class="token punctuation">.</span>t<span class="token punctuation">.</span>c<span class="token punctuation">.</span>spring<span class="token punctuation">.</span>demo2<span class="token punctuation">.</span></span>MetricsAspect</span>      <span class="token operator">:</span><span class="token number">108</span> <span class="token punctuation">]</span> <span class="token operator">-</span> 【出参日志】调用 【<span class="token keyword">class</span> <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>geekbang<span class="token punctuation">.</span>time<span class="token punctuation">.</span>commonmistakes<span class="token punctuation">.</span>spring<span class="token punctuation">.</span>demo2<span class="token punctuation">.</span></span>MetricsController</span>】【<span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>geekbang<span class="token punctuation">.</span>time<span class="token punctuation">.</span>commonmistakes<span class="token punctuation">.</span>spring<span class="token punctuation">.</span>demo2<span class="token punctuation">.</span></span>MetricsController</span><span class="token punctuation">.</span><span class="token function">transaction</span><span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>String</span><span class="token punctuation">)</span>】【http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>localhost<span class="token operator">:</span><span class="token number">45678</span><span class="token operator">/</span>metricstest<span class="token operator">/</span>transaction】 的返回是<span class="token operator">:</span> 【<span class="token number">0</span>】
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>看起来这个切面很不错, 日志中打出了<strong>整个调用的出入参, 方法耗时</strong>:</p> <ol><li>第 1, 8, 9 和 10 行分别是 Controller 方法的入参日志, 调用 Service 方法出错后记录的错误信息, 成功执行的打点和出参日志. 因为 Controller 方法内部进行了 try-catch 处理, 所以其方法最终是成功执行的. 出参日志中显示最后查询到的用户数量是 0, 表示用户创建实际是失败的.</li> <li>第 2, 3 和 4~7 行分别是 Service 方法的入参日志, 失败打点和异常日志. 正是因为 Service 方法的异常抛到了 Controller, 所以整个方法才能被 @Transactional 声明式事务回滚. 在这里, MetricsAspect 捕获了<strong>异常又重新抛出, 记录了异常的同时又不影响事务回滚</strong>.</li></ol> <p>一段时间后, 开发同学觉得默认的 @Metrics 配置有点不合适, 希望进行两个调整:</p> <ol><li><strong>对于 Controller 的自动打点, 不要自动记录入参和出参日志, 否则日志量太大</strong>;</li> <li><strong>对于 Service 中的方法, 最好可以自动捕获异常</strong>.</li></ol> <p>于是, 他就为 MetricsController 手动加上了 @Metrics 注解, 设置 logParameters 和 logReturn 为 false; 然后为 Service 中的 createUser 方法的 @Metrics 注解, 设置了 ignoreException 属性为 true:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Metrics</span><span class="token punctuation">(</span>logParameters <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">,</span> logReturn <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token comment">// 改动点1</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MetricsController</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@Service</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserService</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Transactional</span>
    <span class="token annotation punctuation">@Metrics</span><span class="token punctuation">(</span>ignoreException <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token comment">// 改动点2</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">createUser</span><span class="token punctuation">(</span><span class="token class-name">UserEntity</span> entity<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// ...</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>代码上线后发现日志量并没有减少, 更要命的是<strong>事务回滚失效</strong>了, 从输出看到最后查询到了名为 test 的用户:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token punctuation">[</span><span class="token number">17</span><span class="token operator">:</span><span class="token number">01</span><span class="token operator">:</span><span class="token number">16.549</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>http<span class="token operator">-</span>nio<span class="token operator">-</span><span class="token number">45678</span><span class="token operator">-</span>exec<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token constant">INFO</span> <span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>g<span class="token punctuation">.</span>t<span class="token punctuation">.</span>c<span class="token punctuation">.</span>spring<span class="token punctuation">.</span>demo2<span class="token punctuation">.</span></span>MetricsAspect</span>      <span class="token operator">:</span><span class="token number">75</span>  <span class="token punctuation">]</span> <span class="token operator">-</span> 【入参日志】调用 【<span class="token keyword">class</span> <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>geekbang<span class="token punctuation">.</span>time<span class="token punctuation">.</span>commonmistakes<span class="token punctuation">.</span>spring<span class="token punctuation">.</span>demo2<span class="token punctuation">.</span></span>MetricsController</span>】【<span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>geekbang<span class="token punctuation">.</span>time<span class="token punctuation">.</span>commonmistakes<span class="token punctuation">.</span>spring<span class="token punctuation">.</span>demo2<span class="token punctuation">.</span></span>MetricsController</span><span class="token punctuation">.</span><span class="token function">transaction</span><span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>String</span><span class="token punctuation">)</span>】【http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>localhost<span class="token operator">:</span><span class="token number">45678</span><span class="token operator">/</span>metricstest<span class="token operator">/</span>transaction】 的参数是<span class="token operator">:</span> 【<span class="token punctuation">[</span><span class="token string">&quot;test&quot;</span><span class="token punctuation">]</span>】
<span class="token punctuation">[</span><span class="token number">17</span><span class="token operator">:</span><span class="token number">01</span><span class="token operator">:</span><span class="token number">16.670</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>http<span class="token operator">-</span>nio<span class="token operator">-</span><span class="token number">45678</span><span class="token operator">-</span>exec<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token constant">INFO</span> <span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>g<span class="token punctuation">.</span>t<span class="token punctuation">.</span>c<span class="token punctuation">.</span>spring<span class="token punctuation">.</span>demo2<span class="token punctuation">.</span></span>MetricsAspect</span>      <span class="token operator">:</span><span class="token number">75</span>  <span class="token punctuation">]</span> <span class="token operator">-</span> 【入参日志】调用 【<span class="token keyword">class</span> <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>geekbang<span class="token punctuation">.</span>time<span class="token punctuation">.</span>commonmistakes<span class="token punctuation">.</span>spring<span class="token punctuation">.</span>demo2<span class="token punctuation">.</span></span>UserService</span>】【<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>geekbang<span class="token punctuation">.</span>time<span class="token punctuation">.</span>commonmistakes<span class="token punctuation">.</span>spring<span class="token punctuation">.</span>demo2<span class="token punctuation">.</span></span>UserService</span><span class="token punctuation">.</span><span class="token function">createUser</span><span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>geekbang<span class="token punctuation">.</span>time<span class="token punctuation">.</span>commonmistakes<span class="token punctuation">.</span>spring<span class="token punctuation">.</span>demo2<span class="token punctuation">.</span></span>UserEntity</span><span class="token punctuation">)</span>】【http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>localhost<span class="token operator">:</span><span class="token number">45678</span><span class="token operator">/</span>metricstest<span class="token operator">/</span>transaction】 的参数是<span class="token operator">:</span> 【<span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token string">&quot;id&quot;</span><span class="token operator">:</span><span class="token keyword">null</span><span class="token punctuation">,</span><span class="token string">&quot;name&quot;</span><span class="token operator">:</span><span class="token string">&quot;test&quot;</span><span class="token punctuation">}</span><span class="token punctuation">]</span>】
<span class="token punctuation">[</span><span class="token number">17</span><span class="token operator">:</span><span class="token number">01</span><span class="token operator">:</span><span class="token number">16.885</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>http<span class="token operator">-</span>nio<span class="token operator">-</span><span class="token number">45678</span><span class="token operator">-</span>exec<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token constant">INFO</span> <span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>g<span class="token punctuation">.</span>t<span class="token punctuation">.</span>c<span class="token punctuation">.</span>spring<span class="token punctuation">.</span>demo2<span class="token punctuation">.</span></span>MetricsAspect</span>      <span class="token operator">:</span><span class="token number">86</span>  <span class="token punctuation">]</span> <span class="token operator">-</span> 【失败打点】调用 【<span class="token keyword">class</span> <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>geekbang<span class="token punctuation">.</span>time<span class="token punctuation">.</span>commonmistakes<span class="token punctuation">.</span>spring<span class="token punctuation">.</span>demo2<span class="token punctuation">.</span></span>UserService</span>】【<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>geekbang<span class="token punctuation">.</span>time<span class="token punctuation">.</span>commonmistakes<span class="token punctuation">.</span>spring<span class="token punctuation">.</span>demo2<span class="token punctuation">.</span></span>UserService</span><span class="token punctuation">.</span><span class="token function">createUser</span><span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>geekbang<span class="token punctuation">.</span>time<span class="token punctuation">.</span>commonmistakes<span class="token punctuation">.</span>spring<span class="token punctuation">.</span>demo2<span class="token punctuation">.</span></span>UserEntity</span><span class="token punctuation">)</span>】【http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>localhost<span class="token operator">:</span><span class="token number">45678</span><span class="token operator">/</span>metricstest<span class="token operator">/</span>transaction】 失败<span class="token punctuation">,</span> 耗时<span class="token operator">:</span> <span class="token number">211</span> ms
<span class="token punctuation">[</span><span class="token number">17</span><span class="token operator">:</span><span class="token number">01</span><span class="token operator">:</span><span class="token number">16.899</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>http<span class="token operator">-</span>nio<span class="token operator">-</span><span class="token number">45678</span><span class="token operator">-</span>exec<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token constant">ERROR</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>g<span class="token punctuation">.</span>t<span class="token punctuation">.</span>c<span class="token punctuation">.</span>spring<span class="token punctuation">.</span>demo2<span class="token punctuation">.</span></span>MetricsAspect</span>      <span class="token operator">:</span><span class="token number">88</span>  <span class="token punctuation">]</span> <span class="token operator">-</span> 【异常日志】调用 【<span class="token keyword">class</span> <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>geekbang<span class="token punctuation">.</span>time<span class="token punctuation">.</span>commonmistakes<span class="token punctuation">.</span>spring<span class="token punctuation">.</span>demo2<span class="token punctuation">.</span></span>UserService</span>】【<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>geekbang<span class="token punctuation">.</span>time<span class="token punctuation">.</span>commonmistakes<span class="token punctuation">.</span>spring<span class="token punctuation">.</span>demo2<span class="token punctuation">.</span></span>UserService</span><span class="token punctuation">.</span><span class="token function">createUser</span><span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>geekbang<span class="token punctuation">.</span>time<span class="token punctuation">.</span>commonmistakes<span class="token punctuation">.</span>spring<span class="token punctuation">.</span>demo2<span class="token punctuation">.</span></span>UserEntity</span><span class="token punctuation">)</span>】【http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>localhost<span class="token operator">:</span><span class="token number">45678</span><span class="token operator">/</span>metricstest<span class="token operator">/</span>transaction】 出现异常<span class="token operator">!</span> 
<span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>RuntimeException</span><span class="token operator">:</span> invalid username<span class="token operator">!</span>
at <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>geekbang<span class="token punctuation">.</span>time<span class="token punctuation">.</span>commonmistakes<span class="token punctuation">.</span>spring<span class="token punctuation">.</span>demo2<span class="token punctuation">.</span></span>UserService</span><span class="token punctuation">.</span><span class="token function">createUser</span><span class="token punctuation">(</span><span class="token class-name">UserService</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">18</span><span class="token punctuation">)</span>
at <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>geekbang<span class="token punctuation">.</span>time<span class="token punctuation">.</span>commonmistakes<span class="token punctuation">.</span>spring<span class="token punctuation">.</span>demo2<span class="token punctuation">.</span></span>UserService</span>
$$
<span class="token class-name">FastClassBySpringCGLIB</span>
$$

<span class="token number">9</span>eec91f<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span><span class="token generics"><span class="token punctuation">&lt;</span>generated<span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token number">17</span><span class="token operator">:</span><span class="token number">01</span><span class="token operator">:</span><span class="token number">16.902</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>http<span class="token operator">-</span>nio<span class="token operator">-</span><span class="token number">45678</span><span class="token operator">-</span>exec<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token constant">INFO</span> <span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>g<span class="token punctuation">.</span>t<span class="token punctuation">.</span>c<span class="token punctuation">.</span>spring<span class="token punctuation">.</span>demo2<span class="token punctuation">.</span></span>MetricsAspect</span>      <span class="token operator">:</span><span class="token number">98</span>  <span class="token punctuation">]</span> <span class="token operator">-</span> 【出参日志】调用 【<span class="token keyword">class</span> <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>geekbang<span class="token punctuation">.</span>time<span class="token punctuation">.</span>commonmistakes<span class="token punctuation">.</span>spring<span class="token punctuation">.</span>demo2<span class="token punctuation">.</span></span>UserService</span>】【<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>geekbang<span class="token punctuation">.</span>time<span class="token punctuation">.</span>commonmistakes<span class="token punctuation">.</span>spring<span class="token punctuation">.</span>demo2<span class="token punctuation">.</span></span>UserService</span><span class="token punctuation">.</span><span class="token function">createUser</span><span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>geekbang<span class="token punctuation">.</span>time<span class="token punctuation">.</span>commonmistakes<span class="token punctuation">.</span>spring<span class="token punctuation">.</span>demo2<span class="token punctuation">.</span></span>UserEntity</span><span class="token punctuation">)</span>】【http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>localhost<span class="token operator">:</span><span class="token number">45678</span><span class="token operator">/</span>metricstest<span class="token operator">/</span>transaction】 的返回是<span class="token operator">:</span> 【<span class="token keyword">null</span>】
<span class="token punctuation">[</span><span class="token number">17</span><span class="token operator">:</span><span class="token number">01</span><span class="token operator">:</span><span class="token number">17.466</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>http<span class="token operator">-</span>nio<span class="token operator">-</span><span class="token number">45678</span><span class="token operator">-</span>exec<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token constant">INFO</span> <span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>g<span class="token punctuation">.</span>t<span class="token punctuation">.</span>c<span class="token punctuation">.</span>spring<span class="token punctuation">.</span>demo2<span class="token punctuation">.</span></span>MetricsAspect</span>      <span class="token operator">:</span><span class="token number">83</span>  <span class="token punctuation">]</span> <span class="token operator">-</span> 【成功打点】调用 【<span class="token keyword">class</span> <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>geekbang<span class="token punctuation">.</span>time<span class="token punctuation">.</span>commonmistakes<span class="token punctuation">.</span>spring<span class="token punctuation">.</span>demo2<span class="token punctuation">.</span></span>MetricsController</span>】【<span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>geekbang<span class="token punctuation">.</span>time<span class="token punctuation">.</span>commonmistakes<span class="token punctuation">.</span>spring<span class="token punctuation">.</span>demo2<span class="token punctuation">.</span></span>MetricsController</span><span class="token punctuation">.</span><span class="token function">transaction</span><span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>String</span><span class="token punctuation">)</span>】【http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>localhost<span class="token operator">:</span><span class="token number">45678</span><span class="token operator">/</span>metricstest<span class="token operator">/</span>transaction】 成功<span class="token punctuation">,</span> 耗时<span class="token operator">:</span> <span class="token number">915</span> ms
<span class="token punctuation">[</span><span class="token number">17</span><span class="token operator">:</span><span class="token number">01</span><span class="token operator">:</span><span class="token number">17.467</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>http<span class="token operator">-</span>nio<span class="token operator">-</span><span class="token number">45678</span><span class="token operator">-</span>exec<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token constant">INFO</span> <span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>g<span class="token punctuation">.</span>t<span class="token punctuation">.</span>c<span class="token punctuation">.</span>spring<span class="token punctuation">.</span>demo2<span class="token punctuation">.</span></span>MetricsAspect</span>      <span class="token operator">:</span><span class="token number">98</span>  <span class="token punctuation">]</span> <span class="token operator">-</span> 【出参日志】调用 【<span class="token keyword">class</span> <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>geekbang<span class="token punctuation">.</span>time<span class="token punctuation">.</span>commonmistakes<span class="token punctuation">.</span>spring<span class="token punctuation">.</span>demo2<span class="token punctuation">.</span></span>MetricsController</span>】【<span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>geekbang<span class="token punctuation">.</span>time<span class="token punctuation">.</span>commonmistakes<span class="token punctuation">.</span>spring<span class="token punctuation">.</span>demo2<span class="token punctuation">.</span></span>MetricsController</span><span class="token punctuation">.</span><span class="token function">transaction</span><span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>String</span><span class="token punctuation">)</span>】【http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>localhost<span class="token operator">:</span><span class="token number">45678</span><span class="token operator">/</span>metricstest<span class="token operator">/</span>transaction】 的返回是<span class="token operator">:</span> 【<span class="token number">1</span>】
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>在介绍数据库事务时, 分析了 Spring <strong>通过 TransactionAspectSupport 类实现事务</strong>. 在 invokeWithinTransaction 方法中设置断点可以发现, 在执行 Service 的 createUser 方法时, TransactionAspectSupport 并没有捕获到异常, 所以自然无法回滚事务. 原因就是, <strong>异常被 MetricsAspect 吃掉了</strong>.</p> <p>我们知道, <strong>切面本身是一个 Bean, Spring 对不同切面增强的执行顺序是由 Bean 优先级决定的</strong>, 具体规则是:</p> <ol><li><strong>入操作(Around(连接点执行前), Before), 切面优先级越高, 越先执行</strong>. 一个切面的入操作执行完, 才轮到下一切面, 所有切面入操作执行完, 才开始执行连接点(方法).</li> <li><strong>出操作(Around(连接点执行后), After, AfterReturning, AfterThrowing), 切面优先级越低, 越先执行</strong>. 一个切面的出操作执行完, 才轮到下一切面, 直到返回到调用点.</li> <li><strong>同一切面的 Around 比 After, Before 先执行</strong>.</li></ol> <p>对于 Bean 可以通过 @Order 注解来设置优先级, 查看 @Order 注解和 Ordered 接口源码可以发现, 默认情况下 Bean 的优先级为最低优先级, 其值是 Integer 的最大值. 其实, <strong>值越大优先级反而越低, 这点比较反直觉</strong>:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Retention</span><span class="token punctuation">(</span><span class="token class-name">RetentionPolicy</span><span class="token punctuation">.</span><span class="token constant">RUNTIME</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Target</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token class-name">ElementType</span><span class="token punctuation">.</span><span class="token constant">TYPE</span><span class="token punctuation">,</span> <span class="token class-name">ElementType</span><span class="token punctuation">.</span><span class="token constant">METHOD</span><span class="token punctuation">,</span> <span class="token class-name">ElementType</span><span class="token punctuation">.</span><span class="token constant">FIELD</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Documented</span>
<span class="token keyword">public</span> <span class="token annotation punctuation">@interface</span> <span class="token class-name">Order</span> <span class="token punctuation">{</span>
   <span class="token keyword">int</span> <span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token class-name">Ordered</span><span class="token punctuation">.</span><span class="token constant">LOWEST_PRECEDENCE</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">Ordered</span> <span class="token punctuation">{</span>
   <span class="token keyword">int</span> <span class="token constant">HIGHEST_PRECEDENCE</span> <span class="token operator">=</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token constant">MIN_VALUE</span><span class="token punctuation">;</span>
   <span class="token keyword">int</span> <span class="token constant">LOWEST_PRECEDENCE</span> <span class="token operator">=</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token constant">MAX_VALUE</span><span class="token punctuation">;</span>
   <span class="token keyword">int</span> <span class="token function">getOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>再通过一个例子, 来理解下增强的执行顺序. 新建一个 TestAspectWithOrder10 切面, 通过 @Order 注解设置优先级为 10, 在内部定义 @Before, @After, @Around 三类增强, 三个增强的逻辑只是简单的日志输出, 切点是 TestController 所有方法; 然后再定义一个类似的 TestAspectWithOrder20 切面, 设置优先级为 20:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Aspect</span>
<span class="token annotation punctuation">@Component</span>
<span class="token annotation punctuation">@Order</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TestAspectWithOrder10</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Before</span><span class="token punctuation">(</span><span class="token string">&quot;execution(* org.geekbang.time.commonmistakes.springpart1.aopmetrics.TestController.*(..))&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">before</span><span class="token punctuation">(</span><span class="token class-name">JoinPoint</span> joinPoint<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;TestAspectWithOrder10 @Before&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@After</span><span class="token punctuation">(</span><span class="token string">&quot;execution(* org.geekbang.time.commonmistakes.springpart1.aopmetrics.TestController.*(..))&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">after</span><span class="token punctuation">(</span><span class="token class-name">JoinPoint</span> joinPoint<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;TestAspectWithOrder10 @After&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Around</span><span class="token punctuation">(</span><span class="token string">&quot;execution(* org.geekbang.time.commonmistakes.springpart1.aopmetrics.TestController.*(..))&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">around</span><span class="token punctuation">(</span><span class="token class-name">ProceedingJoinPoint</span> pjp<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;TestAspectWithOrder10 @Around before&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Object</span> o <span class="token operator">=</span> pjp<span class="token punctuation">.</span><span class="token function">proceed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;TestAspectWithOrder10 @Around after&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> o<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@Aspect</span>
<span class="token annotation punctuation">@Component</span>
<span class="token annotation punctuation">@Order</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TestAspectWithOrder20</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br></div></div><p>调用 TestController 的方法后, 通过日志输出可以看到, <strong>增强执行顺序符合切面执行顺序的三个规则</strong>:</p> <p><img src="/img/3e91c9a61322e8b776688f4032987b83-20230731165210-i6idnhr.png" alt=""></p> <p><strong>因为 Spring 的事务管理也是基于 AOP 的, 默认情况下优先级最低也就是会先执行出操作, 但是自定义切面 MetricsAspect 也同样是最低优先级</strong>, 这个时候就可能出现问题: <strong>如果出操作先执行捕获了异常, 那么 Spring 的事务处理就会因为无法捕获到异常导致无法回滚事务</strong>.</p> <p>解决方式是, <strong>明确 MetricsAspect 的优先级, 可以设置为最高优先级, 也就是最先执行入操作最后执行出操作</strong>:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// 将MetricsAspect这个Bean的优先级设置为最高</span>
<span class="token annotation punctuation">@Order</span><span class="token punctuation">(</span><span class="token class-name">Ordered</span><span class="token punctuation">.</span><span class="token constant">HIGHEST_PRECEDENCE</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MetricsAspect</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>此外, <strong>要知道切入的连接点是方法, 注解定义在类上是无法直接从方法上获取到注解的</strong>. 修复方式是, 改为优先从方法获取, 如果获取不到再从类获取, 如果还是获取不到再使用默认的注解:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">Metrics</span> metrics <span class="token operator">=</span> signature<span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAnnotation</span><span class="token punctuation">(</span><span class="token class-name">Metrics</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>metrics <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    metrics <span class="token operator">=</span> signature<span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDeclaringClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAnnotation</span><span class="token punctuation">(</span><span class="token class-name">Metrics</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>经过这 2 处修改, 事务终于又可以回滚了, 并且 Controller 的监控日志也不再出现入参, 出参信息.</p> <p>再总结下这个案例. 利用反射 + 注解 + Spring AOP 实现统一的横切日志关注点时, 遇到的 Spring 事务失效问题, 是由<strong>自定义的切面执行顺序引起的</strong>. 这也让我们认识到, <strong>因为 Spring 内部大量利用 IoC 和 AOP 实现了各种组件, 当使用 IoC 和 AOP 时, 一定要考虑是否会影响其他内部组件</strong>.</p> <h5 id="重点回顾-19"><a href="#重点回顾-19" class="header-anchor">#</a> 重点回顾</h5> <p>今天通过 2 个案例分享了 Spring IoC 和 AOP 的基本概念, 以及三个比较容易出错的点.</p> <p>第一, <strong>让 Spring 容器管理对象, 要考虑对象默认的 Scope 单例是否适合, 对于有状态的类型, 单例可能产生内存泄露问题</strong>.</p> <p>第二, 如果要为单例的 Bean 注入 Prototype 的 Bean, 绝不是仅仅修改 Scope 属性这么简单. 由于单例的 Bean <strong>在容器启动时就会完成一次性初始化</strong>. 最简单的解决方案是, 把 Prototype 的 Bean 设置为通过代理注入, 也就是设置 proxyMode 属性为 TARGET_CLASS.</p> <p>第三, <strong>如果一组相同类型的 Bean 是有顺序的, 需要明确使用 @Order 注解来设置顺序</strong>. 可以再回顾下, 两个不同优先级切面中 @Before, @After 和 @Around 三种增强的执行顺序, 是什么样的.</p> <p>最后要说的是, 文内第二个案例是一个完整的统一日志监控案例, 继续修改就可以实现一个完善的, 生产级的方法调用监控平台. 这些修改主要是两方面: <strong>把日志打点, 改为对接 Metrics 监控系统; 把各种功能的监控开关, 从注解属性获取改为通过配置系统实时获取</strong>.</p> <h4 id="_20-spring框架-框架帮我们做了很多工作也带来了复杂度"><a href="#_20-spring框架-框架帮我们做了很多工作也带来了复杂度" class="header-anchor">#</a> 20-Spring框架:框架帮我们做了很多工作也带来了复杂度</h4> <p>今天聊聊 Spring 框架给业务代码带来的复杂度, 以及与之相关的坑.</p> <p>在上一讲, 通过 AOP 实现统一的监控组件的案例, 看到了 IoC 和 AOP 配合使用的威力: 当对象由 Spring 容器管理成为 Bean 之后, 不但可以通过容器管理配置 Bean 的属性, 还可以方便地对感兴趣的方法做 AOP.</p> <p>不过, 前提是<strong>对象必须是 Bean</strong>. 你可能会觉得这个结论很明显, 也很容易理解. 但就和上一讲提到的 Bean 默认是单例一样, 理解起来简单, 实践的时候却非常容易踩坑. 其中原因, 一方面是, 理解 Spring 的体系结构和使用方式有一定曲线; 另一方面是, Spring 多年发展堆积起来的内部结构非常复杂, 这也是更重要的原因.</p> <p>在我看来, Spring 框架内部的复杂度主要表现为三点:</p> <ol><li>第一, <strong>Spring 框架借助 IoC 和 AOP 的功能, 实现了修改, 拦截 Bean 的定义和实例的灵活性, 因此真正执行的代码流程并不是串行的</strong>.</li> <li>第二, <strong>Spring Boot 根据当前依赖情况实现了自动配置, 虽然省去了手动配置的麻烦, 但也因此多了一些黑盒, 提升了复杂度</strong>.</li> <li>第三, Spring Cloud 模块多版本也多, Spring Boot 1.x 和 2.x 的区别也很大. 如果要对 Spring Cloud 或 Spring Boot 进行二次开发的话, 考虑兼容性的成本会很高.</li></ol> <p>今天就通过配置 AOP 切入 Spring Cloud Feign 组件失败, Spring Boot 程序的文件配置被覆盖这两个案例, 感受一下 Spring 的复杂度. 我希望这一讲的内容, 能帮助你面对 Spring 这个复杂框架出现的问题时, 可以非常自信地找到解决方案.</p> <h5 id="feign-aop切不到的诡异案例"><a href="#feign-aop切不到的诡异案例" class="header-anchor">#</a> Feign AOP切不到的诡异案例</h5> <p>我曾遇到过这么一个案例: 使用 Spring Cloud 做微服务调用, 为方便统一处理 Feign, 想到了用 AOP 实现, 即<strong>使用 within 指示器匹配 feign.Client 接口的实现进行 AOP 切入</strong>.</p> <p>代码如下, 通过 @Before 注解在执行方法前打印日志, 并在代码中定义了一个标记了 @FeignClient 注解的 Client 类, 让其成为一个 Feign 接口:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// 测试Feign</span>
<span class="token annotation punctuation">@FeignClient</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;client&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">Client</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/feignaop/server&quot;</span><span class="token punctuation">)</span>
    <span class="token class-name">String</span> <span class="token function">api</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// AOP切入feign.Client的实现</span>
<span class="token annotation punctuation">@Aspect</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WrongAspect</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Before</span><span class="token punctuation">(</span><span class="token string">&quot;within(feign.Client+)&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">before</span><span class="token punctuation">(</span><span class="token class-name">JoinPoint</span> pjp<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;within(feign.Client+) pjp {}, args:{}&quot;</span><span class="token punctuation">,</span> pjp<span class="token punctuation">,</span> pjp<span class="token punctuation">.</span><span class="token function">getArgs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 配置扫描Feign</span>
<span class="token annotation punctuation">@Configuration</span>
<span class="token annotation punctuation">@EnableFeignClients</span><span class="token punctuation">(</span>basePackages <span class="token operator">=</span> <span class="token string">&quot;org.geekbang.time.commonmistakes.spring.demo4.feign&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Config</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>

<span class="token comment">// 测试Feign</span>
<span class="token annotation punctuation">@FeignClient</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;client&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">Client</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/feignaop/server&quot;</span><span class="token punctuation">)</span>
    <span class="token class-name">String</span> <span class="token function">api</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// AOP切入feign.Client的实现</span>
<span class="token annotation punctuation">@Aspect</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WrongAspect</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Before</span><span class="token punctuation">(</span><span class="token string">&quot;within(feign.Client+)&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">before</span><span class="token punctuation">(</span><span class="token class-name">JoinPoint</span> pjp<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;within(feign.Client+) pjp {}, args:{}&quot;</span><span class="token punctuation">,</span> pjp<span class="token punctuation">,</span> pjp<span class="token punctuation">.</span><span class="token function">getArgs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 配置扫描Feign</span>
<span class="token annotation punctuation">@Configuration</span>
<span class="token annotation punctuation">@EnableFeignClients</span><span class="token punctuation">(</span>basePackages <span class="token operator">=</span> <span class="token string">&quot;org.geekbang.time.commonmistakes.spring.demo4.feign&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Config</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br></div></div><p>通过 Feign 调用服务后可以看到日志中有输出, 的确<strong>实现了 feign.Client 的切入, 切入的是 execute 方法</strong>:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token punctuation">[</span><span class="token number">15</span><span class="token operator">:</span><span class="token number">48</span><span class="token operator">:</span><span class="token number">32.850</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>http<span class="token operator">-</span>nio<span class="token operator">-</span><span class="token number">45678</span><span class="token operator">-</span>exec<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token constant">INFO</span> <span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>g<span class="token punctuation">.</span>t<span class="token punctuation">.</span>c<span class="token punctuation">.</span>spring<span class="token punctuation">.</span>demo4<span class="token punctuation">.</span></span>WrongAspect</span>        <span class="token operator">:</span><span class="token number">20</span>  <span class="token punctuation">]</span> <span class="token operator">-</span> <span class="token function">within</span><span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">feign<span class="token punctuation">.</span></span>Client</span><span class="token operator">+</span><span class="token punctuation">)</span> pjp <span class="token function">execution</span><span class="token punctuation">(</span><span class="token class-name">Response</span> <span class="token class-name"><span class="token namespace">feign<span class="token punctuation">.</span></span>Client</span><span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token class-name">Request</span><span class="token punctuation">,</span><span class="token class-name">Options</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> args<span class="token operator">:</span><span class="token punctuation">[</span><span class="token constant">GET</span> http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>client<span class="token operator">/</span>feignaop<span class="token operator">/</span>server <span class="token constant">HTTP</span><span class="token operator">/</span><span class="token number">1.1</span>
<span class="token class-name">Binary</span> data<span class="token punctuation">,</span> <span class="token class-name"><span class="token namespace">feign<span class="token punctuation">.</span></span>Request</span>$<span class="token class-name">Options</span><span class="token annotation punctuation">@5c16561a</span><span class="token punctuation">]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>一开始这个项目使用的是客户端的负载均衡, 也就是让 Ribbon 来做负载均衡, 代码没啥问题. 后来因为后端服务通过 Nginx 实现服务端负载均衡, 所以开发同学把 @FeignClient 的配置设置了 URL 属性, 直接通过一个固定 URL 调用后端服务:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@FeignClient</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;anotherClient&quot;</span><span class="token punctuation">,</span> url <span class="token operator">=</span> <span class="token string">&quot;http://localhost:45678&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">ClientWithUrl</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/feignaop/server&quot;</span><span class="token punctuation">)</span>
    <span class="token class-name">String</span> <span class="token function">api</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>但这样配置后, 之前的 AOP 切面竟然失效了, 也就是 <code>within(feign.Client+)</code>​ 无法切入 ClientWithUrl 的调用了.</p> <p>为了还原这个场景, 我写了一段代码, 定义两个方法分别通过 Client 和 ClientWithUrl 这两个 Feign 进行接口调用:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Autowired</span>
<span class="token keyword">private</span> <span class="token class-name">Client</span> client<span class="token punctuation">;</span>

<span class="token annotation punctuation">@Autowired</span>
<span class="token keyword">private</span> <span class="token class-name">ClientWithUrl</span> clientWithUrl<span class="token punctuation">;</span>

<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;client&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">client</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> client<span class="token punctuation">.</span><span class="token function">api</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;clientWithUrl&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">clientWithUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> clientWithUrl<span class="token punctuation">.</span><span class="token function">api</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>可以看到, 调用 Client 后 AOP 有日志输出, 调用 ClientWithUrl 后却没有:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token punctuation">[</span><span class="token number">15</span><span class="token operator">:</span><span class="token number">50</span><span class="token operator">:</span><span class="token number">32.850</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>http<span class="token operator">-</span>nio<span class="token operator">-</span><span class="token number">45678</span><span class="token operator">-</span>exec<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token constant">INFO</span> <span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>g<span class="token punctuation">.</span>t<span class="token punctuation">.</span>c<span class="token punctuation">.</span>spring<span class="token punctuation">.</span>demo4<span class="token punctuation">.</span></span>WrongAspect</span>        <span class="token operator">:</span><span class="token number">20</span>  <span class="token punctuation">]</span> <span class="token operator">-</span> <span class="token function">within</span><span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">feign<span class="token punctuation">.</span></span>Client</span><span class="token operator">+</span><span class="token punctuation">)</span> pjp <span class="token function">execution</span><span class="token punctuation">(</span><span class="token class-name">Response</span> <span class="token class-name"><span class="token namespace">feign<span class="token punctuation">.</span></span>Client</span><span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token class-name">Request</span><span class="token punctuation">,</span><span class="token class-name">Options</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> args<span class="token operator">:</span><span class="token punctuation">[</span><span class="token constant">GET</span> http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>client<span class="token operator">/</span>feignaop<span class="token operator">/</span>server <span class="token constant">HTTP</span><span class="token operator">/</span><span class="token number">1.1</span>
<span class="token class-name">Binary</span> data<span class="token punctuation">,</span> <span class="token class-name"><span class="token namespace">feign<span class="token punctuation">.</span></span>Request</span>$<span class="token class-name">Options</span><span class="token annotation punctuation">@5c16561</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>这就很费解了. 难道为 Feign 指定了 URL, 其实现就不是 feign.Clinet 了吗?</p> <p>要明白原因, 需要分析一下 FeignClient 的创建过程, 也就是分析 FeignClientFactoryBean 类的 getTarget 方法. 源码第 4 行有一个 if 判断, <strong>当 URL 没有内容也就是为空或者不配置时调用 loadBalance 方法, 在其内部通过 FeignContext 从容器获取 feign.Client 的实例</strong>:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">T</span> <span class="token function">getTarget</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">FeignContext</span> context <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>applicationContext<span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span><span class="token class-name">FeignContext</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Feign<span class="token punctuation">.</span>Builder</span> builder <span class="token operator">=</span> <span class="token function">feign</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">hasText</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>url<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// ...</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">)</span> <span class="token function">loadBalance</span><span class="token punctuation">(</span>builder<span class="token punctuation">,</span> context<span class="token punctuation">,</span>
                <span class="token keyword">new</span> <span class="token class-name">HardCodedTarget</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>type<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>url<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// ...</span>
    <span class="token class-name">String</span> url <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>url <span class="token operator">+</span> <span class="token function">cleanPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Client</span> client <span class="token operator">=</span> <span class="token function">getOptional</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> <span class="token class-name">Client</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>client <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>client <span class="token keyword">instanceof</span> <span class="token class-name">LoadBalancerFeignClient</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// not load balancing because we have a url,</span>
            <span class="token comment">// but ribbon is on the classpath, so unwrap</span>
            client <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">LoadBalancerFeignClient</span><span class="token punctuation">)</span> client<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDelegate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        builder<span class="token punctuation">.</span><span class="token function">client</span><span class="token punctuation">(</span>client<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// ...</span>
<span class="token punctuation">}</span>

<span class="token keyword">protected</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">T</span> <span class="token function">loadBalance</span><span class="token punctuation">(</span><span class="token class-name">Feign<span class="token punctuation">.</span>Builder</span> builder<span class="token punctuation">,</span> <span class="token class-name">FeignContext</span> context<span class="token punctuation">,</span>
                            <span class="token class-name">HardCodedTarget</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> target<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Client</span> client <span class="token operator">=</span> <span class="token function">getOptional</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> <span class="token class-name">Client</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>client <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        builder<span class="token punctuation">.</span><span class="token function">client</span><span class="token punctuation">(</span>client<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Targeter</span> targeter <span class="token operator">=</span> <span class="token function">get</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> <span class="token class-name">Targeter</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> targeter<span class="token punctuation">.</span><span class="token function">target</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> builder<span class="token punctuation">,</span> context<span class="token punctuation">,</span> target<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// ...</span>
<span class="token punctuation">}</span>

<span class="token keyword">protected</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">T</span> <span class="token function">getOptional</span><span class="token punctuation">(</span><span class="token class-name">FeignContext</span> context<span class="token punctuation">,</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> type<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> context<span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>contextId<span class="token punctuation">,</span> type<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br></div></div><p>调试一下可以看到, <strong>client 是 LoadBalanceFeignClient, 已经是经过代理增强的, 明显是一个 Bean</strong>:</p> <p><img src="/img/0e432237489a8e31289a42addd54a686-20230731165210-op05wrq.png" alt=""></p> <p>所以, 没有指定 URL 的 @FeignClient 对应的 LoadBalanceFeignClient, 是可以通过 feign.Client 切入的.</p> <p>在上面贴出来的源码的 16 行可以看到, 当 URL 不为空的时候, client 设置为了 LoadBalanceFeignClient 的 delegate 属性. 其原因注释中有提到, 因为<strong>有了 URL 就不需要客户端负载均衡</strong>了, 但因为 Ribbon 在 classpath 中, 所以需要从 LoadBalanceFeignClient 提取出真正的 Client. 断点调试下可以看到, 这时 client 是一个 <strong>ApacheHttpClient</strong>:</p> <p><img src="/img/fb4dfe75fbf04896cd496fd4a4bb47d0-20230731165210-qwgxqgx.png" alt=""></p> <p>那么, 这个 ApacheHttpClient 是从哪里来的呢? 这里教你一个小技巧: 如果你希望知道一个类是怎样调用栈初始化的, 可以<strong>在构造方法中设置一个断点进行调试</strong>. 这样就可以在 IDE 的栈窗口看到整个方法调用栈, 然后点击每一个栈帧看到整个过程.</p> <p>用这种方式可以看到, 是 HttpClientFeignLoadBalancedConfiguration 类实例化的 ApacheHttpClient:</p> <p><img src="/img/8d8c92df00996e5905dfeb2e6ab27867-20230731165210-zajf9f4.png" alt=""></p> <p>进一步查看 HttpClientFeignLoadBalancedConfiguration 的源码可以发现, LoadBalancerFeignClient 这个 Bean 在实例化的时候, new 出来一个 ApacheHttpClient 作为 delegate 放到了 LoadBalancerFeignClient 中:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Bean</span>
<span class="token annotation punctuation">@ConditionalOnMissingBean</span><span class="token punctuation">(</span><span class="token class-name">Client</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">Client</span> <span class="token function">feignClient</span><span class="token punctuation">(</span><span class="token class-name">CachingSpringLoadBalancerFactory</span> cachingFactory<span class="token punctuation">,</span>
      <span class="token class-name">SpringClientFactory</span> clientFactory<span class="token punctuation">,</span> <span class="token class-name">HttpClient</span> httpClient<span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token class-name">ApacheHttpClient</span> delegate <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ApacheHttpClient</span><span class="token punctuation">(</span>httpClient<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">LoadBalancerFeignClient</span><span class="token punctuation">(</span>delegate<span class="token punctuation">,</span> cachingFactory<span class="token punctuation">,</span> clientFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token class-name">LoadBalancerFeignClient</span><span class="token punctuation">(</span><span class="token class-name">Client</span> delegate<span class="token punctuation">,</span>
      <span class="token class-name">CachingSpringLoadBalancerFactory</span> lbClientFactory<span class="token punctuation">,</span>
      <span class="token class-name">SpringClientFactory</span> clientFactory<span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token keyword">this</span><span class="token punctuation">.</span>delegate <span class="token operator">=</span> delegate<span class="token punctuation">;</span>
   <span class="token keyword">this</span><span class="token punctuation">.</span>lbClientFactory <span class="token operator">=</span> lbClientFactory<span class="token punctuation">;</span>
   <span class="token keyword">this</span><span class="token punctuation">.</span>clientFactory <span class="token operator">=</span> clientFactory<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>显然, <strong>ApacheHttpClient 是 new 出来的, 并不是 Bean, 而 LoadBalancerFeignClient 是一个 Bean</strong>.</p> <p>有了这个信息, 再来捋一下, 为什么 within(feign.Client+) 无法切入设置过 URL 的 @FeignClient ClientWithUrl:</p> <ol><li>表达式声明的是切入 feign.Client 的实现类.</li> <li><strong>Spring 只能切入由自己管理的 Bean</strong>.</li> <li><strong>虽然 LoadBalancerFeignClient 和 ApacheHttpClient 都是 feign.Client 接口的实现, 但是 HttpClientFeignLoadBalancedConfiguration 的自动配置只是把前者定义为 Bean, 后者是 new 出来的, 作为了 LoadBalancerFeignClient 的 delegate, 不是 Bean</strong>.</li> <li>在定义了 FeignClient 的 URL 属性后, 获取的是 LoadBalancerFeignClient 的 delegate, 它不是 Bean.</li></ol> <p>因此, 定义了 URL 的 FeignClient 采用 <code>within(feign.Client+)</code>​ 无法切入.</p> <p>那如何解决这个问题呢? 有一位同学提出, 修改一下切点表达式, 通过 @FeignClient 注解来切:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Before</span><span class="token punctuation">(</span><span class="token string">&quot;@within(org.springframework.cloud.openfeign.FeignClient)&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">before</span><span class="token punctuation">(</span><span class="token class-name">JoinPoint</span> pjp<span class="token punctuation">)</span><span class="token punctuation">{</span>
    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;@within(org.springframework.cloud.openfeign.FeignClient) pjp {}, args:{}&quot;</span><span class="token punctuation">,</span> pjp<span class="token punctuation">,</span> pjp<span class="token punctuation">.</span><span class="token function">getArgs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>修改后通过日志看到, AOP 的确切成功了:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token punctuation">[</span><span class="token number">15</span><span class="token operator">:</span><span class="token number">53</span><span class="token operator">:</span><span class="token number">39.093</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>http<span class="token operator">-</span>nio<span class="token operator">-</span><span class="token number">45678</span><span class="token operator">-</span>exec<span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token constant">INFO</span> <span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>g<span class="token punctuation">.</span>t<span class="token punctuation">.</span>c<span class="token punctuation">.</span>spring<span class="token punctuation">.</span>demo4<span class="token punctuation">.</span></span>Wrong2Aspect</span>       <span class="token operator">:</span><span class="token number">17</span>  <span class="token punctuation">]</span> <span class="token operator">-</span> <span class="token annotation punctuation">@within</span><span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span>openfeign<span class="token punctuation">.</span></span>FeignClient</span><span class="token punctuation">)</span> pjp <span class="token function">execution</span><span class="token punctuation">(</span><span class="token class-name">String</span> <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>geekbang<span class="token punctuation">.</span>time<span class="token punctuation">.</span>commonmistakes<span class="token punctuation">.</span>spring<span class="token punctuation">.</span>demo4<span class="token punctuation">.</span>feign<span class="token punctuation">.</span></span>ClientWithUrl</span><span class="token punctuation">.</span><span class="token function">api</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> args<span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>但仔细一看就会发现, <strong>这次切入的是 ClientWithUrl 接口的 API 方法, 并不是 client.Feign 接口的 execute 方法, 显然不符合预期</strong>.</p> <p>这位同学犯的错误是, 没有弄清楚真正希望切的是什么对象. @FeignClient 注解标记在 Feign Client 接口上, 所以<strong>切的是 Feign 定义的接口, 也就是每一个实际的 API 接口</strong>. 而通过 feign.Client 接口切的是客户端实现类, 切到的是通用的, 执行所有 Feign 调用的 execute 方法.</p> <p>那么问题来了, ApacheHttpClient 不是 Bean 无法切入, 切 Feign 接口本身又不符合要求. 怎么办呢?</p> <p>经过一番研究发现, ApacheHttpClient 其实有机会独立成为 Bean. 查看 HttpClientFeignConfiguration 的源码可以发现, <strong>当没有 ILoadBalancer 类型的时候, 自动装配会把 ApacheHttpClient 设置为 Bean</strong>.</p> <p>这么做的原因很明确, 如果不希望做客户端负载均衡的话, 应该不会引用 Ribbon 组件的依赖, 自然没有 LoadBalancerFeignClient, 只有 ApacheHttpClient:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Configuration</span>
<span class="token annotation punctuation">@ConditionalOnClass</span><span class="token punctuation">(</span><span class="token class-name">ApacheHttpClient</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@ConditionalOnMissingClass</span><span class="token punctuation">(</span><span class="token string">&quot;com.netflix.loadbalancer.ILoadBalancer&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@ConditionalOnMissingBean</span><span class="token punctuation">(</span><span class="token class-name">CloseableHttpClient</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@ConditionalOnProperty</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;feign.httpclient.enabled&quot;</span><span class="token punctuation">,</span> matchIfMissing <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
<span class="token keyword">protected</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">HttpClientFeignConfiguration</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token annotation punctuation">@ConditionalOnMissingBean</span><span class="token punctuation">(</span><span class="token class-name">Client</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">Client</span> <span class="token function">feignClient</span><span class="token punctuation">(</span><span class="token class-name">HttpClient</span> httpClient<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ApacheHttpClient</span><span class="token punctuation">(</span>httpClient<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>那把 pom.xml 中的 ribbon 模块注释之后, 是不是可以解决问题呢?</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-netflix-ribbon<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>但问题并没解决, 启动出错误了:</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code>Caused by: java.lang.IllegalArgumentException: Cannot subclass final class feign.httpclient.ApacheHttpClient
at org.springframework.cglib.proxy.Enhancer.generateClass(Enhancer.java:657)
at org.springframework.cglib.core.DefaultGeneratorStrategy.generate(DefaultGeneratorStrategy.java:25)
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>这里, 又涉及了 Spring 实现动态代理的两种方式:</p> <ol><li>JDK 动态代理, 通过反射实现, 只支持对实现接口的类进行代理;</li> <li>CGLIB 动态字节码注入方式, 通过继承实现代理, 没有这个限制.</li></ol> <p><strong>Spring Boot 2.x 默认使用 CGLIB 的方式, 但通过继承实现代理有个问题是, 无法继承 final 的类. 因为, ApacheHttpClient 类就是定义为了 final</strong>:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">ApacheHttpClient</span> <span class="token keyword">implements</span> <span class="token class-name">Client</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>为解决这个问题, 把配置参数 <code>proxy-target-class</code>​ 的值修改为 false, 以切换到使用 JDK 动态代理的方式:</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code>spring.aop.proxy-target-class=false
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>修改后执行 clientWithUrl 接口可以看到, 通过 <code>within(feign.Client+)</code>​ 方式可以切入 feign.Client 子类了. 以下日志显示了 @within 和 within 的两次切入:</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code>[16:29:55.303] [http-nio-45678-exec-1] [INFO ] [o.g.t.c.spring.demo4.Wrong2Aspect       :16  ] - @within(org.springframework.cloud.openfeign.FeignClient) pjp execution(String org.geekbang.time.commonmistakes.spring.demo4.feign.ClientWithUrl.api()), args:[]
[16:29:55.310] [http-nio-45678-exec-1] [INFO ] [o.g.t.c.spring.demo4.WrongAspect        :15  ] - within(feign.Client+) pjp execution(Response feign.Client.execute(Request,Options)), args:[GET http://localhost:45678/feignaop/server HTTP/1.1

Binary data, feign.Request$Options@387550b0]
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>这下就明白了, <strong>Spring Cloud 使用了自动装配来根据依赖装配组件, 组件是否成为 Bean 决定了 AOP 是否可以切入, 在尝试通过 AOP 切入 Spring Bean 的时候要注意</strong>.</p> <p>在业务开发时, 还有一个绕不开的点是, Spring 程序的配置问题. 接下来就具体看看.</p> <h5 id="spring程序配置的优先级问题"><a href="#spring程序配置的优先级问题" class="header-anchor">#</a> Spring程序配置的优先级问题</h5> <p>我们知道, 通过配置文件 application.properties, 可以实现 Spring Boot 应用程序的<strong>参数配置</strong>. Spring 程序配置是有<strong>优先级</strong>的, 即当两个不同的配置源包含相同的配置项时, <strong>其中一个配置项很可能会被覆盖掉</strong>. 这也是为什么有时会遇到些看似诡异的配置失效问题.</p> <p>来通过一个实际案例, 研究下<strong>配置源以及配置源的优先级问题</strong>.</p> <p>对于 Spring Boot 应用程序, 一般会通过设置 management.server.port 参数, 来暴露独立的 actuator 管理端口. 这样做更安全, 也更方便监控系统统一监控程序是否健康.</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>management<span class="token punctuation">.</span>server<span class="token punctuation">.</span>port<span class="token operator">=</span><span class="token number">45679</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>有一天程序重新发布后, 监控系统显示程序离线. 但排查下来发现, 程序是正常工作的, 只是 actuator 管理端口的端口号被改了, 不是配置文件中定义的 45679 了.</p> <p>后来发现, 运维同学在服务器上<strong>定义了两个环境变量 MANAGEMENT_SERVER_IP 和 MANAGEMENT_SERVER_PORT</strong>, 目的是方便监控 Agent 把监控数据上报到统一的管理服务上:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token constant">MANAGEMENT_SERVER_IP</span><span class="token operator">=</span><span class="token number">192.168</span><span class="token number">.0</span><span class="token number">.2</span>
<span class="token constant">MANAGEMENT_SERVER_PORT</span><span class="token operator">=</span><span class="token number">12345</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>问题就是出在这里. MANAGEMENT_SERVER_PORT 覆盖了配置文件中的 management.server.port, 修改了应用程序本身的端口. 当然, 监控系统也就无法通过老的管理端口访问到应用的 health 端口了. 如下图所示, actuator 的端口号变成了 12345:</p> <p>​<img src="/img/a130bc35d495fbc417bc85720fbc477e-20230731165210-mdnk604.png" alt="">​</p> <p>到这里坑还没完, 为了方便用户登录, 需要在页面上显示默认的管理员用户名, 于是开发同学在配置文件中定义了一个 user.name 属性, 并设置为 defaultadminname:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>user<span class="token punctuation">.</span>name<span class="token operator">=</span>defaultadminname
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>后来发现, 程序读取出来的用户名根本就不是配置文件中定义的. 这又是咋回事?</p> <p>带着这个问题, 以及之前环境变量覆盖配置文件配置的问题, 写段代码看看, <strong>从 Spring 中到底能读取到几个 management.server.port 和 user.name 配置项</strong>.</p> <p>要想查询 Spring 中所有的配置, 需要以环境 Environment 接口为入口. 接下来就说说 <strong>Spring 通过环境 Environment 抽象出的 Property 和 Profile</strong>:</p> <ol><li><strong>针对 Property, 又抽象出各种 PropertySource 类代表配置源. 一个环境下可能有多个配置源, 每个配置源中有诸多配置项. 在查询配置信息时, 需要按照配置源优先级进行查询</strong>.</li> <li><strong>Profile 定义了场景的概念</strong>. 通常会定义类似 dev, test, stage 和 prod 等环境作为不同的 Profile, 用于按照场景对 Bean 进行逻辑归属. 同时 Profile 和配置文件也有关系, 每个环境都有独立的配置文件, 但只会激活某一个环境来生效特定环境的配置文件.</li></ol> <p><img src="/img/ba77a8ae9ccc1f20d4a79c6ea01412a9-20230731165210-smu1ad6.png" alt=""></p> <p>接下来重点看看 Property 的查询过程.</p> <p>对于非 Web 应用, Spring <strong>对于 Environment 接口的实现是 StandardEnvironment 类</strong>. 通过 Spring 注入 StandardEnvironment 后循环 getPropertySources 获得的 PropertySource, 来查询所有的 PropertySource 中 key 是 user.name 或 management.server.port 的属性值; 然后遍历 getPropertySources 方法, 获得所有配置源并打印出来:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Autowired</span>
<span class="token keyword">private</span> <span class="token class-name">StandardEnvironment</span> env<span class="token punctuation">;</span>

<span class="token annotation punctuation">@PostConstruct</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span><span class="token string">&quot;user.name&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;management.server.port&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>key <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
         env<span class="token punctuation">.</span><span class="token function">getPropertySources</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>propertySource <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>propertySource<span class="token punctuation">.</span><span class="token function">containsProperty</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;{} -&gt; {} 实际取值: {}&quot;</span><span class="token punctuation">,</span> propertySource<span class="token punctuation">,</span> propertySource<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">,</span> env<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;配置优先级: &quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    env<span class="token punctuation">.</span><span class="token function">getPropertySources</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token operator">::</span><span class="token function">println</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>研究下输出的日志:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token number">2020</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">15</span> <span class="token number">16</span><span class="token operator">:</span><span class="token number">08</span><span class="token operator">:</span><span class="token number">34.054</span>  <span class="token constant">INFO</span> <span class="token number">40123</span> <span class="token operator">--</span><span class="token operator">-</span> <span class="token punctuation">[</span>           main<span class="token punctuation">]</span> <span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>g<span class="token punctuation">.</span>t<span class="token punctuation">.</span>c<span class="token punctuation">.</span>s<span class="token punctuation">.</span>d<span class="token punctuation">.</span></span>CommonMistakesApplication</span>    <span class="token operator">:</span> <span class="token class-name">ConfigurationPropertySourcesPropertySource</span> <span class="token punctuation">{</span>name<span class="token operator">=</span>'configurationProperties'<span class="token punctuation">}</span> <span class="token operator">-&gt;</span> zhuye 实际取值<span class="token operator">:</span> zhuye
<span class="token number">2020</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">15</span> <span class="token number">16</span><span class="token operator">:</span><span class="token number">08</span><span class="token operator">:</span><span class="token number">34.054</span>  <span class="token constant">INFO</span> <span class="token number">40123</span> <span class="token operator">--</span><span class="token operator">-</span> <span class="token punctuation">[</span>           main<span class="token punctuation">]</span> <span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>g<span class="token punctuation">.</span>t<span class="token punctuation">.</span>c<span class="token punctuation">.</span>s<span class="token punctuation">.</span>d<span class="token punctuation">.</span></span>CommonMistakesApplication</span>    <span class="token operator">:</span> <span class="token class-name">PropertiesPropertySource</span> <span class="token punctuation">{</span>name<span class="token operator">=</span>'systemProperties'<span class="token punctuation">}</span> <span class="token operator">-&gt;</span> zhuye 实际取值<span class="token operator">:</span> zhuye
<span class="token number">2020</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">15</span> <span class="token number">16</span><span class="token operator">:</span><span class="token number">08</span><span class="token operator">:</span><span class="token number">34.054</span>  <span class="token constant">INFO</span> <span class="token number">40123</span> <span class="token operator">--</span><span class="token operator">-</span> <span class="token punctuation">[</span>           main<span class="token punctuation">]</span> <span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>g<span class="token punctuation">.</span>t<span class="token punctuation">.</span>c<span class="token punctuation">.</span>s<span class="token punctuation">.</span>d<span class="token punctuation">.</span></span>CommonMistakesApplication</span>    <span class="token operator">:</span> <span class="token class-name">OriginTrackedMapPropertySource</span> <span class="token punctuation">{</span>name<span class="token operator">=</span>'applicationConfig<span class="token operator">:</span> <span class="token punctuation">[</span>classpath<span class="token operator">:</span><span class="token operator">/</span>application<span class="token punctuation">.</span>properties<span class="token punctuation">]</span>'<span class="token punctuation">}</span> <span class="token operator">-&gt;</span> defaultadminname 实际取值<span class="token operator">:</span> zhuye
<span class="token number">2020</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">15</span> <span class="token number">16</span><span class="token operator">:</span><span class="token number">08</span><span class="token operator">:</span><span class="token number">34.054</span>  <span class="token constant">INFO</span> <span class="token number">40123</span> <span class="token operator">--</span><span class="token operator">-</span> <span class="token punctuation">[</span>           main<span class="token punctuation">]</span> <span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>g<span class="token punctuation">.</span>t<span class="token punctuation">.</span>c<span class="token punctuation">.</span>s<span class="token punctuation">.</span>d<span class="token punctuation">.</span></span>CommonMistakesApplication</span>    <span class="token operator">:</span> <span class="token class-name">ConfigurationPropertySourcesPropertySource</span> <span class="token punctuation">{</span>name<span class="token operator">=</span>'configurationProperties'<span class="token punctuation">}</span> <span class="token operator">-&gt;</span> <span class="token number">12345</span> 实际取值<span class="token operator">:</span> <span class="token number">12345</span>
<span class="token number">2020</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">15</span> <span class="token number">16</span><span class="token operator">:</span><span class="token number">08</span><span class="token operator">:</span><span class="token number">34.054</span>  <span class="token constant">INFO</span> <span class="token number">40123</span> <span class="token operator">--</span><span class="token operator">-</span> <span class="token punctuation">[</span>           main<span class="token punctuation">]</span> <span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>g<span class="token punctuation">.</span>t<span class="token punctuation">.</span>c<span class="token punctuation">.</span>s<span class="token punctuation">.</span>d<span class="token punctuation">.</span></span>CommonMistakesApplication</span>    <span class="token operator">:</span> <span class="token class-name">OriginAwareSystemEnvironmentPropertySource</span> <span class="token punctuation">{</span>name<span class="token operator">=</span>''<span class="token punctuation">}</span> <span class="token operator">-&gt;</span> <span class="token number">12345</span> 实际取值<span class="token operator">:</span> <span class="token number">12345</span>
<span class="token number">2020</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">15</span> <span class="token number">16</span><span class="token operator">:</span><span class="token number">08</span><span class="token operator">:</span><span class="token number">34.054</span>  <span class="token constant">INFO</span> <span class="token number">40123</span> <span class="token operator">--</span><span class="token operator">-</span> <span class="token punctuation">[</span>           main<span class="token punctuation">]</span> <span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>g<span class="token punctuation">.</span>t<span class="token punctuation">.</span>c<span class="token punctuation">.</span>s<span class="token punctuation">.</span>d<span class="token punctuation">.</span></span>CommonMistakesApplication</span>    <span class="token operator">:</span> <span class="token class-name">OriginTrackedMapPropertySource</span> <span class="token punctuation">{</span>name<span class="token operator">=</span>'applicationConfig<span class="token operator">:</span> <span class="token punctuation">[</span>classpath<span class="token operator">:</span><span class="token operator">/</span>application<span class="token punctuation">.</span>properties<span class="token punctuation">]</span>'<span class="token punctuation">}</span> <span class="token operator">-&gt;</span> <span class="token number">45679</span> 实际取值<span class="token operator">:</span> <span class="token number">12345</span>
配置优先级<span class="token operator">:</span> 
<span class="token class-name">ConfigurationPropertySourcesPropertySource</span> <span class="token punctuation">{</span>name<span class="token operator">=</span>'configurationProperties'<span class="token punctuation">}</span>
<span class="token class-name">StubPropertySource</span> <span class="token punctuation">{</span>name<span class="token operator">=</span>'servletConfigInitParams'<span class="token punctuation">}</span>
<span class="token class-name">ServletContextPropertySource</span> <span class="token punctuation">{</span>name<span class="token operator">=</span>'servletContextInitParams'<span class="token punctuation">}</span>
<span class="token class-name">PropertiesPropertySource</span> <span class="token punctuation">{</span>name<span class="token operator">=</span>'systemProperties'<span class="token punctuation">}</span>
<span class="token class-name">OriginAwareSystemEnvironmentPropertySource</span> <span class="token punctuation">{</span>name<span class="token operator">=</span>'systemEnvironment'<span class="token punctuation">}</span>
<span class="token class-name">RandomValuePropertySource</span> <span class="token punctuation">{</span>name<span class="token operator">=</span><span class="token char">'random'</span><span class="token punctuation">}</span>
<span class="token class-name">OriginTrackedMapPropertySource</span> <span class="token punctuation">{</span>name<span class="token operator">=</span>'applicationConfig<span class="token operator">:</span> <span class="token punctuation">[</span>classpath<span class="token operator">:</span><span class="token operator">/</span>application<span class="token punctuation">.</span>properties<span class="token punctuation">]</span>'<span class="token punctuation">}</span>
<span class="token class-name">MapPropertySource</span> <span class="token punctuation">{</span>name<span class="token operator">=</span>'springCloudClientHostInfo'<span class="token punctuation">}</span>
<span class="token class-name">MapPropertySource</span> <span class="token punctuation">{</span>name<span class="token operator">=</span>'defaultProperties'<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><ol><li>有三处定义了 user.name: 第一个是 <strong>configurationProperties</strong>, 值是 zhuye; 第二个是 <strong>systemProperties</strong>, 代表系统配置, 值是 zhuye; 第三个是 <strong>applicationConfig</strong>, 也就是配置文件, 值是配置文件中定义的 defaultadminname.</li> <li>同样地, 也有三处定义了 management.server.port: 第一个是 configurationProperties, 值是 12345; 第二个是 systemEnvironment 代表系统环境, 值是 12345; 第三个是 applicationConfig, 也就是我们的配置文件, 值是配置文件中定义的 45679.</li> <li>第 7 到 16 行的输出显示, Spring 中有 9 个配置源, 值得关注是 ConfigurationPropertySourcesPropertySource, PropertiesPropertySource, OriginAwareSystemEnvironmentPropertySource 和配置文件.</li></ol> <p>那么, Spring 真的是按这个顺序查询配置吗? 最前面的 configurationProperties 又是什么? 为了回答这 2 个问题, 需要分析下源码. 先说明下, 下面源码分析的逻辑有些复杂, 可以结合着下面的整体流程图来理解:</p> <p><img src="/img/2f9a24707e8af180fcd06e4a15a79dea-20230731165210-nrim4v2.png" alt=""></p> <p>Demo 中注入的 StandardEnvironment, 继承的是 AbstractEnvironment(图中紫色类). AbstractEnvironment 的源码如下:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">AbstractEnvironment</span> <span class="token keyword">implements</span> <span class="token class-name">ConfigurableEnvironment</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">MutablePropertySources</span> propertySources <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MutablePropertySources</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ConfigurablePropertyResolver</span> propertyResolver <span class="token operator">=</span>
            <span class="token keyword">new</span> <span class="token class-name">PropertySourcesPropertyResolver</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>propertySources<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>propertyResolver<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>可以看到:</p> <ol><li>MutablePropertySources 类型的字段 propertySources, 看起来代表了<strong>所有配置源</strong>;</li> <li>getProperty 方法, 通过 PropertySourcesPropertyResolver 类进行查询配置;</li> <li>实例化 PropertySourcesPropertyResolver 的时候, 传入了当前的 MutablePropertySources.</li></ol> <p>接下来, 继续分析 MutablePropertySources 和 PropertySourcesPropertyResolver. 先看看 MutablePropertySources 的源码(图中蓝色类):</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MutablePropertySources</span> <span class="token keyword">implements</span> <span class="token class-name">PropertySources</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PropertySource</span><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> propertySourceList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CopyOnWriteArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addFirst</span><span class="token punctuation">(</span><span class="token class-name">PropertySource</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> propertySource<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">removeIfPresent</span><span class="token punctuation">(</span>propertySource<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>propertySourceList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> propertySource<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addLast</span><span class="token punctuation">(</span><span class="token class-name">PropertySource</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> propertySource<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">removeIfPresent</span><span class="token punctuation">(</span>propertySource<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>propertySourceList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>propertySource<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addBefore</span><span class="token punctuation">(</span><span class="token class-name">String</span> relativePropertySourceName<span class="token punctuation">,</span> <span class="token class-name">PropertySource</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> propertySource<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// ...</span>
        <span class="token keyword">int</span> index <span class="token operator">=</span> <span class="token function">assertPresentAndGetIndex</span><span class="token punctuation">(</span>relativePropertySourceName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">addAtIndex</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span> propertySource<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addAfter</span><span class="token punctuation">(</span><span class="token class-name">String</span> relativePropertySourceName<span class="token punctuation">,</span> <span class="token class-name">PropertySource</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> propertySource<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// ...</span>
        <span class="token keyword">int</span> index <span class="token operator">=</span> <span class="token function">assertPresentAndGetIndex</span><span class="token punctuation">(</span>relativePropertySourceName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">addAtIndex</span><span class="token punctuation">(</span>index <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> propertySource<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">addAtIndex</span><span class="token punctuation">(</span><span class="token keyword">int</span> index<span class="token punctuation">,</span> <span class="token class-name">PropertySource</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> propertySource<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">removeIfPresent</span><span class="token punctuation">(</span>propertySource<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>propertySourceList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span> propertySource<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br></div></div><p>可以发现:</p> <ol><li>propertySourceList 字段用来真正保存 PropertySource 的 List, 且这个 List 是一个 CopyOnWriteArrayList.</li> <li>类中定义了 addFirst, addLast, addBefore, addAfter 等方法, 来精确控制 PropertySource 加入 propertySourceList 的顺序. 这也说明了顺序的重要性.</li></ol> <p>继续看下 PropertySourcesPropertyResolver(图中绿色类)的源码, 找到真正查询配置的方法 getProperty.</p> <p>这里重点看一下第 9 行代码: 遍历的 propertySources 是 PropertySourcesPropertyResolver 构造方法传入的, 再结合 AbstractEnvironment 的源码可以发现, 这个 propertySources 正是 AbstractEnvironment 中的 MutablePropertySources 对象. 遍历时, 如果发现配置源中有对应的 Key 值, 则使用这个值. 因此, <strong>MutablePropertySources 中配置源的次序尤为重要</strong>.</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PropertySourcesPropertyResolver</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractPropertyResolver</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">PropertySources</span> propertySources<span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token class-name">PropertySourcesPropertyResolver</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Nullable</span> <span class="token class-name">PropertySources</span> propertySources<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>propertySources <span class="token operator">=</span> propertySources<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">protected</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">T</span> <span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> targetValueType<span class="token punctuation">,</span> <span class="token keyword">boolean</span> resolveNestedPlaceholders<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>propertySources <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">PropertySource</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> propertySource <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>propertySources<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isTraceEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    logger<span class="token punctuation">.</span><span class="token function">trace</span><span class="token punctuation">(</span><span class="token string">&quot;Searching for key '&quot;</span> <span class="token operator">+</span> key <span class="token operator">+</span> <span class="token string">&quot;' in PropertySource '&quot;</span> <span class="token operator">+</span>
                            propertySource<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;'&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token class-name">Object</span> value <span class="token operator">=</span> propertySource<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>resolveNestedPlaceholders <span class="token operator">&amp;&amp;</span> value <span class="token keyword">instanceof</span> <span class="token class-name">String</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        value <span class="token operator">=</span> <span class="token function">resolveNestedPlaceholders</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token function">logKeyFound</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> propertySource<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span> <span class="token function">convertValueIfNecessary</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> targetValueType<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token comment">// ...</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><p>回到之前的问题, 在查询所有配置源的时候, 注意到处在第一位的是 ConfigurationPropertySourcesPropertySource, 这是什么呢?</p> <p>其实, 它不是一个实际存在的配置源, 扮演的是一个代理的角色. 但通过调试会发现, 我们获取的值竟然是由它提供并且返回的, 且没有循环遍历后面的 PropertySource:</p> <p><img src="/img/44b26ecc444396efd5d4630e915a7c44-20230731165210-mjj2ymk.png" alt=""></p> <p>继续查看 ConfigurationPropertySourcesPropertySource(图中红色类)的源码可以发现, getProperty 方法其实是通过 findConfigurationProperty 方法查询配置的. 如第 25 行代码所示, 这其实还是在遍历所有的配置源:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">class</span> <span class="token class-name">ConfigurationPropertySourcesPropertySource</span> <span class="token keyword">extends</span> <span class="token class-name">PropertySource</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Iterable</span><span class="token punctuation">&lt;</span><span class="token class-name">ConfigurationPropertySource</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span>
        <span class="token keyword">implements</span> <span class="token class-name">OriginLookup</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
    <span class="token class-name">ConfigurationPropertySourcesPropertySource</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">,</span> <span class="token class-name">Iterable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ConfigurationPropertySource</span><span class="token punctuation">&gt;</span></span> source<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> source<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">ConfigurationProperty</span> configurationProperty <span class="token operator">=</span> <span class="token function">findConfigurationProperty</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span>configurationProperty <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token operator">?</span> configurationProperty<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token class-name">ConfigurationProperty</span> <span class="token function">findConfigurationProperty</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token function">findConfigurationProperty</span><span class="token punctuation">(</span><span class="token class-name">ConfigurationPropertyName</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token class-name">ConfigurationProperty</span> <span class="token function">findConfigurationProperty</span><span class="token punctuation">(</span><span class="token class-name">ConfigurationPropertyName</span> name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>name <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">ConfigurationPropertySource</span> configurationPropertySource <span class="token operator">:</span> <span class="token function">getSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">ConfigurationProperty</span> configurationProperty <span class="token operator">=</span> configurationPropertySource<span class="token punctuation">.</span><span class="token function">getConfigurationProperty</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>configurationProperty <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> configurationProperty<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br></div></div><p>调试可以发现, 这个循环遍历(getSource() 的结果)的配置源, 其实是 SpringConfigurationPropertySources(图中黄色类), 其中包含的配置源列表就是之前看到的 9 个配置源, 而第一个就是 ConfigurationPropertySourcesPropertySource. 看到这里, 大家的第一感觉是会不会产生死循环, 它在遍历的时候怎么排除自己呢?</p> <p>同时观察 configurationProperty 可以看到, <strong>这个 ConfigurationProperty 其实类似代理的角色, 实际配置是从系统属性中获得的</strong>:</p> <p><img src="/img/d4a21185936ba58a6b2c7e5e106dcd06-20230731165210-l3w86p7.png" alt=""></p> <p>继续查看 SpringConfigurationPropertySources 可以发现, 它返回的迭代器是内部类 SourcesIterator, 在 fetchNext 方法获取下一个项时, 通过 isIgnored 方法排除了 ConfigurationPropertySourcesPropertySource(源码第 38 行):</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">class</span> <span class="token class-name">SpringConfigurationPropertySources</span> <span class="token keyword">implements</span> <span class="token class-name">Iterable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ConfigurationPropertySource</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Iterable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PropertySource</span><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> sources<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PropertySource</span><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span> <span class="token class-name">ConfigurationPropertySource</span><span class="token punctuation">&gt;</span></span> cache <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentReferenceHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span>
            <span class="token class-name">ReferenceType</span><span class="token punctuation">.</span><span class="token constant">SOFT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">SpringConfigurationPropertySources</span><span class="token punctuation">(</span><span class="token class-name">Iterable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PropertySource</span><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> sources<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">notNull</span><span class="token punctuation">(</span>sources<span class="token punctuation">,</span> <span class="token string">&quot;Sources must not be null&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>sources <span class="token operator">=</span> sources<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Iterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ConfigurationPropertySource</span><span class="token punctuation">&gt;</span></span> <span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">SourcesIterator</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>sources<span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token operator">::</span><span class="token function">adapt</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">SourcesIterator</span> <span class="token keyword">implements</span> <span class="token class-name">Iterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ConfigurationPropertySource</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token function">fetchNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">private</span> <span class="token class-name">ConfigurationPropertySource</span> <span class="token function">fetchNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>next <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>iterators<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>iterators<span class="token punctuation">.</span><span class="token function">peek</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">this</span><span class="token punctuation">.</span>iterators<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span> <span class="token function">fetchNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token class-name">PropertySource</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> candidate <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>iterators<span class="token punctuation">.</span><span class="token function">peek</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>candidate<span class="token punctuation">.</span><span class="token function">getSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">instanceof</span> <span class="token class-name">ConfigurableEnvironment</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">ConfigurableEnvironment</span><span class="token punctuation">)</span> candidate<span class="token punctuation">.</span><span class="token function">getSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span> <span class="token function">fetchNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isIgnored</span><span class="token punctuation">(</span>candidate<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span> <span class="token function">fetchNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>next <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>adapter<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>candidate<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>next<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">push</span><span class="token punctuation">(</span><span class="token class-name">ConfigurableEnvironment</span> environment<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>iterators<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>environment<span class="token punctuation">.</span><span class="token function">getPropertySources</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">isIgnored</span><span class="token punctuation">(</span><span class="token class-name">PropertySource</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> candidate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token punctuation">(</span>candidate <span class="token keyword">instanceof</span> <span class="token class-name">StubPropertySource</span>
                    <span class="token operator">||</span> candidate <span class="token keyword">instanceof</span> <span class="token class-name">ConfigurationPropertySourcesPropertySource</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br></div></div><p>前面已经了解了 ConfigurationPropertySourcesPropertySource 是所有配置源中的第一个, 实现了对 PropertySourcesPropertyResolver 中遍历逻辑的 &quot;劫持&quot;, 并且知道了其遍历逻辑. 最后一个问题是, 它如何让自己成为第一个配置源呢?</p> <p>再次运用之前学到的那个小技巧, 来查看实例化 ConfigurationPropertySourcesPropertySource 的地方:</p> <p><img src="/img/5cfcb75ec28d1fffbf1af25c0fd4345a-20230731165210-tvsmqpd.png" alt=""></p> <p>可以看到, <strong>ConfigurationPropertySourcesPropertySource 类是由 ConfigurationPropertySources 的 attach 方法实例化的</strong>. 查阅源码可以发现, 这个方法的确从环境中获得了原始的 MutablePropertySources, 把自己加入成为一个元素:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">ConfigurationPropertySources</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">attach</span><span class="token punctuation">(</span><span class="token class-name">Environment</span> environment<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">MutablePropertySources</span> sources <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">ConfigurableEnvironment</span><span class="token punctuation">)</span> environment<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPropertySources</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">PropertySource</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> attached <span class="token operator">=</span> sources<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token constant">ATTACHED_PROPERTY_SOURCE_NAME</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>attached <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            sources<span class="token punctuation">.</span><span class="token function">addFirst</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ConfigurationPropertySourcesPropertySource</span><span class="token punctuation">(</span><span class="token constant">ATTACHED_PROPERTY_SOURCE_NAME</span><span class="token punctuation">,</span>
                    <span class="token keyword">new</span> <span class="token class-name">SpringConfigurationPropertySources</span><span class="token punctuation">(</span>sources<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>而这个 attach 方法, 是 Spring 应用程序启动时准备环境的时候调用的. 在 SpringApplication 的 run 方法中调用了 prepareEnvironment 方法, 然后又调用了 <strong>ConfigurationPropertySources.attach</strong> 方法:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SpringApplication</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token class-name">ConfigurableApplicationContext</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// ...</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">ApplicationArguments</span> applicationArguments <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultApplicationArguments</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">ConfigurableEnvironment</span> environment <span class="token operator">=</span> <span class="token function">prepareEnvironment</span><span class="token punctuation">(</span>listeners<span class="token punctuation">,</span> applicationArguments<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//...</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// ...</span>
        <span class="token punctuation">}</span>

    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token class-name">ConfigurableEnvironment</span> <span class="token function">prepareEnvironment</span><span class="token punctuation">(</span><span class="token class-name">SpringApplicationRunListeners</span> listeners<span class="token punctuation">,</span>
                                                       <span class="token class-name">ApplicationArguments</span> applicationArguments<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// ...</span>
        <span class="token class-name">ConfigurationPropertySources</span><span class="token punctuation">.</span><span class="token function">attach</span><span class="token punctuation">(</span>environment<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// ...</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><p>看到这里你是否彻底理清楚 Spring 劫持 PropertySourcesPropertyResolver 的实现方式, 以及配置源有优先级的原因了呢? 如果想知道 Spring 各种预定义的配置源的优先级, 可以参考官方文档.</p> <h5 id="重点回顾-20"><a href="#重点回顾-20" class="header-anchor">#</a> 重点回顾</h5> <p>今天用两个业务开发中的实际案例, 进一步学习了 Spring 的 AOP 和配置优先级这两大知识点.</p> <p>对于 AOP 切 Feign 的案例, 在实现功能时走了一些弯路. Spring Cloud 会使用 Spring Boot 的特性, 根据当前引入包的情况做各种自动装配. 如果要扩展 Spring 的组件, 那么只有清晰了解 Spring 自动装配的运作方式, 才能鉴别运行时对象在 Spring 容器中的情况, <strong>不能想当然认为代码中能看到的所有 Spring 的类都是 Bean</strong>.</p> <p>对于配置优先级的案例, 分析配置源优先级时, 如果以为看到 PropertySourcesPropertyResolver 就看到了真相, 后续进行扩展开发时就可能会踩坑. 一定要注意, <strong>分析 Spring 源码时, 看到的表象不一定是实际运行时的情况, 还需要借助日志或调试工具来理清整个过程</strong>. 如果没有调试工具, 可以借助 Arthas 来分析代码调用路径.</p> <h3 id="设计篇"><a href="#设计篇" class="header-anchor">#</a> 设计篇</h3> <h4 id="_21-代码重复-搞定代码重复的三个绝招"><a href="#_21-代码重复-搞定代码重复的三个绝招" class="header-anchor">#</a> 21-代码重复:搞定代码重复的三个绝招</h4> <p>今天聊聊搞定代码重复的三个绝招.</p> <p>业务同学抱怨业务开发没有技术含量, 用不到设计模式, Java 高级特性, OOP, 平时写代码都在堆 CRUD, 个人成长无从谈起. 每次面试官问到 &quot;请说说平时常用的设计模式&quot;, 都只能答单例模式, 因为其他设计模式的确是听过但没用过; 对于反射, 注解之类的高级特性, 也只是知道它们在写框架的时候非常常用, 但自己又不写框架代码, 没有用武之地.</p> <p>其实, 我认为不是这样的. 设计模式, OOP 是前辈们在大型项目中积累下来的经验, 通过这些方法论来改善大型项目的可维护性. <strong>反射, 注解, 泛型等高级特性在框架中大量使用的原因是, 框架往往需要以同一套算法来应对不同的数据结构, 而这些特性可以帮助减少重复代码, 提升项目可维护性</strong>.</p> <p>在我看来, 可维护性是大型项目成熟度的一个重要指标, 而提升可维护性非常重要的一个手段就是<strong>减少代码重复</strong>. 那为什么这样说呢?</p> <ol><li>如果多处重复代码实现完全相同的功能, 很容易修改一处忘记修改另一处, 造成 Bug;</li> <li>有一些代码并不是完全重复, 而是相似度很高, 修改这些类似的代码容易改(复制粘贴)错, 把原本有区别的地方改为了一样.</li></ol> <p>今天就从业务代码中最常见的三个需求展开, 聊聊如何使用 Java 中的一些高级特性, 设计模式, 以及一些工具消除重复代码, 才能既优雅又高端. 通过今天的学习, 也希望改变你对业务代码没有技术含量的看法.</p> <h5 id="利用工厂模式-模板方法模式-消除if-else和重复代码"><a href="#利用工厂模式-模板方法模式-消除if-else和重复代码" class="header-anchor">#</a> 利用工厂模式+模板方法模式,消除if...else和重复代码</h5> <p>假设要开发一个购物车下单的功能, 针对不同用户进行不同处理:</p> <ol><li>普通用户需要收取运费, 运费是商品价格的 10%, 无商品折扣;</li> <li>VIP 用户同样需要收取商品价格 10% 的快递费, 但购买两件以上相同商品时, 第三件开始享受一定折扣;</li> <li>内部用户可以免运费, 无商品折扣.</li></ol> <p>目标是实现三种类型的购物车业务逻辑, 把入参 Map 对象(Key 是商品 ID, Value 是商品数量), 转换为出参购物车类型 Cart.</p> <p>先实现针对普通用户的购物车处理逻辑:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// 购物车</span>
<span class="token annotation punctuation">@Data</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Cart</span> <span class="token punctuation">{</span>
    <span class="token comment">// 商品清单</span>
    <span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Item</span><span class="token punctuation">&gt;</span></span> items <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 总优惠</span>
    <span class="token keyword">private</span> <span class="token class-name">BigDecimal</span> totalDiscount<span class="token punctuation">;</span>
    <span class="token comment">// 商品总价</span>
    <span class="token keyword">private</span> <span class="token class-name">BigDecimal</span> totalItemPrice<span class="token punctuation">;</span>
    <span class="token comment">// 总运费</span>
    <span class="token keyword">private</span> <span class="token class-name">BigDecimal</span> totalDeliveryPrice<span class="token punctuation">;</span>
    <span class="token comment">// 应付总价</span>
    <span class="token keyword">private</span> <span class="token class-name">BigDecimal</span> payPrice<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 购物车中的商品</span>
<span class="token annotation punctuation">@Data</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Item</span> <span class="token punctuation">{</span>
    <span class="token comment">// 商品ID</span>
    <span class="token keyword">private</span> <span class="token keyword">long</span> id<span class="token punctuation">;</span>
    <span class="token comment">// 商品数量</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> quantity<span class="token punctuation">;</span>
    <span class="token comment">// 商品单价</span>
    <span class="token keyword">private</span> <span class="token class-name">BigDecimal</span> price<span class="token punctuation">;</span>
    <span class="token comment">// 商品优惠</span>
    <span class="token keyword">private</span> <span class="token class-name">BigDecimal</span> couponPrice<span class="token punctuation">;</span>
    <span class="token comment">// 商品运费</span>
    <span class="token keyword">private</span> <span class="token class-name">BigDecimal</span> deliveryPrice<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 普通用户购物车处理</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">NormalUserCart</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token class-name">Cart</span> <span class="token function">process</span><span class="token punctuation">(</span><span class="token keyword">long</span> userId<span class="token punctuation">,</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> items<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Cart</span> cart <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Cart</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 把Map的购物车转换为Item列表</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Item</span><span class="token punctuation">&gt;</span></span> itemList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        items<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>entry <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token class-name">Item</span> item <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Item</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            item<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span>entry<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            item<span class="token punctuation">.</span><span class="token function">setPrice</span><span class="token punctuation">(</span><span class="token class-name">Db</span><span class="token punctuation">.</span><span class="token function">getItemPrice</span><span class="token punctuation">(</span>entry<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            item<span class="token punctuation">.</span><span class="token function">setQuantity</span><span class="token punctuation">(</span>entry<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            itemList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        cart<span class="token punctuation">.</span><span class="token function">setItems</span><span class="token punctuation">(</span>itemList<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 处理运费和商品优惠</span>
        itemList<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>item <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token comment">// 运费为商品总价的10%</span>
            item<span class="token punctuation">.</span><span class="token function">setDeliveryPrice</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span><span class="token function">getPrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">multiply</span><span class="token punctuation">(</span><span class="token class-name">BigDecimal</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span><span class="token function">getQuantity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">multiply</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BigDecimal</span><span class="token punctuation">(</span><span class="token string">&quot;0.1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 无优惠</span>
            item<span class="token punctuation">.</span><span class="token function">setCouponPrice</span><span class="token punctuation">(</span><span class="token class-name">BigDecimal</span><span class="token punctuation">.</span><span class="token constant">ZERO</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 计算商品总价</span>
        cart<span class="token punctuation">.</span><span class="token function">setTotalItemPrice</span><span class="token punctuation">(</span>cart<span class="token punctuation">.</span><span class="token function">getItems</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>item <span class="token operator">-&gt;</span> item<span class="token punctuation">.</span><span class="token function">getPrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">multiply</span><span class="token punctuation">(</span><span class="token class-name">BigDecimal</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span><span class="token function">getQuantity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token class-name">BigDecimal</span><span class="token punctuation">.</span><span class="token constant">ZERO</span><span class="token punctuation">,</span> <span class="token class-name">BigDecimal</span><span class="token operator">::</span><span class="token function">add</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 计算运费总价</span>
        cart<span class="token punctuation">.</span><span class="token function">setTotalDeliveryPrice</span><span class="token punctuation">(</span>cart<span class="token punctuation">.</span><span class="token function">getItems</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">Item</span><span class="token operator">::</span><span class="token function">getDeliveryPrice</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token class-name">BigDecimal</span><span class="token punctuation">.</span><span class="token constant">ZERO</span><span class="token punctuation">,</span> <span class="token class-name">BigDecimal</span><span class="token operator">::</span><span class="token function">add</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 计算总优惠</span>
        cart<span class="token punctuation">.</span><span class="token function">setTotalDiscount</span><span class="token punctuation">(</span>cart<span class="token punctuation">.</span><span class="token function">getItems</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">Item</span><span class="token operator">::</span><span class="token function">getCouponPrice</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token class-name">BigDecimal</span><span class="token punctuation">.</span><span class="token constant">ZERO</span><span class="token punctuation">,</span> <span class="token class-name">BigDecimal</span><span class="token operator">::</span><span class="token function">add</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 应付总价=商品总价+运费总价-总优惠</span>
        cart<span class="token punctuation">.</span><span class="token function">setPayPrice</span><span class="token punctuation">(</span>cart<span class="token punctuation">.</span><span class="token function">getTotalItemPrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>cart<span class="token punctuation">.</span><span class="token function">getTotalDeliveryPrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">subtract</span><span class="token punctuation">(</span>cart<span class="token punctuation">.</span><span class="token function">getTotalDiscount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> cart<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br></div></div><p>然后实现针对 VIP 用户的购物车逻辑. 与普通用户购物车逻辑的不同在于, VIP 用户能享受同类商品多买的折扣. 所以, 这部分代码只需要额外处理多买折扣部分:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">VipUserCart</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token class-name">Cart</span> <span class="token function">process</span><span class="token punctuation">(</span><span class="token keyword">long</span> userId<span class="token punctuation">,</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> items<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// ...</span>
        itemList<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>item <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token comment">// 运费为商品总价的10%</span>
            item<span class="token punctuation">.</span><span class="token function">setDeliveryPrice</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span><span class="token function">getPrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">multiply</span><span class="token punctuation">(</span><span class="token class-name">BigDecimal</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span><span class="token function">getQuantity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">multiply</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BigDecimal</span><span class="token punctuation">(</span><span class="token string">&quot;0.1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 购买两件以上相同商品, 第三件开始享受一定折扣</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>item<span class="token punctuation">.</span><span class="token function">getQuantity</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                item<span class="token punctuation">.</span><span class="token function">setCouponPrice</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span><span class="token function">getPrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">multiply</span><span class="token punctuation">(</span><span class="token class-name">BigDecimal</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span><span class="token number">100</span> <span class="token operator">-</span> <span class="token class-name">Db</span><span class="token punctuation">.</span><span class="token function">getUserCouponPercent</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">divide</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BigDecimal</span><span class="token punctuation">(</span><span class="token string">&quot;100&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">multiply</span><span class="token punctuation">(</span><span class="token class-name">BigDecimal</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span><span class="token function">getQuantity</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                item<span class="token punctuation">.</span><span class="token function">setCouponPrice</span><span class="token punctuation">(</span><span class="token class-name">BigDecimal</span><span class="token punctuation">.</span><span class="token constant">ZERO</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// ...</span>
        <span class="token keyword">return</span> cart<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p>最后是免运费, 无折扣的内部用户, 同样只是处理商品折扣和运费时的逻辑差异:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">InternalUserCart</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token class-name">Cart</span> <span class="token function">process</span><span class="token punctuation">(</span><span class="token keyword">long</span> userId<span class="token punctuation">,</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> items<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// ...</span>
        itemList<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>item <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token comment">// 免运费</span>
            item<span class="token punctuation">.</span><span class="token function">setDeliveryPrice</span><span class="token punctuation">(</span><span class="token class-name">BigDecimal</span><span class="token punctuation">.</span><span class="token constant">ZERO</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 无优惠</span>
            item<span class="token punctuation">.</span><span class="token function">setCouponPrice</span><span class="token punctuation">(</span><span class="token class-name">BigDecimal</span><span class="token punctuation">.</span><span class="token constant">ZERO</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// ...</span>
        <span class="token keyword">return</span> cart<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>对比一下代码量可以发现, 三种购物车 70% 的代码是重复的. 原因很简单, 虽然不同类型用户计算运费和优惠的方式不同, 但整个购物车的初始化, 统计总价, 总运费, 总优惠和支付价格的逻辑都是一样的.</p> <p>正如开始时提到的, 代码重复本身不可怕, 可怕的是漏改或改错. 比如, 写 VIP 用户购物车的同学发现商品总价计算有 Bug, 不应该是把所有 Item 的 price 加在一起, 而是应该把所有 Item 的 price * quantity 加在一起. 这时他可能会只修改 VIP 用户购物车的代码, 而忽略了普通用户, 内部用户的购物车中, 重复的逻辑实现也有相同的 Bug.</p> <p>有了三个购物车后, 就需要根据不同的用户类型使用不同的购物车了. 如下代码所示, 使用三个 if 实现不同类型用户调用不同购物车的 process 方法:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;wrong&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">Cart</span> <span class="token function">wrong</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;userId&quot;</span><span class="token punctuation">)</span> <span class="token keyword">int</span> userId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 根据用户ID获得用户类型</span>
    <span class="token class-name">String</span> userCategory <span class="token operator">=</span> <span class="token class-name">Db</span><span class="token punctuation">.</span><span class="token function">getUserCategory</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 普通用户处理逻辑</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>userCategory<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">&quot;Normal&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">NormalUserCart</span> normalUserCart <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NormalUserCart</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> normalUserCart<span class="token punctuation">.</span><span class="token function">process</span><span class="token punctuation">(</span>userId<span class="token punctuation">,</span> items<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// VIP用户处理逻辑</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>userCategory<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">&quot;Vip&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">VipUserCart</span> vipUserCart <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">VipUserCart</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> vipUserCart<span class="token punctuation">.</span><span class="token function">process</span><span class="token punctuation">(</span>userId<span class="token punctuation">,</span> items<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 内部用户处理逻辑</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>userCategory<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">&quot;Internal&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">InternalUserCart</span> internalUserCart <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">InternalUserCart</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> internalUserCart<span class="token punctuation">.</span><span class="token function">process</span><span class="token punctuation">(</span>userId<span class="token punctuation">,</span> items<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><p>电商的营销玩法是多样的, 以后势必还会有更多用户类型, 需要更多的购物车. 就只能不断增加更多的购物车类, 一遍一遍地写重复的购物车逻辑, 写更多的 if 逻辑吗?</p> <p>当然不是, <strong>相同的代码应该只在一处出现</strong>!</p> <p>如果大家熟记抽象类和抽象方法的定义的话, 这时或许就会想到, 是否可以把重复的逻辑定义在抽象类中, 三个购物车只要分别实现不同的那份逻辑呢?</p> <p>其实, 这个模式就是<strong>模板方法模式</strong>. 在父类中实现了购物车处理的流程模板, 然后把需要特殊处理的地方留空白也就是留抽象方法定义, 让子类去实现其中的逻辑. 由于父类的逻辑不完整无法单独工作, 因此需要定义为抽象类.</p> <p>如下代码所示, <strong>AbstractCart 抽象类实现了购物车通用的逻辑, 额外定义了两个抽象方法让子类去实现. 其中, processCouponPrice 方法用于计算商品折扣, processDeliveryPrice 方法用于计算运费</strong>.</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">AbstractCart</span> <span class="token punctuation">{</span>
    <span class="token comment">// 处理购物车的大量重复逻辑在父类实现</span>
    <span class="token keyword">public</span> <span class="token class-name">Cart</span> <span class="token function">process</span><span class="token punctuation">(</span><span class="token keyword">long</span> userId<span class="token punctuation">,</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> items<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Cart</span> cart <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Cart</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Item</span><span class="token punctuation">&gt;</span></span> itemList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        items<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>entry <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token class-name">Item</span> item <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Item</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            item<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span>entry<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            item<span class="token punctuation">.</span><span class="token function">setPrice</span><span class="token punctuation">(</span><span class="token class-name">Db</span><span class="token punctuation">.</span><span class="token function">getItemPrice</span><span class="token punctuation">(</span>entry<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            item<span class="token punctuation">.</span><span class="token function">setQuantity</span><span class="token punctuation">(</span>entry<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            itemList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        cart<span class="token punctuation">.</span><span class="token function">setItems</span><span class="token punctuation">(</span>itemList<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 让子类处理每一个商品的优惠</span>
        itemList<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>item <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token function">processCouponPrice</span><span class="token punctuation">(</span>userId<span class="token punctuation">,</span> item<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">processDeliveryPrice</span><span class="token punctuation">(</span>userId<span class="token punctuation">,</span> item<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 计算商品总价</span>
        cart<span class="token punctuation">.</span><span class="token function">setTotalItemPrice</span><span class="token punctuation">(</span>cart<span class="token punctuation">.</span><span class="token function">getItems</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>item <span class="token operator">-&gt;</span> item<span class="token punctuation">.</span><span class="token function">getPrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">multiply</span><span class="token punctuation">(</span><span class="token class-name">BigDecimal</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span><span class="token function">getQuantity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token class-name">BigDecimal</span><span class="token punctuation">.</span><span class="token constant">ZERO</span><span class="token punctuation">,</span> <span class="token class-name">BigDecimal</span><span class="token operator">::</span><span class="token function">add</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 计算总运费</span>
cart<span class="token punctuation">.</span><span class="token function">setTotalDeliveryPrice</span><span class="token punctuation">(</span>cart<span class="token punctuation">.</span><span class="token function">getItems</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">Item</span><span class="token operator">::</span><span class="token function">getDeliveryPrice</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token class-name">BigDecimal</span><span class="token punctuation">.</span><span class="token constant">ZERO</span><span class="token punctuation">,</span> <span class="token class-name">BigDecimal</span><span class="token operator">::</span><span class="token function">add</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 计算总折扣</span>
cart<span class="token punctuation">.</span><span class="token function">setTotalDiscount</span><span class="token punctuation">(</span>cart<span class="token punctuation">.</span><span class="token function">getItems</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">Item</span><span class="token operator">::</span><span class="token function">getCouponPrice</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token class-name">BigDecimal</span><span class="token punctuation">.</span><span class="token constant">ZERO</span><span class="token punctuation">,</span> <span class="token class-name">BigDecimal</span><span class="token operator">::</span><span class="token function">add</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 计算应付价格</span>
cart<span class="token punctuation">.</span><span class="token function">setPayPrice</span><span class="token punctuation">(</span>cart<span class="token punctuation">.</span><span class="token function">getTotalItemPrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>cart<span class="token punctuation">.</span><span class="token function">getTotalDeliveryPrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">subtract</span><span class="token punctuation">(</span>cart<span class="token punctuation">.</span><span class="token function">getTotalDiscount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> cart<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 处理商品优惠的逻辑留给子类实现</span>
    <span class="token keyword">protected</span> <span class="token keyword">abstract</span> <span class="token keyword">void</span> <span class="token function">processCouponPrice</span><span class="token punctuation">(</span><span class="token keyword">long</span> userId<span class="token punctuation">,</span> <span class="token class-name">Item</span> item<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 处理配送费的逻辑留给子类实现</span>
    <span class="token keyword">protected</span> <span class="token keyword">abstract</span> <span class="token keyword">void</span> <span class="token function">processDeliveryPrice</span><span class="token punctuation">(</span><span class="token keyword">long</span> userId<span class="token punctuation">,</span> <span class="token class-name">Item</span> item<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br></div></div><p>有了这个抽象类, 三个子类的实现就非常简单了. 普通用户的购物车 NormalUserCart, 实现的是 0 优惠和 10% 运费的逻辑:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Service</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;NormalUserCart&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">NormalUserCart</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractCart</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">processCouponPrice</span><span class="token punctuation">(</span><span class="token keyword">long</span> userId<span class="token punctuation">,</span> <span class="token class-name">Item</span> item<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        item<span class="token punctuation">.</span><span class="token function">setCouponPrice</span><span class="token punctuation">(</span><span class="token class-name">BigDecimal</span><span class="token punctuation">.</span><span class="token constant">ZERO</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">processDeliveryPrice</span><span class="token punctuation">(</span><span class="token keyword">long</span> userId<span class="token punctuation">,</span> <span class="token class-name">Item</span> item<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        item<span class="token punctuation">.</span><span class="token function">setDeliveryPrice</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span><span class="token function">getPrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">multiply</span><span class="token punctuation">(</span><span class="token class-name">BigDecimal</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span><span class="token function">getQuantity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">multiply</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BigDecimal</span><span class="token punctuation">(</span><span class="token string">&quot;0.1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>VIP 用户的购物车 VipUserCart, 直接继承了 NormalUserCart, 只需要修改多买优惠策略:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Service</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;VipUserCart&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">VipUserCart</span> <span class="token keyword">extends</span> <span class="token class-name">NormalUserCart</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">processCouponPrice</span><span class="token punctuation">(</span><span class="token keyword">long</span> userId<span class="token punctuation">,</span> <span class="token class-name">Item</span> item<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>item<span class="token punctuation">.</span><span class="token function">getQuantity</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            item<span class="token punctuation">.</span><span class="token function">setCouponPrice</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span><span class="token function">getPrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">multiply</span><span class="token punctuation">(</span><span class="token class-name">BigDecimal</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span><span class="token number">100</span> <span class="token operator">-</span> <span class="token class-name">Db</span><span class="token punctuation">.</span><span class="token function">getUserCouponPercent</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">divide</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BigDecimal</span><span class="token punctuation">(</span><span class="token string">&quot;100&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">multiply</span><span class="token punctuation">(</span><span class="token class-name">BigDecimal</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span><span class="token function">getQuantity</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            item<span class="token punctuation">.</span><span class="token function">setCouponPrice</span><span class="token punctuation">(</span><span class="token class-name">BigDecimal</span><span class="token punctuation">.</span><span class="token constant">ZERO</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>内部用户购物车 InternalUserCart 是最简单的, 直接设置 0 运费和 0 折扣即可:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Service</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;InternalUserCart&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">InternalUserCart</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractCart</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">processCouponPrice</span><span class="token punctuation">(</span><span class="token keyword">long</span> userId<span class="token punctuation">,</span> <span class="token class-name">Item</span> item<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        item<span class="token punctuation">.</span><span class="token function">setCouponPrice</span><span class="token punctuation">(</span><span class="token class-name">BigDecimal</span><span class="token punctuation">.</span><span class="token constant">ZERO</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">processDeliveryPrice</span><span class="token punctuation">(</span><span class="token keyword">long</span> userId<span class="token punctuation">,</span> <span class="token class-name">Item</span> item<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        item<span class="token punctuation">.</span><span class="token function">setDeliveryPrice</span><span class="token punctuation">(</span><span class="token class-name">BigDecimal</span><span class="token punctuation">.</span><span class="token constant">ZERO</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>抽象类和三个子类的实现关系图, 如下所示:</p> <p><img src="/img/c1d93ad8bf818dcb9365ba4001aff255-20230731165210-gor0zc9.png" alt=""></p> <p>是不是比三个独立的购物车程序简单了很多呢? 接下来再看看如何能避免三个 if 逻辑.</p> <p>或许你已经注意到了, 定义三个购物车子类时, 在 @Service 注解中对 Bean 进行了命名. 既然三个购物车都叫 XXXUserCart, 那就可以把用户类型字符串拼接 UserCart 构成购物车 Bean 的名称, 然后利用 Spring 的 IoC 容器, 通过 Bean 的名称直接获取到 AbstractCart, 调用其 process 方法即可实现通用.</p> <p>其实这就是<strong>工厂模式</strong>, 只不过是借助 Spring 容器实现罢了:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;right&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">Cart</span> <span class="token function">right</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;userId&quot;</span><span class="token punctuation">)</span> <span class="token keyword">int</span> userId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">String</span> userCategory <span class="token operator">=</span> <span class="token class-name">Db</span><span class="token punctuation">.</span><span class="token function">getUserCategory</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">AbstractCart</span> cart <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">AbstractCart</span><span class="token punctuation">)</span> applicationContext<span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span>userCategory <span class="token operator">+</span> <span class="token string">&quot;UserCart&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> cart<span class="token punctuation">.</span><span class="token function">process</span><span class="token punctuation">(</span>userId<span class="token punctuation">,</span> items<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>试想, 之后如果有了新的用户类型, 新的用户逻辑, 是不是完全不用对代码做任何修改, 只要新增一个 XXXUserCart 类继承 AbstractCart, 实现特殊的优惠和运费处理逻辑就可以了?</p> <p><strong>这样一来, 就利用工厂模式 + 模板方法模式, 不仅消除了重复代码, 还避免了修改既有代码的风险</strong>. 这就是设计模式中的开闭原则: <strong>对修改关闭, 对扩展开放</strong>.</p> <h5 id="利用注解-反射消除重复代码"><a href="#利用注解-反射消除重复代码" class="header-anchor">#</a> 利用注解+反射消除重复代码</h5> <p>是不是有点兴奋了, 业务代码居然也能 OOP 了. 再看一个三方接口的调用案例, 同样也是一个普通的业务逻辑.</p> <p>假设银行提供了一些 API 接口, 对参数的序列化有点特殊, 不使用 JSON, 而是需要把参数依次拼在一起构成一个大字符串.</p> <ol><li>按照银行提供的 API 文档的顺序, 把所有参数构成定长的数据, 然后拼接在一起作为整个字符串.</li> <li>因为每一种参数都有固定长度, 未达到长度时需要做填充处理:</li> <li>字符串类型的参数不满长度部分需要以下划线右填充, 也就是字符串内容靠左;</li> <li>数字类型的参数不满长度部分以 0 左填充, 也就是实际数字靠右;</li> <li>货币类型的表示需要把金额向下舍入 2 位到分, 以分为单位, 作为数字类型同样进行左填充.</li> <li>对所有参数做 MD5 操作作为签名(为了方便理解, Demo 中不涉及加盐处理).</li></ol> <p>比如, 创建用户方法和支付方法的定义是这样的:</p> <p><img src="/img/b879c1dbd00356f16789f467ec2f7e49-20230731165210-4q3c21s.png" alt=""></p> <p><img src="/img/12954c1eb4dfaca6fea50637b6e34150-20230731165210-tsh607t.png" alt=""></p> <p>代码很容易实现, 直接根据接口定义实现填充操作, 加签名, 请求调用操作即可:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">BankService</span> <span class="token punctuation">{</span>
    <span class="token comment">// 创建用户方法</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">createUser</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">,</span> <span class="token class-name">String</span> identity<span class="token punctuation">,</span> <span class="token class-name">String</span> mobile<span class="token punctuation">,</span> <span class="token keyword">int</span> age<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        <span class="token class-name">StringBuilder</span> stringBuilder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 字符串靠左, 多余的地方填充_</span>
        stringBuilder<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;%-10s&quot;</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token char">' '</span><span class="token punctuation">,</span> <span class="token char">'_'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 字符串靠左, 多余的地方填充_</span>
        stringBuilder<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;%-18s&quot;</span><span class="token punctuation">,</span> identity<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token char">' '</span><span class="token punctuation">,</span> <span class="token char">'_'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//数字靠右, 多余的地方用0填充</span>
        stringBuilder<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;%05d&quot;</span><span class="token punctuation">,</span> age<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 字符串靠左, 多余的地方用_填充</span>
        stringBuilder<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;%-11s&quot;</span><span class="token punctuation">,</span> mobile<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token char">' '</span><span class="token punctuation">,</span> <span class="token char">'_'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 最后加上MD5作为签名</span>
        stringBuilder<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token class-name">DigestUtils</span><span class="token punctuation">.</span><span class="token function">md2Hex</span><span class="token punctuation">(</span>stringBuilder<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">Request<span class="token punctuation">.</span>Post</span><span class="token punctuation">(</span><span class="token string">&quot;http://localhost:45678/reflection/bank/createUser&quot;</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">bodyString</span><span class="token punctuation">(</span>stringBuilder<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">ContentType</span><span class="token punctuation">.</span><span class="token constant">APPLICATION_JSON</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">returnContent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">asString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  
    <span class="token comment">// 支付方法</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">pay</span><span class="token punctuation">(</span><span class="token keyword">long</span> userId<span class="token punctuation">,</span> <span class="token class-name">BigDecimal</span> amount<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        <span class="token class-name">StringBuilder</span> stringBuilder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 数字靠右, 多余的地方用0填充</span>
        stringBuilder<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;%020d&quot;</span><span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 金额向下舍入2位到分, 以分为单位, 作为数字靠右, 多余的地方用0填充</span>
        stringBuilder<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;%010d&quot;</span><span class="token punctuation">,</span> amount<span class="token punctuation">.</span><span class="token function">setScale</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token class-name">RoundingMode</span><span class="token punctuation">.</span><span class="token constant">DOWN</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">multiply</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BigDecimal</span><span class="token punctuation">(</span><span class="token string">&quot;100&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">longValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 最后加上MD5作为签名</span>
        stringBuilder<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token class-name">DigestUtils</span><span class="token punctuation">.</span><span class="token function">md2Hex</span><span class="token punctuation">(</span>stringBuilder<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">Request<span class="token punctuation">.</span>Post</span><span class="token punctuation">(</span><span class="token string">&quot;http://localhost:45678/reflection/bank/pay&quot;</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">bodyString</span><span class="token punctuation">(</span>stringBuilder<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">ContentType</span><span class="token punctuation">.</span><span class="token constant">APPLICATION_JSON</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">returnContent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">asString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br></div></div><p>可以看到, 这段代码的重复粒度更细:</p> <ol><li>三种标准数据类型的处理逻辑有重复, 稍有不慎就会出现 Bug;</li> <li>处理流程中字符串拼接, 加签和发请求的逻辑, 在所有方法重复;</li> <li>实际方法的入参的参数类型和顺序, 不一定和接口要求一致, 容易出错;</li> <li>代码层面针对每一个参数硬编码, 无法清晰地进行核对, 如果参数达到几十个, 上百个, 出错的概率极大.</li></ol> <p>那应该如何改造这段代码呢? 没错, 就是要用<strong>注解和反射</strong>! 使用注解和反射这两个武器, 就可以针对银行请求的所有逻辑均使用一套代码实现, 不会出现任何重复.</p> <p>要实现接口逻辑和逻辑实现的剥离, 首先需要以 POJO 类(只有属性没有任何业务逻辑的数据类)的方式定义所有的接口参数. 比如下面这个创建用户 API 的参数:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Data</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CreateUserAPI</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> identity<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> mobile<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> age<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>有了<strong>接口参数定义, 就能通过自定义注解为接口和所有参数增加一些元数据</strong>. 如下所示, 定义一个接口 API 的注解 BankAPI, 包含接口 URL 地址和接口说明:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Retention</span><span class="token punctuation">(</span><span class="token class-name">RetentionPolicy</span><span class="token punctuation">.</span><span class="token constant">RUNTIME</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Target</span><span class="token punctuation">(</span><span class="token class-name">ElementType</span><span class="token punctuation">.</span><span class="token constant">TYPE</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Documented</span>
<span class="token annotation punctuation">@Inherited</span>
<span class="token keyword">public</span> <span class="token annotation punctuation">@interface</span> <span class="token class-name">BankAPI</span> <span class="token punctuation">{</span>
    <span class="token class-name">String</span> <span class="token function">desc</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> <span class="token function">url</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>然后再定义一个自定义注解 @BankAPIField, 用于<strong>描述接口的每一个字段规范, 包含参数的次序, 类型和长度</strong>三个属性:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Retention</span><span class="token punctuation">(</span><span class="token class-name">RetentionPolicy</span><span class="token punctuation">.</span><span class="token constant">RUNTIME</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Target</span><span class="token punctuation">(</span><span class="token class-name">ElementType</span><span class="token punctuation">.</span><span class="token constant">FIELD</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Documented</span>
<span class="token annotation punctuation">@Inherited</span>
<span class="token keyword">public</span> <span class="token annotation punctuation">@interface</span> <span class="token class-name">BankAPIField</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> <span class="token function">order</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> <span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> <span class="token function">type</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>接下来, 注解就可以发挥威力了.</p> <p>如下所示, 定义了 CreateUserAPI 类描述<strong>创建用户接口的信息</strong>, 通过为接口增加 @BankAPI 注解, 来补充接口的 URL 和描述等元数据; 通过为每一个字段增加 @BankAPIField 注解, 来补充参数的顺序, 类型和长度等元数据:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@BankAPI</span><span class="token punctuation">(</span>url <span class="token operator">=</span> <span class="token string">&quot;/bank/createUser&quot;</span><span class="token punctuation">,</span> desc <span class="token operator">=</span> <span class="token string">&quot;创建用户接口&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Data</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CreateUserAPI</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractAPI</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@BankAPIField</span><span class="token punctuation">(</span>order <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> type <span class="token operator">=</span> <span class="token string">&quot;S&quot;</span><span class="token punctuation">,</span> length <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@BankAPIField</span><span class="token punctuation">(</span>order <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">,</span> type <span class="token operator">=</span> <span class="token string">&quot;S&quot;</span><span class="token punctuation">,</span> length <span class="token operator">=</span> <span class="token number">18</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> identity<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@BankAPIField</span><span class="token punctuation">(</span>order <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">,</span> type <span class="token operator">=</span> <span class="token string">&quot;S&quot;</span><span class="token punctuation">,</span> length <span class="token operator">=</span> <span class="token number">11</span><span class="token punctuation">)</span> <span class="token comment">// 注意这里的order需要按照API表格中的顺序</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> mobile<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@BankAPIField</span><span class="token punctuation">(</span>order <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">,</span> type <span class="token operator">=</span> <span class="token string">&quot;N&quot;</span><span class="token punctuation">,</span> length <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> age<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>另一个 PayAPI 类也是类似的实现:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@BankAPI</span><span class="token punctuation">(</span>url <span class="token operator">=</span> <span class="token string">&quot;/bank/pay&quot;</span><span class="token punctuation">,</span> desc <span class="token operator">=</span> <span class="token string">&quot;支付接口&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Data</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PayAPI</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractAPI</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@BankAPIField</span><span class="token punctuation">(</span>order <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> type <span class="token operator">=</span> <span class="token string">&quot;N&quot;</span><span class="token punctuation">,</span> length <span class="token operator">=</span> <span class="token number">20</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token keyword">long</span> userId<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@BankAPIField</span><span class="token punctuation">(</span>order <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">,</span> type <span class="token operator">=</span> <span class="token string">&quot;M&quot;</span><span class="token punctuation">,</span> length <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">BigDecimal</span> amount<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>这 2 个类继承的 AbstractAPI 类是一个空实现, 因为这个案例中的接口并没有公共数据可以抽象放到基类.</p> <p>通过这 2 个类, 可以在几秒钟内完成和 API 清单表格的核对. 理论上, 如果核心翻译过程(也就是把注解和接口 API 序列化为请求需要的字符串的过程)没问题, 只要注解和表格一致, API 请求的翻译就不会有任何问题.</p> <p>以上通过注解实现了对 API 参数的描述. 接下来再看看<strong>反射如何配合注解实现动态的接口参数组装</strong>:</p> <ol><li>第 3 行代码中, 从类上获得了 BankAPI 注解, 然后拿到其 URL 属性, 后续进行远程调用.</li> <li>第 6~9 行代码, 使用 stream 快速实现了获取类中所有带 BankAPIField 注解的字段, 并把字段按 order 属性排序, 然后设置私有字段反射可访问.</li> <li>第 12~38 行代码, 实现了反射获取注解的值, 然后根据 BankAPIField 拿到的参数类型, 按照三种标准进行格式化, 将所有参数的格式化逻辑集中在了这一处.</li> <li>第 41~48 行代码, 实现了参数加签和请求调用.</li></ol> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">remoteCall</span><span class="token punctuation">(</span><span class="token class-name">AbstractAPI</span> api<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
    <span class="token comment">// 从BankAPI注解获取请求地址</span>
    <span class="token class-name">BankAPI</span> bankAPI <span class="token operator">=</span> api<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAnnotation</span><span class="token punctuation">(</span><span class="token class-name">BankAPI</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    bankAPI<span class="token punctuation">.</span><span class="token function">url</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">StringBuilder</span> stringBuilder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span>api<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDeclaredFields</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 获得所有字段</span>
            <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>field <span class="token operator">-&gt;</span> field<span class="token punctuation">.</span><span class="token function">isAnnotationPresent</span><span class="token punctuation">(</span><span class="token class-name">BankAPIField</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 查找标记了注解的字段</span>
            <span class="token punctuation">.</span><span class="token function">sorted</span><span class="token punctuation">(</span><span class="token class-name">Comparator</span><span class="token punctuation">.</span><span class="token function">comparingInt</span><span class="token punctuation">(</span>a <span class="token operator">-&gt;</span> a<span class="token punctuation">.</span><span class="token function">getAnnotation</span><span class="token punctuation">(</span><span class="token class-name">BankAPIField</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">order</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">//根据注解中的order对字段排序</span>
            <span class="token punctuation">.</span><span class="token function">peek</span><span class="token punctuation">(</span>field <span class="token operator">-&gt;</span> field<span class="token punctuation">.</span><span class="token function">setAccessible</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 设置可以访问私有字段</span>
            <span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>field <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
                <span class="token comment">// 获得注解</span>
                <span class="token class-name">BankAPIField</span> bankAPIField <span class="token operator">=</span> field<span class="token punctuation">.</span><span class="token function">getAnnotation</span><span class="token punctuation">(</span><span class="token class-name">BankAPIField</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">Object</span> value <span class="token operator">=</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token comment">// 反射获取字段值</span>
                    value <span class="token operator">=</span> field<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>api<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IllegalAccessException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment">// 根据字段类型以正确的填充方式格式化字符串</span>
                <span class="token keyword">switch</span> <span class="token punctuation">(</span>bankAPIField<span class="token punctuation">.</span><span class="token function">type</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">case</span> <span class="token string">&quot;S&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                        stringBuilder<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;%-&quot;</span> <span class="token operator">+</span> bankAPIField<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;s&quot;</span><span class="token punctuation">,</span> value<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token char">' '</span><span class="token punctuation">,</span> <span class="token char">'_'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">case</span> <span class="token string">&quot;N&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                        stringBuilder<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;%&quot;</span> <span class="token operator">+</span> bankAPIField<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;s&quot;</span><span class="token punctuation">,</span> value<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token char">' '</span><span class="token punctuation">,</span> <span class="token char">'0'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">case</span> <span class="token string">&quot;M&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>value <span class="token keyword">instanceof</span> <span class="token class-name">BigDecimal</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;{} 的 {} 必须是BigDecimal&quot;</span><span class="token punctuation">,</span> api<span class="token punctuation">,</span> field<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        stringBuilder<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;%0&quot;</span> <span class="token operator">+</span> bankAPIField<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;d&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">BigDecimal</span><span class="token punctuation">)</span> value<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setScale</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token class-name">RoundingMode</span><span class="token punctuation">.</span><span class="token constant">DOWN</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">multiply</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BigDecimal</span><span class="token punctuation">(</span><span class="token string">&quot;100&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">longValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">default</span><span class="token operator">:</span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 签名逻辑</span>
    stringBuilder<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token class-name">DigestUtils</span><span class="token punctuation">.</span><span class="token function">md2Hex</span><span class="token punctuation">(</span>stringBuilder<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> param <span class="token operator">=</span> stringBuilder<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">long</span> begin <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 发请求</span>
    <span class="token class-name">String</span> result <span class="token operator">=</span> <span class="token class-name">Request<span class="token punctuation">.</span>Post</span><span class="token punctuation">(</span><span class="token string">&quot;http://localhost:45678/reflection&quot;</span> <span class="token operator">+</span> bankAPI<span class="token punctuation">.</span><span class="token function">url</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">bodyString</span><span class="token punctuation">(</span>param<span class="token punctuation">,</span> <span class="token class-name">ContentType</span><span class="token punctuation">.</span><span class="token constant">APPLICATION_JSON</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">returnContent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">asString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;调用银行API {} url:{} 参数:{} 耗时:{}ms&quot;</span><span class="token punctuation">,</span> bankAPI<span class="token punctuation">.</span><span class="token function">desc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> bankAPI<span class="token punctuation">.</span><span class="token function">url</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> param<span class="token punctuation">,</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> begin<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br></div></div><p>可以看到, <strong>所有处理参数排序, 填充, 加签, 请求调用的核心逻辑, 都汇聚在了 remoteCall 方法中</strong>. 有了这个核心方法, BankService 中每一个接口的实现就非常简单了, 只是参数的组装, 然后调用 remoteCall 即可.</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// 创建用户方法</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">createUser</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">,</span> <span class="token class-name">String</span> identity<span class="token punctuation">,</span> <span class="token class-name">String</span> mobile<span class="token punctuation">,</span> <span class="token keyword">int</span> age<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
    <span class="token class-name">CreateUserAPI</span> createUserAPI <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CreateUserAPI</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    createUserAPI<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    createUserAPI<span class="token punctuation">.</span><span class="token function">setIdentity</span><span class="token punctuation">(</span>identity<span class="token punctuation">)</span><span class="token punctuation">;</span>
    createUserAPI<span class="token punctuation">.</span><span class="token function">setAge</span><span class="token punctuation">(</span>age<span class="token punctuation">)</span><span class="token punctuation">;</span>
    createUserAPI<span class="token punctuation">.</span><span class="token function">setMobile</span><span class="token punctuation">(</span>mobile<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">remoteCall</span><span class="token punctuation">(</span>createUserAPI<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 支付方法</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">pay</span><span class="token punctuation">(</span><span class="token keyword">long</span> userId<span class="token punctuation">,</span> <span class="token class-name">BigDecimal</span> amount<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
    <span class="token class-name">PayAPI</span> payAPI <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PayAPI</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    payAPI<span class="token punctuation">.</span><span class="token function">setUserId</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    payAPI<span class="token punctuation">.</span><span class="token function">setAmount</span><span class="token punctuation">(</span>amount<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">remoteCall</span><span class="token punctuation">(</span>payAPI<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>其实, <strong>许多涉及类结构性的通用处理, 都可以按照这个模式来减少重复代码</strong>. 反射给予了我们在不知晓类结构的时候, <strong>按照固定的逻辑处理类的成员</strong>; 而注解给了我们为这些成员补充元数据的能力, 使得利用反射实现通用逻辑的时候, 可以从外部获得更多我们关心的数据.</p> <h5 id="利用属性拷贝工具消除重复代码"><a href="#利用属性拷贝工具消除重复代码" class="header-anchor">#</a> 利用属性拷贝工具消除重复代码</h5> <p>最后再来看一种业务代码中经常出现的代码逻辑, <strong>实体之间的转换复制</strong>.</p> <p>对于三层架构的系统, 考虑到层之间的解耦隔离以及每一层对数据的不同需求, 通常每一层都会有自己的 POJO 作为数据实体. 比如, 数据访问层的实体一般叫作 DataObject 或 DO, 业务逻辑层的实体一般叫作 Domain, 表现层的实体一般叫作 Data Transfer Object 或 DTO. 这里需要注意的是, <strong>如果手动写这些实体之间的赋值代码, 同样容易出错</strong>.</p> <p>对于复杂的业务系统, 实体有几十甚至几百个属性也很正常. 就比如 ComplicatedOrderDTO 这个数据传输对象, 描述的是一个订单中的几十个属性. 如果要把这个 DTO 转换为一个类似的 DO, 复制其中大部分的字段, 然后把数据入库, 势必需要进行很多属性映射赋值操作. 就像这样, 密密麻麻的代码是不是已经让你头晕了?</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">ComplicatedOrderDTO</span> orderDTO <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ComplicatedOrderDTO</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">ComplicatedOrderDO</span> orderDO <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ComplicatedOrderDO</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
orderDO<span class="token punctuation">.</span><span class="token function">setAcceptDate</span><span class="token punctuation">(</span>orderDTO<span class="token punctuation">.</span><span class="token function">getAcceptDate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
orderDO<span class="token punctuation">.</span><span class="token function">setCancelable</span><span class="token punctuation">(</span>orderDTO<span class="token punctuation">.</span><span class="token function">isCancelable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
orderDO<span class="token punctuation">.</span><span class="token function">setCommentable</span><span class="token punctuation">(</span>orderDTO<span class="token punctuation">.</span><span class="token function">isComplainable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 属性错误</span>
orderDO<span class="token punctuation">.</span><span class="token function">setComplainable</span><span class="token punctuation">(</span>orderDTO<span class="token punctuation">.</span><span class="token function">isCommentable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 属性错误</span>
orderDO<span class="token punctuation">.</span><span class="token function">setCancelable</span><span class="token punctuation">(</span>orderDTO<span class="token punctuation">.</span><span class="token function">isCancelable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
orderDO<span class="token punctuation">.</span><span class="token function">setDeliveryManId</span><span class="token punctuation">(</span>orderDTO<span class="token punctuation">.</span><span class="token function">getDeliveryManId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
orderDO<span class="token punctuation">.</span><span class="token function">setDeliveryManMobile</span><span class="token punctuation">(</span>orderDO<span class="token punctuation">.</span><span class="token function">getDeliveryManMobile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 对象错误</span>
orderDO<span class="token punctuation">.</span><span class="token function">setDeliveryManName</span><span class="token punctuation">(</span>orderDTO<span class="token punctuation">.</span><span class="token function">getDeliveryManName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
orderDO<span class="token punctuation">.</span><span class="token function">setLongitude</span><span class="token punctuation">(</span>orderDTO<span class="token punctuation">.</span><span class="token function">getLongitude</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
orderDO<span class="token punctuation">.</span><span class="token function">setLatitude</span><span class="token punctuation">(</span>orderDTO<span class="token punctuation">.</span><span class="token function">getLongitude</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 属性赋值错误</span>
orderDO<span class="token punctuation">.</span><span class="token function">setMerchantAddress</span><span class="token punctuation">(</span>orderDTO<span class="token punctuation">.</span><span class="token function">getMerchantAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
orderDO<span class="token punctuation">.</span><span class="token function">setMerchantHeadPic</span><span class="token punctuation">(</span>orderDTO<span class="token punctuation">.</span><span class="token function">getMerchantHeadPic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
orderDO<span class="token punctuation">.</span><span class="token function">setUid</span><span class="token punctuation">(</span>orderDTO<span class="token punctuation">.</span><span class="token function">getUid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p><strong>如果不是代码中有注释, 你能看出其中的诸多问题吗</strong>?</p> <ol><li>如果原始的 DTO 有 100 个字段, 需要复制 90 个字段到 DO 中, 保留 10 个不赋值, 最后应该如何校验正确性呢? 数数吗? 即使数出有 90 行代码, 也不一定正确, 因为属性可能重复赋值.</li> <li>有的时候字段命名相近, 比如 complainable 和 commentable, 容易搞反(第 7 和第 8 行), 或者对两个目标字段重复赋值相同的来源字段(比如第 28 行)</li> <li>明明要把 DTO 的值赋值到 DO 中, 却在 set 的时候从 DO 自己取值(比如第 20 行), 导致赋值无效.</li></ol> <p>这段代码并不是我随手写出来的, 而是一个真实案例. 有位同学就像代码中那样把经纬度赋值反了, 因为落库的字段实在太多了. 这个 Bug 很久都没发现, 直到真正用到数据库中的经纬度做计算时, 才发现一直以来都存错了.</p> <p>修改方法很简单, 可以<strong>使用类似 BeanUtils 这种 Mapping 工具来做 Bean 的转换, copyProperties 方法还允许提供需要忽略的属性</strong>:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">ComplicatedOrderDTO</span> orderDTO <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ComplicatedOrderDTO</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">ComplicatedOrderDO</span> orderDO <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ComplicatedOrderDO</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">BeanUtils</span><span class="token punctuation">.</span><span class="token function">copyProperties</span><span class="token punctuation">(</span>orderDTO<span class="token punctuation">,</span> orderDO<span class="token punctuation">,</span> <span class="token string">&quot;id&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">return</span> orderDO<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h5 id="重点回顾-21"><a href="#重点回顾-21" class="header-anchor">#</a> 重点回顾</h5> <p>重复代码多了总有一天会出错. 今天从几个最常见的维度, 分享了几个实际业务场景中可能出现的重复问题, 以及消除重复的方式.</p> <p>第一种代码重复是, 有多个并行的类实现相似的代码逻辑. <strong>可以考虑提取相同逻辑在父类中实现, 差异逻辑通过抽象方法留给子类实现. 使用类似的模板方法把相同的流程和逻辑固定成模板, 保留差异的同时尽可能避免代码重复</strong>. 同时, 可以使用 Spring 的 IoC 特性注入相应的子类, 来避免实例化子类时的大量 if...else 代码.</p> <p>第二种代码重复是, 使用硬编码的方式重复实现相同的数据处理算法. 可以考虑把规则转换为自定义注解, 作为元数据对类或对字段, 方法进行描述, 然后通过反射动态读取这些元数据, 字段或调用方法, 实现规则参数和规则定义的分离. 也就是说, 把变化的部分也就是规则的参数放入注解, 规则的定义统一处理.</p> <p>第三种代码重复是, 业务代码中常见的 DO, DTO, VO 转换时大量字段的手动赋值, 遇到有上百个属性的复杂类型, 非常非常容易出错. 建议是, 不要手动进行赋值, 考虑使用 Bean 映射工具进行. 此外, 还可以考虑采用单元测试对所有字段进行赋值正确性校验.</p> <p>最后想说的是, 我会把代码重复度作为评估一个项目质量的重要指标, 如果一个项目几乎没有任何重复代码, 那么它内部的抽象一定是非常好的. 在做项目重构的时候, 也可以以消除重复为第一目标去考虑实现.</p> <h4 id="_22-接口设计-系统间对话的语言-一定要统一"><a href="#_22-接口设计-系统间对话的语言-一定要统一" class="header-anchor">#</a> 22-接口设计:系统间对话的语言,一定要统一</h4> <p>今天要分享的主题是, 在做接口设计时<strong>一定要确保系统之间对话的语言是统一</strong>的.</p> <p>开发一个服务的第一步就是设计接口. 接口的设计需要考虑的点非常多, 比如接口的命名, 参数列表, 包装结构体, 接口粒度, 版本策略, 幂等性实现, 同步异步处理方式等.</p> <p>这其中, 和接口设计相关比较重要的点有三个, 分别是<strong>包装结构体, 版本策略, 同步异步处理</strong>方式. 今天就通过我遇到的实际案例, 一起看看因为接口设计思路和调用方理解不一致所导致的问题, 以及相关的实践经验.</p> <h5 id="接口的响应要明确表示接口的处理结果"><a href="#接口的响应要明确表示接口的处理结果" class="header-anchor">#</a> 接口的响应要明确表示接口的处理结果</h5> <p>我曾遇到过一个处理收单的收单中心项目, 下单接口返回的响应体中, 包含了 success, code, info, message 等属性, 以及二级嵌套对象 data 结构体. 在对项目进行重构的时候发现真的是无从入手, 接口缺少文档, 代码一有改动就出错.</p> <p>有时候, 下单操作的响应结果是这样的: success 是 true, message 是 OK, 貌似代表下单成功了; 但 info 里却提示订单存在风险, code 是一个 5001 的错误码, data 中能看到订单状态是 Cancelled, 订单 ID 是 -1, 好像又说明没有下单成功.</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token punctuation">{</span>
  <span class="token string">&quot;success&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token string">&quot;code&quot;</span><span class="token operator">:</span> <span class="token number">5001</span><span class="token punctuation">,</span>
  <span class="token string">&quot;info&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Risk order detected&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;message&quot;</span><span class="token operator">:</span> <span class="token string">&quot;OK&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;data&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;orderStatus&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Cancelled&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;orderId&quot;</span><span class="token operator">:</span> <span class="token operator">-</span><span class="token number">1</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>有些时候, 这个下单接口又会返回这样的结果: success 是 false, message 提示非法用户 ID, 看上去下单失败; 但 data 里的 orderStatus 是 Created, info 是空, code 是 0. 那这次下单到底是成功还是失败呢?</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token punctuation">{</span>
  <span class="token string">&quot;success&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  <span class="token string">&quot;code&quot;</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
  <span class="token string">&quot;info&quot;</span><span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;message&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Illegal userId&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;data&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;orderStatus&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Created&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;orderId&quot;</span><span class="token operator">:</span> <span class="token number">0</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>这样的结果, 让人非常疑惑:</p> <ol><li>结构体的 code 和 HTTP 响应状态码, 是什么关系?</li> <li>success 到底代表下单成功还是失败?</li> <li>info 和 message 的区别是什么?</li> <li>data 中永远都有数据吗? 什么时候应该去查询 data?</li></ol> <p>造成如此混乱的原因是: 这个收单服务本身并不真正处理下单操作, 只是做一些预校验和预处理; 真正的下单操作, 需要在收单服务内部调用另一个订单服务来处理; 订单服务处理完成后, 会返回订单状态和 ID.</p> <p>在一切正常的情况下, 下单后的订单状态就是已创建 Created, 订单 ID 是一个大于 0 的数字. 而结构体中的 message 和 success, 其实是收单服务的处理异常信息和处理成功与否的结果, code, info 是调用订单服务的结果.</p> <p>对于第一次调用, 收单服务自己没问题, success 是 true, message 是 OK, 但调用订单服务时却因为订单风险问题被拒绝, 所以 code 是 5001, info 是 Risk order detected, data 中的信息是订单服务返回的, 所以最终订单状态是 Cancelled.</p> <p>对于第二次调用, 因为用户 ID 非法, 所以收单服务在校验了参数后直接就返回了 success 是 false, message 是 Illegal userId. 因为请求没有到订单服务, 所以 info, code, data 都是默认值, 订单状态的默认值是 Created. 因此第二次下单肯定失败了, 但订单状态却是已创建.</p> <p>可以看到, 如此混乱的接口定义和实现方式, 是无法让调用者分清到底应该怎么处理的. <strong>为了将接口设计得更合理, 需要考虑如下两个原则:</strong></p> <ol><li><strong>对外隐藏内部实现</strong>. 虽然说收单服务调用订单服务进行真正的下单操作, 但是直接接口其实是收单服务提供的, 收单服务不应该 &quot;直接&quot; 暴露其背后订单服务的状态码, 错误描述.</li> <li><strong>设计接口结构时, 明确每个字段的含义, 以及客户端的处理方式</strong>.</li></ol> <p>基于这两个原则, 调整一下返回结构体, 去掉外层的 info, 即<strong>不再把订单服务的调用结果告知客户端</strong>:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Data</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">APIResponse</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">boolean</span> success<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">T</span> data<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> code<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> message<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>并明确接口的设计逻辑:</p> <ol><li>如果出现非 200 的 HTTP 响应状态码, 就代表请求没有到收单服务, 可能是网络出问题, 网络超时, 或者网络配置的问题. 这时肯定无法拿到服务端的响应体, 客户端可以给予友好提示, 比如让用户重试, 不需要继续解析响应结构体.</li> <li>如果 HTTP 响应码是 200, 解析响应体查看 success, 为 false 代表下单请求处理失败, 可能是因为收单服务参数验证错误, 也可能是因为订单服务下单操作失败. 这时根据收单服务定义的错误码表和 code, 做不同处理. 比如友好提示, 或是让用户重新填写相关信息, 其中友好提示的文字内容可以从 message 中获取.</li> <li><strong>success 为 true 的情况下, 才需要继续解析响应体中的 data 结构体</strong>. data 结构体代表了业务数据, 通常会有下面两种情况. 通常情况下, success 为 true 时订单状态是 Created, 获取 orderId 属性可以拿到订单号. 特殊情况下, 比如收单服务内部处理不当, 或是订单服务出现了额外的状态, 虽然 success 为 true, 但订单实际状态不是 Created, 这时可以给予友好的错误提示.</li></ol> <p><img src="/img/a57c93bc57d2c80e1a48752a716021e8-20230731165210-2ky7dp5.png" alt=""></p> <p>明确了接口的设计逻辑, 就可以实现收单服务的服务端和客户端来模拟这些情况了.</p> <p>首先, 实现服务端的逻辑:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;server&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">APIResponse</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">OrderInfo</span><span class="token punctuation">&gt;</span></span> <span class="token function">server</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;userId&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Long</span> userId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">APIResponse</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">OrderInfo</span><span class="token punctuation">&gt;</span></span> response <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">APIResponse</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>userId <span class="token generics"><span class="token punctuation">&lt;</span>mark<span class="token punctuation">&gt;</span></span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 对于userId为空的情况, 收单服务直接处理失败, 给予相应的错误码和错误提示</span>
        response<span class="token punctuation">.</span><span class="token function">setSuccess</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        response<span class="token punctuation">.</span><span class="token function">setCode</span><span class="token punctuation">(</span><span class="token number">3001</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        response<span class="token punctuation">.</span><span class="token function">setMessage</span><span class="token punctuation">(</span><span class="token string">&quot;Illegal userId&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>userId <span class="token operator">&lt;</span><span class="token operator">/</span>mark<span class="token operator">&gt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 对于userId=1的用户, 模拟订单服务对于风险用户的情况</span>
        response<span class="token punctuation">.</span><span class="token function">setSuccess</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 把订单服务返回的错误码转换为收单服务错误码</span>
        response<span class="token punctuation">.</span><span class="token function">setCode</span><span class="token punctuation">(</span><span class="token number">3002</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        response<span class="token punctuation">.</span><span class="token function">setMessage</span><span class="token punctuation">(</span><span class="token string">&quot;Internal Error, order is cancelled&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 同时日志记录内部错误</span>
        log<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;用户 {} 调用订单服务失败, 原因是 Risk order detected&quot;</span><span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// 其他用户, 下单成功</span>
        response<span class="token punctuation">.</span><span class="token function">setSuccess</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        response<span class="token punctuation">.</span><span class="token function">setCode</span><span class="token punctuation">(</span><span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        response<span class="token punctuation">.</span><span class="token function">setMessage</span><span class="token punctuation">(</span><span class="token string">&quot;OK&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        response<span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">OrderInfo</span><span class="token punctuation">(</span><span class="token string">&quot;Created&quot;</span><span class="token punctuation">,</span> <span class="token number">2L</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> response<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><p>客户端代码, 则可以按照流程图上的逻辑来实现, 同样模拟三种出错情况和正常下单的情况:</p> <p>客户端的实现代码如下:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;client&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">client</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;error&quot;</span><span class="token punctuation">,</span> defaultValue <span class="token operator">=</span> <span class="token string">&quot;0&quot;</span><span class="token punctuation">)</span> <span class="token keyword">int</span> error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token class-name">String</span> url <span class="token operator">=</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span><span class="token string">&quot;http://localhost:45678/apiresposne/server?userId=2&quot;</span><span class="token punctuation">,</span>
        <span class="token string">&quot;http://localhost:45678/apiresposne/server2&quot;</span><span class="token punctuation">,</span>
        <span class="token string">&quot;http://localhost:45678/apiresposne/server?userId=&quot;</span><span class="token punctuation">,</span>
        <span class="token string">&quot;http://localhost:45678/apiresposne/server?userId=1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 第一层, 先看状态码, 如果状态码不是200, 不处理响应体</span>
    <span class="token class-name">String</span> response <span class="token operator">=</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        response <span class="token operator">=</span> <span class="token class-name">Request<span class="token punctuation">.</span>Get</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">returnContent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">asString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">HttpResponseException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;请求服务端出现返回非200&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token string">&quot;服务器忙, 请稍后再试! &quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 状态码为200的情况下处理响应体</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>response<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">APIResponse</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">OrderInfo</span><span class="token punctuation">&gt;</span></span> apiResponse <span class="token operator">=</span> objectMapper<span class="token punctuation">.</span><span class="token function">readValue</span><span class="token punctuation">(</span>response<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">TypeReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">APIResponse</span><span class="token punctuation">&lt;</span><span class="token class-name">OrderInfo</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 第二层, success是false直接提示用户</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>apiResponse<span class="token punctuation">.</span><span class="token function">isSuccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;创建订单失败, 请稍后再试, 错误代码:  %s 错误原因: %s&quot;</span><span class="token punctuation">,</span> apiResponse<span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> apiResponse<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment">// 第三层, 往下解析OrderInfo</span>
                <span class="token class-name">OrderInfo</span> orderInfo <span class="token operator">=</span> apiResponse<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">&quot;Created&quot;</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>orderInfo<span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token keyword">return</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;创建订单成功, 订单号是: %s, 状态是: %s&quot;</span><span class="token punctuation">,</span> orderInfo<span class="token punctuation">.</span><span class="token function">getOrderId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> orderInfo<span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">else</span>
                    <span class="token keyword">return</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;创建订单失败, 请联系客服处理&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">JsonProcessingException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br></div></div><p><strong>相比原来混乱的接口定义和处理逻辑, 改造后的代码, 明确了接口每一个字段的含义, 以及对于各种情况服务端的输出和客户端的处理步骤, 对齐了客户端和服务端的处理逻辑</strong>. 那么现在, 你能回答前面那 4 个让人疑惑的问题了吗?</p> <p>最后分享一个小技巧. 为了简化服务端代码, 可以<strong>把包装 API 响应体 APIResponse 的工作交由框架自动完成</strong>, 这样直接返回 DTO OrderInfo 即可. 对于业务逻辑错误, 可以抛出一个自定义异常:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;server&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">OrderInfo</span> <span class="token function">server</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;userId&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Long</span> userId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>userId <span class="token generics"><span class="token punctuation">&lt;</span>mark<span class="token punctuation">&gt;</span></span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">APIException</span><span class="token punctuation">(</span><span class="token number">3001</span><span class="token punctuation">,</span> <span class="token string">&quot;Illegal userId&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>userId <span class="token operator">&lt;</span><span class="token operator">/</span>mark<span class="token operator">&gt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token comment">// 直接抛出异常</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">APIException</span><span class="token punctuation">(</span><span class="token number">3002</span><span class="token punctuation">,</span> <span class="token string">&quot;Internal Error, order is cancelled&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 直接返回DTO</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">OrderInfo</span><span class="token punctuation">(</span><span class="token string">&quot;Created&quot;</span><span class="token punctuation">,</span> <span class="token number">2L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>在 APIException 中包含错误码和错误消息:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">APIException</span> <span class="token keyword">extends</span> <span class="token class-name">RuntimeException</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Getter</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> errorCode<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Getter</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> errorMessage<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">APIException</span><span class="token punctuation">(</span><span class="token keyword">int</span> errorCode<span class="token punctuation">,</span> <span class="token class-name">String</span> errorMessage<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span>errorMessage<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>errorCode <span class="token operator">=</span> errorCode<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>errorMessage <span class="token operator">=</span> errorMessage<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">APIException</span><span class="token punctuation">(</span><span class="token class-name">Throwable</span> cause<span class="token punctuation">,</span> <span class="token keyword">int</span> errorCode<span class="token punctuation">,</span> <span class="token class-name">String</span> errorMessage<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span>errorMessage<span class="token punctuation">,</span> cause<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>errorCode <span class="token operator">=</span> errorCode<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>errorMessage <span class="token operator">=</span> errorMessage<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p>然后, 定义一个  <strong>@RestControllerAdvice 来完成自动包装响应体的工作</strong>:</p> <p>通过实现 ResponseBodyAdvice 接口的 beforeBodyWrite 方法, 来处理成功请求的响应体转换.</p> <p>实现一个 @ExceptionHandler 来处理业务异常时, APIException 到 APIResponse 的转换.</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// 此段代码只是Demo, 生产级应用还需要扩展很多细节</span>
<span class="token annotation punctuation">@RestControllerAdvice</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">APIResponseAdvice</span> <span class="token keyword">implements</span> <span class="token class-name">ResponseBodyAdvice</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
    <span class="token comment">// 自动处理APIException, 包装为APIResponse</span>
    <span class="token annotation punctuation">@ExceptionHandler</span><span class="token punctuation">(</span><span class="token class-name">APIException</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">APIResponse</span> <span class="token function">handleApiException</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">APIException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;process url {} failed&quot;</span><span class="token punctuation">,</span> request<span class="token punctuation">.</span><span class="token function">getRequestURL</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">APIResponse</span> apiResponse <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">APIResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        apiResponse<span class="token punctuation">.</span><span class="token function">setSuccess</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        apiResponse<span class="token punctuation">.</span><span class="token function">setCode</span><span class="token punctuation">(</span>ex<span class="token punctuation">.</span><span class="token function">getErrorCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        apiResponse<span class="token punctuation">.</span><span class="token function">setMessage</span><span class="token punctuation">(</span>ex<span class="token punctuation">.</span><span class="token function">getErrorMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> apiResponse<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 仅当方法或类没有标记@NoAPIResponse才自动包装</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">supports</span><span class="token punctuation">(</span><span class="token class-name">MethodParameter</span> returnType<span class="token punctuation">,</span> <span class="token class-name">Class</span> converterType<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> returnType<span class="token punctuation">.</span><span class="token function">getParameterType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token class-name">APIResponse</span><span class="token punctuation">.</span><span class="token keyword">class</span>
                <span class="token operator">&amp;&amp;</span> <span class="token class-name">AnnotationUtils</span><span class="token punctuation">.</span><span class="token function">findAnnotation</span><span class="token punctuation">(</span>returnType<span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">NoAPIResponse</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token generics"><span class="token punctuation">&lt;</span>mark<span class="token punctuation">&gt;</span></span> <span class="token keyword">null</span>
                <span class="token operator">&amp;&amp;</span> <span class="token class-name">AnnotationUtils</span><span class="token punctuation">.</span><span class="token function">findAnnotation</span><span class="token punctuation">(</span>returnType<span class="token punctuation">.</span><span class="token function">getDeclaringClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">NoAPIResponse</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span><span class="token operator">/</span>mark<span class="token operator">&gt;</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> 

    <span class="token comment">// 自动包装外层APIResposne响应</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">beforeBodyWrite</span><span class="token punctuation">(</span><span class="token class-name">Object</span> body<span class="token punctuation">,</span> <span class="token class-name">MethodParameter</span> returnType<span class="token punctuation">,</span> <span class="token class-name">MediaType</span> selectedContentType<span class="token punctuation">,</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">HttpMessageConverter</span><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> selectedConverterType<span class="token punctuation">,</span> <span class="token class-name">ServerHttpRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">ServerHttpResponse</span> response<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">APIResponse</span> apiResponse <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">APIResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        apiResponse<span class="token punctuation">.</span><span class="token function">setSuccess</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        apiResponse<span class="token punctuation">.</span><span class="token function">setMessage</span><span class="token punctuation">(</span><span class="token string">&quot;OK&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        apiResponse<span class="token punctuation">.</span><span class="token function">setCode</span><span class="token punctuation">(</span><span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        apiResponse<span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span>body<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> apiResponse<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br></div></div><p>在这里实现了一个 @NoAPIResponse 自定义注解. 如果某些 @RestController 的接口不希望实现自动包装的话, 可以标记这个注解:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Target</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token class-name">ElementType</span><span class="token punctuation">.</span><span class="token constant">METHOD</span><span class="token punctuation">,</span> <span class="token class-name">ElementType</span><span class="token punctuation">.</span><span class="token constant">TYPE</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Retention</span><span class="token punctuation">(</span><span class="token class-name">RetentionPolicy</span><span class="token punctuation">.</span><span class="token constant">RUNTIME</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token annotation punctuation">@interface</span> <span class="token class-name">NoAPIResponse</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>在 ResponseBodyAdvice 的 support 方法中, 排除了标记有这个注解的方法或类的自动响应体包装. 比如, 对于刚才实现的测试客户端 client 方法不需要包装为 APIResponse, 就可以标记上这个注解:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;client&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@NoAPIResponse</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">client</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;error&quot;</span><span class="token punctuation">,</span> defaultValue <span class="token operator">=</span> <span class="token string">&quot;0&quot;</span><span class="token punctuation">)</span> <span class="token keyword">int</span> error<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>这样业务逻辑中就不需要考虑响应体的包装, 代码会更简洁.</p> <h5 id="要考虑接口变迁的版本控制策略"><a href="#要考虑接口变迁的版本控制策略" class="header-anchor">#</a> 要考虑接口变迁的版本控制策略</h5> <p>接口不可能一成不变, 需要根据业务需求不断增加内部逻辑. 如果做大的功能调整或重构, 涉及参数定义的变化或是参数废弃, 导致接口无法向前兼容, 这时接口就需要有版本的概念. <strong>在考虑接口版本策略设计时, 需要注意的是, 最好一开始就明确版本策略, 并考虑在整个服务端统一版本策略</strong>.</p> <p>**第一, 版本策略最好一开始就考虑. **</p> <p>既然接口总是要变迁的, 那么最好一开始就确定版本策略. 比如, 确定是通过 URL Path 实现, 是通过 QueryString 实现, 还是通过 HTTP 头实现. 这三种实现方式的代码如下:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// 通过URL Path实现版本控制</span>
<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/v1/api/user&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">right1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 通过QueryString中的version参数实现版本控制</span>
<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;/api/user&quot;</span><span class="token punctuation">,</span> params <span class="token operator">=</span> <span class="token string">&quot;version=2&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">right2</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;version&quot;</span><span class="token punctuation">)</span> <span class="token keyword">int</span> version<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token number">2</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 通过请求头中的X-API-VERSION参数实现版本控制</span>
<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;/api/user&quot;</span><span class="token punctuation">,</span> headers <span class="token operator">=</span> <span class="token string">&quot;X-API-VERSION=3&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">right3</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestHeader</span><span class="token punctuation">(</span><span class="token string">&quot;X-API-VERSION&quot;</span><span class="token punctuation">)</span> <span class="token keyword">int</span> version<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token number">3</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>这样客户端就可以<strong>在配置中处理相关版本控制的参数, 有可能实现版本的动态切换</strong>.</p> <p>这三种方式中, URL Path 的方式最直观也最不容易出错; QueryString 不易携带, 不太推荐作为公开 API 的版本策略; HTTP 头的方式比较没有侵入性, 如果仅仅是部分接口需要进行版本控制, 可以考虑这种方式.</p> <p>**第二, 版本实现方式要统一. **</p> <p>之前, 我就遇到过一个 O2O 项目, 需要针对商品, 商店和用户实现 REST 接口. 虽然大家约定通过 URL Path 方式实现 API 版本控制, 但实现方式不统一, 有的是 <code>/api/item/v1</code>​, 有的是 <code>/api/v1/shop</code>​, 还有的是 <code>/v1/api/merchant</code>​:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/api/item/v1&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">wrong1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/api/v1/shop&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">wrong2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/v1/api/merchant&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">wrong3</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>显然, 商品, 商店和商户的接口开发同学, 没有按照一致的 URL 格式来实现接口的版本控制. 更要命的是, 还可能开发出两个 URL 类似接口, 比如一个是 <code>/api/v1/user</code>​, 另一个是 <code>/api/user/v1</code>​, 这到底是一个接口还是两个接口呢?</p> <p>相比于在每一个接口的 URL Path 中设置版本号, <strong>更理想的方式是在框架层面实现统一</strong>. 如果使用 Spring 框架的话, 可以按照下面的方式自定义 RequestMappingHandlerMapping 来实现.</p> <p>首先, 创建一个注解来定义接口的版本. @APIVersion 自定义注解可以应用于方法或 Controller 上:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Target</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token class-name">ElementType</span><span class="token punctuation">.</span><span class="token constant">METHOD</span><span class="token punctuation">,</span> <span class="token class-name">ElementType</span><span class="token punctuation">.</span><span class="token constant">TYPE</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Retention</span><span class="token punctuation">(</span><span class="token class-name">RetentionPolicy</span><span class="token punctuation">.</span><span class="token constant">RUNTIME</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token annotation punctuation">@interface</span> <span class="token class-name">APIVersion</span> <span class="token punctuation">{</span>
    <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>然后, 定义一个 <strong>APIVersionHandlerMapping 类继承 RequestMappingHandlerMapping</strong>.</p> <p>RequestMappingHandlerMapping 的作用, 是<strong>根据类或方法上的 @RequestMapping 来生成 RequestMappingInfo 的实例. 我们覆盖 registerHandlerMethod 方法的实现</strong>, 从 @APIVersion 自定义注解中读取版本信息, 拼接上原有的, 不带版本号的 URL Pattern, 构成新的 RequestMappingInfo, 来通过注解的方式为接口增加基于 URL 的版本号:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">APIVersionHandlerMapping</span> <span class="token keyword">extends</span> <span class="token class-name">RequestMappingHandlerMapping</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">boolean</span> <span class="token function">isHandler</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> beanType<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">AnnotatedElementUtils</span><span class="token punctuation">.</span><span class="token function">hasAnnotation</span><span class="token punctuation">(</span>beanType<span class="token punctuation">,</span> <span class="token class-name">Controller</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">registerHandlerMethod</span><span class="token punctuation">(</span><span class="token class-name">Object</span> handler<span class="token punctuation">,</span> <span class="token class-name">Method</span> method<span class="token punctuation">,</span> <span class="token class-name">RequestMappingInfo</span> mapping<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> controllerClass <span class="token operator">=</span> method<span class="token punctuation">.</span><span class="token function">getDeclaringClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 类上的APIVersion注解</span>
        <span class="token class-name">APIVersion</span> apiVersion <span class="token operator">=</span> <span class="token class-name">AnnotationUtils</span><span class="token punctuation">.</span><span class="token function">findAnnotation</span><span class="token punctuation">(</span>controllerClass<span class="token punctuation">,</span> <span class="token class-name">APIVersion</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 方法上的APIVersion注解</span>
        <span class="token class-name">APIVersion</span> methodAnnotation <span class="token operator">=</span> <span class="token class-name">AnnotationUtils</span><span class="token punctuation">.</span><span class="token function">findAnnotation</span><span class="token punctuation">(</span>method<span class="token punctuation">,</span> <span class="token class-name">APIVersion</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 以方法上的注解优先</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>methodAnnotation <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            apiVersion <span class="token operator">=</span> methodAnnotation<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> urlPatterns <span class="token operator">=</span> apiVersion <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">:</span> apiVersion<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   
        <span class="token class-name">PatternsRequestCondition</span> apiPattern <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PatternsRequestCondition</span><span class="token punctuation">(</span>urlPatterns<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">PatternsRequestCondition</span> oldPattern <span class="token operator">=</span> mapping<span class="token punctuation">.</span><span class="token function">getPatternsCondition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">PatternsRequestCondition</span> updatedFinalPattern <span class="token operator">=</span> apiPattern<span class="token punctuation">.</span><span class="token function">combine</span><span class="token punctuation">(</span>oldPattern<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 重新构建RequestMappingInfo</span>
        mapping <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RequestMappingInfo</span><span class="token punctuation">(</span>mapping<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> updatedFinalPattern<span class="token punctuation">,</span> mapping<span class="token punctuation">.</span><span class="token function">getMethodsCondition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                mapping<span class="token punctuation">.</span><span class="token function">getParamsCondition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> mapping<span class="token punctuation">.</span><span class="token function">getHeadersCondition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> mapping<span class="token punctuation">.</span><span class="token function">getConsumesCondition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                mapping<span class="token punctuation">.</span><span class="token function">getProducesCondition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> mapping<span class="token punctuation">.</span><span class="token function">getCustomCondition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">registerHandlerMethod</span><span class="token punctuation">(</span>handler<span class="token punctuation">,</span> method<span class="token punctuation">,</span> mapping<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br></div></div><p>最后, 也是特别容易忽略的一点, 要<strong>通过实现 WebMvcRegistrations 接口</strong>, 来生效自定义的 APIVersionHandlerMapping:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CommonMistakesApplication</span> <span class="token keyword">implements</span> <span class="token class-name">WebMvcRegistrations</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">RequestMappingHandlerMapping</span> <span class="token function">getRequestMappingHandlerMapping</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">APIVersionHandlerMapping</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>这样就实现了<strong>在 Controller 上或接口方法上通过注解, 来实现以统一的 Pattern 进行版本号控制</strong>:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;/api/user&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@APIVersion</span><span class="token punctuation">(</span><span class="token string">&quot;v4&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">right4</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token number">4</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p><strong>使用框架来明确 API 版本的指定策略, 不仅实现了标准化, 更实现了强制的 API 版本控制</strong>. 对上面代码略做修改, 就可以实现不设置 @APIVersion 接口就给予报错提示.</p> <h5 id="接口处理方式要明确同步还是异步"><a href="#接口处理方式要明确同步还是异步" class="header-anchor">#</a> 接口处理方式要明确同步还是异步</h5> <p>看到这个标题, 你可能感觉不太好理解, 直接看一个实际案例.</p> <p>有一个文件上传服务 FileService, 其中一个 upload 文件上传接口特别慢, 原因是这个上传接口在内部需要进行两步操作, 首先上传原图, 然后压缩后上传缩略图. 如果每一步都耗时 5 秒的话, 那么这个接口返回至少需要 10 秒的时间.</p> <p>于是, 开发同学把接口改为了<strong>异步处理</strong>, 每一步操作都限定了超时时间, 也就是分别把上传原文件和上传缩略图的操作提交到线程池, 然后等待一定的时间:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token class-name">ExecutorService</span> threadPool <span class="token operator">=</span> <span class="token class-name">Executors</span><span class="token punctuation">.</span><span class="token function">newFixedThreadPool</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 没有贴出两个文件上传方法uploadFile和uploadThumbnailFile的实现, 它们在内部只是随机进行休眠然后返回文件名, 对于本例来说不是很重要</span>
<span class="token keyword">public</span> <span class="token class-name">UploadResponse</span> <span class="token function">upload</span><span class="token punctuation">(</span><span class="token class-name">UploadRequest</span> request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">UploadResponse</span> response <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UploadResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 上传原始文件任务提交到线程池处理</span>
    <span class="token class-name">Future</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> uploadFile <span class="token operator">=</span> threadPool<span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token function">uploadFile</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 上传缩略图任务提交到线程池处理</span>
    <span class="token class-name">Future</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> uploadThumbnailFile <span class="token operator">=</span> threadPool<span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token function">uploadThumbnailFile</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 等待上传原始文件任务完成, 最多等待1秒</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        response<span class="token punctuation">.</span><span class="token function">setDownloadUrl</span><span class="token punctuation">(</span>uploadFile<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 等待上传缩略图任务完成, 最多等待1秒</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        response<span class="token punctuation">.</span><span class="token function">setThumbnailDownloadUrl</span><span class="token punctuation">(</span>uploadThumbnailFile<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> response<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><p>上传接口的请求和响应比较简单, 传入二进制文件, 传出原文件和缩略图下载地址:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Data</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UploadRequest</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> file<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@Data</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UploadResponse</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> downloadUrl<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> thumbnailDownloadUrl<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>到这里, 你能看出这种实现方式的问题是什么吗?</p> <p>从接口命名上看虽然是同步上传操作, 但其内部通过线程池进行异步上传, 并因为设置了较短超时所以接口整体响应挺快. 但<strong>一旦遇到超时, 接口就不能返回完整的数据, 不是无法拿到原文件下载地址, 就是无法拿到缩略图下载地址, 接口的行为变得不可预测</strong>:</p> <p><img src="/img/142e4ccb3bc9e1842b4878a92ab464ec-20230731165210-uxn8odr.png" alt=""></p> <p>所以, 这种优化接口响应速度的方式并不可取, <strong>更合理的方式是, 让上传接口要么是彻底的同步处理, 要么是彻底的异步处理</strong>:</p> <ol><li>所谓同步处理, 接口一定是同步上传原文件和缩略图的, 调用方可以自己选择调用超时, 如果来得及可以一直等到上传完成, 如果等不及可以结束等待, 下一次再重试;</li> <li>所谓异步处理, 接口是<strong>两段式</strong>的, 上传接口本身只是返回一个任务 ID, 然后异步做上传操作, 上传接口响应很快, 客户端需要之后再拿着任务 ID 调用任务查询接口查询上传的文件 URL.</li></ol> <p>同步上传接口的实现代码如下, 把超时的选择留给客户端:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">SyncUploadResponse</span> <span class="token function">syncUpload</span><span class="token punctuation">(</span><span class="token class-name">SyncUploadRequest</span> request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">SyncUploadResponse</span> response <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SyncUploadResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    response<span class="token punctuation">.</span><span class="token function">setDownloadUrl</span><span class="token punctuation">(</span><span class="token function">uploadFile</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    response<span class="token punctuation">.</span><span class="token function">setThumbnailDownloadUrl</span><span class="token punctuation">(</span><span class="token function">uploadThumbnailFile</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> response<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>这里的 SyncUploadRequest 和 SyncUploadResponse 类, 与之前定义的 UploadRequest 和 UploadResponse 是一致的. <strong>对于接口的入参和出参 DTO 的命名, 比较建议的方式是, 使用接口名 + Request 和 Response 后缀</strong>.</p> <p>接下来看看异步的上传文件接口如何实现. 异步上传接口在出参上有点区别, 不再返回文件 URL, 而是返回一个任务 ID:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Data</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AsyncUploadRequest</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> file<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@Data</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AsyncUploadResponse</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> taskId<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>在接口实现上, 同样把上传任务提交到线程池处理, 但是并不会同步等待任务完成, 而是完成后把结果写入一个 HashMap, 任务查询接口通过查询这个 HashMap 来获得文件的 URL:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// 计数器, 作为上传任务的ID</span>
<span class="token keyword">private</span> <span class="token class-name">AtomicInteger</span> atomicInteger <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicInteger</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 暂存上传操作的结果, 生产代码需要考虑数据持久化</span>
<span class="token keyword">private</span> <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">SyncQueryUploadTaskResponse</span><span class="token punctuation">&gt;</span></span> downloadUrl <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 异步上传操作</span>
<span class="token keyword">public</span> <span class="token class-name">AsyncUploadResponse</span> <span class="token function">asyncUpload</span><span class="token punctuation">(</span><span class="token class-name">AsyncUploadRequest</span> request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">AsyncUploadResponse</span> response <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AsyncUploadResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 生成唯一的上传任务ID</span>
    <span class="token class-name">String</span> taskId <span class="token operator">=</span> <span class="token string">&quot;upload&quot;</span> <span class="token operator">+</span> atomicInteger<span class="token punctuation">.</span><span class="token function">incrementAndGet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 异步上传操作只返回任务ID</span>
    response<span class="token punctuation">.</span><span class="token function">setTaskId</span><span class="token punctuation">(</span>taskId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 提交上传原始文件操作到线程池异步处理</span>
    threadPool<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> url <span class="token operator">=</span> <span class="token function">uploadFile</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 如果ConcurrentHashMap不包含Key, 则初始化一个SyncQueryUploadTaskResponse, 然后设置DownloadUrl</span>
        downloadUrl<span class="token punctuation">.</span><span class="token function">computeIfAbsent</span><span class="token punctuation">(</span>taskId<span class="token punctuation">,</span> id <span class="token operator">-&gt;</span> <span class="token keyword">new</span> <span class="token class-name">SyncQueryUploadTaskResponse</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setDownloadUrl</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 提交上传缩略图操作到线程池异步处理</span>
    threadPool<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> url <span class="token operator">=</span> <span class="token function">uploadThumbnailFile</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        downloadUrl<span class="token punctuation">.</span><span class="token function">computeIfAbsent</span><span class="token punctuation">(</span>taskId<span class="token punctuation">,</span> id <span class="token operator">-&gt;</span> <span class="token keyword">new</span> <span class="token class-name">SyncQueryUploadTaskResponse</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setThumbnailDownloadUrl</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> response<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><p>文件上传查询接口则以任务 ID 作为入参, 返回两个文件的下载地址, 因为文件上传查询接口是同步的, 所以直接命名为 syncQueryUploadTask:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// syncQueryUploadTask接口入参</span>
<span class="token annotation punctuation">@Data</span>
<span class="token annotation punctuation">@RequiredArgsConstructor</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SyncQueryUploadTaskRequest</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">String</span> taskId<span class="token punctuation">;</span><span class="token comment">//使用上传文件任务ID查询上传结果 </span>
<span class="token punctuation">}</span>

<span class="token comment">// syncQueryUploadTask接口出参</span>
<span class="token annotation punctuation">@Data</span>
<span class="token annotation punctuation">@RequiredArgsConstructor</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SyncQueryUploadTaskResponse</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">String</span> taskId<span class="token punctuation">;</span> <span class="token comment">// 任务ID</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> downloadUrl<span class="token punctuation">;</span> <span class="token comment">// 原始文件下载URL</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> thumbnailDownloadUrl<span class="token punctuation">;</span> <span class="token comment">// 缩略图下载URL</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token class-name">SyncQueryUploadTaskResponse</span> <span class="token function">syncQueryUploadTask</span><span class="token punctuation">(</span><span class="token class-name">SyncQueryUploadTaskRequest</span> request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">SyncQueryUploadTaskResponse</span> response <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SyncQueryUploadTaskResponse</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getTaskId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token comment">// 从之前定义的downloadUrl ConcurrentHashMap查询结果</span>
response<span class="token punctuation">.</span><span class="token function">setDownloadUrl</span><span class="token punctuation">(</span>downloadUrl<span class="token punctuation">.</span><span class="token function">getOrDefault</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getTaskId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDownloadUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    response<span class="token punctuation">.</span><span class="token function">setThumbnailDownloadUrl</span><span class="token punctuation">(</span>downloadUrl<span class="token punctuation">.</span><span class="token function">getOrDefault</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getTaskId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getThumbnailDownloadUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> response<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><p>经过改造的 FileService 不再提供一个看起来是同步上传, 内部却是异步上传的 upload 方法, 改为提供很明确的:</p> <ol><li><strong>同步上传接口 syncUpload</strong>;</li> <li><strong>异步上传接口 asyncUpload, 搭配 syncQueryUploadTask 查询上传结果</strong>.</li></ol> <p>使用方可以根据业务性质选择合适的方法: 如果是后端批处理使用, 那么可以使用同步上传, 多等待一些时间问题不大; 如果是面向用户的接口, 那么接口响应时间不宜过长, 可以调用异步上传接口, 然后定时轮询上传结果, 拿到结果再显示.</p> <h5 id="重点回顾-22"><a href="#重点回顾-22" class="header-anchor">#</a> 重点回顾</h5> <p>今天针对接口设计, 深入探讨了三个方面的问题.</p> <p>第一, <strong>针对响应体的设计混乱, 响应结果的不明确问题, 服务端需要明确响应体每一个字段的意义, 以一致的方式进行处理, 并确保不透传下游服务的错误</strong>.</p> <p>第二, <strong>针对接口版本控制问题, 主要就是在开发接口之前明确版本控制策略, 以及尽量使用统一的版本控制策略两方面</strong>.</p> <p>第三, 针对接口的处理方式, 需要明确要么是同步要么是异步. 如果 API 列表中既有同步接口也有异步接口, 那么最好直接在接口名中明确.</p> <p>一个良好的接口文档不仅仅需要说明如何调用接口, 更需要补充接口使用的最佳实践以及接口的 SLA 标准. 我看到的大部分接口文档只给出了参数定义, 但诸如幂等性, 同步异步, 缓存策略等看似内部实现相关的一些设计, 其实也会影响调用方对接口的使用策略, 最好也可以体现在接口文档中.</p> <p>最后再额外提一下, 对于服务端出错的时候是否返回 200 响应码的问题, 其实一直有争论. 从 RESTful 设计原则来看, 应该尽量利用 HTTP 状态码来表达错误, 但也不是这么绝对. 如果认为 HTTP 状态码是协议层面的履约, 那么当这个错误已经不涉及 HTTP 协议时(换句话说, 服务端已经收到请求进入服务端业务处理后产生的错误), 不一定需要硬套协议本身的错误码. 但涉及非法 URL, 非法参数, 没有权限等无法处理请求的情况, 还是应该使用正确的响应码来应对.</p> <h4 id="_23-缓存设计-缓存可以锦上添花也可以落井下石"><a href="#_23-缓存设计-缓存可以锦上添花也可以落井下石" class="header-anchor">#</a> 23-缓存设计:缓存可以锦上添花也可以落井下石</h4> <p>今天从设计的角度聊聊缓存.</p> <p>通常会使用更快的介质(比如内存)作为缓存, 来解决较慢介质(比如磁盘)读取数据慢的问题, <strong>缓存是用空间换时间</strong>, 来解决性能问题的一种架构设计模式. 更重要的是, 磁盘上存储的往往是原始数据, 而缓存中保存的可以是面向呈现的数据. 这样一来, 缓存不仅仅是加快了 IO, 还可以减少原始数据的计算工作.</p> <p>此外, 缓存系统一般设计简单, 功能相对单一, 所以诸如 Redis 这种缓存系统的整体吞吐量, 能达到关系型数据库的几倍甚至几十倍, 因此缓存特别适用于互联网应用的高并发场景.</p> <p>使用 Redis 做缓存虽然简单好用, 但使用和设计缓存并不是 set 一下这么简单, 需要注意<strong>缓存的同步, 雪崩, 并发, 穿透</strong>等问题. 今天就来详细聊聊.</p> <h5 id="不要把redis当作数据库"><a href="#不要把redis当作数据库" class="header-anchor">#</a> 不要把Redis当作数据库</h5> <p>通常, 我们会使用 Redis 等分布式缓存数据库来缓存数据, 但是**千万别把 Redis 当做数据库来使用. **我就见过许多案例, 因为 Redis 中数据消失导致业务逻辑错误, 并且因为没有保留原始数据, 业务都无法恢复.</p> <p>Redis 的确具有数据持久化功能, 可以实现服务重启后数据不丢失. 这一点, 很容易让人误认为 Redis 可以作为高性能的 KV 数据库.</p> <p>其实, 从本质上来看, Redis(免费版)是一个内存数据库, 所有数据保存在内存中, 并且直接从内存读写数据响应操作, 只不过具有数据持久化能力. 所以, Redis 的特点是, 处理请求很快, 但无法保存超过内存大小的数据.</p> <blockquote><p>备注: VM 模式虽然可以保存超过内存大小的数据, 但是因为性能原因从 2.6 开始已经被废弃. 此外, Redis 企业版提供了 Redis on Flash 可以实现 Key + 字典 + 热数据保存在内存中, 冷数据保存在 SSD 中.</p></blockquote> <p>因此, 把 Redis 用作缓存, 需要注意两点.</p> <p>第一, <strong>从客户端的角度来说, 缓存数据的特点一定是有原始数据来源, 且允许丢失</strong>, 即使设置的缓存时间是 1 分钟, 在 30 秒时缓存数据因为某种原因消失了, 我们也要能接受. 当数据丢失后, 需要从原始数据重新加载数据, 不能认为缓存系统是绝对可靠的, 更不能认为缓存系统不会删除没有过期的数据.</p> <p>第二, <strong>从 Redis 服务端的角度来说, 缓存系统可以保存的数据量一定是小于原始数据的</strong>. 首先应该限制 Redis 对内存的使用量, 也就是设置 maxmemory 参数; 其次应该根据数据特点, 明确 Redis 应该以怎样的算法来<strong>驱逐数据</strong>.</p> <p>从 Redis 的文档可以看到, 常用的数据淘汰策略有:</p> <ol><li>allkeys-lru, 针对所有 Key, 优先删除最近最少使用的 Key;</li> <li>volatile-lru, 针对带有过期时间的 Key, 优先删除最近最少使用的 Key;</li> <li>volatile-ttl, 针对带有过期时间的 Key, 优先删除即将过期的 Key(根据 TTL 的值);</li> <li>allkeys-lfu(Redis 4.0 以上), 针对所有 Key, 优先删除最少使用的 Key;</li> <li>volatile-lfu(Redis 4.0 以上), 针对带有过期时间的 Key, 优先删除最少使用的 Key.</li></ol> <p>其实, 这些算法是 <strong>Key 范围 + Key 选择算法</strong>的搭配组合, 其中范围有 allkeys 和 volatile 两种, 算法有 LRU, TTL 和 LFU 三种. 接下来就从 Key 范围和算法角度说说如何选择合适的驱逐算法.</p> <p>首先, 从算法角度来说, Redis 4.0 以后推出的 <strong>LFU 比 LRU 更 &quot;实用&quot;</strong> . 试想一下, 如果一个 Key 访问频率是 1 天一次, 但正好在 1 秒前刚访问过, 那么 LRU 可能不会选择优先淘汰这个 Key, 反而可能会淘汰一个 5 秒访问一次但最近 2 秒没有访问过的 Key, 而 LFU 算法不会有这个问题. 而 TTL 会比较 &quot;头脑简单&quot; 一点, 优先删除即将过期的 Key, 但有可能这个 Key 正在被大量访问.</p> <p>然后, 从 Key 范围角度来说, allkeys 可以确保即使 Key 没有 TTL 也能回收, 如果使用的时候客户端总是 &quot;忘记&quot; 设置缓存的过期时间, 那么可以考虑使用这个系列的算法. 而 volatile 会更稳妥一些, 万一客户端把 Redis 当做了长效缓存使用, 只是启动时候初始化一次缓存, 那么一旦删除了此类没有 TTL 的数据, 可能就会导致客户端出错.</p> <p>所以, 不管是使用者还是管理者都要考虑 Redis 的使用方式, 使用者需要考虑应该以缓存的姿势来使用 Redis, 管理者应该为 Redis 设置内存限制和合适的驱逐策略, 避免出现 OOM.</p> <h5 id="注意缓存雪崩问题"><a href="#注意缓存雪崩问题" class="header-anchor">#</a> 注意缓存雪崩问题</h5> <p>由于缓存系统的 IOPS 比数据库高很多, 因此要特别<mark><strong>小心短时间内大量缓存失效的情况</strong></mark>. 这种情况一旦发生, 可能就会在瞬间有大量的数据需要回源到数据库查询, 对数据库造成极大的压力, 极限情况下甚至导致后端数据库直接崩溃. <strong>这就是常说的缓存失效, 也叫作缓存雪崩</strong>.</p> <p>从广义上说, 产生缓存雪崩的原因有两种:</p> <ol><li>第一种是, <strong>缓存系统本身不可用, 导致大量请求直接回源到数据库</strong>;</li> <li>第二种是, <strong>应用设计层面大量的 Key 在同一时间过期, 导致大量的数据回源</strong>.</li></ol> <p>第一种原因, 主要涉及缓存系统本身高可用的配置, 不属于缓存设计层面的问题, 所以今天主要说说<strong>如何确保大量 Key 不在同一时间被动过期</strong>.</p> <p>程序初始化的时候放入 1000 条城市数据到 Redis 缓存中, 过期时间是 30 秒; 数据过期后从数据库获取数据然后写入缓存, 每次从数据库获取数据后计数器 +1; 在程序启动的同时, 启动一个定时任务线程每隔一秒输出计数器的值, 并把计数器归零.</p> <p>压测一个随机查询某城市信息的接口, 观察一下数据库的 QPS:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Autowired</span>
<span class="token keyword">private</span> <span class="token class-name">StringRedisTemplate</span> stringRedisTemplate<span class="token punctuation">;</span>
<span class="token keyword">private</span> <span class="token class-name">AtomicInteger</span> atomicInteger <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicInteger</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token annotation punctuation">@PostConstruct</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">wrongInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 初始化1000个城市数据到Redis, 所有缓存数据有效期30秒</span>
    <span class="token class-name">IntStream</span><span class="token punctuation">.</span><span class="token function">rangeClosed</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>i <span class="token operator">-&gt;</span> stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">&quot;city&quot;</span> <span class="token operator">+</span> i<span class="token punctuation">,</span> <span class="token function">getCityFromDb</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;Cache init finished&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
    <span class="token comment">// 每秒一次, 输出数据库访问的QPS</span>
    <span class="token class-name">Executors</span><span class="token punctuation">.</span><span class="token function">newSingleThreadScheduledExecutor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">scheduleAtFixedRate</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;DB QPS : {}&quot;</span><span class="token punctuation">,</span> atomicInteger<span class="token punctuation">.</span><span class="token function">getAndSet</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;city&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">city</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 随机查询一个城市</span>
    <span class="token keyword">int</span> id <span class="token operator">=</span> <span class="token class-name">ThreadLocalRandom</span><span class="token punctuation">.</span><span class="token function">current</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> key <span class="token operator">=</span> <span class="token string">&quot;city&quot;</span> <span class="token operator">+</span> id<span class="token punctuation">;</span>
    <span class="token class-name">String</span> data <span class="token operator">=</span> stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>data <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 回源到数据库查询</span>
        data <span class="token operator">=</span> <span class="token function">getCityFromDb</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token comment">// 缓存30秒过期</span>
            stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> data<span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> data<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token class-name">String</span> <span class="token function">getCityFromDb</span><span class="token punctuation">(</span><span class="token keyword">int</span> cityId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 模拟查询数据库, 查一次增加计数器加一</span>
    atomicInteger<span class="token punctuation">.</span><span class="token function">incrementAndGet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token string">&quot;citydata&quot;</span> <span class="token operator">+</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br></div></div><p>使用 wrk 工具, 设置 10 线程 10 连接压测 city 接口:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>wrk <span class="token operator">-</span>c10 <span class="token operator">-</span>t10 <span class="token operator">-</span>d <span class="token number">100</span>s http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>localhost<span class="token operator">:</span><span class="token number">45678</span><span class="token operator">/</span>cacheinvalid<span class="token operator">/</span>city
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>启动程序 30 秒后缓存过期, 回源的数据库 QPS 最高达到了 700 多:</p> <p><img src="/img/6d1f37a17d135bf8ca5bc724c073bfae-20230731165210-edtb8l6.png" alt=""></p> <p>解决缓存 Key 同时大规模失效需要回源, 导致数据库压力激增问题的方式有两种.</p> <p>方案一, <mark><strong>差异化缓存过期时间, 不要让大量的 Key 在同一时间过期</strong></mark>. 比如, 在初始化缓存的时候, 设置缓存的过期时间是 30 秒 + 10 秒以内的随机延迟(扰动值). 这样, 这些 Key 不会集中在 30 秒这个时刻过期, 而是会分散在 30~40 秒之间过期:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@PostConstruct</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">rightInit1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 这次缓存的过期时间是30秒+10秒内的随机延迟</span>
    <span class="token class-name">IntStream</span><span class="token punctuation">.</span><span class="token function">rangeClosed</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>i <span class="token operator">-&gt;</span> stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">&quot;city&quot;</span> <span class="token operator">+</span> i<span class="token punctuation">,</span> <span class="token function">getCityFromDb</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">30</span> <span class="token operator">+</span> <span class="token class-name">ThreadLocalRandom</span><span class="token punctuation">.</span><span class="token function">current</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;Cache init finished&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 同样1秒一次输出数据库QPS: </span>
    <span class="token class-name">Executors</span><span class="token punctuation">.</span><span class="token function">newSingleThreadScheduledExecutor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">scheduleAtFixedRate</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;DB QPS : {}&quot;</span><span class="token punctuation">,</span> atomicInteger<span class="token punctuation">.</span><span class="token function">getAndSet</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>修改后, 缓存过期时的回源不会集中在同一秒, 数据库的 QPS 从 700 多降到了最高 100 左右:</p> <p><img src="/img/8a7af724845df64dd07a00096e1c48e8-20230731165210-9tl2g74.png" alt=""></p> <p>方案二, <strong>让缓存不主动过期</strong>. 初始化缓存数据的时候设置缓存永不过期, 然后启动一个后台线程 30 秒一次定时把所有数据更新到缓存, 而且通过适当的休眠, <strong>控制从数据库更新数据的频率, 降低数据库压力</strong>:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@PostConstruct</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">rightInit2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
    <span class="token class-name">CountDownLatch</span> countDownLatch <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CountDownLatch</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 每隔30秒全量更新一次缓存 </span>
    <span class="token class-name">Executors</span><span class="token punctuation">.</span><span class="token function">newSingleThreadScheduledExecutor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">scheduleAtFixedRate</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        <span class="token class-name">IntStream</span><span class="token punctuation">.</span><span class="token function">rangeClosed</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>i <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token class-name">String</span> data <span class="token operator">=</span> <span class="token function">getCityFromDb</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 模拟更新缓存需要一定的时间</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">MILLISECONDS</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// 缓存永不过期, 被动更新</span>
                stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">&quot;city&quot;</span> <span class="token operator">+</span> i<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;Cache update finished&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 启动程序的时候需要等待首次更新缓存完成</span>
        countDownLatch<span class="token punctuation">.</span><span class="token function">countDown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">Executors</span><span class="token punctuation">.</span><span class="token function">newSingleThreadScheduledExecutor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">scheduleAtFixedRate</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;DB QPS : {}&quot;</span><span class="token punctuation">,</span> atomicInteger<span class="token punctuation">.</span><span class="token function">getAndSet</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    countDownLatch<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><p>这样修改后, 虽然缓存整体更新的耗时在 21 秒左右, 但数据库的压力会比较稳定:</p> <p><img src="/img/c8057a89e20126b1dd8a25555757c0a3-20230731165210-y98lf8x.png" alt=""></p> <p>关于这两种解决方案, <strong>需要特别注意以下三点</strong>:</p> <ol><li>方案一和方案二是截然不同的两种缓存方式, 如果无法全量缓存所有数据, 那么只能使用方案一;</li> <li>即使使用了方案二, 缓存永不过期, 同样需要在查询的时候, 确保有回源的逻辑. 正如之前所说, 我们无法确保缓存系统中的数据永不丢失.</li> <li>不管是方案一还是方案二, 在把数据从数据库加入缓存的时候, 都需要判断来自数据库的数据是否合法, 比如进行最基本的判空检查.</li></ol> <p>之前我就遇到过这样一个重大事故, 某系统会在缓存中对基础数据进行长达半年的缓存, 在某个时间点 DBA 把数据库中的原始数据进行了归档(可以认为是删除)操作. 因为缓存中的数据一直在所以一开始没什么问题, 但半年后的一天缓存中数据过期了, 就从数据库中查询到了空数据加入缓存, 爆发了大面积的事故.</p> <p>这个案例说明, 缓存会让我们更不容易发现原始数据的问题, 所以在<strong>把数据加入缓存之前一定要校验数据</strong>, 如果发现有明显异常要及时报警.</p> <p>说到这里, 再仔细看一下回源 QPS 超过 700 的截图, 可以看到在并发情况下, 总共 1000 条数据回源达到了 1002 次, 说明有一些条目出现了<strong>并发回源</strong>. 这就是后面要讲到的<strong>缓存并发问题</strong>.</p> <h5 id="注意缓存击穿问题"><a href="#注意缓存击穿问题" class="header-anchor">#</a> 注意缓存击穿问题</h5> <p><strong>在某些 Key 属于极端热点数据, 且并发量很大的情况下, 如果这个 Key 过期, 可能会在某个瞬间出现大量的并发请求同时回源, 相当于大量的并发请求直接打到了数据库. 这种情况就是常说的缓存击穿或缓存并发问题.</strong></p> <p>来重现下这个问题. 在程序启动的时候, 初始化一个热点数据到 Redis 中, 过期时间设置为 5 秒, 每隔 1 秒输出一下回源的 QPS:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@PostConstruct</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 初始化一个热点数据到Redis中, 过期时间设置为5秒</span>
    stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">&quot;hotsopt&quot;</span><span class="token punctuation">,</span> <span class="token function">getExpensiveData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 每隔1秒输出一下回源的QPS</span>
   
    <span class="token class-name">Executors</span><span class="token punctuation">.</span><span class="token function">newSingleThreadScheduledExecutor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">scheduleAtFixedRate</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;DB QPS : {}&quot;</span><span class="token punctuation">,</span> atomicInteger<span class="token punctuation">.</span><span class="token function">getAndSet</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;wrong&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">wrong</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">String</span> data <span class="token operator">=</span> stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;hotsopt&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        data <span class="token operator">=</span> <span class="token function">getExpensiveData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 重新加入缓存, 过期时间还是5秒</span>
        stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">&quot;hotsopt&quot;</span><span class="token punctuation">,</span> data<span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> data<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p>可以看到, 每隔 5 秒数据库都有 20 左右的 QPS:</p> <p><img src="/img/65ba012bbaf98c64db7c06ab201c7101-20230731165210-u2ao9a0.png" alt=""></p> <p>如果回源操作特别昂贵, 那么这种并发就不能忽略不计. 这时可以考虑使用锁机制来限制回源的并发. 比如如下代码示例, 使用 Redisson 来获取一个基于 Redis 的分布式锁, 在查询数据库之前先尝试获取锁:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Autowired</span>
<span class="token keyword">private</span> <span class="token class-name">RedissonClient</span> redissonClient<span class="token punctuation">;</span>

<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;right&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">right</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">String</span> data <span class="token operator">=</span> stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;hotsopt&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">RLock</span> locker <span class="token operator">=</span> redissonClient<span class="token punctuation">.</span><span class="token function">getLock</span><span class="token punctuation">(</span><span class="token string">&quot;locker&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 获取分布式锁</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>locker<span class="token punctuation">.</span><span class="token function">tryLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                data <span class="token operator">=</span> stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;hotsopt&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 双重检查, 因为可能已经有一个B线程过了第一次判断, 在等锁, 然后A线程已经把数据写入了Redis中</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">// 回源到数据库查询</span>
                    data <span class="token operator">=</span> <span class="token function">getExpensiveData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">&quot;hotsopt&quot;</span><span class="token punctuation">,</span> data<span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                <span class="token comment">// 别忘记释放, 另外注意写法, 获取锁后整段代码try+finally, 确保unlock万无一失</span>
                locker<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> data<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><p>这样可以把回源到数据库的并发限制在 1:</p> <p><img src="/img/80b1a7e9e7428030fc70385579ae3c5a-20230731165210-9qya80x.png" alt=""></p> <p>在真实的业务场景下, <strong>不一定</strong>要这么严格地使用双重检查分布式锁进行全局的并发限制, 因为这样虽然可以把数据库回源并发降到最低, 但也限制了缓存失效时的并发. 可以考虑的方式是:</p> <ol><li>方案一, 使用进程内的锁进行限制, 这样每一个节点都可以以一个并发回源数据库;</li> <li>方案二, 不使用锁进行限制, 而是使用类似 Semaphore 的工具限制并发数, 比如限制为 10, 这样既限制了回源并发数不至于太大, 又能使得一定量的线程可以同时回源.</li></ol> <h5 id="注意缓存穿透问题"><a href="#注意缓存穿透问题" class="header-anchor">#</a> 注意缓存穿透问题</h5> <p>在之前的例子中, 缓存回源的逻辑都是<strong>当缓存中查不到需要的数据时, 回源到数据库查询</strong>. 这里容易出现的一个漏洞是, <strong>缓存中没有数据不一定代表数据没有缓存, 还有一种可能是原始数据压根就不存在</strong>.</p> <p>比如下面的例子. 数据库中只保存有 ID 介于 0(不含)和 10000(包含)之间的用户, 如果从数据库查询 ID 不在这个区间的用户, 会得到空字符串, 所以缓存中缓存的也是空字符串. 如果使用 ID=0 去压接口的话, 从缓存中查出了空字符串, <strong>认为是缓存中没有数据回源查询, 其实相当于每次都回源</strong>:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;wrong&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">wrong</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">)</span> <span class="token keyword">int</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">String</span> key <span class="token operator">=</span> <span class="token string">&quot;user&quot;</span> <span class="token operator">+</span> id<span class="token punctuation">;</span>
    <span class="token class-name">String</span> data <span class="token operator">=</span> stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 无法区分是无效用户还是缓存失效</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        data <span class="token operator">=</span> <span class="token function">getCityFromDb</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> data<span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> data<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">private</span> <span class="token class-name">String</span> <span class="token function">getCityFromDb</span><span class="token punctuation">(</span><span class="token keyword">int</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    atomicInteger<span class="token punctuation">.</span><span class="token function">incrementAndGet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 注意, 只有ID介于0(不含)和10000(包含)之间的用户才是有效用户, 可以查询到用户信息</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>id <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> id <span class="token operator">&lt;=</span> <span class="token number">10000</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token string">&quot;userdata&quot;</span><span class="token punctuation">;</span>
    <span class="token comment">// 否则返回空字符串</span>
    <span class="token keyword">return</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>压测后数据库的 QPS 达到了几千:</p> <p><img src="/img/8242c2bad55b7d821109b07a891733e7-20230731165210-t5a4qvc.png" alt=""></p> <p>如果这种漏洞被恶意利用的话, 就会对数据库造成很大的性能压力. <strong>这就是</strong>​<mark><strong>缓存穿透</strong></mark>.</p> <p>这里需要注意, <mark><strong>缓存穿透和缓存击穿</strong></mark>的区别:</p> <ol><li><mark><strong>缓存穿透是指, 缓存没有起到压力缓冲的作用.</strong></mark></li> <li><mark><strong>而缓存击穿是指, 缓存失效时瞬时的并发打到数据库.</strong></mark></li></ol> <p>解决缓存穿透有以下两种方案.</p> <p>方案一, <strong>对于不存在的数据, 同样设置一个特殊的 Value 到缓存中</strong>, 比如当数据库中查出的用户信息为空的时候, 设置 NODATA 这样具有特殊含义的字符串到缓存中. 这样下次请求缓存的时候还是可以命中缓存, 即直接从缓存返回结果, 不查询数据库:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;right&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">right</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">)</span> <span class="token keyword">int</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">String</span> key <span class="token operator">=</span> <span class="token string">&quot;user&quot;</span> <span class="token operator">+</span> id<span class="token punctuation">;</span>
    <span class="token class-name">String</span> data <span class="token operator">=</span> stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        data <span class="token operator">=</span> <span class="token function">getCityFromDb</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 校验从数据库返回的数据是否有效</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> data<span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment">// 如果无效, 直接在缓存中设置一个NODATA, 这样下次查询时即使是无效用户还是可以命中缓存</span>
            stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token string">&quot;NODATA&quot;</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> data<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>但这种方式<strong>可能会把大量无效的数据加入缓存中</strong>, 如果担心大量无效数据占满缓存的话还可以考虑方案二, 即<strong>使用布隆过滤器做前置过滤</strong>.</p> <p>布隆过滤器是一种概率型数据库结构, 由一个很长的二进制向量和一系列随机映射函数组成. 它的原理是, 当一个元素被加入集合时, 通过 k 个散列函数将这个元素映射成一个 m 位 bit 数组中的 k 个点, 并置为 1.</p> <p>检索时只要看看这些点是不是都是 1 就(大概)知道集合中有没有它了. 如果这些点<strong>有任何一个 0, 则被检元素一定不在; 如果都是 1, 则被检元素很可能在</strong>.</p> <p>原理如下图所示:</p> <p><img src="/img/133773e9514610350f6ccddeca092034-20230731165210-bxeuo2n.png" alt=""></p> <p>布隆过滤器不保存原始值, 空间效率很高, 平均每一个元素占用 2.4 字节就可以达到万分之一的误判率. 这里的误判率是指, 过滤器判断值存在而实际并不存在的概率. 可以设置布隆过滤器使用更大的存储空间, 来得到更小的误判率.</p> <p>可以<strong>把所有可能的值保存在布隆过滤器中, 从缓存读取数据前先过滤一次</strong>:</p> <ol><li><strong>如果布隆过滤器认为值不存在, 那么值一定是不存在的, 无需查询缓存也无需查询数据库;</strong></li> <li><strong>对于极小概率的误判请求, 才会最终让非法 Key 的请求走到缓存或数据库.</strong></li></ol> <p>要用上布隆过滤器, 可以使用 Google 的 Guava 工具包提供的 BloomFilter 类改造一下程序: 启动时, 初始化一个具有所有有效用户 ID 的, 10000 个元素的 BloomFilter, 在从缓存查询数据之前调用其 mightContain 方法, 来检测用户 ID 是否可能存在; <strong>如果布隆过滤器说值不存在, 那么一定是不存在的, 直接返回</strong>:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token class-name">BloomFilter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> bloomFilter<span class="token punctuation">;</span>

<span class="token annotation punctuation">@PostConstruct</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 创建布隆过滤器, 元素数量10000, 期望误判率1%</span>
    bloomFilter <span class="token operator">=</span> <span class="token class-name">BloomFilter</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token class-name">Funnels</span><span class="token punctuation">.</span><span class="token function">integerFunnel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">10000</span><span class="token punctuation">,</span> <span class="token number">0.01</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 填充布隆过滤器</span>
    <span class="token class-name">IntStream</span><span class="token punctuation">.</span><span class="token function">rangeClosed</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">10000</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>bloomFilter<span class="token operator">::</span><span class="token function">put</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;right2&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">right2</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">)</span> <span class="token keyword">int</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">String</span> data <span class="token operator">=</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
    <span class="token comment">// 通过布隆过滤器先判断</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>bloomFilter<span class="token punctuation">.</span><span class="token function">mightContain</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> key <span class="token operator">=</span> <span class="token string">&quot;user&quot;</span> <span class="token operator">+</span> id<span class="token punctuation">;</span>
        <span class="token comment">// 走缓存查询</span>
        data <span class="token operator">=</span> stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 走数据库查询</span>
            data <span class="token operator">=</span> <span class="token function">getCityFromDb</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
            stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> data<span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> data<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><p>对于方案二, 需要同步所有可能存在的值并加入布隆过滤器, 这是比较麻烦的地方. 如果业务规则明确的话, 也可以考虑<strong>直接根据业务规则判断值是否存在</strong>.</p> <p>其实, 方案二可以和方案一同时使用, <strong>即将布隆过滤器前置, 对于误判的情况再保存特殊值到缓存, 双重保险避免无效数据查询请求打到数据库</strong>.</p> <h5 id="注意缓存数据同步策略"><a href="#注意缓存数据同步策略" class="header-anchor">#</a> 注意缓存数据同步策略</h5> <p>前面提到的 3 个案例, 其实都属于缓存数据过期后的被动删除. 在实际情况下, 修改了原始数据后, 考虑到缓存数据更新的及时性, 可能会采用<strong>主动更新缓存的策略</strong>. 这些策略可能是:</p> <ol><li>先更新缓存, 再更新数据库;</li> <li>先更新数据库, 再更新缓存;</li> <li>先删除缓存, 再更新数据库, 访问的时候按需加载数据到缓存;</li> <li><strong>先更新数据库, 再删除缓存, 访问的时候按需加载数据到缓存.</strong></li></ol> <p>那么应该选择哪种更新策略呢? 下面逐一分析下这 4 种策略:</p> <p><strong>&quot;先更新缓存再更新数据库&quot; 策略不可行</strong>. 数据库设计复杂, 压力集中, 数据库因为超时等原因更新操作失败的可能性较大, 此外还会涉及事务, 很可能因为数据库更新失败, 导致缓存和数据库的数据不一致.</p> <p><strong>&quot;先更新数据库再更新缓存&quot; 策略不可行</strong>. 一是, 如果线程 A 和 B 先后完成数据库更新, 但更新缓存时却是 B 和 A 的顺序, 那很可能会把旧数据更新到缓存中引起数据不一致; 二是, 不确定缓存中的数据是否会被访问, 不一定要把所有数据都更新到缓存中去.</p> <p><strong>&quot;先删除缓存再更新数据库, 访问的时候按需加载数据到缓存&quot; 策略也不可行</strong>. 在并发的情况下, 很可能删除缓存后还没来得及更新数据库, 就有另一个线程先读取了旧值到缓存中, 如果并发量很大的话这个概率也会很大.</p> <p><mark><strong>&quot;先更新数据库再删除缓存, 访问的时候按需加载数据到缓存&quot; 策略是最好的</strong></mark>. 虽然在极端情况下, 这种策略也可能出现数据不一致的问题, 但概率非常低, 基本可以忽略. 举一个 &quot;极端情况&quot; 的例子, 比如更新数据的时间节点恰好是缓存失效的瞬间, 这时 A 先读取到了旧值, 随后在 B 操作数据库完成更新并且删除了缓存之后, A 再把旧值加入缓存.</p> <p>需要注意的是, <strong>更新数据库后删除缓存的操作可能失败, 如果失败则考虑把任务加入延迟队列进行延迟重试, 确保数据可以删除, 缓存可以及时更新</strong>. 因为删除操作是幂等的, 所以即使重复删问题也不是太大, 这又是删除比更新好的一个原因.</p> <p>因此, 针对缓存更新更推荐的方式是, <strong>缓存中的数据不由数据更新操作主动触发, 统一在需要使用的时候按需加载, 数据更新后及时删除缓存中的数据即可</strong>.</p> <h5 id="重点回顾-23"><a href="#重点回顾-23" class="header-anchor">#</a> 重点回顾</h5> <p>今天主要是从设计的角度, 分享了数据缓存的三大问题.</p> <p>第一, 不能把诸如 Redis 的缓存数据库完全当作数据库来使用. 不能假设缓存始终可靠, 也不能假设没有过期的数据必然可以被读取到, 需要处理好缓存的回源逻辑; 而且要显式设置 Redis 的最大内存使用和数据淘汰策略, 避免出现 OOM 的问题.</p> <p>第二, 缓存的性能比数据库好很多, 需要考虑大量请求绕过缓存直击数据库造成数据库瘫痪的各种情况. 对于缓存瞬时大面积失效的<strong>缓存雪崩</strong>问题, 可以通过差异化缓存过期时间解决; 对于高并发的<strong>缓存 Key 回源</strong>问题, 可以使用锁来限制回源并发数; 对于不存在的数据<strong>穿透缓存</strong>的问题, 可以通过布隆过滤器进行数据存在性的预判, 或在缓存中也设置一个值来解决.</p> <p>第三, 当数据库中的数据有更新的时候, 需要考虑如何确保缓存中数据的一致性. &quot;<strong>先更新数据库再删除缓存, 访问的时候按需加载数据到缓存</strong>&quot; 的策略是最为妥当的, 并且要尽量设置合适的缓存过期时间, 这样即便真的发生不一致, 也可以在缓存过期后数据得到及时同步.</p> <p>最后要提醒的是, <strong>在使用缓存系统的时候, 要监控缓存系统的内存使用量, 命中率, 对象平均过期时间等重要指标, 以便评估系统的有效性, 并及时发现问题</strong>.</p> <h4 id="_24-业务代码写完-就意味着生产就绪了"><a href="#_24-业务代码写完-就意味着生产就绪了" class="header-anchor">#</a> 24-业务代码写完,就意味着生产就绪了?</h4> <p>今天来聊聊业务代码写完, 是不是就意味着生产就绪, 可以直接投产了.</p> <p>所谓生产就绪(Production-ready), 是指应用开发完成要投入生产环境, 开发层面需要额外做的一些工作. 在我看来, 如果应用只是开发完成了功能代码, 然后就直接投产, 那意味着应用其实在裸奔. 在这种情况下, 遇到问题因为缺乏有效的监控导致无法排查定位问题, 同时很可能遇到问题连自己都不知道, 需要依靠用户反馈才知道应用出了问题.</p> <p>那么, 生产就绪需要做哪些工作呢? 我认为, 以下三方面的工作最重要.</p> <p>第一, <strong>提供健康检测接口</strong>. 传统采用 ping 的方式对应用进行探活检测并不准确. 有的时候, 应用的关键内部或外部依赖已经离线, 导致其根本无法正常工作, 但其对外的 Web 端口或管理端口是可以 ping 通的. 应该提供一个专有的监控检测接口, 并尽可能触达一些内部组件.</p> <p>第二, <strong>暴露应用内部信息</strong>. 应用内部诸如线程池, 内存队列等组件, 往往在应用内部扮演了重要的角色, 如果应用或应用框架可以对外暴露这些重要信息, 并加以监控, 那么就有可能在诸如 OOM 等重大问题暴露之前发现蛛丝马迹, 避免出现更大的问题.</p> <p>第三, <strong>建立应用指标 Metrics 监控</strong>. Metrics 可以翻译为度量或者指标, 指的是对于一些关键信息以可聚合的, 数值的形式做定期统计, 并绘制出各种趋势图表. 这里的指标监控, 包括两个方面: 一是, 应用内部重要组件的指标监控, 比如 JVM 的一些指标, 接口的 QPS 等; 二是, 应用的业务数据的监控, 比如电商订单量, 游戏在线人数等.</p> <p>今天就通过实际案例, 聊聊如何快速实现这三方面的工作.</p> <h5 id="准备工作-配置spring-boot-actuator"><a href="#准备工作-配置spring-boot-actuator" class="header-anchor">#</a> 准备工作:配置Spring Boot Actuator</h5> <p><strong>Spring Boot 有一个 Actuator 模块, 封装了诸如健康检测, 应用内部信息, Metrics 指标等生产就绪的功能</strong>. 今天这一讲后面的内容都是基于 Actuator 的, 因此需要先完成 Actuator 的引入和配置.</p> <p>可以像这样在 pom 中通过添加依赖的方式引入 Actuator:</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-actuator<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>之后就可以直接使用 Actuator 了, 但还要注意一些重要的配置:</p> <ol><li>如果不希望 Web 应用的 Actuator 管理端口和应用端口重合的话, 可以使用 <code>management.server.port</code>​ 设置独立的端口.</li> <li>Actuator 自带了很多开箱即用<strong>提供信息的端点(Endpoint)</strong> , 可以通过 JMX 或 Web 两种方式进行暴露. 考虑到有些信息比较敏感, 这些内置的端点默认不是完全开启的, 可以通过官网查看这些默认值. 在这里, 为了方便后续 Demo, 设置所有端点通过 Web 方式开启.</li> <li>默认情况下, Actuator 的 Web 访问方式的根地址为 <code>/actuator</code>​, 可以通过 <code>management.endpoints.web.base-path</code>​ 参数进行修改. 下面演示下如何将其修改为 /admin.</li></ol> <div class="language-java line-numbers-mode"><pre class="language-java"><code>management<span class="token punctuation">.</span>server<span class="token punctuation">.</span>port<span class="token operator">=</span><span class="token number">45679</span>
management<span class="token punctuation">.</span>endpoints<span class="token punctuation">.</span>web<span class="token punctuation">.</span>exposure<span class="token punctuation">.</span>include<span class="token operator">=</span><span class="token operator">*</span>
management<span class="token punctuation">.</span>endpoints<span class="token punctuation">.</span>web<span class="token punctuation">.</span>base<span class="token operator">-</span>path<span class="token operator">=</span><span class="token operator">/</span>admin
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>现在就可以访问 <code>http://localhost:45679/admin</code>​, 来查看 Actuator 的所有功能 URL 了:</p> <p><img src="/img/2625ab7b3dbc6d14b9b29b83e7cd16a4-20230731165210-otjb8ns.png" alt=""></p> <p>其中, 大部分端点提供的是<strong>只读信息</strong>, 比如查询 Spring 的 Bean, ConfigurableEnvironment, 定时任务, SpringBoot 自动配置, Spring MVC 映射等; 少部分端点还提供了修改功能, 比如优雅关闭程序, 下载线程 Dump, 下载堆 Dump, 修改日志级别等.</p> <h5 id="健康检测需要触达关键组件"><a href="#健康检测需要触达关键组件" class="header-anchor">#</a> 健康检测需要触达关键组件</h5> <p><strong>健康检测接口可以让监控系统或发布工具知晓应用的真实健康状态, 比 ping 应用端口更可靠</strong>. 不过, 要达到这种效果最关键的是, 能确保健康检测接口可以探查到关键组件的状态.</p> <p>好在 Spring Boot Actuator 预先实现了诸如数据库, InfluxDB, Elasticsearch, Redis, RabbitMQ 等三方系统的健康检测指示器 <strong>HealthIndicator</strong>.</p> <p>通过 Spring Boot 的自动配置, 这些指示器会自动生效. 当这些组件有问题的时候, HealthIndicator 会返回 DOWN 或 OUT_OF_SERVICE 状态, health 端点 HTTP 响应状态码也会变为 503, 可以以此来配置程序健康状态监控报警.</p> <p>为了演示, 可以修改配置文件, 把 <code>management.endpoint.health.show-details</code>​ 参数设置为 always, 让所有用户都可以直接查看各个组件的健康情况(如果配置为 when-authorized, 那么可以结合 <code>management.endpoint.health.roles</code>​ 配置授权的角色):</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>management<span class="token punctuation">.</span>endpoint<span class="token punctuation">.</span>health<span class="token punctuation">.</span>show<span class="token operator">-</span>details<span class="token operator">=</span>always
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>访问 health 端点可以看到, 数据库, 磁盘, RabbitMQ, Redis 等组件健康状态是 UP, 整个应用的状态也是 UP:</p> <p><img src="/img/066b82b3f9b59efef220ac7f9990253d-20230731165210-hram14p.png" alt=""></p> <p>在了解了基本配置之后, 考虑一下<strong>如果程序依赖一个很重要的三方服务, 我们希望这个服务无法访问的时候, 应用本身的健康状态也是 DOWN</strong>.</p> <p>比如三方服务有一个 user 接口, 出现异常的概率是 50%:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@RestController</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">&quot;user&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserServiceController</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@GetMapping</span>
    <span class="token keyword">public</span> <span class="token class-name">User</span> <span class="token function">getUser</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;userId&quot;</span><span class="token punctuation">)</span> <span class="token keyword">long</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 一半概率返回正确响应, 一半概率抛异常</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">ThreadLocalRandom</span><span class="token punctuation">.</span><span class="token function">current</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> <span class="token string">&quot;name&quot;</span> <span class="token operator">+</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;error&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>要实现这个 user 接口是否正确响应和程序整体的健康状态挂钩的话, 很简单, 只需<strong>定义一个 UserServiceHealthIndicator 实现 HealthIndicator 接口即可</strong>.</p> <p>在 health 方法中, 通过 RestTemplate 来访问这个 user 接口, 如果结果正确则返回 Health.up(), 并把调用执行耗时和结果作为补充信息加入 Health 对象中. 如果调用接口出现异常, 则返回 Health.down(), 并把异常信息作为补充信息加入 Health 对象中:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Component</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserServiceHealthIndicator</span> <span class="token keyword">implements</span> <span class="token class-name">HealthIndicator</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">RestTemplate</span> restTemplate<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Health</span> <span class="token function">health</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">long</span> begin <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">long</span> userId <span class="token operator">=</span> <span class="token number">1L</span><span class="token punctuation">;</span>
        <span class="token class-name">User</span> user <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">// 访问远程接口</span>
            user <span class="token operator">=</span> restTemplate<span class="token punctuation">.</span><span class="token function">getForObject</span><span class="token punctuation">(</span><span class="token string">&quot;http://localhost:45678/user?userId=&quot;</span> <span class="token operator">+</span> userId<span class="token punctuation">,</span> <span class="token class-name">User</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>user <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> user<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> userId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// 结果正确, 返回UP状态, 补充提供耗时和用户信息</span>
                <span class="token keyword">return</span> <span class="token class-name">Health</span><span class="token punctuation">.</span><span class="token function">up</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">withDetail</span><span class="token punctuation">(</span><span class="token string">&quot;user&quot;</span><span class="token punctuation">,</span> user<span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">withDetail</span><span class="token punctuation">(</span><span class="token string">&quot;took&quot;</span><span class="token punctuation">,</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> begin<span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment">// 结果不正确, 返回DOWN状态, 补充提供耗时</span>
                <span class="token keyword">return</span> <span class="token class-name">Health</span><span class="token punctuation">.</span><span class="token function">down</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">withDetail</span><span class="token punctuation">(</span><span class="token string">&quot;took&quot;</span><span class="token punctuation">,</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> begin<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 出现异常, 先记录异常, 然后返回DOWN状态, 补充提供异常信息和耗时</span>
            log<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;health check failed!&quot;</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token class-name">Health</span><span class="token punctuation">.</span><span class="token function">down</span><span class="token punctuation">(</span>ex<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">withDetail</span><span class="token punctuation">(</span><span class="token string">&quot;took&quot;</span><span class="token punctuation">,</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> begin<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br></div></div><p>再来看一个聚合多个 HealthIndicator 的案例, 也就是<strong>定义一个 CompositeHealthContributor 来聚合多个 HealthContributor, 实现一组线程池的监控</strong>.</p> <p>首先, 在 ThreadPoolProvider 中定义两个线程池, 其中 demoThreadPool 是包含一个工作线程的线程池, 类型是 ArrayBlockingQueue, 阻塞队列的长度为 10; 还有一个 ioThreadPool 模拟 IO 操作线程池, 核心线程数 10, 最大线程数 50:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ThreadPoolProvider</span> <span class="token punctuation">{</span>
    <span class="token comment">// 一个工作线程的线程池, 队列长度10</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">ThreadPoolExecutor</span> demoThreadPool <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadPoolExecutor</span><span class="token punctuation">(</span>
            <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span>
            <span class="token number">2</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">,</span>
            <span class="token keyword">new</span> <span class="token class-name">ArrayBlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token keyword">new</span> <span class="token class-name">ThreadFactoryBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setNameFormat</span><span class="token punctuation">(</span><span class="token string">&quot;demo-threadpool-%d&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 核心线程数10, 最大线程数50的线程池, 队列长度50</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">ThreadPoolExecutor</span> ioThreadPool <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadPoolExecutor</span><span class="token punctuation">(</span>
            <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">,</span>
            <span class="token number">2</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">,</span>
            <span class="token keyword">new</span> <span class="token class-name">ArrayBlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token keyword">new</span> <span class="token class-name">ThreadFactoryBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setNameFormat</span><span class="token punctuation">(</span><span class="token string">&quot;io-threadpool-%d&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">ThreadPoolExecutor</span> <span class="token function">getDemoThreadPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> demoThreadPool<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">ThreadPoolExecutor</span> <span class="token function">getIOThreadPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> ioThreadPool<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><p>然后定义一个接口, 来把耗时很长的任务提交到这个 demoThreadPool 线程池, 以模拟线程池队列满的情况:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;slowTask&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">slowTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">ThreadPoolProvider</span><span class="token punctuation">.</span><span class="token function">getDemoThreadPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">HOURS</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>做了这些准备工作后, 来真正实现自定义的 HealthIndicator 类, 用于单一线程池的健康状态.</p> <p>可以传入一个 ThreadPoolExecutor, 通过<strong>判断队列剩余容量来确定这个组件的健康状态</strong>, 有剩余量则返回 UP, 否则返回 DOWN, 并把线程池队列的两个重要数据, 也就是当前队列元素个数和剩余量, 作为补充信息加入 Health:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ThreadPoolHealthIndicator</span> <span class="token keyword">implements</span> <span class="token class-name">HealthIndicator</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token class-name">ThreadPoolExecutor</span> threadPool<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">ThreadPoolHealthIndicator</span><span class="token punctuation">(</span><span class="token class-name">ThreadPoolExecutor</span> threadPool<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>threadPool <span class="token operator">=</span> threadPool<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Health</span> <span class="token function">health</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 补充信息</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> detail <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 队列当前元素个数</span>
        detail<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;queue_size&quot;</span><span class="token punctuation">,</span> threadPool<span class="token punctuation">.</span><span class="token function">getQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 队列剩余容量</span>
        detail<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;queue_remaining&quot;</span><span class="token punctuation">,</span> threadPool<span class="token punctuation">.</span><span class="token function">getQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">remainingCapacity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 如果还有剩余量则返回UP, 否则返回DOWN</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>threadPool<span class="token punctuation">.</span><span class="token function">getQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">remainingCapacity</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token class-name">Health</span><span class="token punctuation">.</span><span class="token function">up</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">withDetails</span><span class="token punctuation">(</span>detail<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token class-name">Health</span><span class="token punctuation">.</span><span class="token function">down</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">withDetails</span><span class="token punctuation">(</span>detail<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><p>再定义一个 CompositeHealthContributor, 来<strong>聚合两个 ThreadPoolHealthIndicator 的实例</strong>, 分别对应 ThreadPoolProvider 中定义的两个线程池:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ThreadPoolsHealthContributor</span> <span class="token keyword">implements</span> <span class="token class-name">CompositeHealthContributor</span> <span class="token punctuation">{</span>
    <span class="token comment">// 保存所有的子HealthContributor</span>
    <span class="token keyword">private</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">HealthContributor</span><span class="token punctuation">&gt;</span></span> contributors <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">ThreadPoolsHealthContributor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 对应ThreadPoolProvider中定义的两个线程池</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>contributors<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;demoThreadPool&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">ThreadPoolHealthIndicator</span><span class="token punctuation">(</span><span class="token class-name">ThreadPoolProvider</span><span class="token punctuation">.</span><span class="token function">getDemoThreadPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>contributors<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;ioThreadPool&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">ThreadPoolHealthIndicator</span><span class="token punctuation">(</span><span class="token class-name">ThreadPoolProvider</span><span class="token punctuation">.</span><span class="token function">getIOThreadPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">HealthContributor</span> <span class="token function">getContributor</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 根据name找到某一个HealthContributor</span>
        <span class="token keyword">return</span> contributors<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Iterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">NamedContributor</span><span class="token punctuation">&lt;</span><span class="token class-name">HealthContributor</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 返回NamedContributor的迭代器, NamedContributor也就是Contributor实例+一个命名</span>
        <span class="token keyword">return</span> contributors<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span>entry<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token class-name">NamedContributor</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>entry<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> entry<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><p>程序启动后可以看到, <strong>health 接口展现了线程池和外部服务 userService 的健康状态</strong>, 以及一些具体信息:</p> <p><img src="/img/a6f592bf8fb6584166dbb489bd52f209-20230731165210-wfjg78g.png" alt=""></p> <p>可以看到一个 demoThreadPool 为 DOWN 导致父 threadPools 为 DOWN, 进一步导致整个程序的 status 为 DOWN:</p> <p><img src="/img/6ddf1587b01e42ca7d87f4f8b91547d4-20230731165210-c7fpkn0.png" alt=""></p> <p>以上就是通过<strong>自定义 HealthContributor 和 CompositeHealthContributor, 来实现监控检测触达程序内部诸如三方服务, 线程池等关键组件</strong>, 是不是很方便呢?</p> <p>额外补充一下, Spring Boot 2.3.0 增强了健康检测的功能, 细化了 Liveness 和 Readiness 两个端点, 便于 Spring Boot 应用程序和 Kubernetes 整合.</p> <h5 id="对外暴露应用内部重要组件的状态"><a href="#对外暴露应用内部重要组件的状态" class="header-anchor">#</a> 对外暴露应用内部重要组件的状态</h5> <p>除了可以把线程池的状态作为整个应用程序是否健康的依据外, 还可以<strong>通过 Actuator 的 InfoContributor 功能, 对外暴露程序内部重要组件的状态数据</strong>. 这里用一个例子演示使用 info 的 HTTP 端点, JMX MBean 这两种方式, 如何查看状态数据.</p> <p>看一个具体案例, 实现一个 ThreadPoolInfoContributor 来展现线程池的信息.</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ThreadPoolInfoContributor</span> <span class="token keyword">implements</span> <span class="token class-name">InfoContributor</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">Map</span> <span class="token function">threadPoolInfo</span><span class="token punctuation">(</span><span class="token class-name">ThreadPoolExecutor</span> threadPool<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> info <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        info<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;poolSize&quot;</span><span class="token punctuation">,</span> threadPool<span class="token punctuation">.</span><span class="token function">getPoolSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 当前池大小</span>
        info<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;corePoolSize&quot;</span><span class="token punctuation">,</span> threadPool<span class="token punctuation">.</span><span class="token function">getCorePoolSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 设置的核心池大小</span>
        info<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;largestPoolSize&quot;</span><span class="token punctuation">,</span> threadPool<span class="token punctuation">.</span><span class="token function">getLargestPoolSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 最大达到过的池大小</span>
        info<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;maximumPoolSize&quot;</span><span class="token punctuation">,</span> threadPool<span class="token punctuation">.</span><span class="token function">getMaximumPoolSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 设置的最大池大小</span>
        info<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;completedTaskCount&quot;</span><span class="token punctuation">,</span> threadPool<span class="token punctuation">.</span><span class="token function">getCompletedTaskCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 总完成任务数</span>
        <span class="token keyword">return</span> info<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">contribute</span><span class="token punctuation">(</span><span class="token class-name">Info<span class="token punctuation">.</span>Builder</span> builder<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        builder<span class="token punctuation">.</span><span class="token function">withDetail</span><span class="token punctuation">(</span><span class="token string">&quot;demoThreadPool&quot;</span><span class="token punctuation">,</span> <span class="token function">threadPoolInfo</span><span class="token punctuation">(</span><span class="token class-name">ThreadPoolProvider</span><span class="token punctuation">.</span><span class="token function">getDemoThreadPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        builder<span class="token punctuation">.</span><span class="token function">withDetail</span><span class="token punctuation">(</span><span class="token string">&quot;ioThreadPool&quot;</span><span class="token punctuation">,</span> <span class="token function">threadPoolInfo</span><span class="token punctuation">(</span><span class="token class-name">ThreadPoolProvider</span><span class="token punctuation">.</span><span class="token function">getIOThreadPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p>访问 <code>/admin/info</code>​ 接口, 可以看到这些数据:</p> <p><img src="/img/3593f62941da70cf33eb935af71f5bcc-20230731165210-7j59s72.png" alt=""></p> <p>此外, 如果设置开启 JMX 的话:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>spring<span class="token punctuation">.</span>jmx<span class="token punctuation">.</span>enabled<span class="token operator">=</span><span class="token boolean">true</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>可以通过 jconsole 工具, <strong>在 org.springframework.boot.Endpoint 中找到 Info 这个 MBean, 然后执行 info 操作可以看到</strong>, 刚才自定义的 InfoContributor 输出的有关两个线程池的信息:</p> <p><img src="/img/e15e60ae4bcdd390222bea123e3d5a48-20230731165210-3z7j90t.png" alt=""></p> <p>这里,再额外补充一点. 对于查看和操作 MBean, 除了使用 jconsole 之外, 可以使用 jolokia 把 JMX 转换为 HTTP 协议, 引入依赖:</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.jolokia<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>jolokia-core<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>然后就可以通过 jolokia, 来执行 <code>org.springframework.boot:type=Endpoint,name=Info</code>​ 这个 MBean 的 info 操作:</p> <p><img src="/img/5df1e9a600a853b645454bba10b45b03-20230731165210-31arqrr.png" alt=""></p> <h5 id="指标metrics是快速定位问题的-金钥匙"><a href="#指标metrics是快速定位问题的-金钥匙" class="header-anchor">#</a> 指标Metrics是快速定位问题的&quot;金钥匙&quot;</h5> <p><strong>指标是指一组和时间关联的, 衡量某个维度能力的量化数值</strong>. 通过收集指标并展现为曲线图, 饼图等图表, 可以帮助快速定位, 分析问题.</p> <p>下面通过一个实际的案例, 来看看如何通过图表快速定位问题.</p> <p>有一个外卖订单的下单和配送流程, 如下图所示. OrderController 进行下单操作, 下单操作前先判断参数, 如果参数正确调用另一个服务查询商户状态, 如果商户在营业的话继续下单, 下单成功后发一条消息到 RabbitMQ 进行异步配送流程; 然后另一个 DeliverOrderHandler 监听这条消息进行配送操作.</p> <p><img src="/img/280adbd52a421eff868c2120fc48eb71-20230731165210-z1dxxpp.png" alt=""></p> <p>对于这样一个涉及<strong>同步调用和异步调用的业务流程</strong>, 如果用户反馈下单失败, 那如何才能快速知道是哪个环节出了问题呢?</p> <p>这时, 指标体系就可以发挥作用了. 可以分别为下单和配送这两个重要操作, 建立一些指标进行监控.</p> <p>对于下单操作, 可以建立 4 个指标:</p> <ol><li>下单总数量指标, 监控整个系统当前累计的下单量;</li> <li>下单请求指标, 对于每次收到下单请求, 在处理之前 +1;</li> <li>下单成功指标, 每次下单成功完成 +1;</li> <li>下单失败指标, 下单操作处理出现异常 +1, 并且把异常原因附加到指标上.</li></ol> <p>对于配送操作, 也是建立类似的 4 个指标. 可以使用 Micrometer 框架实现指标的收集, 它也是 Spring Boot Actuator 选用的指标框架. 它实现了各种指标的抽象, 常用的有三种:</p> <ol><li><strong>gauge</strong>(红色), **它反映的是指标当前的值, 是多少就是多少, 不能累计. ** 比如本例中的下单总数量指标, 又比如游戏的在线人数, JVM 当前线程数都可以认为是 gauge.</li> <li><strong>counter</strong>(绿色), <strong>每次调用一次方法值增加 1, 是可以累计的</strong>. 比如本例中的下单请求指标. 举一个例子, 如果 5 秒内调用了 10 次方法, Micrometer 也是每隔 5 秒把指标发送给后端存储系统一次, 那么它可以只发送一次值, 其值为 10.</li> <li><strong>timer</strong>(蓝色), 类似 counter, 只不过<strong>除了记录次数, 还记录耗时</strong>, 比如本例中的下单成功和下单失败两个指标.</li></ol> <p>所有的指标还可以附加一些 tags 标签, 作为补充数据. 比如当操作执行失败的时候, 就会附加一个 reason 标签到指标上.</p> <p>Micrometer 除了抽象了指标外, 还抽象了存储. 可以把 Micrometer 理解为类似 SLF4J 这样的框架, 只不过后者针对日志抽象, 而 Micrometer 是针对指标进行抽象. Micrometer 通过引入各种 registry, 可以实现无缝对接各种监控系统或时间序列数据库.</p> <p>在这个案例中, 引入了 micrometer-registry-influx 依赖, 目的是引入 Micrometer 的核心依赖, 以及通过 Micrometer 对于 <strong>InfluxDB</strong>(InfluxDB 是一个时间序列数据库, 其专长是存储指标数据)的绑定, 以实现指标数据可以保存到 InfluxDB:</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>io.micrometer<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>micrometer-registry-influx<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>然后, 修改配置文件, 启用指标输出到 InfluxDB 的开关, 配置 InfluxDB 的地址, 以及设置指标每秒在客户端聚合一次, 然后发送到 InfluxDB:</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code>management.metrics.export.influx.enabled=true
management.metrics.export.influx.uri=http://localhost:8086
management.metrics.export.influx.step=1S
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>接下来在业务逻辑中增加相关的代码来记录指标.</p> <p>下面是 OrderController 的实现, 代码中有详细注释, 就不一一说明了. 需要注意观察如何通过 Micrometer 框架, 来实现下单总数量, 下单请求, 下单成功和下单失败这四个指标:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// 下单操作, 以及商户服务的接口</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@RestController</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">&quot;order&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderController</span> <span class="token punctuation">{</span>
    <span class="token comment">// 总订单创建数量</span>
    <span class="token keyword">private</span> <span class="token class-name">AtomicLong</span> createOrderCounter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicLong</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">RabbitTemplate</span> rabbitTemplate<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">RestTemplate</span> restTemplate<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@PostConstruct</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 注册createOrder.received指标, gauge指标只需要像这样初始化一次, 直接关联到AtomicLong引用即可</span>
        <span class="token class-name">Metrics</span><span class="token punctuation">.</span><span class="token function">gauge</span><span class="token punctuation">(</span><span class="token string">&quot;createOrder.totalSuccess&quot;</span><span class="token punctuation">,</span> createOrderCounter<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 下单接口, 提供用户ID和商户ID作为入参</span>
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;createOrder&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">createOrder</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;userId&quot;</span><span class="token punctuation">)</span> <span class="token keyword">long</span> userId<span class="token punctuation">,</span> <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;merchantId&quot;</span><span class="token punctuation">)</span> <span class="token keyword">long</span> merchantId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 记录一次createOrder.received指标, 这是一个counter指标, 表示收到下单请求</span>
        <span class="token class-name">Metrics</span><span class="token punctuation">.</span><span class="token function">counter</span><span class="token punctuation">(</span><span class="token string">&quot;createOrder.received&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">increment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">Instant</span> begin <span class="token operator">=</span> <span class="token class-name">Instant</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">MILLISECONDS</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 模拟无效用户的情况, ID&lt;10为无效用户</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>userId <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">)</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;invalid user&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 查询商户服务</span>
            <span class="token class-name">Boolean</span> merchantStatus <span class="token operator">=</span> restTemplate<span class="token punctuation">.</span><span class="token function">getForObject</span><span class="token punctuation">(</span><span class="token string">&quot;http://localhost:45678/order/getMerchantStatus?merchantId=&quot;</span> <span class="token operator">+</span> merchantId<span class="token punctuation">,</span> <span class="token class-name">Boolean</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>merchantStatus <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> <span class="token operator">!</span>merchantStatus<span class="token punctuation">)</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;closed merchant&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Order</span> order <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Order</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            order<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span>createOrderCounter<span class="token punctuation">.</span><span class="token function">incrementAndGet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// gauge指标可以得到自动更新</span>
            order<span class="token punctuation">.</span><span class="token function">setUserId</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            order<span class="token punctuation">.</span><span class="token function">setMerchantId</span><span class="token punctuation">(</span>merchantId<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// 发送MQ消息</span>
            rabbitTemplate<span class="token punctuation">.</span><span class="token function">convertAndSend</span><span class="token punctuation">(</span><span class="token class-name">Consts</span><span class="token punctuation">.</span><span class="token constant">EXCHANGE</span><span class="token punctuation">,</span> <span class="token class-name">Consts</span><span class="token punctuation">.</span><span class="token constant">ROUTING_KEY</span><span class="token punctuation">,</span> order<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 记录一次createOrder.success指标, 这是一个timer指标, 表示下单成功, 同时提供耗时</span>
            <span class="token class-name">Metrics</span><span class="token punctuation">.</span><span class="token function">timer</span><span class="token punctuation">(</span><span class="token string">&quot;createOrder.success&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">record</span><span class="token punctuation">(</span><span class="token class-name">Duration</span><span class="token punctuation">.</span><span class="token function">between</span><span class="token punctuation">(</span>begin<span class="token punctuation">,</span> <span class="token class-name">Instant</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;creareOrder userId {} failed&quot;</span><span class="token punctuation">,</span> userId<span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 记录一次createOrder.failed指标, 这是一个timer指标, 表示下单失败, 同时提供耗时, 并且以tag记录失败原因</span>
            <span class="token class-name">Metrics</span><span class="token punctuation">.</span><span class="token function">timer</span><span class="token punctuation">(</span><span class="token string">&quot;createOrder.failed&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;reason&quot;</span><span class="token punctuation">,</span> ex<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">record</span><span class="token punctuation">(</span><span class="token class-name">Duration</span><span class="token punctuation">.</span><span class="token function">between</span><span class="token punctuation">(</span>begin<span class="token punctuation">,</span> <span class="token class-name">Instant</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 商户查询接口</span>
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;getMerchantStatus&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">getMerchantStatus</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;merchantId&quot;</span><span class="token punctuation">)</span> <span class="token keyword">long</span> merchantId<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
        <span class="token comment">// 只有商户ID为2的商户才是营业的</span>
        <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">MILLISECONDS</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> merchantId <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br></div></div><p>当用户 <code>ID &lt; 10</code>​ 的时候, 模拟用户数据无效的情况, 当商户 ID 不为 2 的时候模拟商户不营业的情况.</p> <p>接下来是 DeliverOrderHandler 配送服务的实现.</p> <p>其中, deliverOrder 方法监听 OrderController 发出的 MQ 消息模拟配送. 如下代码所示, 实现了配送相关四个指标的记录:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// 配送服务消息处理程序</span>
<span class="token annotation punctuation">@RestController</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">&quot;deliver&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DeliverOrderHandler</span> <span class="token punctuation">{</span>
    <span class="token comment">// 配送服务运行状态</span>
    <span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token keyword">boolean</span> deliverStatus <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">AtomicLong</span> deliverCounter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicLong</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 通过一个外部接口来改变配送状态模拟配送服务停工</span>
    <span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;status&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">status</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;status&quot;</span><span class="token punctuation">)</span> <span class="token keyword">boolean</span> status<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        deliverStatus <span class="token operator">=</span> status<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@PostConstruct</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 同样注册一个gauge指标deliverOrder.totalSuccess, 代表总的配送单量, 只需注册一次即可</span>
        <span class="token class-name">Metrics</span><span class="token punctuation">.</span><span class="token function">gauge</span><span class="token punctuation">(</span><span class="token string">&quot;deliverOrder.totalSuccess&quot;</span><span class="token punctuation">,</span> deliverCounter<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 监听MQ消息</span>
    <span class="token annotation punctuation">@RabbitListener</span><span class="token punctuation">(</span>queues <span class="token operator">=</span> <span class="token class-name">Consts</span><span class="token punctuation">.</span><span class="token constant">QUEUE_NAME</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">deliverOrder</span><span class="token punctuation">(</span><span class="token class-name">Order</span> order<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Instant</span> begin <span class="token operator">=</span> <span class="token class-name">Instant</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 对deliverOrder.received进行递增, 代表收到一次订单消息, counter类型</span>
        <span class="token class-name">Metrics</span><span class="token punctuation">.</span><span class="token function">counter</span><span class="token punctuation">(</span><span class="token string">&quot;deliverOrder.received&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">increment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>deliverStatus<span class="token punctuation">)</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;deliver outofservice&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">MILLISECONDS</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            deliverCounter<span class="token punctuation">.</span><span class="token function">incrementAndGet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 配送成功指标deliverOrder.success, timer类型</span>
            <span class="token class-name">Metrics</span><span class="token punctuation">.</span><span class="token function">timer</span><span class="token punctuation">(</span><span class="token string">&quot;deliverOrder.success&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">record</span><span class="token punctuation">(</span><span class="token class-name">Duration</span><span class="token punctuation">.</span><span class="token function">between</span><span class="token punctuation">(</span>begin<span class="token punctuation">,</span> <span class="token class-name">Instant</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;deliver Order {} failed&quot;</span><span class="token punctuation">,</span> order<span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 配送失败指标deliverOrder.failed, 同样附加了失败原因作为tags, timer类型</span>
            <span class="token class-name">Metrics</span><span class="token punctuation">.</span><span class="token function">timer</span><span class="token punctuation">(</span><span class="token string">&quot;deliverOrder.failed&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;reason&quot;</span><span class="token punctuation">,</span> ex<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">record</span><span class="token punctuation">(</span><span class="token class-name">Duration</span><span class="token punctuation">.</span><span class="token function">between</span><span class="token punctuation">(</span>begin<span class="token punctuation">,</span> <span class="token class-name">Instant</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br></div></div><p>同时模拟了一个配送服务整体状态的开关, 调用 status 接口可以修改其状态. 至此完成了场景准备, 接下来开始配置指标监控.</p> <p>首先, 来安装 Grafana. 然后进入 Grafana 配置一个 InfluxDB 数据源:</p> <p><img src="/img/9b4f759486298a55c24b9e9226622eaf-20230731165210-afg7cd4.png" alt=""></p> <p>配置好数据源之后, 就可以添加一个监控面板, 然后在面板中添加各种监控图表. 比如在一个下单次数图表中添加了下单收到, 成功和失败三个指标.</p> <p><img src="/img/9bd5cfbb9476d650d8798e0d99844989-20230731165210-gykcing.png" alt=""></p> <p>关于这张图中的配置:</p> <ol><li>红色框<strong>数据源配置</strong>, 选择刚才配置的数据源.</li> <li>蓝色框 FROM 配置, 选择指标名.</li> <li>绿色框 SELECT 配置, 选择要查询的指标字段, 也可以应用一些聚合函数. 在这里取 count 字段的值, 然后使用 sum 函数进行求和.</li> <li>紫色框 GROUP BY 配置, 配置了按 1 分钟时间粒度和 reason 字段进行分组, 这样指标的 Y 轴代表 QPM(每分钟请求数), 且每种失败的情况都会绘制单独的曲线.</li> <li>黄色框 ALIAS BY 配置中设置了每一个指标的别名, 在别名中引用了 reason 这个 tag.</li></ol> <p>类似地, 配置出一个完整的业务监控面板, 包含之前实现的 8 个指标:</p> <ol><li>配置 2 个 Gauge 图表分别呈现总订单完成次数, 总配送完成次数.</li> <li>配置 4 个 Graph 图表分别呈现下单操作的次数和性能, 以及配送操作的次数和性能.</li></ol> <p>下面进入实战, 使用 wrk 针对四种情况进行压测, 然后通过曲线来分析定位问题.</p> <p>第一种情况是, 使用合法的用户 ID 和营业的商户 ID 运行一段时间:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>wrk <span class="token operator">-</span>t <span class="token number">1</span> <span class="token operator">-</span>c <span class="token number">1</span> <span class="token operator">-</span>d <span class="token number">3600</span>s http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>localhost<span class="token operator">:</span><span class="token number">45678</span><span class="token operator">/</span>order<span class="token operator">/</span>createOrder\<span class="token operator">?</span>userId\<span class="token operator">=</span><span class="token number">20</span>\<span class="token operator">&amp;</span>merchantId\<span class="token operator">=</span><span class="token number">2</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>从监控面板可以一目了然地看到整个系统的运作情况. 可以看到, 目前系统运行良好, 不管是下单还是配送操作都是成功的, 且下单操作平均处理时间 400ms, 配送操作则是在 500ms 左右, 符合预期(注意, 下单次数曲线中的绿色和黄色两条曲线其实是重叠在一起的, 表示所有下单都成功了):</p> <p><img src="/img/7f1e89ae361af20bdc7079341204d5f4-20230731165210-gsbphx2.png" alt=""></p> <p>第二种情况是, 模拟无效用户 ID 运行一段时间:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>wrk <span class="token operator">-</span>t <span class="token number">1</span> <span class="token operator">-</span>c <span class="token number">1</span> <span class="token operator">-</span>d <span class="token number">3600</span>s http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>localhost<span class="token operator">:</span><span class="token number">45678</span><span class="token operator">/</span>order<span class="token operator">/</span>createOrder\<span class="token operator">?</span>userId\<span class="token operator">=</span><span class="token number">2</span>\<span class="token operator">&amp;</span>merchantId\<span class="token operator">=</span><span class="token number">2</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>使用无效用户下单, 显然会导致下单全部失败. 接下来就看看从监控图中是否能看到这个现象.</p> <ol><li>绿色框可以看到, 下单现在出现了 invalid user 这条蓝色的曲线, 并和绿色收到下单请求的曲线是吻合的, 表示所有下单都失败了, 原因是无效用户错误, 说明源头并没有问题.</li> <li>红色框可以看到, 虽然下单都是失败的, 但是下单操作时间从 400ms 减少为 200ms 了, 说明下单失败之前也消耗了 200ms(和代码符合). 而因为下单失败操作的响应时间减半了, 反而导致吞吐翻倍了.</li> <li>观察两个配送监控可以发现, 配送曲线出现掉 0 现象, 是因为下单失败导致的, 下单失败 MQ 消息压根就不会发出. 再注意下蓝色那条线, 可以看到配送曲线掉 0 延后于下单成功曲线的掉 0, 原因是配送走的是异步流程, 虽然从某个时刻开始下单全部失败了, 但是 MQ 队列中还有一些之前未处理的消息.</li></ol> <p><img src="/img/d414458b3c47e91d7c82f513b84ae563-20230731165210-i78f728.png" alt=""></p> <p>第三种情况是, 尝试一下因为商户不营业导致的下单失败:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>wrk <span class="token operator">-</span>t <span class="token number">1</span> <span class="token operator">-</span>c <span class="token number">1</span> <span class="token operator">-</span>d <span class="token number">3600</span>s http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>localhost<span class="token operator">:</span><span class="token number">45678</span><span class="token operator">/</span>order<span class="token operator">/</span>createOrder\<span class="token operator">?</span>userId\<span class="token operator">=</span><span class="token number">20</span>\<span class="token operator">&amp;</span>merchantId\<span class="token operator">=</span><span class="token number">1</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>下面把变化的地方圈了出来, 可以自己尝试分析一下:</p> <p><img src="/img/a947cc88b1872c789c4dfe6429ec345f-20230731165210-xpmgyp3.png" alt=""></p> <p>第四种情况是, 配送停止. 通过 curl 调用接口, 来设置配送停止开关:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>curl <span class="token operator">-</span><span class="token class-name">X</span> <span class="token constant">POST</span> 'http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>localhost<span class="token operator">:</span><span class="token number">45678</span><span class="token operator">/</span>deliver<span class="token operator">/</span>status<span class="token operator">?</span>status<span class="token operator">=</span><span class="token boolean">false</span>'
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>从监控可以看到, 从开关关闭那刻开始, 所有的配送消息全部处理失败了, 原因是 deliver outofservice, 配送操作性能从 500ms 左右到了 0ms, 说明配送失败是一个本地快速失败, 并不是因为服务超时等导致的失败. 而且虽然配送失败, 但下单操作都是正常的:</p> <p><img src="/img/bdaed9b823f1fdcdf639d9b914899726-20230731165210-21dkau0.png" alt=""></p> <p>最后希望说的是, 除了手动添加业务监控指标外, Micrometer 框架自动做了很多有关 JVM 内部各种数据的指标. 进入 InfluxDB 命令行客户端, 可以看到下面的这些表(指标), 其中前 8 个是自己建的业务指标, 后面都是框架建的 JVM, 各种组件状态的指标:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token operator">&gt;</span> <span class="token constant">USE</span> mydb
<span class="token class-name">Using</span> database mydb
<span class="token operator">&gt;</span> <span class="token constant">SHOW</span> <span class="token constant">MEASUREMENTS</span>
name<span class="token operator">:</span> measurements
name
<span class="token operator">--</span><span class="token operator">--</span>
createOrder_failed
createOrder_received
createOrder_success
createOrder_totalSuccess
deliverOrder_failed
deliverOrder_received
deliverOrder_success
deliverOrder_totalSuccess
hikaricp_connections
hikaricp_connections_acquire
hikaricp_connections_active
hikaricp_connections_creation
hikaricp_connections_idle
hikaricp_connections_max
hikaricp_connections_min
hikaricp_connections_pending
hikaricp_connections_timeout
hikaricp_connections_usage
http_server_requests
jdbc_connections_max
jdbc_connections_min
jvm_buffer_count
jvm_buffer_memory_used
jvm_buffer_total_capacity
jvm_classes_loaded
jvm_classes_unloaded
jvm_gc_live_data_size
jvm_gc_max_data_size
jvm_gc_memory_allocated
jvm_gc_memory_promoted
jvm_gc_pause
jvm_memory_committed
jvm_memory_max
jvm_memory_used
jvm_threads_daemon
jvm_threads_live
jvm_threads_peak
jvm_threads_states
logback_events
process_cpu_usage
process_files_max
process_files_open
process_start_time
process_uptime
rabbitmq_acknowledged
rabbitmq_acknowledged_published
rabbitmq_channels
rabbitmq_connections
rabbitmq_consumed
rabbitmq_failed_to_publish
rabbitmq_not_acknowledged_published
rabbitmq_published
rabbitmq_rejected
rabbitmq_unrouted_published
spring_rabbitmq_listener
system_cpu_count
system_cpu_usage
system_load_average_1m
tomcat_sessions_active_current
tomcat_sessions_active_max
tomcat_sessions_alive_max
tomcat_sessions_created
tomcat_sessions_expired
tomcat_sessions_rejected
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br></div></div><p>可以按照自己的需求, 选取其中的一些指标, 在 Grafana 中配置应用监控面板:</p> <p><img src="/img/4b4d379c82c07b8ede0b5aae5d9c082c-20230731165210-sygu3zk.png" alt=""></p> <p>看到这里, 通过监控图表来定位问题, 是不是比日志方便了很多呢?</p> <h5 id="重点回顾-24"><a href="#重点回顾-24" class="header-anchor">#</a> 重点回顾</h5> <p>今天介绍了如何使用 Spring Boot Actuaor 实现生产就绪的几个关键点, 包括健康检测, 暴露应用信息和指标监控.</p> <p>所谓磨刀不误砍柴工, 健康检测可以实现负载均衡的联动; 应用信息以及 Actuaor 提供的各种端点, 可以查看应用内部情况, 甚至对应用的一些参数进行调整; 而指标监控, 则有助于整体观察应用运行情况, 帮助快速发现和定位问题.</p> <p>其实, 完整的应用监控体系一般由三个方面构成, <strong>包括日志 Logging, 指标 Metrics 和追踪 Tracing</strong>. 其中, 日志和指标我相信你应该已经比较清楚了. 追踪一般不涉及开发工作就没有展开阐述, 就简单介绍一下. <strong>追踪也叫做全链路追踪, 比较有代表性的开源系统是 SkyWalking</strong> 和 Pinpoint. 一般而言, 接入此类系统无需额外开发, 使用其<strong>提供的 javaagent 来启动 Java 程序, 就可以通过动态修改字节码实现各种组件的改写, 以加入追踪代码</strong>(类似 AOP).</p> <p>全链路追踪的原理是:</p> <ul><li>请求进入第一个组件时, <strong>先生成一个 TraceID, 作为整个调用链(Trace)的唯一标识</strong>;</li> <li>对于每次操作, 都记录耗时和相关信息形成一个 Span 挂载到调用链上, Span 和 Span 之间同样可以形成树状关联, 出现远程调用, 跨系统调用的时候, 把 TraceID 进行透传(比如, HTTP 调用通过请求透传, MQ 消息则通过消息透传);</li> <li>把这些数据汇总提交到数据库中, 通过一个 UI 界面查询整个树状调用链.</li></ul> <p>同时一般会把 TraceID 记录到日志中, 方便实现日志和追踪的关联.</p> <p>下面用一张图对比了日志, 指标和追踪的区别和特点:</p> <p><img src="/img/04d75a27d5a88ce210a55054233b0d52-20230731165210-a4nsoxe.png" alt=""></p> <p>完善的监控体系三者缺一不可, 它们还可以相互配合, 比如<strong>通过指标发现性能问题, 通过追踪定位性能问题所在的应用和操作, 最后通过日志定位出具体请求的明细参数</strong>.</p> <h4 id="_26-数据存储-nosql与rdbms如何取长补短-相辅相成"><a href="#_26-数据存储-nosql与rdbms如何取长补短-相辅相成" class="header-anchor">#</a> 26-数据存储:NoSQL与RDBMS如何取长补短,相辅相成?</h4> <p>今天聊聊数据存储的常见错误.</p> <p>近几年, 各种非关系型数据库, 也就是 NoSQL 发展迅猛, 在项目中也非常常见. 其中不乏一些使用上的极端情况, 比如直接把关系型数据库(RDBMS)全部替换为 NoSQL, 或是在不合适的场景下错误地使用 NoSQL.</p> <p>其实, <strong>每种 NoSQL 的特点不同, 都有其要着重解决的某一方面的问题</strong>. 因此, 在使用 NoSQL 的时候, 要尽量让它去处理擅长的场景, 否则不但发挥不出它的功能和优势, 还可能会导致性能问题.</p> <p>NoSQL 一般可以分为缓存数据库, 时间序列数据库, 全文搜索数据库, 文档数据库, 图数据库等. 今天, 会以缓存数据库 Redis, 时间序列数据库 InfluxDB, 全文搜索数据库 ElasticSearch 为例, 通过一些测试案例, 聊聊这些常见 NoSQL 的特点, 以及它们擅长和不擅长的地方. 最后也还会说说 NoSQL 如何与 RDBMS 相辅相成, 来构成一套可以应对高并发的复合数据库体系.</p> <h5 id="取长补短之redis-vs-mysql"><a href="#取长补短之redis-vs-mysql" class="header-anchor">#</a> 取长补短之Redis vs MySQL</h5> <p>Redis 是一款设计简洁的缓存数据库, 数据都保存在内存中, 所以读写单一 Key 的性能非常高.</p> <p>来做一个简单测试, 分别填充 10 万条数据到 Redis 和 MySQL 中. MySQL 中的 name 字段做了索引, 相当于 Redis 的 Key, data 字段为 100 字节的数据, 相当于 Redis 的 Value:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CommonMistakesApplication</span> <span class="token punctuation">{</span>
    <span class="token comment">// 模拟10万条数据存到Redis和MySQL</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">ROWS</span> <span class="token operator">=</span> <span class="token number">100000</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">PAYLOAD</span> <span class="token operator">=</span> <span class="token class-name">IntStream</span><span class="token punctuation">.</span><span class="token function">rangeClosed</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">mapToObj</span><span class="token punctuation">(</span>__ <span class="token operator">-&gt;</span> <span class="token string">&quot;a&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">joining</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">StringRedisTemplate</span> stringRedisTemplate<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">JdbcTemplate</span> jdbcTemplate<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">StandardEnvironment</span> standardEnvironment<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">CommonMistakesApplication</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@PostConstruct</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 使用-Dspring.profiles.active=init启动程序进行初始化</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span>standardEnvironment<span class="token punctuation">.</span><span class="token function">getActiveProfiles</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">anyMatch</span><span class="token punctuation">(</span>s <span class="token operator">-&gt;</span> s<span class="token punctuation">.</span><span class="token function">equalsIgnoreCase</span><span class="token punctuation">(</span><span class="token string">&quot;init&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">initRedis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">initMySQL</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 填充数据到MySQL</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">initMySQL</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 删除表</span>
        jdbcTemplate<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token string">&quot;DROP TABLE IF EXISTS `r`;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 新建表, name字段做了索引</span>
        jdbcTemplate<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token string">&quot;CREATE TABLE `r` (\n&quot;</span> <span class="token operator">+</span>
                <span class="token string">&quot;  `id` bigint(20) NOT NULL AUTO_INCREMENT,\n&quot;</span> <span class="token operator">+</span>
                <span class="token string">&quot;  `data` varchar(2000) NOT NULL,\n&quot;</span> <span class="token operator">+</span>
                <span class="token string">&quot;  `name` varchar(20) NOT NULL,\n&quot;</span> <span class="token operator">+</span>
                <span class="token string">&quot;  PRIMARY KEY (`id`),\n&quot;</span> <span class="token operator">+</span>
                <span class="token string">&quot;  KEY `name` (`name`) USING BTREE\n&quot;</span> <span class="token operator">+</span>
                <span class="token string">&quot;) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 批量插入数据</span>
        <span class="token class-name">String</span> sql <span class="token operator">=</span> <span class="token string">&quot;INSERT INTO `r` (`data`,`name`) VALUES (?,?)&quot;</span><span class="token punctuation">;</span>

        jdbcTemplate<span class="token punctuation">.</span><span class="token function">batchUpdate</span><span class="token punctuation">(</span>sql<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">BatchPreparedStatementSetter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setValues</span><span class="token punctuation">(</span><span class="token class-name">PreparedStatement</span> preparedStatement<span class="token punctuation">,</span> <span class="token keyword">int</span> i<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">SQLException</span> <span class="token punctuation">{</span>
                preparedStatement<span class="token punctuation">.</span><span class="token function">setString</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token constant">PAYLOAD</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                preparedStatement<span class="token punctuation">.</span><span class="token function">setString</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">&quot;item&quot;</span> <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getBatchSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token constant">ROWS</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;init mysql finished with count {}&quot;</span><span class="token punctuation">,</span> jdbcTemplate<span class="token punctuation">.</span><span class="token function">queryForObject</span><span class="token punctuation">(</span><span class="token string">&quot;SELECT COUNT(*) FROM `r`&quot;</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 填充数据到Redis</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">initRedis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">IntStream</span><span class="token punctuation">.</span><span class="token function">rangeClosed</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token constant">ROWS</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>i <span class="token operator">-&gt;</span> stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">&quot;item&quot;</span> <span class="token operator">+</span> i<span class="token punctuation">,</span> <span class="token constant">PAYLOAD</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;init redis finished with count {}&quot;</span><span class="token punctuation">,</span> stringRedisTemplate<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span><span class="token string">&quot;item*&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br></div></div><p>启动程序后, 输出了如下日志, 数据全部填充完毕:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token punctuation">[</span><span class="token number">14</span><span class="token operator">:</span><span class="token number">22</span><span class="token operator">:</span><span class="token number">47.195</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>main<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token constant">INFO</span> <span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>g<span class="token punctuation">.</span>t<span class="token punctuation">.</span>c<span class="token punctuation">.</span>n<span class="token punctuation">.</span>r<span class="token punctuation">.</span></span>CommonMistakesApplication</span><span class="token operator">:</span><span class="token number">80</span>  <span class="token punctuation">]</span> <span class="token operator">-</span> init redis finished <span class="token keyword">with</span> <span class="token namespace">count</span> <span class="token number">100000</span>
<span class="token punctuation">[</span><span class="token number">14</span><span class="token operator">:</span><span class="token number">22</span><span class="token operator">:</span><span class="token number">50.030</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>main<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token constant">INFO</span> <span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>g<span class="token punctuation">.</span>t<span class="token punctuation">.</span>c<span class="token punctuation">.</span>n<span class="token punctuation">.</span>r<span class="token punctuation">.</span></span>CommonMistakesApplication</span><span class="token operator">:</span><span class="token number">74</span>  <span class="token punctuation">]</span> <span class="token operator">-</span> init mysql finished <span class="token keyword">with</span> <span class="token namespace">count</span> <span class="token number">100000</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>然后, 比较一下从 MySQL 和 Redis 随机读取单条数据的性能. &quot;公平&quot; 起见, 像 Redis 那样, 使用 MySQL 时也根据 Key 来查 Value, 也就是根据 name 字段来查 data 字段, 并且给 name 字段做了索引:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Autowired</span>
<span class="token keyword">private</span> <span class="token class-name">JdbcTemplate</span> jdbcTemplate<span class="token punctuation">;</span>

<span class="token annotation punctuation">@Autowired</span>
<span class="token keyword">private</span> <span class="token class-name">StringRedisTemplate</span> stringRedisTemplate<span class="token punctuation">;</span>

<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;redis&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">redis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 使用随机的Key来查询Value, 结果应该等于PAYLOAD</span>
    <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">assertTrue</span><span class="token punctuation">(</span>stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;item&quot;</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token class-name">ThreadLocalRandom</span><span class="token punctuation">.</span><span class="token function">current</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span><span class="token class-name">CommonMistakesApplication</span><span class="token punctuation">.</span><span class="token constant">ROWS</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token class-name">CommonMistakesApplication</span><span class="token punctuation">.</span><span class="token constant">PAYLOAD</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;mysql&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">mysql</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 根据随机name来查data, name字段有索引, 结果应该等于PAYLOAD</span>
    <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">assertTrue</span><span class="token punctuation">(</span>jdbcTemplate<span class="token punctuation">.</span><span class="token function">queryForObject</span><span class="token punctuation">(</span><span class="token string">&quot;SELECT data FROM `r` WHERE name=?&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token string">&quot;item&quot;</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token class-name">ThreadLocalRandom</span><span class="token punctuation">.</span><span class="token function">current</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span><span class="token class-name">CommonMistakesApplication</span><span class="token punctuation">.</span><span class="token constant">ROWS</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token class-name">CommonMistakesApplication</span><span class="token punctuation">.</span><span class="token constant">PAYLOAD</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>在我的电脑上, 使用 wrk 加 10 个线程 50 个并发连接做压测. 可以看到, MySQL 90% 的请求需要 61ms, QPS 为 1460; <strong>而 Redis 90% 的请求在 5ms 左右, QPS 达到了 14008, 几乎是 MySQL 的十倍</strong>:</p> <p><img src="/img/4d106f70f6cf72df29a5dfbee4601055-20230731165210-4ry1ud3.png" alt=""></p> <p><strong>但 Redis 薄弱的地方是, 不擅长做 Key 的搜索</strong>. 对 MySQL, 可以使用 LIKE 操作前匹配走 B+ 树索引实现快速搜索; 但对 Redis, 使用 Keys 命令对 Key 的搜索, 其实相当于在 MySQL 里做<strong>全表扫描</strong>.</p> <p>写一段代码来对比一下性能:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;redis2&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">redis2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">assertTrue</span><span class="token punctuation">(</span>stringRedisTemplate<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span><span class="token string">&quot;item71*&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token generics"><span class="token punctuation">&lt;</span>mark<span class="token punctuation">&gt;</span></span> <span class="token number">1111</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;mysql2&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">mysql2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">assertTrue</span><span class="token punctuation">(</span>jdbcTemplate<span class="token punctuation">.</span><span class="token function">queryForList</span><span class="token punctuation">(</span><span class="token string">&quot;SELECT name FROM `r` WHERE name LIKE 'item71%'&quot;</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span><span class="token operator">/</span>mark<span class="token operator">&gt;</span> <span class="token number">1111</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>可以看到, 在 QPS 方面, **MySQL 的 QPS 达到了 Redis 的 157 倍; 在延迟方面, MySQL 的延迟只有 Redis 的十分之一. **</p> <p><img src="/img/3f89b11667e648be76f41622b0f22f66-20230731165210-xi2fi9z.png" alt=""></p> <p>Redis 慢的原因有两个:</p> <ol><li>Redis 的 Keys 命令是 O(n) 时间复杂度. 如果数据库中 Key 的数量很多, 就会非常慢.</li> <li>Redis 是<strong>单线程</strong>的, 对于慢的命令如果有并发, 串行执行就会非常耗时.</li></ol> <p>一般而言, 使用 Redis 都是<strong>针对某一个 Key 来使用</strong>, 而不能在业务代码中使用 Keys 命令从 Redis 中 &quot;搜索数据&quot;, 因为这不是 Redis 的擅长. 对于 Key 的搜索, 可以先通过关系型数据库进行, 然后再从 Redis 存取数据(如果实在需要搜索 Key 可以使用 SCAN 命令). 在生产环境中, 一般也会配置 Redis 禁用类似 Keys 这种比较危险的命令.</p> <p>总结一下, 正如 &quot;缓存设计&quot; 一讲中提到的, 对于业务开发来说, 大多数业务场景下 Redis 是作为关系型数据库的辅助用于缓存的, 一般不会把它当作数据库独立使用.</p> <p>此外值得一提的是, Redis 提供了丰富的数据结构(Set, SortedSet, Hash, List), 并围绕这些数据结构提供了丰富的 API. 如果好好利用这个特点的话, 可以直接在 Redis 中完成一部分服务端计算, 避免 &quot;读取缓存 -&gt; 计算数据 -&gt; 保存缓存&quot; 三部曲中的读取和保存缓存的开销, 进一步提高性能.</p> <h5 id="取长补短之influxdb-vs-mysql"><a href="#取长补短之influxdb-vs-mysql" class="header-anchor">#</a> 取长补短之InfluxDB vs MySQL</h5> <p><strong>InfluxDB 是一款优秀的时序数据库</strong>. 在 &quot;生产就绪&quot; 这一讲就是使用 InfluxDB 来做的 Metrics 打点. 时序数据库的优势, 在于<strong>处理指标数据的聚合, 并且读写效率非常高</strong>.</p> <p>同样的, 使用一些测试来对比下 InfluxDB 和 MySQL 的性能.</p> <p>在如下代码中, 分别填充了 1000 万条数据到 MySQL 和 InfluxDB 中. 其中, 每条数据只有 ID, 时间戳, 10000 以内的随机值这 3 列信息, 对于 MySQL 把时间戳列做了索引:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CommonMistakesApplication</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">CommonMistakesApplication</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 测试数据量</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">ROWS</span> <span class="token operator">=</span> <span class="token number">10000000</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">JdbcTemplate</span> jdbcTemplate<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">StandardEnvironment</span> standardEnvironment<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@PostConstruct</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 使用-Dspring.profiles.active=init启动程序进行初始化</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span>standardEnvironment<span class="token punctuation">.</span><span class="token function">getActiveProfiles</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">anyMatch</span><span class="token punctuation">(</span>s <span class="token operator">-&gt;</span> s<span class="token punctuation">.</span><span class="token function">equalsIgnoreCase</span><span class="token punctuation">(</span><span class="token string">&quot;init&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">initInfluxDB</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">initMySQL</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 初始化MySQL</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">initMySQL</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">long</span> begin <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        jdbcTemplate<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token string">&quot;DROP TABLE IF EXISTS `m`;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 只有ID, 值和时间戳三列</span>
        jdbcTemplate<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token string">&quot;CREATE TABLE `m` (\n&quot;</span> <span class="token operator">+</span>
                <span class="token string">&quot;  `id` bigint(20) NOT NULL AUTO_INCREMENT,\n&quot;</span> <span class="token operator">+</span>
                <span class="token string">&quot;  `value` bigint NOT NULL,\n&quot;</span> <span class="token operator">+</span>
                <span class="token string">&quot;  `time` timestamp NOT NULL,\n&quot;</span> <span class="token operator">+</span>
                <span class="token string">&quot;  PRIMARY KEY (`id`),\n&quot;</span> <span class="token operator">+</span>
                <span class="token string">&quot;  KEY `time` (`time`) USING BTREE\n&quot;</span> <span class="token operator">+</span>
                <span class="token string">&quot;) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> sql <span class="token operator">=</span> <span class="token string">&quot;INSERT INTO `m` (`value`,`time`) VALUES (?,?)&quot;</span><span class="token punctuation">;</span>

        <span class="token comment">// 批量插入数据</span>
        jdbcTemplate<span class="token punctuation">.</span><span class="token function">batchUpdate</span><span class="token punctuation">(</span>sql<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">BatchPreparedStatementSetter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setValues</span><span class="token punctuation">(</span><span class="token class-name">PreparedStatement</span> preparedStatement<span class="token punctuation">,</span> <span class="token keyword">int</span> i<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">SQLException</span> <span class="token punctuation">{</span>
                preparedStatement<span class="token punctuation">.</span><span class="token function">setLong</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token class-name">ThreadLocalRandom</span><span class="token punctuation">.</span><span class="token function">current</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span><span class="token number">10000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                preparedStatement<span class="token punctuation">.</span><span class="token function">setTimestamp</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token class-name">Timestamp</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span><span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">minusSeconds</span><span class="token punctuation">(</span><span class="token number">5</span> <span class="token operator">*</span> i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getBatchSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token constant">ROWS</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;init mysql finished with count {} took {}ms&quot;</span><span class="token punctuation">,</span> jdbcTemplate<span class="token punctuation">.</span><span class="token function">queryForObject</span><span class="token punctuation">(</span><span class="token string">&quot;SELECT COUNT(*) FROM `m`&quot;</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span>begin<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 初始化InfluxDB</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">initInfluxDB</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">long</span> begin <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">OkHttpClient<span class="token punctuation">.</span>Builder</span> okHttpClientBuilder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OkHttpClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">newBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">connectTimeout</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">readTimeout</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">writeTimeout</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">InfluxDB</span> influxDB <span class="token operator">=</span> <span class="token class-name">InfluxDBFactory</span><span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token string">&quot;http://127.0.0.1:8086&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;root&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;root&quot;</span><span class="token punctuation">,</span> okHttpClientBuilder<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">String</span> db <span class="token operator">=</span> <span class="token string">&quot;performance&quot;</span><span class="token punctuation">;</span>
            influxDB<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Query</span><span class="token punctuation">(</span><span class="token string">&quot;DROP DATABASE &quot;</span> <span class="token operator">+</span> db<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            influxDB<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Query</span><span class="token punctuation">(</span><span class="token string">&quot;CREATE DATABASE &quot;</span> <span class="token operator">+</span> db<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 设置数据库</span>
            influxDB<span class="token punctuation">.</span><span class="token function">setDatabase</span><span class="token punctuation">(</span>db<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 批量插入, 10000条数据刷一次, 或1秒刷一次</span>
            influxDB<span class="token punctuation">.</span><span class="token function">enableBatch</span><span class="token punctuation">(</span><span class="token class-name">BatchOptions</span><span class="token punctuation">.</span><span class="token constant">DEFAULTS</span><span class="token punctuation">.</span><span class="token function">actions</span><span class="token punctuation">(</span><span class="token number">10000</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">flushDuration</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">IntStream</span><span class="token punctuation">.</span><span class="token function">rangeClosed</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token constant">ROWS</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">mapToObj</span><span class="token punctuation">(</span>i <span class="token operator">-&gt;</span> <span class="token class-name">Point</span>
                    <span class="token punctuation">.</span><span class="token function">measurement</span><span class="token punctuation">(</span><span class="token string">&quot;m&quot;</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">addField</span><span class="token punctuation">(</span><span class="token string">&quot;value&quot;</span><span class="token punctuation">,</span> <span class="token class-name">ThreadLocalRandom</span><span class="token punctuation">.</span><span class="token function">current</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span><span class="token number">10000</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">time</span><span class="token punctuation">(</span><span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">minusSeconds</span><span class="token punctuation">(</span><span class="token number">5</span> <span class="token operator">*</span> i<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toInstant</span><span class="token punctuation">(</span><span class="token class-name">ZoneOffset</span><span class="token punctuation">.</span><span class="token constant">UTC</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toEpochMilli</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">MILLISECONDS</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>influxDB<span class="token operator">::</span><span class="token function">write</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            influxDB<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;init influxdb finished with count {} took {}ms&quot;</span><span class="token punctuation">,</span> influxDB<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Query</span><span class="token punctuation">(</span><span class="token string">&quot;SELECT COUNT(*) FROM m&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getResults</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getSeries</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getValues</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span>begin<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br></div></div><p>启动后, 程序输出了如下日志:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token punctuation">[</span><span class="token number">16</span><span class="token operator">:</span><span class="token number">08</span><span class="token operator">:</span><span class="token number">25.062</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>main<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token constant">INFO</span> <span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">-</span> init influxdb finished <span class="token keyword">with</span> <span class="token namespace">count</span> <span class="token number">1.0E7</span> took <span class="token number">54280</span>ms
<span class="token punctuation">[</span><span class="token number">16</span><span class="token operator">:</span><span class="token number">11</span><span class="token operator">:</span><span class="token number">50.462</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>main<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token constant">INFO</span> <span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">-</span> init mysql finished <span class="token keyword">with</span> <span class="token namespace">count</span> <span class="token number">10000000</span> took <span class="token number">205394</span>ms
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>InfluxDB 批量插入 1000 万条数据仅用了 54 秒, 相当于每秒插入 18 万条数据, 速度相当快; MySQL 的批量插入, 速度也挺快达到了每秒 4.8 万.</p> <p>接下来测试一下.</p> <p>对这 1000 万数据进行一个统计, 查询最近 60 天的数据, 按照 1 小时的时间粒度聚合, 统计 value 列的最大值, 最小值和平均值, 并将统计结果绘制成曲线图:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Autowired</span>
<span class="token keyword">private</span> <span class="token class-name">JdbcTemplate</span> jdbcTemplate<span class="token punctuation">;</span>

<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;mysql&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">mysql</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">long</span> begin <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 使用SQL从MySQL查询, 按照小时分组</span>
    <span class="token class-name">Object</span> result <span class="token operator">=</span> jdbcTemplate<span class="token punctuation">.</span><span class="token function">queryForList</span><span class="token punctuation">(</span><span class="token string">&quot;SELECT date_format(time,'%Y%m%d%H'),max(value),min(value),avg(value) FROM m WHERE time&gt;now()- INTERVAL 60 DAY GROUP BY date_format(time,'%Y%m%d%H')&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;took {} ms result {}&quot;</span><span class="token punctuation">,</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> begin<span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;influxdb&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">influxdb</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">long</span> begin <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">InfluxDB</span> influxDB <span class="token operator">=</span> <span class="token class-name">InfluxDBFactory</span><span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token string">&quot;http://127.0.0.1:8086&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;root&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;root&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 切换数据库</span>
        influxDB<span class="token punctuation">.</span><span class="token function">setDatabase</span><span class="token punctuation">(</span><span class="token string">&quot;performance&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//I nfluxDB的查询语法InfluxQL类似SQL</span>
        <span class="token class-name">Object</span> result <span class="token operator">=</span> influxDB<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Query</span><span class="token punctuation">(</span><span class="token string">&quot;SELECT MEAN(value),MIN(value),MAX(value) FROM m WHERE time &gt; now() - 60d GROUP BY TIME(1h)&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;took {} ms result {}&quot;</span><span class="token punctuation">,</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> begin<span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><p>因为数据量非常大, 单次查询就已经很慢了, 所以这次不进行压测. 分别调用两个接口, 可以看到 <strong>MySQL 查询一次耗时 29 秒左右, 而 InfluxDB 耗时 980ms</strong>:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token punctuation">[</span><span class="token constant">INFO</span><span class="token punctuation">]</span> <span class="token operator">-</span> took <span class="token number">28919</span> ms result <span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token function">date_format</span><span class="token punctuation">(</span>time<span class="token punctuation">,</span>'<span class="token operator">%</span><span class="token class-name">Y</span><span class="token operator">%</span>m<span class="token operator">%</span>d<span class="token operator">%</span><span class="token class-name">H</span>'<span class="token punctuation">)</span><span class="token operator">=</span><span class="token number">2019121308</span><span class="token punctuation">,</span> <span class="token function">max</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token operator">=</span><span class="token number">9993</span><span class="token punctuation">,</span> <span class="token function">min</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token function">avg</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token operator">=</span><span class="token number">5129.5639</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token function">date_format</span><span class="token punctuation">(</span>time<span class="token punctuation">,</span>'<span class="token operator">%</span><span class="token class-name">Y</span><span class="token operator">%</span>m<span class="token operator">%</span>d<span class="token operator">%</span><span class="token class-name">H</span>'<span class="token punctuation">)</span><span class="token operator">=</span><span class="token number">2019121309</span><span class="token punctuation">,</span> <span class="token function">max</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token operator">=</span><span class="token number">9990</span><span class="token punctuation">,</span> <span class="token function">min</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token operator">=</span><span class="token number">12</span><span class="token punctuation">,</span> <span class="token function">avg</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token operator">=</span><span class="token number">4856.0556</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token function">date_format</span><span class="token punctuation">(</span>time<span class="token punctuation">,</span>'<span class="token operator">%</span><span class="token class-name">Y</span><span class="token operator">%</span>m<span class="token operator">%</span>d<span class="token operator">%</span><span class="token class-name">H</span>'<span class="token punctuation">)</span><span class="token operator">=</span><span class="token number">2019121310</span><span class="token punctuation">,</span> <span class="token function">max</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token operator">=</span><span class="token number">9998</span><span class="token punctuation">,</span> <span class="token function">min</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token operator">=</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token function">avg</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token operator">=</span><span class="token number">4948.9347</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token function">date_format</span><span class="token punctuation">(</span>time<span class="token punctuation">,</span>'<span class="token operator">%</span><span class="token class-name">Y</span><span class="token operator">%</span>m<span class="token operator">%</span>d<span class="token operator">%</span><span class="token class-name">H</span>'<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">[</span><span class="token constant">INFO</span><span class="token punctuation">]</span> <span class="token operator">-</span> took <span class="token number">981</span> ms result <span class="token class-name">QueryResult</span> <span class="token punctuation">[</span>results<span class="token operator">=</span><span class="token punctuation">[</span><span class="token class-name">Result</span> <span class="token punctuation">[</span>series<span class="token operator">=</span><span class="token punctuation">[</span><span class="token class-name">Series</span> <span class="token punctuation">[</span>name<span class="token operator">=</span>m<span class="token punctuation">,</span> tags<span class="token operator">=</span><span class="token keyword">null</span><span class="token punctuation">,</span> columns<span class="token operator">=</span><span class="token punctuation">[</span>time<span class="token punctuation">,</span> mean<span class="token punctuation">,</span> min<span class="token punctuation">,</span> max<span class="token punctuation">]</span><span class="token punctuation">,</span> values<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">2019</span><span class="token operator">-</span><span class="token number">12</span><span class="token operator">-</span><span class="token number">13</span><span class="token constant">T08</span><span class="token operator">:</span><span class="token number">00</span><span class="token operator">:</span><span class="token number">00</span>Z<span class="token punctuation">,</span> <span class="token number">5249.2468619246865</span><span class="token punctuation">,</span> <span class="token number">21.0</span><span class="token punctuation">,</span> <span class="token number">9992.0</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>在按照时间区间聚合的案例上, 看到了 InfluxDB 的性能优势. 但<strong>肯定不能把 InfluxDB 当作普通数据库</strong>, 原因是:</p> <ol><li><strong>InfluxDB 不支持数据更新操作, 毕竟时间数据只能随着时间产生新数据, 肯定无法对过去的数据做修改</strong>;</li> <li>从数据结构上说, <strong>时间序列数据数据没有单一的主键标识, 必须包含时间戳, 数据只能和时间戳进行关联</strong>, 不适合普通业务数据.</li></ol> <p><strong>此外需要注意, 即便只是使用 InfluxDB 保存和时间相关的指标数据, 也要注意不能滥用 tag</strong>.</p> <p>InfluxDB 提供的 tag 功能, 可以为每一个指标设置多个标签, 并且 tag 有索引, 可以对 tag 进行条件搜索或分组. 但 tag 只能保存有限的, 可枚举的标签, 不能保存 URL 等信息, 否则可能会出现high series cardinality 问题, 导致占用大量内存, 甚至是 OOM. 可以点击这里, 查看 series 和内存占用的关系. 对于 InfluxDB, 无法把 URL 这种原始数据保存到数据库中, 只能把数据进行归类, 形成有限的 tag 进行保存.</p> <p>总结一下, 对于 MySQL 而言, 针对大量的数据使用全表扫描的方式来聚合统计指标数据, 性能非常差, 一般只能作为临时方案来使用. 此时, 引入 InfluxDB 之类的时间序列数据库, 就很有必要了. 时间序列数据库可以作为特定场景(比如监控, 统计)的主存储, 也可以和关系型数据库搭配使用, 作为一个辅助数据源, 保存业务系统的指标数据.</p> <h5 id="取长补短之elasticsearch-vs-mysql"><a href="#取长补短之elasticsearch-vs-mysql" class="header-anchor">#</a> 取长补短之Elasticsearch vs MySQL</h5> <p>Elasticsearch(以下简称 ES), 是目前非常流行的分布式搜索和分析数据库, 独特的<strong>倒排索引</strong>结构尤其适合进行<strong>全文搜索</strong>.</p> <p>简单来讲, <strong>倒排索引可以认为是一个 Map, 其 Key 是分词之后的关键字, Value 是文档 ID / 片段 ID 的列表</strong>. 只要输入需要搜索的单词, 就可以直接在这个 Map 中得到所有包含这个单词的文档 ID/ 片段 ID 列表, 然后再根据其中的文档 ID/ 片段 ID 查询出实际的文档内容.</p> <p>来测试一下, 对比下使用 ES 进行关键字全文搜索, 在 MySQL 中使用 LIKE 进行搜索的效率差距.</p> <p>首先, 定义一个实体 News, 包含新闻分类, 标题, 内容等字段. 这个实体同时会用作 Spring Data JPA 和 Spring Data Elasticsearch 的实体:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Entity</span>
<span class="token annotation punctuation">@Document</span><span class="token punctuation">(</span>indexName <span class="token operator">=</span> <span class="token string">&quot;news&quot;</span><span class="token punctuation">,</span> replicas <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment">// @Document注解定义了这是一个ES的索引, 索引名称news, 数据不需要冗余</span>
<span class="token annotation punctuation">@Table</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;news&quot;</span><span class="token punctuation">,</span> indexes <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token annotation punctuation">@Index</span><span class="token punctuation">(</span>columnList <span class="token operator">=</span> <span class="token string">&quot;cateid&quot;</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token comment">// @Table注解定义了这是一个MySQL表, 表名news, 对cateid列做索引</span>
<span class="token annotation punctuation">@Data</span>
<span class="token annotation punctuation">@AllArgsConstructor</span>
<span class="token annotation punctuation">@NoArgsConstructor</span>
<span class="token annotation punctuation">@DynamicUpdate</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">News</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Id</span>
    <span class="token keyword">private</span> <span class="token keyword">long</span> id<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Field</span><span class="token punctuation">(</span>type <span class="token operator">=</span> <span class="token class-name">FieldType<span class="token punctuation">.</span>Keyword</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> category<span class="token punctuation">;</span><span class="token comment">// 新闻分类名称</span>

    <span class="token keyword">private</span> <span class="token keyword">int</span> cateid<span class="token punctuation">;</span><span class="token comment">// 新闻分类ID</span>

    <span class="token annotation punctuation">@Column</span><span class="token punctuation">(</span>columnDefinition <span class="token operator">=</span> <span class="token string">&quot;varchar(500)&quot;</span><span class="token punctuation">)</span><span class="token comment">// @Column注解定义了在MySQL中字段, 比如这里定义title列的类型是varchar(500)</span>
    <span class="token annotation punctuation">@Field</span><span class="token punctuation">(</span>type <span class="token operator">=</span> <span class="token class-name">FieldType<span class="token punctuation">.</span>Text</span><span class="token punctuation">,</span> analyzer <span class="token operator">=</span> <span class="token string">&quot;ik_max_word&quot;</span><span class="token punctuation">,</span> searchAnalyzer <span class="token operator">=</span> <span class="token string">&quot;ik_smart&quot;</span><span class="token punctuation">)</span><span class="token comment">// @Field注解定义了ES字段的格式, 使用ik分词器进行分词</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> title<span class="token punctuation">;</span><span class="token comment">// 新闻标题</span>

    <span class="token annotation punctuation">@Column</span><span class="token punctuation">(</span>columnDefinition <span class="token operator">=</span> <span class="token string">&quot;text&quot;</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@Field</span><span class="token punctuation">(</span>type <span class="token operator">=</span> <span class="token class-name">FieldType<span class="token punctuation">.</span>Text</span><span class="token punctuation">,</span> analyzer <span class="token operator">=</span> <span class="token string">&quot;ik_max_word&quot;</span><span class="token punctuation">,</span> searchAnalyzer <span class="token operator">=</span> <span class="token string">&quot;ik_smart&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> content<span class="token punctuation">;</span><span class="token comment">// 新闻内容</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><p>接下来实现主程序. 在启动时, 会从一个 csv 文件中加载 4000 条新闻数据, 然后复制 100 份, 拼成 40 万条数据, 分别写入 MySQL 和 ES:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@EnableElasticsearchRepositories</span><span class="token punctuation">(</span>includeFilters <span class="token operator">=</span> <span class="token annotation punctuation">@ComponentScan.Filter</span><span class="token punctuation">(</span>type <span class="token operator">=</span> <span class="token class-name">FilterType</span><span class="token punctuation">.</span><span class="token constant">ASSIGNABLE_TYPE</span><span class="token punctuation">,</span> value <span class="token operator">=</span> <span class="token class-name">NewsESRepository</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">//明确设置哪个是ES的Repository</span>
<span class="token annotation punctuation">@EnableJpaRepositories</span><span class="token punctuation">(</span>excludeFilters <span class="token operator">=</span> <span class="token annotation punctuation">@ComponentScan.Filter</span><span class="token punctuation">(</span>type <span class="token operator">=</span> <span class="token class-name">FilterType</span><span class="token punctuation">.</span><span class="token constant">ASSIGNABLE_TYPE</span><span class="token punctuation">,</span> value <span class="token operator">=</span> <span class="token class-name">NewsESRepository</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">//其他的是MySQL的Repository</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CommonMistakesApplication</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Utils</span><span class="token punctuation">.</span><span class="token function">loadPropertySource</span><span class="token punctuation">(</span><span class="token class-name">CommonMistakesApplication</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token string">&quot;es.properties&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">CommonMistakesApplication</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">StandardEnvironment</span> standardEnvironment<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">NewsESRepository</span> newsESRepository<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">NewsMySQLRepository</span> newsMySQLRepository<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@PostConstruct</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 使用-Dspring.profiles.active=init启动程序进行初始化</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span>standardEnvironment<span class="token punctuation">.</span><span class="token function">getActiveProfiles</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">anyMatch</span><span class="token punctuation">(</span>s <span class="token operator">-&gt;</span> s<span class="token punctuation">.</span><span class="token function">equalsIgnoreCase</span><span class="token punctuation">(</span><span class="token string">&quot;init&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// csv中的原始数据只有4000条</span>
            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">News</span><span class="token punctuation">&gt;</span></span> news <span class="token operator">=</span> <span class="token function">loadData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">AtomicLong</span> atomicLong <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicLong</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            news<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>item <span class="token operator">-&gt;</span> item<span class="token punctuation">.</span><span class="token function">setTitle</span><span class="token punctuation">(</span><span class="token string">&quot;%%&quot;</span> <span class="token operator">+</span> item<span class="token punctuation">.</span><span class="token function">getTitle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 模拟100倍的数据量, 也就是40万条</span>
            <span class="token class-name">IntStream</span><span class="token punctuation">.</span><span class="token function">rangeClosed</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>repeat <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
                news<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>item <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
                    <span class="token comment">// 重新设置主键ID</span>
                    item<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span>atomicLong<span class="token punctuation">.</span><span class="token function">incrementAndGet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">// 每次复制数据稍微改一下title字段, 在前面加上一个数字, 代表这是第几次复制</span>
                    item<span class="token punctuation">.</span><span class="token function">setTitle</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span><span class="token function">getTitle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replaceFirst</span><span class="token punctuation">(</span><span class="token string">&quot;%%&quot;</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>repeat<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token function">initMySQL</span><span class="token punctuation">(</span>news<span class="token punctuation">,</span> repeat <span class="token generics"><span class="token punctuation">&lt;</span>mark<span class="token punctuation">&gt;</span></span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;init MySQL finished for {}&quot;</span><span class="token punctuation">,</span> repeat<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">initES</span><span class="token punctuation">(</span>news<span class="token punctuation">,</span> repeat <span class="token operator">&lt;</span><span class="token operator">/</span>mark<span class="token operator">&gt;</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;init ES finished for {}&quot;</span><span class="token punctuation">,</span> repeat<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 从news.csv中解析得到原始数据</span>
    <span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">News</span><span class="token punctuation">&gt;</span></span> <span class="token function">loadData</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 使用jackson-dataformat-csv实现csv到POJO的转换</span>
        <span class="token class-name">CsvMapper</span> csvMapper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CsvMapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">CsvSchema</span> schema <span class="token operator">=</span> <span class="token class-name">CsvSchema</span><span class="token punctuation">.</span><span class="token function">emptySchema</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">withHeader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ObjectReader</span> objectReader <span class="token operator">=</span> csvMapper<span class="token punctuation">.</span><span class="token function">readerFor</span><span class="token punctuation">(</span><span class="token class-name">News</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">with</span><span class="token punctuation">(</span>schema<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ClassLoader</span> classLoader <span class="token operator">=</span> <span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">File</span> file <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>classLoader<span class="token punctuation">.</span><span class="token function">getResource</span><span class="token punctuation">(</span><span class="token string">&quot;news.csv&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">Reader</span> reader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileReader</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> objectReader<span class="token punctuation">.</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">News</span><span class="token punctuation">&gt;</span></span><span class="token function">readValues</span><span class="token punctuation">(</span>reader<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">readAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 把数据保存到ES中</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">initES</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">News</span><span class="token punctuation">&gt;</span></span> news<span class="token punctuation">,</span> <span class="token keyword">boolean</span> clear<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>clear<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 首次调用的时候先删除历史数据</span>
            newsESRepository<span class="token punctuation">.</span><span class="token function">deleteAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        newsESRepository<span class="token punctuation">.</span><span class="token function">saveAll</span><span class="token punctuation">(</span>news<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 把数据保存到MySQL中</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">initMySQL</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">News</span><span class="token punctuation">&gt;</span></span> news<span class="token punctuation">,</span> <span class="token keyword">boolean</span> clear<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>clear<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 首次调用的时候先删除历史数据</span>
            newsMySQLRepository<span class="token punctuation">.</span><span class="token function">deleteAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        newsMySQLRepository<span class="token punctuation">.</span><span class="token function">saveAll</span><span class="token punctuation">(</span>news<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br></div></div><p>由于使用了 Spring Data, 直接定义两个 Repository, 然后直接定义查询方法, 无需实现任何逻辑即可实现查询, <strong>Spring Data 会根据方法名生成相应的 SQL 语句和 ES 查询 DSL</strong>.</p> <p>在这里, 定义一个 countByCateidAndContentContainingAndContentContaining 方法, 代表查询条件是: 搜索分类等于 cateid 参数, 且内容同时包含关键字 keyword1 和 keyword2, 计算符合条件的新闻总数量:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Repository</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">NewsMySQLRepository</span> <span class="token keyword">extends</span> <span class="token class-name">JpaRepository</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">News</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
    <span class="token comment">// JPA: 搜索分类等于cateid参数, 且内容同时包含关键字keyword1和keyword2, 计算符合条件的新闻总数量</span>
    <span class="token keyword">long</span> <span class="token function">countByCateidAndContentContainingAndContentContaining</span><span class="token punctuation">(</span><span class="token keyword">int</span> cateid<span class="token punctuation">,</span> <span class="token class-name">String</span> keyword1<span class="token punctuation">,</span> <span class="token class-name">String</span> keyword2<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@Repository</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">NewsESRepository</span> <span class="token keyword">extends</span> <span class="token class-name">ElasticsearchRepository</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">News</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
    <span class="token comment">// ES: 搜索分类等于cateid参数, 且内容同时包含关键字keyword1和keyword2, 计算符合条件的新闻总数量</span>
    <span class="token keyword">long</span> <span class="token function">countByCateidAndContentContainingAndContentContaining</span><span class="token punctuation">(</span><span class="token keyword">int</span> cateid<span class="token punctuation">,</span> <span class="token class-name">String</span> keyword1<span class="token punctuation">,</span> <span class="token class-name">String</span> keyword2<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>对于 ES 和 MySQL, 使用相同的条件进行搜索, 搜素分类是 1, 关键字是社会和苹果, 然后输出搜索结果和耗时:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// 测试MySQL搜索, 最后输出耗时和结果</span>
<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;mysql&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">mysql</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;cateid&quot;</span><span class="token punctuation">,</span> defaultValue <span class="token operator">=</span> <span class="token string">&quot;1&quot;</span><span class="token punctuation">)</span> <span class="token keyword">int</span> cateid<span class="token punctuation">,</span>
                  <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;keyword1&quot;</span><span class="token punctuation">,</span> defaultValue <span class="token operator">=</span> <span class="token string">&quot;社会&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> keyword1<span class="token punctuation">,</span>
                  <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;keyword2&quot;</span><span class="token punctuation">,</span> defaultValue <span class="token operator">=</span> <span class="token string">&quot;苹果&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> keyword2<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">long</span> begin <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Object</span> result <span class="token operator">=</span> newsMySQLRepository<span class="token punctuation">.</span><span class="token function">countByCateidAndContentContainingAndContentContaining</span><span class="token punctuation">(</span>cateid<span class="token punctuation">,</span> keyword1<span class="token punctuation">,</span> keyword2<span class="token punctuation">)</span><span class="token punctuation">;</span>
    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;took {} ms result {}&quot;</span><span class="token punctuation">,</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> begin<span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 测试ES搜索, 最后输出耗时和结果</span>
<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;es&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">es</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;cateid&quot;</span><span class="token punctuation">,</span> defaultValue <span class="token operator">=</span> <span class="token string">&quot;1&quot;</span><span class="token punctuation">)</span> <span class="token keyword">int</span> cateid<span class="token punctuation">,</span>
               <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;keyword1&quot;</span><span class="token punctuation">,</span> defaultValue <span class="token operator">=</span> <span class="token string">&quot;社会&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> keyword1<span class="token punctuation">,</span>
               <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;keyword2&quot;</span><span class="token punctuation">,</span> defaultValue <span class="token operator">=</span> <span class="token string">&quot;苹果&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> keyword2<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">long</span> begin <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Object</span> result <span class="token operator">=</span> newsESRepository<span class="token punctuation">.</span><span class="token function">countByCateidAndContentContainingAndContentContaining</span><span class="token punctuation">(</span>cateid<span class="token punctuation">,</span> keyword1<span class="token punctuation">,</span> keyword2<span class="token punctuation">)</span><span class="token punctuation">;</span>
    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;took {} ms result {}&quot;</span><span class="token punctuation">,</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> begin<span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p>分别调用接口可以看到, <strong>ES 耗时仅仅 48ms, MySQL 耗时 6 秒多是 ES 的 100 倍</strong>. 很遗憾, 虽然新闻分类 ID 已经建了索引, 但是这个索引只能起到加速过滤分类 ID 这一单一条件的作用, 对于文本内容的全文搜索, B+ 树索引无能为力.</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token punctuation">[</span><span class="token number">22</span><span class="token operator">:</span><span class="token number">04</span><span class="token operator">:</span><span class="token number">00.951</span><span class="token punctuation">]</span><span class="token operator">-</span> took <span class="token number">48</span> ms result <span class="token number">2100</span>
<span class="token class-name">Hibernate</span><span class="token operator">:</span> select <span class="token function">count</span><span class="token punctuation">(</span>news0_<span class="token punctuation">.</span>id<span class="token punctuation">)</span> as col_0_0_ from news news0_ where news0_<span class="token punctuation">.</span>cateid<span class="token operator">=</span><span class="token operator">?</span> and <span class="token punctuation">(</span>news0_<span class="token punctuation">.</span>content like <span class="token operator">?</span> escape <span class="token operator">?</span><span class="token punctuation">)</span> and <span class="token punctuation">(</span>news0_<span class="token punctuation">.</span>content like <span class="token operator">?</span> escape <span class="token operator">?</span><span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token number">22</span><span class="token operator">:</span><span class="token number">04</span><span class="token operator">:</span><span class="token number">11.946</span><span class="token punctuation">]</span><span class="token operator">-</span> took <span class="token number">6637</span> ms result <span class="token number">2100</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>但 ES 这种以索引为核心的数据库, 也不是万能的, <strong>频繁更新就是一个大问题</strong>.</p> <p>MySQL 可以做到仅更新某行数据的某个字段, <mark><strong>但 ES 里每次数据字段更新都相当于整个文档索引重建</strong></mark>. 即便 ES 提供了文档部分更新的功能, 但本质上只是节省了提交文档的网络流量, 以及减少了更新冲突, 其内部实现还是文档删除后重新构建索引. 因此, 如果要在 ES 中保存一个类似计数器的值, 要实现不断更新, 其执行效率会非常低.</p> <p>来验证下, 分别使用 JdbcTemplate + SQL 语句, ElasticsearchTemplate + 自定义 UpdateQuery, 实现部分更新 MySQL 表和 ES 索引的一个字段, 每个方法都是循环更新 1000 次:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;mysql2&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">mysql2</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;id&quot;</span><span class="token punctuation">,</span> defaultValue <span class="token operator">=</span> <span class="token string">&quot;400000&quot;</span><span class="token punctuation">)</span> <span class="token keyword">long</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">long</span> begin <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 对于MySQL, 使用JdbcTemplate+SQL语句, 实现直接更新某个category字段, 更新1000次</span>
    <span class="token class-name">IntStream</span><span class="token punctuation">.</span><span class="token function">rangeClosed</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>i <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        jdbcTemplate<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token string">&quot;UPDATE `news` SET category=? WHERE id=?&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token string">&quot;test&quot;</span> <span class="token operator">+</span> i<span class="token punctuation">,</span> id<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;mysql took {} ms result {}&quot;</span><span class="token punctuation">,</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> begin<span class="token punctuation">,</span> newsMySQLRepository<span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;es2&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">es</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;id&quot;</span><span class="token punctuation">,</span> defaultValue <span class="token operator">=</span> <span class="token string">&quot;400000&quot;</span><span class="token punctuation">)</span> <span class="token keyword">long</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">long</span> begin <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">IntStream</span><span class="token punctuation">.</span><span class="token function">rangeClosed</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>i <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">// 对于ES, 通过ElasticsearchTemplate+自定义UpdateQuery, 实现文档的部分更新</span>
        <span class="token class-name">UpdateQuery</span> updateQuery <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            updateQuery <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UpdateQueryBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">withIndexName</span><span class="token punctuation">(</span><span class="token string">&quot;news&quot;</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">withId</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">withType</span><span class="token punctuation">(</span><span class="token string">&quot;_doc&quot;</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">withUpdateRequest</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">UpdateRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">doc</span><span class="token punctuation">(</span>
                            <span class="token function">jsonBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                                    <span class="token punctuation">.</span><span class="token function">startObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                                    <span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">&quot;category&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;test&quot;</span> <span class="token operator">+</span> i<span class="token punctuation">)</span>
                                    <span class="token punctuation">.</span><span class="token function">endObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        elasticsearchTemplate<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>updateQuery<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;es took {} ms result {}&quot;</span><span class="token punctuation">,</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> begin<span class="token punctuation">,</span> newsESRepository<span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br></div></div><p>可以看到, <strong>MySQL 耗时仅仅 1.5 秒, 而 ES 耗时 6.8 秒</strong>:</p> <p><img src="/img/ba91c530741d0e6fc0b3b08ea3351de2-20230731165210-mzwvudl.png" alt=""></p> <p>ES 是一个分布式的全文搜索数据库, 所以与 MySQL 相比的优势在于文本搜索, 而且因为其分布式的特性, 可以<strong>使用一个大 ES 集群处理大规模数据的内容搜索</strong>. 但由于 ES 的索引是文档维度的, 所以<strong>不适用于频繁更新的 OLTP 业务</strong>.</p> <p>一般而言, <strong>会把 ES 和 MySQL 结合使用, MySQL 直接承担业务系统的增删改操作, 而 ES 作为辅助数据库, 直接扁平化保存一份业务数据, 用于复杂查询, 全文搜索和统计</strong>. 接下来也会继续分析这一点.</p> <h5 id="结合nosql和mysql应对高并发的复合数据库架构"><a href="#结合nosql和mysql应对高并发的复合数据库架构" class="header-anchor">#</a> 结合NoSQL和MySQL应对高并发的复合数据库架构</h5> <p>现在通过一些案例看到了 Redis, InfluxDB, ES 这些 NoSQL 数据库, 都有擅长和不擅长的场景. 那么, 有没有全能的数据库呢?</p> <p>我认为没有. <strong>每一个存储系统都有其独特的数据结构, 数据结构的设计就决定了其擅长和不擅长的场景</strong>.</p> <p>比如, MySQL InnoDB 引擎的 B+ 树对排序和范围查询友好, 频繁数据更新的代价不是太大, 因此适合 OLTP(On-Line Transaction Processing).</p> <p>又比如, ES 的 Lucene 采用了 FST(Finite State Transducer)索引 + 倒排索引, 空间效率高, 适合对变动不频繁的数据做索引, 实现全文搜索. 存储系统本身不可能对一份数据使用多种数据结构保存, 因此不可能适用于所有场景.</p> <p>虽然在大多数业务场景下, MySQL 的性能都不算太差, 但对于数据量大, 访问量大, 业务复杂的互联网应用来说, MySQL 因为实现了 ACID(原子性, 一致性, 隔离性, 持久性)会比较重, 而且横向扩展能力较差, 功能单一, 无法扛下所有数据量和流量, 无法应对所有功能需求. 因此需要<strong>通过架构手段, 来组合使用多种存储系统, 取长补短</strong>, 实现 1 + 1 &gt; 2 的效果.</p> <p>举个例子. 我们设计了一个<strong>包含多个数据库系统的, 能应对各种高并发场景的一套数据服务的系统架构</strong>, 其中包含了同步写服务, 异步写服务和查询服务三部分, 分别实现主数据库写入, 辅助数据库写入和查询路由.</p> <p>按照服务来依次分析下这个架构.</p> <p><img src="/img/a14b086fe9232b29e5dd7b4f658c73af-20230731165210-dnghczr.png" alt=""></p> <p>首先要明确的是, 重要的业务主数据只能保存在 MySQL 这样的关系型数据库中, 原因有三点:</p> <ol><li>RDBMS 经过了几十年的验证, 已经非常成熟;</li> <li>RDBMS 的用户数量众多, Bug 修复快, 版本稳定, 可靠性很高;</li> <li>RDBMS 强调 ACID, 能确保数据完整.</li></ol> <p>有两种类型的查询任务可以交给 MySQL 来做, 性能会比较好, 这也是 MySQL 擅长的地方:</p> <ol><li><strong>按照主键 ID 的查询</strong>. 直接查询聚簇索引, 其性能会很高. 但是单表数据量超过亿级后, 性能也会衰退, 而且单个数据库无法承受超大的查询并发, 因此可以把数据表进行 Sharding 操作, 均匀拆分到多个数据库实例中保存. 这套数据库集群称作 <strong>Sharding 集群</strong>.</li> <li><strong>按照各种条件进行范围查询, 查出主键 ID</strong>. 对二级索引进行查询得到主键, 只需要查询一棵 B+ 树, 效率同样很高. 但索引的值不宜过大, 比如对 varchar(1000) 进行索引不太合适, 而索引外键(一般是 int 或 bigint 类型)性能就会比较好. 因此, 可以在 MySQL 中建立一张 &quot;索引表&quot;, 除了保存主键外, 主要是保存各种关联表的外键, 以及尽可能少的 varchar 类型的字段. 这张索引表的大部分列都可以建上二级索引, 用于进行简单搜索, 搜索的结果是主键的列表, 而不是完整的数据. 由于索引表字段轻量并且数量不多(一般控制在 10 个以内), 所以即便索引表没有进行 Sharding 拆分, 问题也不会很大.</li></ol> <p>如图上蓝色线所示, 写入两种 MySQL 数据表和发送 MQ 消息的这三步, 用一个<strong>同步写服务</strong>完成了. 前面在 &quot;异步处理&quot; 中提到, <strong>所有异步流程都需要补偿, 这里的异步流程同样需要</strong>. 只不过为了简洁, 这里省略了补偿流程.</p> <p>然后, 如图中绿色线所示, 有一个<strong>异步写服务</strong>, 监听 MQ 的消息, 继续完成辅助数据的更新操作. 这里选用了 ES 和 InfluxDB 这两种辅助数据库, 因此整个异步写数据操作有三步:</p> <ul><li>MQ 消息不一定包含完整的数据, 甚至可能只包含一个最新数据的主键 ID, 需要根据 ID 从查询服务查询到完整的数据.</li> <li>写入 InfluxDB 的数据一般可以按时间间隔进行简单聚合, 定时写入 InfluxDB. 因此这里会进行简单的客户端聚合, 然后写入 InfluxDB.</li> <li>ES 不适合在各索引之间做连接(Join)操作, 适合保存扁平化的数据. 比如可以把订单下的用户, 商户, 商品列表等信息, 作为内嵌对象嵌入整个订单 JSON, 然后把整个扁平化的 JSON 直接存入 ES.</li></ul> <p>对于数据写入操作, 可以认为操作返回的时候同步数据一定是写入成功的, 但是由于各种原因, 异步数据写入无法确保立即成功, 会有一定延迟, 比如:</p> <ol><li>异步消息丢失的情况, 需要补偿处理;</li> <li>写入 ES 的索引操作本身就会比较慢;</li> <li>写入 InfluxDB 的数据需要客户端定时聚合.</li></ol> <p>因此, 对于<strong>查询服务</strong>, 如图中红色线所示, 需要根据一定的上下文条件(比如查询一致性要求, 时效性要求, 搜索的条件, 需要返回的数据字段, 搜索时间区间等)来把请求路由到合适的数据库, 并且做一些聚合处理:</p> <ol><li>需要根据主键查询单条数据, 可以从 MySQL Sharding 集群或 Redis 查询, 如果对实时性要求不高也可以从 ES 查询.</li> <li>按照多个条件搜索订单的场景, 可以从 MySQL 索引表查询出主键列表, 然后再根据主键从 MySQL Sharding 集群或 Redis 获取数据详情.</li> <li>各种后台系统需要使用比较复杂的搜索条件, 甚至全文搜索来查询订单数据, 或是定时分析任务需要一次查询大量数据, 这些场景对数据实时性要求都不高, 可以到 ES 进行搜索. 此外, MySQL 中的数据可以归档, 可以在 ES 中保留更久的数据, 而且查询历史数据一般并发不会很大, 可以统一路由到 ES 查询.</li> <li>监控系统或后台报表系统需要呈现业务监控图表或表格, 可以把请求路由到 InfluxDB 查询.</li></ol> <h5 id="重点回顾-25"><a href="#重点回顾-25" class="header-anchor">#</a> 重点回顾</h5> <p>今天通过三个案例分别对比了缓存数据库 Redis, 时间序列数据库 InfluxDB, 搜索数据库 ES 和 MySQL 的性能. 可以看到:</p> <ol><li>Redis 对单条数据的读取性能远远高于 MySQL, 但不适合进行范围搜索.</li> <li>InfluxDB 对于时间序列数据的聚合效率远远高于 MySQL, 但因为没有主键, 所以不是一个通用数据库.</li> <li><strong>ES 对关键字的全文搜索能力远远高于 MySQL, 但是字段的更新效率较低, 不适合保存频繁更新的数据.</strong></li></ol> <p>最后给出了一个混合使用 MySQL + Redis + InfluxDB + ES 的架构方案, 充分发挥了各种数据库的特长, 相互配合构成了一个可以应对各种复杂查询, 以及高并发读写的存储架构.</p> <ol><li><strong>主数据由两种 MySQL 数据表构成, 其中索引表承担简单条件的搜索来得到主键, Sharding 表承担大并发的主键查询. 主数据由同步写服务写入, 写入后发出 MQ 消息</strong>.</li> <li><strong>辅助数据可以根据需求选用合适的 NoSQL, 由单独一个或多个异步写服务监听 MQ 后异步写入</strong>.</li> <li>由统一的查询服务, 对接所有查询需求, 根据不同的查询需求路由查询到合适的存储, 确保每一个存储系统可以根据场景发挥所长, 并分散各数据库系统的查询压力.</li></ol> <h3 id="安全篇"><a href="#安全篇" class="header-anchor">#</a> 安全篇</h3> <h4 id="_27-数据源头-任何客户端的东西都不可信任"><a href="#_27-数据源头-任何客户端的东西都不可信任" class="header-anchor">#</a> 27-数据源头:任何客户端的东西都不可信任</h4> <p>今天开始要讨论几个有关<strong>安全的话题</strong>. 我发现有这么一个问题, 那就是许多做业务开发的同学往往一点点安全意识都没有. 如果有些公司没有安全部门或专家的话, 安全问题就会非常严重.</p> <p>如果只是用一些所谓的渗透服务浅层次地做一下扫描和渗透, 而不在代码和逻辑层面做进一步分析的话, 能够发现的安全问题非常有限. 要做好安全, 还是要靠一线程序员和产品经理点点滴滴的意识. 所以接下来的几篇文章, 会从业务开发的角度, 和说我们应该最应该具备的安全意识.</p> <p>对于 HTTP 请求, 要在脑子里有一个根深蒂固的概念, 那就是<mark><strong>任何客户端传过来的数据都是不能直接信任的</strong></mark>. 客户端传给服务端的数据只是信息收集, 数据需要经过有效性验证, 权限验证等后才能使用, 并且这些数据只能认为是用户操作的意图, 不能直接代表数据当前的状态.</p> <p>举一个简单的例子, 大家打游戏的时候, 客户端发给服务端的只是用户的操作, 比如移动了多少位置, 由服务端根据用户当前的状态来设置新的位置再返回给客户端. 为了防止作弊, 不可能由客户端直接告诉服务端用户当前的位置.</p> <p>因此, 客户端发给服务端的指令, <strong>代表的只是操作指令, 并不能直接决定用户的状态</strong>, 对于状态改变的计算在服务端. 而网络不好时, 往往会遇到走了 10 步又被服务端拉回来的现象, 就是因为有指令丢失, 客户端使用服务端计算的实际位置修正了客户端玩家的位置.</p> <p>今天通过四个案例来说说, 为什么 &quot;任何客户端的东西都不可信任&quot;.</p> <h5 id="客户端的计算不可信"><a href="#客户端的计算不可信" class="header-anchor">#</a> 客户端的计算不可信</h5> <p>先看一个电商下单操作的案例.</p> <p>在这个场景下, 可能会暴露这么一个 <code>/order</code>​ 的 POST 接口给客户端, 让客户端直接把组装后的订单信息 Order 传给服务端:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/order&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">wrong</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">Order</span> order<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">createOrder</span><span class="token punctuation">(</span>order<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>订单信息 Order 可能包括商品 ID, 商品价格, 数量, 商品总价:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Data</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Order</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">long</span> itemId<span class="token punctuation">;</span> <span class="token comment">// 商品ID</span>
    <span class="token keyword">private</span> <span class="token class-name">BigDecimal</span> itemPrice<span class="token punctuation">;</span> <span class="token comment">// 商品价格</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> quantity<span class="token punctuation">;</span> <span class="token comment">// 商品数量</span>
    <span class="token keyword">private</span> <span class="token class-name">BigDecimal</span> itemTotalPrice<span class="token punctuation">;</span> <span class="token comment">// 商品总价</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>虽然用户下单时客户端肯定有商品的价格等信息, 也会计算出订单的总价给用户确认, 但是这些信息<strong>只能用于呈现和核对</strong>. 即使客户端传给服务端的 POJO 中包含了这些信息, 服务端也一定要重新从数据库来初始化商品的价格, 重新计算最终的订单价格. <strong>如果不这么做的话, 很可能会被黑客利用, 商品总价被恶意修改为比较低的价格.</strong></p> <p>因此, 真正直接使用的, 可信赖的只是客户端传过来的<strong>商品 ID 和数量</strong>, 服务端会根据这些信息重新计算最终的总价. 如果服务端计算出来的商品价格和客户端传过来的价格不匹配的话, 可以给客户端友好提示, 让用户重新下单. 修改后的代码如下:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/orderRight&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">right</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">Order</span> order<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 根据ID重新查询商品</span>
    <span class="token class-name">Item</span> item <span class="token operator">=</span> <span class="token class-name">Db</span><span class="token punctuation">.</span><span class="token function">getItem</span><span class="token punctuation">(</span>order<span class="token punctuation">.</span><span class="token function">getItemId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 客户端传入的和服务端查询到的商品单价不匹配的时候, 给予友好提示</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>order<span class="token punctuation">.</span><span class="token function">getItemPrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span><span class="token function">getItemPrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;您选购的商品价格有变化, 请重新下单&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 重新设置商品单价</span>
    order<span class="token punctuation">.</span><span class="token function">setItemPrice</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span><span class="token function">getItemPrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 重新计算商品总价</span>
    <span class="token class-name">BigDecimal</span> totalPrice <span class="token operator">=</span> item<span class="token punctuation">.</span><span class="token function">getItemPrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">multiply</span><span class="token punctuation">(</span><span class="token class-name">BigDecimal</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>order<span class="token punctuation">.</span><span class="token function">getQuantity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 客户端传入的和服务端查询到的商品总价不匹配的时候, 给予友好提示</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>order<span class="token punctuation">.</span><span class="token function">getItemTotalPrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">compareTo</span><span class="token punctuation">(</span>totalPrice<span class="token punctuation">)</span><span class="token operator">!=</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;您选购的商品总价有变化, 请重新下单&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 重新设置商品总价</span>
    order<span class="token punctuation">.</span><span class="token function">setItemTotalPrice</span><span class="token punctuation">(</span>totalPrice<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">createOrder</span><span class="token punctuation">(</span>order<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><p>还有一种可行的做法是, <strong>让客户端仅传入需要的数据给服务端</strong>, 像这样重新定义一个 POJO CreateOrderRequest 作为接口入参, 比直接使用领域模型 Order 更合理. 在设计接口时, 会思考哪些数据需要客户端提供, 而不是把一个大而全的对象作为参数提供给服务端, 以避免因为忘记在服务端重置客户端数据而导致的安全问题.</p> <p>下单成功后, 服务端处理完成后会返回诸如商品单价, 总价等信息给客户端. 此时客户端可以进行一次判断, 如果和之前客户端的数据不一致的话, 给予用户提示, 用户确认没问题后再进入支付阶段:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Data</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CreateOrderRequest</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">long</span> itemId<span class="token punctuation">;</span>   <span class="token comment">// 商品ID</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> quantity<span class="token punctuation">;</span>  <span class="token comment">// 商品数量</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;orderRight2&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">Order</span> <span class="token function">right2</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">CreateOrderRequest</span> createOrderRequest<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 商品ID和商品数量是可信的没问题, 其他数据需要由服务端计算</span>
    <span class="token class-name">Item</span> item <span class="token operator">=</span> <span class="token class-name">Db</span><span class="token punctuation">.</span><span class="token function">getItem</span><span class="token punctuation">(</span>createOrderRequest<span class="token punctuation">.</span><span class="token function">getItemId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Order</span> order <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Order</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    order<span class="token punctuation">.</span><span class="token function">setItemPrice</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span><span class="token function">getItemPrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    order<span class="token punctuation">.</span><span class="token function">setItemTotalPrice</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span><span class="token function">getItemPrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">multiply</span><span class="token punctuation">(</span><span class="token class-name">BigDecimal</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>order<span class="token punctuation">.</span><span class="token function">getQuantity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">createOrder</span><span class="token punctuation">(</span>order<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> order<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>通过这个案例可以看到, 在处理客户端提交过来的数据时, 服务端需要明确区分, 哪些数据是需要客户端提供的, 哪些数据是客户端从服务端获取后在客户端计算的. 其中, 前者可以信任; 而后者不可信任, 服务端需要重新计算, 如果客户端和服务端计算结果不一致的话, 可以给予友好提示.</p> <h5 id="客户端提交的参数需要校验"><a href="#客户端提交的参数需要校验" class="header-anchor">#</a> 客户端提交的参数需要校验</h5> <p>对于客户端的数据, 还容易忽略的一点是, <strong>误以为客户端的数据来源是服务端, 客户端就不可能提交异常数据</strong>.</p> <p>看一个案例. 有一个用户注册页面要让用户选择所在国家, 我们会把服务端支持的国家列表返回给页面, 供用户选择. 如下代码所示, 我们的注册只支持中国, 美国和英国三个国家, 并不对其他国家开放, 因此从数据库中筛选了 id &lt; 4 的国家返回给页面进行填充:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">&quot;trustclientdata&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Controller</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TrustClientDataController</span> <span class="token punctuation">{</span>
    <span class="token comment">// 所有支持的国家</span>
    <span class="token keyword">private</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">,</span> <span class="token class-name">Country</span><span class="token punctuation">&gt;</span></span> allCountries <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">TrustClientDataController</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        allCountries<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Country</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">&quot;China&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        allCountries<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Country</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">&quot;US&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        allCountries<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Country</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">&quot;UK&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        allCountries<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Country</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token string">&quot;Japan&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">index</span><span class="token punctuation">(</span><span class="token class-name">ModelMap</span> modelMap<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Country</span><span class="token punctuation">&gt;</span></span> countries <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 从数据库查出ID&lt;4的三个国家作为白名单在页面显示</span>
        countries<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span>allCountries<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>country <span class="token operator">-&gt;</span> country<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        modelMap<span class="token punctuation">.</span><span class="token function">addAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;countries&quot;</span><span class="token punctuation">,</span> countries<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token string">&quot;index&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span> 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><p>通过服务端返回的数据来渲染模板:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token operator">&lt;</span>form id<span class="token operator">=</span><span class="token string">&quot;myForm&quot;</span> method<span class="token operator">=</span><span class="token string">&quot;post&quot;</span> th<span class="token operator">:</span>action<span class="token operator">=</span><span class="token string">&quot;@{/trustclientdata/wrong}&quot;</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>select id<span class="token operator">=</span><span class="token string">&quot;countryId&quot;</span> name<span class="token operator">=</span><span class="token string">&quot;countryId&quot;</span><span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>option value<span class="token operator">=</span><span class="token string">&quot;0&quot;</span><span class="token operator">&gt;</span><span class="token class-name">Select</span> country<span class="token operator">&lt;</span><span class="token operator">/</span>option<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>option th<span class="token operator">:</span>each<span class="token operator">=</span><span class="token string">&quot;country : ${countries}&quot;</span> th<span class="token operator">:</span>text<span class="token operator">=</span><span class="token string">&quot;${country.name}&quot;</span> th<span class="token operator">:</span>value<span class="token operator">=</span><span class="token string">&quot;${country.id}&quot;</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>option<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>select<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>button th<span class="token operator">:</span>text<span class="token operator">=</span><span class="token string">&quot;Register&quot;</span> type<span class="token operator">=</span><span class="token string">&quot;submit&quot;</span><span class="token operator">/</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>form<span class="token operator">&gt;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>在页面上, 的确也只有这三个国家的可选项:</p> <p>​<img src="/img/38cfb7a0695d53ee6689446d671a77f6-20230731165210-ihnr70g.png" alt="">​</p> <p>但要知道的是, 页面是给普通用户使用的, 而黑客不会在乎页面显示什么, 完全有可能尝试给服务端返回页面上没显示的其他国家 ID. 如果像这样直接信任客户端传来的国家 ID 的话, 很可能会把用户注册功能开放给其他国家的人:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/wrong&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@ResponseBody</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">wrong</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;countryId&quot;</span><span class="token punctuation">)</span> <span class="token keyword">int</span> countryId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> allCountries<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>countryId<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>即使我们知道参数的范围来自下拉框, 而下拉框的内容也来自服务端, <strong>也需要对参数进行校验</strong>. 因为接口不一定要通过浏览器请求, 只要知道接口定义完全可以通过其他工具提交:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>curl http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>localhost<span class="token operator">:</span><span class="token number">45678</span><span class="token operator">/</span>trustclientdata<span class="token operator">/</span>wrong\<span class="token operator">?</span>countryId<span class="token operator">=</span><span class="token number">4</span> <span class="token operator">-</span><span class="token class-name">X</span> <span class="token constant">POST</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>修改方式是, 在使用客户端传过来的参数之前, 对参数进行有效性校验:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/right&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@ResponseBody</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">right</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;countryId&quot;</span><span class="token punctuation">)</span> <span class="token keyword">int</span> countryId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>countryId <span class="token operator">&lt;</span> <span class="token number">1</span> <span class="token operator">||</span> countryId <span class="token operator">&gt;</span> <span class="token number">3</span><span class="token punctuation">)</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;非法参数&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> allCountries<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>countryId<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>或者使用 Spring Validation 采用注解的方式进行参数校验, 更优雅:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Validated</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TrustClientParameterController</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/better&quot;</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@ResponseBody</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">better</span><span class="token punctuation">(</span>
            <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;countryId&quot;</span><span class="token punctuation">)</span>
            <span class="token annotation punctuation">@Min</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> message <span class="token operator">=</span> <span class="token string">&quot;非法参数&quot;</span><span class="token punctuation">)</span>
            <span class="token annotation punctuation">@Max</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">,</span> message <span class="token operator">=</span> <span class="token string">&quot;非法参数&quot;</span><span class="token punctuation">)</span> <span class="token keyword">int</span> countryId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> allCountries<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>countryId<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>客户端提交的参数需要校验的问题, 可以引申出一个更容易忽略的点是, 可能会把一些服务端的数据暂存在网页的隐藏域中, 这样下次页面提交的时候可以把相关数据再传给服务端. 虽然用户通过网页界面的操作无法修改这些数据, 但这些数据对于 HTTP 请求来说就是普通数据, 完全可以随时修改为任意值. 所以服务端在使用这些数据的时候, 也同样要特别小心.</p> <h5 id="不能信任请求头里的任何内容"><a href="#不能信任请求头里的任何内容" class="header-anchor">#</a> 不能信任请求头里的任何内容</h5> <p>刚才介绍了, 不能直接信任客户端的传参, 也就是通过 GET 或 POST 方法传过来的数据, 此外<strong>请求头的内容也不能信任</strong>.</p> <p>一个比较常见的需求是, 为了防刷, 需要判断用户的唯一性. 比如, 针对未注册的新用户发送一些小奖品, 我们不希望相同用户多次获得奖品. 考虑到未注册的用户因为没有登录过所以没有用户标识, 我们可能会想到根据请求的 IP 地址, 来判断用户是否已经领过奖品.</p> <p>比如, 下面的这段测试代码. 通过一个 HashSet 模拟已发放过奖品的 IP 名单, 每次领取奖品后把 IP 地址加入这个名单中. IP 地址的获取方式是: 优先通过 <code>X-Forwarded-For</code>​ 请求头来获取, 如果没有的话再通过 HttpServletRequest 的 getRemoteAddr 方法来获取.</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">&quot;trustclientip&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@RestController</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TrustClientIpController</span> <span class="token punctuation">{</span>

    <span class="token class-name">HashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> activityLimit <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;test&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> ip <span class="token operator">=</span> <span class="token function">getClientIp</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>activityLimit<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>ip<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token string">&quot;您已经领取过奖品&quot;</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            activityLimit<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>ip<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token string">&quot;奖品领取成功&quot;</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token class-name">String</span> <span class="token function">getClientIp</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> xff <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getHeader</span><span class="token punctuation">(</span><span class="token string">&quot;X-Forwarded-For&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>xff <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> request<span class="token punctuation">.</span><span class="token function">getRemoteAddr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> xff<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token string">&quot;,&quot;</span><span class="token punctuation">)</span> <span class="token operator">?</span> xff<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&quot;,&quot;</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">:</span> xff<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><p>之所以这么做是因为, 通常应用之前都部署了反向代理或负载均衡器, <strong>remoteAddr 获得的只能是代理的 IP 地址</strong>, 而不是访问用户实际的 IP. 这不符合需求, 因为反向代理在转发请求时, 通常会把用户真实 IP 放入 <code>X-Forwarded-For</code>​ 这个请求头中.</p> <p><strong>这种过于依赖 X-Forwarded-For 请求头来判断用户唯一性的实现方式, 是有问题的</strong>:</p> <ul><li>完全可以通过 cURL 类似的工具来模拟请求, 随意篡改头的内容:</li></ul> <div class="language-java line-numbers-mode"><pre class="language-java"><code>curl http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>localhost<span class="token operator">:</span><span class="token number">45678</span><span class="token operator">/</span>trustclientip<span class="token operator">/</span>test <span class="token operator">-</span><span class="token class-name">H</span> <span class="token string">&quot;X-Forwarded-For:183.84.18.71, 10.253.15.1&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><ul><li>网吧, 学校等机构的出口 IP 往往是同一个, 在这个场景下, 可能只有最先打开这个页面的用户才能领取到奖品, 而其他用户会被阻拦.</li></ul> <p>因此, IP 地址或者说请求头里的任何信息, 包括 Cookie 中的信息, Referer, 只能用作<strong>参考</strong>, 不能用作重要逻辑判断的依据. 而对于类似这个案例唯一性的判断需求, 更好的做法是, <strong>让用户进行登录或三方授权登录(比如微信), 拿到用户标识来做唯一性判断</strong>.</p> <h5 id="用户标识不能从客户端获取"><a href="#用户标识不能从客户端获取" class="header-anchor">#</a> 用户标识不能从客户端获取</h5> <p>聊到用户登录, 业务代码非常容易犯错的一个地方是, 使用了客户端传给服务端的用户 ID, 类似这样:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;wrong&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">wrong</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;userId&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Long</span> userId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token string">&quot;当前用户Id: &quot;</span> <span class="token operator">+</span> userId<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>你可能觉得没人会这么干, 但我就真实遇到过: <strong>一个大项目因为服务端直接使用了客户端传过来的用户标识, 导致了安全问题</strong>.</p> <p>犯类似低级错误的原因, 有三个:</p> <ol><li>开发同学没有正确认识接口或服务面向的用户. 如果接口面向内部服务, 由服务调用方传入用户 ID 没什么不合理, 但是这样的接口不能直接开放给客户端或 H5 使用.</li> <li>在测试阶段为了方便测试调试, 通常会实现一些无需登录即可使用的接口, 直接使用客户端传过来的用户标识, 却在上线之前忘记删除类似的超级接口.</li> <li>一个大型网站前端可能由不同的模块构成, 不一定是一个系统, 而用户登录状态可能也没有打通. 有些时候, 图简单可能会在 URL 中直接传用户 ID, 以实现通过前端传值来打通用户登录状态.</li></ol> <p>如果接口直面用户(比如给客户端或 H5 页面调用), 那么一定需要用户先登录才能使用. 登录后用户标识保存在服务端, 接口需要从服务端(比如 Session 中)获取. 这里有段代码演示了一个最简单的登录操作, 登录后在 Session 中设置了当前用户的标识:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;login&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">login</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;username&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> username<span class="token punctuation">,</span> <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;password&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> password<span class="token punctuation">,</span> <span class="token class-name">HttpSession</span> session<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>username<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">&quot;admin&quot;</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> password<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">&quot;admin&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        session<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;currentUser&quot;</span><span class="token punctuation">,</span> <span class="token number">1L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">1L</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token number">0L</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>这里再分享一个 Spring Web 的小技巧.</p> <p>如果希望每一个需要登录的方法, 都从 Session 中获得当前用户标识, 并进行一些后续处理的话, 没有必要在每一个方法内都复制粘贴相同的获取用户身份的逻辑, 可以<strong>定义一个自定义注解 @LoginRequired 到 userId 参数上, 然后通过 HandlerMethodArgumentResolver 自动实现参数的组装</strong>:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;right&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">right</span><span class="token punctuation">(</span><span class="token annotation punctuation">@LoginRequired</span> <span class="token class-name">Long</span> userId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token string">&quot;当前用户Id: &quot;</span> <span class="token operator">+</span> userId<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p><strong>@LoginRequired</strong> 本身并无特殊, 只是一个自定义注解:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Retention</span><span class="token punctuation">(</span><span class="token class-name">RetentionPolicy</span><span class="token punctuation">.</span><span class="token constant">RUNTIME</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Target</span><span class="token punctuation">(</span><span class="token class-name">ElementType</span><span class="token punctuation">.</span><span class="token constant">PARAMETER</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Documented</span>
<span class="token keyword">public</span> <span class="token annotation punctuation">@interface</span> <span class="token class-name">LoginRequired</span> <span class="token punctuation">{</span>
    <span class="token class-name">String</span> <span class="token function">sessionKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token string">&quot;currentUser&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>魔法来自 HandlerMethodArgumentResolver. 这里自定义了一个实现类 LoginRequiredArgumentResolver, 实现了 HandlerMethodArgumentResolver 接口的 2 个方法:</p> <ul><li>supportsParameter 方法判断当参数上有 @LoginRequired 注解时, 再做自定义参数解析的处理;</li> <li>resolveArgument 方法用来实现解析逻辑本身. 在这里尝试从 Session 中获取当前用户的标识, 如果无法获取到的话提示非法调用的错误, 如果获取到则返回 userId. 这样一来, Controller 中的 userId 参数就可以自动赋值了.</li></ul> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LoginRequiredArgumentResolver</span> <span class="token keyword">implements</span> <span class="token class-name">HandlerMethodArgumentResolver</span> <span class="token punctuation">{</span>
    <span class="token comment">// 解析哪些参数</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">supportsParameter</span><span class="token punctuation">(</span><span class="token class-name">MethodParameter</span> methodParameter<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 匹配参数上具有@LoginRequired注解的参数</span>
        <span class="token keyword">return</span> methodParameter<span class="token punctuation">.</span><span class="token function">hasParameterAnnotation</span><span class="token punctuation">(</span><span class="token class-name">LoginRequired</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">resolveArgument</span><span class="token punctuation">(</span><span class="token class-name">MethodParameter</span> methodParameter<span class="token punctuation">,</span> <span class="token class-name">ModelAndViewContainer</span> modelAndViewContainer<span class="token punctuation">,</span> <span class="token class-name">NativeWebRequest</span> nativeWebRequest<span class="token punctuation">,</span> <span class="token class-name">WebDataBinderFactory</span> webDataBinderFactory<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token comment">// 从参数上获得注解</span>
        <span class="token class-name">LoginRequired</span> loginRequired <span class="token operator">=</span> methodParameter<span class="token punctuation">.</span><span class="token function">getParameterAnnotation</span><span class="token punctuation">(</span><span class="token class-name">LoginRequired</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 根据注解中的Session Key, 从Session中查询用户信息</span>
        <span class="token class-name">Object</span> object <span class="token operator">=</span> nativeWebRequest<span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span>loginRequired<span class="token punctuation">.</span><span class="token function">sessionKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">NativeWebRequest</span><span class="token punctuation">.</span><span class="token constant">SCOPE_SESSION</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>object <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;接口 {} 非法调用! &quot;</span><span class="token punctuation">,</span> methodParameter<span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;请先登录! &quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> object<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><p>当然要实现 WebMvcConfigurer 接口的 addArgumentResolvers 方法, 来增加这个自定义的处理器 LoginRequiredArgumentResolver:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">SpringBootApplication</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CommonMistakesApplication</span> <span class="token keyword">implements</span> <span class="token class-name">WebMvcConfigurer</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addArgumentResolvers</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">HandlerMethodArgumentResolver</span><span class="token punctuation">&gt;</span></span> resolvers<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        resolvers<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">LoginRequiredArgumentResolver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>测试发现, 经过这样的实现, <strong>登录后所有需要登录的方法都可以一键通过加 @LoginRequired 注解来拿到用户标识, 方便且安全.</strong></p> <h5 id="重点回顾-26"><a href="#重点回顾-26" class="header-anchor">#</a> 重点回顾</h5> <p>今天就 &quot;任何客户端的东西都不可信任&quot; 这个结论, 讲解了一些有代表性的错误.</p> <p>第一, <strong>客户端的计算不可信</strong>. 虽然目前很多项目的前端都是富前端, 会做大量的逻辑计算, 无需访问服务端接口就可以顺畅完成各种功能, 但来自客户端的计算结果不能直接信任. 最终在进行业务操作时, 客户端只能扮演信息收集的角色, 虽然可以将诸如价格等信息传给服务端, 但只能用于校对比较, 最终要以服务端的计算结果为准.</p> <p>第二, <strong>所有来自客户端的参数都需要校验判断合法性</strong>. 即使知道用户是在一个下拉列表选择数据, 即使知道用户通过网页正常操作不可能提交不合法的值, 服务端也应该进行参数校验, 防止非法用户绕过浏览器 UI 页面通过工具直接向服务端提交参数.</p> <p>第三, <strong>除了请求 Body 中的信息, 请求头里的任何信息同样不能信任</strong>. 来自请求头的 IP, Referer 和 Cookie 都有被篡改的可能性, 相关数据只能用来参考和记录, 不能用作重要业务逻辑.</p> <p>第四, <strong>如果接口面向外部用户, 那么一定不能出现用户标识这样的参数, 当前用户的标识一定来自服务端, 只有经过身份认证后的用户才会在服务端留下标识</strong>. 如果接口现在面向内部其他服务, 那么也要千万小心这样的接口只能内部使用, 还可能需要进一步考虑服务端调用方的授权问题.</p> <p><mark><strong>安全问题是木桶效应, 整个系统的安全等级取决于安全性最薄弱的那个模块</strong></mark>. 在写业务代码的时候, 要建立最基本的安全意识, 从源头杜绝低级安全问题.</p> <h4 id="_28-安全兜底-涉及钱时-必须考虑防刷-限量和防重"><a href="#_28-安全兜底-涉及钱时-必须考虑防刷-限量和防重" class="header-anchor">#</a> 28-安全兜底:涉及钱时,必须考虑防刷,限量和防重</h4> <p>今天要分享的主题是, <strong>任何涉及钱的代码必须要考虑防刷, 限量和防重, 要做好安全兜底</strong>.</p> <p>涉及钱的代码, 主要有以下三类.</p> <p>第一, <strong>代码本身涉及有偿使用的三方服务</strong>. 如果因为代码本身缺少授权, 用量控制而被利用导致大量调用, 势必会消耗大量的钱, 给公司造成损失. 有些三方服务可能采用后付款方式的结算, 出现问题后如果没及时发现, 下个月结算时就会收到一笔数额巨大的账单.</p> <p>第二, <strong>代码涉及虚拟资产的发放, 比如积分, 优惠券等</strong>. 虽然说虚拟资产不直接对应货币, 但一般可以在平台兑换具有真实价值的资产. 比如, 优惠券可以在下单时使用, 积分可以兑换积分商城的商品. 所以从某种意义上说, 虚拟资产就是具有一定价值的钱, 但因为不直接涉及钱和外部资金通道, 所以容易产生随意性发放而导致漏洞.</p> <p>第三, <strong>代码涉及真实钱的进出</strong>. 比如, 对用户扣款, 如果出现非正常的多次重复扣款, 小则用户投诉, 用户流失, 大则被相关管理机构要求停业整改, 影响业务. 又比如, 给用户发放返现的付款功能, 如果出现漏洞造成重复付款, 涉及 B 端的可能还好, 但涉及 C 端用户的重复付款可能永远无法追回.</p> <p>前段时间拼多多一夜之间被刷了大量 100 元无门槛优惠券的事情, 就是限量和防刷出了问题.</p> <p>今天就通过三个例子说明如何在代码层面做好安全兜底.</p> <h5 id="开放平台资源的使用需要考虑防刷"><a href="#开放平台资源的使用需要考虑防刷" class="header-anchor">#</a> 开放平台资源的使用需要考虑防刷</h5> <p>我以真实遇到的短信服务被刷案例来说说防刷.</p> <p>有次短信账单月结时发现, 之前每个月是几千元的短信费用, 这个月突然变为了几万元. 查数据库记录发现, 之前是每天发送几千条短信验证码, 从某天开始突然变为了每天几万条, 但注册用户数并没有激增. 显然这是短信接口被刷了.</p> <p>短信验证码服务属于开放性服务, 由用户侧触发, 且因为是注册验证码所以不需要登录就可以使用. 如果发短信接口像这样没有任何防刷的防护, 直接调用三方短信通道, 就相当于 &quot;裸奔&quot;, 很容易被短信轰炸平台利用:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;wrong&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">wrong</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">sendSMSCaptcha</span><span class="token punctuation">(</span><span class="token string">&quot;13600000000&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">sendSMSCaptcha</span><span class="token punctuation">(</span><span class="token class-name">String</span> mobile<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 调用短信通道</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p><strong>对于短信验证码这种开放接口, 程序逻辑内需要有防刷逻辑</strong>. 好的防刷逻辑是, 对正常使用的用户毫无影响, 只有疑似异常使用的用户才会感受到. 对于短信验证码, 有如下 4 种可行的方式来防刷.</p> <p>第一种方式, **只有固定的请求头才能发送验证码. **</p> <p>也就是说, 通过请求头中网页或 App 客户端传给服务端的一些额外参数, 来判断请求是不是 App 发起的. 其实, 这种方式 &quot;防君子不防小人&quot;. 比如, 判断是否存在浏览器或手机型号, 设备分辨率请求头. 对于那些使用爬虫来抓取短信接口地址的程序来说, 往往只能抓取到 URL, 而难以分析出请求发送短信还需要的额外请求头, 可以看作第一道基本防御.</p> <p>第二种方式, **只有先到过注册页面才能发送验证码. **</p> <p>对于普通用户来说, 不管是通过 App 注册还是 H5 页面注册, 一定是先进入注册页面才能看到发送验证码按钮, 再点击发送. 可以在页面或界面打开时请求固定的前置接口, 为这个设备开启允许发送验证码的窗口, 之后的请求发送验证码才是有效请求. 这种方式可以防御直接绕开固定流程, 通过接口直接调用的发送验证码请求, 并不会干扰普通用户.</p> <p>第三种方式, **控制相同手机号的发送次数和发送频次. **</p> <p>除非是短信无法收到, 否则用户不太会请求了验证码后不完成注册流程, 再重新请求. 因此可以限制同一手机号每天的最大请求次数. 验证码的到达需要时间, 太短的发送间隔没有意义, 所以还可以控制发送的最短间隔. 比如可以控制相同手机号一天只能发送 10 次验证码, 最短发送间隔 1 分钟.</p> <p>第四种方式, **增加前置图形验证码. **</p> <p>短信轰炸平台一般会收集很多免费短信接口, 一个接口只会给一个用户发一次短信, 所以控制相同手机号发送次数和间隔的方式不够有效. 这时可以考虑对用户体验稍微有影响, 但也是最有效的方式作为保底, 即将<strong>弹出图形验证码</strong>作为前置. 除了图形验证码, 还可以使用其他更友好的人机验证手段(比如滑动, 点击验证码等), 甚至是引入比较新潮的无感知验证码方案(比如, 通过判断用户输入手机号的打字节奏, 来判断是用户还是机器), 来改善用户体验.</p> <p>此外, 也可以考虑在监测到异常的情况下再弹出人机检测. 比如短时间内大量相同远端 IP 发送验证码的时候, 才会触发人机检测.</p> <p>总之, 要确保只有正常用户经过正常的流程才能使用开放平台资源, 并且资源的用量在业务需求合理范围内. 此外, 还需要考虑做好短信发送量的实时监控, 遇到发送量激增要及时报警.</p> <h5 id="虚拟资产并不能凭空产生无限使用"><a href="#虚拟资产并不能凭空产生无限使用" class="header-anchor">#</a> 虚拟资产并不能凭空产生无限使用</h5> <p>接下来一起看看限量的问题.</p> <p>虚拟资产虽然是平台方自己生产和控制, 但如果生产出来可以立即使用就有立即变现的可能性. 比如, 因为平台 Bug 有大量用户领取高额优惠券, 并立即下单使用.</p> <p>在商家看来, 这很可能只是一个用户支付的订单, 并不会感知到用户使用平台方优惠券的情况; 同时, 因为平台和商家是事后结算的, 所以会马上安排发货. 而发货后基本就不可逆了, 一夜之间造成了大量资金损失.</p> <p>从代码层面模拟一个优惠券被刷的例子.</p> <p>假设有一个 CouponCenter 类负责优惠券的产生和发放. 如下是错误做法, 只要调用方需要, 就可以凭空产生无限的优惠券:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CouponCenter</span> <span class="token punctuation">{</span>
    <span class="token comment">// 用于统计发了多少优惠券</span>
    <span class="token class-name">AtomicInteger</span> totalSent <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicInteger</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">sendCoupon</span><span class="token punctuation">(</span><span class="token class-name">Coupon</span> coupon<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>coupon <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
            totalSent<span class="token punctuation">.</span><span class="token function">incrementAndGet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getTotalSentCoupon</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> totalSent<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 没有任何限制, 来多少请求生成多少优惠券</span>
    <span class="token keyword">public</span> <span class="token class-name">Coupon</span> <span class="token function">generateCouponWrong</span><span class="token punctuation">(</span><span class="token keyword">long</span> userId<span class="token punctuation">,</span> <span class="token class-name">BigDecimal</span> amount<span class="token punctuation">)</span>              <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Coupon</span><span class="token punctuation">(</span>userId<span class="token punctuation">,</span> amount<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p>这样一来, 使用 CouponCenter 的 generateCouponWrong 方法, 想发多少优惠券就可以发多少:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;wrong&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">wrong</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">CouponCenter</span> couponCenter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CouponCenter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 发送10000个优惠券</span>
    <span class="token class-name">IntStream</span><span class="token punctuation">.</span><span class="token function">rangeClosed</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">10000</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>i <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        <span class="token class-name">Coupon</span> coupon <span class="token operator">=</span> couponCenter<span class="token punctuation">.</span><span class="token function">generateCouponWrong</span><span class="token punctuation">(</span><span class="token number">1L</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">BigDecimal</span><span class="token punctuation">(</span><span class="token string">&quot;100&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        couponCenter<span class="token punctuation">.</span><span class="token function">sendCoupon</span><span class="token punctuation">(</span>coupon<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> couponCenter<span class="token punctuation">.</span><span class="token function">getTotalSentCoupon</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p><strong>更合适的做法是, 把优惠券看作一种资源, 其生产不是凭空的, 而是需要事先申请</strong>, 理由是:</p> <ol><li>虚拟资产如果最终可以对应到真实金钱上的优惠, 那么能发多少取决于运营和财务的核算, 应该是有计划, 有上限的. 引言提到的无门槛优惠券, 需要特别小心. 有门槛优惠券的大量使用至少会带来大量真实的消费, 而使用无门槛优惠券下的订单, 可能用户一分钱都没有支付.</li> <li>即使虚拟资产不值钱, 大量不合常规的虚拟资产流入市场, 也会冲垮虚拟资产的经济体系, 造成虚拟货币的极速贬值. 有量的控制才有价值.</li> <li>资产的申请需要理由, 甚至需要走流程, 这样才可以追溯是什么活动需要, 谁提出的申请, 程序依据申请批次来发放.</li></ol> <p>接下来按照这个思路改进一下程序.</p> <p>首先, 定义一个 CouponBatch 类, 要产生优惠券必须先向运营申请优惠券批次, 批次中包含了固定张数的优惠券, 申请原因等信息:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// 优惠券批次</span>
<span class="token annotation punctuation">@Data</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CouponBatch</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">long</span> id<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">AtomicInteger</span> totalCount<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">AtomicInteger</span> remainCount<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">BigDecimal</span> amount<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> reason<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>在业务需要发放优惠券的时候, 先申请批次, 然后再通过批次发放优惠券:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;right&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">right</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">CouponCenter</span> couponCenter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CouponCenter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 申请批次  </span>
    <span class="token class-name">CouponBatch</span> couponBatch <span class="token operator">=</span> couponCenter<span class="token punctuation">.</span><span class="token function">generateCouponBatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">IntStream</span><span class="token punctuation">.</span><span class="token function">rangeClosed</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">10000</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>i <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        <span class="token class-name">Coupon</span> coupon <span class="token operator">=</span> couponCenter<span class="token punctuation">.</span><span class="token function">generateCouponRight</span><span class="token punctuation">(</span><span class="token number">1L</span><span class="token punctuation">,</span> couponBatch<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 发放优惠券</span>
        couponCenter<span class="token punctuation">.</span><span class="token function">sendCoupon</span><span class="token punctuation">(</span>coupon<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> couponCenter<span class="token punctuation">.</span><span class="token function">getTotalSentCoupon</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>可以看到, generateCouponBatch 方法申请批次时, 设定了这个批次包含 100 张优惠券. 在通过 generateCouponRight 方法发放优惠券时, 每发一次都会从批次中扣除一张优惠券, 发完了就没有了:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">Coupon</span> <span class="token function">generateCouponRight</span><span class="token punctuation">(</span><span class="token keyword">long</span> userId<span class="token punctuation">,</span> <span class="token class-name">CouponBatch</span> couponBatch<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>couponBatch<span class="token punctuation">.</span><span class="token function">getRemainCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">decrementAndGet</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Coupon</span><span class="token punctuation">(</span>userId<span class="token punctuation">,</span> couponBatch<span class="token punctuation">.</span><span class="token function">getAmount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;优惠券批次 {} 剩余优惠券不足&quot;</span><span class="token punctuation">,</span> couponBatch<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token class-name">CouponBatch</span> <span class="token function">generateCouponBatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">CouponBatch</span> couponBatch <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CouponBatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    couponBatch<span class="token punctuation">.</span><span class="token function">setAmount</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BigDecimal</span><span class="token punctuation">(</span><span class="token string">&quot;100&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    couponBatch<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span><span class="token number">1L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    couponBatch<span class="token punctuation">.</span><span class="token function">setTotalCount</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">AtomicInteger</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    couponBatch<span class="token punctuation">.</span><span class="token function">setRemainCount</span><span class="token punctuation">(</span>couponBatch<span class="token punctuation">.</span><span class="token function">getTotalCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    couponBatch<span class="token punctuation">.</span><span class="token function">setReason</span><span class="token punctuation">(</span><span class="token string">&quot;XXX活动&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> couponBatch<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>这样改进后的程序, 一个批次最多只能发放 100 张优惠券.</p> <p>因为是 Demo, 所以只是凭空 new 出来一个 Coupon. 在真实的生产级代码中, 一定是根据 CouponBatch 在数据库中插入一定量的 Coupon 记录, 每一个优惠券都有唯一的 ID, 可跟踪, 可注销.</p> <h5 id="钱的进出一定要和订单挂钩并且实现幂等"><a href="#钱的进出一定要和订单挂钩并且实现幂等" class="header-anchor">#</a> 钱的进出一定要和订单挂钩并且实现幂等</h5> <p>涉及钱的进出, 需要做好以下两点.</p> <p>第一, <strong>任何资金操作都需要在平台侧生成业务属性的订单, 可以是优惠券发放订单, 可以是返现订单, 也可以是借款订单, 一定是先有订单再去做资金操作</strong>. 同时, 订单的产生需要有业务属性. 业务属性是指, 订单不是凭空产生的, 否则就没有控制的意义. 比如, 返现发放订单必须关联到原先的商品订单产生; 再比如, 借款订单必须关联到同一个借款合同产生.</p> <p>第二, <mark><strong>一定要做好防重, 也就是实现幂等处理, 并且幂等处理必须是全链路的</strong></mark>. 这里的全链路是指, 从前到后都需要有相同的<strong>业务订单号</strong>来贯穿, 实现最终的支付防重.</p> <p>关于这两点, 可以参考下面的代码示例:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// 错误: 每次使用UUID作为订单号</span>
<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;wrong&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">wrong</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;orderId&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> orderId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">PayChannel</span><span class="token punctuation">.</span><span class="token function">pay</span><span class="token punctuation">(</span><span class="token constant">UUID</span><span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;123&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">BigDecimal</span><span class="token punctuation">(</span><span class="token string">&quot;100&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 正确: 使用相同的业务订单号</span>
<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;right&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">right</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;orderId&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> orderId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">PayChannel</span><span class="token punctuation">.</span><span class="token function">pay</span><span class="token punctuation">(</span>orderId<span class="token punctuation">,</span> <span class="token string">&quot;123&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">BigDecimal</span><span class="token punctuation">(</span><span class="token string">&quot;100&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 三方支付通道</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PayChannel</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">pay</span><span class="token punctuation">(</span><span class="token class-name">String</span> orderId<span class="token punctuation">,</span> <span class="token class-name">String</span> account<span class="token punctuation">,</span> <span class="token class-name">BigDecimal</span> amount<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>对于支付操作, 一定是调用三方支付公司的接口或银行接口进行处理的. 一般而言, 这些接口都会有商户订单号的概念, 对于相同的商户订单号, 无法进行重复的资金处理, 所以<strong>三方公司的接口可以实现唯一订单号的幂等处理</strong>.</p> <p>但是, 业务系统在实现资金操作时容易犯的错是, 没有自始至终地使用一个订单号作为商户订单号, 透传给三方支付接口. 出现这个问题的原因是, 比较大的互联网公司一般会把支付独立一个部门. 支付部门可能会针对支付做聚合操作, 内部会维护一个支付订单号, 然后使用支付订单号和三方支付接口交互. 最终虽然商品订单是一个, 但支付订单是多个, 相同的商品订单因为产生多个支付订单导致多次支付.</p> <p>如果说, 支付出现了重复扣款, 可以给用户进行退款操作, 但给用户付款的操作一旦出现重复付款, 就很难把钱追回来了, 所以更要小心.</p> <p>这就是全链路的意义, 从一开始就需要先有业务订单产生, 然后使用相同的业务订单号一直贯穿到最后的资金通路, 才能真正避免重复资金操作.</p> <h5 id="重点回顾-27"><a href="#重点回顾-27" class="header-anchor">#</a> 重点回顾</h5> <p>今天从安全兜底聊起, 分享了涉及钱的业务最需要做的三方面工作, <strong>防刷, 限量和防重</strong>.</p> <p>第一, <strong>使用开放的, 面向用户的平台资源要考虑防刷</strong>, 主要包括正常使用流程识别, 人机识别, 单人限量和全局限量等手段.</p> <p>第二, <strong>虚拟资产不能凭空产生, 一定是先有发放计划, 申请批次, 然后通过批次来生产资产</strong>. 这样才能达到限量, 有审计, 能追溯的目的.</p> <p>第三, <strong>真实钱的进出操作要额外小心, 做好防重处理</strong>. 不能凭空去操作用户的账户, 每次操作以真实的订单作为依据, 通过业务订单号实现全链路的幂等控制.</p> <p>如果程序逻辑涉及有价值的资源或是真实的钱, 必须有敬畏之心. 程序上线后, 人是有休息时间的, 但程序是一直运行着的, 如果产生安全漏洞, 就很可能在一夜之间爆发, 被大量人利用导致大量的金钱损失.</p> <p>除了在流程上做好防刷, 限量和防重控制之外, 还需要做好三方平台调用量, 虚拟资产使用量, 交易量, 交易金额等重要数据的监控报警, 这样即使出现问题也能第一时间发现.</p> <h4 id="_29-数据和代码-数据就是数据-代码就是代码"><a href="#_29-数据和代码-数据就是数据-代码就是代码" class="header-anchor">#</a> 29-数据和代码:数据就是数据,代码就是代码</h4> <p>今天聊聊数据和代码的问题.</p> <p>正如这一讲标题 &quot;数据就是数据, 代码就是代码&quot; 所说, Web 安全方面的很多漏洞, 都是源自把数据当成了代码来执行, 也就是注入类问题, 比如:</p> <ol><li>客户端提供给服务端的查询值, 是一个数据, 会成为 SQL 查询的一部分. 黑客通过修改这个值注入一些 SQL, 来达到在服务端运行 SQL 的目的, 相当于把查询条件的数据变为了查询代码. 这种攻击方式, 叫做 <strong>SQL 注入</strong>.</li> <li>对于规则引擎, 可能会用动态语言做一些计算, 和 SQL 注入一样外部传入的数据只能当做数据使用, 如果被黑客利用传入了代码, 那么代码可能就会被动态执行. 这种攻击方式, 叫做<strong>代码注入</strong>.</li> <li>对于用户注册, 留言评论等功能, 服务端会从客户端收集一些信息, 本来用户名, 邮箱这类信息是纯文本信息, 但是黑客把信息替换为了 JavaScript 代码. 那么这些信息在页面呈现时, 可能就相当于执行了 JavaScript 代码. 甚至服务端可能把这样的代码, 当作普通信息保存到了数据库. 黑客通过构建 JavaScript 代码来实现修改页面呈现, 盗取信息, 甚至蠕虫攻击的方式, 叫做 <strong>XSS(跨站脚本)攻击</strong>.</li></ol> <p>今天就通过案例来看一下这三个问题, 并了解下应对方式.</p> <h5 id="sql注入能干的事情比你想象的更多"><a href="#sql注入能干的事情比你想象的更多" class="header-anchor">#</a> SQL注入能干的事情比你想象的更多</h5> <p>最近几年, 大家的安全意识增强了, 都知道使用<strong>参数化查询</strong>来避免 SQL 注入问题. 其中的原理是, 使用参数化查询的话, 参数只能作为普通数据, 不可能作为 SQL 的一部分, 以此有效避免 SQL 注入问题.</p> <p>虽然大家已经开始关注 SQL 注入的问题, 但还是有一些认知上的误区, 主要表现在以下三个方面:</p> <p>第一, <strong>认为 SQL 注入问题只可能发生于 Http Get 请求, 也就是通过 URL 传入的参数才可能产生注入点</strong>. 这是很危险的想法. 从注入的难易度上来说, 修改 URL 上的 QueryString 和修改 Post 请求体中的数据, 没有任何区别, 因为黑客是通过工具来注入的, 而不是通过修改浏览器上的 URL 来注入的. 甚至 Cookie 都可以用来 SQL 注入, 任何提供数据的地方都可能成为注入点.</p> <p>第二, <strong>认为不返回数据的接口, 不可能存在注入问题</strong>. 其实, 黑客完全可以利用 SQL 语句构造出一些不正确的 SQL, 导致执行出错. 如果服务端直接显示了错误信息, 那黑客需要的数据就有可能被带出来, 从而达到查询数据的目的. 甚至即使没有详细的出错信息, 黑客也可以通过所谓盲注的方式进行攻击.</p> <p>第三, <strong>认为 SQL 注入的影响范围, 只是通过短路实现突破登录, 只需要登录操作加强防范即可</strong>. 首先, SQL 注入完全可以实现拖库, 也就是下载整个数据库的内容, SQL 注入的危害不仅仅是突破后台登录. 其次, 根据木桶原理, 整个站点的安全性受限于安全级别最低的那块短板. 因此, 对于安全问题, 站点的所有模块必须一视同仁, 并不是只加强防范所谓的重点模块.</p> <p>在日常开发中, 虽然是使用框架来进行数据访问的, 但还可能会因为疏漏而导致注入问题. 接下来就用一个实际的例子配合专业的 SQL 注入工具 sqlmap, 来测试下 SQL 注入.</p> <p>首先, 在程序启动的时候使用 JdbcTemplate 创建一个 userdata 表(表中只有 ID, 用户名, 密码三列), 并初始化两条用户信息. 然后, 创建一个不返回任何数据的 Http Post 接口. 在实现上, 通过 SQL 拼接的方式, 把传入的用户名入参拼接到 LIKE 子句中实现模糊查询.</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// 程序启动时进行表结构和数据初始化</span>
<span class="token annotation punctuation">@PostConstruct</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 删除表</span>
    jdbcTemplate<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token string">&quot;drop table IF EXISTS `userdata`;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 创建表, 不包含自增ID, 用户名, 密码三列</span>
    jdbcTemplate<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token string">&quot;create TABLE `userdata` (\n&quot;</span> <span class="token operator">+</span>
            <span class="token string">&quot;  `id` bigint(20) NOT NULL AUTO_INCREMENT,\n&quot;</span> <span class="token operator">+</span>
            <span class="token string">&quot;  `name` varchar(255) NOT NULL,\n&quot;</span> <span class="token operator">+</span>
            <span class="token string">&quot;  `password` varchar(255) NOT NULL,\n&quot;</span> <span class="token operator">+</span>
            <span class="token string">&quot;  PRIMARY KEY (`id`)\n&quot;</span> <span class="token operator">+</span>
            <span class="token string">&quot;) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 插入两条测试数据</span>
    jdbcTemplate<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token string">&quot;INSERT INTO `userdata` (name,password) VALUES ('test1','haha1'),('test2','haha2')&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@Autowired</span>
<span class="token keyword">private</span> <span class="token class-name">JdbcTemplate</span> jdbcTemplate<span class="token punctuation">;</span>

<span class="token comment">// 用户模糊搜索接口</span>
<span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;jdbcwrong&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">jdbcwrong</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 采用拼接SQL的方式把姓名参数拼到LIKE子句中</span>
    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;{}&quot;</span><span class="token punctuation">,</span> jdbcTemplate<span class="token punctuation">.</span><span class="token function">queryForList</span><span class="token punctuation">(</span><span class="token string">&quot;SELECT id,name FROM userdata WHERE name LIKE '%&quot;</span> <span class="token operator">+</span> name <span class="token operator">+</span> <span class="token string">&quot;%'&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><p>使用 sqlmap 来探索这个接口:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>python sqlmap<span class="token punctuation">.</span>py <span class="token operator">-</span>u  http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>localhost<span class="token operator">:</span><span class="token number">45678</span><span class="token operator">/</span>sqlinject<span class="token operator">/</span>jdbcwrong <span class="token operator">--</span>data name<span class="token operator">=</span>test
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>一段时间后, sqlmap 给出了如下结果:</p> <p><img src="/img/a015d2c89cb934a886cf5fc5d1921eb7-20230731165210-kjzey8y.png" alt=""></p> <p>可以看到, 这个接口的 name 参数有两种可能的注入方式: <strong>一种是报错注入, 一种是基于时间的盲注</strong>.</p> <p>接下来, <strong>仅需简单的三步, 就可以直接导出整个用户表的内容了</strong>.</p> <p>第一步, 查询当前数据库:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>python sqlmap<span class="token punctuation">.</span>py <span class="token operator">-</span>u  http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>localhost<span class="token operator">:</span><span class="token number">45678</span><span class="token operator">/</span>sqlinject<span class="token operator">/</span>jdbcwrong <span class="token operator">--</span>data name<span class="token operator">=</span>test <span class="token operator">--</span>current<span class="token operator">-</span>db
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>可以得到当前数据库是 common_mistakes:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>current database<span class="token operator">:</span> 'common_mistakes'
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>第二步, 查询数据库下的表:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>python sqlmap<span class="token punctuation">.</span>py <span class="token operator">-</span>u  http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>localhost<span class="token operator">:</span><span class="token number">45678</span><span class="token operator">/</span>sqlinject<span class="token operator">/</span>jdbcwrong <span class="token operator">--</span>data name<span class="token operator">=</span>test <span class="token operator">--</span>tables <span class="token operator">-</span><span class="token class-name">D</span> <span class="token string">&quot;common_mistakes&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>可以看到其中有一个敏感表 <strong>userdata</strong>:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">Database</span><span class="token operator">:</span> common_mistakes
<span class="token punctuation">[</span><span class="token number">7</span> tables<span class="token punctuation">]</span>
<span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span>
<span class="token operator">|</span> user               <span class="token operator">|</span>
<span class="token operator">|</span> common_store       <span class="token operator">|</span>
<span class="token operator">|</span> hibernate_sequence <span class="token operator">|</span>
<span class="token operator">|</span> m                  <span class="token operator">|</span>
<span class="token operator">|</span> news               <span class="token operator">|</span>
<span class="token operator">|</span> r                  <span class="token operator">|</span>
<span class="token operator">|</span> userdata           <span class="token operator">|</span>
<span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>第三步, 查询 userdata 的数据:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>python sqlmap<span class="token punctuation">.</span>py <span class="token operator">-</span>u  http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>localhost<span class="token operator">:</span><span class="token number">45678</span><span class="token operator">/</span>sqlinject<span class="token operator">/</span>jdbcwrong <span class="token operator">--</span>data name<span class="token operator">=</span>test <span class="token operator">-</span><span class="token class-name">D</span> <span class="token string">&quot;common_mistakes&quot;</span> <span class="token operator">-</span><span class="token class-name">T</span> <span class="token string">&quot;userdata&quot;</span> <span class="token operator">--</span>dump
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>你看, <strong>用户密码信息一览无遗. 当然也可以继续查看其他表的数据</strong>:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">Database</span><span class="token operator">:</span> common_mistakes
<span class="token class-name">Table</span><span class="token operator">:</span> userdata
<span class="token punctuation">[</span><span class="token number">2</span> entries<span class="token punctuation">]</span>
<span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span>
<span class="token operator">|</span> id <span class="token operator">|</span> name  <span class="token operator">|</span> password <span class="token operator">|</span>
<span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span>
<span class="token operator">|</span> <span class="token number">1</span>  <span class="token operator">|</span> test1 <span class="token operator">|</span> haha1    <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">2</span>  <span class="token operator">|</span> test2 <span class="token operator">|</span> haha2    <span class="token operator">|</span>
<span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>在日志中可以看到, sqlmap 实现拖库的方式是, <strong>让 SQL 执行后的出错信息包含字段内容</strong>. 注意看下错误日志的第二行, 错误信息中包含 ID 为 2 的用户的密码字段的值 &quot;haha2&quot;. 这就是报错注入的基本原理:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token punctuation">[</span><span class="token number">13</span><span class="token operator">:</span><span class="token number">22</span><span class="token operator">:</span><span class="token number">27.375</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>http<span class="token operator">-</span>nio<span class="token operator">-</span><span class="token number">45678</span><span class="token operator">-</span>exec<span class="token operator">-</span><span class="token number">10</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token constant">ERROR</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>a<span class="token punctuation">.</span>c<span class="token punctuation">.</span>c<span class="token punctuation">.</span></span>C</span><span class="token punctuation">.</span><span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">[</span><span class="token operator">/</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token punctuation">[</span>dispatcherServlet<span class="token punctuation">]</span><span class="token operator">:</span><span class="token number">175</span> <span class="token punctuation">]</span> <span class="token operator">-</span> <span class="token class-name">Servlet</span><span class="token punctuation">.</span><span class="token function">service</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">for</span> servlet <span class="token punctuation">[</span>dispatcherServlet<span class="token punctuation">]</span> in context <span class="token keyword">with</span> <span class="token namespace">path</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> threw exception <span class="token punctuation">[</span><span class="token class-name">Request</span> processing failed<span class="token punctuation">;</span> nested exception is <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>dao<span class="token punctuation">.</span></span>DuplicateKeyException</span><span class="token operator">:</span> <span class="token class-name">StatementCallback</span><span class="token punctuation">;</span> <span class="token constant">SQL</span> <span class="token punctuation">[</span><span class="token class-name">SELECT</span> id<span class="token punctuation">,</span>name <span class="token constant">FROM</span> userdata <span class="token constant">WHERE</span> name <span class="token constant">LIKE</span> <span class="token char">'%test'</span><span class="token operator">||</span><span class="token punctuation">(</span><span class="token constant">SELECT</span> <span class="token number">0x694a6e64</span> <span class="token class-name">WHERE</span> <span class="token number">3941</span><span class="token operator">=</span><span class="token number">3941</span> <span class="token constant">AND</span> <span class="token punctuation">(</span><span class="token constant">SELECT</span> <span class="token number">9927</span> <span class="token function">FROM</span><span class="token punctuation">(</span><span class="token class-name">SELECT</span> <span class="token function">COUNT</span><span class="token punctuation">(</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">CONCAT</span><span class="token punctuation">(</span><span class="token number">0x71626a7a71</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token class-name">SELECT</span> <span class="token function">MID</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">IFNULL</span><span class="token punctuation">(</span><span class="token function">CAST</span><span class="token punctuation">(</span>password <span class="token class-name">AS</span> <span class="token constant">NCHAR</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">0x20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">54</span><span class="token punctuation">)</span> <span class="token constant">FROM</span> common_mistakes<span class="token punctuation">.</span>userdata <span class="token constant">ORDER</span> <span class="token constant">BY</span> id <span class="token class-name">LIMIT</span> <span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">0x7170706271</span><span class="token punctuation">,</span><span class="token function">FLOOR</span><span class="token punctuation">(</span><span class="token function">RAND</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>x <span class="token constant">FROM</span> <span class="token constant">INFORMATION_SCHEMA</span><span class="token punctuation">.</span><span class="token constant">PLUGINS</span> <span class="token constant">GROUP</span> <span class="token class-name">BY</span> x<span class="token punctuation">)</span>a<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">||</span><span class="token char">'%'</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token class-name">Duplicate</span> entry 'qbjzqhaha2qppbq1' <span class="token keyword">for</span> key '<span class="token generics"><span class="token punctuation">&lt;</span>group_key<span class="token punctuation">&gt;</span></span>'<span class="token punctuation">;</span> nested exception is <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>sql<span class="token punctuation">.</span></span>SQLIntegrityConstraintViolationException</span><span class="token operator">:</span> <span class="token class-name">Duplicate</span> entry 'qbjzqhaha2qppbq1' <span class="token keyword">for</span> key '<span class="token generics"><span class="token punctuation">&lt;</span>group_key<span class="token punctuation">&gt;</span></span>'<span class="token punctuation">]</span> <span class="token keyword">with</span> <span class="token namespace">root</span> cause
<span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>sql<span class="token punctuation">.</span></span>SQLIntegrityConstraintViolationException</span><span class="token operator">:</span> <span class="token class-name">Duplicate</span> entry 'qbjzqhaha2qppbq1' <span class="token keyword">for</span> key '<span class="token generics"><span class="token punctuation">&lt;</span>group_key<span class="token punctuation">&gt;</span></span>'
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>既然是这样, 就实现一个 ExceptionHandler 来屏蔽异常, 看看能否解决注入问题:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@ExceptionHandler</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handle</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> req<span class="token punctuation">,</span> <span class="token class-name">HandlerMethod</span> method<span class="token punctuation">,</span> <span class="token class-name">Exception</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    log<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;访问 %s -&gt; %s 出现异常! &quot;</span><span class="token punctuation">,</span> req<span class="token punctuation">.</span><span class="token function">getRequestURI</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> method<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>重启程序后重新运行刚才的 sqlmap 命令, 可以看到报错注入是没戏了, 但使用<strong>时间盲注</strong>还是可以查询整个表的数据:</p> <p><img src="/img/2891372226ce869bb77fd298b691ef9c-20230731165210-b2n5ing.png" alt=""></p> <p>所谓盲注, 指的是注入后并不能从服务器得到任何执行结果(甚至是错误信息), 只能寄希望服务器对于 SQL 中的真假条件表现出不同的状态. 比如, 对于布尔盲注来说, 可能是 &quot;真&quot; 可以得到 200 状态码, &quot;假&quot; 可以得到 500 错误状态码; 或者, &quot;真&quot; 可以得到内容输出, &quot;假&quot; 得不到任何输出. 总之, 对于不同的 SQL 注入可以得到不同的输出即可.</p> <p>在这个案例中, 因为接口没有输出, 也彻底屏蔽了错误, 布尔盲注这招儿行不通了. 那么退而求其次的方式, 就是时间盲注. 也就是说, 通过在真假条件中加入 SLEEP, 来实现通过判断接口的响应时间, 知道条件的结果是真还是假.</p> <p>不管是什么盲注, 都是通过真假两种状态来完成的. 你可能会好奇, 通过真假两种状态如何实现数据导出?</p> <p>其实你可以想一下, 虽然不能直接查询出 password 字段的值, 但可以按字符逐一来查, 判断第一个字符是否是 a, 是否是 b..., 查询到 h 时发现响应变慢了, 自然知道这就是真的, 得出第一位就是 h. 以此类推, 可以查询出整个值.</p> <p>所以, sqlmap 在返回数据的时候, 也是一个字符一个字符跳出结果的, 并且时间盲注的整个过程会比报错注入慢许多.</p> <p>可以引入 p6spy 工具打印出所有执行的 SQL, 观察 sqlmap 构造的一些 SQL, 来分析其中原理:</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.github.gavlyukovskiy<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>p6spy-spring-boot-starter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.6.1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p><img src="/img/d3c42050cc7fff9dfd2cc8830c9e9d0b-20230731165210-xy4wiy1.png" alt=""></p> <p>所以说, 即使屏蔽错误信息错误码, 也不能彻底防止 SQL 注入. 真正的解决方式, 还是<strong>使用参数化查询, 让任何外部输入值只可能作为数据来处理</strong>.</p> <p>比如, 对于之前那个接口, <strong>在 SQL 语句中使用 &quot;?&quot; 作为参数占位符, 然后提供参数值.</strong>  这样修改后, sqlmap 也就无能为力了:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;jdbcright&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">jdbcright</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;{}&quot;</span><span class="token punctuation">,</span> jdbcTemplate<span class="token punctuation">.</span><span class="token function">queryForList</span><span class="token punctuation">(</span><span class="token string">&quot;SELECT id,name FROM userdata WHERE name LIKE ?&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;%&quot;</span> <span class="token operator">+</span> name <span class="token operator">+</span> <span class="token string">&quot;%&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>对于 MyBatis 来说, 同样需要使用参数化的方式来写 SQL 语句. 在 MyBatis 中, &quot;<code>#{}</code>​&quot; 是参数化的方式, &quot;<code>{}</code>​&quot; 只是占位符替换.</p> <p>比如 LIKE 语句. 因为使用 &quot;<code>#{}</code>​&quot; 会为参数带上单引号, 导致 LIKE 语法错误, 所以一些同学会退而求其次, 选择 &quot;<code>${}</code>​&quot; 的方式, 比如:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Select</span><span class="token punctuation">(</span><span class="token string">&quot;SELECT id,name FROM `userdata` WHERE name LIKE '%${name}%'&quot;</span><span class="token punctuation">)</span>
<span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">UserData</span><span class="token punctuation">&gt;</span></span> <span class="token function">findByNameWrong</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Param</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>可以尝试一下, 使用 sqlmap 同样可以实现注入. 正确的做法是, 使用 &quot;<code>#{}</code>​&quot; 来参数化 name 参数, 对于 LIKE 操作可以使用 CONCAT 函数来拼接 % 符号:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Select</span><span class="token punctuation">(</span><span class="token string">&quot;SELECT id,name FROM `userdata` WHERE name LIKE CONCAT('%',#{name},'%')&quot;</span><span class="token punctuation">)</span>
<span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">UserData</span><span class="token punctuation">&gt;</span></span> <span class="token function">findByNameRight</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Param</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>又比如 IN 子句. 因为涉及多个元素的拼接, 一些同学不知道如何处理, 也可能会选择使用 &quot;<code>${}</code>​&quot;. 因为使用 &quot;<code>#{}</code>​&quot; 会把输入当做一个字符串来对待:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token operator">&lt;</span>select id<span class="token operator">=</span><span class="token string">&quot;findByNamesWrong&quot;</span> resultType<span class="token operator">=</span><span class="token string">&quot;org.geekbang.time.commonmistakes.codeanddata.sqlinject.UserData&quot;</span><span class="token operator">&gt;</span>
    <span class="token class-name">SELECT</span> id<span class="token punctuation">,</span>name <span class="token constant">FROM</span> `userdata` <span class="token constant">WHERE</span> name in <span class="token punctuation">(</span>$<span class="token punctuation">{</span>names<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>select<span class="token operator">&gt;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>但这样直接把外部传入的内容替换到 IN 内部, 同样会有注入漏洞:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;mybatiswrong2&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">List</span> <span class="token function">mybatiswrong2</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;names&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> names<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> userDataMapper<span class="token punctuation">.</span><span class="token function">findByNamesWrong</span><span class="token punctuation">(</span>names<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>可以使用下面这条命令测试下:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>python sqlmap<span class="token punctuation">.</span>py <span class="token operator">-</span>u  http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>localhost<span class="token operator">:</span><span class="token number">45678</span><span class="token operator">/</span>sqlinject<span class="token operator">/</span>mybatiswrong2 <span class="token operator">--</span>data names<span class="token operator">=</span><span class="token string">&quot;'test1','test2'&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>最后可以发现, 有 4 种可行的注入方式, 分别是布尔盲注, 报错注入, 时间盲注和联合查询注入:</p> <p><img src="/img/e1d0ba04283214ea644553c401227faa-20230731165210-dxaw4qm.png" alt=""></p> <p>修改方式是, 给 MyBatis 传入一个 List, 然后使用其 foreach 标签来拼接出 IN 中的内容, 并确保 IN 中的每一项都是使用 &quot;<code>#{}</code>​&quot; 来注入参数:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;mybatisright2&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">List</span> <span class="token function">mybatisright2</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;names&quot;</span><span class="token punctuation">)</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> names<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> userDataMapper<span class="token punctuation">.</span><span class="token function">findByNamesRight</span><span class="token punctuation">(</span>names<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token operator">&lt;</span>select id<span class="token operator">=</span><span class="token string">&quot;findByNamesRight&quot;</span> resultType<span class="token operator">=</span><span class="token string">&quot;org.geekbang.time.commonmistakes.codeanddata.sqlinject.UserData&quot;</span><span class="token operator">&gt;</span>
    <span class="token class-name">SELECT</span> id<span class="token punctuation">,</span>name <span class="token constant">FROM</span> `userdata` <span class="token constant">WHERE</span> name in
    <span class="token operator">&lt;</span>foreach collection<span class="token operator">=</span><span class="token string">&quot;names&quot;</span> item<span class="token operator">=</span><span class="token string">&quot;item&quot;</span> <span class="token keyword">open</span><span class="token operator">=</span><span class="token string">&quot;(&quot;</span> separator<span class="token operator">=</span><span class="token string">&quot;,&quot;</span> close<span class="token operator">=</span><span class="token string">&quot;)&quot;</span><span class="token operator">&gt;</span>
        #<span class="token punctuation">{</span>item<span class="token punctuation">}</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>foreach<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>select<span class="token operator">&gt;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>修改后这个接口就不会被注入了.</p> <h5 id="小心动态执行代码时代码注入漏洞"><a href="#小心动态执行代码时代码注入漏洞" class="header-anchor">#</a> 小心动态执行代码时代码注入漏洞</h5> <p>总结下, 刚刚看到的 SQL 注入漏洞的原因是, 黑客把 SQL 攻击代码通过传参混入 SQL 语句中执行. 同样, 对于任何解释执行的其他语言代码, 也可以产生类似的注入漏洞. 下面看一个<strong>动态执行 JavaScript 代码导致注入漏洞</strong>的案例.</p> <p>现在, 要对用户名实现动态的规则判断: 通过 ScriptEngineManager 获得一个 JavaScript 脚本引擎, 使用 Java 代码来动态执行 JavaScript 代码, 实现当外部传入的用户名为 admin 的时候返回 1, 否则返回 0:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token class-name">ScriptEngineManager</span> scriptEngineManager <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ScriptEngineManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 获得JavaScript脚本引擎</span>
<span class="token keyword">private</span> <span class="token class-name">ScriptEngine</span> jsEngine <span class="token operator">=</span> scriptEngineManager<span class="token punctuation">.</span><span class="token function">getEngineByName</span><span class="token punctuation">(</span><span class="token string">&quot;js&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;wrong&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">wrong</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment">// 通过eval动态执行JavaScript脚本, 这里name参数通过字符串拼接方式混入JavaScript代码</span>
        <span class="token keyword">return</span> jsEngine<span class="token punctuation">.</span><span class="token function">eval</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;var name='%s'; name=='admin'?1:0;&quot;</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ScriptException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>这个功能本身没什么问题. 但是如果把传入的用户名修改为这样:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>haha'<span class="token punctuation">;</span><span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>System</span><span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>'
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>就可以达到<strong>关闭整个程序</strong>的目的. 原因是, 我们直接把代码和数据拼接在了一起. 外部如果构造了一个特殊的用户名先闭合字符串的单引号, 再执行一条 System.exit 命令的话, 就可以满足脚本不出错, 命令被执行.</p> <p>解决这个问题有两种方式.</p> <p>第一种方式和解决 SQL 注入一样, 需要<strong>把外部传入的条件数据仅仅当做数据来对待. 可以通过 SimpleBindings 来绑定参数初始化 name 变量</strong>, 而不是直接拼接代码:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;right&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">right</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment">// 外部传入的参数</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> parm <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        parm<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// name参数作为绑定传给eval方法, 而不是拼接JavaScript代码</span>
        <span class="token keyword">return</span> jsEngine<span class="token punctuation">.</span><span class="token function">eval</span><span class="token punctuation">(</span><span class="token string">&quot;name=='admin'?1:0;&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">SimpleBindings</span><span class="token punctuation">(</span>parm<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ScriptException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>这样就避免了注入问题.</p> <p>第二种解决方法是, 使用 SecurityManager 配合 AccessControlContext, 来构建一个脚本运行的<strong>沙箱环境</strong>. 脚本能执行的所有操作权限, 是通过 setPermissions 方法精细化设置的:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ScriptingSandbox</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token class-name">ScriptEngine</span> scriptEngine<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">AccessControlContext</span> accessControlContext<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">SecurityManager</span> securityManager<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Boolean</span><span class="token punctuation">&gt;</span></span> needCheck <span class="token operator">=</span> <span class="token class-name">ThreadLocal</span><span class="token punctuation">.</span><span class="token function">withInitial</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">ScriptingSandbox</span><span class="token punctuation">(</span><span class="token class-name">ScriptEngine</span> scriptEngine<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InstantiationException</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>scriptEngine <span class="token operator">=</span> scriptEngine<span class="token punctuation">;</span>
        securityManager <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SecurityManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token comment">// 仅在需要的时候检查权限</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">checkPermission</span><span class="token punctuation">(</span><span class="token class-name">Permission</span> perm<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>needCheck<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> accessControlContext <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">checkPermission</span><span class="token punctuation">(</span>perm<span class="token punctuation">,</span> accessControlContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>

        <span class="token comment">// 设置执行脚本需要的权限</span>
        <span class="token function">setPermissions</span><span class="token punctuation">(</span><span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span>
                <span class="token keyword">new</span> <span class="token class-name">RuntimePermission</span><span class="token punctuation">(</span><span class="token string">&quot;getProtectionDomain&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token keyword">new</span> <span class="token class-name">PropertyPermission</span><span class="token punctuation">(</span><span class="token string">&quot;jdk.internal.lambda.dumpProxyClasses&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;read&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token keyword">new</span> <span class="token class-name">FilePermission</span><span class="token punctuation">(</span><span class="token class-name">Shell</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getProtectionDomain</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPermissions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">elements</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">nextElement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">&quot;read&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token keyword">new</span> <span class="token class-name">RuntimePermission</span><span class="token punctuation">(</span><span class="token string">&quot;createClassLoader&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token keyword">new</span> <span class="token class-name">RuntimePermission</span><span class="token punctuation">(</span><span class="token string">&quot;accessClassInPackage.jdk.internal.org.objectweb.*&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token keyword">new</span> <span class="token class-name">RuntimePermission</span><span class="token punctuation">(</span><span class="token string">&quot;accessClassInPackage.jdk.nashorn.internal.*&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token keyword">new</span> <span class="token class-name">RuntimePermission</span><span class="token punctuation">(</span><span class="token string">&quot;accessDeclaredMembers&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token keyword">new</span> <span class="token class-name">ReflectPermission</span><span class="token punctuation">(</span><span class="token string">&quot;suppressAccessChecks&quot;</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 设置执行上下文的权限</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setPermissions</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Permission</span><span class="token punctuation">&gt;</span></span> permissionCollection<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Permissions</span> perms <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Permissions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>permissionCollection <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Permission</span> p <span class="token operator">:</span> permissionCollection<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                perms<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">ProtectionDomain</span> domain <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ProtectionDomain</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">CodeSource</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">CodeSigner</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">,</span> perms<span class="token punctuation">)</span><span class="token punctuation">;</span>
        accessControlContext <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AccessControlContext</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ProtectionDomain</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span>domain<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">eval</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">String</span> code<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">SecurityManager</span> oldSecurityManager <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">getSecurityManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">setSecurityManager</span><span class="token punctuation">(</span>securityManager<span class="token punctuation">)</span><span class="token punctuation">;</span>
        needCheck<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">// 在AccessController的保护下执行脚本</span>
            <span class="token keyword">return</span> <span class="token class-name">AccessController</span><span class="token punctuation">.</span><span class="token function">doPrivileged</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">PrivilegedAction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span> scriptEngine<span class="token punctuation">.</span><span class="token function">eval</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ScriptException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span> accessControlContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;抱歉, 无法执行脚本 {}&quot;</span><span class="token punctuation">,</span> code<span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            needCheck<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">setSecurityManager</span><span class="token punctuation">(</span>oldSecurityManager<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br></div></div><p>写一段测试代码, 使用刚才定义的 ScriptingSandbox 沙箱工具类来执行脚本:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;right2&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">right2</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InstantiationException</span> <span class="token punctuation">{</span>
    <span class="token comment">// 使用沙箱执行脚本</span>
    <span class="token class-name">ScriptingSandbox</span> scriptingSandbox <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ScriptingSandbox</span><span class="token punctuation">(</span>jsEngine<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> scriptingSandbox<span class="token punctuation">.</span><span class="token function">eval</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;var name='%s'; name=='admin'?1:0;&quot;</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>这次再使用之前的注入脚本调用这个接口:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>localhost<span class="token operator">:</span><span class="token number">45678</span><span class="token operator">/</span>codeinject<span class="token operator">/</span>right2<span class="token operator">?</span>name<span class="token operator">=</span>haha<span class="token operator">%</span><span class="token number">27</span><span class="token punctuation">;</span><span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>System</span><span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token operator">%</span><span class="token number">27</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>可以看到, 结果中抛出了 AccessControlException 异常, 注入攻击失效了:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token punctuation">[</span><span class="token number">13</span><span class="token operator">:</span><span class="token number">09</span><span class="token operator">:</span><span class="token number">36.080</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>http<span class="token operator">-</span>nio<span class="token operator">-</span><span class="token number">45678</span><span class="token operator">-</span>exec<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token constant">ERROR</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>g<span class="token punctuation">.</span>t<span class="token punctuation">.</span>c<span class="token punctuation">.</span>c<span class="token punctuation">.</span>codeinject<span class="token punctuation">.</span></span>ScriptingSandbox</span><span class="token operator">:</span><span class="token number">77</span>  <span class="token punctuation">]</span> <span class="token operator">-</span> 抱歉<span class="token punctuation">,</span> 无法执行脚本 <span class="token keyword">var</span> name<span class="token operator">=</span><span class="token char">'haha'</span><span class="token punctuation">;</span><span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>System</span><span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>''<span class="token punctuation">;</span> name<span class="token operator">==</span><span class="token char">'admin'</span><span class="token operator">?</span><span class="token number">1</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">;</span>
<span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>security<span class="token punctuation">.</span></span>AccessControlException</span><span class="token operator">:</span> access denied <span class="token punctuation">(</span><span class="token string">&quot;java.lang.RuntimePermission&quot;</span> <span class="token string">&quot;exitVM.0&quot;</span><span class="token punctuation">)</span>
at <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>security<span class="token punctuation">.</span></span>AccessControlContext</span><span class="token punctuation">.</span><span class="token function">checkPermission</span><span class="token punctuation">(</span><span class="token class-name">AccessControlContext</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">472</span><span class="token punctuation">)</span>
at <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>SecurityManager</span><span class="token punctuation">.</span><span class="token function">checkPermission</span><span class="token punctuation">(</span><span class="token class-name">SecurityManager</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">585</span><span class="token punctuation">)</span>
at <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>geekbang<span class="token punctuation">.</span>time<span class="token punctuation">.</span>commonmistakes<span class="token punctuation">.</span>codeanddata<span class="token punctuation">.</span>codeinject<span class="token punctuation">.</span></span>ScriptingSandbox</span>$<span class="token number">1.</span><span class="token function">checkPermission</span><span class="token punctuation">(</span><span class="token class-name">ScriptingSandbox</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">30</span><span class="token punctuation">)</span>
at <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>SecurityManager</span><span class="token punctuation">.</span><span class="token function">checkExit</span><span class="token punctuation">(</span><span class="token class-name">SecurityManager</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">761</span><span class="token punctuation">)</span>
at <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>Runtime</span><span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token class-name">Runtime</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">107</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>在实际应用中, 可以考虑同时使用这两种方法, 确保代码执行的安全性.</p> <h5 id="xss必须全方位严防死堵"><a href="#xss必须全方位严防死堵" class="header-anchor">#</a> XSS必须全方位严防死堵</h5> <p>对于业务开发来说, XSS 的问题同样要引起关注.</p> <p>XSS 问题的根源在于, <strong>原本是让用户传入或输入正常数据的地方, 被黑客替换为了 JavaScript 脚本, 页面没有经过转义直接显示了这个数据, 然后脚本就被执行了</strong>. 更严重的是, 脚本没有经过转义就保存到了数据库中, 随后页面加载数据的时候, 数据中混入的脚本又当做代码执行了. 黑客可以利用这个漏洞来盗取敏感数据, 诱骗用户访问钓鱼网站等.</p> <p>写一段代码测试下. 首先服务端定义两个接口, 其中 index 接口查询用户名信息返回给 xss 页面, save 接口使用 @RequestParam 注解接收用户名, 并创建用户保存到数据库; 然后重定向浏览器到 index 接口:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">&quot;xss&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@Controller</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">XssController</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">UserRepository</span> userRepository<span class="token punctuation">;</span>

    <span class="token comment">// 显示xss页面</span>
    <span class="token annotation punctuation">@GetMapping</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">index</span><span class="token punctuation">(</span><span class="token class-name">ModelMap</span> modelMap<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 查数据库</span>
        <span class="token class-name">User</span> user <span class="token operator">=</span> userRepository<span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span><span class="token number">1L</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">orElse</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 给View提供Model</span>
        modelMap<span class="token punctuation">.</span><span class="token function">addAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;username&quot;</span><span class="token punctuation">,</span> user<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token string">&quot;xss&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 保存用户信息</span>
    <span class="token annotation punctuation">@PostMapping</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">save</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;username&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> username<span class="token punctuation">,</span> <span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">User</span> user <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        user<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span><span class="token number">1L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        user<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span><span class="token punctuation">;</span>
        userRepository<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 保存完成后重定向到首页</span>
        <span class="token keyword">return</span> <span class="token string">&quot;redirect:/xss/&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
 <span class="token punctuation">}</span>

<span class="token comment">// 用户类, 同时作为DTO和Entity</span>
<span class="token annotation punctuation">@Entity</span>
<span class="token annotation punctuation">@Data</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">User</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Id</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> id<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br></div></div><p>使用 Thymeleaf 模板引擎来渲染页面. 模板代码比较简单, 页面加载的时候会在标签显示用户名, 用户输入用户名提交后调用 save 接口创建用户:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token operator">&lt;</span>div style<span class="token operator">=</span><span class="token string">&quot;font-size: 14px&quot;</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>form id<span class="token operator">=</span><span class="token string">&quot;myForm&quot;</span> method<span class="token operator">=</span><span class="token string">&quot;post&quot;</span> th<span class="token operator">:</span>action<span class="token operator">=</span><span class="token string">&quot;@{/xss/}&quot;</span><span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>label th<span class="token operator">:</span>utext<span class="token operator">=</span><span class="token string">&quot;${username}&quot;</span><span class="token operator">/</span><span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>input id<span class="token operator">=</span><span class="token string">&quot;username&quot;</span> name<span class="token operator">=</span><span class="token string">&quot;username&quot;</span> size<span class="token operator">=</span><span class="token string">&quot;100&quot;</span> type<span class="token operator">=</span><span class="token string">&quot;text&quot;</span><span class="token operator">/</span><span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>button th<span class="token operator">:</span>text<span class="token operator">=</span><span class="token string">&quot;Register&quot;</span> type<span class="token operator">=</span><span class="token string">&quot;submit&quot;</span><span class="token operator">/</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>form<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>打开 xss 页面后, 在文本框中输入 <code>&lt;script&gt;alert('test')&lt;/script&gt;</code>​ 点击 Register 按钮提交, 页面会弹出 alert 对话框:</p> <p><img src="/img/2abf9ca77a1e2c8d793e798547e4df7b-20230731165210-sxo0vkd.png" alt=""></p> <p><img src="/img/542823290b4b4ee03389d8c6354e58fd-20230731165210-rckkdyk.png" alt=""></p> <p>并且脚本被保存到了数据库:</p> <p>​<img src="/img/ef36e7e54cb3894be93650da5fa29e6b-20230731165210-ogs66pz.png" alt="">​</p> <p>你可能想到了, 解决方式就是 <strong>HTML 转码</strong>. 既然是通过 @RequestParam 来获取请求参数, 那定义一个 @InitBinder 实现数据绑定的时候, 对字符串进行转码即可:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@ControllerAdvice</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SecurityAdvice</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@InitBinder</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">initBinder</span><span class="token punctuation">(</span><span class="token class-name">WebDataBinder</span> binder<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 注册自定义的绑定器</span>
        binder<span class="token punctuation">.</span><span class="token function">registerCustomEditor</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">PropertyEditorSupport</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getAsText</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">Object</span> value <span class="token operator">=</span> <span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> value <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> value<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setAsText</span><span class="token punctuation">(</span><span class="token class-name">String</span> text<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// 赋值时进行HTML转义</span>
                <span class="token function">setValue</span><span class="token punctuation">(</span>text <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token keyword">null</span> <span class="token operator">:</span> <span class="token class-name">HtmlUtils</span><span class="token punctuation">.</span><span class="token function">htmlEscape</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p>的确, 针对这个场景, 这种做法是可行的. 数据库中保存了转义后的数据, 因此数据会被当做 HTML 显示在页面上, 而不是当做脚本执行:</p> <p>​<img src="/img/c80259ff5964e539b4b41fb657c79d6c-20230731165210-uqridfr.png" alt="">​</p> <p><img src="/img/da97fe0c8efb224425fa46cba892644b-20230731165210-s92txpx.png" alt=""></p> <p>但这种处理方式犯了一个严重的错误, 那就是没有从根儿上来处理安全问题. 因为 @InitBinder 是 Spring Web 层面的处理逻辑, 如果有代码不通过 @RequestParam 来获取数据, 而是直接从 HTTP 请求获取数据的话, 这种方式就不会奏效. 比如这样:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>user<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span><span class="token string">&quot;username&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>更合理的解决方式是, 定义一个 <strong>servlet Filter</strong>, 通过 HttpServletRequestWrapper 实现 servlet 层面的统一参数替换:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// 自定义过滤器</span>
<span class="token annotation punctuation">@Component</span>
<span class="token annotation punctuation">@Order</span><span class="token punctuation">(</span><span class="token class-name">Ordered</span><span class="token punctuation">.</span><span class="token constant">HIGHEST_PRECEDENCE</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">XssFilter</span> <span class="token keyword">implements</span> <span class="token class-name">Filter</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doFilter</span><span class="token punctuation">(</span><span class="token class-name">ServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">ServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">FilterChain</span> chain<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">ServletException</span> <span class="token punctuation">{</span>
        chain<span class="token punctuation">.</span><span class="token function">doFilter</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">XssRequestWrapper</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span><span class="token punctuation">)</span> request<span class="token punctuation">)</span><span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">XssRequestWrapper</span> <span class="token keyword">extends</span> <span class="token class-name">HttpServletRequestWrapper</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token class-name">XssRequestWrapper</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">getParameterValues</span><span class="token punctuation">(</span><span class="token class-name">String</span> parameter<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 获取多个参数值的时候对所有参数值应用clean方法逐一清洁</span>
        <span class="token keyword">return</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">getParameterValues</span><span class="token punctuation">(</span>parameter<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">::</span><span class="token function">clean</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toArray</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">::</span><span class="token keyword">new</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getHeader</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 同样清洁请求头</span>
        <span class="token keyword">return</span> <span class="token function">clean</span><span class="token punctuation">(</span><span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">getHeader</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getParameter</span><span class="token punctuation">(</span><span class="token class-name">String</span> parameter<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 获取参数单一值也要处理</span>
        <span class="token keyword">return</span> <span class="token function">clean</span><span class="token punctuation">(</span><span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span>parameter<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// clean方法就是对值进行HTML转义</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> <span class="token function">clean</span><span class="token punctuation">(</span><span class="token class-name">String</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token operator">?</span> <span class="token string">&quot;&quot;</span> <span class="token operator">:</span> <span class="token class-name">HtmlUtils</span><span class="token punctuation">.</span><span class="token function">htmlEscape</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span> 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br></div></div><p>这样就可以实现所有请求参数的 HTML 转义了. 不过, 这种方式还是不够彻底, 原因是无法处理通过 @RequestBody 注解提交的 JSON 数据. 比如, 有这样一个 PUT 接口, 直接保存了客户端传入的 JSON User 对象:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@PutMapping</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">put</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">User</span> user<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    userRepository<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>通过 Postman 请求这个接口, 保存到数据库中的数据还是没有转义:</p> <p>​<img src="/img/0cca4938b225fd6a6d4a9c086f6f4bcd-20230731165210-dafjeau.png" alt="">​</p> <p>需要自定义一个 <strong>Jackson 反列化器</strong>, 来实现反序列化时的字符串的 HTML 转义:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// 注册自定义的Jackson反序列器</span>
<span class="token annotation punctuation">@Bean</span>
<span class="token keyword">public</span> <span class="token class-name">Module</span> <span class="token function">xssModule</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">SimpleModule</span> <span class="token keyword">module</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SimpleModule</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">module</span><span class="token punctuation">.</span><span class="token keyword">module</span><span class="token punctuation">.</span><span class="token function">addDeserializer</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">XssJsonDeserializer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">module</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">XssJsonDeserializer</span> <span class="token keyword">extends</span> <span class="token class-name">JsonDeserializer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">deserialize</span><span class="token punctuation">(</span><span class="token class-name">JsonParser</span> jsonParser<span class="token punctuation">,</span> <span class="token class-name">DeserializationContext</span> ctxt<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">JsonProcessingException</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> value <span class="token operator">=</span> jsonParser<span class="token punctuation">.</span><span class="token function">getValueAsString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 对于值进行HTML转义</span>
            <span class="token keyword">return</span> <span class="token class-name">HtmlUtils</span><span class="token punctuation">.</span><span class="token function">htmlEscape</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> value<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token function">handledType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><p>这样就实现了既能转义 <code>Get/Post</code>​ 通过请求参数提交的数据, 又能转义请求体中直接提交的 JSON 数据.</p> <p>你可能觉得做到这里, 防范已经很全面了, 但其实不是. 这种只能堵新漏, 确保新数据进入数据库之前转义. 如果因为之前的漏洞, 数据库中已经保存了一些 JavaScript 代码, 那么读取的时候同样可能出问题. 因此还要实现数据读取的时候也转义.</p> <p>接下来看一下具体的实现方式. 首先, 之前处理了 JSON 反序列化问题, 那么就需要同样处理序列化, 实现数据从数据库中读取的时候转义, 否则读出来的 JSON 可能包含 JavaScript 代码.</p> <p>比如, 定义这样一个 GET 接口以 JSON 来返回用户信息:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;user&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@ResponseBody</span>
<span class="token keyword">public</span> <span class="token class-name">User</span> <span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> userRepository<span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span><span class="token number">1L</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">orElse</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p><img src="/img/832282c8c709429fc2266f2bb2ede2fa-20230731165210-3z7z834.png" alt=""></p> <p>修改之前的 SimpleModule 加入自定义序列化器, 并且实现序列化时处理字符串转义:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// 注册自定义的Jackson序列器</span>
<span class="token annotation punctuation">@Bean</span>
<span class="token keyword">public</span> <span class="token class-name">Module</span> <span class="token function">xssModule</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">SimpleModule</span> <span class="token keyword">module</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SimpleModule</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">module</span><span class="token punctuation">.</span><span class="token function">addDeserializer</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">XssJsonDeserializer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">module</span><span class="token punctuation">.</span><span class="token function">addSerializer</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">XssJsonSerializer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">module</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">XssJsonSerializer</span> <span class="token keyword">extends</span> <span class="token class-name">JsonSerializer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token function">handledType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">serialize</span><span class="token punctuation">(</span><span class="token class-name">String</span> value<span class="token punctuation">,</span> <span class="token class-name">JsonGenerator</span> jsonGenerator<span class="token punctuation">,</span> <span class="token class-name">SerializerProvider</span> serializerProvider<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 对字符串进行HTML转义</span>
            jsonGenerator<span class="token punctuation">.</span><span class="token function">writeString</span><span class="token punctuation">(</span><span class="token class-name">HtmlUtils</span><span class="token punctuation">.</span><span class="token function">htmlEscape</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><p>可以看到, 这次读到的 JSON 也转义了:</p> <p><img src="/img/13bd814e59a4e041d865543711fba893-20230731165210-4sp41jl.png" alt=""></p> <p>其次, 还需要处理 HTML 模板. 对于 Thymeleaf 模板引擎, 需要注意的是, 使用 <code>th:utext</code>​ 来显示数据是不会进行转义的, 需要使用 <code>th:text</code>​:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token operator">&lt;</span>label th<span class="token operator">:</span>text<span class="token operator">=</span><span class="token string">&quot;${username}&quot;</span><span class="token operator">/</span><span class="token operator">&gt;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>经过修改后, 即使数据库中已经保存了 JavaScript 代码, 呈现的时候也只能作为 HTML 显示了. 现在对于进和出两个方向, 都实现了补漏.</p> <p>但所谓百密总有一疏. 为了避免疏漏, 进一步控制 XSS 可能带来的危害, 还要考虑一种情况: 如果需要在 Cookie 中写入敏感信息的话, 可以开启 HttpOnly 属性. 这样 JavaScript 代码就无法读取 Cookie 了, 即便页面被 XSS 注入了攻击代码, 也无法获得 Cookie.</p> <p>写段代码测试一下. 定义两个接口, 其中 readCookie 接口读取 Key 为 test 的 Cookie, writeCookie 接口写入 Cookie, 根据参数 HttpOnly 确定 Cookie 是否开启 HttpOnly:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// 服务端读取Cookie</span>
<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;readCookie&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@ResponseBody</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">readCookie</span><span class="token punctuation">(</span><span class="token annotation punctuation">@CookieValue</span><span class="token punctuation">(</span><span class="token string">&quot;test&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> cookieValue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> cookieValue<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 服务端写入Cookie</span>
<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;writeCookie&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@ResponseBody</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">writeCookie</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;httpOnly&quot;</span><span class="token punctuation">)</span> <span class="token keyword">boolean</span> httpOnly<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Cookie</span> cookie <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Cookie</span><span class="token punctuation">(</span><span class="token string">&quot;test&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;zhuye&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 根据httpOnly入参决定是否开启HttpOnly属性</span>
    cookie<span class="token punctuation">.</span><span class="token function">setHttpOnly</span><span class="token punctuation">(</span>httpOnly<span class="token punctuation">)</span><span class="token punctuation">;</span>
    response<span class="token punctuation">.</span><span class="token function">addCookie</span><span class="token punctuation">(</span>cookie<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>可以看到, 由于 test 和 _ga 这两个 Cookie 不是 HttpOnly 的. 通过 document.cookie 可以输出这两个 Cookie 的内容:</p> <p><img src="/img/018045c41c2f8058a0260ccb14d22d72-20230731165210-0ys7oar.png" alt=""></p> <p>为 test 这个 Cookie 启用了 HttpOnly 属性后, 就不能被 document.cookie 读取到了, 输出中只有 _ga 一项:</p> <p><img src="/img/58981ee5a1a9bf35680562a5f3278c58-20230731165210-51u3u3t.png" alt=""></p> <p>但是服务端可以读取到这个 cookie.</p> <h5 id="重点回顾-28"><a href="#重点回顾-28" class="header-anchor">#</a> 重点回顾</h5> <p>今天通过案例具体分析了 SQL 注入和 XSS 攻击这两类注入类安全问题.</p> <p>在学习 SQL 注入的时候, 通过 sqlmap 工具看到了几种常用注入方式, 这可能改变了我们对 SQL 注入威力的认知: 对于 POST 请求, 请求没有任何返回数据, 请求不会出错的情况下, 仍然可以完成注入, 并可以导出数据库的所有数据.</p> <p>对于 SQL 注入来说, <strong>避免参数化的查询是最好的堵漏方式</strong>; 对于 JdbcTemplate 来说, 可以使用 &quot;<code>?</code>​&quot; 作为参数占位符; 对于 MyBatis 来说, 需要使用 &quot;<code>#{}</code>​&quot; 进行参数化处理.</p> <p>和 SQL 注入类似的是, 脚本引擎动态执行代码, 需要确保外部传入的数据只能作为数据来处理, 不能和代码拼接在一起, 只能作为参数来处理. 代码和数据之间需要划出清晰的界限, 否则可能产生代码注入问题. 同时可以通过设置一个代码的执行沙箱来细化代码的权限, 这样即便产生了注入问题, 因为权限受限注入攻击也很难发挥威力.</p> <p><strong>随后通过学习 XSS 案例, 认识到处理安全问题需要确保三点.</strong></p> <ol><li>第一, 要从根本上, 从最底层进行堵漏, 尽量不要在高层框架层面做, 否则堵漏可能不彻底.</li> <li>第二, <strong>堵漏要同时考虑进和出</strong>, 不仅要确保数据存入数据库的时候进行了转义或过滤, 还要在取出数据呈现的时候再次转义, 确保万无一失.</li> <li>第三, 除了直接堵漏外, 还可以通过一些额外的手段限制漏洞的威力. 比如为 Cookie 设置 HttpOnly 属性, 来防止数据被脚本读取; 又比如, 尽可能限制字段的最大保存长度, 即使出现漏洞, 也会因为长度问题限制黑客构造复杂攻击脚本的能力.</li></ol> <h4 id="_30-如何正确保存和传输敏感数据"><a href="#_30-如何正确保存和传输敏感数据" class="header-anchor">#</a> 30-如何正确保存和传输敏感数据?</h4> <p>今天从安全角度来聊聊<strong>用户名, 密码, 身份证等敏感信息, 应该怎么保存和传输</strong>. 同时还可以进一步复习加密算法中的散列, 对称加密和非对称加密算法, 以及 HTTPS 等相关知识.</p> <h5 id="应该怎样保存用户密码"><a href="#应该怎样保存用户密码" class="header-anchor">#</a> 应该怎样保存用户密码?</h5> <p>最敏感的数据恐怕就是用户的密码了. 黑客一旦窃取了用户密码, 或许就可以登录进用户的账号, 消耗其资产, 发布不良信息等; 更可怕的是, 有些用户至始至终都是使用一套密码, 密码一旦泄露, 就可以被黑客用来登录全网.</p> <p><mark><strong>为了防止密码泄露, 最重要的原则是不要保存用户密码</strong></mark>. 你可能会觉得很好笑, 不保存用户密码, 之后用户登录的时候怎么验证? 其实, 这里指的是<strong>不保存原始密码, 这样即使拖库也不会泄露用户密码.</strong></p> <p>我经常会听到大家说, 不要明文保存用户密码, 应该把密码通过 MD5 加密后保存. 这的确是一个正确的方向, 但这个说法并不准确.</p> <p>首先, <strong>MD5 其实不是真正的加密算法</strong>. 所谓加密算法, 是可以使用密钥把明文加密为密文, 随后还可以使用密钥解密出明文, 是双向的.</p> <p>而 MD5 是散列, 哈希算法或者摘要算法. 不管多长的数据, 使用 MD5 运算后得到的都是固定长度的摘要信息或指纹信息, 无法再解密为原始数据. 所以, MD5 是单向的. <strong>最重要的是, 仅仅使用 MD5 对密码进行摘要, 并不安全</strong>.</p> <p>比如, 使用如下代码在保持用户信息时, 对密码进行了 MD5 计算:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">UserData</span> userData <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UserData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
userData<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span><span class="token number">1L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
userData<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 密码字段使用MD5哈希后保存</span>
userData<span class="token punctuation">.</span><span class="token function">setPassword</span><span class="token punctuation">(</span><span class="token class-name">DigestUtils</span><span class="token punctuation">.</span><span class="token function">md5Hex</span><span class="token punctuation">(</span>password<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">return</span> userRepository<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>userData<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>通过输出, 可以看到密码是 32 位的 MD5:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token string">&quot;password&quot;</span><span class="token operator">:</span> <span class="token string">&quot;325a2cc052914ceeb8c19016c091d2ac&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>到某 MD5 破解网站上输入这个 MD5, 不到 1 秒就得到了原始密码:</p> <p><img src="/img/ec964234adc8cba7b19d52a516c05c3c-20230731165210-lcn5zuw.png" alt=""></p> <p>可以想一下, 虽然 MD5 不可解密, 但是可以构建一个超大的数据库, 把所有 20 位以内的数字和字母组合的密码全部计算一遍 MD5 存进去, 需要解密的时候搜索一下 MD5 就可以得到原始值了. 这就是<strong>字典表</strong>.</p> <p>目前, 有些 MD5 解密网站使用的是彩虹表, 是一种使用时间空间平衡的技术, 即可以使用更大的空间来降低破解时间, 也可以使用更长的破解时间来换取更小的空间.</p> <p><strong>此外, 你可能会觉得多次 MD5 比较安全, 其实并不是这样</strong>. 比如如下代码使用两次 MD5 进行摘要:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>userData<span class="token punctuation">.</span><span class="token function">setPassword</span><span class="token punctuation">(</span><span class="token class-name">DigestUtils</span><span class="token punctuation">.</span><span class="token function">md5Hex</span><span class="token punctuation">(</span><span class="token class-name">DigestUtils</span><span class="token punctuation">.</span><span class="token function">md5Hex</span><span class="token punctuation">(</span> password<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>得到下面的 MD5:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token string">&quot;password&quot;</span><span class="token operator">:</span> <span class="token string">&quot;ebbca84993fe002bac3a54e90d677d09&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>也可以破解出密码, 并且破解网站还告知这是两次 MD5 算法:</p> <p><img src="/img/afdb48e65ab0e82fdc1af5341b1718aa-20230731165210-txsh4hs.png" alt=""></p> <p>所以直接保存 MD5 后的密码是不安全的. 一些同学可能会说, 还需要加盐. 是的, 但是加盐如果不当, 还是非常不安全, 比较重要的有两点.</p> <p>第一, <strong>不能在代码中写死盐, 且盐需要有一定的长度</strong>, 比如这样:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>userData<span class="token punctuation">.</span><span class="token function">setPassword</span><span class="token punctuation">(</span><span class="token class-name">DigestUtils</span><span class="token punctuation">.</span><span class="token function">md5Hex</span><span class="token punctuation">(</span><span class="token string">&quot;salt&quot;</span> <span class="token operator">+</span> password<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>得到了如下 MD5:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token string">&quot;password&quot;</span><span class="token operator">:</span> <span class="token string">&quot;58b1d63ed8492f609993895d6ba6b93a&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>对于这样一串 MD5, 虽然破解网站上找不到原始密码, 但是黑客可以自己注册一个账号, 使用一个简单的密码, 比如 1:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token string">&quot;password&quot;</span><span class="token operator">:</span> <span class="token string">&quot;55f312f84e7785aa1efa552acbf251db&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>然后再去破解网站试一下这个 MD5, 就可以得到原始密码是 salt, 也就知道了盐值是 salt:</p> <p><img src="/img/af008b69ec8a414a6b8db2772ac62da9-20230731165210-sxvjnsp.png" alt=""></p> <p>其实, 知道盐是什么没什么关系, 关键是在代码里写死了盐, 并且盐很短, 所有用户都是这个盐. 这么做有三个问题:</p> <ol><li>因为盐太短, 太简单了, 如果用户原始密码也很简单, 那么整个拼起来的密码也很短, 这样一般的 MD5 破解网站都可以直接解密这个 MD5, 除去盐就知道原始密码了.</li> <li>相同的盐, 意味着使用相同密码的用户 MD5 值是一样的, 知道了一个用户的密码就可能知道了多个.</li> <li>也可以使用这个盐来构建一张彩虹表, 虽然会花不少代价, 但是一旦构建完成, 所有人的密码都可以被破解.</li></ol> <p><strong>所以,</strong> <mark><strong>最好是每一个密码都有独立的盐, 并且盐要长一点, 比如超过 20 位</strong></mark>.</p> <p>第二, <strong>虽然说每个人的盐最好不同, 但也不建议将一部分用户数据作为盐.</strong>  比如, 使用用户名作为盐:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>userData<span class="token punctuation">.</span><span class="token function">setPassword</span><span class="token punctuation">(</span><span class="token class-name">DigestUtils</span><span class="token punctuation">.</span><span class="token function">md5Hex</span><span class="token punctuation">(</span>name <span class="token operator">+</span> password<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>如果世界上所有的系统都是按照这个方案来保存密码, 那么 root, admin 这样的用户使用再复杂的密码也总有一天会被破解, 因为黑客们完全可以针对这些常用用户名来做彩虹表. <strong>所以盐最好是随机的值, 并且是全球唯一的, 意味着全球不可能有现成的彩虹表给你用.</strong></p> <p>正确的做法是, <mark><strong>使用全球唯一的, 和用户无关的, 足够长的随机值作为盐</strong></mark>. 比如, 可以使用 UUID 作为盐, 把盐一起保存到数据库中:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>userData<span class="token punctuation">.</span><span class="token function">setSalt</span><span class="token punctuation">(</span><span class="token constant">UUID</span><span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
userData<span class="token punctuation">.</span><span class="token function">setPassword</span><span class="token punctuation">(</span><span class="token class-name">DigestUtils</span><span class="token punctuation">.</span><span class="token function">md5Hex</span><span class="token punctuation">(</span>userData<span class="token punctuation">.</span><span class="token function">getSalt</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> password<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>并且每次用户修改密码的时候都重新计算盐, 重新保存新的密码. 你可能会问, 盐保存在数据库中, 那被拖库了不是就可以看到了吗? 难道不应该加密保存吗?</p> <p>在我看来, 盐没有必要加密保存. 盐的作用是, 防止通过彩虹表快速实现密码 &quot;解密&quot;, 如果用户的盐都是唯一的, 那么生成一次彩虹表只可能拿到一个用户的密码, 这样黑客的动力会小很多.</p> <p><strong>更好的做法是, 不要使用像 MD5 这样快速的摘要算法, 而是使用慢一点的算法</strong>. 比如 Spring Security 已经废弃了 MessageDigestPasswordEncoder, 推荐使用 <strong>BCryptPasswordEncoder</strong>, 也就是 BCrypt 来进行密码哈希. BCrypt 是为保存密码设计的算法, 相比 MD5 要慢很多.</p> <p>写段代码来测试一下 MD5, 以及使用不同代价因子的 BCrypt, 看看哈希一次密码的耗时.</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">BCryptPasswordEncoder</span> passwordEncoder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BCryptPasswordEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;performance&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">performance</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">StopWatch</span> stopWatch <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StopWatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> password <span class="token operator">=</span> <span class="token string">&quot;Abcd1234&quot;</span><span class="token punctuation">;</span>
    stopWatch<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token string">&quot;MD5&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// MD5</span>
    <span class="token class-name">DigestUtils</span><span class="token punctuation">.</span><span class="token function">md5Hex</span><span class="token punctuation">(</span>password<span class="token punctuation">)</span><span class="token punctuation">;</span>
    stopWatch<span class="token punctuation">.</span><span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    stopWatch<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token string">&quot;BCrypt(10)&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 代价因子为10的BCrypt</span>
    <span class="token class-name">String</span> hash1 <span class="token operator">=</span> <span class="token class-name">BCrypt</span><span class="token punctuation">.</span><span class="token function">gensalt</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">BCrypt</span><span class="token punctuation">.</span><span class="token function">hashpw</span><span class="token punctuation">(</span>password<span class="token punctuation">,</span> hash1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>hash1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    stopWatch<span class="token punctuation">.</span><span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    stopWatch<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token string">&quot;BCrypt(12)&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 代价因子为12的BCrypt</span>
    <span class="token class-name">String</span> hash2 <span class="token operator">=</span> <span class="token class-name">BCrypt</span><span class="token punctuation">.</span><span class="token function">gensalt</span><span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">BCrypt</span><span class="token punctuation">.</span><span class="token function">hashpw</span><span class="token punctuation">(</span>password<span class="token punctuation">,</span> hash2<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>hash2<span class="token punctuation">)</span><span class="token punctuation">;</span>
    stopWatch<span class="token punctuation">.</span><span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    stopWatch<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token string">&quot;BCrypt(14)&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 代价因子为14的BCrypt</span>
    <span class="token class-name">String</span> hash3 <span class="token operator">=</span> <span class="token class-name">BCrypt</span><span class="token punctuation">.</span><span class="token function">gensalt</span><span class="token punctuation">(</span><span class="token number">14</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">BCrypt</span><span class="token punctuation">.</span><span class="token function">hashpw</span><span class="token punctuation">(</span>password<span class="token punctuation">,</span> hash3<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>hash3<span class="token punctuation">)</span><span class="token punctuation">;</span>
    stopWatch<span class="token punctuation">.</span><span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;{}&quot;</span><span class="token punctuation">,</span> stopWatch<span class="token punctuation">.</span><span class="token function">prettyPrint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br></div></div><p>可以看到, MD5 只需要 0.8 毫秒, 而三次 BCrypt 哈希(代价因子分别设置为 10, 12 和 14)耗时分别是 82 毫秒, 312 毫秒和 1.2 秒:</p> <p>​<img src="/img/444e4a6c75c7e48c61f688ceab01a06a-20230731165210-22jv7cv.png" alt="">​</p> <p>也就是说, 如果制作 8 位密码长度的 MD5 彩虹表需要 5 个月, 那么对于 BCrypt 来说, 可能就需要几十年, 大部分黑客应该都没有这个耐心.</p> <p>写一段代码观察下, BCryptPasswordEncoder 生成的密码哈希的规律:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;better&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">UserData</span> <span class="token function">better</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;name&quot;</span><span class="token punctuation">,</span> defaultValue <span class="token operator">=</span> <span class="token string">&quot;zhuye&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> name<span class="token punctuation">,</span> <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;password&quot;</span><span class="token punctuation">,</span> defaultValue <span class="token operator">=</span> <span class="token string">&quot;Abcd1234&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> password<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">UserData</span> userData <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UserData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    userData<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span><span class="token number">1L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    userData<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 保存哈希后的密码</span>
    userData<span class="token punctuation">.</span><span class="token function">setPassword</span><span class="token punctuation">(</span>passwordEncoder<span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span>password<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    userRepository<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>userData<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 判断密码是否匹配</span>
    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;match ? {}&quot;</span><span class="token punctuation">,</span> passwordEncoder<span class="token punctuation">.</span><span class="token function">matches</span><span class="token punctuation">(</span>password<span class="token punctuation">,</span> userData<span class="token punctuation">.</span><span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> userData<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>可以发现三点规律.</p> <p>第一, 调用 encode, matches 方法进行哈希, 做密码比对的时候, 不需要传入盐. <strong>BCrypt 把盐作为了算法的一部分, 强制我们遵循安全保存密码的最佳实践.</strong></p> <p>第二, 生成的盐和哈希后的密码拼在了一起: <code>$</code>​ 是字段分隔符, 其中第一个 <code>$</code>​ 后的 2a 代表算法版本, 第二个 <code>$</code>​ 后的 10 是代价因子(默认是 10, 代表 2 的 10 次方次哈希), 第三个 <code>$</code>​ 后的 22 个字符是盐, 再后面是摘要. 所以不需要使用单独的数据库字段来保存盐.</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token string">&quot;password&quot;</span><span class="token operator">:</span> <span class="token string">&quot;$2a$10$wPWdQwfQO2lMxqSIb6iCROXv7lKnQq5XdMO96iCYCj7boK9pk6QPC&quot;</span>
<span class="token comment">//格式为: $&lt;ver&gt;$&lt;cost&gt;$&lt;salt&gt;&lt;digest&gt;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>第三, 代价因子的值越大, BCrypt 哈希的耗时越久. 因此, 对于代价因子的值, 更建议的实践是, 根据用户的忍耐程度和硬件, 设置一个尽可能大的值.</p> <p>最后, 需要注意的是, 虽然黑客已经很难通过彩虹表来破解密码了, 但是仍然有可能暴力破解密码, 也就是对于同一个用户名使用常见的密码逐一尝试登录. 因此, 除了做好密码哈希保存的工作外, 还要建设一套完善的安全防御机制, 在感知到暴力破解危害的时候, 开启短信验证, 图形验证码, 账号暂时锁定等防御机制来抵御暴力破解.</p> <h5 id="应该怎么保存姓名和身份证"><a href="#应该怎么保存姓名和身份证" class="header-anchor">#</a> 应该怎么保存姓名和身份证?</h5> <p>我们把姓名和身份证, 叫做<strong>二要素</strong>.</p> <p>现在互联网非常发达, 很多服务都可以在网上办理, 很多网站仅仅依靠二要素来确认你是谁. 所以, 二要素是比较敏感的数据, 如果在数据库中明文保存, 那么数据库被攻破后, 黑客就可能拿到大量的二要素信息. 如果这些二要素被用来申请贷款等, 后果不堪设想.</p> <p>之前提到的单向散列算法, 显然不适合用来加密保存二要素, 因为数据无法解密. 这个时候, 需要选择真正的加密算法. 可供选择的算法, 包括<strong>对称加密和非对称加密算法</strong>两类.</p> <p>对称加密算法, 是使用相同的密钥进行加密和解密. 使用对称加密算法来加密双方的通信的话, 双方需要先约定一个密钥, 加密方才能加密, 接收方才能解密. 如果密钥在发送的时候被窃取, 那么加密就是白忙一场. 因此, 这种加密方式的特点是, 加密速度比较快, 但是密钥传输分发有泄露风险.</p> <p>非对称加密算法, 或者叫公钥密码算法. 公钥密码是由一对密钥对构成的, 使用公钥或者说加密密钥来加密, 使用私钥或者说解密密钥来解密, 公钥可以任意公开, 私钥不能公开. 使用非对称加密的话, 通信双方可以仅分享公钥用于加密, 加密后的数据没有私钥无法解密. 因此, 这种加密方式的特点是, 加密速度比较慢, 但是解决了密钥的配送分发安全问题.</p> <p>但是, 对于保存敏感信息的场景来说, 加密和解密都是服务端程序, 不太需要考虑密钥的分发安全性, 也就是说使用非对称加密算法没有太大的意义. 在这里使用<strong>对称加密算法</strong>来加密数据.</p> <p>接下来, 就重点说说对称加密算法. 对称加密常用的加密算法, 有 DES, 3DES 和 AES.</p> <p>虽然, 现在仍有许多老项目使用了 DES 算法, 但不推荐使用. 在 1999 年的 DES 挑战赛 3 中, DES 密码破解耗时不到一天, 而现在 DES 密码破解更快, 使用 DES 来加密数据非常不安全. 因此, <strong>在业务代码中要避免使用 DES 加密</strong>.</p> <p>而 3DES 算法, 是使用不同的密钥进行三次 DES 串联调用, 虽然解决了 DES 不够安全的问题, 但是比 AES 慢, 也不太推荐.</p> <p><strong>AES 是当前公认的比较安全, 兼顾性能的对称加密算法</strong>. 不过严格来说, AES 并不是实际的算法名称, 而是算法标准. 2000 年, NIST 选拔出 Rijndael 算法作为 AES 的标准.</p> <p>AES 有一个重要的特点就是分组加密体制, 一次只能处理 128 位的明文, 然后生成 128 位的密文. 如果要加密很长的明文, 那么就需要迭代处理, 而迭代方式就叫做模式. 网上很多使用 AES 来加密的代码, 使用的是最简单的 ECB 模式(也叫电子密码本模式), 其基本结构如下:</p> <p><img src="/img/2fd589806c205e3a658dd0558e68e2c9-20230731165210-jg8yr31.png" alt=""></p> <p>可以看到, 这种结构有两个风险: 明文和密文是一一对应的, 如果明文中有重复的分组, 那么密文中可以观察到重复, 掌握密文的规律; 因为每一个分组是独立加密和解密的 , 如果密文分组的顺序, 也可以反过来操纵明文, 那么就可以实现不解密密文的情况下, 来修改明文.</p> <p>写一段代码来测试下. 在下面的代码中, 使用 ECB 模式测试:</p> <ol><li>加密一段包含 16 个字符的字符串, 得到密文 A; 然后把这段字符串复制一份成为一个 32 个字符的字符串, 再进行加密得到密文 B. 验证下密文 B 是不是重复了一遍的密文 A.</li> <li>模拟银行转账的场景, 假设整个数据由发送方账号, 接收方账号, 金额三个字段构成. 尝试改变密文中数据的顺序来操纵明文.</li></ol> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">KEY</span> <span class="token operator">=</span> <span class="token string">&quot;secretkey1234567&quot;</span><span class="token punctuation">;</span> <span class="token comment">// 密钥</span>

<span class="token comment">// 测试ECB模式</span>
<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;ecb&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">ecb</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token class-name">Cipher</span> cipher <span class="token operator">=</span> <span class="token class-name">Cipher</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token string">&quot;AES/ECB/NoPadding&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">test</span><span class="token punctuation">(</span>cipher<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 获取加密秘钥帮助方法</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">SecretKeySpec</span> <span class="token function">setKey</span><span class="token punctuation">(</span><span class="token class-name">String</span> secret<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">SecretKeySpec</span><span class="token punctuation">(</span>secret<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;AES&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 测试逻辑</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token class-name">Cipher</span> cipher<span class="token punctuation">,</span> <span class="token class-name">AlgorithmParameterSpec</span> parameterSpec<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token comment">// 初始化Cipher</span>
    cipher<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token class-name">Cipher</span><span class="token punctuation">.</span><span class="token constant">ENCRYPT_MODE</span><span class="token punctuation">,</span> <span class="token function">setKey</span><span class="token punctuation">(</span><span class="token constant">KEY</span><span class="token punctuation">)</span><span class="token punctuation">,</span> parameterSpec<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 加密测试文本</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;一次: &quot;</span> <span class="token operator">+</span> <span class="token class-name">Hex</span><span class="token punctuation">.</span><span class="token function">encodeHexString</span><span class="token punctuation">(</span>cipher<span class="token punctuation">.</span><span class="token function">doFinal</span><span class="token punctuation">(</span><span class="token string">&quot;abcdefghijklmnop&quot;</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 加密重复一次的测试文本</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;两次: &quot;</span> <span class="token operator">+</span> <span class="token class-name">Hex</span><span class="token punctuation">.</span><span class="token function">encodeHexString</span><span class="token punctuation">(</span>cipher<span class="token punctuation">.</span><span class="token function">doFinal</span><span class="token punctuation">(</span><span class="token string">&quot;abcdefghijklmnopabcdefghijklmnop&quot;</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 下面测试是否可以通过操纵密文来操纵明文  </span>
    <span class="token comment">// 发送方账号</span>
    <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> sender <span class="token operator">=</span> <span class="token string">&quot;1000000000012345&quot;</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 接收方账号</span>
    <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> receiver <span class="token operator">=</span> <span class="token string">&quot;1000000000034567&quot;</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 转账金额</span>
    <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> money <span class="token operator">=</span> <span class="token string">&quot;0000000010000000&quot;</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 加密发送方账号</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;发送方账号: &quot;</span> <span class="token operator">+</span> <span class="token class-name">Hex</span><span class="token punctuation">.</span><span class="token function">encodeHexString</span><span class="token punctuation">(</span>cipher<span class="token punctuation">.</span><span class="token function">doFinal</span><span class="token punctuation">(</span>sender<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 加密接收方账号</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;接收方账号: &quot;</span> <span class="token operator">+</span> <span class="token class-name">Hex</span><span class="token punctuation">.</span><span class="token function">encodeHexString</span><span class="token punctuation">(</span>cipher<span class="token punctuation">.</span><span class="token function">doFinal</span><span class="token punctuation">(</span>receiver<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 加密金额</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;金额: &quot;</span> <span class="token operator">+</span> <span class="token class-name">Hex</span><span class="token punctuation">.</span><span class="token function">encodeHexString</span><span class="token punctuation">(</span>cipher<span class="token punctuation">.</span><span class="token function">doFinal</span><span class="token punctuation">(</span>money<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 加密完整的转账信息</span>
    <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> result <span class="token operator">=</span> cipher<span class="token punctuation">.</span><span class="token function">doFinal</span><span class="token punctuation">(</span><span class="token class-name">ByteUtils</span><span class="token punctuation">.</span><span class="token function">concatAll</span><span class="token punctuation">(</span>sender<span class="token punctuation">,</span> receiver<span class="token punctuation">,</span> money<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;完整数据: &quot;</span> <span class="token operator">+</span> <span class="token class-name">Hex</span><span class="token punctuation">.</span><span class="token function">encodeHexString</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 用于操纵密文的临时字节数组</span>
    <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> hack <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span>result<span class="token punctuation">.</span>length<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token comment">// 把密文前两段交换</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">arraycopy</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">,</span> hack<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">arraycopy</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> hack<span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">arraycopy</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">,</span> hack<span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    cipher<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token class-name">Cipher</span><span class="token punctuation">.</span><span class="token constant">DECRYPT_MODE</span><span class="token punctuation">,</span> <span class="token function">setKey</span><span class="token punctuation">(</span><span class="token constant">KEY</span><span class="token punctuation">)</span><span class="token punctuation">,</span> parameterSpec<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 尝试解密</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;原始明文: &quot;</span> <span class="token operator">+</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span><span class="token class-name">ByteUtils</span><span class="token punctuation">.</span><span class="token function">concatAll</span><span class="token punctuation">(</span>sender<span class="token punctuation">,</span> receiver<span class="token punctuation">,</span> money<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;操纵密文: &quot;</span> <span class="token operator">+</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>cipher<span class="token punctuation">.</span><span class="token function">doFinal</span><span class="token punctuation">(</span>hack<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br></div></div><p>输出如下:</p> <p><img src="/img/dba72e97364e46f330d64fa7db12d1cf-20230731165210-fdiagv5.png" alt=""></p> <p>可以看到:</p> <ol><li>两个相同明文分组产生的密文, 就是两个相同的密文分组叠在一起.</li> <li>在不知道密钥的情况下, 操纵密文实现了对明文数据的修改, 对调了发送方账号和接收方账号.</li></ol> <p>所以说, <strong>ECB 模式虽然简单, 但是不安全, 不推荐使用</strong>. 再看一下另一种常用的加密模式, <strong>CBC 模式</strong>.</p> <p>CBC 模式, 在解密或解密之前引入了 XOR 运算, 第一个分组使用外部提供的初始化向量 IV, 从第二个分组开始使用前一个分组的数据, 这样即使明文是一样的, 加密后的密文也是不同的, 并且分组的顺序不能任意调换. 这就解决了 ECB 模式的缺陷:</p> <p><img src="/img/bbc1cad8265adb9d66ac23a77197540c-20230731165210-llnh5hr.png" alt=""></p> <p>把之前的代码修改为 CBC 模式, 再次进行测试:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> initVector <span class="token operator">=</span> <span class="token string">&quot;abcdefghijklmnop&quot;</span><span class="token punctuation">;</span> <span class="token comment">// 初始化向量</span>

<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;cbc&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">cbc</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token class-name">Cipher</span> cipher <span class="token operator">=</span> <span class="token class-name">Cipher</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token string">&quot;AES/CBC/NoPadding&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">IvParameterSpec</span> iv <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IvParameterSpec</span><span class="token punctuation">(</span>initVector<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token string">&quot;UTF-8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">test</span><span class="token punctuation">(</span>cipher<span class="token punctuation">,</span> iv<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>可以看到, 相同的明文字符串复制一遍得到的密文<strong>并不是重复两个密文分组, 并且调换密文分组的顺序无法操纵明文</strong>:</p> <p><img src="/img/f233cab30a88ed78fa111e08ece95d29-20230731165210-fif5274.png" alt=""></p> <p>《实用密码学》一书比较推荐的是 CBC 和 CTR 模式. 还需要注意的是, ECB 和 CBC 模式还需要设置合适的填充模式, 才能处理超过一个分组的数据.</p> <p>对于敏感数据保存, 除了选择 AES+ 合适模式进行加密外, 还推荐以下几个实践:</p> <ol><li>不要在代码中写死一个固定的密钥和初始化向量, 最好和之前提到的盐一样, 是唯一, 独立并且每次都变化的.</li> <li>推荐使用独立的加密服务来管控密钥, 做加密操作, 千万不要把密钥和密文存在一个数据库, 加密服务需要设置非常高的管控标准.</li> <li><strong>数据库中不能保存明文的敏感信息, 但可以保存脱敏的信息</strong>. 普通查询的时候, 直接查脱敏信息即可.</li></ol> <p>接下来, 按照这个策略完成相关代码实现.</p> <p>第一步, 对于用户姓名和身份证, 分别保存三个信息, <strong>脱敏后的明文, 密文和加密 ID</strong>. 加密服务加密后返回密文和加密 ID, 随后使用加密 ID 来请求加密服务进行解密:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Data</span>
<span class="token annotation punctuation">@Entity</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserData</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Id</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> id<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> idcard<span class="token punctuation">;</span><span class="token comment">// 脱敏的身份证</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> idcardCipherId<span class="token punctuation">;</span><span class="token comment">// 身份证加密ID</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> idcardCipherText<span class="token punctuation">;</span><span class="token comment">// 身份证密文</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span><span class="token comment">// 脱敏的姓名</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> nameCipherId<span class="token punctuation">;</span><span class="token comment">// 姓名加密ID</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> nameCipherText<span class="token punctuation">;</span><span class="token comment">// 姓名密文</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>第二步, <strong>加密服务数据表保存加密 ID, 初始化向量和密钥</strong>. 加密服务表中没有密文, 实现了<strong>密文和密钥分离保存</strong>:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Data</span>
<span class="token annotation punctuation">@Entity</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CipherData</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Id</span>
    <span class="token annotation punctuation">@GeneratedValue</span><span class="token punctuation">(</span>strategy <span class="token operator">=</span> <span class="token constant">AUTO</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> id<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> iv<span class="token punctuation">;</span><span class="token comment">// 初始化向量</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> secureKey<span class="token punctuation">;</span><span class="token comment">// 密钥</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>第三步, 加密服务使用 GCM 模式( Galois/Counter Mode)的 AES-256 对称加密算法, 也就是 AES-256-GCM.</p> <p>这是一种 AEAD(Authenticated Encryption with Associated Data)认证加密算法, 除了能实现普通加密算法提供的保密性之外, 还能实现可认证性和密文完整性, 是目前最推荐的 AES 模式.</p> <p>使用类似 GCM 的 AEAD 算法进行加解密, 除了需要提供初始化向量和密钥之外, 还可以提供一个 AAD(附加认证数据, additional authenticated data), 用于验证未包含在明文中的附加信息, 解密时不使用加密时的 AAD 将解密失败. 其实, GCM 模式的内部使用的就是 CTR 模式, 只不过还使用了 GMAC 签名算法, 对密文进行签名实现完整性校验.</p> <p>接下来, 实现基于 AES-256-GCM 的加密服务, 包含下面的主要逻辑:</p> <ol><li>加密时允许外部传入一个 AAD 用于认证, 加密服务每次都会使用新生成的随机值作为密钥和初始化向量.</li> <li>在加密后, 加密服务密钥和初始化向量保存到数据库中, 返回加密 ID 作为本次加密的标识.</li> <li>应用解密时, 需要提供加密 ID, 密文和加密时的 AAD 来解密. 加密服务使用加密 ID, 从数据库查询出密钥和初始化向量.</li></ol> <p>这段逻辑的实现代码比较长, 加了详细注释方便仔细阅读:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CipherService</span> <span class="token punctuation">{</span>
    <span class="token comment">// 密钥长度</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">AES_KEY_SIZE</span> <span class="token operator">=</span> <span class="token number">256</span><span class="token punctuation">;</span>
    <span class="token comment">// 初始化向量长度</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">GCM_IV_LENGTH</span> <span class="token operator">=</span> <span class="token number">12</span><span class="token punctuation">;</span>
    <span class="token comment">// GCM身份认证Tag长度</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">GCM_TAG_LENGTH</span> <span class="token operator">=</span> <span class="token number">16</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">CipherRepository</span> cipherRepository<span class="token punctuation">;</span>

    <span class="token comment">// 内部加密方法</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">doEncrypt</span><span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> plaintext<span class="token punctuation">,</span> <span class="token class-name">SecretKey</span> key<span class="token punctuation">,</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> iv<span class="token punctuation">,</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> aad<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token comment">// 加密算法</span>
        <span class="token class-name">Cipher</span> cipher <span class="token operator">=</span> <span class="token class-name">Cipher</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token string">&quot;AES/GCM/NoPadding&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// Key规范</span>
        <span class="token class-name">SecretKeySpec</span> keySpec <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SecretKeySpec</span><span class="token punctuation">(</span>key<span class="token punctuation">.</span><span class="token function">getEncoded</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;AES&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// GCM参数规范</span>
        <span class="token class-name">GCMParameterSpec</span> gcmParameterSpec <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">GCMParameterSpec</span><span class="token punctuation">(</span><span class="token constant">GCM_TAG_LENGTH</span> <span class="token operator">*</span> <span class="token number">8</span><span class="token punctuation">,</span> iv<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 加密模式</span>
        cipher<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token class-name">Cipher</span><span class="token punctuation">.</span><span class="token constant">ENCRYPT_MODE</span><span class="token punctuation">,</span> keySpec<span class="token punctuation">,</span> gcmParameterSpec<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 设置aad</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>aad <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
            cipher<span class="token punctuation">.</span><span class="token function">updateAAD</span><span class="token punctuation">(</span>aad<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 加密</span>
        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> cipherText <span class="token operator">=</span> cipher<span class="token punctuation">.</span><span class="token function">doFinal</span><span class="token punctuation">(</span>plaintext<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> cipherText<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 内部解密方法</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">doDecrypt</span><span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> cipherText<span class="token punctuation">,</span> <span class="token class-name">SecretKey</span> key<span class="token punctuation">,</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> iv<span class="token punctuation">,</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> aad<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token comment">// 加密算法</span>
        <span class="token class-name">Cipher</span> cipher <span class="token operator">=</span> <span class="token class-name">Cipher</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token string">&quot;AES/GCM/NoPadding&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// Key规范</span>
        <span class="token class-name">SecretKeySpec</span> keySpec <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SecretKeySpec</span><span class="token punctuation">(</span>key<span class="token punctuation">.</span><span class="token function">getEncoded</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;AES&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// GCM参数规范</span>
        <span class="token class-name">GCMParameterSpec</span> gcmParameterSpec <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">GCMParameterSpec</span><span class="token punctuation">(</span><span class="token constant">GCM_TAG_LENGTH</span> <span class="token operator">*</span> <span class="token number">8</span><span class="token punctuation">,</span> iv<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 解密模式</span>
        cipher<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token class-name">Cipher</span><span class="token punctuation">.</span><span class="token constant">DECRYPT_MODE</span><span class="token punctuation">,</span> keySpec<span class="token punctuation">,</span> gcmParameterSpec<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 设置aad</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>aad <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
            cipher<span class="token punctuation">.</span><span class="token function">updateAAD</span><span class="token punctuation">(</span>aad<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 解密</span>
        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> decryptedText <span class="token operator">=</span> cipher<span class="token punctuation">.</span><span class="token function">doFinal</span><span class="token punctuation">(</span>cipherText<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>decryptedText<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 加密入口</span>
    <span class="token keyword">public</span> <span class="token class-name">CipherResult</span> <span class="token function">encrypt</span><span class="token punctuation">(</span><span class="token class-name">String</span> data<span class="token punctuation">,</span> <span class="token class-name">String</span> aad<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token comment">// 加密结果</span>
        <span class="token class-name">CipherResult</span> encryptResult <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CipherResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 密钥生成器</span>
        <span class="token class-name">KeyGenerator</span> keyGenerator <span class="token operator">=</span> <span class="token class-name">KeyGenerator</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token string">&quot;AES&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 生成密钥</span>
        keyGenerator<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token constant">AES_KEY_SIZE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">SecretKey</span> key <span class="token operator">=</span> keyGenerator<span class="token punctuation">.</span><span class="token function">generateKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// IV数据</span>
        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> iv <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token constant">GCM_IV_LENGTH</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token comment">// 随机生成IV</span>
        <span class="token class-name">SecureRandom</span> random <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SecureRandom</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        random<span class="token punctuation">.</span><span class="token function">nextBytes</span><span class="token punctuation">(</span>iv<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 处理aad</span>
        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> aaddata <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>aad<span class="token punctuation">)</span><span class="token punctuation">)</span>
            aaddata <span class="token operator">=</span> aad<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 获得密文</span>
        encryptResult<span class="token punctuation">.</span><span class="token function">setCipherText</span><span class="token punctuation">(</span><span class="token class-name">Base64</span><span class="token punctuation">.</span><span class="token function">getEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">encodeToString</span><span class="token punctuation">(</span><span class="token function">doEncrypt</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> key<span class="token punctuation">,</span> iv<span class="token punctuation">,</span> aaddata<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 加密上下文数据</span>
        <span class="token class-name">CipherData</span> cipherData <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CipherData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 保存IV</span>
        cipherData<span class="token punctuation">.</span><span class="token function">setIv</span><span class="token punctuation">(</span><span class="token class-name">Base64</span><span class="token punctuation">.</span><span class="token function">getEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">encodeToString</span><span class="token punctuation">(</span>iv<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 保存密钥</span>
        cipherData<span class="token punctuation">.</span><span class="token function">setSecureKey</span><span class="token punctuation">(</span><span class="token class-name">Base64</span><span class="token punctuation">.</span><span class="token function">getEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">encodeToString</span><span class="token punctuation">(</span>key<span class="token punctuation">.</span><span class="token function">getEncoded</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        cipherRepository<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>cipherData<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 返回本地加密ID</span>
        encryptResult<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span>cipherData<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> encryptResult<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 解密入口</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">decrypt</span><span class="token punctuation">(</span><span class="token keyword">long</span> cipherId<span class="token punctuation">,</span> <span class="token class-name">String</span> cipherText<span class="token punctuation">,</span> <span class="token class-name">String</span> aad<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token comment">// 使用加密ID找到加密上下文数据</span>
        <span class="token class-name">CipherData</span> cipherData <span class="token operator">=</span> cipherRepository<span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span>cipherId<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">orElseThrow</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">&quot;invlaid cipherId&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 加载密钥</span>
        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> decodedKey <span class="token operator">=</span> <span class="token class-name">Base64</span><span class="token punctuation">.</span><span class="token function">getDecoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span>cipherData<span class="token punctuation">.</span><span class="token function">getSecureKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 初始化密钥</span>
        <span class="token class-name">SecretKey</span> originalKey <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SecretKeySpec</span><span class="token punctuation">(</span>decodedKey<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> decodedKey<span class="token punctuation">.</span>length<span class="token punctuation">,</span> <span class="token string">&quot;AES&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 加载IV</span>
        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> decodedIv <span class="token operator">=</span> <span class="token class-name">Base64</span><span class="token punctuation">.</span><span class="token function">getDecoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span>cipherData<span class="token punctuation">.</span><span class="token function">getIv</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 处理aad</span>
        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> aaddata <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>aad<span class="token punctuation">)</span><span class="token punctuation">)</span>
            aaddata <span class="token operator">=</span> aad<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 解密</span>
        <span class="token keyword">return</span> <span class="token function">doDecrypt</span><span class="token punctuation">(</span><span class="token class-name">Base64</span><span class="token punctuation">.</span><span class="token function">getDecoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span>cipherText<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> originalKey<span class="token punctuation">,</span> decodedIv<span class="token punctuation">,</span> aaddata<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br></div></div><p>第四步, 分别实现加密和解密接口用于测试.</p> <p>可以让用户选择, 如果需要保护二要素的话, 就自己输入一个查询密码作为 AAD. 系统需要读取用户敏感信息的时候, 还需要用户提供这个密码, 否则无法解密. 这样一来, 即使黑客拿到了用户数据库的密文, 加密服务的密钥和 IV, 也会因为缺少 AAD 无法解密:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Autowired</span>
<span class="token keyword">private</span> <span class="token class-name">CipherService</span> cipherService<span class="token punctuation">;</span>

<span class="token comment">// 加密</span>
<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;right&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">UserData</span> <span class="token function">right</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;name&quot;</span><span class="token punctuation">,</span> defaultValue <span class="token operator">=</span> <span class="token string">&quot;朱晔&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> name<span class="token punctuation">,</span>
                      <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;idcard&quot;</span><span class="token punctuation">,</span> defaultValue <span class="token operator">=</span> <span class="token string">&quot;300000000000001234&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> idCard<span class="token punctuation">,</span>
                      <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;aad&quot;</span><span class="token punctuation">,</span> required <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token class-name">String</span> aad<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token class-name">UserData</span> userData <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UserData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    userData<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span><span class="token number">1L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 脱敏姓名</span>
    userData<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token function">chineseName</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 脱敏身份证</span>
    userData<span class="token punctuation">.</span><span class="token function">setIdcard</span><span class="token punctuation">(</span><span class="token function">idCard</span><span class="token punctuation">(</span>idCard<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 加密姓名</span>
    <span class="token class-name">CipherResult</span> cipherResultName <span class="token operator">=</span> cipherService<span class="token punctuation">.</span><span class="token function">encrypt</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span>aad<span class="token punctuation">)</span><span class="token punctuation">;</span>
    userData<span class="token punctuation">.</span><span class="token function">setNameCipherId</span><span class="token punctuation">(</span>cipherResultName<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    userData<span class="token punctuation">.</span><span class="token function">setNameCipherText</span><span class="token punctuation">(</span>cipherResultName<span class="token punctuation">.</span><span class="token function">getCipherText</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 加密身份证</span>
    <span class="token class-name">CipherResult</span> cipherResultIdCard <span class="token operator">=</span> cipherService<span class="token punctuation">.</span><span class="token function">encrypt</span><span class="token punctuation">(</span>idCard<span class="token punctuation">,</span>aad<span class="token punctuation">)</span><span class="token punctuation">;</span>
    userData<span class="token punctuation">.</span><span class="token function">setIdcardCipherId</span><span class="token punctuation">(</span>cipherResultIdCard<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    userData<span class="token punctuation">.</span><span class="token function">setIdcardCipherText</span><span class="token punctuation">(</span>cipherResultIdCard<span class="token punctuation">.</span><span class="token function">getCipherText</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> userRepository<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>userData<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 解密</span>
<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;read&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">read</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;aad&quot;</span><span class="token punctuation">,</span> required <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token class-name">String</span> aad<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token comment">// 查询用户信息</span>
    <span class="token class-name">UserData</span> userData <span class="token operator">=</span> userRepository<span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span><span class="token number">1L</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 使用AAD来解密姓名和身份证</span>
    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;name : {} idcard : {}&quot;</span><span class="token punctuation">,</span>
            cipherService<span class="token punctuation">.</span><span class="token function">decrypt</span><span class="token punctuation">(</span>userData<span class="token punctuation">.</span><span class="token function">getNameCipherId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> userData<span class="token punctuation">.</span><span class="token function">getNameCipherText</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>aad<span class="token punctuation">)</span><span class="token punctuation">,</span>
            cipherService<span class="token punctuation">.</span><span class="token function">decrypt</span><span class="token punctuation">(</span>userData<span class="token punctuation">.</span><span class="token function">getIdcardCipherId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> userData<span class="token punctuation">.</span><span class="token function">getIdcardCipherText</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>aad<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 脱敏身份证</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">idCard</span><span class="token punctuation">(</span><span class="token class-name">String</span> idCard<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">String</span> num <span class="token operator">=</span> <span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">right</span><span class="token punctuation">(</span>idCard<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">leftPad</span><span class="token punctuation">(</span>num<span class="token punctuation">,</span> <span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span>idCard<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;*&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 脱敏姓名</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">chineseName</span><span class="token punctuation">(</span><span class="token class-name">String</span> chineseName<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">String</span> name <span class="token operator">=</span> <span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">left</span><span class="token punctuation">(</span>chineseName<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">rightPad</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span>chineseName<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;*&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br></div></div><p>访问加密接口获得如下结果, 可以看到数据库表中只有脱敏数据和密文:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token punctuation">{</span><span class="token string">&quot;id&quot;</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">&quot;name&quot;</span><span class="token operator">:</span><span class="token string">&quot;朱*&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;idcard&quot;</span><span class="token operator">:</span><span class="token string">&quot;**************1234&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;idcardCipherId&quot;</span><span class="token operator">:</span><span class="token number">26346</span><span class="token punctuation">,</span><span class="token string">&quot;idcardCipherText&quot;</span><span class="token operator">:</span><span class="token string">&quot;t/wIh1XTj00wJP1Lt3aGzSvn9GcqQWEwthN58KKU4KZ4Tw&lt;mark&gt;&amp;quot;,&amp;quot;nameCipherId&amp;quot;:26347,&amp;quot;nameCipherText&amp;quot;:&amp;quot;+gHrk1mWmveBMVUo+CYon8Zjj9QAtw&lt;/mark&gt;&quot;</span><span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>访问解密接口, 可以看到解密成功了:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token punctuation">[</span><span class="token number">21</span><span class="token operator">:</span><span class="token number">46</span><span class="token operator">:</span><span class="token number">00.079</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>http<span class="token operator">-</span>nio<span class="token operator">-</span><span class="token number">45678</span><span class="token operator">-</span>exec<span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token constant">INFO</span> <span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>g<span class="token punctuation">.</span>t<span class="token punctuation">.</span>c<span class="token punctuation">.</span>s<span class="token punctuation">.</span>s<span class="token punctuation">.</span></span>StoreIdCardController</span><span class="token operator">:</span><span class="token number">102</span> <span class="token punctuation">]</span> <span class="token operator">-</span> name <span class="token operator">:</span> 朱晔 idcard <span class="token operator">:</span> <span class="token number">300000000000001234</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>如果 AAD 输入不对, 会得到如下异常:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name"><span class="token namespace">javax<span class="token punctuation">.</span>crypto<span class="token punctuation">.</span></span>AEADBadTagException</span><span class="token operator">:</span> <span class="token class-name">Tag</span> mismatch<span class="token operator">!</span>
at <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>sun<span class="token punctuation">.</span>crypto<span class="token punctuation">.</span>provider<span class="token punctuation">.</span></span>GaloisCounterMode</span><span class="token punctuation">.</span><span class="token function">decryptFinal</span><span class="token punctuation">(</span><span class="token class-name">GaloisCounterMode</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">578</span><span class="token punctuation">)</span>
at <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>sun<span class="token punctuation">.</span>crypto<span class="token punctuation">.</span>provider<span class="token punctuation">.</span></span>CipherCore</span><span class="token punctuation">.</span><span class="token function">finalNoPadding</span><span class="token punctuation">(</span><span class="token class-name">CipherCore</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">1116</span><span class="token punctuation">)</span>
at <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>sun<span class="token punctuation">.</span>crypto<span class="token punctuation">.</span>provider<span class="token punctuation">.</span></span>CipherCore</span><span class="token punctuation">.</span><span class="token function">fillOutputBuffer</span><span class="token punctuation">(</span><span class="token class-name">CipherCore</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">1053</span><span class="token punctuation">)</span>
at <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>sun<span class="token punctuation">.</span>crypto<span class="token punctuation">.</span>provider<span class="token punctuation">.</span></span>CipherCore</span><span class="token punctuation">.</span><span class="token function">doFinal</span><span class="token punctuation">(</span><span class="token class-name">CipherCore</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">853</span><span class="token punctuation">)</span>
at <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>sun<span class="token punctuation">.</span>crypto<span class="token punctuation">.</span>provider<span class="token punctuation">.</span></span>AESCipher</span><span class="token punctuation">.</span><span class="token function">engineDoFinal</span><span class="token punctuation">(</span><span class="token class-name">AESCipher</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">446</span><span class="token punctuation">)</span>
at <span class="token class-name"><span class="token namespace">javax<span class="token punctuation">.</span>crypto<span class="token punctuation">.</span></span>Cipher</span><span class="token punctuation">.</span><span class="token function">doFinal</span><span class="token punctuation">(</span><span class="token class-name">Cipher</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">2164</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>经过这样的设计, 二要素就比较安全了. 黑客要查询用户二要素的话, <strong>需要同时拿到密文, IV+ 密钥, AAD</strong>. 而这三者可能由三方掌管, 要全部拿到比较困难.</p> <h5 id="用一张图说清楚https"><a href="#用一张图说清楚https" class="header-anchor">#</a> 用一张图说清楚HTTPS</h5> <p>HTTP 协议传输数据使用的是明文. 那在传输敏感信息的场景下, 如果客户端和服务端中间有一个黑客作为中间人拦截请求, 就可以窃听到这些数据, 还可以修改客户端传过来的数据. 这就是很大的安全隐患.</p> <p>为解决这个安全隐患, 有了 HTTPS 协议. <code>HTTPS = SSL/TLS + HTTP</code>​, 通过使用一系列加密算法来确保信息安全传输, 以实现数据传输的机密性, 完整性和权威性.</p> <ol><li><strong>机密性</strong>: 使用非对称加密来加密密钥, 然后使用密钥来加密数据, 既安全又解决了非对称加密大量数据慢的问题.</li> <li><strong>完整性</strong>: 使用散列算法对信息进行摘要, 确保信息完整无法被中间人篡改.</li> <li><strong>权威性</strong>: 使用数字证书, 来确保我们是在和合法的服务端通信.</li></ol> <p>可以看出, 理解 HTTPS 的流程, 将有助于理解各种加密算法的区别, 以及证书的意义. 此外, SSL/TLS 还是混合加密系统的一个典范, 如果需要自己开发应用层数据加密系统, 也可以参考它的流程.</p> <p>那就来看看 HTTPS TLS 1.2 连接(RSA 握手)的整个过程.</p> <p><img src="/img/bc16ad0e8771a9140324a37e18b90613-20230731165210-dgvfoti.png" alt=""></p> <p>作为准备工作, 网站管理员需要申请并安装 CA 证书到服务端. <strong>CA 证书中包含非对称加密的公钥, 网站域名等信息, 密钥是服务端自己保存的, 不会在任何地方公开</strong>.</p> <p>建立 HTTPS 连接的过程, 首先是 TCP 握手, 然后是 TLS 握手的一系列工作, 包括:</p> <ul><li>客户端告知服务端自己支持的<strong>密码套件</strong>(比如 TLS_RSA_WITH_AES_256_GCM_SHA384, 其中 RSA 是密钥交换的方式, AES_256_GCM 是加密算法, SHA384 是消息验证摘要算法), 提供客户端随机数.</li> <li>服务端应答选择的密码套件, 提供服务端随机数.</li> <li><strong>服务端发送 CA 证书给客户端, 客户端验证 CA 证书</strong>(后面详细说明).</li> <li><strong>客户端生成 PreMasterKey, 并使用非对称加密 + 公钥加密 PreMasterKey</strong>.</li> <li><strong>客户端把加密后的 PreMasterKey 传给服务端</strong>.</li> <li><strong>服务端使用非对称加密 + 私钥解密得到 PreMasterKey, 并使用 PreMasterKey+ 两个随机数, 生成 MasterKey</strong>.</li> <li><strong>客户端也使用 PreMasterKey+ 两个随机数生成 MasterKey.</strong></li> <li>客户端告知服务端之后将进行加密传输.</li> <li>客户端使用 MasterKey 配合对称加密算法, 进行对称加密测试.</li> <li>服务端也使用 MasterKey 配合对称加密算法, 进行对称加密测试.</li></ul> <p>接下来, 客户端和服务端的所有通信都是加密通信, 并且数据通过签名确保无法篡改. 你可能会问, 客户端怎么验证 CA 证书呢?</p> <p>其实, <strong>CA 证书是一个证书链</strong>, 可以看一下上图的左边部分:</p> <ol><li>从服务端拿到的 CA 证书是用户证书, 需要通过证书中的签发人信息找到上级中间证书, 再网上<strong>找到根证书</strong>.</li> <li><strong>根证书只有为数不多的权威机构才能生成, 一般预置在 OS 中, 根本无法伪造</strong>.</li> <li>找到根证书后, 提取其公钥来验证中间证书的签名, 判断其权威性.</li> <li>最后再拿到中间证书的公钥, 验证用户证书的签名.</li></ol> <p>这就验证了用户证书的合法性, 然后再校验其有效期, 域名等信息进一步验证有效性.</p> <p>总结一下, TLS 通过巧妙的流程和算法搭配解决了传输安全问题: <strong>使用对称加密加密数据, 使用非对称加密算法确保密钥无法被中间人解密; 使用 CA 证书链认证, 确保中间人无法伪造自己的证书和公钥</strong>.</p> <p>如果网站涉及敏感数据的传输, 必须使用 HTTPS 协议. 作为用户, 如果看到网站不是 HTTPS 的或者看到无效证书警告, 也不应该继续使用这个网站, 以免敏感信息被泄露.</p> <h5 id="重点回顾-29"><a href="#重点回顾-29" class="header-anchor">#</a> 重点回顾</h5> <p>今天一起学习了如何保存和传输敏感数据. 回顾一下重点内容.</p> <p>对于数据保存, 需要记住两点:</p> <ol><li><strong>用户密码不能加密保存, 更不能明文保存, 需要使用全球唯一的, 具有一定长度的, 随机的盐, 配合单向散列算法保存. 使用 BCrypt 算法, 是一个比较好的实践.</strong></li> <li><strong>诸如姓名和身份证这种需要可逆解密查询的敏感信息, 需要使用对称加密算法保存</strong>. 建议是把脱敏数据和密文保存在业务数据库, 独立使用加密服务来做数据加解密; 对称加密需要用到的密钥和初始化向量, 可以和业务数据库分开保存.</li></ol> <p>对于数据传输, 则务必通过 SSL/TLS 进行传输. 对于用于客户端到服务端传输数据的 HTTP, 需要使用基于 SSL/TLS 的 HTTPS. 对于一些走 TCP 的 RPC 服务, 同样可以使用 SSL/TLS 来确保传输安全.</p> <h3 id="加餐篇"><a href="#加餐篇" class="header-anchor">#</a> 加餐篇</h3> <h4 id="加餐-定位应用问题-排错套路很重要"><a href="#加餐-定位应用问题-排错套路很重要" class="header-anchor">#</a> 加餐-定位应用问题,排错套路很重要</h4> <p>今天这一讲说说我在应急排错方面积累的心得. 这都是我多年担任技术负责人和架构师自己总结出来的, 希望对你有所帮助.</p> <h5 id="在不同环境排查问题-有不同的方式"><a href="#在不同环境排查问题-有不同的方式" class="header-anchor">#</a> 在不同环境排查问题,有不同的方式</h5> <p>要说排查问题的思路, 首先得明白是在什么环境排错.</p> <ol><li>如果是在自己的开发环境排查问题, 那几乎可以使用任何自己熟悉的工具来排查, 甚至可以进行单步调试. 只要问题能重现, 排查就不会太困难, 最多就是把程序调试到 JDK 或三方类库内部进行分析.</li> <li>如果是在测试环境排查问题, 相比开发环境少的是调试, 不过可以使用 JDK 自带的 jvisualvm 或阿里的Arthas, 附加到远程的 JVM 进程排查问题. 另外, 测试环境允许造数据, 造压力模拟需要的场景, 因此遇到偶发问题时, 可以尝试去造一些场景让问题更容易出现, 方便测试.</li> <li>如果是在生产环境排查问题, 往往比较难: 一方面, 生产环境权限管控严格, 一般不允许调试工具从远程附加进程; 另一方面, 生产环境出现问题要求以恢复为先, 难以留出充足的时间去慢慢排查问题. 但因为生产环境的流量真实, 访问量大, 网络权限管控严格, 环境复杂, 因此更容易出问题, 也是出问题最多的环境.</li></ol> <p>接下来就详细说说, 如何在生产环境排查问题.</p> <h5 id="生产问题的排查很大程度依赖监控"><a href="#生产问题的排查很大程度依赖监控" class="header-anchor">#</a> 生产问题的排查很大程度依赖监控</h5> <p>其实, 排查问题就像在破案, 生产环境出现问题时, 因为要尽快恢复应用, 就不可能保留完整现场用于排查和测试. 因此, 是否有充足的信息可以了解过去, 还原现场就成了破案的关键. 这里说的信息, 主要就是<strong>日志, 监控和快照</strong>.</p> <p>日志就不用多说了, 主要注意两点:</p> <ol><li>确保错误, 异常信息可以被完整地记录到文件日志中;</li> <li>确保生产上程序的日志级别是 INFO 以上. 记录日志要使用合理的日志优先级, DEBUG 用于开发调试, INFO 用于重要流程信息, WARN 用于需要关注的问题, ERROR 用于阻断流程的错误.</li></ol> <p>对于监控, 在生产环境排查问题时, 首先就需要开发和运维团队做好充足的监控, 而且是多个层次的监控.</p> <ol><li><strong>主机层面, 对 CPU, 内存, 磁盘, 网络等资源做监控</strong>. 如果应用部署在虚拟机或 Kubernetes 集群中, 那么除了对物理机做基础资源监控外, 还要对虚拟机或 Pod 做同样的监控. 监控层数取决于应用的部署方案, 有一层 OS 就要做一层监控.</li> <li><strong>网络层面, 需要监控专线带宽, 交换机基本情况, 网络延迟</strong>.</li> <li><strong>所有的中间件和存储都要做好监控, 不仅仅是监控进程对 CPU, 内存, 磁盘 IO, 网络使用的基本指标, 更重要的是监控组件内部的一些重要指标</strong>. 比如, 著名的监控工具 Prometheus, 就提供了大量的 exporter 来对接各种中间件和存储系统.</li> <li><strong>应用层面, 需要监控 JVM 进程的类加载, 内存, GC, 线程等常见指标</strong>(比如使用 Micrometer 来做应用监控), 此外还要确保能够收集, 保存应用日志, GC 日志.</li></ol> <p>再来看看快照. 这里的 &quot;快照&quot; 是指, 应用进程在某一时刻的快照. 通常情况下, 会为生产环境的 Java 应用设置 <code>-XX:+HeapDumpOnOutOfMemoryError</code>​ 和 <code>-XX:HeapDumpPath</code>​ 这 2 个 JVM 参数, 用于在出现 OOM 时保留堆快照.</p> <p>了解过去, 还原现场后, 接下来就看看定位问题的套路.</p> <h5 id="分析定位问题的套路"><a href="#分析定位问题的套路" class="header-anchor">#</a> 分析定位问题的套路</h5> <p>定位问题, 首先要定位问题出在哪个层次上. 比如, 是 Java 应用程序自身的问题还是外部因素导致的问题. 可以先查看程序是否有异常, 异常信息一般比较具体, 可以马上定位到大概的问题方向; 如果是一些资源消耗型的问题可能不会有异常, 可以通过指标监控配合显性问题点来定位.</p> <p>一般情况下, 程序的问题来自以下三个方面.</p> <p>第一, <strong>程序发布后的 Bug, 回滚后可以立即解决</strong>. 这类问题的排查, 可以回滚后再慢慢分析版本差异.</p> <p>第二, <strong>外部因素, 比如主机, 中间件或数据库的问题</strong>. 这类问题的排查方式, 按照主机层面的问题, 中间件或存储(统称组件)的问题分为两类.</p> <p>主机层面的问题, 可以使用工具排查:</p> <ol><li>CPU 相关问题, 可以使用 top, vmstat, pidstat, ps 等工具排查;</li> <li>内存相关问题, 可以使用 free, top, ps, vmstat, cachestat, sar 等工具排查;</li> <li>IO 相关问题, 可以使用 lsof, iostat, pidstat, sar, iotop, df, du 等工具排查;</li> <li>网络相关问题, 可以使用 ifconfig, ip, nslookup, dig, ping, tcpdump, iptables 等工具排查.</li></ol> <p>组件的问题, 可以从以下几个方面排查:</p> <ol><li><strong>排查组件所在主机是否有问题;</strong></li> <li><strong>排查组件进程基本情况, 观察各种监控指标;</strong></li> <li><strong>查看组件的日志输出, 特别是错误日志;</strong></li> <li><strong>进入组件控制台, 使用一些命令查看其运作情况.</strong></li></ol> <p>第三, 因为系统资源不够造成系统假死的问题, 通常需要先通过重启和扩容解决问题, 之后再进行分析, 不过最好能留一个节点作为现场. 系统资源不够, 一般体现在 CPU 使用高, 内存泄漏或 OOM 的问题, IO 问题, 网络相关问题这四个方面.</p> <p>对于 CPU 使用高的问题, 如果现场还在, 具体的分析流程是:</p> <ol><li>首先, 在 Linux 服务器上运行 top -Hp pid 命令, 来查看进程中哪个线程 CPU 使用高;</li> <li>然后, 输入大写的 P 将线程按照 CPU 使用率排序, 并把明显占用 CPU 的线程 ID 转换为 16 进制;</li> <li>最后, 在 jstack 命令输出的线程栈中搜索这个线程 ID, 定位出问题的线程当时的调用栈.</li></ol> <p>如果没有条件直接在服务器上运行 top 命令的话, 可以用采样的方式定位问题: <strong>间隔固定秒数(比如 10 秒)运行一次 jstack 命令, 采样几次后, 对比采样得出哪些线程始终处于运行状态, 分析出问题的线程</strong>.</p> <p>如果现场没有了, 可以通过排除法来分析. CPU 使用高, 一般是由下面的因素引起的:</p> <ol><li><strong>突发压力</strong>. 这类问题, 可以通过应用之前的负载均衡的流量或日志量来确认, 诸如 Nginx 等反向代理都会记录 URL, 可以依靠代理的 Access Log 进行细化定位, 也可以通过监控观察 JVM 线程数的情况. 压力问题导致 CPU 使用高的情况下, 如果程序的各资源使用没有明显不正常, 之后可以通过压测 +Profiler(jvisualvm 就有这个功能)进一步定位热点方法; 如果资源使用不正常, 比如产生了几千个线程, 就需要考虑调参.</li> <li><strong>GC</strong>. 这种情况, 可以通过 JVM 监控 GC 相关指标, GC Log 进行确认. 如果确认是 GC 的压力, 那么内存使用也很可能会不正常, 需要按照内存问题分析流程做进一步分析.</li> <li><strong>程序中死循环逻辑或不正常的处理流程</strong>. 这类问题可以结合应用日志分析. 一般情况下, 应用执行过程中都会产生一些日志, 可以重点关注日志量异常部分.</li></ol> <p>对于内存泄露或 OOM 的问题, 最简单的分析方式, 就是<strong>堆转储后使用 MAT 分析</strong>. 堆转储, 包含了堆现场全貌和线程栈信息, 一般观察支配树图, 直方图就可以马上看到占用大量内存的对象, 可以快速定位到内存相关问题.</p> <p>需要注意的是, Java 进程对内存的使用不仅仅是堆区, 还包括线程使用的内存(线程个数 * 每一个线程的线程栈)和元数据区. 每一个内存区都可能产生 OOM, 可以结合监控观察线程数, 已加载类数量等指标分析. 另外需要注意看一下, JVM 参数的设置是否有明显不合理的地方, 限制了资源使用.</p> <p>IO 相关的问题, 除非是代码问题引起的资源不释放等问题, 否则通常都不是由 Java 进程内部因素引发的.</p> <p>网络相关的问题, 一般也是由外部因素引起的. 对于连通性问题, 结合异常信息通常比较容易定位; 对于性能或瞬断问题, 可以先尝试使用 ping 等工具简单判断, 如果不行再使用 tcpdump 或 Wireshark 来分析.</p> <h5 id="分析和定位问题需要注意的九个点"><a href="#分析和定位问题需要注意的九个点" class="header-anchor">#</a> 分析和定位问题需要注意的九个点</h5> <p>有些时候, 分析和定位问题时, 会陷入误区或是找不到方向. 遇到这种情况, 可以借鉴下我的九个心得.</p> <p><strong>第一, 考虑 &quot;鸡&quot; 和 &quot;蛋&quot; 的问题.</strong>  比如, 发现业务逻辑执行很慢且线程数增多的情况时, 需要考虑两种可能性:</p> <ol><li>一是, 程序逻辑有问题或外部依赖慢, 使得业务逻辑执行慢, 在访问量不变的情况下需要更多的线程数来应对. 比如, 10TPS 的并发原先一次请求 1s 可以执行完成, 10 个线程可以支撑; 现在执行完成需要 10s, 那就需要 100 个线程.</li> <li>二是, 有可能是请求量增大了, 使得线程数增多, 应用本身的 CPU 资源不足, 再加上上下文切换问题导致处理变慢了.</li></ol> <p>出现问题的时候, 需要结合内部表现和入口流量一起看, <strong>确认这里的 &quot;慢&quot; 到底是根因还是结果</strong>.</p> <p><strong>第二, 考虑通过分类寻找规律.</strong>  在定位问题没有头绪的时候, 可以尝试总结规律.</p> <p>比如, 有 10 台应用服务器做负载均衡, 出问题时可以通过日志分析是否是均匀分布的, 还是问题都出现在 1 台机器. 又比如, 应用日志一般会记录线程名称, 出问题时可以分析日志是否集中在某一类线程上. 再比如, 如果发现应用开启了大量 TCP 连接, 通过 netstat 可以分析出主要集中连接到哪个服务.</p> <p>如果能总结出规律, 很可能就找到了突破点.</p> <p><strong>第三, 分析问题需要根据调用拓扑来, 不能想当然.</strong>  比如看到 Nginx 返回 502 错误, 一般可以认为是下游服务的问题导致网关无法完成请求转发. 对于下游服务, 不能想当然就认为是 Java 程序, 比如在拓扑上可能 Nginx 代理的是 Kubernetes 的 Traefik Ingress, 链路是 Nginx-&gt;Traefik-&gt; 应用, 如果一味排查 Java 程序的健康情况, 那么始终不会找到根因.</p> <p>又比如, 虽然使用了 Spring Cloud Feign 来进行服务调用, 出现连接超时也不一定就是服务端的问题, 有可能是客户端通过 URL 来调用服务端, 并不是通过 Eureka 的服务发现实现的客户端负载均衡. 换句话说, 客户端连接的是 Nginx 代理而不是直接连接应用, 客户端连接服务出现的超时, 其实是 Nginx 代理宕机所致.</p> <p>**第四, 考虑资源限制类问题. **观察各种曲线指标, 如果发现曲线慢慢上升然后稳定在一个水平线上, 那么一般就是资源达到了限制或瓶颈.</p> <p>比如, 在观察网络带宽曲线的时候, 如果发现带宽上升到 120MB 左右不动了, 那么很可能就是打满了 1GB 的网卡或传输带宽. 又比如, 观察到数据库活跃连接数上升到 10 个就不动了, 那么很可能是连接池打满了. 观察监控一旦看到任何这样的曲线, 都要引起重视.</p> <p>**第五, 考虑资源相互影响. **CPU, 内存, IO 和网络, 这四类资源就像人的五脏六腑, 是相辅相成的, 一个资源出现了明显的瓶颈, 很可能会引起其他资源的连锁反应.</p> <p>比如, 内存泄露后对象无法回收会造成大量 Full GC, 此时 CPU 会大量消耗在 GC 上从而引起 CPU 使用增加. 又比如, 我们经常会把数据缓存在内存队列中进行异步 IO 处理, 网络或磁盘出现问题时, 就很可能会引起内存的暴涨. 因此, 出问题的时候, 要考虑到这一点, 以避免误判.</p> <p>**第六, 排查网络问题要考虑三个方面, 到底是客户端问题, 还是服务端问题, 还是传输问题. **比如, 出现数据库访问慢的现象, 可能是客户端的原因, 连接池不够导致连接获取慢, GC 停顿, CPU 占满等; 也可能是传输环节的问题, 包括光纤, 防火墙, 路由表设置等问题; 也可能是真正的服务端问题, 需要逐一排查来进行区分.</p> <p>服务端慢一般可以看到 MySQL 出慢日志, 传输慢一般可以通过 ping 来简单定位, 排除了这两个可能, 并且仅仅是部分客户端出现访问慢的情况, 就需要怀疑是客户端本身的问题. 对于第三方系统, 服务或存储访问出现慢的情况, 不能完全假设是服务端的问题.</p> <p><strong>第七, 快照类工具和趋势类工具需要结合使用.</strong>  比如, jstat, top, 各种监控曲线是趋势类工具, 可以观察各个指标的变化情况, 定位大概的问题点; 而 jstack 和分析堆快照的 MAT 是快照类工具, 用于详细分析某一时刻应用程序某一个点的细节.</p> <p>一般情况下, 会先使用趋势类工具来总结规律, 再使用快照类工具来分析问题. 如果反过来可能就会误判, 因为快照类工具反映的只是一个瞬间程序的情况, 不能仅仅通过分析单一快照得出结论, 如果缺少趋势类工具的帮助, 那至少也要提取多个快照来对比.</p> <p><strong>第八, 不要轻易怀疑监控.</strong>  我曾看过一个空难事故的分析, 飞行员在空中发现仪表显示飞机所有油箱都处于缺油的状态, 他第一时间的怀疑是油表出现故障了, 始终不愿意相信是真的缺油, 结果飞行不久后引擎就断油熄火了. 同样地, 在应用出现问题时, 我们会查看各种监控系统, 但有些时候我们宁愿相信自己的经验, 也不相信监控图表的显示. 这可能会导致完全朝着错误的方向来排查问题. 如果你真的怀疑是监控系统有问题, 可以看一下这套监控系统对于不出问题的应用显示是否正常, 如果正常那就应该相信监控而不是自己的经验.</p> <p><strong>第九, 如果因为监控缺失等原因无法定位到根因的话, 相同问题就有再出现的风险</strong>, 需要做好三项工作:</p> <ol><li>做好日志, 监控和快照补漏工作, 下次遇到问题时可以定位根因;</li> <li>针对问题的症状做好实时报警, 确保出现问题后可以第一时间发现;</li> <li>考虑做一套热备的方案, 出现问题后可以第一时间切换到热备系统快速解决问题, 同时又可以保留老系统的现场.</li></ol> <h4 id="加餐-分析定位java问题-一定要用好这些工具"><a href="#加餐-分析定位java问题-一定要用好这些工具" class="header-anchor">#</a> 加餐-分析定位Java问题,一定要用好这些工具</h4> <p>今天要分享的内容是分析定位 Java 问题常用的一些工具.</p> <p>你可能一开始会比较畏惧使用复杂的工具去排查问题, 又或者是打开了工具感觉无从下手, 但是随着实践越来越多, 对 Java 程序和各种框架的运作越来越熟悉, 你会发现使用这些工具越来越顺手.</p> <p>其实工具只是定位问题的手段, 要用好工具主要还是得对程序本身的运作有大概的认识, 这需要长期的积累.</p> <p>因此, 下面会通过两篇加餐, 分享 4 个案例, 分别展示使用 JDK 自带的工具来排查 JVM 参数配置问题, 使用 Wireshark 来分析网络问题, 通过 MAT 来分析内存问题, 以及使用 Arthas 来分析 CPU 使用高的问题. 这些案例也只是冰山一角, 可以自己再通过些例子进一步学习和探索.</p> <h5 id="使用jdk自带工具查看jvm情况"><a href="#使用jdk自带工具查看jvm情况" class="header-anchor">#</a> 使用JDK自带工具查看JVM情况</h5> <p>JDK 自带了很多命令行甚至是图形界面工具, 可以查看 JVM 的一些信息. 比如, 在我的机器上运行 ls 命令, 可以看到 JDK 8 提供了非常多的工具或程序:</p> <p><img src="/img/7048aaf71a4b7633e81b35cdbc831edb-20230731165210-q2a6heb.png" alt=""></p> <p>接下来会介绍些常用的监控工具. 也可以先通过下面这张图了解下各种工具的基本作用:</p> <p><img src="/img/c881489b61b488e3ac8d479278ffa199-20230731165210-xp5zhn7.png" alt=""></p> <p>为了测试这些工具, 先来写一段代码: 启动 10 个死循环的线程, 每个线程分配一个 10MB 左右的字符串, 然后休眠 10 秒. 可以想象到, 这个程序会对 GC 造成压力.</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// 启动10个线程</span>
<span class="token class-name">IntStream</span><span class="token punctuation">.</span><span class="token function">rangeClosed</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">mapToObj</span><span class="token punctuation">(</span>i <span class="token operator">-&gt;</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 每一个线程都是一个死循环, 休眠10秒, 打印10M数据</span>
        <span class="token class-name">String</span> payload <span class="token operator">=</span> <span class="token class-name">IntStream</span><span class="token punctuation">.</span><span class="token function">rangeClosed</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">10000000</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">mapToObj</span><span class="token punctuation">(</span>__ <span class="token operator">-&gt;</span> <span class="token string">&quot;a&quot;</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">joining</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token constant">UUID</span><span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>payload<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token operator">::</span><span class="token function">start</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">HOURS</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>修改 pom.xml, 配置 spring-boot-maven-plugin 插件打包的 Java 程序的 main 方法类:</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugin</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-maven-plugin<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>configuration</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>mainClass</span><span class="token punctuation">&gt;</span></span>org.geekbang.time.commonmistakes.troubleshootingtools.jdktool.CommonMistakesApplication
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>mainClass</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>configuration</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugin</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>然后使用 <code>java -jar</code>​ 启动进程, 设置 JVM 参数, 让堆最小最大都是 1GB:</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code>java -jar common-mistakes-0.0.1-SNAPSHOT.jar -Xms1g -Xmx1g
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>完成这些准备工作后, 就可以使用 JDK 提供的工具, 来观察分析这个测试程序了.</p> <h6 id="jps"><a href="#jps" class="header-anchor">#</a> jps</h6> <p>首先使用 jps 得到 Java 进程列表, 这会比使用 ps 来的方便:</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>➜  ~ jps
<span class="token number">12707</span>
<span class="token number">22261</span> Launcher
<span class="token number">23864</span> common-mistakes-0.0.1-SNAPSHOT.jar
<span class="token number">15608</span> RemoteMavenServer36
<span class="token number">23243</span> Main
<span class="token number">23868</span> Jps
<span class="token number">22893</span> KotlinCompileDaemon
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h6 id="jinfo"><a href="#jinfo" class="header-anchor">#</a> jinfo</h6> <p>然后, 可以使用 jinfo 打印 JVM 的各种参数:</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>➜  ~ jinfo <span class="token number">23864</span>
Java System Properties:
<span class="token comment">#Wed Jan 29 12:49:47 CST 2020</span>
<span class="token punctuation">..</span>.
<span class="token assign-left variable">user.name</span><span class="token operator">=</span>zhuye
<span class="token assign-left variable">path.separator</span><span class="token operator">=</span><span class="token punctuation">\</span>:
<span class="token assign-left variable">os.version</span><span class="token operator">=</span><span class="token number">10.15</span>.2
<span class="token assign-left variable">java.runtime.name</span><span class="token operator">=</span>Java<span class="token punctuation">(</span>TM<span class="token punctuation">)</span> SE Runtime Environment
<span class="token assign-left variable">file.encoding</span><span class="token operator">=</span>UTF-8
<span class="token assign-left variable">java.vm.name</span><span class="token operator">=</span>Java HotSpot<span class="token punctuation">(</span>TM<span class="token punctuation">)</span> <span class="token number">64</span>-Bit Server VM
<span class="token punctuation">..</span>.
VM Flags:
<span class="token parameter variable">-XX:CICompilerCount</span><span class="token operator">=</span><span class="token number">4</span> <span class="token parameter variable">-XX:ConcGCThreads</span><span class="token operator">=</span><span class="token number">2</span> <span class="token parameter variable">-XX:G1ConcRefinementThreads</span><span class="token operator">=</span><span class="token number">8</span> <span class="token parameter variable">-XX:G1HeapRegionSize</span><span class="token operator">=</span><span class="token number">1048576</span> <span class="token parameter variable">-XX:GCDrainStackTargetSize</span><span class="token operator">=</span><span class="token number">64</span> <span class="token parameter variable">-XX:InitialHeapSize</span><span class="token operator">=</span><span class="token number">268435456</span> <span class="token parameter variable">-XX:MarkStackSize</span><span class="token operator">=</span><span class="token number">4194304</span> <span class="token parameter variable">-XX:MaxHeapSize</span><span class="token operator">=</span><span class="token number">4294967296</span> <span class="token parameter variable">-XX:MaxNewSize</span><span class="token operator">=</span><span class="token number">2576351232</span> <span class="token parameter variable">-XX:MinHeapDeltaBytes</span><span class="token operator">=</span><span class="token number">1048576</span> <span class="token parameter variable">-XX:NonNMethodCodeHeapSize</span><span class="token operator">=</span><span class="token number">5835340</span> <span class="token parameter variable">-XX:NonProfiledCodeHeapSize</span><span class="token operator">=</span><span class="token number">122911450</span> <span class="token parameter variable">-XX:ProfiledCodeHeapSize</span><span class="token operator">=</span><span class="token number">122911450</span> <span class="token parameter variable">-XX:ReservedCodeCacheSize</span><span class="token operator">=</span><span class="token number">251658240</span> <span class="token parameter variable">-XX:+SegmentedCodeCache</span> <span class="token parameter variable">-XX:+UseCompressedClassPointers</span> <span class="token parameter variable">-XX:+UseCompressedOops</span> <span class="token parameter variable">-XX:+UseG1GC</span>
VM Arguments:
java_command: common-mistakes-0.0.1-SNAPSHOT.jar <span class="token parameter variable">-Xms1g</span> <span class="token parameter variable">-Xmx1g</span>
java_class_path <span class="token punctuation">(</span>initial<span class="token punctuation">)</span>: common-mistakes-0.0.1-SNAPSHOT.jar
Launcher Type: SUN_STANDARD
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>查看第 15 行和 19 行可以发现, <strong>我们设置 JVM 参数的方式不对, -Xms1g 和 -Xmx1g 这两个参数被当成了 Java 程序的启动参数</strong>, 整个 JVM 目前最大内存是 4GB 左右, 而不是 1GB.</p> <p>因此, 当怀疑 JVM 的配置很不正常的时候, 要第一时间使用工具来确认参数. 除了使用工具确认 JVM 参数外, 也可以打印 VM 参数和程序参数:</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>System.out.println<span class="token punctuation">(</span><span class="token string">&quot;VM options&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
System.out.println<span class="token punctuation">(</span>ManagementFactory.getRuntimeMXBean<span class="token punctuation">(</span><span class="token punctuation">)</span>.getInputArguments<span class="token punctuation">(</span><span class="token punctuation">)</span>.stream<span class="token punctuation">(</span><span class="token punctuation">)</span>.collect<span class="token punctuation">(</span>Collectors.joining<span class="token punctuation">(</span>System.lineSeparator<span class="token punctuation">(</span><span class="token punctuation">))</span><span class="token punctuation">))</span><span class="token punctuation">;</span>
System.out.println<span class="token punctuation">(</span><span class="token string">&quot;Program arguments&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
System.out.println<span class="token punctuation">(</span>Arrays.stream<span class="token punctuation">(</span>args<span class="token punctuation">)</span>.collect<span class="token punctuation">(</span>Collectors.joining<span class="token punctuation">(</span>System.lineSeparator<span class="token punctuation">(</span><span class="token punctuation">))</span><span class="token punctuation">))</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>把 JVM 参数放到 -jar 之前, 重新启动程序, 可以看到如下输出, 从输出也可以确认这次 JVM 参数的配置正确了:</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>➜  target git:<span class="token punctuation">(</span>master<span class="token punctuation">)</span> ✗ <span class="token function">java</span> <span class="token parameter variable">-Xms1g</span> <span class="token parameter variable">-Xmx1g</span> <span class="token parameter variable">-jar</span> common-mistakes-0.0.1-SNAPSHOT.jar <span class="token builtin class-name">test</span>
VM options
<span class="token parameter variable">-Xms1g</span>
<span class="token parameter variable">-Xmx1g</span>
Program arguments
<span class="token builtin class-name">test</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h6 id="jvisualvm"><a href="#jvisualvm" class="header-anchor">#</a> jvisualvm</h6> <p>然后启动另一个重量级工具 jvisualvm 观察一下程序, 可以在概述面板再次确认 JVM 参数设置成功了:</p> <p><img src="/img/0a909895f8bab9151f59326b27e81f2a-20230731165210-t4fts9k.png" alt=""></p> <p>继续观察监视面板可以看到, JVM 的 GC 活动基本是 10 秒发生一次, 堆内存在 250MB 到 900MB 之间波动, 活动线程数是 22. 可以在监视面板看到 JVM 的基本情况, 也可以直接在这里进行手动 GC 和堆 Dump 操作:</p> <p><img src="/img/7af049c6e351b00b1f7a4594f5b43a44-20230731165210-anjfrju.png" alt=""></p> <h6 id="jconsole"><a href="#jconsole" class="header-anchor">#</a> jconsole</h6> <p>如果希望看到<strong>各个内存区的 GC 曲线图, 可以使用 jconsole 观察</strong>. jconsole 也是一个综合性图形界面监控工具, 比 jvisualvm 更方便的一点是, 可以用曲线的形式监控各种数据, <strong>包括 MBean 中的属性值</strong>:</p> <p><img src="/img/98608d7ae4a1e265c23098b37092dbf0-20230731165210-pfdndm9.png" alt=""></p> <h6 id="jstat"><a href="#jstat" class="header-anchor">#</a> jstat</h6> <p>同样, 如果没有条件使用图形界面(毕竟在 Linux 服务器上, 主要使用命令行工具), 又希望看到 GC 趋势的话, 可以使用 jstat 工具.</p> <p><strong>jstat 工具允许以固定的监控频次输出 JVM 的各种监控指标</strong>, 比如使用 -gcutil 输出 GC 和内存占用汇总信息, 每隔 5 秒输出一次, 输出 100 次, 可以看到 Young GC 比较频繁, 而 Full GC 基本 10 秒一次:</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>➜  ~ jstat <span class="token parameter variable">-gcutil</span> <span class="token number">23940</span> <span class="token number">5000</span> <span class="token number">100</span>
  S0     S1     E      O      M     CCS    YGC     YGCT    FGC    FGCT    CGC    CGCT     GCT
  <span class="token number">0.00</span> <span class="token number">100.00</span>   <span class="token number">0.36</span>  <span class="token number">87.63</span>  <span class="token number">94.30</span>  <span class="token number">81.06</span>    <span class="token number">539</span>   <span class="token number">14.021</span>    <span class="token number">33</span>    <span class="token number">3.972</span>   <span class="token number">837</span>    <span class="token number">0.976</span>   <span class="token number">18.968</span>
  <span class="token number">0.00</span> <span class="token number">100.00</span>   <span class="token number">0.60</span>  <span class="token number">69.51</span>  <span class="token number">94.30</span>  <span class="token number">81.06</span>    <span class="token number">540</span>   <span class="token number">14.029</span>    <span class="token number">33</span>    <span class="token number">3.972</span>   <span class="token number">839</span>    <span class="token number">0.978</span>   <span class="token number">18.979</span>
  <span class="token number">0.00</span>   <span class="token number">0.00</span>   <span class="token number">0.50</span>  <span class="token number">99.81</span>  <span class="token number">94.27</span>  <span class="token number">81.03</span>    <span class="token number">548</span>   <span class="token number">14.143</span>    <span class="token number">34</span>    <span class="token number">4.002</span>   <span class="token number">840</span>    <span class="token number">0.981</span>   <span class="token number">19.126</span>
  <span class="token number">0.00</span> <span class="token number">100.00</span>   <span class="token number">0.59</span>  <span class="token number">70.47</span>  <span class="token number">94.27</span>  <span class="token number">81.03</span>    <span class="token number">549</span>   <span class="token number">14.177</span>    <span class="token number">34</span>    <span class="token number">4.002</span>   <span class="token number">844</span>    <span class="token number">0.985</span>   <span class="token number">19.164</span>
  <span class="token number">0.00</span> <span class="token number">100.00</span>   <span class="token number">0.57</span>  <span class="token number">99.85</span>  <span class="token number">94.32</span>  <span class="token number">81.09</span>    <span class="token number">550</span>   <span class="token number">14.204</span>    <span class="token number">34</span>    <span class="token number">4.002</span>   <span class="token number">845</span>    <span class="token number">0.990</span>   <span class="token number">19.196</span>
  <span class="token number">0.00</span> <span class="token number">100.00</span>   <span class="token number">0.65</span>  <span class="token number">77.69</span>  <span class="token number">94.32</span>  <span class="token number">81.09</span>    <span class="token number">559</span>   <span class="token number">14.469</span>    <span class="token number">36</span>    <span class="token number">4.198</span>   <span class="token number">847</span>    <span class="token number">0.993</span>   <span class="token number">19.659</span>
  <span class="token number">0.00</span> <span class="token number">100.00</span>   <span class="token number">0.65</span>  <span class="token number">77.69</span>  <span class="token number">94.32</span>  <span class="token number">81.09</span>    <span class="token number">559</span>   <span class="token number">14.469</span>    <span class="token number">36</span>    <span class="token number">4.198</span>   <span class="token number">847</span>    <span class="token number">0.993</span>   <span class="token number">19.659</span>
  <span class="token number">0.00</span> <span class="token number">100.00</span>   <span class="token number">0.70</span>  <span class="token number">35.54</span>  <span class="token number">94.32</span>  <span class="token number">81.09</span>    <span class="token number">567</span>   <span class="token number">14.763</span>    <span class="token number">37</span>    <span class="token number">4.378</span>   <span class="token number">853</span>    <span class="token number">1.001</span>   <span class="token number">20.142</span>
  <span class="token number">0.00</span> <span class="token number">100.00</span>   <span class="token number">0.70</span>  <span class="token number">41.22</span>  <span class="token number">94.32</span>  <span class="token number">81.09</span>    <span class="token number">567</span>   <span class="token number">14.763</span>    <span class="token number">37</span>    <span class="token number">4.378</span>   <span class="token number">853</span>    <span class="token number">1.001</span>   <span class="token number">20.142</span>
  <span class="token number">0.00</span> <span class="token number">100.00</span>   <span class="token number">1.89</span>  <span class="token number">96.76</span>  <span class="token number">94.32</span>  <span class="token number">81.09</span>    <span class="token number">574</span>   <span class="token number">14.943</span>    <span class="token number">38</span>    <span class="token number">4.487</span>   <span class="token number">859</span>    <span class="token number">1.007</span>   <span class="token number">20.438</span>
  <span class="token number">0.00</span> <span class="token number">100.00</span>   <span class="token number">1.39</span>  <span class="token number">39.20</span>  <span class="token number">94.32</span>  <span class="token number">81.09</span>    <span class="token number">575</span>   <span class="token number">14.946</span>    <span class="token number">38</span>    <span class="token number">4.487</span>   <span class="token number">861</span>    <span class="token number">1.01</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><blockquote><p>其中, S0 表示 Survivor0 区占用百分比, S1 表示 Survivor1 区占用百分比, E 表示 Eden 区占用百分比, O 表示老年代占用百分比, M 表示元数据区占用百分比, YGC 表示年轻代回收次数, YGCT 表示年轻代回收耗时, FGC 表示老年代回收次数, FGCT 表示老年代回收耗时.</p></blockquote> <p>jstat 命令的参数众多, 包含 -class, -compiler, -gc 等. jstat 定时输出的特性, 可以方便持续观察程序的各项指标.</p> <p>继续来到线程面板可以看到, 大量以 Thread 开头的线程基本都是有节奏的 10 秒运行一下, 其他时间都在休眠, 和代码逻辑匹配:</p> <p><img src="/img/3e879e744a492021ef8562e163ef2fc7-20230731165210-u7l8yw3.png" alt=""></p> <p>点击面板的线程 Dump 按钮, 可以查看线程瞬时的线程栈:</p> <p><img src="/img/1479d7909a73cd8c331d249016dddb86-20230731165210-u8rriqp.png" alt=""></p> <h6 id="jstack"><a href="#jstack" class="header-anchor">#</a> jstack</h6> <p>通过命令行工具 jstack, 也可以实现抓取线程栈的操作:</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>➜  ~ jstack <span class="token number">23940</span>
<span class="token number">2020</span>-01-29 <span class="token number">13</span>:08:15
Full thread dump Java HotSpot<span class="token punctuation">(</span>TM<span class="token punctuation">)</span> <span class="token number">64</span>-Bit Server VM <span class="token punctuation">(</span><span class="token number">11.0</span>.3+12-LTS mixed mode<span class="token punctuation">)</span>:
<span class="token punctuation">..</span>.
<span class="token string">&quot;main&quot;</span> <span class="token comment">#1 prio=5 os_prio=31 cpu=440.66ms elapsed=574.86s tid=0x00007ffdd9800000 nid=0x2803 waiting on condition  [0x0000700003849000]</span>
   java.lang.Thread.State: TIMED_WAITING <span class="token punctuation">(</span>sleeping<span class="token punctuation">)</span>
  at java.lang.Thread.sleep<span class="token punctuation">(</span>java.base@11.0.3/Native Method<span class="token punctuation">)</span>
  at java.lang.Thread.sleep<span class="token punctuation">(</span>java.base@11.0.3/Thread.java:339<span class="token punctuation">)</span>
  at java.util.concurrent.TimeUnit.sleep<span class="token punctuation">(</span>java.base@11.0.3/TimeUnit.java:446<span class="token punctuation">)</span>
  at org.geekbang.time.commonmistakes.troubleshootingtools.jdktool.CommonMistakesApplication.main<span class="token punctuation">(</span>CommonMistakesApplication.java:41<span class="token punctuation">)</span>
  at jdk.internal.reflect.NativeMethodAccessorImpl.invoke0<span class="token punctuation">(</span>java.base@11.0.3/Native Method<span class="token punctuation">)</span>
  at jdk.internal.reflect.NativeMethodAccessorImpl.invoke<span class="token punctuation">(</span>java.base@11.0.3/NativeMethodAccessorImpl.java:62<span class="token punctuation">)</span>
  at jdk.internal.reflect.DelegatingMethodAccessorImpl.invoke<span class="token punctuation">(</span>java.base@11.0.3/DelegatingMethodAccessorImpl.java:43<span class="token punctuation">)</span>
  at java.lang.reflect.Method.invoke<span class="token punctuation">(</span>java.base@11.0.3/Method.java:566<span class="token punctuation">)</span>
  at org.springframework.boot.loader.MainMethodRunner.run<span class="token punctuation">(</span>MainMethodRunner.java:48<span class="token punctuation">)</span>
  at org.springframework.boot.loader.Launcher.launch<span class="token punctuation">(</span>Launcher.java:87<span class="token punctuation">)</span>
  at org.springframework.boot.loader.Launcher.launch<span class="token punctuation">(</span>Launcher.java:51<span class="token punctuation">)</span>
  at org.springframework.boot.loader.JarLauncher.main<span class="token punctuation">(</span>JarLauncher.java:52<span class="token punctuation">)</span>
<span class="token string">&quot;Thread-1&quot;</span> <span class="token comment">#13 prio=5 os_prio=31 cpu=17851.77ms elapsed=574.41s tid=0x00007ffdda029000 nid=0x9803 waiting on condition  [0x000070000539d000]</span>
   java.lang.Thread.State: TIMED_WAITING <span class="token punctuation">(</span>sleeping<span class="token punctuation">)</span>
  at java.lang.Thread.sleep<span class="token punctuation">(</span>java.base@11.0.3/Native Method<span class="token punctuation">)</span>
  at java.lang.Thread.sleep<span class="token punctuation">(</span>java.base@11.0.3/Thread.java:339<span class="token punctuation">)</span>
  at java.util.concurrent.TimeUnit.sleep<span class="token punctuation">(</span>java.base@11.0.3/TimeUnit.java:446<span class="token punctuation">)</span>
  at org.geekbang.time.commonmistakes.troubleshootingtools.jdktool.CommonMistakesApplication.lambda<span class="token variable">$null</span><span class="token variable">$1</span><span class="token punctuation">(</span>CommonMistakesApplication.java:33<span class="token punctuation">)</span>
  at org.geekbang.time.commonmistakes.troubleshootingtools.jdktool.CommonMistakesApplication<span class="token variable">$$</span>Lambda<span class="token variable">$41</span>/0x00000008000a8c40.run<span class="token punctuation">(</span>Unknown Source<span class="token punctuation">)</span>
  at java.lang.Thread.run<span class="token punctuation">(</span>java.base@11.0.3/Thread.java:834<span class="token punctuation">)</span>
<span class="token punctuation">..</span>.
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><p>抓取后可以使用类似fastthread这样的在线分析工具来分析线程栈.</p> <h6 id="jcmd"><a href="#jcmd" class="header-anchor">#</a> jcmd</h6> <p>最后, 来看一下 Java HotSpot 虚拟机的 NMT 功能.</p> <p>通过 NMT, 可以观察细粒度内存使用情况, 设置 <code>-XX:NativeMemoryTracking=summary/detail</code>​ 可以开启 NMT 功能, 开启后可以使用 jcmd 工具查看 NMT 数据.</p> <p>重新启动一次程序, 这次加上 JVM 参数以 detail 方式开启 NMT:</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code><span class="token parameter variable">-Xms1g</span> <span class="token parameter variable">-Xmx1g</span> <span class="token parameter variable">-XX:ThreadStackSize</span><span class="token operator">=</span>256k <span class="token parameter variable">-XX:NativeMemoryTracking</span><span class="token operator">=</span>detail
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>在这里, 还增加了 <code>-XX:ThreadStackSize</code>​ 参数, 并将其值设置为 256k, 也就是期望把线程栈设置为 256KB. 通过 NMT 观察一下设置是否成功.</p> <p>启动程序后执行如下 jcmd 命令, 以概要形式输出 NMT 结果. 可以看到, <strong>当前有 32 个线程, 线程栈总共保留了差不多 4GB 左右的内存</strong>. 明明配置线程栈最大 256KB, 为什么会出现 4GB 这么夸张的数字呢, 到底哪里出了问题呢?</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>➜  ~ jcmd <span class="token number">24404</span> VM.native_memory summary
<span class="token number">24404</span>:
Native Memory Tracking:
Total: <span class="token assign-left variable">reserved</span><span class="token operator">=</span>6635310KB, <span class="token assign-left variable">committed</span><span class="token operator">=</span>5337110KB
-                 Java Heap <span class="token punctuation">(</span>reserved<span class="token operator">=</span>1048576KB, <span class="token assign-left variable">committed</span><span class="token operator">=</span>1048576KB<span class="token punctuation">)</span>
                            <span class="token punctuation">(</span>mmap: <span class="token assign-left variable">reserved</span><span class="token operator">=</span>1048576KB, <span class="token assign-left variable">committed</span><span class="token operator">=</span>1048576KB<span class="token punctuation">)</span>
-                     Class <span class="token punctuation">(</span>reserved<span class="token operator">=</span>1066233KB, <span class="token assign-left variable">committed</span><span class="token operator">=</span>15097KB<span class="token punctuation">)</span>
                            <span class="token punctuation">(</span>classes <span class="token comment">#902)</span>
                            <span class="token punctuation">(</span>malloc<span class="token operator">=</span>9465KB <span class="token comment">#908)</span>
                            <span class="token punctuation">(</span>mmap: <span class="token assign-left variable">reserved</span><span class="token operator">=</span>1056768KB, <span class="token assign-left variable">committed</span><span class="token operator">=</span>5632KB<span class="token punctuation">)</span>
-                    Thread <span class="token punctuation">(</span>reserved<span class="token operator">=</span>4209797KB, <span class="token assign-left variable">committed</span><span class="token operator">=</span>4209797KB<span class="token punctuation">)</span>
                            <span class="token punctuation">(</span>thread <span class="token comment">#32)</span>
                            <span class="token punctuation">(</span>stack: <span class="token assign-left variable">reserved</span><span class="token operator">=</span>4209664KB, <span class="token assign-left variable">committed</span><span class="token operator">=</span>4209664KB<span class="token punctuation">)</span>
                            <span class="token punctuation">(</span>malloc<span class="token operator">=</span>96KB <span class="token comment">#165)</span>
                            <span class="token punctuation">(</span>arena<span class="token operator">=</span>37KB <span class="token comment">#59)</span>
-                      Code <span class="token punctuation">(</span>reserved<span class="token operator">=</span>249823KB, <span class="token assign-left variable">committed</span><span class="token operator">=</span>2759KB<span class="token punctuation">)</span>
                            <span class="token punctuation">(</span>malloc<span class="token operator">=</span>223KB <span class="token comment">#730)</span>
                            <span class="token punctuation">(</span>mmap: <span class="token assign-left variable">reserved</span><span class="token operator">=</span>249600KB, <span class="token assign-left variable">committed</span><span class="token operator">=</span>2536KB<span class="token punctuation">)</span>
-                        GC <span class="token punctuation">(</span>reserved<span class="token operator">=</span>48700KB, <span class="token assign-left variable">committed</span><span class="token operator">=</span>48700KB<span class="token punctuation">)</span>
                            <span class="token punctuation">(</span>malloc<span class="token operator">=</span>10384KB <span class="token comment">#135)</span>
                            <span class="token punctuation">(</span>mmap: <span class="token assign-left variable">reserved</span><span class="token operator">=</span>38316KB, <span class="token assign-left variable">committed</span><span class="token operator">=</span>38316KB<span class="token punctuation">)</span>
-                  Compiler <span class="token punctuation">(</span>reserved<span class="token operator">=</span>186KB, <span class="token assign-left variable">committed</span><span class="token operator">=</span>186KB<span class="token punctuation">)</span>
                            <span class="token punctuation">(</span>malloc<span class="token operator">=</span>56KB <span class="token comment">#105)</span>
                            <span class="token punctuation">(</span>arena<span class="token operator">=</span>131KB <span class="token comment">#7)</span>
-                  Internal <span class="token punctuation">(</span>reserved<span class="token operator">=</span>9693KB, <span class="token assign-left variable">committed</span><span class="token operator">=</span>9693KB<span class="token punctuation">)</span>
                            <span class="token punctuation">(</span>malloc<span class="token operator">=</span>9661KB <span class="token comment">#2585)</span>
                            <span class="token punctuation">(</span>mmap: <span class="token assign-left variable">reserved</span><span class="token operator">=</span>32KB, <span class="token assign-left variable">committed</span><span class="token operator">=</span>32KB<span class="token punctuation">)</span>
-                    Symbol <span class="token punctuation">(</span>reserved<span class="token operator">=</span>2021KB, <span class="token assign-left variable">committed</span><span class="token operator">=</span>2021KB<span class="token punctuation">)</span>
                            <span class="token punctuation">(</span>malloc<span class="token operator">=</span>1182KB <span class="token comment">#334)</span>
                            <span class="token punctuation">(</span>arena<span class="token operator">=</span>839KB <span class="token comment">#1)</span>
-    Native Memory Tracking <span class="token punctuation">(</span>reserved<span class="token operator">=</span>85KB, <span class="token assign-left variable">committed</span><span class="token operator">=</span>85KB<span class="token punctuation">)</span>
                            <span class="token punctuation">(</span>malloc<span class="token operator">=</span>5KB <span class="token comment">#53)</span>
                            <span class="token punctuation">(</span>tracking <span class="token assign-left variable">overhead</span><span class="token operator">=</span>80KB<span class="token punctuation">)</span>
-               Arena Chunk <span class="token punctuation">(</span>reserved<span class="token operator">=</span>196KB, <span class="token assign-left variable">committed</span><span class="token operator">=</span>196KB<span class="token punctuation">)</span>
                            <span class="token punctuation">(</span>malloc<span class="token operator">=</span>196KB<span class="token punctuation">)</span>   
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br></div></div><p>重新以 VM.native_memory detail 参数运行 jcmd:</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>jcmd <span class="token number">24404</span> VM.native_memory detail
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>可以看到, <strong>有 16 个可疑线程, 每一个线程保留了 262144KB 内存, 也就是 256MB</strong>(通过下图红框可以看到, 使用关键字 262144KB for Thread Stack from 搜索到了 16 个结果):</p> <p><img src="/img/68383f02b3db50b7bb06d0e40e0683f5-20230731165210-pi86gfw.png" alt=""></p> <p>其实, ThreadStackSize 参数的单位是 KB, <strong>所以如果要设置线程栈 256KB, 那么应该设置 256 而不是 256k</strong>. 重新设置正确的参数后, 使用 jcmd 再次验证下:</p> <p><img src="/img/4e372c535f2924d16eb151886b81ba6e-20230731165210-ryncrzx.png" alt=""></p> <p>除了用于查看 NMT 外, jcmd 还有许多功能. 可以通过 help, 看到它的所有功能:</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>jcmd <span class="token number">24781</span> <span class="token builtin class-name">help</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>对于其中每一种功能, 都可以进一步使用 help 来查看介绍. 比如, 使用 GC.heap_info 命令可以打印 Java 堆的一些信息:</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>jcmd <span class="token number">24781</span> <span class="token builtin class-name">help</span> GC.heap_info
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>除了 jps, jinfo, jcmd, jstack, jstat, jconsole, jvisualvm 外, JDK 中还有一些工具, 可以通过官方文档查看完整介绍.</p> <h5 id="使用wireshark分析sql批量插入慢的问题"><a href="#使用wireshark分析sql批量插入慢的问题" class="header-anchor">#</a> 使用Wireshark分析SQL批量插入慢的问题</h5> <p>我之前遇到过这样一个案例: 有一个数据导入程序需要导入大量的数据, 开发同学就想到了使用 Spring JdbcTemplate 的批量操作功能进行数据批量导入, 但是发现性能非常差, 和普通的单条 SQL 执行性能差不多.</p> <p>重现下这个案例. 启动程序后, 首先创建一个 testuser 表, 其中只有一列 name, 然后使用 JdbcTemplate 的 batchUpdate 方法, 批量插入 10000 条记录到 testuser 表:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">BatchInsertAppliation</span> <span class="token keyword">implements</span> <span class="token class-name">CommandLineRunner</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">JdbcTemplate</span> jdbcTemplate<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">BatchInsertApplication</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@PostConstruct</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 初始化表</span>
        jdbcTemplate<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token string">&quot;drop table IF EXISTS `testuser`;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        jdbcTemplate<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token string">&quot;create TABLE `testuser` (\n&quot;</span> <span class="token operator">+</span>
                <span class="token string">&quot;  `id` bigint(20) NOT NULL AUTO_INCREMENT,\n&quot;</span> <span class="token operator">+</span>
                <span class="token string">&quot;  `name` varchar(255) NOT NULL,\n&quot;</span> <span class="token operator">+</span>
                <span class="token string">&quot;  PRIMARY KEY (`id`)\n&quot;</span> <span class="token operator">+</span>
                <span class="token string">&quot;) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">long</span> begin <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> sql <span class="token operator">=</span> <span class="token string">&quot;INSERT INTO `testuser` (`name`) VALUES (?)&quot;</span><span class="token punctuation">;</span>
        <span class="token comment">// 使用JDBC批量更新</span>
        jdbcTemplate<span class="token punctuation">.</span><span class="token function">batchUpdate</span><span class="token punctuation">(</span>sql<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">BatchPreparedStatementSetter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setValues</span><span class="token punctuation">(</span><span class="token class-name">PreparedStatement</span> preparedStatement<span class="token punctuation">,</span> <span class="token keyword">int</span> i<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">SQLException</span> <span class="token punctuation">{</span>
                <span class="token comment">// 第一个参数(索引从1开始), 也就是name列赋值</span>
                preparedStatement<span class="token punctuation">.</span><span class="token function">setString</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">&quot;usera&quot;</span> <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getBatchSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// 批次大小为10000</span>
                <span class="token keyword">return</span> <span class="token number">10000</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;took : {} ms&quot;</span><span class="token punctuation">,</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> begin<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br></div></div><p>执行程序后可以看到, 1 万条数据插入耗时 26 秒:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token punctuation">[</span><span class="token number">14</span><span class="token operator">:</span><span class="token number">44</span><span class="token operator">:</span><span class="token number">19.094</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>main<span class="token punctuation">]</span> <span class="token operator">-</span> took <span class="token operator">:</span> <span class="token number">26144</span> ms
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>其实, 对于批量操作, 希望程序可以把多条 insert SQL 语句合并成一条, 或至少是一次性提交多条语句到数据库, 以减少和 MySQL 交互次数, 提高性能. 那程序是这样运作的吗?</p> <p>&quot;分析问题一定是需要依据的, 靠猜是猜不出来的&quot;. 现在就使用网络分析工具 Wireshark 来分析一下这个案例, 眼见为实.</p> <p>首先, 可以在这里下载 Wireshark, 启动后选择某个需要捕获的网卡. 由于连接的是本地的 MySQL, 因此选择 loopback 回环网卡:</p> <p><img src="/img/37606426a5f7197ad5c81af113967167-20230731165210-25rynnk.png" alt=""></p> <p>然后, Wireshark 捕捉这个网卡的所有网络流量. 可以在上方的显示过滤栏输入 tcp.port == 6657, 来过滤出所有 6657 端口的 TCP 请求(因为是通过 6657 端口连接 MySQL 的).</p> <p>可以看到, 程序运行期间和 MySQL 有大量交互. 因为 Wireshark 直接把 TCP 数据包解析为了 MySQL 协议, 所以下方窗口可以直接显示 MySQL 请求的 SQL 查询语句. 可以<strong>看到, testuser 表的每次 insert 操作, 插入的都是一行记录</strong>:</p> <p><img src="/img/c1735d8a4dad12babfec39a754f30960-20230731165210-38dk9q7.png" alt=""></p> <p>如果列表中的 Protocol 没有显示 MySQL 的话, 可以手动点击 Analyze 菜单的 Decode As 菜单, 然后加一条规则, 把 6657 端口设置为 MySQL 协议:</p> <p><img src="/img/a847610404908631508bb72953490033-20230731165210-b5qz3fo.png" alt=""></p> <p>这就说明, 程序并不是在做批量插入操作, 和普通的单条循环插入没有区别. 调试程序进入 ClientPreparedStatement 类, 可以看到执行批量操作的是 executeBatchInternal 方法. executeBatchInternal 方法的源码如下:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">protected</span> <span class="token keyword">long</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">executeBatchInternal</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">SQLException</span> <span class="token punctuation">{</span>
    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token function">checkClosed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getConnectionMutex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>connection<span class="token punctuation">.</span><span class="token function">isReadOnly</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">SQLException</span><span class="token punctuation">(</span><span class="token class-name">Messages</span><span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">&quot;PreparedStatement.25&quot;</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token class-name">Messages</span><span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">&quot;PreparedStatement.26&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token class-name">MysqlErrorNumbers</span><span class="token punctuation">.</span><span class="token constant">SQL_STATE_ILLEGAL_ARGUMENT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>query<span class="token punctuation">.</span><span class="token function">getBatchedArgs</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token generics"><span class="token punctuation">&lt;</span>mark<span class="token punctuation">&gt;</span></span> <span class="token keyword">null</span> <span class="token operator">||</span> <span class="token keyword">this</span><span class="token punctuation">.</span>query<span class="token punctuation">.</span><span class="token function">getBatchedArgs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span><span class="token operator">/</span>mark<span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token keyword">long</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// we timeout the entire batch, not individual statements</span>
        <span class="token keyword">int</span> batchTimeout <span class="token operator">=</span> <span class="token function">getTimeoutInMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">setTimeoutInMillis</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">resetCancelledState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token function">statementBegins</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">clearWarnings</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>batchHasPlainStatements <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>rewriteBatchedStatements<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">PreparedQuery</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span> <span class="token keyword">this</span><span class="token punctuation">.</span>query<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getParseInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">canRewriteAsMultiValueInsertAtSqlLevel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span> <span class="token function">executeBatchedInserts</span><span class="token punctuation">(</span>batchTimeout<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>batchHasPlainStatements <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>query<span class="token punctuation">.</span><span class="token function">getBatchedArgs</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span>
                        <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>query<span class="token punctuation">.</span><span class="token function">getBatchedArgs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">3</span> <span class="token comment">/* cost of option setting rt-wise */</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span> <span class="token function">executePreparedBatchAsMultiStatement</span><span class="token punctuation">(</span>batchTimeout<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> <span class="token function">executeBatchSerially</span><span class="token punctuation">(</span>batchTimeout<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>query<span class="token punctuation">.</span><span class="token function">getStatementExecuting</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">clearBatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br></div></div><p>注意这里判断了 rewriteBatchedStatements 参数是否为 true, <strong>是才会开启批量的优化</strong>. 优化方式有 2 种:</p> <ol><li>如果有条件的话, <strong>优先把 insert 语句优化为一条语句, 也就是 executeBatchedInserts 方法</strong>;</li> <li>如果不行的话, 再尝试把 insert 语句优化为多条语句一起提交, 也就是 executePreparedBatchAsMultiStatement 方法.</li></ol> <p>到这里就明朗了, 实现批量提交优化的关键, 在于 rewriteBatchedStatements 参数. 修改连接字符串, 并将其值设置为 true:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>spring<span class="token punctuation">.</span>datasource<span class="token punctuation">.</span>url<span class="token operator">=</span>jdbc<span class="token operator">:</span>mysql<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>localhost<span class="token operator">:</span><span class="token number">6657</span><span class="token operator">/</span>common_mistakes<span class="token operator">?</span>characterEncoding<span class="token operator">=</span><span class="token constant">UTF</span><span class="token operator">-</span><span class="token number">8</span><span class="token operator">&amp;</span>useSSL<span class="token operator">=</span><span class="token boolean">false</span><span class="token operator">&amp;</span>rewriteBatchedStatements<span class="token operator">=</span><span class="token boolean">true</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>重新按照之前的步骤打开 Wireshark 验证, 可以看到:</p> <ol><li>这次 insert SQL 语句被拼接成了一条语句(如第二个红框所示);</li> <li>这个 TCP 包因为太大被分割成了 11 个片段传输, <code>#699</code>​ 请求是最后一个片段, 其实际内容是 insert 语句的最后一部分内容(如第一和第三个红框显示).</li></ol> <p><img src="/img/fa6f2972554a3cff2833410ee23fb477-20230731165210-xqgzk88.png" alt=""></p> <p>为了查看整个 TCP 连接的所有数据包, 可以在请求上点击右键, 选择 Follow-&gt;TCP Stream:</p> <p><img src="/img/fb0781804228bcacec9bc01b0ee3eba9-20230731165210-tlb5gbh.png" alt=""></p> <p>打开后可以看到, 从 MySQL 认证开始到 insert 语句的所有数据包的内容:</p> <p><img src="/img/7f625d77573dc0feb40caf075ee3614f-20230731165210-nzmslho.png" alt=""></p> <p>查看最开始的握手数据包可以发现, TCP 的最大分段大小(MSS)是 16344 字节, 而 MySQL 超长 insert 的数据一共 138933 字节, 因此被<strong>分成了 11 段传输, 其中最大的一段是 16332 字节, 低于 MSS 要求的 16344 字节</strong>.</p> <p><img src="/img/f4aa1fb4da9ab850fd5a6720191c4dd8-20230731165210-dt4ijqi.png" alt=""></p> <p>最后可以看到插入 1 万条数据仅耗时 253 毫秒, 性能提升了 100 倍:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token punctuation">[</span><span class="token number">20</span><span class="token operator">:</span><span class="token number">19</span><span class="token operator">:</span><span class="token number">30.185</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>main<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token constant">INFO</span> <span class="token punctuation">]</span> <span class="token operator">-</span> took <span class="token operator">:</span> <span class="token number">253</span> ms
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>虽然大家一直在使用 MySQL, 但很少会考虑 MySQL Connector Java 是怎么和 MySQL 交互的, 实际发送给 MySQL 的 SQL 语句又是怎样的. 有没有感觉到, MySQL 协议其实并不遥远, 完全可以使用 Wireshark 来观察, 分析应用程序与 MySQL 交互的整个流程.</p> <h5 id="使用mat分析oom问题"><a href="#使用mat分析oom问题" class="header-anchor">#</a> 使用MAT分析OOM问题</h5> <p>对于<strong>排查 OOM 问题, 分析程序堆内存使用情况, 最好的方式就是分析堆转储</strong>.</p> <p>堆转储, 包含了堆现场全貌和线程栈信息(Java 6 Update 14 开始包含). 使用 jstat 等工具虽然可以观察堆内存使用情况的变化, 但是对程序内到底有多少对象, 哪些是大对象还一无所知, 也就是说只能看到问题但无法定位问题. 而堆转储, 就好似得到了病人在某个瞬间的全景核磁影像, 可以拿着慢慢分析.</p> <p>Java 的 OutOfMemoryError 是比较严重的问题, 需要分析出根因, 所以对生产应用一般都会这样设置 JVM 参数, 方便发生 OOM 时进行堆转储:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token operator">-</span><span class="token constant">XX</span><span class="token operator">:</span><span class="token operator">+</span><span class="token class-name">HeapDumpOnOutOfMemoryError</span> <span class="token operator">-</span><span class="token constant">XX</span><span class="token operator">:</span><span class="token class-name">HeapDumpPath</span><span class="token operator">=</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>jvisualvm 同样可以进行一键堆转储后, 直接打开这个 dump 查看. 但是 jvisualvm 的堆转储分析功能并不是很强大, 只能查看类使用内存的直方图, 无法有效跟踪内存使用的引用关系, 所以更推荐使用 Eclipse 的 Memory Analyzer(也叫做 <strong>MAT</strong>)做堆转储的分析.</p> <p>使用 MAT 分析 OOM 问题, 一般可以按照以下思路进行:</p> <ul><li>通过支配树功能或直方图功能<strong>查看消耗内存最大的类型</strong>, 来分析内存泄露的大概原因;</li> <li>查看那些<strong>消耗内存最大的类型, 详细的对象明细列表, 以及它们的引用链, 来定位内存泄露的具体点</strong>;</li> <li>配合<strong>查看对象属性的功能, 可以脱离源码看到对象的各种属性的值和依赖关系, 理清程序逻辑和参数</strong>;</li> <li>辅助使用查看线程栈来看 OOM 问题是否和过多线程有关, 甚至可以在线程栈看到 OOM 最后一刻出现异常的线程.</li></ul> <p>比如, 我手头有一个 OOM 后得到的转储文件 java_pid29569.hprof, 现在要使用 MAT 的直方图, 支配树, 线程栈, OQL 等功能来分析此次 OOM 的原因.</p> <p>首先, 用 MAT 打开后先进入的是概览信息界面, 可以看到整个堆是 437.6MB:</p> <p><img src="/img/5a9b61b4e7904abe0e2c244b56e4f6d8-20230731165210-1qzh3xc.png" alt=""></p> <p>那这 437.6MB 都是什么对象呢?</p> <p>如图所示, 工具栏的第二个按钮可以<strong>打开直方图, 直方图按照类型进行分组</strong>, 列出了每个类有多少个实例, 以及占用的内存. 可以看到, <code>char[]</code>​ 字节数组占用内存最多, 对象数量也很多, 结合第二位的 String 类型对象数量也很多, 大概可以猜出(String 使用 <code>char[]</code>​ 作为实际数据存储)程序可能是被字符串占满了内存, 导致 OOM.</p> <p><img src="/img/5cf606443abd0b50cf8ce386d856b181-20230731165210-f7r2g5q.png" alt=""></p> <p>继续分析下, 到底是不是这样呢.</p> <p>在 <code>char[]</code>​ 上点击右键, 选择 <code>List objects-&gt;with incoming references</code>​, 就可以列出所有的 <code>char[]</code>​ 实例, 以及每个 <code>char[]</code>​ 的整个引用关系链:</p> <p><img src="/img/df6ae9f551ffd9539c440b3609610f29-20230731165210-tg2voxo.png" alt=""></p> <p>随机展开一个 <code>char[]</code>​, 如下图所示:</p> <p><img src="/img/86b0dac9113ac240fc29d39ef470cc2a-20230731165210-hc6i7nl.png" alt=""></p> <p>接下来按照红色框中的引用链来查看, 尝试找到这些大 <code>char[]</code>​ 的来源:</p> <ol><li>在①处看到, 这些 <code>char[]</code>​ 几乎都是 10000 个字符, 占用 20000 字节左右(char 是 UTF-16, 每一个字符占用 2 字节);</li> <li>在②处看到, <code>char[]</code>​ 被 String 的 value 字段引用, 说明 <code>char[]</code>​ 来自字符串;</li> <li>在③处看到, String 被 ArrayList 的 elementData 字段引用, 说明这些字符串加入了一个 ArrayList 中;</li> <li>在④处看到, ArrayList 又被 <strong>FooService</strong> 的 data 字段引用, 这个 ArrayList 整个 RetainedHeap 列的值是 431MB.</li></ol> <p><mark><strong>Retained Heap(深堆)代表对象本身和对象关联的对象占用的内存, Shallow Heap(浅堆)代表对象本身占用的内存</strong></mark>. 比如, FooService 中的 data 这个 ArrayList 对象本身只有 16 字节, 但是其所有关联的对象占用了 431MB 内存. 这些就可以说明, <strong>肯定有哪里在不断向这个 List 中添加 String 数据, 导致了 OOM.</strong></p> <p>左侧的蓝色框可以查看每一个实例的内部属性, 图中显示 FooService 有一个 data 属性, 类型是 ArrayList.</p> <p>如果希望看到字符串完整内容的话, 可以右键选择 <code>Copy -&gt; Value</code>​, 把值复制到剪贴板或保存到文件中:</p> <p><img src="/img/d9484f2ab27b75c3edd97815a7d8cea9-20230731165210-77773ak.png" alt=""></p> <p>这里复制出的是 10000 个字符 a(下图红色部分可以看到). 对于真实案例, 查看大字符串, 大数据的实际内容对于识别数据来源, 有很大意义:</p> <p>​<img src="/img/15443a622536c51dd099037fe51bd594-20230731165210-8fc0kih.png" alt="">​</p> <p>看到这些, 已经基本可以还原出真实的代码是怎样的了.</p> <p>其实, 之前使用直方图定位 FooService, 已经走了些弯路. 可以点击工具栏中第三个按钮(下图左上角的红框所示)进入支配树界面(有关支配树的具体概念参考这里). <strong>这个界面会按照对象保留的 Retained Heap 倒序直接列出占用内存最大的对象</strong>.</p> <p>可以看到, 第一位就是 FooService, 整个路径是 <code>FooSerice -&gt; ArrayList -&gt; Object[] -&gt; String -&gt; char[]</code>​(蓝色框部分), 一共有 21523 个字符串(绿色方框部分):</p> <p><img src="/img/233ebb2a1c2edf4d79139b930ddc7cce-20230731165210-lqnrnch.png" alt=""></p> <p>这样就从内存角度定位到 FooService 是根源了. 那么, OOM 的时候, FooService 是在执行什么逻辑呢?</p> <p>为解决这个问题, 可以点击工具栏的第五个按钮(下图红色框所示). 打开<strong>线程视图</strong>, 首先看到的就是一个名为 main 的线程(Name 列), 展开后果然发现了 FooService:</p> <p><img src="/img/10766b5246c336fab093b939fbaa0abe-20230731165210-qeri2ap.png" alt=""></p> <p>先执行的方法先入栈, 所以线程栈最上面是线程当前执行的方法, 逐一往下看能看到整个调用路径. 因为希望了解 <code>FooService.oom()</code>​ 方法, 看看是谁在调用它, 它的内部又调用了谁, 所以选择以 <code>FooService.oom()</code>​ 方法(蓝色框)为起点来分析这个调用栈.</p> <p>往下看整个绿色框部分, oom() 方法被 OOMApplication 的 run 方法调用, 而这个 run 方法又被 SpringAppliction.callRunner 方法调用. 看到参数中的 CommandLineRunner 你应该能想到, OOMApplication 其实是实现了 CommandLineRunner 接口, 所以是 SpringBoot 应用程序启动后执行的.</p> <p><strong>以 FooService 为起点往上看, 从紫色框中的 Collectors 和 IntPipeline, 大概也可以猜出, 这些字符串是由 Stream 操作产生的. 再往上看, 可以发现在 StringBuilder 的 append 操作的时候, 出现了 OutOfMemoryError 异常(黑色框部分), 说明这这个线程抛出了 OOM 异常</strong>.</p> <p>可以看到, 整个程序是 Spring Boot 应用程序, 那么 FooService 是不是 Spring 的 Bean 呢, 又是不是单例呢? 如果能分析出这点的话, 就更能确认是因为反复调用同一个 FooService 的 oom 方法, 然后导致其内部的 ArrayList 不断增加数据的.</p> <p>点击工具栏的第四个按钮(如下图红框所示), 来到 <strong>OQL 界面</strong>. 在这个界面, 可以使用类似 SQL 的语法, 在 dump 中搜索数据(可以直接在 MAT 帮助菜单搜索 OQL Syntax, 来查看 OQL 的详细语法).</p> <p>比如, 输入如下语句搜索 FooService 的实例:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token constant">SELECT</span> <span class="token operator">*</span> <span class="token constant">FROM</span> <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>geekbang<span class="token punctuation">.</span>time<span class="token punctuation">.</span>commonmistakes<span class="token punctuation">.</span>troubleshootingtools<span class="token punctuation">.</span>oom<span class="token punctuation">.</span></span>FooService</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>可以看到只有一个实例, 然后通过 List objects 功能搜索引用 FooService 的对象:</p> <p><img src="/img/106aecfca38aaedb40cbe6af02141ab4-20230731165210-pv6on1n.png" alt=""></p> <p>得到以下结果:</p> <p><img src="/img/739ddea48f616ca9307c37317fa8125d-20230731165210-m1akepp.png" alt=""></p> <p>可以看到, 一共两处引用:</p> <ol><li>第一处是, OOMApplication 使用了 FooService, 这个已经知道了.</li> <li>第二处是一个 <strong>ConcurrentHashMap</strong>. 可以看到, <strong>这个 HashMap 是 DefaultListableBeanFactory 的 singletonObjects 字段, 可以证实 FooService 是 Spring 容器管理的单例的 Bean</strong>.</li></ol> <p>甚至可以在这个 HashMap 上点击右键, 选择 Java Collections -&gt; Hash Entries 功能, 来查看其内容:</p> <p><img src="/img/1f6d07c8a940f8b6d42639997031378f-20230731165210-d4dd0b0.png" alt=""></p> <p>这样就<strong>列出了所有的 Bean</strong>, 可以在 Value 上的 Regex 进一步过滤. 输入 FooService 后可以看到, 类型为 FooService 的 Bean 只有一个, 其名字是 fooService:</p> <p><img src="/img/61b893fcec4593c1fbc3ef27ee7d9b09-20230731165210-5njbilp.png" alt=""></p> <p>到现在为止, 虽然没看程序代码, 但是已经大概知道程序出现 OOM 的原因和大概的调用栈了. 再贴出程序来对比一下, 果然看到得一模一样:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OOMApplication</span> <span class="token keyword">implements</span> <span class="token class-name">CommandLineRunner</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">FooService</span> fooService<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">OOMApplication</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token comment">// 程序启动后, 不断调用Fooservice.oom()方法</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            fooService<span class="token punctuation">.</span><span class="token function">oom</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FooService</span> <span class="token punctuation">{</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> data <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">oom</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 往同一个ArrayList中不断加入大小为10KB的字符串</span>
        data<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">IntStream</span><span class="token punctuation">.</span><span class="token function">rangeClosed</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">10_000</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">mapToObj</span><span class="token punctuation">(</span>__ <span class="token operator">-&gt;</span> <span class="token string">&quot;a&quot;</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">joining</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br></div></div><p>到这里, 使用 MAT 工具从对象清单, 大对象, 线程栈等视角, 分析了一个 OOM 程序的堆转储. 可以发现, 有了堆转储, 几乎相当于拿到了应用程序的源码 + 当时那一刻的快照, OOM 的问题无从遁形.</p> <h5 id="使用arthas分析高cpu问题"><a href="#使用arthas分析高cpu问题" class="header-anchor">#</a> 使用Arthas分析高CPU问题</h5> <p>Arthas是阿里开源的 Java 诊断工具, 相比 JDK 内置的诊断工具, 要更人性化, 并且功能强大, 可以实现许多问题的一键定位, 而且可以一键反编译类查看源码, 甚至是直接进行生产代码热修复, 实现在一个工具内快速定位和修复问题的一站式服务. 今天就带你使用 Arthas 定位一个 CPU 使用高的问题, 系统学习下这个工具的使用.</p> <p>首先, 下载并启动 Arthas:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>curl <span class="token operator">-</span><span class="token class-name">O</span> https<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>alibaba<span class="token punctuation">.</span>github<span class="token punctuation">.</span>io<span class="token operator">/</span>arthas<span class="token operator">/</span>arthas<span class="token operator">-</span>boot<span class="token punctuation">.</span>jar
java <span class="token operator">-</span>jar arthas<span class="token operator">-</span>boot<span class="token punctuation">.</span>jar
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>启动后, 直接找到要排查的 JVM 进程, 然后可以看到 Arthas 附加进程成功:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token punctuation">[</span><span class="token constant">INFO</span><span class="token punctuation">]</span> arthas<span class="token operator">-</span>boot version<span class="token operator">:</span> <span class="token number">3.1</span><span class="token number">.7</span>
<span class="token punctuation">[</span><span class="token constant">INFO</span><span class="token punctuation">]</span> <span class="token class-name">Found</span> existing java process<span class="token punctuation">,</span> please choose one and hit <span class="token constant">RETURN</span><span class="token punctuation">.</span>
<span class="token operator">*</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">:</span> <span class="token number">12707</span>
  <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token operator">:</span> <span class="token number">30724</span> <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>jetbrains<span class="token punctuation">.</span>jps<span class="token punctuation">.</span>cmdline<span class="token punctuation">.</span></span>Launcher</span>
  <span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token operator">:</span> <span class="token number">30725</span> <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>geekbang<span class="token punctuation">.</span>time<span class="token punctuation">.</span>commonmistakes<span class="token punctuation">.</span>troubleshootingtools<span class="token punctuation">.</span>highcpu<span class="token punctuation">.</span></span>HighCPUApplication</span>
  <span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token operator">:</span> <span class="token number">24312</span> <span class="token class-name"><span class="token namespace">sun<span class="token punctuation">.</span>tools<span class="token punctuation">.</span>jconsole<span class="token punctuation">.</span></span>JConsole</span>
  <span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token operator">:</span> <span class="token number">26328</span> <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>jetbrains<span class="token punctuation">.</span>jps<span class="token punctuation">.</span>cmdline<span class="token punctuation">.</span></span>Launcher</span>
  <span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token operator">:</span> <span class="token number">24106</span> <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>netbeans<span class="token punctuation">.</span>lib<span class="token punctuation">.</span>profiler<span class="token punctuation">.</span>server<span class="token punctuation">.</span></span>ProfilerServer</span>
<span class="token number">3</span>
<span class="token punctuation">[</span><span class="token constant">INFO</span><span class="token punctuation">]</span> arthas home<span class="token operator">:</span> <span class="token operator">/</span><span class="token class-name">Users</span><span class="token operator">/</span>zhuye<span class="token operator">/</span><span class="token punctuation">.</span>arthas<span class="token operator">/</span>lib<span class="token operator">/</span><span class="token number">3.1</span><span class="token number">.7</span><span class="token operator">/</span>arthas
<span class="token punctuation">[</span><span class="token constant">INFO</span><span class="token punctuation">]</span> <span class="token class-name">Try</span> <span class="token keyword">to</span> <span class="token namespace">attach</span> process <span class="token number">30725</span>
<span class="token punctuation">[</span><span class="token constant">INFO</span><span class="token punctuation">]</span> <span class="token class-name">Attach</span> process <span class="token number">30725</span> success<span class="token punctuation">.</span>
<span class="token punctuation">[</span><span class="token constant">INFO</span><span class="token punctuation">]</span> arthas<span class="token operator">-</span>client connect <span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span> <span class="token number">3658</span>
  <span class="token punctuation">,</span><span class="token operator">--</span><span class="token operator">-</span><span class="token punctuation">.</span>  <span class="token punctuation">,</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token punctuation">.</span> <span class="token punctuation">,</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token punctuation">.</span><span class="token punctuation">,</span><span class="token operator">--</span><span class="token punctuation">.</span>  <span class="token punctuation">,</span><span class="token operator">--</span><span class="token punctuation">.</span>  <span class="token punctuation">,</span><span class="token operator">--</span><span class="token operator">-</span><span class="token punctuation">.</span>   <span class="token punctuation">,</span><span class="token operator">--</span><span class="token operator">-</span><span class="token punctuation">.</span>
 <span class="token operator">/</span>  <span class="token class-name">O</span>  \ <span class="token operator">|</span>  <span class="token punctuation">.</span>-<span class="token operator">-</span><span class="token punctuation">.</span> ''<span class="token operator">--</span><span class="token punctuation">.</span>  <span class="token punctuation">.</span>-<span class="token operator">-</span><span class="token char">'|  '</span><span class="token operator">--</span>'  <span class="token operator">|</span> <span class="token operator">/</span>  <span class="token class-name">O</span>  \ <span class="token char">'   .-'</span>
<span class="token operator">|</span>  <span class="token punctuation">.</span>-<span class="token punctuation">.</span>  <span class="token operator">||</span>  <span class="token char">'--'</span><span class="token punctuation">.</span>'   <span class="token operator">|</span>  <span class="token operator">|</span>   <span class="token operator">|</span>  <span class="token punctuation">.</span>-<span class="token operator">-</span><span class="token punctuation">.</span>  <span class="token operator">||</span>  <span class="token punctuation">.</span>-<span class="token punctuation">.</span>  <span class="token operator">|</span>`<span class="token punctuation">.</span>  `<span class="token operator">-</span><span class="token punctuation">.</span>
<span class="token operator">|</span>  <span class="token operator">|</span> <span class="token operator">|</span>  <span class="token operator">||</span>  <span class="token operator">|</span>\  \    <span class="token operator">|</span>  <span class="token operator">|</span>   <span class="token operator">|</span>  <span class="token operator">|</span>  <span class="token operator">|</span>  <span class="token operator">||</span>  <span class="token operator">|</span> <span class="token operator">|</span>  <span class="token operator">|</span><span class="token punctuation">.</span>-'    <span class="token operator">|</span>
`<span class="token operator">--</span><span class="token char">' `--'</span>`<span class="token operator">--</span><span class="token char">' '</span><span class="token operator">--</span><span class="token char">'   `--'</span>   `<span class="token operator">--</span><span class="token char">'  `--'</span>`<span class="token operator">--</span><span class="token char">' `--'</span>`<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span>'
wiki      https<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>alibaba<span class="token punctuation">.</span>github<span class="token punctuation">.</span>io<span class="token operator">/</span>arthas
tutorials https<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>alibaba<span class="token punctuation">.</span>github<span class="token punctuation">.</span>io<span class="token operator">/</span>arthas<span class="token operator">/</span>arthas<span class="token operator">-</span>tutorials
version   <span class="token number">3.1</span><span class="token number">.7</span>
pid       <span class="token number">30725</span>
time      <span class="token number">2020</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">30</span> <span class="token number">15</span><span class="token operator">:</span><span class="token number">48</span><span class="token operator">:</span><span class="token number">33</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><p>输出 help 命令, 可以看到所有支持的命令列表. 今天会用到 <strong>dashboard, thread, jad, watch, ognl</strong> 命令, 来定位这个 HighCPUApplication 进程. 可以通过官方文档, 查看这些命令的完整介绍:</p> <p><img src="/img/ac034f73ed71d21689129c4b6d814791-20230731165210-8gdd68c.png" alt=""></p> <p><strong>dashboard 命令用于整体展示进程所有线程, 内存, GC 等情况</strong>, 其输出如下:</p> <p><img src="/img/12bd2b5d77244a494f5084f540742067-20230731165210-xepdda4.png" alt=""></p> <p>可以看到, CPU 高并不是 GC 引起的, 占用 CPU 较多的线程有 8 个, 其中 7 个是 ForkJoinPool.commonPool. ForkJoinPool.commonPool 是并行流默认使用的线程池. 所以此次 CPU 高的问题, 应该出现在某段并行流的代码上.</p> <p>接下来, <strong>要查看最繁忙的线程在执行的线程栈, 可以使用 thread -n 命令</strong>. 这里查看下最忙的 8 个线程:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>thread <span class="token operator">-</span><span class="token number">8</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>输出如下:</p> <p><img src="/img/e26326fd1b0be23d3f9307a90e8f1a67-20230731165210-yjitj64.png" alt=""></p> <p>可以看到, 由于这些线程都在处理 MD5 的操作, 所以占用了大量 CPU 资源. 我们希望分析出代码中哪些逻辑可能会执行这个操作, 所以需要从方法栈上找出自己写的类, 并重点关注.</p> <p>由于主线程也参与了 ForkJoinPool 的任务处理, 因此可以通过主线程的栈看到需要重点关注 org.geekbang.time.commonmistakes.troubleshootingtools.highcpu.HighCPUApplication 类的 doTask 方法.</p> <p>接下来, <strong>使用 jad 命令直接对 HighCPUApplication 类反编译</strong>:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>jad <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>geekbang<span class="token punctuation">.</span>time<span class="token punctuation">.</span>commonmistakes<span class="token punctuation">.</span>troubleshootingtools<span class="token punctuation">.</span>highcpu<span class="token punctuation">.</span></span>HighCPUApplication</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>可以看到, 调用路径是 main -&gt; task() -&gt; doTask(), 当 doTask 方法接收到的 int 参数等于某个常量的时候, 会进行 1 万次的 MD5 操作, 这就是耗费 CPU 的来源. 那这个魔法值到底是多少呢?</p> <p><img src="/img/ed7f2d60b113864ed049c109af8b1424-20230731165210-ccucr6r.png" alt=""></p> <p>你可能想到了, 通过 jad 命令继续查看 User 类即可. 这里因为是 Demo, 所以没有给出很复杂的逻辑. 在业务逻辑很复杂的代码中, 判断逻辑不可能这么直白, 可能还需要分析出 doTask 的 &quot;慢&quot; 会慢在什么入参上.</p> <p>这时可以<strong>使用 watch 命令来观察方法入参</strong>. 如下命令, 表示需要监控耗时超过 100 毫秒的 doTask 方法的入参, 并且输出入参, 展开 2 层入参参数:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>watch <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>geekbang<span class="token punctuation">.</span>time<span class="token punctuation">.</span>commonmistakes<span class="token punctuation">.</span>troubleshootingtools<span class="token punctuation">.</span>highcpu<span class="token punctuation">.</span></span>HighCPUApplication</span> doTask '<span class="token punctuation">{</span>params<span class="token punctuation">}</span><span class="token char">' '</span>#cost<span class="token operator">&gt;</span><span class="token number">100</span>' <span class="token operator">-</span>x <span class="token number">2</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>可以看到, 所有耗时较久的 doTask 方法的入参都是 0, 意味着 User.ADMN_ID 常量应该是 0.</p> <p><img src="/img/35bd297ca2f7f5f57d9bd7079792b1de-20230731165210-xy91sdx.png" alt=""></p> <p>最后, <strong>使用 ognl 命令来运行一个表达式, 直接查询 User 类的 ADMIN_ID 静态字段来验证是不是这样</strong>, 得到的结果果然是 0:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token punctuation">[</span>arthas<span class="token annotation punctuation">@31126</span><span class="token punctuation">]</span>$ ognl '<span class="token annotation punctuation">@org.geekbang.time.commonmistakes.troubleshootingtools.highcpu.User</span><span class="token annotation punctuation">@ADMIN_ID</span>'
<span class="token annotation punctuation">@Integer</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>需要额外说明的是, 由于 monitor, trace, watch 等命令是通过<strong>字节码增强技术</strong>来实现的, 会在指定类的方法中插入一些切面来实现数据统计和观测, 因此<strong>诊断结束要执行 shutdown 来还原类或方法字节码, 然后退出 Arthas</strong>.</p> <p>在这个案例中, 通过 Arthas 工具排查了高 CPU 的问题:</p> <ol><li>首先, 通过 dashboard + thread 命令, 基本可以在几秒钟内一键定位问题, 找出消耗 CPU 最多的线程和方法栈;</li> <li>然后, 直接 jad 反编译相关代码, 来确认根因;</li> <li>此外, 如果调用入参不明确的话, 可以使用 watch 观察方法入参, 并根据方法执行时间来过滤慢请求的入参.</li></ol> <p>可见, <strong>使用 Arthas 来定位生产问题根本用不着原始代码, 也用不着通过增加日志来帮助分析入参, 一个工具即可完成定位问题, 分析问题的全套流程</strong>.</p> <h4 id="加餐-这15年我是如何在工作中学习技术和英语的"><a href="#加餐-这15年我是如何在工作中学习技术和英语的" class="header-anchor">#</a> 加餐-这15年我是如何在工作中学习技术和英语的?</h4> <p>今天来聊聊如何在工作中, 让自己成长得更快.</p> <p>工作这些年来, 经常会有同学来找我沟通学习和成长, 他们的问题可以归结为两个.</p> <ul><li>一是, 长期参与 CRUD 业务开发项目, 技术提升出现瓶颈, 学不到新知识, 完全没有办法实践各种新技术, 以后会不会被淘汰, 找不到工作?</li> <li>二是, 英语学得比较晚, 大学的时候也只是为了应试, 英语水平很低, 看不了英文的技术资料, 更别说去外企找工作了.</li></ul> <p>不知道你是不是也面临这两个问题呢? 今天, 我就通过自己的经历和你分享一下, 如何利用有限的环境, 有限的时间来学习技术和英语?</p> <h5 id="学好技术"><a href="#学好技术" class="header-anchor">#</a> 学好技术</h5> <p>在我看来, 知识网络的搭建就是在造楼房: <strong>基础也就是地基的承载力, 决定了你能把楼造多高; 广度就像是把房子造大, 造宽; 深度就是楼房的高度</strong>. 因此, 如果想要提升自己的水平, 那这三个方面的发展缺一不可.</p> <blockquote><p>第一, 学习必须靠自觉.</p></blockquote> <p>虽说工作经历和项目经验是实践技术, 提升技术的一个重要手段, 但不可能所有的工作经历和项目都能持续地提升我们的技术. 所以, 要想提升自己的技术水平, 就必须打消仅仅通过工作经历来提升的念头, 要靠业余时间主动地持续学习和积累来提升.</p> <p>比如, 可以针对项目中用到的技术, 全面阅读官方文档, 做各种 Demo 来论证其技术特性. 在这个过程中, 一定还会产生许多技术疑问, 那就继续展开学习.</p> <blockquote><p>第二, 不要吝啬分享.</p></blockquote> <p>刚毕业那会, 我花了很多时间和精力在 CSDN 回答问题, 积极写博客, 写书和翻译书. 这些经历对我的技术成长, 帮助非常大.</p> <p>很多知识点大家自认为完全掌握了, 但其实并不是那么回事儿. 当要说出来教别人的时候, 就必须 100% 了解每一个细节. 因此, 分享不仅是帮助自己进一步理清每一个知识点, 锻炼自己的表达能力, 更是一种强迫自己学习的手段, 因为要保证按时交付.</p> <p>当然了, 分享的过程也需要些正向激励, 让自己保持分享的激情. 就比如说, 我获得的几次微软 MVP, CSDN TOP3 专家等荣誉, 就对我激励很大, 可以让我保持热情去不断地学习并帮助别人.</p> <blockquote><p>第三, 不要停留在舒适区.</p></blockquote> <p>分享一段真实经历. 我加入一家公司组建新团队后, 在做技术选型的时候, 考虑到成本等因素, 放弃了从事了七年的 <code>.NET</code>​ 技术, 转型 Java. 有了 <code>.NET</code>​ 的积累, 我自己转型 Java 只用了两周. 其实, 一开始做这个决定非常痛苦, 但是突破自己的舒适区并没有想象得那么困难. 随后, 我又自学了 iOS, 深度学习, Python 等技术或语言.</p> <p>随着掌握的技术越来越多, 这些技术不但让我触类旁通, 更让我理解了技术只是工具, 解决问题需要使用合适的技术. 因此, 也建议利用业余时间多学习几门不同类型的编程语言, 比如 Java, Python 和 Go.</p> <p>有些时候, 因为恐惧跳出舒适区而不愿意学习和引入合适的新技术来解决问题, 虽然省去了前期的学习转型成本, 但是后期却会投入更多的时间来弥补技术上的短板.</p> <blockquote><p>第四, 打好基础很重要.</p></blockquote> <p>这里的 &quot;基础&quot; 是指, 和编程语言无关的那部分知识, 包括<strong>硬件基础, 操作系统原理, TCP/IP, HTTP, 数据结构和算法, 安全基础, 设计模式, 数据库原理</strong>等. 学习基础知识是比较枯燥的过程, 需要大块的时间来系统阅读相关书籍, 并要尝试把学到的知识付诸实践. 只有实践过的技术才能映入脑子里, 否则只是书本上的知识.</p> <p>比如, 学习 TCP/IP 的时候, 可以使用 Wireshark 来观察网络数据. 又比如, 学习设计模式的时候, 可以结合身边的业务案例来思考下, 是否有对应的适用场景, 如果没有能否模拟一个场景, 然后使用所有设计模式和自己熟悉的语言开发一个实际的 Demo.</p> <p>这些看似和日常业务开发关系不大的基础知识, 却是否能够深入理解技术的最重要的基石.</p> <blockquote><p>第五, 想办法积累技术深度.</p></blockquote> <p>对开发者而言, 技术深度体现在从一个框架, 组件或 SDK 的使用者转变为开发者.</p> <p>虽然不建议大家重复去造轮子, 造框架, 但完全可以阅读各种框架的源码去了解其实现, 并亲手实现一些框架的原型. 比如, 可以尝试把 MVC, RPC, ORM, IoC, AOP 等框架, 都实现一个最基本功能点原型. 在实现的过程中, 一定会遇到很多问题和难点, 然后再继续研究一下 Spring, Hibernate, Dubbo 等框架是如何实现的.</p> <p>当把自己的小框架实现出来的那一刻, 收获的不仅是满满的成就感, 更是在技术深度积累上的更进一步. 在这个过程中, 肯定会遇到不少问题, 解决不少问题. 有了这些积累, 之后再去学习甚至二次开发那些流行的开源框架, 就会更容易了.</p> <p>除了实现一些框架外, 还建议选择一个中间件(比如 Redis, RocketMQ)来练手学习网络知识.</p> <p>可以先实现它的客户端, 用 Netty 实现 TCP 通信层的功能, 之后参照官方文档实现协议封装, 客户端连接池等功能. 在实现的过程中, 可以对自己实现的客户端进行压测, 分析和官方实现的性能差距. 这样一来, 不仅可以对 TCP/IP 网络有更深入的了解, 还可以获得很多网络方面的优化经验.</p> <p>然后, 再尝试实现服务端, 进一步加深对网络的认识. 最后尝试把服务端扩展为支持高可用的集群, 来加深对分布式通信技术的理解.</p> <blockquote><p>第六, 扩大技术广度也重要.</p></blockquote> <p>除了之前提到的多学几门编程语言之外, 在技术广度的拓展上, 还可以在两个方面下功夫.</p> <p>第一, 阅读大量的技术书籍. 新出来的各种技术图书(不只是编程相关的), 一般我都会买. 十几年来, 我买了 500 多本技术图书, 大概有三分之一是完整看过的, 还有三分之一只翻了一个大概, 还有三分之一只看了目录.</p> <p>广泛的阅读, 让我能够了解目前各种技术的主流框架和平台. 这样的好处是, 在整体看技术方案的时候, 可以知道大家都在做什么, 不至于只能理解方案中的一部分. 对于看不完的, 又比较有价值的书, 我会做好标签, 等空闲的时候再看.</p> <p>第二, 在开发程序的时候, 会直接使用运维搭建的数据库(比如 Elasticsearch, MySQL), 中间件(比如 RabbitMQ, ZooKeeper), 容器云(比如 Kubernetes). 但,果只会使用这些组件而不会搭建的话, 对它们的理解很可能只是停留在 API 或客户端层面.</p> <p>因此, 建议去尝试下从头搭建和配置这些组件, 在遇到性能问题的时候自己着手分析一下. 把实现技术的前后打通, 遇到问题时就不至于手足无措了. 我通常会购买公有云按小时收费的服务器, 来构建一些服务器集群, 尝试搭建和测试这些系统, 加深对运维的理解.</p> <h5 id="学好英语"><a href="#学好英语" class="header-anchor">#</a> 学好英语</h5> <p>为啥要单独说英语的学习方法呢, 这是因为学好英语对做技术的同学非常重要:</p> <ol><li>国外的社区环境比较好, 许多技术问题只有通过英文关键字才能在 Google 或 Stackoverflow 上搜到答案;</li> <li>可以第一时间学习各种新技术, 阅读第一手资料, 中文翻译资料往往至少有半年左右的延迟;</li> <li>参与或研究各种开源项目, 和老外沟通需要使用英语来提问, 以及阅读别人的答复.</li></ol> <p>所以学好英语可以整体拓宽个人视野. 不过, 对于上班族来说, 可能没有太多的大块时间投入英语学习, 那如何利用碎片时间, 相对休闲地学习英语呢? 还有一个问题是, 学好英语需要大量的练习和训练, 但不在外企工作就连个英语环境都没有, 那如何解决这样的矛盾呢?</p> <p>接下来将从读, 听, 写和说四个方面, 分享一下我学习英语的方法.</p> <blockquote><p>读方面</p></blockquote> <p>读对于搞技术的人来说是最重要的, 并且也是最容易掌握的. 建议这么学:</p> <ol><li>先从阅读身边的技术文档开始, 有英语文档的一定要选择阅读英语文档. 一来, 贴近实际工作, 是真正用得到的知识, 比较容易有兴趣去读; 二来, 这些文档中大部分词汇, 日常基本都接触过, 难度不会太大.</li> <li>技术书籍的常用词汇量不大, 有了一些基础后, 可以正式或非正式地参与翻译一些英语书籍或文档. 从我的经验来看, 翻译过一本书之后, 你在日常阅读任何技术资料时基本都不需要查字典了.</li> <li>订阅一些英语报纸, 比如 ChinaDaily. 第一, 贴近日常生活, 都是身边发生的事儿, 不会很枯燥; 第二, 可以进一步积累词汇量. 在这个过程中, 你肯定需要大量查字典打断阅读, 让你感觉很痛苦. 但一般来说, 一个单词最多查三次也就记住了, 所以随着时间推移, 你慢慢可以摆脱字典, 词汇量也可以上一个台阶了.</li></ol> <p>技术方面阅读能力的培养, 通常只需要三个月左右的时间, 但生活方面资料的阅读可能需要一年甚至更长的时间.</p> <blockquote><p>听方面</p></blockquote> <p>读需要积累词汇量, 听力的训练需要通过时间来磨耳朵. 每个人都可以选择适合自己的材料来磨耳朵, 比如我是通过看美剧来训练听力的.</p> <p>我就以看美剧为例, 说说练听力的几个关键点.</p> <ol><li>量变到质变的过程, 需要 1000 小时的量. 如果一部美剧是 100 小时, 那么看前 9 部的时候可能都很痛苦, 直到某一天你突然觉得一下子都可以听懂了.</li> <li>需要确保看美剧时没有中文字幕, 否则很难忍住不看, 看了字幕就无法起到训练听力的效果.</li> <li>在美剧的选择上, 可以先选择对话比较少, 也可以选择自己感兴趣的题材, 这样不容易放弃. 如果第一次听下来, 听懂率低于 30%, 连理解剧情都困难, 那么可以先带着中文字幕看一遍, 然后再脱离字幕看.</li> <li>看美剧不在乎看的多少, 而是要找适合的素材反复训练. 有人说, 反复看 100 遍《老友记》, 英语的听说能力可以接近母语是英语的人的水平.</li></ol> <p>总而言之, 选择自己喜欢的材料和内容, 从简单开始, 不断听. 如果你有一定词汇量的话, 查字典其实不是必须的, 很多时候不借助字典, 同一个单词出现 10 遍后也就知道它的意思了.</p> <p>一定要记住, 在积累 1000 小时之前, 别轻易放弃.</p> <blockquote><p>写方面</p></blockquote> <p>如果有外企经历, 那么平时写英语邮件和文档基本就可以让你的工作英语过关; 如果没有外企经历也没关系, 你可以尝试通过下面的方式锻炼写作:</p> <ol><li>每天写英语日记. 日记是自己看的, 没人会嘲笑你, 可以从简单的开始.</li> <li>在保持写作的同时, 需要确保自己能有持续的一定量的阅读. 因为写作要实现从正确到准确到优雅, 离不开阅读的积累.</li> <li>写程序的时候使用英语注释, 或者尝试写英语博客, 总之利用好一切写的机会, 来提升自己的英语表达.</li></ol> <p>再和享一个小技巧. 当要通过查词典知道中文的英语翻译时, 尽量不要直接用找到的英文单词, 最好先在英语例句中确认这个翻译的准确性再使用, 以免闹笑话.</p> <blockquote><p>说方面</p></blockquote> <p>训练说英语的机会是最少的, 毕竟身边说英语的人少, 很难自己主动练习.</p> <p>这里分享两个方法.</p> <p>第一是, 买外教的 1-1 对话课程来训练. 这些课程一般按小时计费, 由母语是英语的人在线和你聊一些话题, 帮助你训练对话能力. 买不买课程不重要, 只要能有母语是英语的人来帮你提升就可以. 同时, 大量的听力训练也可以帮助你提升说的能力, 很多英语短句经过反复强化会成为脱口而出的下意识反应. 所以, 你会发现在听力达到质变的时候, 说的能力也会上一个台阶.</p> <p>第二, 大胆说, 不要担心有语法错误, 单词发音问题, 表达不流畅问题而被嘲笑. 其实, 你可以反过来想想, 老外说中文时出现这些问题, 你会嘲笑他吗. 这里有一个技巧是, 尽量选用简单的表达和词汇去说, 先尝试把内容说出来, 甚至是只说几个关键字, 而不是憋着在脑子里尝试整理一个完整的句子. 灵活运用有限的单词, 尽可能地流畅, 准确表达, 才是聪明的做法.</p> <h4 id="结束语-写代码时如何才能尽量避免踩坑"><a href="#结束语-写代码时如何才能尽量避免踩坑" class="header-anchor">#</a> 结束语-写代码时如何才能尽量避免踩坑?</h4> <p>这个课程要告一段落了, 在这里我要特别感谢你一直以来的认可与陪伴.</p> <p>相信一路走来, 你不仅理解了业务代码开发中常见的 130 多个坑点的解决方式, 也知道了其根本原因, 以及如何使用一些常用工具来分析问题. 这样在以后遇到各种坑的时候, 你就更加能有方法, 有信心来解决问题.</p> <h5 id="如何尽量避免踩坑"><a href="#如何尽量避免踩坑" class="header-anchor">#</a> 如何尽量避免踩坑?</h5> <p>不过, 学习, 分析这些坑点并不是最终目的, 在写业务代码时如何尽量避免踩坑才是. 所以接下来要重点聊聊避免踩坑的一些方法.</p> <p>所谓坑, 往往就是意识不到的陷进. 虽然这个课程覆盖了 130 多个业务开发时可能会出错的点, 但我相信在整个 Java 开发领域还有成千上万个可能会踩的坑. 同时随着 Java 语言以及各种新框架, 新技术的产生, 还会不断遇到各种坑, 很难有一种方式确保永远不会遇到新问题.</p> <p>而大家能做的, 就是尽可能少踩坑, 或者减少踩坑带来的影响. 鉴于此, 还有 10 条建议要分享给你.</p> <p>**第一, 遇到自己不熟悉的新类, 在不了解之前不要随意使用. **</p> <p>比如 CopyOnWriteArrayList. 如果你仅仅认为 CopyOnWriteArrayList 是 ArrayList 的线程安全版本, 在不知晓原理之前把它用于大量写操作的场景, 那么很可能会遇到性能问题.</p> <p>JDK 或各种框架随着时间的推移会不断推出各种特殊类, 用于极致化各种细化场景下的程序性能. 在使用这些类之前, 需要<strong>认清楚这些类的由来, 以及要解决的问题</strong>, 在确认自己的场景符合的情况下再去使用.</p> <p>而且, 越普适的工具类通常用起来越简单, 越高级的类用起来越复杂, 也更容易踩坑. 比如, 代码加锁这一讲中提到的, 锁工具类 StampedLock 就比 ReentrantLock 或者 synchronized 的用法复杂得多, 很容易踩坑.</p> <p>**第二, 尽量使用更高层次的框架. **</p> <p>通常情况下, 偏底层的框架趋向于提供更多细节的配置, 尽可能让使用者根据自己的需求来进行不同的配置, 而较少考虑最佳实践的问题; 而高层次的框架, 则会更多地考虑怎么方便开发者开箱即用.</p> <p>比如, 在 HTTP 请求这一讲中, 谈到 Apache HttpClient 的并发数限制问题. 如果使用 Spring Cloud Feign 搭配 HttpClient, 就不会遇到单域名默认 2 个并发连接的问题. 因为 Spring Cloud Feign 已经把这个参数设置为了 50, 足够应对一般场景了.</p> <p>**第三, 关注各种框架和组件的安全补丁和版本更新. **</p> <p>比如, 使用的 Tomcat 服务器, 序列化框架等, 就是黑客关注的安全突破口. 需要及时关注这些组件和框架的稳定大版本和补丁, 并及时更新升级, 以避免组件和框架本身的性能问题或安全问题带来的大坑.</p> <p>**第四, 尽量少自己造轮子, 使用流行的框架. **</p> <p>流行框架最大的好处是成熟, 在经过大量用户的使用打磨后, 你能想到, 能遇到的所有问题几乎别人都遇到了, 框架中也有了解决方案. 很多时候会以 &quot;轻量级&quot; 为由来造轮子, 但其实很多复杂的框架, 一开始也是轻量的. 只不过是, 这些框架经过各种迭代解决了各种问题, 做了很多可扩展性预留之后, 才变得越来越复杂, 而并不一定是框架本身的设计臃肿.</p> <p>如果自己去开发框架的话, 很可能会踩一些别人已经踩过的坑. 比如, 直接使用 JDK NIO 来开发网络程序或网络框架的话, 可能会遇到 epoll 的 selector 空轮询 Bug, 最终导致 CPU 100%. 而 Netty 规避了这些问题, 因此使用 Netty 开发 NIO 网络程序, 不但简单而且可以少踩很多坑.</p> <p>**第五, 开发的时候遇到错误, 除了搜索解决方案外, 更重要的是理解原理. **</p> <p>比如, 在 OOM 这一讲, 提到的配置超大 <code>server.max-http-header-size</code>​ 参数导致的 OOM 问题, 可能就是来自网络的解决方案. 网络上别人给出的解决方案, 可能只是适合 &quot;自己&quot;, 不一定适合所有人. 并且, 各种框架迭代很频繁, 今天有效的解决方案, 明天可能就无效了; 今天有效的参数配置, 新版本可能就不再建议使用甚至失效了. 因此, 只有知其所以然, 才能从根本上避免踩坑.</p> <p>**第六, 网络上的资料有很多, 但不一定可靠, 最可靠的还是官方文档. **</p> <p>比如, 搜索 Java 8 的一些介绍, 可以看到有些资料提到了在 Java 8 中 Files.lines 方法进行文件读取更高效, 但是 Demo 代码并没使用 try-with-resources 来释放资源. 在文件 IO 这一讲中, 讲解了这么做会导致文件句柄无法释放. 其实, 网上的各种资料, 本来就是大家自己学习分享的经验和心得, 不一定都是对的. 另外, 这些资料给出的都是 Demo, 演示的是某个类在某方面的功能, 不一定会面面俱到地考虑到资源释放, 并发等问题.</p> <p>因此, 对于系统学习某个组件或框架, <strong>最推荐的还是 JDK 或者三方库的官方文档. 这些文档基本不会出现错误的示例, 一般也会提到使用的最佳实践, 以及最需要注意的点</strong>.</p> <p>**第七, 做好单元测试和性能测试. **</p> <p>如果你开发的是一个偏底层的服务或框架, 有非常多的受众和分支流程, 那么单元测试(或者是自动化测试)就是必须的.</p> <p><strong>人工测试一般针对主流程和改动点, 只有单元测试才可以确保任何一次改动不会影响现有服务的每一个细节点</strong>. 此外, 许多坑都涉及线程安全, 资源使用, 这些问题只有在高并发的情况下才会产生. 没有经过性能测试的代码, 只能认为是完成了功能, 还不能确保健壮性, 可扩展性和可靠性.</p> <p>**第八, 做好设计评审和代码审查工作. **</p> <p>人都会犯错, 而且任何一个人的知识都有盲区. 因此, 项目的设计如果能提前有专家组进行评审, 每一段代码都能有至少三个人进行代码审核, 就可以极大地减少犯错的可能性.</p> <p>比如, 对于熟悉 IO 的开发者来说, 他肯定知道文件的读写需要基于缓冲区. 如果他看到另一个同事提交的代码, 是以单字节的方式来读写文件, 就可以提前发现代码的性能问题.</p> <p>又比如, 一些比较老的资料仍然提倡使用 MD5 摘要来保存密码. 但现在 MD5 已经不安全了. 如果项目设计已经由公司内安全经验丰富的架构师和安全专家评审过, 就可以提前避免安全疏漏.</p> <p><strong>第九, 借助工具帮助避坑.</strong></p> <p>其实, 我们犯很多低级错误时, 并不是自己不知道, 而是因为疏忽. 就好像是, 即使知道可能存在这 100 个坑, 但如果一条一条地确认所有代码是否有这些坑, 也很难办到. 但是, 如果可以把规则明确的坑使用工具来检测, 就可以避免大量的低级错误.</p> <p>比如, 使用 YYYY 进行日期格式化的坑, 使用 <code>==</code>​ 进行判等的坑, List.subList 原 List 和子 List 相互影响的坑等, 都可以通过阿里 P3C 代码规约扫描插件发现. 建议为 IDE 安装这个插件.</p> <p>此外, 还建议在 CI 流程中集成 Sonarqube 代码静态扫描平台, 对需要构建发布的代码进行全面的代码质量扫描.</p> <p>**第十, 做好完善的监控报警. **</p> <p>诸如内存泄露, 文件句柄不释放, 线程泄露等消耗型问题, 往往都是量变积累成为质变, 最后才会造成进程崩溃. 如果一开始就可以对应用程序的内存使用, 文件句柄使用, IO 使用量, 网络带宽, TCP 连接, 线程数等各种指标进行监控, 并且基于合理阈值设置报警, 那么可能就能在事故的婴儿阶段及时发现问题, 解决问题.</p> <p>此外, 在遇到报警的时候, 不能凭经验想当然地认为这些问题都是已知的, 对报警置之不理. 要牢记, <strong>所有报警都需要处理和记录</strong>.</p> <p>以上, 就是要分享的 10 条建议了. 用好这 10 条建议, 可以帮助我们很大程度提前发现 Java 开发中的一些坑, 避免一些压力引起的生产事故, 或是减少踩坑的影响.</p> <p>最后, 正所谓师傅领进门, 修行靠个人, 希望你在接下来学习技术和写代码的过程中, 能够养成多研究原理, 多思考总结问题的习惯, 点点滴滴补全自己的知识网络. 对代码精益求精, 写出健壮的代码, 线上问题少了, 不但自己的心情好了, 也能得到更多认可, 并有更多时间来学习提升. 这样, 我们的个人成长就会比较快, 形成正向循环.</p></div></div>  <div class="page-edit"><div class="edit-link"><a href="https://github.com/xugaoyi/vuepress-theme-vdoing/edit/main/docs/20.开发/2100.开发/800.代码质量/740.Java业务开发常见错误100例(极客时间)🌸.md" target="_blank" rel="noopener noreferrer">编辑</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <!----> <!----></div> <div class="page-nav-wapper"><div class="page-nav-centre-wrap"><a href="/pages/c47e15/" class="page-nav-centre page-nav-centre-prev"><div class="tooltip">代码之丑(极客时间)🌸</div></a> <!----></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/pages/c47e15/" class="prev">代码之丑(极客时间)🌸</a></span> <!----></p></div></div></div> <!----></main></div> <div class="footer"><div class="icons"><a href="mailto:1174520425@qq.com" title="发邮件" target="_blank" class="iconfont icon-youjian"></a><a href="https://github.com/nanodaemony" title="GitHub" target="_blank" class="iconfont icon-github"></a></div> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="本站主题">Vdoing</a> 
    | Copyright © 2019-2025
    <span>达尔文的猹 | MIT License</span></div> <div class="buttons"><div title="返回顶部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去评论" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主题模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          跟随系统
        </li><li class="iconfont icon-rijianmoshi">
          浅色模式
        </li><li class="iconfont icon-yejianmoshi">
          深色模式
        </li><li class="iconfont icon-yuedu">
          阅读模式
        </li></ul></div></div> <!----> <!----> <!----></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.3f3e0e10.js" defer></script><script src="/assets/js/2.e9fcb30c.js" defer></script><script src="/assets/js/3.1998f389.js" defer></script><script src="/assets/js/141.d703f30b.js" defer></script>
  </body>
</html>
