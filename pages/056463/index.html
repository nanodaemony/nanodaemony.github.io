<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>MySQL基础架构与存储引擎🌟 | Pangolin Note</title>
    <meta name="generator" content="VuePress 1.9.5">
    <link rel="icon" href="/img/favicon.ico">
    <meta name="description" content="大道至简">
    <meta name="keywords" content="前端博客,个人技术博客,前端,前端开发,前端框架,web前端,前端面试题,技术文档,学习,面试,JavaScript,js,ES6,TypeScript,vue,python,css3,html5,Node,git,github,markdown">
    <meta name="baidu-site-verification" content="7F55weZDDc">
    <meta name="theme-color" content="#11a8cd">
    
    <link rel="preload" href="/assets/css/0.styles.56073ad3.css" as="style"><link rel="preload" href="/assets/js/app.3f3e0e10.js" as="script"><link rel="preload" href="/assets/js/2.e9fcb30c.js" as="script"><link rel="preload" href="/assets/js/3.1998f389.js" as="script"><link rel="preload" href="/assets/js/105.8288396c.js" as="script"><link rel="prefetch" href="/assets/js/10.0b55747f.js"><link rel="prefetch" href="/assets/js/100.b8912a99.js"><link rel="prefetch" href="/assets/js/101.a6740c8a.js"><link rel="prefetch" href="/assets/js/102.e31e89b2.js"><link rel="prefetch" href="/assets/js/103.2c5dbdae.js"><link rel="prefetch" href="/assets/js/104.0e9c02f6.js"><link rel="prefetch" href="/assets/js/106.62f43c11.js"><link rel="prefetch" href="/assets/js/107.70c90211.js"><link rel="prefetch" href="/assets/js/108.b488ce56.js"><link rel="prefetch" href="/assets/js/109.12942650.js"><link rel="prefetch" href="/assets/js/11.ac3fd1ca.js"><link rel="prefetch" href="/assets/js/110.1e57ecba.js"><link rel="prefetch" href="/assets/js/111.6e33b4ea.js"><link rel="prefetch" href="/assets/js/112.bd52831b.js"><link rel="prefetch" href="/assets/js/113.868c1ac9.js"><link rel="prefetch" href="/assets/js/114.090549d1.js"><link rel="prefetch" href="/assets/js/115.d97f6c2b.js"><link rel="prefetch" href="/assets/js/116.097c4b4e.js"><link rel="prefetch" href="/assets/js/117.4024cfe2.js"><link rel="prefetch" href="/assets/js/118.e3057cba.js"><link rel="prefetch" href="/assets/js/119.4ef1fa3b.js"><link rel="prefetch" href="/assets/js/12.863eaabe.js"><link rel="prefetch" href="/assets/js/120.78f9df50.js"><link rel="prefetch" href="/assets/js/121.8e16df87.js"><link rel="prefetch" href="/assets/js/122.f21c0107.js"><link rel="prefetch" href="/assets/js/123.ea1cb375.js"><link rel="prefetch" href="/assets/js/124.01c04c6e.js"><link rel="prefetch" href="/assets/js/125.d383e301.js"><link rel="prefetch" href="/assets/js/126.3162cb47.js"><link rel="prefetch" href="/assets/js/127.c6bebae6.js"><link rel="prefetch" href="/assets/js/128.d659db60.js"><link rel="prefetch" href="/assets/js/129.2afdcf48.js"><link rel="prefetch" href="/assets/js/13.4f59ce35.js"><link rel="prefetch" href="/assets/js/130.beb9ed9d.js"><link rel="prefetch" href="/assets/js/131.35b05f8a.js"><link rel="prefetch" href="/assets/js/132.d77f4f93.js"><link rel="prefetch" href="/assets/js/133.4ceda6e5.js"><link rel="prefetch" href="/assets/js/134.11390c5f.js"><link rel="prefetch" href="/assets/js/135.32f9e38f.js"><link rel="prefetch" href="/assets/js/136.6d8bb0f2.js"><link rel="prefetch" href="/assets/js/137.9c0ffeef.js"><link rel="prefetch" href="/assets/js/138.88d86e5f.js"><link rel="prefetch" href="/assets/js/139.8c2c3d6c.js"><link rel="prefetch" href="/assets/js/14.11c82d35.js"><link rel="prefetch" href="/assets/js/140.c5c375d3.js"><link rel="prefetch" href="/assets/js/141.d703f30b.js"><link rel="prefetch" href="/assets/js/142.6a005a44.js"><link rel="prefetch" href="/assets/js/143.9b2edf6f.js"><link rel="prefetch" href="/assets/js/144.3fd013c9.js"><link rel="prefetch" href="/assets/js/145.b05079c5.js"><link rel="prefetch" href="/assets/js/146.ed5360a6.js"><link rel="prefetch" href="/assets/js/147.7408d86f.js"><link rel="prefetch" href="/assets/js/148.f390b370.js"><link rel="prefetch" href="/assets/js/149.95017f0a.js"><link rel="prefetch" href="/assets/js/15.bd143bd5.js"><link rel="prefetch" href="/assets/js/150.f0ede764.js"><link rel="prefetch" href="/assets/js/151.b7093623.js"><link rel="prefetch" href="/assets/js/152.a82a6c83.js"><link rel="prefetch" href="/assets/js/153.965e3fb2.js"><link rel="prefetch" href="/assets/js/154.9e49311e.js"><link rel="prefetch" href="/assets/js/155.cef33ba5.js"><link rel="prefetch" href="/assets/js/156.bcc397ae.js"><link rel="prefetch" href="/assets/js/157.90824739.js"><link rel="prefetch" href="/assets/js/158.efd429b9.js"><link rel="prefetch" href="/assets/js/159.122ff5b7.js"><link rel="prefetch" href="/assets/js/16.2449162b.js"><link rel="prefetch" href="/assets/js/160.0b806535.js"><link rel="prefetch" href="/assets/js/161.835052c6.js"><link rel="prefetch" href="/assets/js/162.ca34e2d2.js"><link rel="prefetch" href="/assets/js/163.08000d04.js"><link rel="prefetch" href="/assets/js/164.a1cc0109.js"><link rel="prefetch" href="/assets/js/165.65444686.js"><link rel="prefetch" href="/assets/js/166.7d73c84f.js"><link rel="prefetch" href="/assets/js/167.009d47a3.js"><link rel="prefetch" href="/assets/js/168.0afeae2a.js"><link rel="prefetch" href="/assets/js/169.7654cb31.js"><link rel="prefetch" href="/assets/js/17.eb7f9def.js"><link rel="prefetch" href="/assets/js/170.58569530.js"><link rel="prefetch" href="/assets/js/171.7db9ed40.js"><link rel="prefetch" href="/assets/js/172.3cb50ed4.js"><link rel="prefetch" href="/assets/js/173.0846425f.js"><link rel="prefetch" href="/assets/js/174.9e95f111.js"><link rel="prefetch" href="/assets/js/175.ef2098f2.js"><link rel="prefetch" href="/assets/js/176.c2635fe9.js"><link rel="prefetch" href="/assets/js/177.4fa38e8e.js"><link rel="prefetch" href="/assets/js/178.2be7037f.js"><link rel="prefetch" href="/assets/js/179.bf3bba28.js"><link rel="prefetch" href="/assets/js/18.0455f4d1.js"><link rel="prefetch" href="/assets/js/180.72c5f597.js"><link rel="prefetch" href="/assets/js/181.42287bcc.js"><link rel="prefetch" href="/assets/js/182.6cd4bf1a.js"><link rel="prefetch" href="/assets/js/183.05dbbfd9.js"><link rel="prefetch" href="/assets/js/184.03de7e00.js"><link rel="prefetch" href="/assets/js/185.42dd210e.js"><link rel="prefetch" href="/assets/js/186.28ee0f8a.js"><link rel="prefetch" href="/assets/js/187.bb58697b.js"><link rel="prefetch" href="/assets/js/188.1bc8be96.js"><link rel="prefetch" href="/assets/js/189.fac747e3.js"><link rel="prefetch" href="/assets/js/19.ae9e35d6.js"><link rel="prefetch" href="/assets/js/190.ea533ac7.js"><link rel="prefetch" href="/assets/js/191.6dc6eb13.js"><link rel="prefetch" href="/assets/js/192.184d249f.js"><link rel="prefetch" href="/assets/js/193.4a06bc12.js"><link rel="prefetch" href="/assets/js/194.8cce60a9.js"><link rel="prefetch" href="/assets/js/195.93231a13.js"><link rel="prefetch" href="/assets/js/196.4a596bde.js"><link rel="prefetch" href="/assets/js/197.96c113cf.js"><link rel="prefetch" href="/assets/js/198.73ba3f67.js"><link rel="prefetch" href="/assets/js/199.74bab595.js"><link rel="prefetch" href="/assets/js/20.b542d0e7.js"><link rel="prefetch" href="/assets/js/200.69a6928a.js"><link rel="prefetch" href="/assets/js/201.9ffa7c5a.js"><link rel="prefetch" href="/assets/js/202.41edb652.js"><link rel="prefetch" href="/assets/js/203.7fabcef3.js"><link rel="prefetch" href="/assets/js/204.b0ae2f62.js"><link rel="prefetch" href="/assets/js/205.add8738b.js"><link rel="prefetch" href="/assets/js/206.f3a712ec.js"><link rel="prefetch" href="/assets/js/207.cd7dd729.js"><link rel="prefetch" href="/assets/js/208.78b33afa.js"><link rel="prefetch" href="/assets/js/209.9d3329ff.js"><link rel="prefetch" href="/assets/js/21.5a050318.js"><link rel="prefetch" href="/assets/js/210.d285d5ac.js"><link rel="prefetch" href="/assets/js/211.8791bb3f.js"><link rel="prefetch" href="/assets/js/212.84ed81a8.js"><link rel="prefetch" href="/assets/js/213.7b990580.js"><link rel="prefetch" href="/assets/js/214.da31f20c.js"><link rel="prefetch" href="/assets/js/215.9eeed659.js"><link rel="prefetch" href="/assets/js/216.9539f0ec.js"><link rel="prefetch" href="/assets/js/217.11b575be.js"><link rel="prefetch" href="/assets/js/218.a67f12f1.js"><link rel="prefetch" href="/assets/js/219.bfbb817a.js"><link rel="prefetch" href="/assets/js/22.2bc6f7e3.js"><link rel="prefetch" href="/assets/js/220.8b01342f.js"><link rel="prefetch" href="/assets/js/221.b450decd.js"><link rel="prefetch" href="/assets/js/222.97468507.js"><link rel="prefetch" href="/assets/js/223.b6dafd73.js"><link rel="prefetch" href="/assets/js/224.c86c18c6.js"><link rel="prefetch" href="/assets/js/225.b0dcf86e.js"><link rel="prefetch" href="/assets/js/226.02cc2999.js"><link rel="prefetch" href="/assets/js/227.8474ef5a.js"><link rel="prefetch" href="/assets/js/228.0298e421.js"><link rel="prefetch" href="/assets/js/229.6aeaf595.js"><link rel="prefetch" href="/assets/js/23.9995fce4.js"><link rel="prefetch" href="/assets/js/230.a5785286.js"><link rel="prefetch" href="/assets/js/231.d791daa4.js"><link rel="prefetch" href="/assets/js/232.97aeeb00.js"><link rel="prefetch" href="/assets/js/233.46e51e28.js"><link rel="prefetch" href="/assets/js/234.2cffe82f.js"><link rel="prefetch" href="/assets/js/235.14965da6.js"><link rel="prefetch" href="/assets/js/236.00a5afc0.js"><link rel="prefetch" href="/assets/js/237.3b73d52f.js"><link rel="prefetch" href="/assets/js/238.6e1db765.js"><link rel="prefetch" href="/assets/js/239.75866c5e.js"><link rel="prefetch" href="/assets/js/24.9141eeb2.js"><link rel="prefetch" href="/assets/js/240.af9c2cc9.js"><link rel="prefetch" href="/assets/js/241.388acab2.js"><link rel="prefetch" href="/assets/js/242.c60f2b48.js"><link rel="prefetch" href="/assets/js/243.d8e81b13.js"><link rel="prefetch" href="/assets/js/244.58b0b21d.js"><link rel="prefetch" href="/assets/js/245.c3768497.js"><link rel="prefetch" href="/assets/js/246.ac8bbe7a.js"><link rel="prefetch" href="/assets/js/247.d095f70a.js"><link rel="prefetch" href="/assets/js/248.e9f210b5.js"><link rel="prefetch" href="/assets/js/249.a9fad023.js"><link rel="prefetch" href="/assets/js/25.98e8593e.js"><link rel="prefetch" href="/assets/js/250.ae7f0ebb.js"><link rel="prefetch" href="/assets/js/251.9a617d55.js"><link rel="prefetch" href="/assets/js/252.ce082446.js"><link rel="prefetch" href="/assets/js/253.4575302d.js"><link rel="prefetch" href="/assets/js/254.5899a61b.js"><link rel="prefetch" href="/assets/js/255.66c69f31.js"><link rel="prefetch" href="/assets/js/256.8fd6c706.js"><link rel="prefetch" href="/assets/js/257.31b77e5e.js"><link rel="prefetch" href="/assets/js/258.eba48891.js"><link rel="prefetch" href="/assets/js/259.edf74b59.js"><link rel="prefetch" href="/assets/js/26.e69924ea.js"><link rel="prefetch" href="/assets/js/260.cf2ed36d.js"><link rel="prefetch" href="/assets/js/261.9e7792d8.js"><link rel="prefetch" href="/assets/js/262.e7b9433e.js"><link rel="prefetch" href="/assets/js/263.1185b25c.js"><link rel="prefetch" href="/assets/js/264.5e0f89cb.js"><link rel="prefetch" href="/assets/js/265.a38d3b94.js"><link rel="prefetch" href="/assets/js/266.2ef170b3.js"><link rel="prefetch" href="/assets/js/267.a7d14651.js"><link rel="prefetch" href="/assets/js/268.05b18748.js"><link rel="prefetch" href="/assets/js/269.dad48d6f.js"><link rel="prefetch" href="/assets/js/27.13612515.js"><link rel="prefetch" href="/assets/js/270.4f5a6b8d.js"><link rel="prefetch" href="/assets/js/271.7ebf6682.js"><link rel="prefetch" href="/assets/js/272.7c2fbfd1.js"><link rel="prefetch" href="/assets/js/273.8ee20732.js"><link rel="prefetch" href="/assets/js/274.d525242a.js"><link rel="prefetch" href="/assets/js/275.a8a19acb.js"><link rel="prefetch" href="/assets/js/276.df3a4eb4.js"><link rel="prefetch" href="/assets/js/277.336debda.js"><link rel="prefetch" href="/assets/js/278.c470625f.js"><link rel="prefetch" href="/assets/js/279.a91e1a64.js"><link rel="prefetch" href="/assets/js/28.ab7ae1df.js"><link rel="prefetch" href="/assets/js/280.87e25c9a.js"><link rel="prefetch" href="/assets/js/281.87c1ba25.js"><link rel="prefetch" href="/assets/js/282.dcd4dce0.js"><link rel="prefetch" href="/assets/js/283.abac2e00.js"><link rel="prefetch" href="/assets/js/284.f6079659.js"><link rel="prefetch" href="/assets/js/285.f1b39879.js"><link rel="prefetch" href="/assets/js/286.f6a79242.js"><link rel="prefetch" href="/assets/js/287.06bebe07.js"><link rel="prefetch" href="/assets/js/288.89e325df.js"><link rel="prefetch" href="/assets/js/289.3aa1bedd.js"><link rel="prefetch" href="/assets/js/29.ebe50f76.js"><link rel="prefetch" href="/assets/js/290.ee059c92.js"><link rel="prefetch" href="/assets/js/291.fa9a921a.js"><link rel="prefetch" href="/assets/js/292.2a8811cd.js"><link rel="prefetch" href="/assets/js/293.eec09cdf.js"><link rel="prefetch" href="/assets/js/294.dfac20dc.js"><link rel="prefetch" href="/assets/js/295.825d2070.js"><link rel="prefetch" href="/assets/js/296.f645861e.js"><link rel="prefetch" href="/assets/js/297.424fdb17.js"><link rel="prefetch" href="/assets/js/298.ebf87cdc.js"><link rel="prefetch" href="/assets/js/299.b8f19cbb.js"><link rel="prefetch" href="/assets/js/30.75237511.js"><link rel="prefetch" href="/assets/js/300.10fb6d4f.js"><link rel="prefetch" href="/assets/js/301.ef77c612.js"><link rel="prefetch" href="/assets/js/302.1b839763.js"><link rel="prefetch" href="/assets/js/303.609f7d98.js"><link rel="prefetch" href="/assets/js/304.1d255f19.js"><link rel="prefetch" href="/assets/js/305.b0234f2c.js"><link rel="prefetch" href="/assets/js/306.48677f64.js"><link rel="prefetch" href="/assets/js/307.14390d4b.js"><link rel="prefetch" href="/assets/js/308.fa730b28.js"><link rel="prefetch" href="/assets/js/309.0496b9e0.js"><link rel="prefetch" href="/assets/js/31.cf3f471a.js"><link rel="prefetch" href="/assets/js/310.a31676dc.js"><link rel="prefetch" href="/assets/js/311.ed53adc5.js"><link rel="prefetch" href="/assets/js/312.1b0ff2f1.js"><link rel="prefetch" href="/assets/js/313.bf123f32.js"><link rel="prefetch" href="/assets/js/314.4e6ce06b.js"><link rel="prefetch" href="/assets/js/315.8eb18560.js"><link rel="prefetch" href="/assets/js/32.74fef842.js"><link rel="prefetch" href="/assets/js/33.bc2d190b.js"><link rel="prefetch" href="/assets/js/34.d23438fc.js"><link rel="prefetch" href="/assets/js/35.7675c4d0.js"><link rel="prefetch" href="/assets/js/36.96a4161b.js"><link rel="prefetch" href="/assets/js/37.d1824f2f.js"><link rel="prefetch" href="/assets/js/38.4effff9e.js"><link rel="prefetch" href="/assets/js/39.6509914b.js"><link rel="prefetch" href="/assets/js/4.4d01750f.js"><link rel="prefetch" href="/assets/js/40.1509d08b.js"><link rel="prefetch" href="/assets/js/41.f2c1124f.js"><link rel="prefetch" href="/assets/js/42.e541d077.js"><link rel="prefetch" href="/assets/js/43.369de999.js"><link rel="prefetch" href="/assets/js/44.43959db0.js"><link rel="prefetch" href="/assets/js/45.282fbd31.js"><link rel="prefetch" href="/assets/js/46.1b83cfe9.js"><link rel="prefetch" href="/assets/js/47.c3a88e41.js"><link rel="prefetch" href="/assets/js/48.bc7c0a1b.js"><link rel="prefetch" href="/assets/js/49.92a4e5ba.js"><link rel="prefetch" href="/assets/js/5.c3991e24.js"><link rel="prefetch" href="/assets/js/50.9c488c6c.js"><link rel="prefetch" href="/assets/js/51.546ea632.js"><link rel="prefetch" href="/assets/js/52.0d2ccee1.js"><link rel="prefetch" href="/assets/js/53.6f52b5b1.js"><link rel="prefetch" href="/assets/js/54.c838b295.js"><link rel="prefetch" href="/assets/js/55.13af99ee.js"><link rel="prefetch" href="/assets/js/56.6be6d1ed.js"><link rel="prefetch" href="/assets/js/57.67c98b39.js"><link rel="prefetch" href="/assets/js/58.107e82ec.js"><link rel="prefetch" href="/assets/js/59.b3e5edc7.js"><link rel="prefetch" href="/assets/js/6.36a535f9.js"><link rel="prefetch" href="/assets/js/60.3b0b4ba5.js"><link rel="prefetch" href="/assets/js/61.3df843df.js"><link rel="prefetch" href="/assets/js/62.1213823d.js"><link rel="prefetch" href="/assets/js/63.e8f3f926.js"><link rel="prefetch" href="/assets/js/64.e1219050.js"><link rel="prefetch" href="/assets/js/65.5bf5bb0b.js"><link rel="prefetch" href="/assets/js/66.a2502afb.js"><link rel="prefetch" href="/assets/js/67.690dd59b.js"><link rel="prefetch" href="/assets/js/68.de7b0915.js"><link rel="prefetch" href="/assets/js/69.ac61dd61.js"><link rel="prefetch" href="/assets/js/7.5d254238.js"><link rel="prefetch" href="/assets/js/70.3edd41b1.js"><link rel="prefetch" href="/assets/js/71.d23407e9.js"><link rel="prefetch" href="/assets/js/72.a5bd01bc.js"><link rel="prefetch" href="/assets/js/73.c9f4dd57.js"><link rel="prefetch" href="/assets/js/74.66323fc1.js"><link rel="prefetch" href="/assets/js/75.e1a72e00.js"><link rel="prefetch" href="/assets/js/76.801268b4.js"><link rel="prefetch" href="/assets/js/77.3a5fda67.js"><link rel="prefetch" href="/assets/js/78.54d84cd4.js"><link rel="prefetch" href="/assets/js/79.fa10f4e3.js"><link rel="prefetch" href="/assets/js/8.e060e47d.js"><link rel="prefetch" href="/assets/js/80.d5b24fea.js"><link rel="prefetch" href="/assets/js/81.0e9da714.js"><link rel="prefetch" href="/assets/js/82.e96ff6d7.js"><link rel="prefetch" href="/assets/js/83.771cced1.js"><link rel="prefetch" href="/assets/js/84.220b69e7.js"><link rel="prefetch" href="/assets/js/85.7dcc5659.js"><link rel="prefetch" href="/assets/js/86.44ba2100.js"><link rel="prefetch" href="/assets/js/87.281da75d.js"><link rel="prefetch" href="/assets/js/88.12d88449.js"><link rel="prefetch" href="/assets/js/89.f28c86d3.js"><link rel="prefetch" href="/assets/js/9.8f9fef32.js"><link rel="prefetch" href="/assets/js/90.715cabb2.js"><link rel="prefetch" href="/assets/js/91.6ced7c82.js"><link rel="prefetch" href="/assets/js/92.c05b33ca.js"><link rel="prefetch" href="/assets/js/93.6bf5fb66.js"><link rel="prefetch" href="/assets/js/94.3561200e.js"><link rel="prefetch" href="/assets/js/95.0f2cf716.js"><link rel="prefetch" href="/assets/js/96.ac8487ea.js"><link rel="prefetch" href="/assets/js/97.48042b5a.js"><link rel="prefetch" href="/assets/js/98.441bb7f8.js"><link rel="prefetch" href="/assets/js/99.4b214d92.js">
    <link rel="stylesheet" href="/assets/css/0.styles.56073ad3.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu"><header class="navbar blur"><div title="目录" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/img/magic.png" alt="Pangolin Note" class="logo"> <span class="site-name can-hide">Pangolin Note</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">🏡首页</a></div><div class="nav-item"><a href="/basic/" class="nav-link">基础</a></div><div class="nav-item"><a href="/develop/" class="nav-link">开发</a></div><div class="nav-item"><a href="/middleware/" class="nav-link">系统</a></div><div class="nav-item"><a href="/algorithm/" class="nav-link">算法</a></div><div class="nav-item"><a href="/books/" class="nav-link">🍀读书笔记</a></div><div class="nav-item"><a href="/work/" class="nav-link">工作</a></div><div class="nav-item"><a href="/pangolin/" class="nav-link">🌸达尔文的猹</a></div><div class="nav-item"><a href="/pages/beb6c0bd8a66cea6/" class="nav-link">收藏</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/archives/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">归档</a></li></ul></div></div> <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><div class="blogger"><img src="/img/avatarnew.png"> <div class="blogger-info"><h3>达尔文的猹</h3> <span>大道至简 悟在天成</span></div></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">🏡首页</a></div><div class="nav-item"><a href="/basic/" class="nav-link">基础</a></div><div class="nav-item"><a href="/develop/" class="nav-link">开发</a></div><div class="nav-item"><a href="/middleware/" class="nav-link">系统</a></div><div class="nav-item"><a href="/algorithm/" class="nav-link">算法</a></div><div class="nav-item"><a href="/books/" class="nav-link">🍀读书笔记</a></div><div class="nav-item"><a href="/work/" class="nav-link">工作</a></div><div class="nav-item"><a href="/pangolin/" class="nav-link">🌸达尔文的猹</a></div><div class="nav-item"><a href="/pages/beb6c0bd8a66cea6/" class="nav-link">收藏</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/archives/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">归档</a></li></ul></div></div> <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Java</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading open"><span>基础</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/4f30b9/" class="sidebar-link">Java基础</a></li><li><a href="/pages/795eca/" class="sidebar-link">类与继承</a></li><li><a href="/pages/c69152/" class="sidebar-link">抽象类与接口</a></li><li><a href="/pages/d71abb/" class="sidebar-link">内部类</a></li><li><a href="/pages/f06dca/" class="sidebar-link">枚举类</a></li><li><a href="/pages/259f57/" class="sidebar-link">常用类</a></li><li><a href="/pages/84b03b/" class="sidebar-link">关键字</a></li><li><a href="/pages/31b87b/" class="sidebar-link">注解</a></li><li><a href="/pages/f81c0d/" class="sidebar-link">异常</a></li><li><a href="/pages/ae7746/" class="sidebar-link">泛型</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading"><span>容器类</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/0c88ac/" class="sidebar-link">集合容器类基础</a></li><li><a href="/pages/f805ed/" class="sidebar-link">List与Queue类</a></li><li><a href="/pages/d24b60/" class="sidebar-link">Map与Set类</a></li><li><a href="/pages/54e5d3/" class="sidebar-link">并发容器类</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading"><span>并发</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/67d70f/" class="sidebar-link">多线程基础</a></li><li><a href="/pages/ffc8f7/" class="sidebar-link">Java内置锁</a></li><li><a href="/pages/c43494/" class="sidebar-link">AQS</a></li><li><a href="/pages/eb5b61/" class="sidebar-link">显式锁ReentrantLock</a></li><li><a href="/pages/eb8cbc/" class="sidebar-link">线程协作与JUC组件</a></li><li><a href="/pages/23c79a/" class="sidebar-link">Atomic原子变量与Unsafe类与CAS</a></li><li><a href="/pages/9d6ed4/" class="sidebar-link">线程池与定时任务</a></li><li><a href="/pages/5b787a/" class="sidebar-link">ThreadLocal</a></li><li><a href="/pages/db53d1/" class="sidebar-link">Java并发编程实战(极客时间)🌸</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading"><span>IO</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/b4d461/" class="sidebar-link">文件操作</a></li><li><a href="/pages/1b9d6c/" class="sidebar-link">IO流操作</a></li><li><a href="/pages/076a47/" class="sidebar-link">Java网络IO模型</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading"><span>高级特性</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/d76905/" class="sidebar-link">Lambda表达式</a></li><li><a href="/pages/f7f0e6/" class="sidebar-link">流Stream</a></li><li><a href="/pages/7cc40a/" class="sidebar-link">反射</a></li><li><a href="/pages/945326/" class="sidebar-link">代理</a></li><li><a href="/pages/7fd9b4/" class="sidebar-link">Javaagent</a></li><li><a href="/pages/a3cee0/" class="sidebar-link">Guava</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading"><span>JVM</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/d308f6/" class="sidebar-link">走进JVM🌼</a></li><li><a href="/pages/be0269/" class="sidebar-link">JVM内存区域与对象解析🌼</a></li><li><a href="/pages/48d1be/" class="sidebar-link">垃圾收集器与内存分配策略🌼</a></li><li><a href="/pages/3a4c8a/" class="sidebar-link">JVM性能监控与故障处理工具🌼</a></li><li><a href="/pages/106680/" class="sidebar-link">调优案例分析与实战🌼</a></li><li><a href="/pages/16a914/" class="sidebar-link">类文件结构🌼</a></li><li><a href="/pages/ea287c/" class="sidebar-link">虚拟机类加载机制🌼</a></li><li><a href="/pages/6367b0/" class="sidebar-link">虚拟机字节码执行引擎🌼</a></li><li><a href="/pages/c6c210/" class="sidebar-link">类加载及执行子系统的案例与实战🌼</a></li><li><a href="/pages/deb8b7/" class="sidebar-link">前端编译与优化🌼</a></li><li><a href="/pages/1f8f72/" class="sidebar-link">后端编译与优化🌼</a></li><li><a href="/pages/3d72db/" class="sidebar-link">Java内存模型与线程实现🌼</a></li><li><a href="/pages/ed086e/" class="sidebar-link">线程安全与内置锁优化🌼</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading"><span>其他</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/56b9dd/" class="sidebar-link">Java性能问题定位分析</a></li><li><a href="/pages/939bf8/" class="sidebar-link">杂记</a></li></ul></section></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>开发</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading"><span>软件设计</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/a5f6fe/" class="sidebar-link">设计基础理论</a></li><li><a href="/pages/3b245c/" class="sidebar-link">设计模式之美(极客时间)🌟</a></li><li><a href="/pages/661fa4/" class="sidebar-link">领域驱动设计(DDD)</a></li><li><a href="/pages/856368/" class="sidebar-link">DDD实战课(极客时间)🌸</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading open"><span>数据库</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/d3fbd2/" class="sidebar-link">数据库基础</a></li><li><a href="/pages/691fc3/" class="sidebar-link">数据库系统原理</a></li><li><a href="/pages/50f6b7/" class="sidebar-link">MySQL基础必知必会</a></li><li><a href="/pages/fe297e/" class="sidebar-link">MySQL特性</a></li><li><a href="/pages/07bdb6/" class="sidebar-link">MySQL索引🌟</a></li><li><a href="/pages/984715/" class="sidebar-link">MySQL锁🌟</a></li><li><a href="/pages/53b588/" class="sidebar-link">MySQL事务🌟</a></li><li><a href="/pages/becc59/" class="sidebar-link">MySQL高级特性</a></li><li><a href="/pages/056463/" aria-current="page" class="active sidebar-link">MySQL基础架构与存储引擎🌟</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/pages/63b46e/" class="sidebar-link">MySQL架构优化与运维</a></li><li><a href="/pages/9995e5/" class="sidebar-link">MySQL优化</a></li><li><a href="/pages/c1c2f6/" class="sidebar-link">MySQL架构</a></li><li><a href="/pages/8e8e0a/" class="sidebar-link">MySQL设计规范</a></li><li><a href="/pages/0219aa/" class="sidebar-link">MySQL运维</a></li><li><a href="/pages/e288c0/" class="sidebar-link">MySQL中间件</a></li><li><a href="/pages/c6cafa/" class="sidebar-link">MySQL实战45讲(极客时间)🌟</a></li><li><a href="/pages/4a6106/" class="sidebar-link">数据库LeetCode题目</a></li><li><a href="/pages/2827f1/" class="sidebar-link">数据库综合问题</a></li><li><a href="/pages/c616d5/" class="sidebar-link">MongoDB</a></li><li><a href="/pages/075e71/" class="sidebar-link">ClickHouse</a></li><li><a href="/pages/d74f6d/" class="sidebar-link">Doris</a></li><li><a href="/pages/b6bad9/" class="sidebar-link">HBase</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading"><span>Spring</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/bd8eb8/" class="sidebar-link">Spring Boot基础</a></li><li><a href="/pages/d0d797/" class="sidebar-link">Spring Boot应用整合</a></li><li><a href="/pages/314cdc/" class="sidebar-link">Spring MVC基础</a></li><li><a href="/pages/80de47/" class="sidebar-link">Spring AOP基础</a></li><li><a href="/pages/f0d4d6/" class="sidebar-link">Spring事务基础</a></li><li><a href="/pages/db6afe/" class="sidebar-link">Spring IOC源码分析-概览</a></li><li><a href="/pages/672e98/" class="sidebar-link">Spring IOC源码分析-getBean()</a></li><li><a href="/pages/695b90/" class="sidebar-link">Spring IOC源码分析-createBean()</a></li><li><a href="/pages/f89bcf/" class="sidebar-link">Spring AOP源码分析</a></li><li><a href="/pages/3b52f4/" class="sidebar-link">Spring事务源码分析</a></li><li><a href="/pages/186902/" class="sidebar-link">Spring Boot源码分析</a></li><li><a href="/pages/16bd1c/" class="sidebar-link">Spring MVC源码分析</a></li><li><a href="/pages/3d0c1f/" class="sidebar-link">Spring Cloud</a></li><li><a href="/pages/d56156/" class="sidebar-link">Spring编程常见错误50例(极客时间)🌸</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading"><span>MyBatis</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/bb032d/" class="sidebar-link">基础</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading"><span>工具与环境</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/c9cb6e/" class="sidebar-link">Arthas</a></li><li><a href="/pages/3172bb/" class="sidebar-link">Maven</a></li><li><a href="/pages/37f79a/" class="sidebar-link">Git</a></li><li><a href="/pages/db9f99/" class="sidebar-link">环境搭建与部署</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading"><span>测试</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/c725f5/" class="sidebar-link">测试基础</a></li><li><a href="/pages/7893a4/" class="sidebar-link">单元测试</a></li><li><a href="/pages/af9f25/" class="sidebar-link">压力测试</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading"><span>代码质量</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/ec2b81/" class="sidebar-link">代码整洁之道</a></li><li><a href="/pages/474cdf/" class="sidebar-link">阿里巴巴编程规范</a></li><li><a href="/pages/c47e15/" class="sidebar-link">代码之丑(极客时间)🌸</a></li><li><a href="/pages/4d4606/" class="sidebar-link">Java业务开发常见错误100例(极客时间)🌸</a></li></ul></section></li></ul></section></li></ul> </aside> <div><main class="page"><div class="theme-vdoing-wrapper "><div class="articleInfo-wrap" data-v-06970110><div class="articleInfo" data-v-06970110><ul class="breadcrumbs" data-v-06970110><li data-v-06970110><a href="/" title="首页" class="iconfont icon-home router-link-active" data-v-06970110></a></li> <li data-v-06970110><a href="/develop/#开发" data-v-06970110>开发</a></li><li data-v-06970110><a href="/develop/#开发" data-v-06970110>开发</a></li><li data-v-06970110><a href="/develop/#数据库" data-v-06970110>数据库</a></li></ul> <div class="info" data-v-06970110><div title="作者" class="author iconfont icon-touxiang" data-v-06970110><a href="https://github.com/nanodaemony" target="_blank" title="作者" class="beLink" data-v-06970110>NanoDaemony</a></div> <div title="创建时间" class="date iconfont icon-riqi" data-v-06970110><a href="javascript:;" data-v-06970110>2025-02-26</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-title">本文目录</div> <div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABKFJREFUSA3tVl1oFVcQnrMbrak3QUgkya1akpJYcrUtIqW1JvFBE9LiQ5v6JmJpolbMg32rVrhgoYK0QiMY6i9Y6EMaW5D+xFJaTYItIuK2Kr3+BJNwkxBj05sQY3b3nM6cs2dv9t7NT/vQJw/sndk5M/PNzJkzewGerP+pAmy+ON8lLzUJgA8ZYxYIYZmGYRnctDaWvJJAmTtfP1pvXsBCCPP8QFcCaRkZYACgDZFO4stNIcBCajEOlmmC9XpJ9bAGCaPaPmzPl32dvLSVu3BWCTQs0XQQ6g0DYgwLIoAZbBCdW/i+781o1VVlm/410mw4h06Y7bIPHNyWDyL4FHkX03Q8SrzNhZTZriieckWt7cL6MM85YcLpsi/7O9/iXFT6MswI0DmmpkSaJ0qLxFIm3+i1THHB3zmBH3PYx9CcykcLOeQVVa7QtdxTgQgEleX2AjHYfwA+2ddV77ruGoJUbhGDI09YSNXyMpUt5ylOzxgbUmtOp7NmbNt8v3arjTBfYELmLUV+M+nSawNNAUqpT3ClJWg5I3BLT+cGW/DXNGCa6tx1aakCGEigArTn4TDIPdrXXYKCZNrHLMCOEPvHBlLQ99s9eHB7EB6NTki73CVPQ2F5MSx/uRQixfmq7rK0wYD8w8E905bnPDfwoWs/rfv93NWN/ZfvwsLIU7A09gxECyISeGJkHAau98L97tuw7NXnoPyNF8FcYGLGKsOs0mN3OEyec9esGW/ZEl945dTP34wlR2FZVQWU1q0Cw8Tr7p+hgLLNL0FPxx/Q35mA8aEUrH6nCgwEl0tn7wUiZYJnNRh6DK4UH/k0lfyrsBKdPVv/AriGIQcEDQZ65LBAGe2Rzui9Ybjz7XUppz1/uKBbyVPGkN3ZAeC6hr0x7Nr38N5+EqkoOm17xpoqR9ohQF55ERSvr4Dkr3chNfC3DMzGJlNBElW8w9nsGQvhNGIzDkXzCg8cLK951xHsFBlTJspJNi3ZFIMF2AeDV3q8DNOB+YHi6QTrChDIWDBRi5U5f+ZMfJLu3ccrqxtdxk4SKH336LFxSmkqefwU5T8fhdSdQf9IVKD6aNiwI/hnmcAZ91isYMJIaCUCx9W098+LgruikeTqzqqxKPUwqJyCPJiyemVVZBOijDGjD38Os0jOiSPL1z3SPjXNANbiNPXAdzTfukjjuknNBbyz3nwgTd3AVFqUJ5hpHlq9MveLnWwttUfoygBmvVjuikxND3znrhsELnZk7k+OjIGxeNEkomyLVta0xxn+HZhjBc4YZ/AFjHjz9u3xRZl2BN4aq9nFwWh16IrQ1aHHEd3j1+4/dB9OtH4e29A2H1DyHQRmOSfQZ1Fy7MHBTGB6J/Djq6p3OxyO2cB+4Car7v/o3GXgfAkj23+x9ID1Teoamo/SXcbvSf2PX7Vc8DdCmE1vN9di+32P9/5YR3vLnhCVGUWBjEkr3yh4H8v9CzmsbdhzOKzsJKM90iFdaTMjRPhGVsakRvOaRidljo6H6G7j+ctrJpsP+4COhDIl0La2+FS4+5mlocBaXY5QnGZysIBYoeSsl5qQzrSj/cgNrfuEzlWBfwA+EjrZyWUvpAAAAABJRU5ErkJggg==">MySQL基础架构与存储引擎🌟<!----></h1>  <div class="theme-vdoing-content content__default"><h1 id="_250-mysql基础架构与存储引擎🌟"><a href="#_250-mysql基础架构与存储引擎🌟" class="header-anchor">#</a> 250.MySQL基础架构与存储引擎🌟</h1> <h4 id="mysql架构🌟"><a href="#mysql架构🌟" class="header-anchor">#</a> MySQL架构🌟</h4> <p>下图是 MySQL 的简要架构图. 整体主要分为 <strong>Server 层和存储引擎层</strong>.</p> <p>​<img src="https://nano-note.oss-cn-beijing.aliyuncs.com/images/image-20210904145152067.png" alt="">​</p> <h5 id="_1-server层"><a href="#_1-server层" class="header-anchor">#</a> 1.Server层</h5> <p><strong>Server 层主要包括连接器, 查询缓存, 分析器, 优化器, 执行器</strong>等, 所有<mark><strong>跨存储引擎</strong></mark>的功能都在这一层实现, 比如存储过程, 触发器, 视图, 内置函数等, 还有一个通用的<strong>日志模块 binlog 日志模块</strong>.</p> <p>总结一下: <strong>连接器用于身份权限校验; 分析器分析 SQL 语句要做什么; 优化器分析采用何种方案去执行语句; 执行器去执行语句</strong>.</p> <h6 id="_1-连接器"><a href="#_1-连接器" class="header-anchor">#</a> (1)连接器</h6> <p><strong>连接器用于与客户端建立连接, 并进行身份认证和权限校验等</strong>. 客户端要向 MySQL 发起通信都必须先跟 Server 端建立通信连接, 而建立连接的工作就是连接器完成的.</p> <p>连接器负责<strong>跟客户端建立连接, 获取权限, 维持和管理连接</strong>. 连接后如果用户名密码<strong>认证</strong>通过, 连接器会到权限表里面查出账户拥有的<strong>权限</strong>. 后面这个连接里面的权限判断逻辑都将依赖于此时读到的权限. 这意味着一个用户成功建立连接后, 即使用管理员账号对这个用户的权限做了修改, 也不会影响已经存在连接的权限. 修改完成后, 只有再新建连接才会使用新的权限设置.</p> <p>每个客户端连接都会在服务器进程中拥有一个<strong>线程</strong>, 这个连接的查询只会在这个<strong>单独的线程</strong>中执行, 该线程只能轮流在某个 CPU 中运行.</p> <p>客户端如果太长时间没动静, 连接器会自动断开连接. 这由参数 <strong>wait_timeout</strong> 控制, 默认为 8 小时. 建立连接的过程通常比较复杂, 所以建议尽量减少建立连接的动作, <strong>尽量使用长连接</strong>. 项目中应该使用<strong>数据库连接池</strong>来维护连接。</p> <h6 id="_2-查询缓存"><a href="#_2-查询缓存" class="header-anchor">#</a> (2)查询缓存</h6> <p>执行查询语句的时候, 会先查询缓存.</p> <p>之前执行过的语句及其结果可能会以 <strong>key-value</strong> 的形式被直接缓存在内存中. <strong>key 是查询的语句, value 是查询的结果</strong>. 如果当前查询能够直接在这个缓存中找到 key, 那么这个 value 就会被直接返回给客户端.</p> <p>MySQL8.0 版本已经<strong>删除</strong>了查询缓存模块, 因为收益并不大, 而且还需要一定的维护成本.</p> <blockquote><p>为什么删除查询缓存机制?</p></blockquote> <p>对于频繁更新的表, 查询缓存并不好.</p> <ul><li><strong>但查询缓存的失效非常频繁, 只要有对一个表有更新, 这个表上所有的查询缓存都会被清空，因此缓存都将失效</strong>.</li> <li><strong>缓存碎片, 内存不足都会造成缓存失效</strong>.</li> <li><strong>缓存全部在内存中, 容易造成内存资源紧张, MySQL 本来就十分需要内存</strong>. 且 SQL 语句有任何不同, 都会因为 Hash 不同而认为是不同的查询, 从而进行缓存.</li></ul> <h6 id="_3-分析器"><a href="#_3-分析器" class="header-anchor">#</a> (3)分析器</h6> <p><strong>分析器会分析 SQL 语句进行词法分析与语法分析，也就是判断 SQL 语句是什么并判断其要做什么</strong>.</p> <p>词法分析就是识别出 SQL 字符串的含义; 针对词法分析的结果, 词法分析器会根据语法规则判断输入的 SQL 语句语法是否合法. 如果输入的语句不对, 就会抛出 &quot;You have an error in your SQL syntax...&quot; 错误.</p> <p>MySQL 会解析查询, 并创建内部数据结构(解析树), 然后对其进行各种优化, 包括重写查询, 决定表的读取顺序, 以及选择合适的索引等. <strong>SQL 语句经过分析器分析之后, 会生成一颗语法树</strong>, 如下图所示.</p> <p>​<img src="https://nano-note.oss-cn-beijing.aliyuncs.com/images/image-20230315221642-cahwx26.png" alt="image">​</p> <h6 id="​​​-4-优化器"><a href="#​​​-4-优化器" class="header-anchor">#</a> ​​​(4)优化器</h6> <p><strong>优化器根据实际情况去判断并选择最优的方案去执行语句</strong>.</p> <p><strong>这里最优只是优化器觉得最优的方案, 实际执行时不一定是最优的</strong>. 优化器可以在表里面有多个索引的时候, 决定使用哪个索引; 或者在一个语句有多表关联(JOIN) 的时候, 决定各个表的连接顺序. 比如:</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> t1 <span class="token keyword">JOIN</span> t2 <span class="token keyword">USING</span><span class="token punctuation">(</span>ID<span class="token punctuation">)</span> <span class="token keyword">WHERE</span> t1<span class="token punctuation">.</span>c <span class="token operator">=</span> <span class="token number">10</span> <span class="token operator">AND</span> t2<span class="token punctuation">.</span>d <span class="token operator">=</span> <span class="token number">20</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><ul><li>可以先从表 t1 里面取出 c = 10 的记录的 ID 值, 再根据 ID 值关联表 t2, 再判断 t2 里面 d 的值是否等于 20.</li> <li>可以先从表 t2 里面取出 d = 20 的记录的 ID 值, 再根据 ID 值关联表 t1, 再判断 t1 里面 c 的值是否等于 10.</li></ul> <p>这两种执行方法的逻辑结果是一样的, 但执行的效率会有不同, 而优化器的作用就是决定选择使用哪种方案.</p> <p>用户可以通过特殊的关键字提示(hint)优化器, 影响它的决策过程. 也可以请求优化器解释(explain)优化过程的各个因素, 使用户可以知道服务器是如何进行优化决策的, 并提供一个参考基准, 便于用户重构查询和 schema, 修改相关配置, 使应用尽可能高效运行.</p> <h6 id="_5-执行器"><a href="#_5-执行器" class="header-anchor">#</a> (5)执行器</h6> <p><strong>执行器执行语句并从存储引擎返回数据</strong>.</p> <p>前面通过分析器知道 SQL 要做什么, 通过优化器知道了该怎么做, 于是就进入了执行器阶段, 开始执行语句.</p> <p>开始执行的时候, 要先判断一下用户对数据表<strong>有没有执行查询权限</strong>, 如果有权限则打开表继续执行. 打开表的时候, 执行器就会根据表的引擎定义, 去使用这个引擎提供的接口.</p> <p>比如查询:</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> T <span class="token keyword">WHERE</span> id <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>这里 ID 字段没有索引, 执行器的执行流程如下:</p> <ol><li>调用 InnoDB 引擎接口取这个表的第一行, 判断 ID 值是不是 10, 如果不是则跳过, 如果是则将这行存在结果集中;</li> <li>调用引擎接口取 &quot;下一行&quot;, 重复相同的判断逻辑, 直到取到这个表的最后一行.</li> <li>执行器将上述遍历过程中所有满足条件的行组成的记录集作为<strong>结果集</strong>返回给客户端.</li></ol> <p>数据库的慢查询日志中可以看到一个 <strong>rows_examined</strong> 的字段, 表示这个<strong>语句执行过程中扫描了多少行</strong>. 这个值就是在执行器每次调用引擎获取数据行的时候累加的. 有些场景下, 执行器调用一次, 在引擎内部则扫描了多行, 因此引擎扫描行数跟 rows_examined 并不是完全相同的.</p> <h5 id="_2-存储引擎层"><a href="#_2-存储引擎层" class="header-anchor">#</a> 2.存储引擎层</h5> <p><strong>存储引擎层主要负责数据的存储和读取</strong>, 采用可以替换的<strong>插件式架构</strong>, 支持 InnoDB, MyISAM, Memory 等多种存储引擎.</p> <h4 id="mysql存储引擎🌟"><a href="#mysql存储引擎🌟" class="header-anchor">#</a> MySQL存储引擎🌟</h4> <h5 id="_1-基础"><a href="#_1-基础" class="header-anchor">#</a> 1.基础</h5> <p>存储引擎就是数据库用于数据存储, 更新, 查询等操作的不同实现方式. MySQL 采用不同方式将数据存储在文件或内存中, 这些技术使用不同的<strong>存储机制, 索引技巧, 锁定水平</strong>以提供不同的功能和能力.</p> <p>查看 MySQL 提供的所有存储引擎.</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">SHOW</span> ENGINES<span class="token punctuation">;</span>
<span class="token keyword">SHOW</span> VARIABLES <span class="token operator">LIKE</span> <span class="token string">'%storage_engine%'</span><span class="token punctuation">;</span> <span class="token comment"># 查看默认引擎</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>结果如下图所示:</p> <p><img src="https://nano-note.oss-cn-beijing.aliyuncs.com/images/image-20210904140759531.png" alt="image-20210904140759531"></p> <p>MySQL 默认存储引擎是 <strong>InnoDB</strong>. 不同存储引擎有不同的功能特点及<strong>适用场景</strong>, 不同需求可以选择不同的存储引擎.</p> <h5 id="_2-myisam"><a href="#_2-myisam" class="header-anchor">#</a> 2.MyISAM</h5> <p>MyISAM 是 MySQL5.5 版本之前的默认存储引擎, <strong>不支持事务</strong>.</p> <p>不支持行级锁, 只能对整张表加锁, 读取时会对需要读到的所有表加共享锁, 写入时则对表加排它锁. 但在表有读取操作的同时, 也可以往表中插入新的记录, 这被称为并发插入(CONCURRENT INSERT).</p> <p>如果指定了 <strong>DELAY_KEY_WRITE</strong> 选项, 在每次修改执行完成时, <strong>不会立即</strong>将修改的索引数据写入磁盘, 而是会写到内存中的<strong>键缓冲区</strong>, 只有在清理键缓冲区或者关闭表的时候才会将对应的索引块写入磁盘. 这种方式可以极大的提升写入性能, 但是在数据库或者主机崩溃时会<strong>造成索引损坏</strong>, 需要执行<strong>修复操作</strong>. 可以手工或者自动执行检查和修复操作, 但是和事务恢复以及崩溃恢复不同, 可能导致一些<strong>数据丢失</strong>, 而且修复操作是非常慢的.</p> <p><strong>应用场景</strong>: 如果设计简单, 数据以<strong>紧密格式</strong>存储. <strong>对于只读数据, 或者表比较小, 可以容忍修复操作</strong>, 则依然可以使用它.</p> <p>其索引实现参考: MyISAM 索引实现.</p> <h5 id="_3-innodb"><a href="#_3-innodb" class="header-anchor">#</a> 3.InnoDB</h5> <p>InnoDB 是默认存储引擎, 是事务型存储引擎.</p> <p><strong>事务支持</strong>: InnoDB 采用 MVCC 来支持高并发, 并且实现了四个标准的隔离级别. 其默认级别是<strong>可重复读</strong>, 并且通过 next-key 锁 + MVCC 策略解决幻读问题.</p> <p><strong>索引</strong>: 主索引是<strong>聚簇索引</strong>, 在索引中保存了数据, 从而避免直接读取磁盘, 因此对查询性能有很大的提升.</p> <p>InnoDB 做了很多优化, 包括从磁盘读取数据时采用的可预测性读, 能够加快读操作并且自动创建的自适应哈希索引, 能够加速插入操作的插入缓冲区等.</p> <p><strong>应用场景</strong>: 可靠性要求较高或要求事务. 只有在需要它<strong>不支持</strong>的特性时, 才考虑使用其它存储引擎.</p> <blockquote><p>MyISAM与InnoDB的对比</p></blockquote> <ul><li><strong>事务</strong>: InnoDB 支持事务, MyISAM 不支持事务.</li> <li><strong>锁的粒度</strong>: MyISAM 只支持表锁, InnoDB 支持<strong>表锁与行锁</strong>. InnoDB 在应对高并发事务上使用 MVCC 比单纯的加锁更高效.</li> <li><strong>外键</strong>: InnoDB 支持外键; 而 MyISAM 不支持外键.</li> <li><strong>备份</strong>: InnoDB 支持<strong>在线热备份</strong>.</li> <li><strong>崩溃恢复</strong>: MyISAM 崩溃后发生损坏的概率比 InnoDB 高很多, 且恢复的速度也更慢; InnoDB 崩溃之后恢复更加容易.</li> <li><strong>其它特性</strong>: MyISAM 支持压缩表和空间数据索引.</li></ul> <p>《MySQL 高性能》: 不要轻易相信 &quot;MyISAM 比 InnoDB 快&quot; 之类的经验之谈, 这个结论往往不是绝对的. 在很多已知场景中, InnoDB 的速度都能让 MyISAM 望尘莫及, 尤其是用到了聚簇索引, 或者需要访问的数据都可以放入内存的应用. 所以<strong>一般情况下选择 InnoDB 都是没有问题</strong>的. 如果并不在乎可扩展能力和并发能力, 也不需要事务支持以及崩溃后的安全恢复问题, 也可以选择 MyISAM.</p> <blockquote><p>如何选择存储引擎?</p></blockquote> <p><strong>根据具体的应用场景选择:</strong> <strong><strong>综合考虑是否需要事务, 是否可以热备份, 崩溃恢复, 存储引擎的特有特性等. 注意不要混合使用存储引擎</strong></strong>. 一般使用 InnoDB 就行了.</p> <h5 id="_4-其他存储引擎"><a href="#_4-其他存储引擎" class="header-anchor">#</a> 4.其他存储引擎</h5> <h6 id="_1-archive"><a href="#_1-archive" class="header-anchor">#</a> (1)Archive</h6> <p><strong>特性</strong>: 对表数据进行压缩, 磁盘 I/O 更少, 数据存储在 ARZ 为后缀的文件中(表文件为 <strong>a.arz, a.frm</strong>), 只支持 INSERT 和 SELECT 操作(不可以 DELETE 和 UPDATE), 只允许在自增 ID 列上加索引.</p> <p><strong>应用场景</strong>: 日志和数据采集类应用.</p> <h6 id="_2-memory"><a href="#_2-memory" class="header-anchor">#</a> (2)Memory</h6> <p><strong>特性</strong>: 数据保存在内存中, 所以数据库重启后会导致数据丢失. 支持 HASH 索引(等值查找应选择 HASH)和 BTree 索引(范围查找应选择), 所有字段都为固定长度, Memory 存储使用表级锁.</p> <p><strong>应用场景</strong>: 用于查找或是映射表, 例如用于保存数据分析中产生的中间表, 用于缓存周期性聚合数据的结果表等. Memory 数据易丢失, 所以要求数据可再生.</p> <h4 id="sql语句执行流程🌟"><a href="#sql语句执行流程🌟" class="header-anchor">#</a> SQL语句执行流程🌟</h4> <p>SQL 语句一般可以分为<strong>查询与更新</strong>(增加, 更新, 删除)两类.</p> <p>整体流程(与 MySQL架构 的顺序基本一致)如下:</p> <ul><li>客户端发送一条查询语句给服务器.</li> <li>服务器先检查查询缓存, 如果命中了缓存, 则立刻返回存储在缓存中的结果. 否则进入下一阶段.</li> <li>服务器端进行 SQL 解析, 预处理, 再由<strong>优化器</strong>生成对应的执行计划.</li> <li>MySQL 根据优化器生成的执行计划, 调用存储引擎的 API 来执行查询.</li> <li>将结果返回给客户端.</li></ul> <h5 id="_1-客户端发送执行请求"><a href="#_1-客户端发送执行请求" class="header-anchor">#</a> 1.客户端发送执行请求</h5> <p>MySQL 客户端和服务器之间的通信协议是 &quot;<strong>半双工</strong>&quot; 的, 这意味着在任何一个时刻, 要么是由服务器向客户端发送数据, 要么是由客户端向服务器发送数据, 这两个动作不能同时发生. 所以无法也无须将一个消息切成小块独立来发送. 这种协议让 MySQL 通信简单快速, 但也从很多地方限制了 MySQL. 一个明显的限制是, 这意味着没法进行流量控制. 一旦一端开始发生消息, 另一端要接收完整个消息才能响应它. 客户端用一个单独的数据包将查询传给服务器. 这也是为什么当查询的语句很长的时候, 参数 <code>max_allowed_packet</code>​ 就特别重要了. <strong>一旦客户端发送了请求, 它能做的事情就只是等待结果了. 一般服务器响应给用户的数据通常很多, 由多个数据包组成. 当服务器开始响应客户端请求时, 客户端必须完整地接收整个返回结果, 而不能简单地只取前面几条结果, 然后让服务器停止发送数据</strong>.</p> <h5 id="_2-查询语句执行流程"><a href="#_2-查询语句执行流程" class="header-anchor">#</a> 2.查询语句执行流程</h5> <p>先分析下查询语句, 语句如下:</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> tb_student A <span class="token keyword">WHERE</span> A<span class="token punctuation">.</span>age <span class="token operator">=</span> <span class="token string">'18'</span> <span class="token operator">AND</span> A<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">'Jack'</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>参考 MySQL 架构分析下这个语句的执行流程如下.</p> <h6 id="_1-查询权限"><a href="#_1-查询权限" class="header-anchor">#</a> (1)查询权限</h6> <p>先检查该语句是<strong>否有权限</strong>, 如果没有则直接返回错误信息.</p> <h6 id="_2-查询缓存-2"><a href="#_2-查询缓存-2" class="header-anchor">#</a> (2)查询缓存</h6> <p>如果有权限则计算这条 SQL 语句的 Hash 并以之为 key 在内存中查询是否缓存有结果, 当查询命中该缓存, MySQL会立刻返回结果, 跳过了解析, 优化和执行阶段, 如果没有, 执行下一步.</p> <p>注意新版已经去掉了查询缓存机制.</p> <h6 id="_3-词法分析与语法检查"><a href="#_3-词法分析与语法检查" class="header-anchor">#</a> (3)词法分析与语法检查</h6> <p><strong>MySQL 通过关键字将 SQL 语句进行解析, 并生成一棵对应的 &quot;解析树&quot;. MySQL 解析器将使用 MySQL 语法规则验证和解析查询. 例如, 它将验证是否使用错误的关键字, 或者使用关键字的顺序是否正确等, 再或者它还会验证引号是否能前后正确匹配</strong>.</p> <p>通过分析器进行词法分析并分析是否有语法错误, 提取 SQL 语句的<strong>关键元素</strong>, 并生成一棵对应的 &quot;解析树&quot;. 比如提取上面这个语句是查询 SELECT, 提取需要查询的表名为 tb_student, 需要查询所有的列, 查询条件是这个表的 id = '1'.</p> <p>预处理器则根据一些 MySQL 规则进一步检查解析树是否合法, 例如这里将检查数据表和数据列是否存在, 还会解析名字和别名, 看看它们是否有歧义.</p> <h6 id="_4-优化器确定执行方案"><a href="#_4-优化器确定执行方案" class="header-anchor">#</a> (4)优化器确定执行方案</h6> <blockquote><p>生成执行计划</p></blockquote> <p>现在语法树被认为是合法的了, 并且由优化器将其转化成<strong>执行计划</strong>.</p> <p>和很多其他关系数据库不同, MySQL 并不会生成查询字节码来执行查询. MySQL 生成查询的一棵<strong>指令树</strong>, 然后通过存储引擎执行完成这棵指令树并返回结果. 最终的执行计划包含了重构查询的全部信息.</p> <blockquote><p>基于成本的执行计划选择策略</p></blockquote> <p><strong>一条查询可以有很多种执行计划, 最后都返回相同的结果. 优化器的作用就是找到这其中最好的执行计划</strong>. <mark><strong>MySQL 使用基于成本的优化器, 它将尝试预测一个查询使用某种执行计划时的成本, 并选择其中成本最小的一个</strong></mark>.</p> <p>最初, 成本的最小单位是随机读取一个 4K 数据页的成本, 后来成本计算公式变得更加复杂, 并且引入了一些 &quot;因子&quot; 来估算某些操作的代价, 如通过各种<strong>统计信息</strong>来计算: 每个表或者索引的页面个数, 索引的基数(索引中不同值的数量), 索引和数据行的长度, 索引分布情况. <strong>这些统计信息是通过存储引擎获取的</strong>.</p> <p>例如上述 SQL 语句可以有两种执行方案: (1) 先查询学生表中姓名为 &quot;Jack&quot; 的学生, 然后判断是否年龄是 18. (2) 先找出学生中年龄 18 岁的学生, 然后再查询姓名为 &quot;Jack&quot; 的学生. 优化器会根据<strong>自己的优化算法</strong>进行选择执行效率最好的一个方案(优化器的决定有时候不一定最好).</p> <p>确定执行计划后就准备开始执行.</p> <blockquote><p>优化策略</p></blockquote> <p>MySQL 的查询优化器是一个非常复杂的部件, 它使用了很多优化策略来<strong>生成一个最优的执行计划</strong>. 优化策略可以简单地分为两种, 一种是<strong>静态优化</strong>, 一种是<strong>动态优化</strong>.</p> <p><strong>静态优化</strong>可以直接对解析树进行分析, 并完成优化. 例如优化器可以通过一些简单的代数变换将 WHERE 条件转换成另一种等价形式. 静态优化不依赖于特别的数值, 如 WHERE 条件中带入的一些常数等. <strong>静态优化在第一次完成后就一直有效</strong>, 即使使用不同的参数重复执行查询也不会发生变化. 可以认为这是一种 &quot;编译时优化&quot;.</p> <p><strong>动态优化</strong>则和查询的上下文有关, 也可能和很多其他因素有关, 例如 WHERE 条件中的取值, 索引中条目对应的数据行数等. 这需要在每次查询的时候都重新评估, 可以认为这是 &quot;运行时优化&quot;.</p> <p>在执行语句和存储过程的时候, 动态优化和静态优化的区别非常重要. <strong>MySQL 对查询的静态优化只需要做一次, 但对查询的动态优化则在每次执行时都需要重新评估</strong>. 有时候甚至在查询的执行过程中也会重新优化.</p> <p>下面是一些 MySQL 能够处理的优化类型:</p> <ul><li>重新定义关联表的顺序.</li> <li>将外连接转化成内连接.</li> <li>使用等价变换规则. 比如比较符号的变换.</li> <li>覆盖索引扫描.</li> <li>提前终止查询.</li></ul> <blockquote><p>数据与索引的统计信息</p></blockquote> <p><strong>MySQL 通过统计信息来计算执行计划的成本进而选择合适的执行计划. 统计信息由存储引擎实现, 不同的存储引擎可能会存储不同的统计信息(也可以按照不同的格式存储统计信息)</strong> .</p> <p>因为服务器层没有任何统计信息, 所以 MySQL 查询优化器在生成查询的执行计划时, 需要向存储引擎获取相应的统计信息. 存储引擎则提供给优化器对应的统计信息, 包括: 每个表或者索引有多少个页面, 每个表的每个索引的基数是多少, 数据行和索引长度, 索引的分布信息等. <strong>优化器根据这些信息来选择一个最优的执行计划</strong>.</p> <blockquote><p>优化器选择错误的原因</p></blockquote> <p>有很多种原因会导致 MySQL 优化器<strong>选择错误的执行计划</strong>, 如下所示:</p> <ul><li><strong>统计信息不准确</strong>. MySQL 依赖存储引擎提供的统计信息来评估成本, 但有的存储引擎提供的信息是准确的, 有的偏差可能非常大. 例如, InnoDB 因为其 MVCC 的架构, 并不能维护一个数据表的行数的精确统计信息.</li> <li><strong>执行计划中的成本估算不等同于实际执行的成本</strong>. 所以即使统计信息精准, 优化器给出的执行计划也可能不是最优的. 例如<strong>有时候某个执行计划虽然需要读取更多的页面, 但是它的成本却更小</strong>. 因为如果这些页面都是顺序读或者这些页面都已经在内存中的话, 那么它的访问成本将很小. MySQL 层面并不知道哪些页面在内存中, 哪些在磁盘上, 所以查询实际执行过程中到底需要多少次物理 I/O 是无法得知的.</li> <li><strong>MySQL 的最优可能和你想的最优不一样</strong>. 你可能希望执行时间尽可能的短, 但 MySQL 只是基于其成本模型选择最优的执行计划, 而有些时候这并不是最快的执行方式. 所以根据执行成本来选择执行计划并不是完美的模型.</li> <li><strong>MySQL 从不考虑其他并发执行的查询</strong>, 这可能会影响到当前查询的速度.</li> <li><strong>MySQL 也并不是任何时候都是基于成本的优化</strong>. 有时也会基于一些固定的规则, 例如如果存在全文搜索的 MATCH() 子句, 则在存在全文索引的时候就使用全文索引. 即使有时候使用别的索引和 WHERE 条件可以远比这种方式要快, MySQL 也仍然会使用对应的全文索引.</li></ul> <blockquote><p>查询优化器的提示(hint)</p></blockquote> <p>如果对优化器选择的执行计划不满意, 可以<strong>使用优化器提供的几个提示(hint)来控制最终的执行计划</strong>. 常见的提示如下.</p> <ul><li><strong>USE INDEX, IGNORE INDEX 和 FORCE INDEX</strong>. 这几个提示会告诉优化器使用或不使用哪些索引来查询记录(例如在决定关联顺序的时候使用哪个索引). 在 MyQL 5.1 和之后的版本可以通过新增选项 FOR ORDER BY 和 FOR GROUP BY 来指定是否对排序和分组有效. FORCE INDEX 和 USE INDEX 基本相同, 除了一点: <strong>FORCE INDEX 会告诉优化器全表扫描的成本会远远高于索引扫描, 哪怕实际上该索引用处不大</strong>. 当发现优化器选择了错误的索引, 或者因为某些原因(比如在不使用 ORDER BY 的时候希望结果有序)要使用另一个索引时, 可以使用该提示.</li> <li><strong>FOR UPDATE 和 LOCK IN SHARE MODE</strong>. 这也不是真正的优化器提示. 这两个提示主要<strong>控制 SELECT 语句的锁机制, 但只对实现了行级锁的存储引擎有效</strong>. 使用该提示会<strong>对符合查询条件的数据行加锁</strong>. 这两个提示经常被滥用, 很容易造成服务器的锁争用问题. 应<mark><strong>避免使用</strong></mark>这个. (参考: 共享锁与排他锁(读写锁))</li></ul> <h6 id="_5-执行查询并返回结果"><a href="#_5-执行查询并返回结果" class="header-anchor">#</a> (5)执行查询并返回结果</h6> <p>在解析和优化阶段, MySQL 将生成查询对应的执行计划, MySQL 的查询执行引擎则根据这个执行计划来完成整个查询. 这里执行计划是一个数据结构, 而不是和很多其他的关系型数据库那样会生成对应的字节码.</p> <p>MySQL 只是简单地根据执行计划给出的指令<strong>逐步执行</strong>. 在根据执行计划逐步执行的过程中, 有大量的操作需要通过调用存储引擎实现的接口来完成, 这些接口称为 &quot;handler API&quot; 接口.</p> <p>最后将查询结果返回给客户端.</p> <h5 id="_3-更新语句执行流程"><a href="#_3-更新语句执行流程" class="header-anchor">#</a> 3.更新语句执行流程</h5> <p>接下来看看更新语句如何执行, 示例 SQL 语句如下:</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">UPDATE</span> tb_student A <span class="token keyword">SET</span> A<span class="token punctuation">.</span>age <span class="token operator">=</span> <span class="token string">'19'</span> <span class="token keyword">WHERE</span> A<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">'Jack'</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>这条语句与之前查询的流程类似, 只不过执行<strong>更新需要进行日志记录</strong>. 这就引入了日志模块, MySQL 自带的<strong>日志模块是 binlog(归档日志)</strong> , 所有的存储引擎都可以使用, <strong>常用的 InnoDB 引擎</strong>还自带了一个日志模块 <strong>redo log(重做日志) 和 undo log(回滚日志)</strong> .</p> <p>下面分析这个语句的执行流程, 大体流程如下:</p> <ul><li>先查询到 Jack 这条数据.</li> <li><strong>然后拿到查询语句, 把 age 改为 19, 然后调用引擎 API 接口, 写入这一行数据, InnoDB 引擎把数据保存在内存中, 同时记录 redo log, 此时 redo log 进入 prepare 状态, 然后告诉执行器, 执行完成了随时可以提交</strong>.</li> <li><strong>执行器收到通知后记录 binlog, 然后调用引擎接口, 提交 redo log 并且状态改为提交状态, 更新完成</strong>.</li></ul> <p>数据更新的详细流程如下:</p> <p>​<img src="https://nano-note.oss-cn-beijing.aliyuncs.com/images/%E5%9B%BE%E7%81%B5-MySQL%E6%89%A7%E8%A1%8C%E8%BF%87%E7%A8%8B%E4%B8%8EInnoDB%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86-20250223101634-rq6njmc.png" alt="图灵-MySQL执行过程与InnoDB底层原理">​</p> <p>整体流程如下:</p> <ol><li>当需要<strong>更新的数据不在 Buffer Pool 缓存池的时候, 会从磁盘中把整页数据都加载到缓存池内存中</strong>.</li> <li><strong>将旧的数据值(name=Lucy)写入到</strong> <mark><strong>undo 回滚日志中, 便于后续回滚</strong></mark>​ <strong>. 如果事务提交失败要回滚数据, 可以用 undo 日志里的数据恢复 buffer pool 里面的缓存数据</strong>.</li> <li><strong>执行器更新内存数据</strong>, 即 name=Jack.</li> <li><strong>更新信息写入到 redo log buffer 缓冲区</strong>中.</li> <li><strong>redo 日志顺序写入磁盘, 准备提交事务(prepare阶段)</strong> .</li> <li><strong>准备提交事务, 将 binlog 日志写入磁盘</strong>.</li> <li>写入 commit 标记到 redo 日志文件里, <strong>此时事务提交完成</strong>. 该标记为了保证事务提交后 redo 与 binlog 数据一致. 到这里可以告知客户端事务已经提交完成. 这里 redo 日志文件记录了哪些位置的什么数据做了哪些修改, 由于 redo 日志具有<strong>顺序写</strong>的特点, 所以写入是很快的, 因此<mark><strong>修改记录到 redo 日志中即可认为事务已经完成</strong></mark>. 这比每次都直接去修改磁盘上的 ibd 文件要快.</li> <li><strong>在系统空闲的时候将修改随机写入磁盘进行持久化, 以 page 为单位写入</strong>. 完成后实现磁盘中的数据更新. 如果事务提交成功, buffer pool 里的数据还没来得及写入磁盘的时候系统宕机了, 可以用 redo 日志的数据<strong>恢复磁盘 ibd 文件里面的数据</strong>. 也就是 buffer pool 里面的数据还没持久化到磁盘文件中, 但是 redo log 中记录了哪些数据做了哪些修改, 因此当系统恢复的时候, 可以先根据 redo log 对数据进行磁盘中的数据重做, 让其与 redo log 中的数据状态保持一致, 也就是实现数据的持久化. <strong>这个过程其实就是 &quot;重做&quot;, 或者 &quot;重放&quot;, 也就是 redo 的含义</strong>.</li></ol> <p>一个简要的流程图如下：</p> <p>​<img src="/img/%E5%9B%BE%E7%81%B5-MySQL%E6%89%A7%E8%A1%8C%E8%BF%87%E7%A8%8B%E4%B8%8EInnoDB%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86%201-20250223102245-5jbbcw3.png" alt="图灵-MySQL执行过程与InnoDB底层原理 1">​</p> <p>更新语句默认都是会自动提交事务，因此更新的执行流程也可以看做是<mark><strong>事务的执行流程</strong></mark>.</p> <blockquote><p>更新流程总结</p></blockquote> <p>整个过程，其实是把数据直接在内存中更新，这样后面其他事务马上就能使用数据了。同时把更新操作记录到三个日志中：</p> <ul><li><strong>undo log</strong>: 回滚日志。记录修改之前的数据，如果遇到事务回滚就能基于此回滚内存中的数据。</li> <li><strong>redo log</strong>: 重做日志。由于对数据的修改是先放到内存中的，这个属于缓存，需要定时刷新到磁盘才算完全持久化。如果内存数据还没刷盘服务器就挂了，之前更新到内存的数据就丢失了。系统恢复时可以用 redo log 进行重做，进行数据恢复。</li> <li><strong>binlog</strong>: 二进制日志。这是服务器层的日志，记录了本次执行的 SQL 语句或者修改的数据是啥(对应不同的日志格式)。如果数据库的数据不小心被删除了(比如删库跑路)，就可以用此文件恢复数据。</li></ul> <blockquote><p>为什么MySQL不能直接更新磁盘上的数据而设置这么一套复杂的机制来执行SQL?</p></blockquote> <p>因为如果来一个请求就直接对磁盘文件进行随机读写, 然后更新磁盘文件里的数据性能可能相当差. 磁盘随机读写的性能是非常差的, 所以<strong>直接更新磁盘文件是不能让数据库抗住很高并发的</strong>. MySQL 这套机制看起来复杂, 但它可以<strong>保证每个更新请求都是更新内存 Buffer Pool, 然后顺序写日志文件, 同时还能保证各种异常情况下的数据一致性</strong>. 更新内存的性能是极高的, 然后顺序写磁盘上的日志文件的性能也是非常高的, 要远高于随机读写磁盘文件. 正是通过这套机制, 才能让 MySQL 数据库在较高配置的机器上每秒可以抗下几干甚至上万的读写请求.</p> <blockquote><p>为什么要用两个日志模块, 用一个日志模块不行吗?</p></blockquote> <p>这是因为最开始 MySQL 默认存储引擎是 MyISAM, 但 <strong>redo log 是 InnoDB 引擎独有的</strong>, 这就导致会<strong>没有 crash-safe 的能力</strong>(即使数据库发生<strong>异常重启</strong>, 之前提交的记录都不会丢失), <strong>binlog 日志只能用来归档</strong>.</p> <p>并不是说只用一个日志模块不可以, <strong>只是 InnoDB 引擎就是通过 redo log 来支持事务</strong>. 那么用两个日志模块, 但是不要这么复杂行不行, 为什么 redo log 要引入 prepare 预提交状态? 这里用<strong>反证法</strong>来说明下为什么要这么做.</p> <ul><li><strong>先写 redo log 直接提交, 然后写 binlog</strong>. 假设写完 redo log 后机器挂了, binlog 日志没有被写入, 那么机器重启后, 这台机器会通过 redo log 恢复数据, 但是这个时候 binlog 并没有记录该数据, 后续进行机器备份的时候, 就会丢失这一条数据, 同时主从同步也会<strong>丢失</strong>这一条数据.</li> <li><strong>先写 binlog, 然后写 redo log</strong>. 假设写完了 binlog, 机器异常重启了, 由于没有 redo log, 本机是无法恢复这一条记录的, 但是 binlog 又有记录, 那么和上面同样的道理, 就会<strong>产生数据不一致</strong>的情况.</li></ul> <p>如果<strong>采用 redo log 两阶段提交</strong>的方式就不一样了, <strong>写完 binglog 后, 然后再提交 redo log</strong> 就会防止出现上述的问题, 从而保证了数据一致性.</p> <p>那么问题来了, 有没有一个极端的情况呢? 假设 redo log 处于预提交状态, binglog 也已经写完了, 这个时候发生了异常重启会怎么样呢?  这个就要依赖于 MySQL 的<strong>处理机制</strong>了, MySQL 的处理过程如下:</p> <ul><li><strong>判断 redo log 是否完整, 如果判断是完整的就立即提交.</strong></li> <li><strong>如果 redo log 只是预提交但不是 commit 状态, 这个时候就会去判断 binlog 是否完整, 如果完整就提交 redo log, 不完整就回滚事务</strong>.</li></ul> <p>这样就解决了<strong>数据一致性</strong>问题.</p> <h4 id="回滚日志-undo-log-🌟"><a href="#回滚日志-undo-log-🌟" class="header-anchor">#</a> 回滚日志(undo log)🌟</h4> <h5 id="_1-基础-2"><a href="#_1-基础-2" class="header-anchor">#</a> 1.基础</h5> <p>undo log 叫做<strong>回滚日志</strong>, 在事务执行变更操作之前需要先将相反的操作写入 undo log, 通过它可以<strong>进行事务回滚操作, undo log 也是实现 MVCC 的基础</strong>.</p> <blockquote><p>写入时机</p></blockquote> <p>回滚日志是在<strong>更新内存数据之前</strong>写入的，更新内存数据时回滚日志已经持久化到磁盘上了。这样就保证了即使遇到数据库突然宕机导致内存中缓存的更新数据丢失了, 当用户再次启动数据库的时候, 数据库还能够通过<strong>回滚日志</strong>来回滚之前未完成的事务.</p> <p>如果想要保证事务的<strong>原子性</strong>, 就需要在异常发生时, 对已经执行的操作进行<strong>回滚</strong>, 而恢复机制就是通过 <strong>回滚日志(undo log)</strong>  实现的, 所有事务进行的修改都会<strong>先记录到这个回滚日志中</strong>, <strong>然后再执行相关的操作</strong>. 如果执行过程中遇到异常的话, 可以直接利用<strong>回滚日志</strong>中的信息将数据<strong>回滚</strong>到修改之前的样子就行!</p> <p>​<img src="https://nano-note.oss-cn-beijing.aliyuncs.com/images/image-20250223102524-g7v1lu8.png" alt="image">​</p> <blockquote><p>回滚日志的作用</p></blockquote> <p>回滚日志作用：</p> <ul><li><strong>回滚</strong>：记录事务的修改，可以实现事务的回滚。这可以实现事务的原子性。</li> <li><strong>实现 MVCC</strong>：MVCC 使用到的快照数据存储在 undo log(回滚日志)中, 该日志通过回滚指针把一个数据行(Record) 的所有快照连接起来, 这样数据就可以有多个版本。</li></ul> <blockquote><p>回滚段</p></blockquote> <p>InnoDB 对 <strong>undo log 文件</strong>的管理采用段的方式, 也就是<strong>回滚段</strong>(rollback segment). 每个回滚段记录了 1024 个 undo log segment, 每个事务只会使用一个 undo log segment.</p> <p>在 MySQL5.5 的时候, 只有一个回滚段, 那么最大同时支持的事务数量为 1024 个. 在 MySQL 5.6 开始, InnoDB 支持最大 128 个回滚段, 故其支持<strong>同时在线的事务限制提高到了 128 * 1024</strong>.</p> <h5 id="_2-回滚日志相关参数"><a href="#_2-回滚日志相关参数" class="header-anchor">#</a> 2.回滚日志相关参数</h5> <ul><li>innodb_undo_directory: 设置 undo log 文件所在的路径. 该参数的默认值为 &quot;./&quot;, 即 InnoDB 数据文件存储位置, 目录下 ibdata1 文件就是 undo log 存储的位置.</li> <li><strong>innodb_undo_logs</strong>: 设置 undo log 文件内部回滚段的个数, 默认值为 128. YFD 设置值为 128.</li> <li>innodb_undo_tablespaces: 设置 undo log 文件的数量, 这样回滚段可以较为平均地分布在多个文件中. 设置该参数后, 会在路径 innodb_undo_directory 看到以 undo 为前缀的文件.</li></ul> <h5 id="_3-日志删除时机"><a href="#_3-日志删除时机" class="header-anchor">#</a> 3.日志删除时机</h5> <p>回滚日志不需要一直存储着，因为事务提交之后一般就用不着回滚了，删除的时机如下：</p> <ul><li><strong>新增类型的, 在事务提交之后就可以删除了</strong>.</li> <li><strong>修改类型的, 事务提交之后不能立即删除, 这些日志会用于 MVCC, 只有当没有事务用到该版本信息时才可以删除</strong>.</li></ul> <h4 id="重做日志-redo-log-🌟"><a href="#重做日志-redo-log-🌟" class="header-anchor">#</a> 重做日志(redo log)🌟</h4> <h5 id="_1-基础-3"><a href="#_1-基础-3" class="header-anchor">#</a> 1.基础</h5> <p>重做日志(redo log) 也叫<strong>事务日志</strong>, 可以帮助提高事务的效率.</p> <blockquote><p>写入时机</p></blockquote> <p>在数据更新的流程中，涉及写入重做日志的操作如下：</p> <p>​<img src="https://nano-note.oss-cn-beijing.aliyuncs.com/images/%E5%9B%BE%E7%81%B5-MySQL%E6%89%A7%E8%A1%8C%E8%BF%87%E7%A8%8B%E4%B8%8EInnoDB%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86%20(3).png" alt="">​</p> <p>在修改完内存缓存池的数据之后，就开始写入重做日志，等后面写入 binlog 之后，还会在重做日志中写入事务提交完成的标记。</p> <h5 id="_2-重做-事务-日志的作用"><a href="#_2-重做-事务-日志的作用" class="header-anchor">#</a> 2.重做(事务)日志的作用</h5> <p>重做(事务)日志的作用如下：</p> <ul><li><strong>提升事务提交的性能</strong>。因为日志中已经记录了事务, 就无须在每个事务提交时把缓冲池的脏块刷新(flush)到磁盘中。</li> <li><strong>提供数据库异常启动后数据修复的 crash safe 能力</strong>。</li></ul> <blockquote><p>提升事务提交性能</p></blockquote> <p><strong>使用事务日志, 存储引擎在修改表的数据时只需要修改其内存拷贝, 再把该修改行为记录到持久在硬盘上的事务日志中, 而不用每次都将修改的数据本身持久到磁盘.</strong></p> <p><strong>InnoDB 使用日志来减少提交事务时的开销. 因为日志中已经记录了事务, 就无须在每个事务提交时把缓冲池的脏块刷新(flush)到磁盘中</strong>. 事务修改的数据和索引通常会映射到表空间的随机位置, 所以刷新这些变更到磁盘需要很多随机 I/O. InnoDB 假设使用的是常规磁盘(机械磁盘), 随机 I/O 比顺序 I/O 要昂贵得多, 因为一个 I/O 请求需要时间把磁头移到正确的位置, 然后等待磁盘上读出需要的部分, 再转到开始位置.</p> <p><strong>事务日志采用的是追加的方式, 因此写日志的操作是磁盘上一小块区域内的顺序 I/O, 而不像随机 I/O 需要在磁盘的多个地方移动磁头, 所以采用事务日志的方式相对来说要快得多. 事务日志持久以后, 内存中被修改的数据在后台可以慢慢地刷回到磁盘. 目前大多数存储引擎都是这样实现的, 这称之为预写式日志(Write-Ahead Logging), 修改数据需要写两次磁盘</strong>.</p> <blockquote><p>提供crash safe能力</p></blockquote> <p><mark><strong>InnoDB 用日志把随机 I/O 变成顺序 I/O. 一旦日志安全写到磁盘, 事务就持久化了, 即使变更还没写到数据文件. 如果一些糟糕的事情发生了(例如断电了), InnoDB 可以重放日志并且恢复已经提交的事务</strong></mark>.</p> <p><strong>如果数据的修改已经记录到事务日志并持久化, 但数据本身还没有写回磁盘, 此时系统崩溃, 存储引擎在重启时能够自动恢复这部分修改的数据</strong>. 具体的恢复方式则视存储引擎而定.</p> <p>最开始 MySQL 里自带的引擎是 MyISAM, 但 MyISAM 没有 crash-safe 的能力, binlog 日志只能用于<strong>归档</strong>. 而 InnoDB 是另一个公司以插件形式引入 MySQL 的, 既然只依靠 binlog 是没有 crash-safe 能力的, 所以 InnoDB 使用了另外一套日志系统, 也就是事务日志来实现 crash-safe 能力. <strong>有了事务日志, InnoDB 就可以保证即使数据库发生异常重启, 之前提交的记录都不会丢失, 这个能力就称为</strong> <mark><strong>crash-safe</strong></mark>.</p> <h5 id="_3-缓冲区写入磁盘机制"><a href="#_3-缓冲区写入磁盘机制" class="header-anchor">#</a> 3.缓冲区写入磁盘机制</h5> <h6 id="基础"><a href="#基础" class="header-anchor">#</a> 基础</h6> <p><strong>日志缓冲必须被刷新到持久化存储, 以确保提交的事务完全被持久化了</strong>. 了解清楚 &quot;把日志缓冲写到日志文件&quot; 和 &quot;把日志刷新到持久化存储&quot; 之间的不同是很重要的. <strong>在大部分操作系统中, 把缓冲写到日志只是简单地把数据从 InnoDB 的内存缓冲转移到了操作系统的缓存, 也是在内存里, 并没有真的把数据写到了持久化存储</strong>.</p> <p><mark><strong>当 InnoDB 变更任何数据时, 会写一条变更记录到内存日志缓冲区. 在缓冲满的时候, 事务提交的时候, 或者每一秒钟, InnoDB 都会刷写缓冲区的内容到磁盘日志文件---无论上述三个条件哪个先达到</strong></mark>.</p> <p>流程如下，其实就是先写到 redo log buffer，然后写到操作系统的 Page Cache，最后再由操作系统刷盘存储到磁盘上的重做日志文件中。</p> <p>​<img src="/img/image-20250223122654-z3yszq8.png" alt="image">​</p> <p>如果有大事务, 增加日志缓冲区(默认 1MB)大小可以帮助减少 I/O. 变量 innodb_log_buffer_size 可以控制日志缓冲区的大小. <strong>通常不需要把日志缓冲区设置得非常大</strong>. 推荐的范围是 1MB～8MB, 一般来说足够了, 除非要写很多相当大的 BLOB 记录. 相对于 InnoDB 的普通数据, 日志条目是非常紧凑的. 它们不是基于页的, 所以不会浪费空间来一次存储整个页. InnoDB 也使得日志条目尽可能地短.</p> <h6 id="环式写磁盘"><a href="#环式写磁盘" class="header-anchor">#</a> 环式写磁盘</h6> <p>InnoDB 最后还是必须把变更写到数据文件, 因为日志有固定的大小. InnoDB 的日志是<strong>环形方式</strong>写的: 当写到日志的尾部, 会重新跳转到开头继续写, 但不会覆盖还没应用到数据文件的日志记录, 因为这样做会清掉已提交事务的唯一持久化记录.</p> <p><strong>InnoDB 使用多个文件作为一组循环日志(如下图所示)</strong> . 通常不需要修改默认的日志数量, 只修改每个日志文件的大小即可. 要修改日志文件大小, 需要完全关闭 MySQL, 将旧的日志文件移到其他地方保存, 重新配置参数, 然后重启. 一定要确保 MySQL 干净地关闭了, 或者还有日志文件可以保证需要应用到数据文件的事务记录, 否则数据库就无法恢复了! 当重启服务器的时候, 查看 MySQL 的错误日志. 在重启成功之后, 才可以删除旧的日志文件.</p> <p>在有<strong>多个 redo log 日志文件</strong>的情况下, redo log 会对某个文件从头开始写, 写完一个文件继续写另一个文件, 写到最后一个文件末尾就又回到第一个文件开头循环写, 如下面这个图所示.</p> <p>​<img src="https://nano-note.oss-cn-beijing.aliyuncs.com/images/20230319185252.png" alt="">​</p> <p>write pos 是<strong>当前记录的位置</strong>, 一边写一边后移, 写到第 3 号文件末尾后就回到 0 号文件开头.</p> <p>checkpoint 是<strong>当前要擦除的位置</strong>, 也是往后推移并且循环的, 擦除记录前要把记录更新到数据文件里.</p> <p>write pos 和 checkpoint 之间的部分就是空着的<strong>可写部分</strong>, 可以用来记录新的操作. 如果 write pos 追上 checkpoint, 表示 redo log 写满了, 这时候不能再执行新的更新, 得停下来先擦掉一些记录, 也就是<strong>把一部分数据持久化到 ibd 磁盘文件中</strong>, 把 checkpoint 推进一下.</p> <p>整体的<strong>日志文件大小受控于 innodb_log_file_size 和 innodb_log_files_in_group 两个参数</strong>, 这对写性能非常重要. 日志文件的总大小是每个文件的大小之和. 默认情况下, 只有两个 5MB 的文件, 总共 10MB. 对高性能工作来说这太小了. <strong>至少需要几百 MB, 或者甚至上 GB 的日志文件</strong>.</p> <h6 id="刷盘策略与innodb-flush-log-at-trx-commit参数"><a href="#刷盘策略与innodb-flush-log-at-trx-commit参数" class="header-anchor">#</a> 刷盘策略与innodb_flush_log_at_trx_commit参数</h6> <p><strong>数据修改是先写入到重做日志缓冲区(redo log buffer)中的, 后面操作系统需要把修改的数据从内存刷新到磁盘进行持久化(刷盘), 这里就有不同的刷盘策略</strong>。</p> <p><strong>参数</strong> <mark><strong>innodb_flush_log_at_trx_commit</strong></mark> <strong>可以控制 redo log 的从内存缓冲区写入磁盘的策略(日志缓冲刷新的频繁程度)</strong> , 也就是上面流程图中更新信息写入到 redo log buffer 缓冲区中之后, 将 redo log buffer 缓冲区中的修改写入到 redo log 的过程(步骤 5).</p> <blockquote><p>innodb_flush_log_at_trx_commit参数取值</p></blockquote> <p>它有三种可能取值:</p> <ul><li>设置为 0: 表示每次事务提交时都只是把 redo log <strong>留在 redo log buffer 中</strong>, 数据库宕机可能会造成<strong>丢失数据</strong>. 对于上图就是没有步骤 5 了.</li> <li><strong>设置为 1(默认值)</strong> : 表示<strong>每次事务提交时都将 redo log 直接持久化到磁盘, 数据最安全, 不会因为数据库宕机丢失数据</strong>, 但是效率稍微差一点, 线上系统推荐这个设置.</li> <li>设置为 2: 表示每次事务提交时都<strong>只是把 redo log 写到操作系统的缓存 page cache 里而不会写到文件中</strong>, 这种情况如果<strong>数据库宕机(数据库进程挂掉)是不会丢失数据的(因为数据是缓存在操作系统的 page cache 内存里面的)</strong> . 但是操作系统如果宕机了, page cache 缓存里的数据还没来得及写入磁盘文件的话就会丢失数据.</li></ul> <blockquote><p>innodb_flush_log_at_trx_commit参数选择</p></blockquote> <p>上面的 0 和 2 都是不会写入文件的, 而是<mark><strong>暂存到内存缓冲区中(0 是 redo log buffer, 2 是操作系统的 page cache)</strong></mark> , 因此存在宕机丢失数据的风险. 因此如果 MySQL 崩溃了或电源断电了, 设置 0 和 2 通常会导致最多一秒的数据丢失, 因为数据可能只存在于操作系统的缓存. 这里说 &quot;通常&quot;, 因为不论如何 InnoDB 会每秒尝试刷新日志文件到磁盘, 但是在一些场景下也可能丢失超过 1 秒的事务, 例如当刷新被推迟了. 与此相反, 把日志刷新到持久化存储意味着 InnoDB 请求操作系统把数据刷出缓存, 并且确认写到磁盘了. 这是一个<strong>阻塞 I/O 的调用</strong>, 直到数据被完全写回才会完成. <strong>因为写数据到磁盘比较慢, 当 innodb_flush_log_at_trx_commit 被设置为 1 时, 可能明显地降低 InnoDB 每秒可以提交的事务数</strong>.</p> <p>设置 innodb_flush_log_at_trx_commit 为不为 1 的值可能导致丢失事务. <mark><strong>高性能事务处理需要的最佳配置是把 innodb_flush_log_at_trx_commit 设置为 1 且把日志文件放到一个有电池保护的写缓存的 RAID 卷中</strong></mark>. 这兼顾了安全和速度. <strong>YFD 配置的 innodb_flush_log_at_trx_commit 参数值为 1</strong>.</p> <p>redo log buffer 刷盘持久化的策略如下图所示, 几种策略对应了不同的 redo log 记录方式.</p> <p>​<img src="https://nano-note.oss-cn-beijing.aliyuncs.com/images/202303191907182.png" alt="">​</p> <p><strong>InnoDB 使用一个后台线程智能地刷新这些变更到数据文件</strong>, 每隔 1 秒就会把 redo log buffer 中的日志, 调用操作系统函数 write 写到文件系统的 <strong>page cache</strong>, 然后调用操作系统函数 fsync 持久化到磁盘文件. 这个线程可以批量组合写入, 使得数据写入更顺序, 以提高效率. 实际上, 事务日志把数据文件的随机 I/O 转换为几乎顺序的日志文件和数据文件 I/O. 把刷新操作转移到后台使查询可以更快完成, 并且缓和查询高峰时 I/O 系统的压力.</p> <p><strong>这里 redo log buffer 是 MySQL 进程管理的内存区域, page cache 是操作系统管理的内存区域, redo log buffer 中的数据修改信息会被写入操作系统的缓存 page cache 中</strong>. page cache 是操作系统内存的一部分, 主要用于解决内存与磁盘速度差异较大的交互问题, 与在 CPU 与内存之间设置高速缓存是一个道理.</p> <h4 id="二进制归档日志-binlog-🌟"><a href="#二进制归档日志-binlog-🌟" class="header-anchor">#</a> 二进制归档日志(binlog)🌟</h4> <h5 id="_1-基础-4"><a href="#_1-基础-4" class="header-anchor">#</a> 1.基础</h5> <p>二进制归档日志(binlog) 是属于 <strong>Server 层</strong>的日志, 是一种逻辑日志, 保存了<strong>所有执行过的修改操作语句, 不保存查询操作</strong>. 所有存储引擎都有.</p> <p>如果 MySQL 服务意外停止, 可通过 binlog 日志文件排查用户操作或表结构操作, 从而来恢复数据库数据.</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token comment">-- 查看binlog相关参数</span>
<span class="token keyword">show</span> variables <span class="token operator">like</span> <span class="token string">'%log_bin%'</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>YFD 测试环境的执行结果如下所示:</p> <p>​<img src="https://nano-note.oss-cn-beijing.aliyuncs.com/images/202303191911123.png" alt="">​</p> <p>几个参数的含义:</p> <ul><li>log_bin: binlog 日志是否打开状态</li> <li>log_bin_basename: 是 binlog 日志的基本文件名, 后面会追加标识来表示每一个文件, binlog 日志文件会滚动增加.</li> <li>log_bin_index: 指定的是 binlog 文件的索引文件, 这个文件管理了所有的 binlog 文件的目录.</li> <li>sql_log_bin: <strong>SQL 语句是否写入 binlog 文件</strong>, ON 代表需要写入, OFF 代表不需要写入. 如果想在主库上执行一些操作, 但不复制到 slave 库上, 可以通过修改参数 sql_log_bin 来实现. 比如模拟主从同步复制异常.</li></ul> <p>MySQL5.7 版本中, binlog 默认是关闭的, 8.0 版本默认是打开的. 上图中 log_bin 的值是 ON 就代表 binlog 是开启状态.</p> <p>binlog 日志文件可能会存在多个, 比如:</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code>mysql<span class="token operator">-</span>bin<span class="token punctuation">.</span><span class="token number">000001</span>
mysql<span class="token operator">-</span>bin<span class="token punctuation">.</span><span class="token number">000002</span>
mysql<span class="token operator">-</span>bin<span class="token punctuation">.</span><span class="token keyword">index</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>这里 mysql-bin.index 文件是 binlog 文件的索引文件, 这个文件管理了所有的 binlog 文件的目录.</p> <blockquote><p>binlog写入时机</p></blockquote> <p>在数据更新流程中，会先写重做日志，写入后再写二进制归档日志。</p> <p>​<img src="https://nano-note.oss-cn-beijing.aliyuncs.com/images/%E5%9B%BE%E7%81%B5-MySQL%E6%89%A7%E8%A1%8C%E8%BF%87%E7%A8%8B%E4%B8%8EInnoDB%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86%20(5).png" alt="">​</p> <blockquote><p>binlog的作用</p></blockquote> <p>binlog 主要用处是<mark><strong>恢复数据与主从复制</strong></mark>.</p> <ul><li><strong>数据恢复</strong>: binlog 主要用来<strong>恢复数据库磁盘里的数据</strong>. 比如某次修改已经将数据的真实修改写入到了磁盘文件中, 但是有人误操作删除了磁盘文件的数据(比如删库跑路), 这时候就可以用 binlog 恢复原始的数据.</li> <li><strong>主从复制</strong>: 主从复制是基于主从机器之间的 binlog 同步实现的，因为 binlog 记录的是执行的 SQL 或者数据，所以从机器也跟着执行一次就实现了数据同步。</li> <li><strong>变更数据事件消费</strong>: 除此之外，还可以监听 binlog 的变化，将数据变化的事件生成消息或者进行二次加工，将结果发送到 MQ 或者其他系统中，比如同步到 ES 或者 Redis 中。</li></ul> <h5 id="_2-binlog日志格式"><a href="#_2-binlog日志格式" class="header-anchor">#</a> 2.binlog日志格式</h5> <p>参数 binlog_format 可以设置 binlog <strong>日志的记录格式</strong>, MySQL 支持三种格式类型:</p> <ul><li><strong>STATEMENT</strong>: 基于 <strong>SQL 语句的复制</strong>, 每一条会修改数据的 SQL 都会记录到 master 机器的 binlog 中, 这种方式<strong>日志量小</strong>, 节约 IO 开销, 提高性能, 但是对于一些执行<strong>过程中才能确定结果的函数</strong>, 比如 UUID(), SYSDATE() 等函数如果随 SQL 同步到 slave 机器去执行, 则结果跟 master 机器执行的不一样.</li> <li><strong>ROW</strong>: 基于<strong>行的复制, 日志中会记录成每一行数据被修改的形式</strong>, 然后在 slave 端再对相同的数据进行修改记录下每一行数据修改的细节, 可以解决函数, 存储过程等在 slave 机器的复制问题, 但这种方式<strong>日志量较大</strong>, 性能不如 Statement. 假设 update 语句更新 100 行数据, Statement 方式就记录这条 update 语句, Row 方式会记录被修改的 100 行数据.</li> <li><strong>MIXED</strong>: 混合模式复制, 实际就是前两种模式的结合, 在 Mixed 模式下, MySQL 会根据执行的每一条具体的 SQL 语句来区分对待记录的日志形式, 也就是在 Statement 和 Row 之间选择一种, 如果 SQL 里有函数或一些在执行时才知道结果的情况, 会选择 Row, 其它情况选择 Statement, 推荐使用这一种.</li></ul> <p><strong>YFD 采用的 ROW 格式</strong>.</p> <h5 id="_3-binlog写入磁盘机制"><a href="#_3-binlog写入磁盘机制" class="header-anchor">#</a> 3.binlog写入磁盘机制</h5> <p>binlog 写入磁盘机制主要通过 <strong>sync_binlog</strong> 参数控制, 默认值是 0.</p> <ul><li><strong>设置为 0</strong>. 表示每次提交事务都只写到操作系统的 page cache, 由系统自行判断什么时候执行 fsync 写入磁盘. 虽然性能得到提升, 但是机器宕机, page cache 里面的 binlog 会丢失. 这与前面 redo log 类似.</li> <li><strong>设置为 1. 表示每次提交事务都会执行 fsync 写入磁盘, 这种方式最安全</strong>.</li> <li><strong>设置为 N(N &gt; 1)</strong> . 表示每次提交事务都写到 page cache, 但累积 N 个事务后才 fsync 写入磁盘, 这种如果机器宕机会丢失 N 个事务的 binlog.</li></ul> <p>YFD 采用的 <strong>sync_binlog = 1</strong>.</p> <p>发生以下任何事件时, <strong>binlog 日志文件会重新生成</strong>:</p> <ul><li>服务器启动或重新启动.</li> <li>服务器刷新日志, 执行命令 flush logs.</li> <li>日志文件大小达到 max_binlog_size 值, 默认值为 1GB.</li></ul> <h5 id="_4-查看binlog日志文件"><a href="#_4-查看binlog日志文件" class="header-anchor">#</a> 4.查看binlog日志文件</h5> <p>可以用 MySQL 自带的命令工具 <strong>mysqlbinlog</strong> 可以查看 binlog 日志内容.</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token comment">-- 查看bin-log二进制文件(命令行方式, 不用登录mysql)</span>
mysqlbinlog <span class="token comment">--no-defaults -v --base64-output=decode-rows D:/dev/mysql-5.7.25-winx64/data/mysql-binlog.000007 </span>

<span class="token comment">-- 查看bin-log二进制文件(带查询条件)</span>
mysqlbinlog <span class="token comment">--no-defaults -v --base64-output=decode-rows D:/dev/mysql-5.7.25-winx64/data/mysql-binlog.000007 start-datetime=&quot;2023-01-21 00:00:00&quot; stop-datetime=&quot;2023-02-01 00:00:00&quot; start-position=&quot;5000&quot; stop-position=&quot;20000&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>执行 mysqlbinlog 命令.</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code>mysqlbinlog <span class="token comment">--no-defaults -v --base64-output=decode-rows D:/dev/mysql-5.7.25-winx64/data/mysql-binlog.000007</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>查出来的 binlog 日志文件内容如下:</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token comment">/*!50530 SET @@SESSION.PSEUDO_SLAVE_MODE=1*/</span><span class="token punctuation">;</span>
<span class="token comment">/*!50003 SET @OLD_COMPLETION_TYPE=@@COMPLETION_TYPE,COMPLETION_TYPE=0*/</span><span class="token punctuation">;</span>
<span class="token keyword">DELIMITER</span> <span class="token comment">/*!*/</span><span class="token punctuation">;</span>
<span class="token comment"># at 4</span>
<span class="token comment">#230127 21:13:51 server id 1  end_log_pos 123 CRC32 0x084f390f  Start: binlog v 4, server v 5.7.25-log created 230127 21:13:51 at startup</span>
<span class="token comment"># Warning: this binlog is either in use or was not closed properly.</span>
<span class="token keyword">ROLLBACK</span><span class="token comment">/*!*/</span><span class="token punctuation">;</span>
<span class="token comment"># at 123</span>
<span class="token comment">#230127 21:13:51 server id 1  end_log_pos 154 CRC32 0x672ba207  Previous-GTIDs</span>
<span class="token comment"># [empty]</span>
<span class="token comment"># at 154</span>
<span class="token comment">#230127 21:22:48 server id 1  end_log_pos 219 CRC32 0x8349d010  Anonymous_GTID  last_committed=0        sequence_number=1       rbr_only=yes</span>
<span class="token comment">/*!50718 SET TRANSACTION ISOLATION LEVEL READ COMMITTED*/</span><span class="token comment">/*!*/</span><span class="token punctuation">;</span>
<span class="token keyword">SET</span> @<span class="token variable">@SESSION.GTID_NEXT</span><span class="token operator">=</span> <span class="token string">'ANONYMOUS'</span><span class="token comment">/*!*/</span><span class="token punctuation">;</span>
<span class="token comment"># at 219</span>
<span class="token comment">#230127 21:22:48 server id 1  end_log_pos 291 CRC32 0xbf49de02  Query   thread_id=3     exec_time=0     error_code=0</span>
<span class="token keyword">SET</span> <span class="token keyword">TIMESTAMP</span><span class="token operator">=</span><span class="token number">1674825768</span><span class="token comment">/*!*/</span><span class="token punctuation">;</span>
<span class="token keyword">SET</span> @<span class="token variable">@session.pseudo_thread_id</span><span class="token operator">=</span><span class="token number">3</span><span class="token comment">/*!*/</span><span class="token punctuation">;</span>
<span class="token keyword">SET</span> @<span class="token variable">@session.foreign_key_checks</span><span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> @<span class="token variable">@session.sql_auto_is_null</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> @<span class="token variable">@session.unique_checks</span><span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> @<span class="token variable">@session.autocommit</span><span class="token operator">=</span><span class="token number">1</span><span class="token comment">/*!*/</span><span class="token punctuation">;</span>
<span class="token keyword">SET</span> @<span class="token variable">@session.sql_mode</span><span class="token operator">=</span><span class="token number">1342177280</span><span class="token comment">/*!*/</span><span class="token punctuation">;</span>
<span class="token keyword">SET</span> @<span class="token variable">@session.auto_increment_increment</span><span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> @<span class="token variable">@session.auto_increment_offset</span><span class="token operator">=</span><span class="token number">1</span><span class="token comment">/*!*/</span><span class="token punctuation">;</span>
<span class="token comment">/*!\C utf8 */</span><span class="token comment">/*!*/</span><span class="token punctuation">;</span>
<span class="token keyword">SET</span> @<span class="token variable">@session.character_set_client</span><span class="token operator">=</span><span class="token number">33</span><span class="token punctuation">,</span>@<span class="token variable">@session.collation_connection</span><span class="token operator">=</span><span class="token number">33</span><span class="token punctuation">,</span>@<span class="token variable">@session.collation_server</span><span class="token operator">=</span><span class="token number">33</span><span class="token comment">/*!*/</span><span class="token punctuation">;</span>
<span class="token keyword">SET</span> @<span class="token variable">@session.lc_time_names</span><span class="token operator">=</span><span class="token number">0</span><span class="token comment">/*!*/</span><span class="token punctuation">;</span>
<span class="token keyword">SET</span> @<span class="token variable">@session.collation_database</span><span class="token operator">=</span><span class="token keyword">DEFAULT</span><span class="token comment">/*!*/</span><span class="token punctuation">;</span>
<span class="token keyword">BEGIN</span>
<span class="token comment">/*!*/</span><span class="token punctuation">;</span>
<span class="token comment"># at 291</span>
<span class="token comment">#230127 21:22:48 server id 1  end_log_pos 345 CRC32 0xc4ab653e  Table_map: `test`.`account` mapped to number 99</span>
<span class="token comment"># at 345</span>
<span class="token comment">#230127 21:22:48 server id 1  end_log_pos 413 CRC32 0x54a124bd  Update_rows: table id 99 flags: STMT_END_F</span>
<span class="token comment">### UPDATE `test`.`account`</span>
<span class="token comment">### WHERE</span>
<span class="token comment">###   @1=1</span>
<span class="token comment">###   @2='lilei'</span>
<span class="token comment">###   @3=1000</span>
<span class="token comment">### SET</span>
<span class="token comment">###   @1=1</span>
<span class="token comment">###   @2='lilei'</span>
<span class="token comment">###   @3=2000</span>
<span class="token comment"># at 413</span>
<span class="token comment">#230127 21:22:48 server id 1  end_log_pos 444 CRC32 0x23355595  Xid = 10</span>
<span class="token keyword">COMMIT</span><span class="token comment">/*!*/</span><span class="token punctuation">;</span>
<span class="token comment"># at 444</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br></div></div><p>能看到里面有具体执行的<strong>修改 SQL 语句以及执行时的相关情况</strong>.</p> <h5 id="_5-binlog日志文件恢复数据"><a href="#_5-binlog日志文件恢复数据" class="header-anchor">#</a> 5.binlog日志文件恢复数据</h5> <p><strong>如果数据被误删除了, 可以尝试用 binlog 日志文件对数据进行恢复, 其实就是</strong>​<mark><strong>回放执行</strong></mark>​<strong>之前记录在 binlog 文件里的 SQL</strong>.</p> <p>举一个数据恢复的例子:</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token comment">-- 先执行刷新日志的命令生成一个新的binlog文件mysql-binlog.000008, 后面修改操作日志都会记录在最新的这个文件里</span>
flush logs<span class="token punctuation">;</span>
<span class="token comment">-- 执行两条插入语句</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token identifier"><span class="token punctuation">`</span>test<span class="token punctuation">`</span></span><span class="token punctuation">.</span><span class="token identifier"><span class="token punctuation">`</span>account<span class="token punctuation">`</span></span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span><span class="token punctuation">,</span> <span class="token identifier"><span class="token punctuation">`</span>name<span class="token punctuation">`</span></span><span class="token punctuation">,</span> <span class="token identifier"><span class="token punctuation">`</span>balance<span class="token punctuation">`</span></span><span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'4'</span><span class="token punctuation">,</span> <span class="token string">'zhu'</span><span class="token punctuation">,</span> <span class="token string">'666'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token identifier"><span class="token punctuation">`</span>test<span class="token punctuation">`</span></span><span class="token punctuation">.</span><span class="token identifier"><span class="token punctuation">`</span>account<span class="token punctuation">`</span></span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span><span class="token punctuation">,</span> <span class="token identifier"><span class="token punctuation">`</span>name<span class="token punctuation">`</span></span><span class="token punctuation">,</span> <span class="token identifier"><span class="token punctuation">`</span>balance<span class="token punctuation">`</span></span><span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'5'</span><span class="token punctuation">,</span> <span class="token string">'zhu1'</span><span class="token punctuation">,</span> <span class="token string">'888'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">-- 假设现在误操作执行了一条删除语句把刚新增的两条数据删掉了</span>
<span class="token keyword">delete</span> <span class="token keyword">from</span> account <span class="token keyword">where</span> id <span class="token operator">&gt;</span> <span class="token number">3</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>现在需要<strong>恢复被删除的两条数据</strong>, 先查看 binlog 日志文件.</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code>mysqlbinlog <span class="token comment">--no-defaults -v --base64-output=decode-rows D:/dev/mysql-5.7.25-winx64/data/mysql-binlog.000008</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>文件内容如下:</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">SET</span> @<span class="token variable">@SESSION.GTID_NEXT</span><span class="token operator">=</span> <span class="token string">'ANONYMOUS'</span><span class="token comment">/*!*/</span><span class="token punctuation">;</span>
<span class="token comment"># at 219</span>
<span class="token comment">#230127 23:32:24 server id 1  end_log_pos 291 CRC32 0x4528234f  Query   thread_id=5     exec_time=0     error_code=0</span>
<span class="token keyword">SET</span> <span class="token keyword">TIMESTAMP</span><span class="token operator">=</span><span class="token number">1674833544</span><span class="token comment">/*!*/</span><span class="token punctuation">;</span>
<span class="token keyword">SET</span> @<span class="token variable">@session.pseudo_thread_id</span><span class="token operator">=</span><span class="token number">5</span><span class="token comment">/*!*/</span><span class="token punctuation">;</span>
<span class="token keyword">SET</span> @<span class="token variable">@session.foreign_key_checks</span><span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> @<span class="token variable">@session.sql_auto_is_null</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> @<span class="token variable">@session.unique_checks</span><span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> @<span class="token variable">@session.autocommit</span><span class="token operator">=</span><span class="token number">1</span><span class="token comment">/*!*/</span><span class="token punctuation">;</span>
<span class="token keyword">SET</span> @<span class="token variable">@session.sql_mode</span><span class="token operator">=</span><span class="token number">1342177280</span><span class="token comment">/*!*/</span><span class="token punctuation">;</span>
<span class="token keyword">SET</span> @<span class="token variable">@session.auto_increment_increment</span><span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> @<span class="token variable">@session.auto_increment_offset</span><span class="token operator">=</span><span class="token number">1</span><span class="token comment">/*!*/</span><span class="token punctuation">;</span>
<span class="token comment">/*!\C utf8 */</span><span class="token comment">/*!*/</span><span class="token punctuation">;</span>
<span class="token keyword">SET</span> @<span class="token variable">@session.character_set_client</span><span class="token operator">=</span><span class="token number">33</span><span class="token punctuation">,</span>@<span class="token variable">@session.collation_connection</span><span class="token operator">=</span><span class="token number">33</span><span class="token punctuation">,</span>@<span class="token variable">@session.collation_server</span><span class="token operator">=</span><span class="token number">33</span><span class="token comment">/*!*/</span><span class="token punctuation">;</span>
<span class="token keyword">SET</span> @<span class="token variable">@session.lc_time_names</span><span class="token operator">=</span><span class="token number">0</span><span class="token comment">/*!*/</span><span class="token punctuation">;</span>
<span class="token keyword">SET</span> @<span class="token variable">@session.collation_database</span><span class="token operator">=</span><span class="token keyword">DEFAULT</span><span class="token comment">/*!*/</span><span class="token punctuation">;</span>
<span class="token keyword">BEGIN</span>
<span class="token comment">/*!*/</span><span class="token punctuation">;</span>
<span class="token comment"># at 291</span>
<span class="token comment">#230127 23:32:24 server id 1  end_log_pos 345 CRC32 0x7482741d  Table_map: `test`.`account` mapped to number 99</span>
<span class="token comment"># at 345</span>
<span class="token comment">#230127 23:32:24 server id 1  end_log_pos 396 CRC32 0x5e443cf0  Write_rows: table id 99 flags: STMT_END_F</span>
<span class="token comment">### INSERT INTO `test`.`account`</span>
<span class="token comment">### SET</span>
<span class="token comment">###   @1=4</span>
<span class="token comment">###   @2='zhu'</span>
<span class="token comment">###   @3=666</span>
<span class="token comment"># at 396</span>
<span class="token comment">#230127 23:32:24 server id 1  end_log_pos 427 CRC32 0x8a0d8a3c  Xid = 56</span>
<span class="token keyword">COMMIT</span><span class="token comment">/*!*/</span><span class="token punctuation">;</span>
<span class="token comment"># at 427</span>
<span class="token comment">#230127 23:32:40 server id 1  end_log_pos 492 CRC32 0x5261a37e  Anonymous_GTID  last_committed=1        sequence_number=2       rbr_only=yes</span>
<span class="token comment">/*!50718 SET TRANSACTION ISOLATION LEVEL READ COMMITTED*/</span><span class="token comment">/*!*/</span><span class="token punctuation">;</span>
<span class="token keyword">SET</span> @<span class="token variable">@SESSION.GTID_NEXT</span><span class="token operator">=</span> <span class="token string">'ANONYMOUS'</span><span class="token comment">/*!*/</span><span class="token punctuation">;</span>
<span class="token comment"># at 492</span>
<span class="token comment">#230127 23:32:40 server id 1  end_log_pos 564 CRC32 0x01086643  Query   thread_id=5     exec_time=0     error_code=0</span>
<span class="token keyword">SET</span> <span class="token keyword">TIMESTAMP</span><span class="token operator">=</span><span class="token number">1674833560</span><span class="token comment">/*!*/</span>
<span class="token keyword">BEGIN</span>
<span class="token comment">/*!*/</span><span class="token punctuation">;</span>
<span class="token comment"># at 564</span>
<span class="token comment">#230127 23:32:40 server id 1  end_log_pos 618 CRC32 0xc26b6719  Table_map: `test`.`account` mapped to number 99</span>
<span class="token comment"># at 618</span>
<span class="token comment">#230127 23:32:40 server id 1  end_log_pos 670 CRC32 0x8e272176  Write_rows: table id 99 flags: STMT_END_F</span>
<span class="token comment">### INSERT INTO `test`.`account`</span>
<span class="token comment">### SET</span>
<span class="token comment">###   @1=5</span>
<span class="token comment">###   @2='zhu1'</span>
<span class="token comment">###   @3=888</span>
<span class="token comment"># at 670</span>
<span class="token comment">#230127 23:32:40 server id 1  end_log_pos 701 CRC32 0xb5e63d00  Xid = 58</span>
<span class="token keyword">COMMIT</span><span class="token comment">/*!*/</span><span class="token punctuation">;</span>
<span class="token comment"># at 701</span>
<span class="token comment">#230127 23:34:23 server id 1  end_log_pos 766 CRC32 0xa0844501  Anonymous_GTID  last_committed=2        sequence_number=3       rbr_only=yes</span>
<span class="token comment">/*!50718 SET TRANSACTION ISOLATION LEVEL READ COMMITTED*/</span><span class="token comment">/*!*/</span><span class="token punctuation">;</span>
<span class="token keyword">SET</span> @<span class="token variable">@SESSION.GTID_NEXT</span><span class="token operator">=</span> <span class="token string">'ANONYMOUS'</span><span class="token comment">/*!*/</span><span class="token punctuation">;</span>
<span class="token comment"># at 766</span>
<span class="token comment">#230127 23:34:23 server id 1  end_log_pos 838 CRC32 0x687bdf88  Query   thread_id=7     exec_time=0     error_code=0</span>
<span class="token keyword">SET</span> <span class="token keyword">TIMESTAMP</span><span class="token operator">=</span><span class="token number">1674833663</span><span class="token comment">/*!*/</span><span class="token punctuation">;</span>
<span class="token keyword">BEGIN</span>
<span class="token comment">/*!*/</span><span class="token punctuation">;</span>
<span class="token comment"># at 838</span>
<span class="token comment">#230127 23:34:23 server id 1  end_log_pos 892 CRC32 0x4f7b7d6a  Table_map: `test`.`account` mapped to number 99</span>
<span class="token comment"># at 892</span>
<span class="token comment">#230127 23:34:23 server id 1  end_log_pos 960 CRC32 0xc47ac777  Delete_rows: table id 99 flags: STMT_END_F</span>
<span class="token comment">### DELETE FROM `test`.`account`</span>
<span class="token comment">### WHERE</span>
<span class="token comment">###   @1=4</span>
<span class="token comment">###   @2='zhu'</span>
<span class="token comment">###   @3=666</span>
<span class="token comment">### DELETE FROM `test`.`account`</span>
<span class="token comment">### WHERE</span>
<span class="token comment">###   @1=5</span>
<span class="token comment">###   @2='zhu1'</span>
<span class="token comment">###   @3=888</span>
<span class="token comment"># at 960</span>
<span class="token comment">#230127 23:34:23 server id 1  end_log_pos 991 CRC32 0x386699fe  Xid = 65</span>
<span class="token keyword">COMMIT</span><span class="token comment">/*!*/</span><span class="token punctuation">;</span>
<span class="token keyword">SET</span> @<span class="token variable">@SESSION.GTID_NEXT</span><span class="token operator">=</span> <span class="token string">'AUTOMATIC'</span> <span class="token comment">/* added by mysqlbinlog */</span> <span class="token comment">/*!*/</span><span class="token punctuation">;</span>
<span class="token keyword">DELIMITER</span> <span class="token punctuation">;</span>
<span class="token comment"># End of log file</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br></div></div><p>找到两条插入数据的 SQL, <strong>每条 SQL 的上下都有 BEGIN 和 COMMIT</strong>, 找到第一条 SQL BEGIN 前面的文件位置标识 at <strong>219</strong>(这是文件的位置标识), 再找到第二条 SQL COMMIT 后面的文件位置标识 at <strong>701</strong>.</p> <p>可以根据文件位置标识来恢复数据, 执行如下 SQL:</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code>mysqlbinlog  <span class="token comment">--no-defaults --start-position=219 --stop-position=701 --database=test D:/dev/mysql-5.7.25-winx64/data/mysql-binlog.000009 | mysql -uroot -p123456 -v test</span>

<span class="token comment">-- 补充一个根据时间来恢复数据的命令, 找到第一条SQL BEGIN前面的时间戳标记 SET TIMESTAMP=1674833544, 再找到第二条SQL COMMIT后面的时间戳标记 SET TIMESTAMP=1674833663, 转成datetime格式</span>
mysqlbinlog  <span class="token comment">--no-defaults --start-datetime=&quot;2023-1-27 23:32:24&quot; --stop-datetime=&quot;2023-1-27 23:34:23&quot; --database=test D:/dev/mysql-5.7.25-winx64/data/mysql-binlog.000009 | mysql -uroot -p123456 -v test</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>这样被删除数据就被恢复了.</p> <p>注意: <strong>如果要恢复大量数据</strong>, 比如删库跑路, 假设把数据库所有数据都删除了要怎么恢复, 如果数据库之前没有备份, 所有的 binlog 日志都在的话, 就从 binlog 第一个文件开始逐个恢复每个 binlog 文件里的数据, 这种一般不太可能, 因为 binlog 日志比较大, <strong>早期的 binlog 文件会定期删除的, 所以一般不可能用 binlog 文件恢复整个数据库的</strong>.</p> <p><mark><strong>一般推荐的是定期做一次全量数据库备份, 那么恢复数据库可以用最近的一次全量备份再加上备份时间点之后的 binlog 来恢复数据</strong></mark>.</p> <p>备份数据库一般可以用 mysqldump 命令工具.</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token comment">-- 备份整个数据库</span>
mysqldump <span class="token operator">-</span>u root 数据库名<span class="token operator">&gt;</span>备份文件名<span class="token punctuation">;</span>   
<span class="token comment">-- 备份整个表</span>
mysqldump <span class="token operator">-</span>u root 数据库名 表名字<span class="token operator">&gt;</span>备份文件名<span class="token punctuation">;</span>  
<span class="token comment">-- 恢复整个数据库, test为数据库名称, 需要自己先建一个数据库test</span>
mysql <span class="token operator">-</span>u root test <span class="token operator">&lt;</span> 备份文件名 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h4 id="其他日志"><a href="#其他日志" class="header-anchor">#</a> 其他日志</h4> <h5 id="_1-慢查询日志"><a href="#_1-慢查询日志" class="header-anchor">#</a> 1.慢查询日志</h5> <p>慢查询日志是开销最低, 精度最高的测量查询时间的工具.</p> <p>应该借助<strong>工具分析慢查询日志, 生成直观的报告</strong>.</p> <p>通过慢查询日志定位需要优化的单条查询, 然后单独分析该语句.</p> <h5 id="_2-错误日志"><a href="#_2-错误日志" class="header-anchor">#</a> 2.错误日志</h5> <p>MySQL 还有一个比较重要的日志是错误日志, 它<strong>记录了数据库启动和停止, 以及运行过程中发生任何严重错误时的相关信息</strong>. 当数据库出现任何故障导致无法正常使用时, 建议首先查看此日志.</p> <p>在 MySQL 数据库中, 错误日志功能是默认开启的, 而且无法被关闭.</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token comment">-- 查看错误日志存放位置</span>
<span class="token keyword">show</span> variables <span class="token operator">like</span> <span class="token string">'%log_error%'</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>‍</p> <p>‍</p> <h4 id="参考资料"><a href="#参考资料" class="header-anchor">#</a> 参考资料</h4> <ul><li><a href="https://segmentfault.com/a/1190000012650596" target="_blank" rel="noopener noreferrer">MySQL-InnoDB-MVCC多版本并发控制<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="http://xiaorui.cc/2016/12/08/%E4%B8%BA%E4%BB%80%E4%B9%88%E4%B8%8D%E5%BB%BA%E8%AE%AEinnodb%E4%BD%BF%E7%94%A8%E4%BA%BF%E7%BA%A7%E5%A4%A7%E8%A1%A8/" target="_blank" rel="noopener noreferrer">为什么不建议innodb使用亿级大表 | 峰云就她了<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul> <p>‍</p></div></div>  <div class="page-edit"><div class="edit-link"><a href="https://github.com/xugaoyi/vuepress-theme-vdoing/edit/main/docs/20.开发/2100.开发/200.数据库/250.MySQL基础架构与存储引擎🌟.md" target="_blank" rel="noopener noreferrer">编辑</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <!----> <!----></div> <div class="page-nav-wapper"><div class="page-nav-centre-wrap"><a href="/pages/becc59/" class="page-nav-centre page-nav-centre-prev"><div class="tooltip">MySQL高级特性</div></a> <a href="/pages/63b46e/" class="page-nav-centre page-nav-centre-next"><div class="tooltip">MySQL架构优化与运维</div></a></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/pages/becc59/" class="prev">MySQL高级特性</a></span> <span class="next"><a href="/pages/63b46e/">MySQL架构优化与运维</a>→
      </span></p></div></div></div> <!----></main></div> <div class="footer"><div class="icons"><a href="mailto:1174520425@qq.com" title="发邮件" target="_blank" class="iconfont icon-youjian"></a><a href="https://github.com/nanodaemony" title="GitHub" target="_blank" class="iconfont icon-github"></a></div> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="本站主题">Vdoing</a> 
    | Copyright © 2019-2025
    <span>达尔文的猹 | MIT License</span></div> <div class="buttons"><div title="返回顶部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去评论" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主题模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          跟随系统
        </li><li class="iconfont icon-rijianmoshi">
          浅色模式
        </li><li class="iconfont icon-yejianmoshi">
          深色模式
        </li><li class="iconfont icon-yuedu">
          阅读模式
        </li></ul></div></div> <!----> <!----> <!----></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.3f3e0e10.js" defer></script><script src="/assets/js/2.e9fcb30c.js" defer></script><script src="/assets/js/3.1998f389.js" defer></script><script src="/assets/js/105.8288396c.js" defer></script>
  </body>
</html>
