<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Netty | Pangolin Note</title>
    <meta name="generator" content="VuePress 1.9.5">
    <link rel="icon" href="/img/favicon.ico">
    <meta name="description" content="å¤§é“è‡³ç®€">
    <meta name="keywords" content="å‰ç«¯åšå®¢,ä¸ªäººæŠ€æœ¯åšå®¢,å‰ç«¯,å‰ç«¯å¼€å‘,å‰ç«¯æ¡†æ¶,webå‰ç«¯,å‰ç«¯é¢è¯•é¢˜,æŠ€æœ¯æ–‡æ¡£,å­¦ä¹ ,é¢è¯•,JavaScript,js,ES6,TypeScript,vue,python,css3,html5,Node,git,github,markdown">
    <meta name="baidu-site-verification" content="7F55weZDDc">
    <meta name="theme-color" content="#11a8cd">
    
    <link rel="preload" href="/assets/css/0.styles.56073ad3.css" as="style"><link rel="preload" href="/assets/js/app.3f3e0e10.js" as="script"><link rel="preload" href="/assets/js/2.e9fcb30c.js" as="script"><link rel="preload" href="/assets/js/3.1998f389.js" as="script"><link rel="preload" href="/assets/js/167.009d47a3.js" as="script"><link rel="prefetch" href="/assets/js/10.0b55747f.js"><link rel="prefetch" href="/assets/js/100.b8912a99.js"><link rel="prefetch" href="/assets/js/101.a6740c8a.js"><link rel="prefetch" href="/assets/js/102.e31e89b2.js"><link rel="prefetch" href="/assets/js/103.2c5dbdae.js"><link rel="prefetch" href="/assets/js/104.0e9c02f6.js"><link rel="prefetch" href="/assets/js/105.8288396c.js"><link rel="prefetch" href="/assets/js/106.62f43c11.js"><link rel="prefetch" href="/assets/js/107.70c90211.js"><link rel="prefetch" href="/assets/js/108.b488ce56.js"><link rel="prefetch" href="/assets/js/109.12942650.js"><link rel="prefetch" href="/assets/js/11.ac3fd1ca.js"><link rel="prefetch" href="/assets/js/110.1e57ecba.js"><link rel="prefetch" href="/assets/js/111.6e33b4ea.js"><link rel="prefetch" href="/assets/js/112.bd52831b.js"><link rel="prefetch" href="/assets/js/113.868c1ac9.js"><link rel="prefetch" href="/assets/js/114.090549d1.js"><link rel="prefetch" href="/assets/js/115.d97f6c2b.js"><link rel="prefetch" href="/assets/js/116.097c4b4e.js"><link rel="prefetch" href="/assets/js/117.4024cfe2.js"><link rel="prefetch" href="/assets/js/118.e3057cba.js"><link rel="prefetch" href="/assets/js/119.4ef1fa3b.js"><link rel="prefetch" href="/assets/js/12.863eaabe.js"><link rel="prefetch" href="/assets/js/120.78f9df50.js"><link rel="prefetch" href="/assets/js/121.8e16df87.js"><link rel="prefetch" href="/assets/js/122.f21c0107.js"><link rel="prefetch" href="/assets/js/123.ea1cb375.js"><link rel="prefetch" href="/assets/js/124.01c04c6e.js"><link rel="prefetch" href="/assets/js/125.d383e301.js"><link rel="prefetch" href="/assets/js/126.3162cb47.js"><link rel="prefetch" href="/assets/js/127.c6bebae6.js"><link rel="prefetch" href="/assets/js/128.d659db60.js"><link rel="prefetch" href="/assets/js/129.2afdcf48.js"><link rel="prefetch" href="/assets/js/13.4f59ce35.js"><link rel="prefetch" href="/assets/js/130.beb9ed9d.js"><link rel="prefetch" href="/assets/js/131.35b05f8a.js"><link rel="prefetch" href="/assets/js/132.d77f4f93.js"><link rel="prefetch" href="/assets/js/133.4ceda6e5.js"><link rel="prefetch" href="/assets/js/134.11390c5f.js"><link rel="prefetch" href="/assets/js/135.32f9e38f.js"><link rel="prefetch" href="/assets/js/136.6d8bb0f2.js"><link rel="prefetch" href="/assets/js/137.9c0ffeef.js"><link rel="prefetch" href="/assets/js/138.88d86e5f.js"><link rel="prefetch" href="/assets/js/139.8c2c3d6c.js"><link rel="prefetch" href="/assets/js/14.11c82d35.js"><link rel="prefetch" href="/assets/js/140.c5c375d3.js"><link rel="prefetch" href="/assets/js/141.d703f30b.js"><link rel="prefetch" href="/assets/js/142.6a005a44.js"><link rel="prefetch" href="/assets/js/143.9b2edf6f.js"><link rel="prefetch" href="/assets/js/144.3fd013c9.js"><link rel="prefetch" href="/assets/js/145.b05079c5.js"><link rel="prefetch" href="/assets/js/146.ed5360a6.js"><link rel="prefetch" href="/assets/js/147.7408d86f.js"><link rel="prefetch" href="/assets/js/148.f390b370.js"><link rel="prefetch" href="/assets/js/149.95017f0a.js"><link rel="prefetch" href="/assets/js/15.bd143bd5.js"><link rel="prefetch" href="/assets/js/150.f0ede764.js"><link rel="prefetch" href="/assets/js/151.b7093623.js"><link rel="prefetch" href="/assets/js/152.a82a6c83.js"><link rel="prefetch" href="/assets/js/153.965e3fb2.js"><link rel="prefetch" href="/assets/js/154.9e49311e.js"><link rel="prefetch" href="/assets/js/155.cef33ba5.js"><link rel="prefetch" href="/assets/js/156.bcc397ae.js"><link rel="prefetch" href="/assets/js/157.90824739.js"><link rel="prefetch" href="/assets/js/158.efd429b9.js"><link rel="prefetch" href="/assets/js/159.122ff5b7.js"><link rel="prefetch" href="/assets/js/16.2449162b.js"><link rel="prefetch" href="/assets/js/160.0b806535.js"><link rel="prefetch" href="/assets/js/161.835052c6.js"><link rel="prefetch" href="/assets/js/162.ca34e2d2.js"><link rel="prefetch" href="/assets/js/163.08000d04.js"><link rel="prefetch" href="/assets/js/164.a1cc0109.js"><link rel="prefetch" href="/assets/js/165.65444686.js"><link rel="prefetch" href="/assets/js/166.7d73c84f.js"><link rel="prefetch" href="/assets/js/168.0afeae2a.js"><link rel="prefetch" href="/assets/js/169.7654cb31.js"><link rel="prefetch" href="/assets/js/17.eb7f9def.js"><link rel="prefetch" href="/assets/js/170.58569530.js"><link rel="prefetch" href="/assets/js/171.7db9ed40.js"><link rel="prefetch" href="/assets/js/172.3cb50ed4.js"><link rel="prefetch" href="/assets/js/173.0846425f.js"><link rel="prefetch" href="/assets/js/174.9e95f111.js"><link rel="prefetch" href="/assets/js/175.ef2098f2.js"><link rel="prefetch" href="/assets/js/176.c2635fe9.js"><link rel="prefetch" href="/assets/js/177.4fa38e8e.js"><link rel="prefetch" href="/assets/js/178.2be7037f.js"><link rel="prefetch" href="/assets/js/179.bf3bba28.js"><link rel="prefetch" href="/assets/js/18.0455f4d1.js"><link rel="prefetch" href="/assets/js/180.72c5f597.js"><link rel="prefetch" href="/assets/js/181.42287bcc.js"><link rel="prefetch" href="/assets/js/182.6cd4bf1a.js"><link rel="prefetch" href="/assets/js/183.05dbbfd9.js"><link rel="prefetch" href="/assets/js/184.03de7e00.js"><link rel="prefetch" href="/assets/js/185.42dd210e.js"><link rel="prefetch" href="/assets/js/186.28ee0f8a.js"><link rel="prefetch" href="/assets/js/187.bb58697b.js"><link rel="prefetch" href="/assets/js/188.1bc8be96.js"><link rel="prefetch" href="/assets/js/189.fac747e3.js"><link rel="prefetch" href="/assets/js/19.ae9e35d6.js"><link rel="prefetch" href="/assets/js/190.ea533ac7.js"><link rel="prefetch" href="/assets/js/191.6dc6eb13.js"><link rel="prefetch" href="/assets/js/192.184d249f.js"><link rel="prefetch" href="/assets/js/193.4a06bc12.js"><link rel="prefetch" href="/assets/js/194.8cce60a9.js"><link rel="prefetch" href="/assets/js/195.93231a13.js"><link rel="prefetch" href="/assets/js/196.4a596bde.js"><link rel="prefetch" href="/assets/js/197.96c113cf.js"><link rel="prefetch" href="/assets/js/198.73ba3f67.js"><link rel="prefetch" href="/assets/js/199.74bab595.js"><link rel="prefetch" href="/assets/js/20.b542d0e7.js"><link rel="prefetch" href="/assets/js/200.69a6928a.js"><link rel="prefetch" href="/assets/js/201.9ffa7c5a.js"><link rel="prefetch" href="/assets/js/202.41edb652.js"><link rel="prefetch" href="/assets/js/203.7fabcef3.js"><link rel="prefetch" href="/assets/js/204.b0ae2f62.js"><link rel="prefetch" href="/assets/js/205.add8738b.js"><link rel="prefetch" href="/assets/js/206.f3a712ec.js"><link rel="prefetch" href="/assets/js/207.cd7dd729.js"><link rel="prefetch" href="/assets/js/208.78b33afa.js"><link rel="prefetch" href="/assets/js/209.9d3329ff.js"><link rel="prefetch" href="/assets/js/21.5a050318.js"><link rel="prefetch" href="/assets/js/210.d285d5ac.js"><link rel="prefetch" href="/assets/js/211.8791bb3f.js"><link rel="prefetch" href="/assets/js/212.84ed81a8.js"><link rel="prefetch" href="/assets/js/213.7b990580.js"><link rel="prefetch" href="/assets/js/214.da31f20c.js"><link rel="prefetch" href="/assets/js/215.9eeed659.js"><link rel="prefetch" href="/assets/js/216.9539f0ec.js"><link rel="prefetch" href="/assets/js/217.11b575be.js"><link rel="prefetch" href="/assets/js/218.a67f12f1.js"><link rel="prefetch" href="/assets/js/219.bfbb817a.js"><link rel="prefetch" href="/assets/js/22.2bc6f7e3.js"><link rel="prefetch" href="/assets/js/220.8b01342f.js"><link rel="prefetch" href="/assets/js/221.b450decd.js"><link rel="prefetch" href="/assets/js/222.97468507.js"><link rel="prefetch" href="/assets/js/223.b6dafd73.js"><link rel="prefetch" href="/assets/js/224.c86c18c6.js"><link rel="prefetch" href="/assets/js/225.b0dcf86e.js"><link rel="prefetch" href="/assets/js/226.02cc2999.js"><link rel="prefetch" href="/assets/js/227.8474ef5a.js"><link rel="prefetch" href="/assets/js/228.0298e421.js"><link rel="prefetch" href="/assets/js/229.6aeaf595.js"><link rel="prefetch" href="/assets/js/23.9995fce4.js"><link rel="prefetch" href="/assets/js/230.a5785286.js"><link rel="prefetch" href="/assets/js/231.d791daa4.js"><link rel="prefetch" href="/assets/js/232.97aeeb00.js"><link rel="prefetch" href="/assets/js/233.46e51e28.js"><link rel="prefetch" href="/assets/js/234.2cffe82f.js"><link rel="prefetch" href="/assets/js/235.14965da6.js"><link rel="prefetch" href="/assets/js/236.00a5afc0.js"><link rel="prefetch" href="/assets/js/237.3b73d52f.js"><link rel="prefetch" href="/assets/js/238.6e1db765.js"><link rel="prefetch" href="/assets/js/239.75866c5e.js"><link rel="prefetch" href="/assets/js/24.9141eeb2.js"><link rel="prefetch" href="/assets/js/240.af9c2cc9.js"><link rel="prefetch" href="/assets/js/241.388acab2.js"><link rel="prefetch" href="/assets/js/242.c60f2b48.js"><link rel="prefetch" href="/assets/js/243.d8e81b13.js"><link rel="prefetch" href="/assets/js/244.58b0b21d.js"><link rel="prefetch" href="/assets/js/245.c3768497.js"><link rel="prefetch" href="/assets/js/246.ac8bbe7a.js"><link rel="prefetch" href="/assets/js/247.d095f70a.js"><link rel="prefetch" href="/assets/js/248.e9f210b5.js"><link rel="prefetch" href="/assets/js/249.a9fad023.js"><link rel="prefetch" href="/assets/js/25.98e8593e.js"><link rel="prefetch" href="/assets/js/250.ae7f0ebb.js"><link rel="prefetch" href="/assets/js/251.9a617d55.js"><link rel="prefetch" href="/assets/js/252.ce082446.js"><link rel="prefetch" href="/assets/js/253.4575302d.js"><link rel="prefetch" href="/assets/js/254.5899a61b.js"><link rel="prefetch" href="/assets/js/255.66c69f31.js"><link rel="prefetch" href="/assets/js/256.8fd6c706.js"><link rel="prefetch" href="/assets/js/257.31b77e5e.js"><link rel="prefetch" href="/assets/js/258.eba48891.js"><link rel="prefetch" href="/assets/js/259.edf74b59.js"><link rel="prefetch" href="/assets/js/26.e69924ea.js"><link rel="prefetch" href="/assets/js/260.cf2ed36d.js"><link rel="prefetch" href="/assets/js/261.9e7792d8.js"><link rel="prefetch" href="/assets/js/262.e7b9433e.js"><link rel="prefetch" href="/assets/js/263.1185b25c.js"><link rel="prefetch" href="/assets/js/264.5e0f89cb.js"><link rel="prefetch" href="/assets/js/265.a38d3b94.js"><link rel="prefetch" href="/assets/js/266.2ef170b3.js"><link rel="prefetch" href="/assets/js/267.a7d14651.js"><link rel="prefetch" href="/assets/js/268.05b18748.js"><link rel="prefetch" href="/assets/js/269.dad48d6f.js"><link rel="prefetch" href="/assets/js/27.13612515.js"><link rel="prefetch" href="/assets/js/270.4f5a6b8d.js"><link rel="prefetch" href="/assets/js/271.7ebf6682.js"><link rel="prefetch" href="/assets/js/272.7c2fbfd1.js"><link rel="prefetch" href="/assets/js/273.8ee20732.js"><link rel="prefetch" href="/assets/js/274.d525242a.js"><link rel="prefetch" href="/assets/js/275.a8a19acb.js"><link rel="prefetch" href="/assets/js/276.df3a4eb4.js"><link rel="prefetch" href="/assets/js/277.336debda.js"><link rel="prefetch" href="/assets/js/278.c470625f.js"><link rel="prefetch" href="/assets/js/279.a91e1a64.js"><link rel="prefetch" href="/assets/js/28.ab7ae1df.js"><link rel="prefetch" href="/assets/js/280.87e25c9a.js"><link rel="prefetch" href="/assets/js/281.87c1ba25.js"><link rel="prefetch" href="/assets/js/282.dcd4dce0.js"><link rel="prefetch" href="/assets/js/283.abac2e00.js"><link rel="prefetch" href="/assets/js/284.f6079659.js"><link rel="prefetch" href="/assets/js/285.f1b39879.js"><link rel="prefetch" href="/assets/js/286.f6a79242.js"><link rel="prefetch" href="/assets/js/287.06bebe07.js"><link rel="prefetch" href="/assets/js/288.89e325df.js"><link rel="prefetch" href="/assets/js/289.3aa1bedd.js"><link rel="prefetch" href="/assets/js/29.ebe50f76.js"><link rel="prefetch" href="/assets/js/290.ee059c92.js"><link rel="prefetch" href="/assets/js/291.fa9a921a.js"><link rel="prefetch" href="/assets/js/292.2a8811cd.js"><link rel="prefetch" href="/assets/js/293.eec09cdf.js"><link rel="prefetch" href="/assets/js/294.dfac20dc.js"><link rel="prefetch" href="/assets/js/295.825d2070.js"><link rel="prefetch" href="/assets/js/296.f645861e.js"><link rel="prefetch" href="/assets/js/297.424fdb17.js"><link rel="prefetch" href="/assets/js/298.ebf87cdc.js"><link rel="prefetch" href="/assets/js/299.b8f19cbb.js"><link rel="prefetch" href="/assets/js/30.75237511.js"><link rel="prefetch" href="/assets/js/300.10fb6d4f.js"><link rel="prefetch" href="/assets/js/301.ef77c612.js"><link rel="prefetch" href="/assets/js/302.1b839763.js"><link rel="prefetch" href="/assets/js/303.609f7d98.js"><link rel="prefetch" href="/assets/js/304.1d255f19.js"><link rel="prefetch" href="/assets/js/305.b0234f2c.js"><link rel="prefetch" href="/assets/js/306.48677f64.js"><link rel="prefetch" href="/assets/js/307.14390d4b.js"><link rel="prefetch" href="/assets/js/308.fa730b28.js"><link rel="prefetch" href="/assets/js/309.0496b9e0.js"><link rel="prefetch" href="/assets/js/31.cf3f471a.js"><link rel="prefetch" href="/assets/js/310.a31676dc.js"><link rel="prefetch" href="/assets/js/311.ed53adc5.js"><link rel="prefetch" href="/assets/js/312.1b0ff2f1.js"><link rel="prefetch" href="/assets/js/313.bf123f32.js"><link rel="prefetch" href="/assets/js/314.4e6ce06b.js"><link rel="prefetch" href="/assets/js/315.8eb18560.js"><link rel="prefetch" href="/assets/js/32.74fef842.js"><link rel="prefetch" href="/assets/js/33.bc2d190b.js"><link rel="prefetch" href="/assets/js/34.d23438fc.js"><link rel="prefetch" href="/assets/js/35.7675c4d0.js"><link rel="prefetch" href="/assets/js/36.96a4161b.js"><link rel="prefetch" href="/assets/js/37.d1824f2f.js"><link rel="prefetch" href="/assets/js/38.4effff9e.js"><link rel="prefetch" href="/assets/js/39.6509914b.js"><link rel="prefetch" href="/assets/js/4.4d01750f.js"><link rel="prefetch" href="/assets/js/40.1509d08b.js"><link rel="prefetch" href="/assets/js/41.f2c1124f.js"><link rel="prefetch" href="/assets/js/42.e541d077.js"><link rel="prefetch" href="/assets/js/43.369de999.js"><link rel="prefetch" href="/assets/js/44.43959db0.js"><link rel="prefetch" href="/assets/js/45.282fbd31.js"><link rel="prefetch" href="/assets/js/46.1b83cfe9.js"><link rel="prefetch" href="/assets/js/47.c3a88e41.js"><link rel="prefetch" href="/assets/js/48.bc7c0a1b.js"><link rel="prefetch" href="/assets/js/49.92a4e5ba.js"><link rel="prefetch" href="/assets/js/5.c3991e24.js"><link rel="prefetch" href="/assets/js/50.9c488c6c.js"><link rel="prefetch" href="/assets/js/51.546ea632.js"><link rel="prefetch" href="/assets/js/52.0d2ccee1.js"><link rel="prefetch" href="/assets/js/53.6f52b5b1.js"><link rel="prefetch" href="/assets/js/54.c838b295.js"><link rel="prefetch" href="/assets/js/55.13af99ee.js"><link rel="prefetch" href="/assets/js/56.6be6d1ed.js"><link rel="prefetch" href="/assets/js/57.67c98b39.js"><link rel="prefetch" href="/assets/js/58.107e82ec.js"><link rel="prefetch" href="/assets/js/59.b3e5edc7.js"><link rel="prefetch" href="/assets/js/6.36a535f9.js"><link rel="prefetch" href="/assets/js/60.3b0b4ba5.js"><link rel="prefetch" href="/assets/js/61.3df843df.js"><link rel="prefetch" href="/assets/js/62.1213823d.js"><link rel="prefetch" href="/assets/js/63.e8f3f926.js"><link rel="prefetch" href="/assets/js/64.e1219050.js"><link rel="prefetch" href="/assets/js/65.5bf5bb0b.js"><link rel="prefetch" href="/assets/js/66.a2502afb.js"><link rel="prefetch" href="/assets/js/67.690dd59b.js"><link rel="prefetch" href="/assets/js/68.de7b0915.js"><link rel="prefetch" href="/assets/js/69.ac61dd61.js"><link rel="prefetch" href="/assets/js/7.5d254238.js"><link rel="prefetch" href="/assets/js/70.3edd41b1.js"><link rel="prefetch" href="/assets/js/71.d23407e9.js"><link rel="prefetch" href="/assets/js/72.a5bd01bc.js"><link rel="prefetch" href="/assets/js/73.c9f4dd57.js"><link rel="prefetch" href="/assets/js/74.66323fc1.js"><link rel="prefetch" href="/assets/js/75.e1a72e00.js"><link rel="prefetch" href="/assets/js/76.801268b4.js"><link rel="prefetch" href="/assets/js/77.3a5fda67.js"><link rel="prefetch" href="/assets/js/78.54d84cd4.js"><link rel="prefetch" href="/assets/js/79.fa10f4e3.js"><link rel="prefetch" href="/assets/js/8.e060e47d.js"><link rel="prefetch" href="/assets/js/80.d5b24fea.js"><link rel="prefetch" href="/assets/js/81.0e9da714.js"><link rel="prefetch" href="/assets/js/82.e96ff6d7.js"><link rel="prefetch" href="/assets/js/83.771cced1.js"><link rel="prefetch" href="/assets/js/84.220b69e7.js"><link rel="prefetch" href="/assets/js/85.7dcc5659.js"><link rel="prefetch" href="/assets/js/86.44ba2100.js"><link rel="prefetch" href="/assets/js/87.281da75d.js"><link rel="prefetch" href="/assets/js/88.12d88449.js"><link rel="prefetch" href="/assets/js/89.f28c86d3.js"><link rel="prefetch" href="/assets/js/9.8f9fef32.js"><link rel="prefetch" href="/assets/js/90.715cabb2.js"><link rel="prefetch" href="/assets/js/91.6ced7c82.js"><link rel="prefetch" href="/assets/js/92.c05b33ca.js"><link rel="prefetch" href="/assets/js/93.6bf5fb66.js"><link rel="prefetch" href="/assets/js/94.3561200e.js"><link rel="prefetch" href="/assets/js/95.0f2cf716.js"><link rel="prefetch" href="/assets/js/96.ac8487ea.js"><link rel="prefetch" href="/assets/js/97.48042b5a.js"><link rel="prefetch" href="/assets/js/98.441bb7f8.js"><link rel="prefetch" href="/assets/js/99.4b214d92.js">
    <link rel="stylesheet" href="/assets/css/0.styles.56073ad3.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu"><header class="navbar blur"><div title="ç›®å½•" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/img/magic.png" alt="Pangolin Note" class="logo"> <span class="site-name can-hide">Pangolin Note</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">ğŸ¡é¦–é¡µ</a></div><div class="nav-item"><a href="/basic/" class="nav-link">åŸºç¡€</a></div><div class="nav-item"><a href="/develop/" class="nav-link">å¼€å‘</a></div><div class="nav-item"><a href="/middleware/" class="nav-link">ç³»ç»Ÿ</a></div><div class="nav-item"><a href="/algorithm/" class="nav-link">ç®—æ³•</a></div><div class="nav-item"><a href="/books/" class="nav-link">ğŸ€è¯»ä¹¦ç¬”è®°</a></div><div class="nav-item"><a href="/work/" class="nav-link">å·¥ä½œ</a></div><div class="nav-item"><a href="/pangolin/" class="nav-link">ğŸŒ¸è¾¾å°”æ–‡çš„çŒ¹</a></div><div class="nav-item"><a href="/pages/beb6c0bd8a66cea6/" class="nav-link">æ”¶è—</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="ç´¢å¼•" class="dropdown-title"><a href="/archives/" class="link-title">ç´¢å¼•</a> <span class="title" style="display:none;">ç´¢å¼•</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">åˆ†ç±»</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">æ ‡ç­¾</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">å½’æ¡£</a></li></ul></div></div> <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><div class="blogger"><img src="/img/avatarnew.png"> <div class="blogger-info"><h3>è¾¾å°”æ–‡çš„çŒ¹</h3> <span>å¤§é“è‡³ç®€ æ‚Ÿåœ¨å¤©æˆ</span></div></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">ğŸ¡é¦–é¡µ</a></div><div class="nav-item"><a href="/basic/" class="nav-link">åŸºç¡€</a></div><div class="nav-item"><a href="/develop/" class="nav-link">å¼€å‘</a></div><div class="nav-item"><a href="/middleware/" class="nav-link">ç³»ç»Ÿ</a></div><div class="nav-item"><a href="/algorithm/" class="nav-link">ç®—æ³•</a></div><div class="nav-item"><a href="/books/" class="nav-link">ğŸ€è¯»ä¹¦ç¬”è®°</a></div><div class="nav-item"><a href="/work/" class="nav-link">å·¥ä½œ</a></div><div class="nav-item"><a href="/pangolin/" class="nav-link">ğŸŒ¸è¾¾å°”æ–‡çš„çŒ¹</a></div><div class="nav-item"><a href="/pages/beb6c0bd8a66cea6/" class="nav-link">æ”¶è—</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="ç´¢å¼•" class="dropdown-title"><a href="/archives/" class="link-title">ç´¢å¼•</a> <span class="title" style="display:none;">ç´¢å¼•</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">åˆ†ç±»</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">æ ‡ç­¾</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">å½’æ¡£</a></li></ul></div></div> <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>ç³»ç»Ÿ</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading"><span>åˆ†å¸ƒå¼ç³»ç»Ÿç†è®º</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/129626/" class="sidebar-link">åˆ†å¸ƒå¼ç³»ç»ŸåŸºç¡€</a></li><li><a href="/pages/fb5d35/" class="sidebar-link">åˆ†å¸ƒå¼å…±è¯†ç®—æ³•</a></li><li><a href="/pages/12ac37/" class="sidebar-link">åˆ†å¸ƒå¼ç³»ç»Ÿç»„ä»¶</a></li><li><a href="/pages/d03ebf/" class="sidebar-link">åˆ†å¸ƒå¼æŠ€æœ¯åŸç†ä¸ç®—æ³•è§£æ(æå®¢æ—¶é—´)ğŸŒ¸</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading open"><span>ç³»ç»Ÿæ¥å…¥å±‚</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/f1b6c4/" class="sidebar-link">NginxåŸºç¡€</a></li><li><a href="/pages/d4123d/" class="sidebar-link">æ·±å…¥æ‹†è§£Tomcatä¸Jetty(æå®¢æ—¶é—´)ğŸŒ¸</a></li><li><a href="/pages/baee2f/" aria-current="page" class="active sidebar-link">Netty</a><ul class="sidebar-sub-headers"></ul></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading"><span>æœåŠ¡æ²»ç†-æ³¨å†Œå‘ç°ä¸RPC</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/05077d/" class="sidebar-link">åŸºç¡€</a></li><li><a href="/pages/51b6aa/" class="sidebar-link">RPCå®æˆ˜ä¸æ ¸å¿ƒåŸç†(æå®¢æ—¶é—´)ğŸŒ¸</a></li><li><a href="/pages/0966ee/" class="sidebar-link">Zookeeper</a></li><li><a href="/pages/3b7e05/" class="sidebar-link">Nacos</a></li><li><a href="/pages/7f31f8/" class="sidebar-link">Dubbo</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading"><span>æœåŠ¡æ²»ç†-æµé‡æ§åˆ¶</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/44bfa8/" class="sidebar-link">è´Ÿè½½å‡è¡¡</a></li><li><a href="/pages/4d5a6c/" class="sidebar-link">é™æµ</a></li><li><a href="/pages/e0c561/" class="sidebar-link">ç†”æ–­</a></li><li><a href="/pages/12ae40/" class="sidebar-link">ç½‘å…³è·¯ç”±</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading"><span>æœåŠ¡æ²»ç†-ç³»ç»Ÿç›‘æ§ä¸å®‰å…¨</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/8c9210/" class="sidebar-link">ç³»ç»Ÿå®‰å…¨æ€§</a></li><li><a href="/pages/c9bf40/" class="sidebar-link">ç³»ç»Ÿç›‘æ§ç»„ä»¶</a></li><li><a href="/pages/3f3cf7/" class="sidebar-link">è¿ç»´ç›‘æ§ç³»ç»Ÿå®æˆ˜(æå®¢æ—¶é—´)ğŸŒ¸</a></li><li><a href="/pages/e20e02/" class="sidebar-link">OAuth2.0å®æˆ˜è¯¾(æå®¢æ—¶é—´)ğŸŒŸ</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading"><span>ä¸­é—´ä»¶-æ¶ˆæ¯é˜Ÿåˆ—</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/96d94c/" class="sidebar-link">æ¶ˆæ¯é˜Ÿåˆ—åŸºç¡€</a></li><li><a href="/pages/abf16c/" class="sidebar-link">RabbitMQ</a></li><li><a href="/pages/4fc3f1/" class="sidebar-link">Kafka</a></li><li><a href="/pages/013cfe/" class="sidebar-link">RocketMQ</a></li><li><a href="/pages/ed8d92/" class="sidebar-link">Disruptor</a></li><li><a href="/pages/249149/" class="sidebar-link">æ¶ˆæ¯é˜Ÿåˆ—é«˜æ‰‹è¯¾(æå®¢æ—¶é—´)ğŸŒŸ</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading"><span>ä¸­é—´ä»¶-ç¼“å­˜</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/946847/" class="sidebar-link">ç¼“å­˜åŸºç¡€</a></li><li><a href="/pages/e46d56/" class="sidebar-link">æœ¬åœ°ç¼“å­˜</a></li><li><a href="/pages/0abfb9/" class="sidebar-link">RedisåŸºç¡€</a></li><li><a href="/pages/09236a/" class="sidebar-link">RedisæŒä¹…åŒ–</a></li><li><a href="/pages/867f9b/" class="sidebar-link">Redisä¸»ä»å¤åˆ¶</a></li><li><a href="/pages/50cae1/" class="sidebar-link">Rediså“¨å…µ</a></li><li><a href="/pages/43b45c/" class="sidebar-link">Redisé›†ç¾¤</a></li><li><a href="/pages/a32379/" class="sidebar-link">Rediså†…å­˜ç®¡ç†ä¸è¿ç»´</a></li><li><a href="/pages/386037/" class="sidebar-link">Redisæ ¸å¿ƒæŠ€æœ¯ä¸å®æˆ˜(æå®¢æ—¶é—´)ğŸŒ¸</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading"><span>ä¸­é—´ä»¶-å…¶ä»–</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/23044d/" class="sidebar-link">å®šæ—¶ä»»åŠ¡-XXLJob</a></li><li><a href="/pages/459117/" class="sidebar-link">ESä¸æ£€ç´¢</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading"><span>ç³»ç»Ÿè®¾è®¡ä¸ä¼˜åŒ–</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/41a845/" class="sidebar-link">å‡¤å‡°æ¶æ„</a></li><li><a href="/pages/68cc0b/" class="sidebar-link">å·¦è€³å¬é£(æå®¢æ—¶é—´)ğŸŒŸ</a></li><li><a href="/pages/e3e99c/" class="sidebar-link">ä»0å¼€å§‹å­¦å¾®æœåŠ¡(æå®¢æ—¶é—´)ğŸŒ¸</a></li><li><a href="/pages/1e5368/" class="sidebar-link">é«˜å¹¶å‘ç³»ç»Ÿè®¾è®¡40é—®(æå®¢æ—¶é—´)ğŸŒ¸</a></li><li><a href="/pages/33599f/" class="sidebar-link">ç³»ç»Ÿæ€§èƒ½è°ƒä¼˜å¿…çŸ¥å¿…ä¼š(æå®¢æ—¶é—´)ğŸŒ¸</a></li><li><a href="/pages/c83472/" class="sidebar-link">åç«¯æŠ€æœ¯é¢è¯•38è®²(æå®¢æ—¶é—´)</a></li><li><a href="/pages/4404b6/" class="sidebar-link">æ¶æ„å®æˆ˜æ¡ˆä¾‹è§£æ(æå®¢æ—¶é—´)ğŸŒ¸</a></li><li><a href="/pages/8f1c1d/" class="sidebar-link">å¦‚ä½•è®¾è®¡ä¸€ä¸ªç§’æ€ç³»ç»Ÿ(æå®¢æ—¶é—´)</a></li></ul></section></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>å®¹å™¨</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading open"><span>å®¹å™¨</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/582acf/" class="sidebar-link">éƒ¨ç½²Minikube</a></li><li><a href="/pages/98e5e4/" class="sidebar-link">å®¹å™¨å®æˆ˜é«˜æ‰‹è¯¾(æå®¢æ—¶é—´)ğŸŒ¸</a></li><li><a href="/pages/c6a42c/" class="sidebar-link">Kuberneteså®æˆ˜ğŸŒ¸</a></li><li><a href="/pages/f35c72/" class="sidebar-link">æ·±å…¥å‰–æKubernetes(æå®¢æ—¶é—´)ğŸŒ¸</a></li><li><a href="/pages/caa314/" class="sidebar-link">Istio</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading"><span>è‡ªåŠ¨åŒ–è¿ç»´</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/beb97f/" class="sidebar-link">æŒç»­é›†æˆ(CICD)</a></li><li><a href="/pages/a0df2d/" class="sidebar-link">DevOps</a></li><li><a href="/pages/765815/" class="sidebar-link">SREå®æˆ˜æ‰‹å†Œ(æå®¢æ—¶é—´)</a></li></ul></section></li></ul></section></li></ul> </aside> <div><main class="page"><div class="theme-vdoing-wrapper "><div class="articleInfo-wrap" data-v-06970110><div class="articleInfo" data-v-06970110><ul class="breadcrumbs" data-v-06970110><li data-v-06970110><a href="/" title="é¦–é¡µ" class="iconfont icon-home router-link-active" data-v-06970110></a></li> <li data-v-06970110><a href="/middleware/#ç³»ç»Ÿ" data-v-06970110>ç³»ç»Ÿ</a></li><li data-v-06970110><a href="/middleware/#ç³»ç»Ÿ" data-v-06970110>ç³»ç»Ÿ</a></li><li data-v-06970110><a href="/middleware/#ç³»ç»Ÿæ¥å…¥å±‚" data-v-06970110>ç³»ç»Ÿæ¥å…¥å±‚</a></li></ul> <div class="info" data-v-06970110><div title="ä½œè€…" class="author iconfont icon-touxiang" data-v-06970110><a href="https://github.com/nanodaemony" target="_blank" title="ä½œè€…" class="beLink" data-v-06970110>NanoDaemony</a></div> <div title="åˆ›å»ºæ—¶é—´" class="date iconfont icon-riqi" data-v-06970110><a href="javascript:;" data-v-06970110>2025-02-26</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-title">æœ¬æ–‡ç›®å½•</div> <div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABH1JREFUSA3tVl1oHFUUPmdmd2ltklqbpJDiNnXFmgbFktho7YMPNiJSSZM0+CAYSkUELVhM6YuwIPpgoOKDqOBDC0XE2CQoNtQXBUFTTcCi+Wlh1V2TQExsUzcltd3M9Tt3ZjZzZ2fT+OJTL8yeM+eee757fmeJbq//KQL8X3DUSFOcfr7cRsRtxNQMWueeVzOkaITIGqQHNg5y8+jNW9ldM7A6nTpAjuolUikAwq7CE3WcM2RRDz+XGVgN3FptU/aUSlvq9Pa3iZ1+sgAqJyyAFqkipd9dqiwHF3P65YycLWc/6sqGrvoEoIp6DOFaX5h6+dnfjkWprwqsPk0dUGq5vySwDImC10KxFHgGL1SWoc92O3eVht09qdXNH11I2SsTsJYqMWzihqGMi+A+Garf3BAuuLI5oGlULyNfyB/HYNujwktOfRrMr5t77NmevqaUopx0grnKAyvVpmwUDB4x6FPXuGvYLTDwWsejwgtgkYKPqRJg8SV6xaiZ3ZTppGneS4yfH5/66fZSDHv+QZci/+h5c5UHtpy67JUqGppM0sh0Nc1dW6/N1W5Yoqat8/TU/VnadmdeW2PLLSyh0cvxBs3KbqTmwYPpxN4do/mzE8nEpvX/UMu2Wbp74zUAK5q6WkHns7V0eWkdPbPzd3rxkTGybadYySumVzhcaJFbs5UrEkQ/+CK8gF5dnh/6ciIZ73gwQ927L1IitoxKLXYP3SjYdOrHHfTZhRRlFyrorafPk20B3HPD1y2G3qKZME5Jcf3t/HUC13/8tSd++vqFveMUTwAUxSUFI1QekR1+bIze3D9MF2aq6cPvG72CgnldWCFqyRw3lwH8ZMerjTD9ElRO7Gv44wNpC90aASqGfVlz/Rx17srQ57/UU26hkhQqUB7dBR71WmzQhHUnblGmVOEw0jhbV1n9OlXUDCIRGaNV5Jp43N516fN7JmnTHdfp7Hgy0luO4aMhtkLL8Bi3bUWYvzh5Mn1dTxrL6QmGuRhGL/TiTTxRoEdTszSaq9GR0NGA3KdkOz3hqSV3MIDhQ5IVX/Ivx3umBti2es2h4eZby7x8br1rkf7Mo90AqC8aQ3sJeNzqFRu+vSANAQe3PL7l0HGOAdwDCeZYvNKeoZp1Qfs6Aipndh86HmFRi0LAnEO47wsqM6cdfjh3jBPUzhZy7nvlUfFsamED1VQt6aISHVymXZ/B2aCtIG8AI8xfobj2d3en1wWVhOeHELKmLQ1s211s88comkv4UCwWyF787mJdYXtNfhKAXVqnKTq8QZvGAGGOfaTo5pGZ/PwbUCr5+DPr/1J92JNHr9aOl/F3iI5+O1nfybsGxoimvZ3ViWSluDITw3P37mypheDIPY0tw7+O/5ApbkYw+zpfaUVu32Pi98+defdUhEpZkRFq0aqyNh9FuL9hpYbEm6iwi0z2REd09ZmyENEbuhjDWzKvZXTqKYaBIr3tt5kuPtQBZFvEUwHt60vfCNu41XsksH9Ij1BMMz1Y0OOunHNShFIP5868g5zeXmuLwL9T4b6Q2+KejgAAAABJRU5ErkJggg==">Netty<!----></h1>  <div class="theme-vdoing-content content__default"><h1 id="_300-netty"><a href="#_300-netty" class="header-anchor">#</a> 300.Netty</h1> <h4 id="nettyåŸºç¡€"><a href="#nettyåŸºç¡€" class="header-anchor">#</a> NettyåŸºç¡€</h4> <h5 id="_1-æ¦‚è¿°"><a href="#_1-æ¦‚è¿°" class="header-anchor">#</a> 1.æ¦‚è¿°</h5> <p>Netty æ˜¯ä¸€ä¸ª<strong>å¼‚æ­¥çš„äº‹ä»¶é©±åŠ¨</strong>çš„ç½‘ç»œåº”ç”¨æ¡†æ¶. Java åŸç”Ÿçš„ NIO çš„åº“ä½¿ç”¨éå¸¸ååˆ†éº»çƒ¦, é™¤ä¸šåŠ¡ä»£ç å¤–è¿˜éœ€è¦è€ƒè™‘å¤„ç†æ–­çº¿é‡è¿, ç½‘ç»œé—ªæ–­, åŠåŒ…è¯»å†™, ç½‘ç»œæ‹¥å¡å’Œå¼‚å¸¸æµç­‰. <strong>Netty é€šè¿‡å¯¹ NIO çš„ API è¿›è¡Œäº†è‰¯å¥½çš„å°è£…</strong>, è§£å†³äº†ä¸Šè¿°é—®é¢˜.</p> <p>Netty å…·æœ‰é«˜æ€§èƒ½, é«˜ååé‡, ä½å»¶è¿Ÿ, èµ„æºæ¶ˆè€—å°‘ç­‰ä¼˜ç‚¹.</p> <h5 id="_2-nettyä½¿ç”¨åœºæ™¯"><a href="#_2-nettyä½¿ç”¨åœºæ™¯" class="header-anchor">#</a> 2.Nettyä½¿ç”¨åœºæ™¯</h5> <p>ä¸€äº›å¸¸è§åº”ç”¨åœºæ™¯:</p> <ul><li><strong>RPC æ¡†æ¶</strong>: ä½œä¸ºå¼‚æ­¥é«˜æ€§èƒ½çš„é€šä¿¡æ¡†æ¶, Netty è¢«ä¸€äº› RPC æ¡†æ¶é€‰ç”¨ä¸ºå…¶åŸºç¡€é€šä¿¡ç»„ä»¶. å…¸å‹çš„åº”ç”¨æœ‰: <strong>Dubbo, RocketMQ</strong>, Hadoop çš„ Avro ç­‰.</li> <li>å¤šäººèŠå¤©å®¤, æ¸¸æˆæœåŠ¡å™¨ç­‰è¿æ¥æ•°è¦æ±‚è¾ƒå¤šçš„åœºæ™¯.</li> <li>åŸºäº WebSocket ä¸ Netty çš„å¼¹å¹•ç³»ç»Ÿ. å¼¹å¹•ç³»ç»Ÿç‰¹ç‚¹: å®æ—¶æ€§é«˜, å¹¶å‘é‡å¤§, å¯¹æ•°æ®ä¸€è‡³æ€§è¦æ±‚å¹¶ä¸é«˜. é‡‡ç”¨ HTTP è½®è¯¢æœåŠ¡å™¨å¹¶ä¸å¥½, å› æ­¤å¯ä»¥é‡‡ç”¨ Netty å®ç°.</li> <li>Netty ä¹Ÿèƒ½å½“åš HTTP æœåŠ¡å™¨, ä½¿ç”¨ <strong>HTTP ç›¸å…³çš„ç¼–è§£ç å™¨</strong>å’Œå¤„ç†çš„ Handler è¿›è¡Œå¤„ç†å³å¯.</li> <li>Netty ç›¸å…³å¼€æºé¡¹ç›®: <a href="https://netty.io/wiki/related-projects.html" target="_blank" rel="noopener noreferrer">https://netty.io/wiki/related-projects.html<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul> <h5 id="_3-åº”ç”¨ç¤ºä¾‹"><a href="#_3-åº”ç”¨ç¤ºä¾‹" class="header-anchor">#</a> 3.åº”ç”¨ç¤ºä¾‹</h5> <h6 id="nettyå®¢æˆ·ç«¯æœåŠ¡ç«¯åŸºæœ¬å®ç°"><a href="#nettyå®¢æˆ·ç«¯æœåŠ¡ç«¯åŸºæœ¬å®ç°" class="header-anchor">#</a> Nettyå®¢æˆ·ç«¯æœåŠ¡ç«¯åŸºæœ¬å®ç°</h6> <p>ä¸Šé¢ä»‹ç»äº† Netty çš„æ•´ä½“æ¡†æ¶, è¿™é‡Œå…ˆçœ‹ä¸€ä¸ªåŸºäº Netty å®ç°çš„æœåŠ¡å™¨å’Œå®¢æˆ·ç«¯é€šä¿¡çš„ demo, ä»¥ä¾¿å¯¹ Netty ç”¨æ³•æœ‰ä¸ªæ„ŸçŸ¥.</p> <p>Netty çš„ä¾èµ–:</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>io.netty<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>netty-all<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>4.1.35.Final<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p><strong>æœåŠ¡ç«¯å®ç°</strong>:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">NettyServer</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token comment">// åˆ›å»ºä¸¤ä¸ªçº¿ç¨‹ç»„bossGroupå’ŒworkerGroup, å«æœ‰çš„å­çº¿ç¨‹NioEventLoopçš„ä¸ªæ•°é»˜è®¤ä¸ºcpuæ ¸æ•°çš„ä¸¤å€</span>
        <span class="token comment">// bossGroupåªæ˜¯å¤„ç†è¿æ¥è¯·æ±‚ ,çœŸæ­£çš„å’Œå®¢æˆ·ç«¯ä¸šåŠ¡å¤„ç†, ä¼šäº¤ç»™workerGroupå®Œæˆ</span>
        <span class="token class-name">EventLoopGroup</span> bossGroup <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NioEventLoopGroup</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// è¿™é‡Œè®¾ç½®æœ‰10ä¸ªSelector</span>
        <span class="token class-name">EventLoopGroup</span> workerGroup <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NioEventLoopGroup</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">// åˆ›å»ºæœåŠ¡å™¨ç«¯çš„å¯åŠ¨å¯¹è±¡</span>
            <span class="token class-name">ServerBootstrap</span> bootstrap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ServerBootstrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// è®¾ç½®ä¸¤ä¸ªçº¿ç¨‹ç»„</span>
            bootstrap<span class="token punctuation">.</span><span class="token function">group</span><span class="token punctuation">(</span>bossGroup<span class="token punctuation">,</span> workerGroup<span class="token punctuation">)</span>
                <span class="token comment">// ä½¿ç”¨NioServerSocketChannelä½œä¸ºæœåŠ¡å™¨çš„é€šé“å®ç°</span>
                <span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token class-name">NioServerSocketChannel</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
                <span class="token comment">// åˆå§‹åŒ–æœåŠ¡å™¨è¿æ¥é˜Ÿåˆ—å¤§å°, æœåŠ¡ç«¯å¤„ç†å®¢æˆ·ç«¯è¿æ¥è¯·æ±‚æ˜¯é¡ºåºå¤„ç†çš„,æ‰€ä»¥åŒä¸€æ—¶é—´åªèƒ½å¤„ç†ä¸€ä¸ªå®¢æˆ·ç«¯è¿æ¥. </span>
                <span class="token comment">// å¤šä¸ªå®¢æˆ·ç«¯åŒæ—¶æ¥çš„æ—¶å€™,æœåŠ¡ç«¯å°†ä¸èƒ½å¤„ç†çš„å®¢æˆ·ç«¯è¿æ¥è¯·æ±‚æ”¾åœ¨é˜Ÿåˆ—ä¸­ç­‰å¾…å¤„ç†</span>
                <span class="token punctuation">.</span><span class="token function">option</span><span class="token punctuation">(</span><span class="token class-name">ChannelOption</span><span class="token punctuation">.</span><span class="token constant">SO_BACKLOG</span><span class="token punctuation">,</span> <span class="token number">1024</span><span class="token punctuation">)</span>
                <span class="token comment">// åˆ›å»ºé€šé“åˆå§‹åŒ–å¯¹è±¡, è®¾ç½®åˆå§‹åŒ–å‚æ•° è¿™ä¸ªSocketChannelæ˜¯Nettyé‡Œé¢çš„, ä¸æ˜¯NIOé‡Œé¢é‚£ä¸ª</span>
                <span class="token punctuation">.</span><span class="token function">childHandler</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ChannelInitializer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SocketChannel</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">// å¯ä»¥æŠŠä¸‹é¢çš„ç†è§£ä¸ºä¸€ä¸ªå›è°ƒå‡½æ•°</span>
                    <span class="token annotation punctuation">@Override</span>
                    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">initChannel</span><span class="token punctuation">(</span><span class="token class-name">SocketChannel</span> ch<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
                        <span class="token comment">// å¯¹workerGroupçš„SocketChannelè®¾ç½®å¤„ç†å™¨</span>
                        ch<span class="token punctuation">.</span><span class="token function">pipeline</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">NettyServerHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Netty server start. . &quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// ç»‘å®šä¸€ä¸ªç«¯å£å¹¶ä¸”åŒæ­¥, ç”Ÿæˆäº†ä¸€ä¸ªChannelFutureå¼‚æ­¥å¯¹è±¡, é€šè¿‡isDone()ç­‰æ–¹æ³•å¯ä»¥åˆ¤æ–­å¼‚æ­¥äº‹ä»¶çš„æ‰§è¡Œæƒ…å†µ</span>
            <span class="token comment">// å¯åŠ¨æœåŠ¡å™¨(å¹¶ç»‘å®šç«¯å£), bindæ˜¯å¼‚æ­¥æ“ä½œ, syncæ–¹æ³•æ˜¯ç­‰å¾…å¼‚æ­¥æ“ä½œæ‰§è¡Œå®Œæ¯•</span>
            <span class="token class-name">ChannelFuture</span> cf <span class="token operator">=</span> bootstrap<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token number">9000</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// ç»™cfæ³¨å†Œç›‘å¬å™¨, ç›‘å¬å…³å¿ƒçš„äº‹ä»¶</span>
            <span class="token comment">/** cf.addListener(new ChannelFutureListener() {
                @Override
                public void operationComplete(ChannelFuture future) throws Exception {
                    if (cf.isSuccess()) {
                        System.out.println(&quot;ç›‘å¬ç«¯å£9000æˆåŠŸ&quot;);
                    } else {
                        System.out.println(&quot;ç›‘å¬ç«¯å£9000å¤±è´¥&quot;);
                    }
                }
            });*/</span>
            <span class="token comment">// å¯¹é€šé“å…³é—­è¿›è¡Œç›‘å¬, closeFutureæ˜¯å¼‚æ­¥æ“ä½œ, ç›‘å¬é€šé“å…³é—­</span>
            <span class="token comment">// é€šè¿‡syncæ–¹æ³•åŒæ­¥ç­‰å¾…é€šé“å…³é—­å¤„ç†å®Œæ¯•, è¿™é‡Œä¼šé˜»å¡ç­‰å¾…é€šé“å…³é—­å®Œæˆ</span>
            cf<span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">closeFuture</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            bossGroup<span class="token punctuation">.</span><span class="token function">shutdownGracefully</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            workerGroup<span class="token punctuation">.</span><span class="token function">shutdownGracefully</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br></div></div><p>æœåŠ¡ç«¯ Handler:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
 * è‡ªå®šä¹‰Handleréœ€è¦ç»§æ‰¿nettyè§„å®šå¥½çš„æŸä¸ªHandlerAdapter(è§„èŒƒ)
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">NettyServerHandler</span> <span class="token keyword">extends</span> <span class="token class-name">ChannelInboundHandlerAdapter</span> <span class="token punctuation">{</span>

    <span class="token comment">/**
     * è¯»å–å®¢æˆ·ç«¯å‘é€çš„æ•°æ®
     *
     * @param ctx ä¸Šä¸‹æ–‡å¯¹è±¡,å«æœ‰é€šé“channel,ç®¡é“pipeline
     * @param msg å°±æ˜¯å®¢æˆ·ç«¯å‘é€çš„æ•°æ®
     * @throws Exception Exception
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">channelRead</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">,</span> <span class="token class-name">Object</span> msg<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;æœåŠ¡å™¨è¯»å–çº¿ç¨‹ &quot;</span> <span class="token operator">+</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// Channel channel = ctx.channel();</span>
        <span class="token comment">// ChannelPipeline pipeline = ctx.pipeline(); // æœ¬è´¨æ˜¯ä¸€ä¸ªåŒå‘é“¾è¡¨</span>
        <span class="token comment">// å°†msgè½¬æˆä¸€ä¸ªByteBuf, ç±»ä¼¼NIOçš„ByteBuffer</span>
        <span class="token class-name">ByteBuf</span> buf <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">ByteBuf</span><span class="token punctuation">)</span> msg<span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;å®¢æˆ·ç«¯å‘é€æ¶ˆæ¯æ˜¯:&quot;</span> <span class="token operator">+</span> buf<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token class-name">CharsetUtil</span><span class="token punctuation">.</span><span class="token constant">UTF_8</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * æ•°æ®è¯»å–å®Œæ¯•å¤„ç†æ–¹æ³• è¯´æ˜ä¸Šä¸€ä¸ªchannelRead()æ–¹æ³•è¯»å®Œ
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">channelReadComplete</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token comment">// ä¸Šä¸€ä¸ªæ–¹æ³•æ‰§è¡Œå®Œä¹‹åå†™æ•°æ®åˆ°å®¢æˆ·ç«¯</span>
        <span class="token class-name">ByteBuf</span> buf <span class="token operator">=</span> <span class="token class-name">Unpooled</span><span class="token punctuation">.</span><span class="token function">copiedBuffer</span><span class="token punctuation">(</span><span class="token string">&quot;HelloClient&quot;</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token class-name">CharsetUtil</span><span class="token punctuation">.</span><span class="token constant">UTF_8</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        ctx<span class="token punctuation">.</span><span class="token function">writeAndFlush</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * å¤„ç†å¼‚å¸¸, ä¸€èˆ¬éœ€è¦å…³é—­é€šé“
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">exceptionCaught</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">,</span> <span class="token class-name">Throwable</span> cause<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        ctx<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br></div></div><p><strong>å®¢æˆ·ç«¯å®ç°</strong>:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">NettyClient</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token comment">// å®¢æˆ·ç«¯éœ€è¦ä¸€ä¸ªäº‹ä»¶å¾ªç¯ç»„</span>
        <span class="token class-name">EventLoopGroup</span> group <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NioEventLoopGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">// åˆ›å»ºå®¢æˆ·ç«¯å¯åŠ¨å¯¹è±¡</span>
            <span class="token comment">// æ³¨æ„å®¢æˆ·ç«¯ä½¿ç”¨çš„ä¸æ˜¯ServerBootstrapè€Œæ˜¯Bootstrap</span>
            <span class="token class-name">Bootstrap</span> bootstrap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Bootstrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// è®¾ç½®ç›¸å…³å‚æ•° // è®¾ç½®çº¿ç¨‹ç»„</span>
            bootstrap<span class="token punctuation">.</span><span class="token function">group</span><span class="token punctuation">(</span>group<span class="token punctuation">)</span>
                    <span class="token comment">// ä½¿ç”¨NioSocketChannelä½œä¸ºå®¢æˆ·ç«¯çš„é€šé“å®ç°</span>
                    <span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token class-name">NioSocketChannel</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">handler</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ChannelInitializer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SocketChannel</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token annotation punctuation">@Override</span>
                        <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">initChannel</span><span class="token punctuation">(</span><span class="token class-name">SocketChannel</span> ch<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
                            <span class="token comment">// åŠ å…¥å¤„ç†å™¨</span>
                            ch<span class="token punctuation">.</span><span class="token function">pipeline</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">NettyClientHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;netty client start. . &quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// å¯åŠ¨å®¢æˆ·ç«¯å»è¿æ¥æœåŠ¡å™¨ç«¯</span>
            <span class="token class-name">ChannelFuture</span> cf <span class="token operator">=</span> bootstrap<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token string">&quot;127.0.0.1&quot;</span><span class="token punctuation">,</span> <span class="token number">9000</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// å¯¹é€šé“å…³é—­è¿›è¡Œç›‘å¬</span>
            cf<span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">closeFuture</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            group<span class="token punctuation">.</span><span class="token function">shutdownGracefully</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br></div></div><p>å®¢æˆ·ç«¯ Handler:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
 * å®¢æˆ·ç«¯å¤„ç†ç±»
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">NettyClientHandler</span> <span class="token keyword">extends</span> <span class="token class-name">ChannelInboundHandlerAdapter</span> <span class="token punctuation">{</span>

    <span class="token comment">/**
     * å½“å®¢æˆ·ç«¯è¿æ¥æœåŠ¡å™¨å®Œæˆå°±ä¼šè§¦å‘è¯¥æ–¹æ³•
     *
     * @param ctx ä¸Šä¸‹æ–‡
     * @throws Exception Exception
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">channelActive</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">ByteBuf</span> buf <span class="token operator">=</span> <span class="token class-name">Unpooled</span><span class="token punctuation">.</span><span class="token function">copiedBuffer</span><span class="token punctuation">(</span><span class="token string">&quot;HelloServer&quot;</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token class-name">CharsetUtil</span><span class="token punctuation">.</span><span class="token constant">UTF_8</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        ctx<span class="token punctuation">.</span><span class="token function">writeAndFlush</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * å½“é€šé“æœ‰è¯»å–äº‹ä»¶æ—¶ä¼šè§¦å‘, å³æœåŠ¡ç«¯å‘é€æ•°æ®ç»™å®¢æˆ·ç«¯
     *
     * @param ctx ä¸Šä¸‹æ–‡
     * @param msg æ¶ˆæ¯
     * @throws Exception Exception
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">channelRead</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">,</span> <span class="token class-name">Object</span> msg<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">ByteBuf</span> buf <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">ByteBuf</span><span class="token punctuation">)</span> msg<span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;æ”¶åˆ°æœåŠ¡ç«¯çš„æ¶ˆæ¯:&quot;</span> <span class="token operator">+</span> buf<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token class-name">CharsetUtil</span><span class="token punctuation">.</span><span class="token constant">UTF_8</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;æœåŠ¡ç«¯çš„åœ°å€:  &quot;</span> <span class="token operator">+</span> ctx<span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">remoteAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">exceptionCaught</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">,</span> <span class="token class-name">Throwable</span> cause<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        cause<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        ctx<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br></div></div><p>ä»ä¸Šé¢ demo å¯ä»¥çœ‹å‡º, Netty æ¡†æ¶çš„ä½¿ç”¨ä¸ NIO æœ‰å¾ˆå¤§ä¸åŒ, <strong>ç›®æ ‡å°±æ˜¯è®©ä¸šåŠ¡é€»è¾‘ä»ç½‘ç»œåŸºç¡€åº”ç”¨ç¼–ç ä¸­åˆ†ç¦»å‡ºæ¥</strong>, å› æ­¤å¯ä»¥<strong>ä¸“æ³¨ä¸šåŠ¡çš„å¼€å‘</strong>, è€Œä¸éœ€å†™ä¸€å¤§å †ç±»ä¼¼ NIO çš„ç½‘ç»œå¤„ç†æ“ä½œ.</p> <h6 id="åŸºäºnettyçš„ç¾¤èŠç³»ç»Ÿ"><a href="#åŸºäºnettyçš„ç¾¤èŠç³»ç»Ÿ" class="header-anchor">#</a> åŸºäºNettyçš„ç¾¤èŠç³»ç»Ÿ</h6> <p>å†é€šè¿‡ Netty å®ç°ä¸€ä¸ªç®€å•çš„ç¾¤èŠç³»ç»Ÿ.</p> <p><strong>æœåŠ¡ç«¯å®ç°</strong>:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ChatServer</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>

        <span class="token class-name">EventLoopGroup</span> bossGroup <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NioEventLoopGroup</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">EventLoopGroup</span> workerGroup <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NioEventLoopGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">ServerBootstrap</span> bootstrap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ServerBootstrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            bootstrap<span class="token punctuation">.</span><span class="token function">group</span><span class="token punctuation">(</span>bossGroup<span class="token punctuation">,</span> workerGroup<span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token class-name">NioServerSocketChannel</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">option</span><span class="token punctuation">(</span><span class="token class-name">ChannelOption</span><span class="token punctuation">.</span><span class="token constant">SO_BACKLOG</span><span class="token punctuation">,</span> <span class="token number">1024</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">childHandler</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ChannelInitializer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SocketChannel</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token annotation punctuation">@Override</span>
                        <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">initChannel</span><span class="token punctuation">(</span><span class="token class-name">SocketChannel</span> ch<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
                            <span class="token class-name">ChannelPipeline</span> pipeline <span class="token operator">=</span> ch<span class="token punctuation">.</span><span class="token function">pipeline</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token comment">// å‘pipelineåŠ å…¥è§£ç å™¨</span>
                            pipeline<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token string">&quot;decoder&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">StringDecoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token comment">// å‘pipelineåŠ å…¥ç¼–ç å™¨</span>
                            pipeline<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token string">&quot;encoder&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">StringEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token comment">// åŠ å…¥è‡ªå·±çš„ä¸šåŠ¡å¤„ç†handler</span>
                            pipeline<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ChatServerHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;èŠå¤©å®¤serverå¯åŠ¨. . &quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">ChannelFuture</span> channelFuture <span class="token operator">=</span> bootstrap<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token number">9000</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// å…³é—­é€šé“</span>
            channelFuture<span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">closeFuture</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            bossGroup<span class="token punctuation">.</span><span class="token function">shutdownGracefully</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            workerGroup<span class="token punctuation">.</span><span class="token function">shutdownGracefully</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br></div></div><p>æœåŠ¡å™¨ç«¯ Handler:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ChatServerHandler</span> <span class="token keyword">extends</span> <span class="token class-name">SimpleChannelInboundHandler</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>

    <span class="token comment">/** GlobalEventExecutor.INSTANCEæ˜¯å…¨å±€çš„äº‹ä»¶æ‰§è¡Œå™¨(æ˜¯ä¸€ä¸ªå•ä¾‹) */</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">ChannelGroup</span> channelGroup <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultChannelGroup</span><span class="token punctuation">(</span><span class="token class-name">GlobalEventExecutor</span><span class="token punctuation">.</span><span class="token constant">INSTANCE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">SimpleDateFormat</span> sdf <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SimpleDateFormat</span><span class="token punctuation">(</span><span class="token string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/** è¡¨ç¤ºChannelå¤„äºå°±ç»ªçŠ¶æ€(æç¤ºä¸Šçº¿) */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">channelActive</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">Channel</span> channel <span class="token operator">=</span> ctx<span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// å°†è¯¥å®¢æˆ·åŠ å…¥èŠå¤©çš„ä¿¡æ¯æ¨é€ç»™å…¶å®ƒåœ¨çº¿çš„å®¢æˆ·ç«¯</span>
        <span class="token comment">// è¯¥æ–¹æ³•ä¼šéå†channelGroupä¸­æ‰€æœ‰çš„channel, å¹¶å‘é€æ¶ˆæ¯</span>
        channelGroup<span class="token punctuation">.</span><span class="token function">writeAndFlush</span><span class="token punctuation">(</span><span class="token string">&quot;[å®¢æˆ·ç«¯]&quot;</span> <span class="token operator">+</span> channel<span class="token punctuation">.</span><span class="token function">remoteAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; ä¸Šçº¿äº† &quot;</span> <span class="token operator">+</span> sdf<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// å°†å½“å‰channelåŠ å…¥åˆ°channelGroupä¸­</span>
        channelGroup<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>channel<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">remoteAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; ä¸Šçº¿äº†&quot;</span><span class="token operator">+</span> <span class="token string">&quot;\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/** è¡¨ç¤ºchannelå¤„äºä¸æ´»åŠ¨çŠ¶æ€(æç¤ºç¦»çº¿) */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">channelInactive</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">Channel</span> channel <span class="token operator">=</span> ctx<span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// å°†å®¢æˆ·ç¦»å¼€ä¿¡æ¯æ¨é€ç»™å½“å‰åœ¨çº¿çš„å®¢æˆ·</span>
        channelGroup<span class="token punctuation">.</span><span class="token function">writeAndFlush</span><span class="token punctuation">(</span><span class="token string">&quot;[å®¢æˆ·ç«¯]&quot;</span> <span class="token operator">+</span> channel<span class="token punctuation">.</span><span class="token function">remoteAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; ä¸‹çº¿äº†&quot;</span><span class="token operator">+</span> <span class="token string">&quot;\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">remoteAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; ä¸‹çº¿äº†&quot;</span><span class="token operator">+</span> <span class="token string">&quot;\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;ChannelGroup size=&quot;</span> <span class="token operator">+</span> channelGroup<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * è¯»å–æ•°æ®
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">channelRead0</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">,</span> <span class="token class-name">String</span> msg<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token comment">// è·å–å½“å‰channel</span>
        <span class="token class-name">Channel</span> channel <span class="token operator">=</span> ctx<span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// è¿™æ—¶éå†channelGroupé‡Œé¢æ‰€æœ‰çš„Channel,æ ¹æ®ä¸åŒçš„æƒ…å†µ,å›é€ä¸åŒçš„æ¶ˆæ¯</span>
        channelGroup<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>ch <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token comment">// ä¸æ˜¯å½“å‰çš„ channel,è½¬å‘æ¶ˆæ¯</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>channel <span class="token operator">!=</span> ch<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                ch<span class="token punctuation">.</span><span class="token function">writeAndFlush</span><span class="token punctuation">(</span><span class="token string">&quot;[å®¢æˆ·ç«¯]&quot;</span> <span class="token operator">+</span> channel<span class="token punctuation">.</span><span class="token function">remoteAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; å‘é€äº†æ¶ˆæ¯: &quot;</span> <span class="token operator">+</span> msg <span class="token operator">+</span> <span class="token string">&quot;\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// å›æ˜¾è‡ªå·±å‘é€çš„æ¶ˆæ¯ç»™è‡ªå·±</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                ch<span class="token punctuation">.</span><span class="token function">writeAndFlush</span><span class="token punctuation">(</span><span class="token string">&quot;[è‡ªå·±]å‘é€äº†æ¶ˆæ¯: &quot;</span> <span class="token operator">+</span> msg <span class="token operator">+</span> <span class="token string">&quot;\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">exceptionCaught</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">,</span> <span class="token class-name">Throwable</span> cause<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        ctx<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br></div></div><p>å®¢æˆ·ç«¯å®ç°:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ChatClient</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>

        <span class="token class-name">EventLoopGroup</span> group <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NioEventLoopGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">Bootstrap</span> bootstrap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Bootstrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">group</span><span class="token punctuation">(</span>group<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token class-name">NioSocketChannel</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">handler</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ChannelInitializer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SocketChannel</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token annotation punctuation">@Override</span>
                    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">initChannel</span><span class="token punctuation">(</span><span class="token class-name">SocketChannel</span> ch<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
                        <span class="token class-name">ChannelPipeline</span> pipeline <span class="token operator">=</span> ch<span class="token punctuation">.</span><span class="token function">pipeline</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        pipeline<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">StringEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        pipeline<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">StringDecoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token comment">// æ·»åŠ å®¢æˆ·ç«¯å¤„ç†å™¨</span>
                        pipeline<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ChatClientHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">ChannelFuture</span> channelFuture <span class="token operator">=</span> bootstrap<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token string">&quot;127.0.0.1&quot;</span><span class="token punctuation">,</span> <span class="token number">9000</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// å¾—åˆ°channel</span>
            <span class="token class-name">Channel</span> channel <span class="token operator">=</span> channelFuture<span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;&lt;mark&gt;&lt;/mark&gt;&lt;mark&gt;&lt;/mark&gt;&quot;</span> <span class="token operator">+</span> channel<span class="token punctuation">.</span><span class="token function">localAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;&lt;mark&gt;&lt;/mark&gt;&lt;mark&gt;&lt;/mark&gt;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// å®¢æˆ·ç«¯éœ€è¦è¾“å…¥ä¿¡æ¯,åˆ›å»ºä¸€ä¸ªæ‰«æå™¨</span>
            <span class="token class-name">Scanner</span> scanner <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Scanner</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span>in<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span>scanner<span class="token punctuation">.</span><span class="token function">hasNextLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">String</span> msg <span class="token operator">=</span> scanner<span class="token punctuation">.</span><span class="token function">nextLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// é€šè¿‡channelå‘é€æ¶ˆæ¯åˆ°æœåŠ¡å™¨ç«¯</span>
                channel<span class="token punctuation">.</span><span class="token function">writeAndFlush</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            group<span class="token punctuation">.</span><span class="token function">shutdownGracefully</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br></div></div><p>å®¢æˆ·ç«¯ Handler:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ChatClientHandler</span> <span class="token keyword">extends</span> <span class="token class-name">SimpleChannelInboundHandler</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>

    <span class="token comment">/** æ¥æ”¶åˆ°æ•°æ® */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">channelRead0</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">,</span> <span class="token class-name">String</span> msg<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token comment">// æ‰“å°å‡ºæ¥æ”¶åˆ°çš„æ•°æ®</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h4 id="nettyæ¶æ„æ¨¡å‹ä¸å·¥ä½œæµç¨‹ğŸŒŸ"><a href="#nettyæ¶æ„æ¨¡å‹ä¸å·¥ä½œæµç¨‹ğŸŒŸ" class="header-anchor">#</a> Nettyæ¶æ„æ¨¡å‹ä¸å·¥ä½œæµç¨‹ğŸŒŸ</h4> <h5 id="_1-æ¦‚è¿°-2"><a href="#_1-æ¦‚è¿°-2" class="header-anchor">#</a> 1.æ¦‚è¿°</h5> <p>å¯ä»¥å…ˆç†è§£ä¸‹ã€ŠScalable IO in Javaã€‹è¿™ç¯‡æ–‡ç« é‡Œè¯´çš„ä¸€äº› IO å¤„ç†æ¨¡å¼å†é˜…è¯»æœ¬èŠ‚.</p> <blockquote><p>NIOæ¨¡å‹å­˜åœ¨çš„é—®é¢˜</p></blockquote> <p>å‰é¢è¯´åˆ° Netty æ˜¯å¯¹ NIO æ¨¡å‹çš„å°è£…, è¿™é‡Œå›é¡¾ä¸€ä¸‹ NIO æ¨¡å‹å­˜åœ¨çš„é—®é¢˜. NIO æ¨¡å‹ä¸­, ä¸€ä¸ª <strong>Selector åŒæ—¶éœ€è¦å¤„ç†è¿æ¥äº‹ä»¶å’Œè¯»å†™äº‹ä»¶</strong>. å¦‚æœè¯»å†™äº‹ä»¶å¤ªå¤šé€ æˆäº‹ä»¶ç§¯å‹, è¿™å°±é€ æˆè¿æ¥äº‹ä»¶å¾—ä¸åˆ°åŠæ—¶å¤„ç†è€Œæ— æ³•å»ºç«‹è¿æ¥. (å‚è€ƒ: NIO)</p> <p>å…¶è§£å†³æ–¹æ³•æ˜¯é‡‡ç”¨<strong>ä¸¤ä¸ªæˆ–å¤šä¸ª Selector</strong>, ä¸€ä¸ªä¸“é—¨ç”¨äº<strong>å¤„ç†è¿æ¥äº‹ä»¶</strong>, ä¸€ä¸ªä¸“é—¨ç”¨äº<strong>å¤„ç†è¯»å†™äº‹ä»¶</strong>. æ‰€ä»¥ä¸€ä¸ª Selector è¿æ¥å»ºç«‹å, è·å–<strong>é€šé“å¹¶æ³¨å†Œåˆ°å¦ä¸€ä¸ª Selector ä¸Š</strong>, ä¸“é—¨ç”¨äºè¯»å†™äº‹ä»¶, è¿™æ ·å°±èƒ½è§£å†³ä¸Šè¿°çš„é—®é¢˜. è¿™ç§æ˜¯<strong>ä¸€ä¸»ä¸€ä»</strong>çš„ç»“æ„.</p> <h5 id="_2-nettyçº¿ç¨‹æ¨¡å‹"><a href="#_2-nettyçº¿ç¨‹æ¨¡å‹" class="header-anchor">#</a> 2.Nettyçº¿ç¨‹æ¨¡å‹</h5> <p>Netty ä¹Ÿæ˜¯è¿™æ ·å¹²çš„, Netty ä¸€èˆ¬æƒ…å†µä¸‹æ˜¯ <strong>ä¸€ä¸»å¤šä»</strong>æ¶æ„(ä¹Ÿå¯ä»¥æ˜¯<strong>å¤šä¸»å¤šä»</strong>æ¶æ„), å³å¯ä»¥<strong>è®¾ç½®å¤šä¸ª Selector</strong>.</p> <p>Netty çš„<strong>çº¿ç¨‹æ¨¡å‹</strong>å¦‚ä¸‹å›¾æ‰€ç¤º:</p> <p><img src="https://nano-note.oss-cn-beijing.aliyuncs.com/images/Netty.png" alt="Netty" title="Nettyçº¿ç¨‹æ¨¡å‹"></p> <p>Netty æŠ½è±¡å‡º<strong>ä¸¤ç»„çº¿ç¨‹æ± </strong> <strong>BossGroup</strong> å’Œ <strong>WorkerGroup</strong>, BossGroup ä¸“é—¨è´Ÿè´£æ¥æ”¶<strong>å®¢æˆ·ç«¯çš„è¿æ¥</strong>, WorkerGroup ä¸“é—¨<strong>è´Ÿè´£ç½‘ç»œçš„è¯»å†™</strong>.</p> <p>BossGroup å’Œ WorkerGroup çš„ç±»å‹éƒ½æ˜¯ <strong>NioEventLoopGroup</strong>. NioEventLoopGroup ç›¸å½“äºä¸€ä¸ª<strong>äº‹ä»¶å¾ªç¯çº¿ç¨‹ç»„</strong>, å…¶ä¸­åŒ…å«å¤šä¸ªäº‹ä»¶å¾ªç¯çº¿ç¨‹, æ¯ä¸ªäº‹ä»¶å¾ªç¯çº¿ç¨‹éƒ½æ˜¯ <strong>NioEventLoop</strong>, ä¸€ä¸ª <strong>NioEventLoop å¯ä»¥ç†è§£ä¸ºä¸€ä¸ªçº¿ç¨‹ä»…åŒ…å«ä¸€ä¸ªçº¿ç¨‹çš„çº¿ç¨‹æ± </strong>. æ¯ä¸ª NioEventLoop <strong>éƒ½æœ‰ä¸€ä¸ª selector</strong>, ç›¸å½“äºä¸€ä¸ªçº¿ç¨‹å°±æœ‰ä¸€ä¸ª Selector, ç”¨äºç›‘å¬æ³¨å†Œåœ¨å…¶ä¸Šçš„ socketChannel çš„ç½‘ç»œé€šè®¯.</p> <blockquote><p>Nettyçº¿ç¨‹æ¨¡å‹æºç å‰–æå›¾</p></blockquote> <p>æºè‡ªå›¾çµ ZG, å›¾é“¾æ¥: <a href="https://www.processon.com/view/link/5dee0943e4b079080a26c2ac" target="_blank" rel="noopener noreferrer">https://www.processon.com/view/link/5dee0943e4b079080a26c2ac<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h5 id="_2-æ•´ä½“å·¥ä½œæµç¨‹"><a href="#_2-æ•´ä½“å·¥ä½œæµç¨‹" class="header-anchor">#</a> 2.æ•´ä½“å·¥ä½œæµç¨‹</h5> <p>æ¯ä¸ª <strong>Boss NioEventLoop çº¿ç¨‹</strong>å†…éƒ¨å¾ªç¯æ‰§è¡Œçš„æ­¥éª¤æœ‰ 3 æ­¥:</p> <ul><li>å¤„ç† <mark><strong>accept äº‹ä»¶</strong></mark>, ä¸ client å»ºç«‹è¿æ¥ , ç”Ÿæˆ <strong>NioSocketChannel é€šé“</strong>.</li> <li>å°† <strong>NioSocketChannel</strong> <strong>æ³¨å†Œåˆ°æŸä¸ª Worker NioEventLoop çš„ selector ä¹‹ä¸Š</strong>.</li> <li>å¤„ç†<strong>ä»»åŠ¡é˜Ÿåˆ—</strong>çš„ä»»åŠ¡, å³ runAllTasks.</li></ul> <p>æ¯ä¸ª <strong>Worker NioEventLoop</strong> å†…éƒ¨å¾ªç¯æ‰§è¡Œçš„æ­¥éª¤ä¹Ÿæœ‰ 3 æ­¥:</p> <ul><li><strong>è½®è¯¢æ³¨å†Œ</strong>åˆ°è‡ªå·± <strong>Selector</strong> ä¸Šçš„æ‰€æœ‰ <strong>NioSocketChannel</strong> çš„ <strong>read, write</strong> äº‹ä»¶(åªå¤„ç†è¯»å†™äº‹ä»¶).</li> <li>å¤„ç† read å’Œ write çš„ I/O äº‹ä»¶, å¹¶åœ¨å¯¹åº” <strong>NioSocketChannel</strong> å¤„ç†å…·ä½“ä¸šåŠ¡.</li> <li>runAllTasks å¤„ç†<strong>ä»»åŠ¡é˜Ÿåˆ— TaskQueue çš„ä»»åŠ¡</strong>, ä¸€äº›è€—æ—¶çš„ä¸šåŠ¡å¤„ç†ä¸€èˆ¬å¯ä»¥æ”¾å…¥ <strong>TaskQueue</strong> ä¸­æ…¢æ…¢å¤„ç†, è¿™æ ·ä¸å½±å“æ•°æ®åœ¨ <strong>pipeline</strong> ä¸­çš„æµåŠ¨å¤„ç†.</li></ul> <p>æ¯ä¸ª Worker NioEventLoop å¤„ç† <strong>NioSocketChannel</strong> ä¸šåŠ¡æ—¶, ä¼šä½¿ç”¨ <strong>pipeline</strong> (ç®¡é“), ç®¡é“ä¸­ç»´æŠ¤äº†å¾ˆå¤š <strong>handler</strong> å¤„ç†å™¨ç”¨æ¥å¤„ç† channel ä¸­çš„æ•°æ®. ä¸€ä¸ª NioEventLoop å°±æ˜¯ä¸€ä¸ª<strong>çº¿ç¨‹æ± </strong>, åªä¸è¿‡é‡Œé¢åªæœ‰<strong>ä¸€ä¸ª</strong>çº¿ç¨‹, <strong>æ¯ä¸ªçº¿ç¨‹</strong>éƒ½æœ‰ä¸€ä¸ª <strong>TaskQueue</strong>, ç”¨äºæ‰§è¡Œæ¯”è¾ƒè€—æ—¶çš„ä»»åŠ¡.</p> <h5 id="_3-æ¶æ„æ¨¡å—ç»„ä»¶ğŸŒŸ"><a href="#_3-æ¶æ„æ¨¡å—ç»„ä»¶ğŸŒŸ" class="header-anchor">#</a> 3.æ¶æ„æ¨¡å—ç»„ä»¶ğŸŒŸ</h5> <p>å‰é¢ä»‹ç»äº† Netty æ•´ä½“çš„æ¶æ„æ¨¡å‹ä¸å·¥ä½œæµç¨‹, è¿™é‡Œè¯¦ç»†çš„ä»‹ç»ä¸‹æ¨¡å‹ä¸­çš„å„ä¸ªç»„ä»¶çš„ä½œç”¨ä¸è¦ç‚¹. è¿™å¯¹äºæºç çš„é˜…è¯»ä¹Ÿæ˜¯æœ‰ç”¨å¤„çš„.</p> <h6 id="bootstrap-serverbootstrap"><a href="#bootstrap-serverbootstrap" class="header-anchor">#</a> Bootstrap/ServerBootstrap</h6> <p>Bootstrap æ„æ€æ˜¯<strong>å¼•å¯¼ç±»</strong>, ä¸€ä¸ª Netty åº”ç”¨é€šå¸¸ç”±ä¸€ä¸ª Bootstrap å¼€å§‹, ä¸»è¦ä½œç”¨æ˜¯<strong>è¿›è¡Œåº”ç”¨é…ç½®å¹¶ä¸²è”å„ä¸ªç»„ä»¶</strong>. <strong>Bootstrap</strong> ç±»æ˜¯<strong>å®¢æˆ·ç«¯å¯åŠ¨å¼•å¯¼ç±»</strong>, <strong>ServerBootstrap</strong> æ˜¯<strong>æœåŠ¡ç«¯å¯åŠ¨å¼•å¯¼ç±»</strong>.</p> <h6 id="future-channelfuture"><a href="#future-channelfuture" class="header-anchor">#</a> Future/ChannelFuture</h6> <p>Netty ä¸­æ‰€æœ‰çš„ IO æ“ä½œéƒ½æ˜¯<strong>å¼‚æ­¥</strong>çš„, ä¸èƒ½ç«‹åˆ»å¾—çŸ¥æ¶ˆæ¯æ˜¯å¦è¢«æ­£ç¡®å¤„ç†. å¯ä»¥é€šè¿‡ <strong>Future å’Œ ChannelFutures</strong> æ³¨å†Œä¸€ä¸ªç›‘å¬, å½“<strong>æ“ä½œæ‰§è¡ŒæˆåŠŸæˆ–å¤±è´¥æ—¶ç›‘å¬ä¼šè‡ªåŠ¨è§¦å‘æ³¨å†Œçš„ç›‘å¬äº‹ä»¶</strong>.</p> <h6 id="channel"><a href="#channel" class="header-anchor">#</a> Channel</h6> <p>Netty <strong>ç½‘ç»œé€šä¿¡çš„ç»„ä»¶, èƒ½å¤Ÿç”¨äºæ‰§è¡Œç½‘ç»œ I/O æ“ä½œ</strong>. Channel ä¸ºç”¨æˆ·æä¾›:</p> <ul><li>å½“å‰ç½‘ç»œè¿æ¥çš„<strong>é€šé“çš„çŠ¶æ€</strong>(å¦‚æ˜¯å¦æ‰“å¼€, æ˜¯å¦å·²è¿æ¥)</li> <li>ç½‘ç»œè¿æ¥çš„<strong>é…ç½®å‚æ•°</strong> (å¦‚æ¥æ”¶ç¼“å†²åŒºå¤§å°)</li> <li>æä¾›å¼‚æ­¥çš„<strong>ç½‘ç»œ I/O æ“ä½œ</strong>(å¦‚å»ºç«‹è¿æ¥, è¯»å†™, ç»‘å®šç«¯å£), å¼‚æ­¥è°ƒç”¨æ„å‘³ç€ä»»ä½• I/O è°ƒç”¨éƒ½å°†ç«‹å³è¿”å›, å¹¶ä¸”ä¸ä¿è¯åœ¨è°ƒç”¨ç»“æŸæ—¶æ‰€è¯·æ±‚çš„ I/O æ“ä½œå·²å®Œæˆ. è°ƒç”¨ç«‹å³è¿”å›ä¸€ä¸ª <strong>ChannelFuture</strong> å®ä¾‹, é€šè¿‡æ³¨å†Œç›‘å¬å™¨åˆ° <strong>ChannelFuture</strong> ä¸Š, å¯ä»¥åœ¨ I/O æ“ä½œæˆåŠŸ, å¤±è´¥æˆ–å–æ¶ˆæ—¶å›è°ƒé€šçŸ¥è°ƒç”¨æ–¹.</li> <li>æ”¯æŒå…³è” I/O æ“ä½œä¸å¯¹åº”çš„å¤„ç†ç¨‹åº.</li></ul> <p><strong>ä¸åŒåè®®, ä¸åŒçš„é˜»å¡ç±»å‹çš„è¿æ¥éƒ½æœ‰ä¸åŒçš„ Channel ç±»å‹ä¸ä¹‹å¯¹åº”</strong>.</p> <p>ä¸‹é¢æ˜¯ä¸€äº›å¸¸ç”¨çš„ Channel ç±»å‹:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">NioSocketChannel</span> 		<span class="token comment">// å¼‚æ­¥çš„å®¢æˆ·ç«¯ TCP Socket è¿æ¥</span>
<span class="token class-name">NioServerSocketChannel</span> 		<span class="token comment">// å¼‚æ­¥çš„æœåŠ¡å™¨ç«¯ TCP Socket è¿æ¥</span>
<span class="token class-name">NioDatagramChannel</span>		<span class="token comment">// å¼‚æ­¥çš„ UDP è¿æ¥</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h6 id="selector"><a href="#selector" class="header-anchor">#</a> Selector</h6> <p>Netty åŸºäº <strong>Selector å®ç° I/O å¤šè·¯å¤ç”¨</strong>, é€šè¿‡ <strong>Selector ä¸€ä¸ªçº¿ç¨‹å¯ä»¥ç›‘å¬å¤šä¸ªè¿æ¥çš„ Channel äº‹ä»¶</strong>. å½“å‘ä¸€ä¸ª <strong>Selector æ³¨å†Œ Channel å</strong>, Selector å¯ä»¥<strong>ä¸æ–­åœ°è½®è¯¢(select) è¿™äº›æ³¨å†Œçš„ Channel</strong> æ˜¯å¦æœ‰<strong>å·²å°±ç»ªçš„ I/O äº‹ä»¶</strong>(å¦‚å¯è¯», å¯å†™, ç½‘ç»œè¿æ¥å®Œæˆç­‰), è¿™æ ·å°±å¯ä»¥ä½¿ç”¨<strong>ä¸€ä¸ªçº¿ç¨‹</strong>ç®€å•é«˜æ•ˆåœ°ç®¡ç†å¤šä¸ª Channel.</p> <h6 id="nioeventloop"><a href="#nioeventloop" class="header-anchor">#</a> NioEventLoop</h6> <p>NioEventLoop ç»´æŠ¤äº†<strong>ä¸€ä¸ªçº¿ç¨‹å’Œä»»åŠ¡é˜Ÿåˆ—</strong>, æ”¯æŒå¼‚æ­¥æäº¤æ‰§è¡Œä»»åŠ¡, çº¿ç¨‹å¯åŠ¨æ—¶ä¼šè°ƒç”¨ NioEventLoop çš„ <strong>run() æ–¹æ³•</strong>, æ‰§è¡Œ I/O ä»»åŠ¡å’Œé I/O ä»»åŠ¡:</p> <ul><li><strong>IO ä»»åŠ¡</strong>, å³ <strong>selectionKey</strong> ä¸­ ready çš„äº‹ä»¶, å¦‚ <strong>accept, connect, read, write</strong> ç­‰, ç”± <strong>processSelectedKeys()</strong>  æ–¹æ³•è§¦å‘.</li> <li><strong>é IO ä»»åŠ¡</strong>, æ·»åŠ åˆ° <strong>taskQueue</strong> ä¸­çš„ä»»åŠ¡, å¦‚ <strong>register0, bind0</strong> ç­‰ä»»åŠ¡, ç”± <strong>runAllTasks() æ–¹æ³•è§¦å‘</strong>.</li></ul> <h6 id="nioeventloopgroup"><a href="#nioeventloopgroup" class="header-anchor">#</a> NioEventLoopGroup</h6> <p>NioEventLoopGroup ä¸»è¦ç®¡ç† <strong>EventLoop çš„ç”Ÿå‘½å‘¨æœŸ</strong>, å¯ä»¥ç†è§£ä¸ºä¸€ä¸ª<strong>çº¿ç¨‹æ± </strong>, å†…éƒ¨ç»´æŠ¤äº†<strong>ä¸€ç»„çº¿ç¨‹</strong>, æ¯ä¸ªçº¿ç¨‹(NioEventLoop)è´Ÿè´£å¤„ç†<strong>å¤šä¸ª Channel ä¸Šçš„äº‹ä»¶</strong>, è€Œ<strong>ä¸€ä¸ª Channel åªå¯¹åº”äºä¸€ä¸ªçº¿ç¨‹</strong>.</p> <h6 id="channelhandlercontext"><a href="#channelhandlercontext" class="header-anchor">#</a> ChannelHandlerContext</h6> <p>ä¿å­˜ <strong>Channel ç›¸å…³</strong>çš„<strong>æ‰€æœ‰ä¸Šä¸‹æ–‡ä¿¡æ¯</strong>, åŒæ—¶å…³è”ä¸€ä¸ª <strong>ChannelHandler å¯¹è±¡</strong>.</p> <h6 id="channelhandler"><a href="#channelhandler" class="header-anchor">#</a> ChannelHandler</h6> <p><strong>ChannelHandler æ˜¯ä¸€ä¸ªæ¥å£, ç”¨äºå¤„ç† I/O äº‹ä»¶æˆ–æ‹¦æˆª I/O æ“ä½œ, å¹¶å°†å…¶è½¬å‘åˆ°å…¶ ChannelPipeline(ä¸šåŠ¡å¤„ç†é“¾)ä¸­çš„ä¸‹ä¸€ä¸ªå¤„ç†ç¨‹åº, æ„æˆä¸€æ¡å¤„ç†é“¾. ChannelHandler å……å½“äº†å¤„ç†å…¥ç«™å’Œå‡ºç«™æ•°æ®çš„åº”ç”¨ç¨‹åºé€»è¾‘å®¹å™¨.</strong></p> <blockquote><p>è‡ªå®šä¹‰ChannelHandler</p></blockquote> <p>ä¸ºæ–¹ä¾¿ä½¿ç”¨, ä¸€èˆ¬è‡ªå®šä¹‰çš„ä¸šåŠ¡ Handler å¯ä»¥ç»§æ‰¿è‡ª ChannelHandler çš„å­ç±», è‡ªå·±åªéœ€è¦å®ç°æ–¹æ³•å®Œæˆä¸šåŠ¡å³å¯:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">ChannelInboundHandler</span> 	<span class="token comment">// ç”¨äºå¤„ç†å…¥ç«™I/Oäº‹ä»¶</span>
<span class="token class-name">ChannelOutboundHandler</span> 	<span class="token comment">// ç”¨äºå¤„ç†å‡ºç«™I/Oæ“ä½œ</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>æˆ–ä½¿ç”¨ä»¥ä¸‹<strong>é€‚é…å™¨</strong>ç±»:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">ChannelInboundHandlerAdapter</span>  <span class="token comment">// ç”¨äºå¤„ç†å…¥ç«™I/Oäº‹ä»¶</span>
<span class="token class-name">ChannelOutboundHandlerAdapter</span> <span class="token comment">// ç”¨äºå¤„ç†å‡ºç«™I/Oæ“ä½œ</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>ä¾‹å¦‚å®ç° <strong>ChannelInboundHandler</strong> æ¥å£(æˆ– ChannelInboundHandlerAdapter), å°±å¯ä»¥æ¥æ”¶<strong>å…¥ç«™äº‹ä»¶</strong>å’Œæ•°æ®, è¿™äº›æ•°æ®éšåä¼š<strong>è¢«åº”ç”¨ç¨‹åºçš„ä¸šåŠ¡é€»è¾‘å¤„ç†</strong>. å½“è¦ç»™è¿æ¥çš„å®¢æˆ·ç«¯<strong>å‘é€å“åº”</strong>æ—¶, ä¹Ÿå¯ä»¥ä» ChannelInboundHandler <strong>å†²åˆ·</strong>æ•°æ®. è¯»å–ä¸å¤„ç†æ•°æ®çš„ä¸šåŠ¡é€»è¾‘é€šå¸¸å†™åœ¨ä¸€ä¸ªæˆ–è€…<strong>å¤šä¸ª ChannelInboundHandler</strong> ä¸­, è€Œ ChannelOutboundHandler åˆ™æ˜¯ç”¨æ¥å¤„ç†å‡ºç«™æ•°æ®çš„.</p> <h6 id="channelpipeline"><a href="#channelpipeline" class="header-anchor">#</a> ChannelPipeline</h6> <p><strong>ChannelPipeline æ˜¯ ChannelHandler é“¾çš„å®¹å™¨, ä¿å­˜ ChannelHandler å®ç°ç±»çš„ List, ç”¨äºå¤„ç†æˆ–æ‹¦æˆª Channel çš„å…¥ç«™äº‹ä»¶å’Œå‡ºç«™äº‹ä»¶</strong>. ChannelPipeline å®ç°äº†ä¸€ç§<strong>æ‹¦æˆªè¿‡æ»¤å™¨æ¨¡å¼</strong>, ç”¨æˆ·å¯ä»¥å®Œå…¨æ§åˆ¶äº‹ä»¶çš„å¤„ç†æ–¹å¼ä»¥åŠ Channel ä¸­å„ä¸ªçš„ ChannelHandler å¦‚ä½•<strong>ç›¸äº’äº¤äº’</strong>.</p> <p>ä¸€ä¸ª Channel åŒ…å«äº†ä¸€ä¸ª <strong>ChannelPipeline</strong>, è€Œ ChannelPipeline ä¸­åˆç»´æŠ¤äº†ä¸€ä¸ªç”± <strong>ChannelHandlerContext</strong> ç»„æˆçš„<strong>åŒå‘é“¾è¡¨</strong>, å¹¶ä¸”æ¯ä¸ª ChannelHandlerContext ä¸­åˆ<strong>å…³è”ç€ä¸€ä¸ª ChannelHandler</strong>. <strong>æ¯ä¸ª Channel éƒ½æœ‰ä¸”ä»…æœ‰ä¸€ä¸ª ChannelPipeline ä¸ä¹‹å¯¹åº”</strong>, å®ƒä»¬çš„ç»„æˆå…³ç³»å¦‚ä¸‹, ChannelHandler é“¾åªæœ‰ä¸€ä¸ªé“¾, æ˜¯ä¸€ä¸ª<strong>åŒå‘é“¾è¡¨</strong>:</p> <p>â€‹<img src="https://nano-note.oss-cn-beijing.aliyuncs.com/images/image-20230204224749543.png" alt="" title="ChannelPipeLineç»“æ„">â€‹</p> <p><strong>ä»¥</strong>â€‹<mark><strong>å®¢æˆ·ç«¯</strong></mark>â€‹<strong>ä¸ºä¾‹</strong>, å¦‚æœäº‹ä»¶çš„è¿åŠ¨æ–¹å‘æ˜¯ä»<strong>å®¢æˆ·ç«¯åˆ°æœåŠ¡ç«¯</strong>(ä¹Ÿå°±æ˜¯æ•°æ®æµå‡ºå®¢æˆ·ç«¯)çš„, é‚£ä¹ˆè¿™äº›äº‹ä»¶ç§°ä¸º<strong>å‡ºç«™(write)äº‹ä»¶</strong>. å®¢æˆ·ç«¯å‘é€ç»™æœåŠ¡ç«¯çš„æ•°æ®ä¼šç»è¿‡ pipeline ä¸­çš„ä¸€ç³»åˆ—çš„ <strong>ChannelOutboundHandler(ChannelOutboundHandler è°ƒç”¨æ˜¯ä» tail åˆ° head æ–¹å‘é€ä¸ªè°ƒç”¨æ¯ä¸ª handler çš„é€»è¾‘)</strong> , å¹¶è¢«è¿™äº› Handler å¤„ç†. åä¹‹åˆ™ç§°ä¸º<strong>å…¥ç«™(read)äº‹ä»¶</strong>, å…¥ç«™åªè°ƒç”¨ pipeline é‡Œçš„ <strong>ChannelInboundHandler</strong> é€»è¾‘ <strong>(ChannelInboundHandler è°ƒç”¨æ˜¯ä» head åˆ° tail æ–¹å‘é€ä¸ªè°ƒç”¨æ¯ä¸ª handler çš„é€»è¾‘)</strong> .</p> <p>å‡ºç«™ä¸å…¥ç«™äº‹ä»¶éƒ½ä¼šç»å†ä¸€æ¡ ChannelHandler é“¾è¿›è¡Œå¤„ç†, ç„¶è€Œä¼šæ ¹æ®å‡ºç«™è¿˜æ˜¯å…¥ç«™äº‹ä»¶é€‰æ‹©å¯¹åº”çš„ ChannelHandler è¿›è¡Œå¤„ç†, ä¸ç¬¦åˆçš„ä¸ç®¡. å› æ­¤<strong>ä¸¤ç§ç±»å‹çš„ handler äº’ä¸å¹²æ‰°</strong>.</p> <p><mark><strong>ChannelHandler å’Œ ChannelPipeline è¿™ä¸¤ä¸ªç»„ä»¶éå¸¸å…³é”®, å‡ºå…¥ç«™äº‹ä»¶çš„å¤„ç†, ä¸‹é¢ä»‹ç»çš„ç¼–è§£ç , ç²˜åŒ…æ‹†åŒ…, å¿ƒè·³æ£€æŸ¥, ä¸šåŠ¡å¤„ç†åŸºæœ¬éƒ½æ˜¯åŸºäºè¿™ä¸ªæ¨¡å‹å®ç°çš„, ä¹Ÿå°±æ˜¯å®ç°å¯¹åº”çš„ ChannelHandler æ¥å£, ç„¶åæ³¨å†Œåˆ° ChannelPipeline ä¸­</strong></mark>.</p> <h4 id="bytebufæ•°ç»„"><a href="#bytebufæ•°ç»„" class="header-anchor">#</a> ByteBufæ•°ç»„</h4> <h5 id="_1-åŸºæœ¬ä½¿ç”¨"><a href="#_1-åŸºæœ¬ä½¿ç”¨" class="header-anchor">#</a> 1.åŸºæœ¬ä½¿ç”¨</h5> <p>Netty å®ç°ç¤ºä¾‹ä¸­çš„ client ä¸ server çš„ Handler é‡Œé¢éƒ½ç”¨äº† ByteBuf æ¥è¯»/å†™æ•°æ®. ä»ç»“æ„ä¸Šæ¥è¯´, ByteBuf ç”±ä¸€ä¸²<strong>å­—èŠ‚æ•°ç»„</strong>æ„æˆ, æ•°ç»„ä¸­æ¯ä¸ª<strong>å­—èŠ‚ç”¨æ¥å­˜æ”¾ä¿¡æ¯</strong>.</p> <p>ByteBuf æä¾›äº†<strong>ä¸¤ä¸ªç´¢å¼•</strong>, ä¸€ä¸ªç”¨äº<strong>è¯»å–</strong>æ•°æ®, ä¸€ä¸ªç”¨äº<strong>å†™å…¥</strong>æ•°æ®. è¿™ä¸¤ä¸ªç´¢å¼•é€šè¿‡åœ¨<strong>å­—èŠ‚æ•°ç»„ä¸­ç§»åŠ¨</strong>, æ¥å®šä½éœ€è¦è¯»å†™ä¿¡æ¯çš„ä½ç½®.</p> <ul><li>å½“è¯» ByteBuf æ—¶, å®ƒçš„ <strong>readerIndex</strong>(è¯»ç´¢å¼•)å°†ä¼šæ ¹æ®è¯»å–çš„å­—èŠ‚æ•°<strong>é€’å¢</strong>.</li> <li>å½“å†™ ByteBuf æ—¶, å®ƒçš„ <strong>writerIndex</strong>(å†™ç´¢å¼•)ä¹Ÿä¼šæ ¹æ®å†™å…¥çš„å­—èŠ‚æ•°è¿›è¡Œ<strong>é€’å¢</strong>.</li></ul> <p><img src="https://nano-note.oss-cn-beijing.aliyuncs.com/images/image-20230205100542970.png" alt="" title="ByteBufç»“æ„"></p> <p>è¿™é‡Œ readerIndex å’Œ writerIndex å’Œ capacity, å°† buffer æ•°ç»„åˆ†æˆä¸‰ä¸ªåŒºåŸŸ:</p> <ul><li>å·²ç»è¯»å–çš„åŒºåŸŸ: [0, readerIndex)</li> <li>å¯è¯»å–çš„åŒºåŸŸ: [readerIndex, writerIndex)</li> <li>å¯å†™çš„åŒºåŸŸ: [writerIndex, capacity)</li></ul> <p>æé™çš„<strong>æƒ…å†µæ˜¯ readerIndex åˆšå¥½è¯»åˆ°äº† writerIndex å†™å…¥çš„åœ°æ–¹</strong>.</p> <p>ç¤ºä¾‹ä»£ç :</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">NettyByteBufTest</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// åˆ›å»ºbyteBufå¯¹è±¡, è¯¥å¯¹è±¡å†…éƒ¨åŒ…å«ä¸€ä¸ªå­—èŠ‚æ•°ç»„byte[10]</span>
        <span class="token class-name">ByteBuf</span> byteBuf <span class="token operator">=</span> <span class="token class-name">Unpooled</span><span class="token punctuation">.</span><span class="token function">buffer</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// (ridx: 0, widx: 0, cap: 10)</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;byteBuf=&quot;</span> <span class="token operator">+</span> byteBuf<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// å†™å…¥8ä¸ªå­—èŠ‚</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">8</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            byteBuf<span class="token punctuation">.</span><span class="token function">writeByte</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// (ridx: 0, widx: 8, cap: 10)è¿™é‡ŒwriteIndexå˜æˆäº†8</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;byteBuf=&quot;</span> <span class="token operator">+</span> byteBuf<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">// è¯»å–æ•°æ®</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span>byteBuf<span class="token punctuation">.</span><span class="token function">getByte</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; &quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// (ridx: 0, widx: 8, cap: 10) readIndexæ²¡å˜, è°ƒç”¨getByte()æ–¹æ³•ä¸ä¼šæ”¹å˜readIndex</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;byteBuf=&quot;</span> <span class="token operator">+</span> byteBuf<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// å†æ¬¡è°ƒç”¨è¯»æ•°æ®</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span>byteBuf<span class="token punctuation">.</span><span class="token function">readByte</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; &quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// (ridx: 5, widx: 8, cap: 10),readIndexå˜åŒ–, è°ƒç”¨readByte()æ–¹æ³•ä¼šæ”¹å˜readIndex</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;byteBuf=&quot;</span> <span class="token operator">+</span> byteBuf<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// ç”¨Unschooledå·¥å…·ç±»åˆ›å»ºByteBuf</span>
        <span class="token class-name">ByteBuf</span> byteBuf2 <span class="token operator">=</span> <span class="token class-name">Unpooled</span><span class="token punctuation">.</span><span class="token function">copiedBuffer</span><span class="token punctuation">(</span><span class="token string">&quot;hello,Cindy!&quot;</span><span class="token punctuation">,</span> <span class="token class-name">CharsetUtil</span><span class="token punctuation">.</span><span class="token constant">UTF_8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// ä½¿ç”¨ç›¸å…³çš„æ–¹æ³•</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>byteBuf2<span class="token punctuation">.</span><span class="token function">hasArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> content <span class="token operator">=</span> byteBuf2<span class="token punctuation">.</span><span class="token function">array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// å°†contentè½¬æˆå­—ç¬¦ä¸²</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>content<span class="token punctuation">,</span> <span class="token class-name">CharsetUtil</span><span class="token punctuation">.</span><span class="token constant">UTF_8</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;byteBuf=&quot;</span> <span class="token operator">+</span> byteBuf2<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>byteBuf2<span class="token punctuation">.</span><span class="token function">readerIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 0</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>byteBuf2<span class="token punctuation">.</span><span class="token function">writerIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 12</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>byteBuf2<span class="token punctuation">.</span><span class="token function">capacity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 36</span>
            <span class="token comment">// è·å–æ•°ç»„0è¿™ä¸ªä½ç½®çš„å­—ç¬¦hçš„ASCIIç , h=104</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>byteBuf2<span class="token punctuation">.</span><span class="token function">getByte</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">int</span> len <span class="token operator">=</span> byteBuf2<span class="token punctuation">.</span><span class="token function">readableBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>         <span class="token comment">// å¯è¯»çš„å­—èŠ‚æ•°  12</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;len=&quot;</span> <span class="token operator">+</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// ä½¿ç”¨forå–å‡ºå„ä¸ªå­—èŠ‚</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> len<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token punctuation">)</span> byteBuf2<span class="token punctuation">.</span><span class="token function">getByte</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; &quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment">// èŒƒå›´è¯»å–</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>byteBuf2<span class="token punctuation">.</span><span class="token function">getCharSequence</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token class-name">CharsetUtil</span><span class="token punctuation">.</span><span class="token constant">UTF_8</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>byteBuf2<span class="token punctuation">.</span><span class="token function">getCharSequence</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token class-name">CharsetUtil</span><span class="token punctuation">.</span><span class="token constant">UTF_8</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br></div></div><p>è¾“å‡ºå¦‚ä¸‹:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>byteBuf<span class="token operator">=</span><span class="token class-name">UnpooledByteBufAllocator</span>$<span class="token class-name">InstrumentedUnpooledUnsafeHeapByteBuf</span><span class="token punctuation">(</span>ridx<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> widx<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> cap<span class="token operator">:</span> <span class="token number">10</span><span class="token punctuation">)</span>
byteBuf<span class="token operator">=</span><span class="token class-name">UnpooledByteBufAllocator</span>$<span class="token class-name">InstrumentedUnpooledUnsafeHeapByteBuf</span><span class="token punctuation">(</span>ridx<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> widx<span class="token operator">:</span> <span class="token number">8</span><span class="token punctuation">,</span> cap<span class="token operator">:</span> <span class="token number">10</span><span class="token punctuation">)</span>
<span class="token number">0</span> <span class="token number">1</span> <span class="token number">2</span> <span class="token number">3</span> <span class="token number">4</span> byteBuf<span class="token operator">=</span><span class="token class-name">UnpooledByteBufAllocator</span>$<span class="token class-name">InstrumentedUnpooledUnsafeHeapByteBuf</span><span class="token punctuation">(</span>ridx<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> widx<span class="token operator">:</span> <span class="token number">8</span><span class="token punctuation">,</span> cap<span class="token operator">:</span> <span class="token number">10</span><span class="token punctuation">)</span>
<span class="token number">0</span> <span class="token number">1</span> <span class="token number">2</span> <span class="token number">3</span> <span class="token number">4</span> byteBuf<span class="token operator">=</span><span class="token class-name">UnpooledByteBufAllocator</span>$<span class="token class-name">InstrumentedUnpooledUnsafeHeapByteBuf</span><span class="token punctuation">(</span>ridx<span class="token operator">:</span> <span class="token number">5</span><span class="token punctuation">,</span> widx<span class="token operator">:</span> <span class="token number">8</span><span class="token punctuation">,</span> cap<span class="token operator">:</span> <span class="token number">10</span><span class="token punctuation">)</span>
hello<span class="token punctuation">,</span><span class="token class-name">Cindy</span><span class="token operator">!</span>
byteBuf<span class="token operator">=</span><span class="token class-name">UnpooledByteBufAllocator</span>$<span class="token class-name">InstrumentedUnpooledUnsafeHeapByteBuf</span><span class="token punctuation">(</span>ridx<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> widx<span class="token operator">:</span> <span class="token number">12</span><span class="token punctuation">,</span> cap<span class="token operator">:</span> <span class="token number">64</span><span class="token punctuation">)</span>
<span class="token number">0</span>
<span class="token number">12</span>
<span class="token number">64</span>
<span class="token number">104</span>
len<span class="token operator">=</span><span class="token number">12</span>
h e l l o <span class="token punctuation">,</span> <span class="token class-name">C</span> i n d y <span class="token operator">!</span> hello<span class="token punctuation">,</span>
<span class="token class-name">Cindy</span><span class="token operator">!</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><h5 id="_2-bytebufå†…å­˜æ± è®¾è®¡"><a href="#_2-bytebufå†…å­˜æ± è®¾è®¡" class="header-anchor">#</a> 2.ByteBufå†…å­˜æ± è®¾è®¡</h5> <p>éšç€ JVM å’Œ JIT å³æ—¶ç¼–è¯‘æŠ€æœ¯çš„å‘å±•, <strong>å¯¹è±¡çš„åˆ†é…å’Œå›æ”¶</strong>å˜å¾—æ„ˆå‘è½»é‡. ä½†å¯¹äº<strong>ç¼“å†²åŒº Buffer</strong> (ç›¸å½“äºä¸€ä¸ªå†…å­˜å—), æƒ…å†µå´ç¨æœ‰ä¸åŒ, ç‰¹åˆ«æ˜¯å¯¹äº<strong>å †å¤–ç›´æ¥å†…å­˜çš„åˆ†é…å’Œå›æ”¶, æ˜¯ä¸€ä»¶è€—æ—¶çš„æ“ä½œ</strong>. ä¸ºäº†å°½é‡é‡ç”¨ç¼“å†²åŒº, Netty æä¾›äº†<strong>åŸºäº ByteBuf å†…å­˜æ± çš„ç¼“å†²åŒºé‡ç”¨æœºåˆ¶</strong>. éœ€è¦çš„æ—¶å€™ç›´æ¥ä»<strong>æ± å­é‡Œè·å– ByteBuf ä½¿ç”¨</strong>å³å¯, ä½¿ç”¨å®Œæ¯•ä¹‹åå°±é‡æ–°æ”¾å›åˆ°æ± å­é‡Œå». ä¸‹é¢çœ‹ä¸‹ Netty ByteBuf çš„å®ç°:</p> <p><img src="https://nano-note.oss-cn-beijing.aliyuncs.com/images/image-20200727211346203.png" alt="" title="Netty ByteBufå®ç°ç±»"></p> <p>å¯ä»¥çœ‹ä¸‹ Netty çš„è¯»å†™æºç é‡Œé¢ç”¨åˆ°çš„ <strong>ByteBuf å†…å­˜æ± </strong>, çœ‹ ByteBufAllocator æ¥å£çš„æ–¹æ³•:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">ByteBuf</span> <span class="token function">directBuffer</span><span class="token punctuation">(</span><span class="token keyword">int</span> initialCapacity<span class="token punctuation">,</span> <span class="token keyword">int</span> maxCapacity<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>æŠ½è±¡ç±» AbstractByteBufAllocator å¯¹è¿™ä¸ªæ–¹æ³•çš„å®ç°å¦‚ä¸‹:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">ByteBuf</span> <span class="token function">directBuffer</span><span class="token punctuation">(</span><span class="token keyword">int</span> initialCapacity<span class="token punctuation">,</span> <span class="token keyword">int</span> maxCapacity<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>initialCapacity <span class="token generics"><span class="token punctuation">&lt;</span>mark<span class="token punctuation">&gt;</span></span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> maxCapacity <span class="token operator">&lt;</span><span class="token operator">/</span>mark<span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> emptyBuf<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">validate</span><span class="token punctuation">(</span>initialCapacity<span class="token punctuation">,</span> maxCapacity<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// å¾—åˆ°ä¸€ä¸ªByteBuf</span>
    <span class="token keyword">return</span> <span class="token function">newDirectBuffer</span><span class="token punctuation">(</span>initialCapacity<span class="token punctuation">,</span> maxCapacity<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>ç»§ç»­çœ‹ <strong>newDirectBuffer()</strong>  æ–¹æ³•, å‘ç°å®ƒæ˜¯ä¸€ä¸ª<strong>æŠ½è±¡æ–¹æ³•</strong>:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">protected</span> <span class="token keyword">abstract</span> <span class="token class-name">ByteBuf</span> <span class="token function">newDirectBuffer</span><span class="token punctuation">(</span><span class="token keyword">int</span> initialCapacity<span class="token punctuation">,</span> <span class="token keyword">int</span> maxCapacity<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>ç”± AbstractByteBufAllocator çš„<strong>å­ç±»</strong> <strong>PooledByteBufAllocator</strong> è´Ÿè´£å…·ä½“å®ç°. ä»£ç è·³è½¬åˆ° PooledByteBufAllocator å®ç°çš„ <strong>newDirectBuffer()</strong>  æ–¹æ³•, ä» Cache ä¸­è·å–å†…å­˜åŒºåŸŸ PoolArena, è°ƒç”¨å®ƒçš„ <strong>allocate()</strong>  æ–¹æ³•è¿›è¡Œ<strong>å†…å­˜åˆ†é…</strong>:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">protected</span> <span class="token class-name">ByteBuf</span> <span class="token function">newDirectBuffer</span><span class="token punctuation">(</span><span class="token keyword">int</span> initialCapacity<span class="token punctuation">,</span> <span class="token keyword">int</span> maxCapacity<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">PoolThreadCache</span> cache <span class="token operator">=</span> threadCache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">PoolArena</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ByteBuffer</span><span class="token punctuation">&gt;</span></span> directArena <span class="token operator">=</span> cache<span class="token punctuation">.</span>directArena<span class="token punctuation">;</span>

    <span class="token keyword">final</span> <span class="token class-name">ByteBuf</span> buf<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>directArena <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        buf <span class="token operator">=</span> directArena<span class="token punctuation">.</span><span class="token function">allocate</span><span class="token punctuation">(</span>cache<span class="token punctuation">,</span> initialCapacity<span class="token punctuation">,</span> maxCapacity<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        buf <span class="token operator">=</span> <span class="token class-name">PlatformDependent</span><span class="token punctuation">.</span><span class="token function">hasUnsafe</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span>
            <span class="token class-name">UnsafeByteBufUtil</span><span class="token punctuation">.</span><span class="token function">newUnsafeDirectByteBuf</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> initialCapacity<span class="token punctuation">,</span> maxCapacity<span class="token punctuation">)</span> <span class="token operator">:</span>
        <span class="token keyword">new</span> <span class="token class-name">UnpooledDirectByteBuf</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> initialCapacity<span class="token punctuation">,</span> maxCapacity<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token function">toLeakAwareBuffer</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p><strong>PoolArena çš„ allocate()</strong>  æ–¹æ³•å¦‚ä¸‹:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">PooledByteBuf</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">allocate</span><span class="token punctuation">(</span><span class="token class-name">PoolThreadCache</span> cache<span class="token punctuation">,</span> <span class="token keyword">int</span> reqCapacity<span class="token punctuation">,</span> <span class="token keyword">int</span> maxCapacity<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">PooledByteBuf</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> buf <span class="token operator">=</span> <span class="token function">newByteBuf</span><span class="token punctuation">(</span>maxCapacity<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">allocate</span><span class="token punctuation">(</span>cache<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> reqCapacity<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> buf<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>é‡ç‚¹åˆ†æ <strong>newByteBuf</strong> çš„å®ç°, å®ƒåŒæ ·æ˜¯ä¸ª<strong>æŠ½è±¡æ–¹æ³•</strong>, ç”±å­ç±» <strong>DirectArena å’Œ HeapArena</strong> æ¥å®ç°ä¸åŒç±»å‹çš„<strong>ç¼“å†²åŒºåˆ†é…</strong>.</p> <p><img src="https://nano-note.oss-cn-beijing.aliyuncs.com/images/image-20200728132110796.png" alt="image-20200728132110796"></p> <p>è¿™é‡Œä½¿ç”¨çš„æ˜¯<strong>ç›´æ¥å†…å­˜</strong>, å› æ­¤é‡ç‚¹åˆ†æ <strong>DirectArena</strong> çš„å®ç°:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">protected</span> <span class="token class-name">PooledByteBuf</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ByteBuffer</span><span class="token punctuation">&gt;</span></span> <span class="token function">newByteBuf</span><span class="token punctuation">(</span><span class="token keyword">int</span> maxCapacity<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">HAS_UNSAFE</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">PooledUnsafeDirectByteBuf</span><span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span>maxCapacity<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">PooledDirectByteBuf</span><span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span>maxCapacity<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>æœ€ç»ˆæ‰§è¡Œäº† <strong>PooledUnsafeDirectByteBuf</strong> çš„ <strong>newInstance()</strong>  æ–¹æ³•, ä»£ç å¦‚ä¸‹:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">static</span> <span class="token class-name">PooledDirectByteBuf</span> <span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token keyword">int</span> maxCapacity<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">PooledDirectByteBuf</span> buf <span class="token operator">=</span> <span class="token constant">RECYCLER</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    buf<span class="token punctuation">.</span><span class="token function">reuse</span><span class="token punctuation">(</span>maxCapacity<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> buf<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>é€šè¿‡ RECYCLER çš„ get() æ–¹æ³•<strong>å¾ªç¯ä½¿ç”¨ ByteBuf å¯¹è±¡</strong>, å¦‚æœæ˜¯<strong>éå†…å­˜æ± </strong>å®ç°, åˆ™ç›´æ¥åˆ›å»ºä¸€ä¸ª<strong>æ–°çš„ ByteBuf å¯¹è±¡</strong>.</p> <h4 id="nettyç¼–è§£ç ğŸŒŸ"><a href="#nettyç¼–è§£ç ğŸŒŸ" class="header-anchor">#</a> Nettyç¼–è§£ç ğŸŒŸ</h4> <p><strong>ç½‘ç»œä¸­ä¼ è¾“çš„å†…å®¹éƒ½æ˜¯å­—èŠ‚, åº”ç”¨å¦‚ä½•è§£æä¸è¯†åˆ«è¿™äº›å­—èŠ‚æµåˆ™éœ€è¦ä½¿ç”¨ç¼–è§£ç å™¨</strong>. Netty æä¾›äº†å‡ ä¸ªå¸¸ç”¨çš„ç¼–è§£ç å™¨, ä¹Ÿå¯ä»¥æ ¹æ®ä¸åŒéœ€æ±‚è‡ªå®šä¹‰ç¼–è§£ç å™¨.</p> <h5 id="_1-ç¼–ç è§£ç å™¨"><a href="#_1-ç¼–ç è§£ç å™¨" class="header-anchor">#</a> 1.ç¼–ç è§£ç å™¨</h5> <p>å½“é€šè¿‡ Netty å‘é€æˆ–æ¥æ”¶ä¸€æ¡æ¶ˆæ¯çš„æ—¶å€™, å°±ä¼šå‘ç”Ÿä¸€æ¬¡<strong>æ•°æ®è½¬æ¢</strong>, éœ€è¦å°†æ•°æ®è½¬æ¢ä¸º<strong>äºŒè¿›åˆ¶å­—èŠ‚æµ</strong>. å…¥ç«™æ—¶å­—èŠ‚æµæ¶ˆæ¯ä¼šè¢«<strong>è§£ç </strong>: ä»<strong>å­—èŠ‚æµ</strong>è½¬æ¢ä¸ºå¦ä¸€ç§æ ¼å¼(æ¯”å¦‚ Java å¯¹è±¡); <strong>å‡ºç«™</strong>æ¶ˆæ¯åˆ™ä¼šè¢«<strong>ç¼–ç æˆå­—èŠ‚æµ</strong>.</p> <p>æ³¨æ„ä¸‹é¢ç›´æ¥å‘é€å­—ç¬¦ä¸²æ˜¯å‘ä¸å‡ºå»çš„:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>ctx<span class="token punctuation">.</span><span class="token function">writeAndFlush</span><span class="token punctuation">(</span><span class="token string">&quot;Test&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>ä¸€ç§æ–¹å¼æ˜¯é€šè¿‡ ByteBuf åŒ…è£…ä¸€ä¸‹è¿›è¡Œå‘é€:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">ByteBuf</span> buf <span class="token operator">=</span> <span class="token class-name">Unpooled</span><span class="token punctuation">.</span><span class="token function">copiedBuffer</span><span class="token punctuation">(</span><span class="token string">&quot;HelloClient&quot;</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token class-name">CharsetUtil</span><span class="token punctuation">.</span><span class="token constant">UTF_8</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
ctx<span class="token punctuation">.</span><span class="token function">writeAndFlush</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>å¦ä¸€ç§æ–¹å¼åˆ™æ˜¯<strong>æ³¨å†Œä¸€ä¸ªç¼–è§£ç å™¨</strong>.</p> <p>Netty æä¾›äº†ä¸€ç³»åˆ—å®ç”¨çš„<strong>ç¼–ç è§£ç å™¨</strong>, æ¯”å¦‚ç”¨äºç¼–è§£ç å­—ç¬¦ä¸²çš„ <strong>StringEncoder å’Œ StringDecoder</strong>, ç”¨äºç¼–è§£ç å¯¹è±¡çš„ ObjectEncoder å’Œ ObjectDecoder ç­‰.</p> <p>è¿™äº›ç¼–è§£ç å™¨éƒ½<strong>å®ç°äº† ChannelInboundHandler æˆ–è€… ChannelOutboundHandler æ¥å£</strong>å¹¶å®ç° <strong>channelRead()</strong>  æ–¹æ³•. ä»¥å…¥ç«™ä¸ºä¾‹, æ¯ä¸ªä»å…¥ç«™ Channel è¯»å–çš„æ¶ˆæ¯éƒ½ä¼šè°ƒç”¨ channelRead() æ–¹æ³•, ç„¶åå®ƒå°†è°ƒç”¨ç”±å·²çŸ¥<strong>è§£ç å™¨</strong>æ‰€æä¾›çš„ <strong>decode()</strong>  æ–¹æ³•è¿›è¡Œè§£ç , å¹¶å°†<strong>å·²ç»è§£ç çš„å­—èŠ‚</strong>è½¬å‘ç»™ ChannelPipeline ä¸­çš„ä¸‹ä¸€ä¸ª ChannelInboundHandler è¿›è¡Œå¤„ç†.</p> <p><strong>å¾€ ChannelPipeline ä¸­æ³¨å†Œ StringDecoder å’Œ StringEncoder ç¼–ç å™¨</strong>çš„å®ä¾‹å¦‚ä¸‹:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>bootstrap<span class="token punctuation">.</span><span class="token function">group</span><span class="token punctuation">(</span>bossGroup<span class="token punctuation">,</span> workerGroup<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token class-name">NioServerSocketChannel</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">option</span><span class="token punctuation">(</span><span class="token class-name">ChannelOption</span><span class="token punctuation">.</span><span class="token constant">SO_BACKLOG</span><span class="token punctuation">,</span> <span class="token number">1024</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">childHandler</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ChannelInitializer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SocketChannel</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">initChannel</span><span class="token punctuation">(</span><span class="token class-name">SocketChannel</span> ch<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
            <span class="token class-name">ChannelPipeline</span> pipeline <span class="token operator">=</span> ch<span class="token punctuation">.</span><span class="token function">pipeline</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// å‘pipelineæ³¨å†Œè§£ç å™¨</span>
            pipeline<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token string">&quot;decoder&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">StringDecoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// å‘pipelineæ³¨å†Œç¼–ç å™¨</span>
            pipeline<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token string">&quot;encoder&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">StringEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// æ³¨å†Œè‡ªå·±çš„ä¸šåŠ¡å¤„ç†handler</span>
            pipeline<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ChatServerHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>è¿™é‡Œå¾€ PipeLine ä¸­æ³¨å†Œç¼–è§£ç å™¨, <strong>StringEncoder å’Œ StringEncoder éƒ½å®ç°äº† ChannelHandler æ¥å£, æ‰€ä»¥éƒ½æ˜¯ ChannelHandler</strong>, æ‰€ä»¥å®ƒä»¬ä¹Ÿæ˜¯<strong>è¢«åŠ å…¥åˆ°å¤„ç†äº‹ä»¶çš„ ChannelHandler é“¾ä¸­</strong>, è¿™ä¸ªåœ¨åˆå§‹åŒ– ChannelPipeline çš„ä»£ç ä¸­å°±èƒ½ä½“ç°.</p> <p>StringDecoder æ˜¯ä¸€ä¸ª <strong>ChannelInboundHandler</strong> ç”¨äºè§£ç å…¥ç«™æ•°æ®, StringEncoder æ˜¯ä¸€ä¸ª <strong>ChannelOutboundHandler</strong> ç”¨äºå¤„ç†å‡ºç«™æ•°æ®, æ‰€ä»¥å‡ºç«™ä¸å…¥ç«™äº‹ä»¶åªä¼šé€‰æ‹©è°ƒç”¨å…¶ä¸­çš„ä¸€ä¸ª. <strong>å‡ºç«™äº‹ä»¶åªå…³æ³¨ ChannelOutboundHandler çš„ä¸€ç³»åˆ— Handler, è€Œå…¥ç«™äº‹ä»¶åªå…³æ³¨ ChannelInboundHandler çš„ä¸€ç³»åˆ—çš„ Handler.</strong> <strong><strong>æ‰€ä»¥</strong></strong>â€‹<strong>å‡ºç«™åªä¼šæ‰§è¡Œ StringEncoder è¿›è¡Œç¼–ç </strong>, è€Œ<strong>å…¥ç«™åªä¼šæ‰§è¡Œ StringDecoder è¿›è¡Œè§£ç </strong>.</p> <p>è¿™é‡Œä¸åŒçš„ ChannelHandler <strong>åŠ å…¥å¤„ç†é“¾çš„é¡ºåº</strong>æ˜¯æœ‰è®²ç©¶çš„, å¦‚æœæ˜¯åŒä¸€ç±»å‹çš„, æ¯”å¦‚éƒ½æ˜¯ ChannelOutboundHandler åˆ™ä¼š<strong>æœ‰å…ˆåè°ƒç”¨</strong>çš„é¡ºåº. æ¯”å¦‚ä¸‹é¢å†æ³¨å†Œä¸€ä¸ªç”¨äºç¼–è§£ç å¯¹è±¡çš„ ObjectEncoder.</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>bootstrap<span class="token punctuation">.</span><span class="token function">group</span><span class="token punctuation">(</span>group<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token class-name">NioSocketChannel</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">handler</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ChannelInitializer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SocketChannel</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">initChannel</span><span class="token punctuation">(</span><span class="token class-name">SocketChannel</span> ch<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
            <span class="token class-name">ChannelPipeline</span> pipeline <span class="token operator">=</span> ch<span class="token punctuation">.</span><span class="token function">pipeline</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// æ³¨å†Œä¸¤ä¸ªç¼–ç å™¨</span>
            pipeline<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">StringEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            pipeline<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ObjectEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h5 id="_2-è‡ªå®šä¹‰ç¼–è§£ç å™¨"><a href="#_2-è‡ªå®šä¹‰ç¼–è§£ç å™¨" class="header-anchor">#</a> 2.è‡ªå®šä¹‰ç¼–è§£ç å™¨</h5> <p>è‡ªå®šä¹‰ç¼–è§£ç å™¨å¯ä»¥é€šè¿‡ç»§æ‰¿ <strong>ByteToMessageDecoder å’Œ MessageToByteEncoder ç±»å®ç°</strong>.</p> <p>æ¯”å¦‚å¯ä»¥è‡ªå®šä¹‰ä¸€ä¸ªç¼–è§£ç å™¨, å®ç°ç›´æ¥é€šè¿‡ä¸Šä¸‹æ–‡å‘é€ä¸€ä¸ª <strong>Long å‹</strong>æ•°æ®.</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>ctx<span class="token punctuation">.</span><span class="token function">writeAndFlush</span><span class="token punctuation">(</span><span class="token number">2000L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><strong>è§£ç å™¨</strong>:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ByteToLongDecoder</span> <span class="token keyword">extends</span> <span class="token class-name">ByteToMessageDecoder</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">decode</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">,</span> <span class="token class-name">ByteBuf</span> in<span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> out<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;ByteToLongDecoder decoder è¢«è°ƒç”¨&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// å› ä¸ºlongä¸º8ä¸ªå­—èŠ‚, éœ€è¦åˆ¤æ–­æœ‰8ä¸ªå­—èŠ‚, æ‰èƒ½è¯»å–ä¸€ä¸ªlong</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>in<span class="token punctuation">.</span><span class="token function">readableBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;=</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            out<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>in<span class="token punctuation">.</span><span class="token function">readLong</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p><strong>ç¼–ç å™¨</strong>:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LongToByteEncoder</span> <span class="token keyword">extends</span> <span class="token class-name">MessageToByteEncoder</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">encode</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">,</span> <span class="token class-name">Long</span> msg<span class="token punctuation">,</span> <span class="token class-name">ByteBuf</span> out<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;LongToByteEncoder encoderè¢«è°ƒç”¨&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;msg=&quot;</span> <span class="token operator">+</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
        out<span class="token punctuation">.</span><span class="token function">writeLong</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>åº”ç”¨åˆå§‹åŒ–æ—¶æ³¨å†Œåˆ° ChannelPipeline ä¸­å³å¯.</p> <h4 id="nettyç²˜åŒ…æ‹†åŒ…ğŸŒŸ"><a href="#nettyç²˜åŒ…æ‹†åŒ…ğŸŒŸ" class="header-anchor">#</a> Nettyç²˜åŒ…æ‹†åŒ…ğŸŒŸ</h4> <h5 id="_1-æ¦‚è¿°-3"><a href="#_1-æ¦‚è¿°-3" class="header-anchor">#</a> 1.æ¦‚è¿°</h5> <blockquote><p>ä»€ä¹ˆæ˜¯ TCP ç²˜åŒ…ä¸æ‹†åŒ…</p></blockquote> <p>TCP ç²˜åŒ…æ‹†åŒ…æ˜¯æŒ‡å‘é€æ–¹å‘é€çš„<strong>è‹¥å¹²æ•°æ®åŒ…</strong>åˆ°æ¥æ”¶æ–¹æ¥æ”¶æ—¶<strong>ç²˜æˆä¸€åŒ…</strong>æˆ–æŸä¸ª<strong>æ•°æ®åŒ…è¢«æ‹†å¼€æ¥æ”¶</strong>. å¦‚ä¸‹å›¾æ‰€ç¤º, client å‘äº†ä¸¤ä¸ªæ•°æ®åŒ… D1 å’Œ D2, ä½† server ç«¯å¯èƒ½ä¼šæ”¶åˆ°å¦‚ä¸‹å‡ ç§æƒ…å†µçš„æ•°æ®.</p> <p><img src="https://nano-note.oss-cn-beijing.aliyuncs.com/images/image-20230205112651738.png" alt="" title="ç²˜åŒ…ä¸æ‹†åŒ…ç¤ºæ„å›¾"></p> <p>æ”¹é€ å‰é¢èŠå¤©å®¤çš„å®¢æˆ·ç«¯ç¤ºä¾‹ä»£ç :</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ChatClient</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>

        <span class="token class-name">EventLoopGroup</span> group <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NioEventLoopGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">Bootstrap</span> bootstrap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Bootstrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">group</span><span class="token punctuation">(</span>group<span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token class-name">NioSocketChannel</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">handler</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ChannelInitializer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SocketChannel</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token annotation punctuation">@Override</span>
                        <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">initChannel</span><span class="token punctuation">(</span><span class="token class-name">SocketChannel</span> ch<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
                            <span class="token class-name">ChannelPipeline</span> pipeline <span class="token operator">=</span> ch<span class="token punctuation">.</span><span class="token function">pipeline</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            pipeline<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">StringEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            pipeline<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">StringDecoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token comment">// æ·»åŠ å®¢æˆ·ç«¯å¤„ç†å™¨</span>
                            pipeline<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ChatClientHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">ChannelFuture</span> channelFuture <span class="token operator">=</span> bootstrap<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token string">&quot;127.0.0.1&quot;</span><span class="token punctuation">,</span> <span class="token number">9000</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// å¾—åˆ°channel</span>
            <span class="token class-name">Channel</span> channel <span class="token operator">=</span> channelFuture<span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;&lt;mark&gt;&lt;/mark&gt;&lt;mark&gt;&lt;/mark&gt;&quot;</span> <span class="token operator">+</span> channel<span class="token punctuation">.</span><span class="token function">localAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;&lt;mark&gt;&lt;/mark&gt;&lt;mark&gt;&lt;/mark&gt;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token comment">// æ­¤å¤„è¿æ¥æˆåŠŸåç›´æ¥è¿ç»­å‘200ä¸ªå­—ç¬¦ä¸²</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">200</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                channel<span class="token punctuation">.</span><span class="token function">writeAndFlush</span><span class="token punctuation">(</span><span class="token string">&quot;Hello!NanoJava!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            group<span class="token punctuation">.</span><span class="token function">shutdownGracefully</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br></div></div><p>å³è®©å®¢æˆ·ç«¯è¿æ¥æˆåŠŸåç›´æ¥è¿ç»­å‘ 200 ä¸ªå­—ç¬¦ä¸². è¿™æ—¶å€™çœ‹çœ‹æœåŠ¡ç«¯æ¥æ”¶çš„æ¶ˆæ¯:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token operator">/</span><span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span><span class="token operator">:</span><span class="token number">63873</span> ä¸Šçº¿äº†

<span class="token class-name">Hello</span><span class="token operator">!</span><span class="token class-name">NanoJava</span><span class="token operator">!</span>
<span class="token class-name">Hello</span><span class="token operator">!</span><span class="token class-name">NanoJava</span><span class="token operator">!</span>
<span class="token class-name">Hello</span><span class="token operator">!</span><span class="token class-name">NanoJava</span><span class="token operator">!</span><span class="token class-name">Hello</span><span class="token operator">!</span><span class="token class-name">NanoJava</span><span class="token operator">!</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token class-name">Hello</span><span class="token operator">!</span><span class="token class-name">NanoJava</span><span class="token operator">!</span><span class="token class-name">Hello</span><span class="token operator">!</span><span class="token class-name">NanoJava</span><span class="token operator">!</span>
<span class="token class-name">Hello</span><span class="token operator">!</span><span class="token class-name">NanoJava</span><span class="token operator">!</span><span class="token class-name">Hello</span><span class="token operator">!</span><span class="token class-name">NanoJava</span><span class="token operator">!</span><span class="token class-name">Hello</span><span class="token operator">!</span><span class="token class-name">NanoJava</span><span class="token operator">!</span>
<span class="token class-name">Hello</span><span class="token operator">!</span><span class="token class-name">NanoJava</span><span class="token operator">!</span>
<span class="token class-name">Hello</span><span class="token operator">!</span><span class="token class-name">NanoJava</span><span class="token operator">!</span><span class="token class-name">Hello</span><span class="token operator">!</span><span class="token class-name">NanoJava</span><span class="token operator">!</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token class-name">Hello</span><span class="token operator">!</span><span class="token class-name">NanoJava</span><span class="token operator">!</span><span class="token class-name">Hello</span><span class="token operator">!</span><span class="token class-name">NanoJava</span><span class="token operator">!</span>
<span class="token class-name">Hello</span><span class="token operator">!</span><span class="token class-name">NanoJava</span><span class="token operator">!</span>
<span class="token class-name">Hello</span><span class="token operator">!</span><span class="token class-name">NanoJava</span><span class="token operator">!</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token class-name">Hello</span><span class="token operator">!</span><span class="token class-name">NanoJava</span><span class="token operator">!</span>
<span class="token class-name">Hello</span><span class="token operator">!</span><span class="token class-name">NanoJava</span><span class="token operator">!</span><span class="token class-name">Hello</span><span class="token operator">!</span><span class="token class-name">NanoJava</span><span class="token operator">!</span>
<span class="token operator">/</span><span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span><span class="token operator">:</span><span class="token number">63873</span> ä¸‹çº¿äº†

<span class="token class-name">ChannelGroup</span> size<span class="token operator">=</span><span class="token number">0</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><p>è¿™é‡Œå°±å¾ˆæ˜æ˜¾çš„å‘ç”Ÿäº†ç²˜åŒ…ç°è±¡.</p> <blockquote><p>ä¸ºä»€ä¹ˆä¼šå‡ºç°ç²˜åŒ…ç°è±¡</p></blockquote> <p>TCP åè®®ä¸­<strong>æ”¶å‘ä¸¤ç«¯(å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ç«¯)éƒ½è¦æœ‰æˆå¯¹çš„ socket, å‘é€ç«¯ä¸ºäº†å°†å¤šä¸ªåŒ…æ›´æœ‰æ•ˆçš„å‘ç»™å¯¹æ–¹, ä½¿ç”¨äº†ä¼˜åŒ–æ–¹æ³•(Nagle ç®—æ³•), å°†å¤šæ¬¡é—´éš”è¾ƒå°ä¸”æ•°æ®é‡å°çš„æ•°æ®, åˆå¹¶æˆä¸€ä¸ªå¤§çš„æ•°æ®å—, ç„¶åè¿›è¡Œå°åŒ…</strong>. è¿™æ ·åšè™½ç„¶æé«˜äº†æ•ˆç‡, ä½†æ¥æ”¶ç«¯å°±<strong>éš¾äºåˆ†è¾¨å‡ºå®Œæ•´çš„æ•°æ®åŒ…</strong>äº†, å› ä¸ºé¢å‘æµçš„é€šä¿¡æ˜¯<strong>æ— æ¶ˆæ¯ä¿æŠ¤è¾¹ç•Œ</strong>çš„.</p> <h5 id="_2-ç²˜åŒ…æ‹†åŒ…ä¸€èˆ¬è§£å†³æ–¹æ¡ˆ"><a href="#_2-ç²˜åŒ…æ‹†åŒ…ä¸€èˆ¬è§£å†³æ–¹æ¡ˆ" class="header-anchor">#</a> 2.ç²˜åŒ…æ‹†åŒ…ä¸€èˆ¬è§£å†³æ–¹æ¡ˆ</h5> <h6 id="_1-æŠ¥æ–‡å›ºå®šé•¿åº¦"><a href="#_1-æŠ¥æ–‡å›ºå®šé•¿åº¦" class="header-anchor">#</a> (1)æŠ¥æ–‡å›ºå®šé•¿åº¦</h6> <p>å®¢æˆ·ç«¯åœ¨å‘é€æ•°æ®åŒ…çš„æ—¶å€™, æ¯ä¸ªåŒ…éƒ½<strong>å›ºå®šé•¿åº¦</strong>, å¦‚ 1024 ä¸ªå­—èŠ‚å¤§å°, å¦‚æœå®¢æˆ·ç«¯å‘é€çš„æ•°æ®é•¿åº¦ä¸è¶³ 1024 ä¸ªå­—èŠ‚, åˆ™é€šè¿‡<strong>è¡¥å……ç©ºæ ¼çš„æ–¹å¼è¡¥å…¨åˆ°æŒ‡å®šé•¿åº¦</strong>.</p> <h6 id="_2-æ·»åŠ æŠ¥æ–‡åˆ†éš”ç¬¦"><a href="#_2-æ·»åŠ æŠ¥æ–‡åˆ†éš”ç¬¦" class="header-anchor">#</a> (2)æ·»åŠ æŠ¥æ–‡åˆ†éš”ç¬¦</h6> <p>æ¯æ¡æ•°æ®æœ‰<strong>å›ºå®šçš„æ ¼å¼</strong>(å¼€å§‹ç¬¦, ç»“æŸç¬¦), è¿™ç§æ–¹æ³•ç®€å•æ˜“è¡Œ, ä½†é€‰æ‹©å¼€å§‹ç¬¦å’Œç»“æŸç¬¦çš„æ—¶å€™ä¸€å®šè¦æ³¨æ„æ•°æ®æŠ¥æ–‡<strong>å†…å®¹ä¸€å®šä¸èƒ½å‡ºç°</strong>å¼€å§‹ç¬¦æˆ–ç»“æŸç¬¦, ä¹Ÿå°±æ˜¯åˆ†éš”ç¬¦éœ€è¦å¯¹äºæŠ¥æ–‡é€æ˜.</p> <p>æ¯”å¦‚å®¢æˆ·ç«¯åœ¨æ¯ä¸ªåŒ…çš„<strong>æœ«å°¾ä½¿ç”¨å›ºå®šçš„åˆ†éš”ç¬¦</strong>, å¦‚ &quot;\r\n&quot;, å¦‚æœä¸€ä¸ªåŒ…è¢«æ‹†åˆ†äº†, åˆ™ç­‰å¾…ä¸‹ä¸€ä¸ªåŒ…å‘é€è¿‡æ¥ä¹‹åæ‰¾åˆ°å…¶ä¸­çš„ &quot;\r\n&quot;, ç„¶åå¯¹å…¶æ‹†åˆ†åçš„å¤´éƒ¨éƒ¨åˆ†ä¸å‰ä¸€ä¸ªåŒ…çš„å‰©ä½™éƒ¨åˆ†è¿›è¡Œ<strong>åˆå¹¶</strong>, è¿™æ ·å°±å¾—åˆ°äº†ä¸€ä¸ªå®Œæ•´çš„åŒ….</p> <h6 id="_3-æ¶ˆæ¯æºå¸¦å‘é€é•¿åº¦"><a href="#_3-æ¶ˆæ¯æºå¸¦å‘é€é•¿åº¦" class="header-anchor">#</a> (3)æ¶ˆæ¯æºå¸¦å‘é€é•¿åº¦</h6> <p>å°†<strong>æ¶ˆæ¯åˆ†ä¸ºå¤´éƒ¨å’Œæ¶ˆæ¯ä½“</strong>, åœ¨æ¶ˆæ¯å¤´éƒ¨ä¸­ä¿å­˜æœ‰å½“å‰<strong>æ•´ä¸ªæ¶ˆæ¯çš„é•¿åº¦</strong>, åªæœ‰åœ¨è¯»å–åˆ°è¶³å¤Ÿé•¿åº¦çš„æ¶ˆæ¯ä¹‹åæ‰ç®—æ˜¯è¯»åˆ°ä¸€æ¡å®Œæ•´çš„æ¶ˆæ¯.</p> <p>å‘é€æ¯æ¡æ•°æ®çš„æ—¶å€™, å°†æ•°æ®çš„<strong>é•¿åº¦ä¸€å¹¶å‘é€</strong>, æ¯”å¦‚å¯ä»¥é€‰æ‹©<strong>æ¯æ¡æ•°æ®çš„å‰ 4 ä½æ˜¯æ•°æ®çš„é•¿åº¦</strong>, åº”ç”¨å±‚å¤„ç†æ—¶å¯ä»¥æ ¹æ®é•¿åº¦æ¥åˆ¤æ–­æ¯æ¡æ•°æ®çš„å¼€å§‹å’Œç»“æŸ.</p> <p>ç¤ºä¾‹ä»£ç å¦‚ä¸‹: è¿™é‡Œå°±æ˜¯<strong>è‡ªå®šä¹‰æ¶ˆæ¯ä½“</strong>å¹¶é…åˆè‡ªå®šä¹‰çš„ç¼–è§£ç å™¨è§£å†³ç²˜åŒ…æ‹†åŒ…é—®é¢˜.</p> <p>é¦–å…ˆ<strong>è‡ªå®šä¹‰é€šä¿¡çš„æ¶ˆæ¯ä½“</strong>. æ¶ˆæ¯ä½“åŒ…å«å½“å‰æ¶ˆæ¯çš„é•¿åº¦å’ŒæŠ¥æ–‡å†…å®¹.</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Data</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyMessageProtocol</span> <span class="token punctuation">{</span>

    <span class="token comment">/** å®šä¹‰ä¸€æ¬¡å‘é€åŒ…ä½“é•¿åº¦ */</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> len<span class="token punctuation">;</span>

    <span class="token comment">/** ä¸€æ¬¡å‘é€åŒ…ä½“å†…å®¹ */</span>
    <span class="token keyword">private</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> content<span class="token punctuation">;</span>   
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>è‡ªå®šä¹‰<strong>ç¼–ç å™¨</strong>:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyMessageEncoder</span> <span class="token keyword">extends</span> <span class="token class-name">MessageToByteEncoder</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MyMessageProtocol</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">encode</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">,</span> <span class="token class-name">MyMessageProtocol</span> msg<span class="token punctuation">,</span> <span class="token class-name">ByteBuf</span> out<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;MyMessageEncoder encoder æ–¹æ³•è¢«è°ƒç”¨&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        out<span class="token punctuation">.</span><span class="token function">writeInt</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span><span class="token function">getLen</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        out<span class="token punctuation">.</span><span class="token function">writeBytes</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span><span class="token function">getContent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>è‡ªå®šä¹‰<strong>è§£ç å™¨</strong>:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyMessageDecoder</span> <span class="token keyword">extends</span> <span class="token class-name">ByteToMessageDecoder</span> <span class="token punctuation">{</span>

    <span class="token keyword">int</span> length <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">decode</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">,</span> <span class="token class-name">ByteBuf</span> in<span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> out<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;MyMessageDecoder decodeè¢«è°ƒç”¨&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// éœ€è¦å°†å¾—åˆ°äºŒè¿›åˆ¶å­—èŠ‚ç -&gt; MyMessageProtocol æ•°æ®åŒ…(å¯¹è±¡)</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>in<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// å…ˆæ”¶intç±»å‹çš„å­—èŠ‚ä»£è¡¨æ˜¯é•¿åº¦</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>in<span class="token punctuation">.</span><span class="token function">readableBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;=</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>length <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                length <span class="token operator">=</span> in<span class="token punctuation">.</span><span class="token function">readInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>in<span class="token punctuation">.</span><span class="token function">readableBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;å½“å‰å¯è¯»æ•°æ®ä¸å¤Ÿ, ç»§ç»­ç­‰å¾…. . &quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> content <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span>length<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>in<span class="token punctuation">.</span><span class="token function">readableBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;=</span> length<span class="token punctuation">)</span><span class="token punctuation">{</span>
                in<span class="token punctuation">.</span><span class="token function">readBytes</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// è¯»å–å®Œæˆå°è£…æˆMyMessageProtocolå¯¹è±¡, ä¼ é€’åˆ°ä¸‹ä¸€ä¸ªhandlerä¸šåŠ¡å¤„ç†</span>
                <span class="token class-name">MyMessageProtocol</span> messageProtocol <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyMessageProtocol</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                messageProtocol<span class="token punctuation">.</span><span class="token function">setLen</span><span class="token punctuation">(</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
                messageProtocol<span class="token punctuation">.</span><span class="token function">setContent</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span>
                out<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>messageProtocol<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            length <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br></div></div><h5 id="_3-nettyç²˜åŒ…æ‹†åŒ…è§£å†³æ–¹æ¡ˆ"><a href="#_3-nettyç²˜åŒ…æ‹†åŒ…è§£å†³æ–¹æ¡ˆ" class="header-anchor">#</a> 3.Nettyç²˜åŒ…æ‹†åŒ…è§£å†³æ–¹æ¡ˆ</h5> <p>åŸºäºä¸Šè¿°é€šç”¨çš„ç²˜åŒ…æ‹†åŒ…è§£å†³æ–¹æ¡ˆ, Netty æä¾›äº†ä¸€äº›<strong>å¯¹åº”çš„å®ç°ç±»</strong>, å…¶å®åŸç†è·Ÿä¸Šé¢çš„è‡ªå®šä¹‰çš„ä¸€è‡´.</p> <h6 id="_1-fixedlengthframedecoder"><a href="#_1-fixedlengthframedecoder" class="header-anchor">#</a> (1)FixedLengthFrameDecoder</h6> <p>FixedLengthFrameDecoder é€šè¿‡<strong>å›ºå®šæŠ¥æ–‡é•¿åº¦</strong>çš„æ–¹å¼æ¥è§£å†³ç²˜åŒ…å’Œæ‹†åŒ…é—®é¢˜, è¯¥è§£ç å™¨ä¼š<strong>æ¯æ¬¡è¯»å–å›ºå®šé•¿åº¦çš„æ¶ˆæ¯</strong>, å¦‚æœå½“å‰è¯»å–åˆ°çš„æ¶ˆæ¯ä¸è¶³æŒ‡å®šé•¿åº¦, é‚£ä¹ˆå°±ä¼š<strong>ç­‰å¾…</strong>ä¸‹ä¸€ä¸ªæ¶ˆæ¯åˆ°è¾¾åè¿›è¡Œè¡¥è¶³. ä½¿ç”¨åªéœ€è¦åœ¨<strong>æ„é€ å‡½æ•°ä¸­æŒ‡å®šæ¯ä¸ªæ¶ˆæ¯çš„é•¿åº¦</strong>å³å¯.</p> <p>éœ€è¦æ³¨æ„çš„æ˜¯, å¯¹äº FixedLengthFrameDecoder è§£ç å™¨, Netty <strong>å¹¶æ²¡æœ‰</strong>æä¾›ç›¸åº”çš„ç¼–ç å™¨ FixedLengthFrameEncoder. è¿™æ˜¯å› ä¸ºè§£ç éœ€è¦ç­‰å¾…ä¸‹ä¸€ä¸ªåŒ…çš„è¿›è¡Œè¡¥å…¨çš„, ä»£ç ç›¸å¯¹å¤æ‚; è€Œç¼–ç å™¨ç”¨æˆ·å¯ä»¥è‡ªè¡Œç¼–å†™, å› ä¸ºç¼–ç æ—¶åªéœ€è¦å°†ä¸è¶³æŒ‡å®šé•¿åº¦çš„éƒ¨åˆ†è¿›è¡Œè¡¥å…¨å³å¯. è¿™é‡Œè‡ªå·±å®ç°äº†ä¸€ä¸‹ FixedLengthFrameEncoder. è¿™é‡Œ FixedLengthFrameEncoder å®ç°äº† <strong>decode()</strong>  æ–¹æ³•, åœ¨è¯¥æ–¹æ³•ä¸­, ä¸»è¦æ˜¯å°†æ¶ˆæ¯é•¿åº¦ä¸è¶³ 20 çš„æ¶ˆæ¯è¿›è¡Œç©ºæ ¼è¡¥å…¨, æ»¡è¶³çº¦å®šçš„ä»¥å›ºå®šæŠ¥æ–‡é•¿åº¦è¿›è¡Œé€šä¿¡.</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FixedLengthFrameEncoder</span> <span class="token keyword">extends</span> <span class="token class-name">MessageToByteEncoder</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> length<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">FixedLengthFrameEncoder</span><span class="token punctuation">(</span><span class="token keyword">int</span> length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>length <span class="token operator">=</span> length<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">encode</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">,</span> <span class="token class-name">String</span> msg<span class="token punctuation">,</span> <span class="token class-name">ByteBuf</span> out<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token comment">// è¶…è¿‡æŒ‡å®šé•¿åº¦çš„æ¶ˆæ¯ç›´æ¥æŠ›å‡ºå¼‚å¸¸</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>msg<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">UnsupportedOperationException</span><span class="token punctuation">(</span><span class="token string">&quot;Message too long.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// é•¿åº¦ä¸è¶³åˆ™è¿›è¡Œè¡¥å…¨</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>msg<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            msg <span class="token operator">=</span> <span class="token function">addSpace</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        ctx<span class="token punctuation">.</span><span class="token function">writeAndFlush</span><span class="token punctuation">(</span><span class="token class-name">Unpooled</span><span class="token punctuation">.</span><span class="token function">wrappedBuffer</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// è¿›è¡Œç©ºæ ¼è¡¥å…¨</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> <span class="token function">addSpace</span><span class="token punctuation">(</span><span class="token class-name">String</span> msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">StringBuilder</span> builder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> length <span class="token operator">-</span> msg<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            builder<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot; &quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> builder<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br></div></div><p>å¯¹ FixedLengthFrameDecoder(Netty æä¾›) å’Œ FixedLengthFrameEncoder(è‡ªå·±å®ç°) è¿›è¡Œæ³¨å†Œçš„å®ä¾‹å¦‚ä¸‹:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FixedLengthFrameDecoderServer</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">int</span> port<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
        <span class="token class-name">EventLoopGroup</span> bossGroup <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NioEventLoopGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">EventLoopGroup</span> workerGroup <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NioEventLoopGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">ServerBootstrap</span> bootstrap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ServerBootstrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            bootstrap<span class="token punctuation">.</span><span class="token function">group</span><span class="token punctuation">(</span>bossGroup<span class="token punctuation">,</span> workerGroup<span class="token punctuation">)</span>
                     <span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token class-name">NioServerSocketChannel</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
                     <span class="token punctuation">.</span><span class="token function">option</span><span class="token punctuation">(</span><span class="token class-name">ChannelOption</span><span class="token punctuation">.</span><span class="token constant">SO_BACKLOG</span><span class="token punctuation">,</span> <span class="token number">1024</span><span class="token punctuation">)</span>
                     <span class="token punctuation">.</span><span class="token function">handler</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">LoggingHandler</span><span class="token punctuation">(</span><span class="token class-name">LogLevel</span><span class="token punctuation">.</span><span class="token constant">INFO</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                     <span class="token punctuation">.</span><span class="token function">childHandler</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ChannelInitializer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SocketChannel</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                         <span class="token annotation punctuation">@Override</span>
                         <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">initChannel</span><span class="token punctuation">(</span><span class="token class-name">SocketChannel</span> ch<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
                             <span class="token comment">// å°†FixedLengthFrameDecoderæ·»åŠ åˆ°pipelineä¸­, æŒ‡å®šå›ºå®šé•¿åº¦ä¸º20</span>
                             ch<span class="token punctuation">.</span><span class="token function">pipeline</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">FixedLengthFrameDecoder</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                             <span class="token comment">// å°†å‰ä¸€æ­¥è§£ç å¾—åˆ°çš„æ•°æ®è½¬ç ä¸ºå­—ç¬¦ä¸²</span>
                             ch<span class="token punctuation">.</span><span class="token function">pipeline</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">StringDecoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                             <span class="token comment">// è¿™é‡ŒFixedLengthFrameEncoderæ˜¯è‡ªå®šä¹‰çš„, ç”¨äºå°†é•¿åº¦ä¸è¶³20çš„æ¶ˆæ¯è¿›è¡Œè¡¥å…¨ç©ºæ ¼</span>
                             ch<span class="token punctuation">.</span><span class="token function">pipeline</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">FixedLengthFrameDecoder</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                             <span class="token comment">// æœ€ç»ˆçš„æ•°æ®å¤„ç†</span>
                             ch<span class="token punctuation">.</span><span class="token function">pipeline</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ChatServerHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                         <span class="token punctuation">}</span>
                     <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token class-name">ChannelFuture</span> future <span class="token operator">=</span> bootstrap<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>port<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            future<span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">closeFuture</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            bossGroup<span class="token punctuation">.</span><span class="token function">shutdownGracefully</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            workerGroup<span class="token punctuation">.</span><span class="token function">shutdownGracefully</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
        <span class="token keyword">new</span> <span class="token class-name">FixedLengthFrameDecoderServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token number">8080</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br></div></div><p>ä¸Šé¢çš„ HandlerPipeline ä¸­, å¯¹äºå…¥ç«™æ•°æ®, ä¸»è¦æ·»åŠ äº† FixedLengthFrameDecoder å’Œ StringDecoder, å‰é¢ä¸€ä¸ªç”¨äºå¤„ç†å›ºå®šé•¿åº¦çš„æ¶ˆæ¯çš„ç²˜åŒ…å’Œæ‹†åŒ…é—®é¢˜, ç¬¬äºŒä¸ªåˆ™æ˜¯å°†å¤„ç†ä¹‹åçš„æ¶ˆæ¯è½¬æ¢ä¸ºå­—ç¬¦ä¸². æœ€åç”± ChatServerHandler ç”¨äºå¤„ç†æœ€ç»ˆå¾—åˆ°çš„æ•°æ®. å¤„ç†å®Œæˆå, å°†ç»“æœæ•°æ®äº¤ç”±è‡ªå·±å®ç°çš„ FixedLengthFrameEncoder è¿›è¡Œå¤„ç†.</p> <h6 id="_2-linebasedframedecoderä¸delimiterbasedframedecoder"><a href="#_2-linebasedframedecoderä¸delimiterbasedframedecoder" class="header-anchor">#</a> (2)LineBasedFrameDecoderä¸DelimiterBasedFrameDecoder</h6> <p><strong>LineBasedFrameDecoder</strong> å’Œ <strong>DelimiterBasedFrameDecoder</strong> é€šè¿‡<strong>åˆ†éš”ç¬¦</strong>è§£å†³ç²˜åŒ…å’Œæ‹†åŒ…é—®é¢˜. è¿™é‡Œ LineBasedFrameDecoder ä¸»è¦æ˜¯é€šè¿‡<strong>æ¢è¡Œç¬¦</strong>(å³ \n æˆ– \r\n)å¯¹æ•°æ®è¿›è¡Œç²˜åŒ…æ‹†åŒ…å¤„ç†; è€Œ DelimiterBasedFrameDecoder çš„ä½œç”¨åˆ™æ˜¯é€šè¿‡<strong>ç”¨æˆ·æŒ‡å®šçš„åˆ†éš”ç¬¦</strong>å¯¹æ•°æ®è¿›è¡Œç²˜åŒ…æ‹†åŒ…å¤„ç†.</p> <p>ä¸ FixedLengthFrameDecoder ç±»ä¼¼, è¿™ä¸¤ä¸ªç±»éƒ½æ˜¯<strong>è§£ç å™¨ç±»</strong>, è€Œå¯¹äºæ•°æ®çš„ç¼–ç , ä¹Ÿå³åœ¨æ¯ä¸ªæ•°æ®åŒ…æœ€åæ·»åŠ æ¢è¡Œç¬¦æˆ–è€…æŒ‡å®šåˆ†å‰²ç¬¦çš„éƒ¨åˆ†<strong>éœ€è¦ç”¨æˆ·è‡ªè¡Œè¿›è¡Œå¤„ç†</strong>. è¿™é‡Œä¹Ÿç»™å‡º DelimiterBasedFrameEncoder è‡ªå®šä¹‰ç¼–ç å™¨çš„å®ç°ä¾‹å­, å…¶ä¸»è¦ä½œç”¨æ˜¯åœ¨è¿”å›çš„å“åº”æ•°æ®ä¹‹åæ·»åŠ åˆ†éš”ç¬¦:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DelimiterBasedFrameEncoder</span> <span class="token keyword">extends</span> <span class="token class-name">MessageToByteEncoder</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token class-name">String</span> delimiter<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">DelimiterBasedFrameEncoder</span><span class="token punctuation">(</span><span class="token class-name">String</span> delimiter<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>delimiter <span class="token operator">=</span> delimiter<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">encode</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">,</span> <span class="token class-name">String</span> msg<span class="token punctuation">,</span> <span class="token class-name">ByteBuf</span> out<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token comment">// åœ¨å“åº”çš„æ•°æ®åé¢æ·»åŠ åˆ†éš”ç¬¦</span>
        ctx<span class="token punctuation">.</span><span class="token function">writeAndFlush</span><span class="token punctuation">(</span><span class="token class-name">Unpooled</span><span class="token punctuation">.</span><span class="token function">wrappedBuffer</span><span class="token punctuation">(</span><span class="token punctuation">(</span>msg <span class="token operator">+</span> delimiter<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>ä¸‹é¢æ˜¯æ³¨å†Œ DelimiterBasedFrameDecoder å’Œ DelimiterBasedFrameEncoder çš„ç¤ºä¾‹, è¿™é‡Œä»…ç»™å‡ºäº†åˆå§‹åŒ– HandlerPipeline çš„é€»è¾‘:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">initChannel</span><span class="token punctuation">(</span><span class="token class-name">SocketChannel</span> ch<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token class-name">String</span> delimiter <span class="token operator">=</span> <span class="token string">&quot;_$&quot;</span><span class="token punctuation">;</span>
    <span class="token comment">// å°†delimiterè®¾ç½®åˆ°DelimiterBasedFrameDecoderä¸­, ç»è¿‡è¯¥è§£ç ä¸€å™¨è¿›è¡Œå¤„ç†ä¹‹å, æºæ•°æ®å°†ä¼š</span>
    <span class="token comment">// è¢«æŒ‰ç…§_$è¿›è¡Œåˆ†éš”, è¿™é‡Œ1024æŒ‡çš„æ˜¯åˆ†éš”çš„æœ€å¤§é•¿åº¦, å³å½“è¯»å–åˆ°1024ä¸ªå­—èŠ‚çš„æ•°æ®ä¹‹å, è‹¥è¿˜æ˜¯æœª</span>
    <span class="token comment">// è¯»å–åˆ°åˆ†éš”ç¬¦, åˆ™èˆå¼ƒå½“å‰æ•°æ®æ®µ, å› ä¸ºå…¶å¾ˆæœ‰å¯èƒ½æ˜¯ç”±äºç æµç´Šä¹±é€ æˆçš„</span>
    ch<span class="token punctuation">.</span><span class="token function">pipeline</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">DelimiterBasedFrameDecoder</span><span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">,</span>
        <span class="token class-name">Unpooled</span><span class="token punctuation">.</span><span class="token function">wrappedBuffer</span><span class="token punctuation">(</span>delimiter<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// å°†åˆ†éš”ä¹‹åçš„å­—èŠ‚æ•°æ®è½¬æ¢ä¸ºå­—ç¬¦ä¸²æ•°æ®</span>
    ch<span class="token punctuation">.</span><span class="token function">pipeline</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">StringDecoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// è¿™æ˜¯æˆ‘ä»¬è‡ªå®šä¹‰çš„ä¸€ä¸ªç¼–ç å™¨, ä¸»è¦ä½œç”¨æ˜¯åœ¨è¿”å›çš„å“åº”æ•°æ®æœ€åæ·»åŠ åˆ†éš”ç¬¦</span>
    ch<span class="token punctuation">.</span><span class="token function">pipeline</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">DelimiterBasedFrameEncoder</span><span class="token punctuation">(</span>delimiter<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// æœ€ç»ˆå¤„ç†æ•°æ®å¹¶ä¸”è¿”å›å“åº”çš„handler</span>
    ch<span class="token punctuation">.</span><span class="token function">pipeline</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ChatServerHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>ä¸Šé¢ pipeline çš„è®¾ç½®ä¸­, æ·»åŠ çš„è§£ç å™¨ä¸º DelimiterBasedFrameDecoder å’Œ StringDecoder, ç»è¿‡è¿™ä¸¤ä¸ªå¤„ç†å™¨å¤„ç†ä¹‹å, æ¥æ”¶åˆ°çš„<strong>å­—èŠ‚æµå°±ä¼šè¢«åˆ†éš”</strong>, å¹¶ä¸”è½¬æ¢ä¸ºå­—ç¬¦ä¸²æ•°æ®, æœ€ç»ˆäº¤ç”± ChatServerHandler å¤„ç†.</p> <h4 id="nettyé›¶æ‹·è´ğŸŒŸ"><a href="#nettyé›¶æ‹·è´ğŸŒŸ" class="header-anchor">#</a> Nettyé›¶æ‹·è´ğŸŒŸ</h4> <h5 id="_1-javaæ“ä½œç›´æ¥å†…å­˜"><a href="#_1-javaæ“ä½œç›´æ¥å†…å­˜" class="header-anchor">#</a> 1.Javaæ“ä½œç›´æ¥å†…å­˜</h5> <p>ç›´æ¥å†…å­˜(Direct Memory)å¹¶ä¸æ˜¯è™šæ‹Ÿæœºè¿è¡Œæ—¶æ•°æ®åŒºçš„ä¸€éƒ¨åˆ†, ä¹Ÿä¸æ˜¯ JVM è§„èŒƒä¸­å®šä¹‰çš„å†…å­˜åŒºåŸŸ, æŸäº›æƒ…å†µä¸‹è¿™éƒ¨åˆ†å†…å­˜ä¹Ÿä¼šè¢«é¢‘ç¹åœ°ä½¿ç”¨, è€Œä¸”ä¹Ÿå¯èƒ½å¯¼è‡´ OutOfMemoryError å¼‚å¸¸å‡ºç°. (å‚è€ƒ: ç›´æ¥å†…å­˜)</p> <p>Java é‡Œç”¨ <strong>DirectByteBuffer</strong> å¯ä»¥åˆ†é…ä¸€å—<strong>ç›´æ¥å†…å­˜(å †å¤–å†…å­˜)</strong> , å®ƒä»¬å¯¹åº”çš„éƒ½æ˜¯æœºå™¨çš„<strong>ç‰©ç†å†…å­˜</strong>. <strong>DirectByteBuffer çš„å¯¹è±¡</strong>æ˜¯åœ¨<strong>å †å†…</strong>çš„, å…¶<strong>å­˜æ”¾æœ‰å †å¤–å†…å­˜çš„åœ°å€å€¼</strong>, æŒ‡å‘çš„<strong>æ˜¯å †å¤–å­˜æ”¾æ•°æ®çš„ç›´æ¥å†…å­˜</strong>.</p> <p><img src="https://nano-note.oss-cn-beijing.aliyuncs.com/images/image-20230205152141674.png" alt="" title="JVMä¸å †å¤–å†…å­˜"></p> <p>ä¸‹é¢æ˜¯ç”³è¯·ä¸åˆ†é…å †å†…å­˜å’Œç›´æ¥å†…å­˜çš„è€—æ—¶æµ‹è¯•:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DirectMemoryTest</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">heapAccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">long</span> startTime <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// åˆ†é…å †å†…å­˜</span>
        <span class="token class-name">ByteBuffer</span> buffer <span class="token operator">=</span> <span class="token class-name">ByteBuffer</span><span class="token punctuation">.</span><span class="token function">allocate</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">100000</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> <span class="token number">200</span><span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                buffer<span class="token punctuation">.</span><span class="token function">putInt</span><span class="token punctuation">(</span>j<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            buffer<span class="token punctuation">.</span><span class="token function">flip</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> <span class="token number">200</span><span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                buffer<span class="token punctuation">.</span><span class="token function">getInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            buffer<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">long</span> endTime <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;å †å†…å­˜è®¿é—®æ—¶é—´:&quot;</span> <span class="token operator">+</span> <span class="token punctuation">(</span>endTime <span class="token operator">-</span> startTime<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;ms&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">directAccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">long</span> startTime <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// åˆ†é…ç›´æ¥å†…å­˜</span>
        <span class="token class-name">ByteBuffer</span> buffer <span class="token operator">=</span> <span class="token class-name">ByteBuffer</span><span class="token punctuation">.</span><span class="token function">allocateDirect</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">100000</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> <span class="token number">200</span><span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                buffer<span class="token punctuation">.</span><span class="token function">putInt</span><span class="token punctuation">(</span>j<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            buffer<span class="token punctuation">.</span><span class="token function">flip</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> <span class="token number">200</span><span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                buffer<span class="token punctuation">.</span><span class="token function">getInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            buffer<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">long</span> endTime <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;ç›´æ¥å†…å­˜è®¿é—®æ—¶é—´:&quot;</span> <span class="token operator">+</span> <span class="token punctuation">(</span>endTime <span class="token operator">-</span> startTime<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;ms&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">heapAllocate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">long</span> startTime <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">100000</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">ByteBuffer</span><span class="token punctuation">.</span><span class="token function">allocate</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">long</span> endTime <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;å †å†…å­˜ç”³è¯·æ—¶é—´:&quot;</span> <span class="token operator">+</span> <span class="token punctuation">(</span>endTime <span class="token operator">-</span> startTime<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;ms&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">directAllocate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">long</span> startTime <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">100000</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">ByteBuffer</span><span class="token punctuation">.</span><span class="token function">allocateDirect</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">long</span> endTime <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;ç›´æ¥å†…å­˜ç”³è¯·æ—¶é—´:&quot;</span> <span class="token operator">+</span> <span class="token punctuation">(</span>endTime <span class="token operator">-</span> startTime<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;ms&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span> args<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">heapAccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">directAccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">heapAllocate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">directAllocate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br></div></div><p>è¿è¡Œç»“æœ:</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>å †å†…å­˜è®¿é—®æ—¶é—´:40ms
ç›´æ¥å†…å­˜è®¿é—®æ—¶é—´:41ms
å †å†…å­˜è®¿é—®æ—¶é—´:29ms
ç›´æ¥å†…å­˜è®¿é—®æ—¶é—´:20ms
å †å†…å­˜è®¿é—®æ—¶é—´:50ms
ç›´æ¥å†…å­˜è®¿é—®æ—¶é—´:39ms
å †å†…å­˜è®¿é—®æ—¶é—´:26ms
ç›´æ¥å†…å­˜è®¿é—®æ—¶é—´:18ms
å †å†…å­˜è®¿é—®æ—¶é—´:33ms
ç›´æ¥å†…å­˜è®¿é—®æ—¶é—´:20ms

å †å†…å­˜ç”³è¯·æ—¶é—´:14ms
ç›´æ¥å†…å­˜ç”³è¯·æ—¶é—´:41ms
å †å†…å­˜ç”³è¯·æ—¶é—´:9ms
ç›´æ¥å†…å­˜ç”³è¯·æ—¶é—´:35ms
å †å†…å­˜ç”³è¯·æ—¶é—´:81ms
ç›´æ¥å†…å­˜ç”³è¯·æ—¶é—´:44ms
å †å†…å­˜ç”³è¯·æ—¶é—´:2ms
ç›´æ¥å†…å­˜ç”³è¯·æ—¶é—´:35ms
å †å†…å­˜ç”³è¯·æ—¶é—´:1ms
ç›´æ¥å†…å­˜ç”³è¯·æ—¶é—´:81ms
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p>ä»ç¨‹åºè¿è¡Œç»“æœçœ‹å‡º<mark><strong>ç›´æ¥å†…å­˜ç”³è¯·è¾ƒæ…¢, ä½†è®¿é—®æ•ˆç‡é«˜</strong></mark>.</p> <p><strong>ç›´æ¥å†…å­˜åˆ†é…æºç åˆ†æ</strong>:</p> <blockquote><p>ByteBuffer#allocateDirect()</p></blockquote> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">ByteBuffer</span> <span class="token function">allocateDirect</span><span class="token punctuation">(</span><span class="token keyword">int</span> capacity<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">DirectByteBuffer</span><span class="token punctuation">(</span>capacity<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><blockquote><p>DirectByteBufferæ„é€ æ–¹æ³•</p></blockquote> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">DirectByteBuffer</span><span class="token punctuation">(</span><span class="token keyword">int</span> cap<span class="token punctuation">)</span> <span class="token punctuation">{</span>   
    <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> cap<span class="token punctuation">,</span> cap<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">boolean</span> pa <span class="token operator">=</span> <span class="token constant">VM</span><span class="token punctuation">.</span><span class="token function">isDirectMemoryPageAligned</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> ps <span class="token operator">=</span> <span class="token class-name">Bits</span><span class="token punctuation">.</span><span class="token function">pageSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">long</span> size <span class="token operator">=</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token number">1L</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span>cap <span class="token operator">+</span> <span class="token punctuation">(</span>pa <span class="token operator">?</span> ps <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// åˆ¤æ–­æ˜¯å¦æœ‰è¶³å¤Ÿçš„ç›´æ¥å†…å­˜ç©ºé—´åˆ†é…, å¯é€šè¿‡-XX:MaxDirectMemorySize=&lt;size&gt;å‚æ•°æŒ‡å®šç›´æ¥å†…å­˜æœ€å¤§å¯åˆ†é…ç©ºé—´, å¦‚æœä¸æŒ‡å®šé»˜è®¤ä¸ºæœ€å¤§å †å†…å­˜å¤§å°, </span>
    <span class="token comment">// åœ¨åˆ†é…ç›´æ¥å†…å­˜æ—¶å¦‚æœå‘ç°ç©ºé—´ä¸å¤Ÿä¼šæ˜¾ç¤ºè°ƒç”¨System.gc()è§¦å‘ä¸€æ¬¡full gcå›æ”¶æ‰ä¸€éƒ¨åˆ†æ— ç”¨çš„ç›´æ¥å†…å­˜çš„å¼•ç”¨å¯¹è±¡, åŒæ—¶ç›´æ¥å†…å­˜ä¹Ÿä¼šè¢«é‡Šæ”¾æ‰</span>
    <span class="token comment">// å¦‚æœé‡Šæ”¾å®Œåˆ†é…ç©ºé—´è¿˜æ˜¯ä¸å¤Ÿä¼šæŠ›å‡ºå¼‚å¸¸java.lang.OutOfMemoryError</span>
    <span class="token class-name">Bits</span><span class="token punctuation">.</span><span class="token function">reserveMemory</span><span class="token punctuation">(</span>size<span class="token punctuation">,</span> cap<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// baseå­˜æ”¾çš„å°±æ˜¯åˆ†é…çš„ç›´æ¥å†…å­˜åœ°å€</span>
    <span class="token keyword">long</span> base <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment">// è°ƒç”¨unsafeæœ¬åœ°æ–¹æ³•åˆ†é…ç›´æ¥å†…å­˜</span>
        base <span class="token operator">=</span> unsafe<span class="token punctuation">.</span><span class="token function">allocateMemory</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">OutOfMemoryError</span> x<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// åˆ†é…å¤±è´¥, é‡Šæ”¾å†…å­˜</span>
        <span class="token class-name">Bits</span><span class="token punctuation">.</span><span class="token function">unreserveMemory</span><span class="token punctuation">(</span>size<span class="token punctuation">,</span> cap<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">throw</span> x<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    unsafe<span class="token punctuation">.</span><span class="token function">setMemory</span><span class="token punctuation">(</span>base<span class="token punctuation">,</span> size<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>pa <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>base <span class="token operator">%</span> ps <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        address <span class="token operator">=</span> base <span class="token operator">+</span> ps <span class="token operator">-</span> <span class="token punctuation">(</span>base <span class="token operator">&amp;</span> <span class="token punctuation">(</span>ps <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        address <span class="token operator">=</span> base<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// ä½¿ç”¨Cleaneræœºåˆ¶æ³¨å†Œå†…å­˜å›æ”¶å¤„ç†å‡½æ•°, å½“ç›´æ¥å†…å­˜å¼•ç”¨å¯¹è±¡è¢«GCæ¸…ç†æ‰æ—¶, </span>
    <span class="token comment">// ä¼šæå‰è°ƒç”¨è¿™é‡Œæ³¨å†Œçš„é‡Šæ”¾ç›´æ¥å†…å­˜çš„Deallocatorçº¿ç¨‹å¯¹è±¡çš„runæ–¹æ³•</span>
    cleaner <span class="token operator">=</span> <span class="token class-name">Cleaner</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Deallocator</span><span class="token punctuation">(</span>base<span class="token punctuation">,</span> size<span class="token punctuation">,</span> cap<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    att <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// ç”³è¯·ä¸€å—æœ¬åœ°å†…å­˜. å†…å­˜ç©ºé—´æ˜¯æœªåˆå§‹åŒ–çš„, å…¶å†…å®¹æ˜¯æ— æ³•é¢„æœŸçš„. </span>
<span class="token comment">// ä½¿ç”¨freeMemoryé‡Šæ”¾å†…å­˜, ä½¿ç”¨reallocateMemoryä¿®æ”¹å†…å­˜å¤§å°</span>
<span class="token keyword">public</span> <span class="token keyword">native</span> <span class="token keyword">long</span> <span class="token function">allocateMemory</span><span class="token punctuation">(</span><span class="token keyword">long</span> bytes<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// openjdk8/hotspot/src/share/vm/prims/unsafe.cpp</span>
<span class="token function">UNSAFE_ENTRY</span><span class="token punctuation">(</span>jlong<span class="token punctuation">,</span> <span class="token class-name">Unsafe_AllocateMemory</span><span class="token punctuation">(</span><span class="token class-name">JNIEnv</span> <span class="token operator">*</span>env<span class="token punctuation">,</span> jobject unsafe<span class="token punctuation">,</span> jlong size<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token class-name">UnsafeWrapper</span><span class="token punctuation">(</span><span class="token string">&quot;Unsafe_AllocateMemory&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
size_t sz <span class="token operator">=</span> <span class="token punctuation">(</span>size_t<span class="token punctuation">)</span>size<span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>sz <span class="token operator">!=</span> <span class="token punctuation">(</span>julong<span class="token punctuation">)</span>size <span class="token operator">||</span> size <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">THROW_0</span><span class="token punctuation">(</span>vmSymbols<span class="token operator">::</span><span class="token function">java_lang_IllegalArgumentException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>sz <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
sz <span class="token operator">=</span> <span class="token function">round_to</span><span class="token punctuation">(</span>sz<span class="token punctuation">,</span> <span class="token class-name">HeapWordSize</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// è°ƒç”¨os::mallocç”³è¯·å†…å­˜, å†…éƒ¨ä½¿ç”¨mallocè¿™ä¸ªCæ ‡å‡†åº“çš„å‡½æ•°ç”³è¯·å†…å­˜</span>
<span class="token keyword">void</span><span class="token operator">*</span> x <span class="token operator">=</span> os<span class="token operator">::</span><span class="token function">malloc</span><span class="token punctuation">(</span>sz<span class="token punctuation">,</span> mtInternal<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>x <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">THROW_0</span><span class="token punctuation">(</span>vmSymbols<span class="token operator">::</span><span class="token function">java_lang_OutOfMemoryError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// Copy::fill_to_words((HeapWord*)x, sz / HeapWordSize);</span>
<span class="token keyword">return</span> <span class="token function">addr_to_java</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token constant">UNSAFE_END</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br></div></div><p><strong>ä½¿ç”¨ç›´æ¥å†…å­˜çš„ä¼˜ç¼ºç‚¹:</strong></p> <p><strong>ä¼˜ç‚¹</strong>: ä¸å ç”¨å †å†…å­˜ç©ºé—´, å‡å°‘äº† GC å‘ç”Ÿ; è™šæ‹Ÿæœºå®ç°ä¸Š, æœ¬åœ° IO ä¼šç›´æ¥æ“ä½œç›´æ¥å†…å­˜(ç›´æ¥å†…å­˜ -&gt; ç³»ç»Ÿè°ƒç”¨ -&gt; ç¡¬ç›˜/ç½‘å¡), è€Œéç›´æ¥å†…å­˜åˆ™éœ€è¦<strong>äºŒæ¬¡æ‹·è´</strong>(å †å†…å­˜ -&gt; ç›´æ¥å†…å­˜ -&gt; ç³»ç»Ÿè°ƒç”¨ -&gt; ç¡¬ç›˜/ç½‘å¡).</p> <p><strong>ç¼ºç‚¹</strong>: ç›´æ¥å†…å­˜çš„åˆå§‹åˆ†é…è¾ƒæ…¢; æ²¡æœ‰ JVM ç›´æ¥å¸®åŠ©ç®¡ç†å†…å­˜, å®¹æ˜“å‘ç”Ÿå†…å­˜æº¢å‡º, ç”šè‡³å¯¼è‡´ç›´æ¥å†…å­˜æŠŠç‰©ç†å†…å­˜è¢«è€—å®Œ. å¯ä»¥é€šè¿‡ -XX: MaxDirectMemorySize å‚æ•°æŒ‡å®š<strong>ç›´æ¥å†…å­˜çš„æœ€å¤§å€¼</strong>, å½“è¾¾åˆ°é˜ˆå€¼çš„æ—¶å€™, è°ƒç”¨ System.gc() æ¥è¿›è¡Œä¸€æ¬¡ FULL GC, é—´æ¥æŠŠé‚£äº›æ²¡æœ‰è¢«ä½¿ç”¨çš„ç›´æ¥å†…å­˜å›æ”¶æ‰.</p> <h5 id="_2-nettyé›¶æ‹·è´å®ç°"><a href="#_2-nettyé›¶æ‹·è´å®ç°" class="header-anchor">#</a> 2.Nettyé›¶æ‹·è´å®ç°</h5> <p>Netty çš„æ¥æ”¶å’Œå‘é€ä½¿ç”¨çš„ <strong>ByteBuffer</strong> é‡‡ç”¨ <strong>DIRECT BUFFERS</strong>, ä½¿ç”¨å †å¤–<mark><strong>ç›´æ¥å†…å­˜</strong></mark>è¿›è¡Œ <strong>Socket è¯»å†™</strong>, <strong>ä¸éœ€è¦è¿›è¡Œå­—èŠ‚ç¼“å†²åŒºçš„äºŒæ¬¡æ‹·è´</strong>. ä½¿ç”¨ç›´æ¥å†…å­˜ä½¿å¾—<strong>æ•°æ®å¯ä»¥ä¸ç”¨æ‹·è´åˆ° JVM å†…å­˜</strong>ä¸­, ä¾¿å¯ä»¥<strong>ç›´æ¥å†™å…¥ Socket ä¸­, è¿™æ ·å°±å‡å°‘äº†æ‹·è´çš„æ¬¡æ•°, è¿™å°±æ˜¯é›¶æ‹·è´</strong>.</p> <p>å¦‚æœä½¿ç”¨ä¼ ç»Ÿçš„ JVM å †å†…å­˜(HEAP BUFFERS)è¿›è¡Œ Socket è¯»å†™, ç”±äº JVM å †å†…å­˜çš„æ•°æ®<strong>ä¸èƒ½ç›´æ¥å†™å…¥</strong> Socket ä¸­, å› æ­¤ <strong>JVM ä¼šå°†å †å†…å­˜ä¸­çš„æ•°æ®æ‹·è´ä¸€ä»½åˆ°ç›´æ¥å†…å­˜ä¸­</strong>, ç„¶åæ‰èƒ½å†™å…¥ Socket. <strong>ç›¸æ¯”äºå †å¤–ç›´æ¥å†…å­˜, æ¶ˆæ¯åœ¨å‘é€è¿‡ç¨‹ä¸­å¤šäº†ä¸€æ¬¡ç¼“å†²åŒºçš„å†…å­˜æ‹·è´.</strong>  JVM å¯¹æ“ä½œç³»ç»Ÿæ¥è¯´å°±æ˜¯<strong>ç”¨æˆ·æ€çš„è¿›ç¨‹</strong>, æ‰€ä»¥é›¶æ‹·è´åªæ˜¯ä¸ç”¨æŠŠ IO æ”¾åœ¨<strong>å†…æ ¸æ€</strong>çš„æ•°æ®å†æ‹·è´åˆ°å¼•ç”¨è¿›ç¨‹ JVM çš„å†…å­˜ä¸­.</p> <p>Netty çš„<strong>è¯»å†™æºç </strong>ä¸­æœ‰ä¸å°‘åœ°æ–¹èƒ½çœ‹å‡ºæ˜¯åœ¨<strong>æ“ä½œç›´æ¥å†…å­˜</strong>å®ç°è¯»å†™. æ¯”å¦‚ AbstractNioByteChannel ç±»ä¸­çš„å†…éƒ¨ç±» NioByteUnsafe çš„ read() æºç å³ <strong>NioByteUnsafe</strong>.read():</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">final</span> <span class="token class-name">ChannelConfig</span> config <span class="token operator">=</span> <span class="token function">config</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">shouldBreakReadReady</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">clearReadPending</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">final</span> <span class="token class-name">ChannelPipeline</span> pipeline <span class="token operator">=</span> <span class="token function">pipeline</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">final</span> <span class="token class-name">ByteBufAllocator</span> allocator <span class="token operator">=</span> config<span class="token punctuation">.</span><span class="token function">getAllocator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">final</span> <span class="token class-name">RecvByteBufAllocator<span class="token punctuation">.</span>Handle</span> allocHandle <span class="token operator">=</span> <span class="token function">recvBufAllocHandle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    allocHandle<span class="token punctuation">.</span><span class="token function">reset</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">ByteBuf</span> byteBuf <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">boolean</span> close <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token keyword">do</span> <span class="token punctuation">{</span>
            <span class="token comment">// åˆ†é…ç›´æ¥å†…å­˜</span>
            byteBuf <span class="token operator">=</span> allocHandle<span class="token punctuation">.</span><span class="token function">allocate</span><span class="token punctuation">(</span>allocator<span class="token punctuation">)</span><span class="token punctuation">;</span>
            allocHandle<span class="token punctuation">.</span><span class="token function">lastBytesRead</span><span class="token punctuation">(</span><span class="token function">doReadBytes</span><span class="token punctuation">(</span>byteBuf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//...</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><p>åˆå¦‚ PooledUnsafeDirectByteBuf ç±»çš„ <strong>initMemoryAddress()</strong>  æ–¹æ³•:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">initMemoryAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    memoryAddress <span class="token operator">=</span> <span class="token class-name">PlatformDependent</span><span class="token punctuation">.</span><span class="token function">directBufferAddress</span><span class="token punctuation">(</span>memory<span class="token punctuation">)</span> <span class="token operator">+</span> offset<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h4 id="nettyå¿ƒè·³æ£€æµ‹æœºåˆ¶"><a href="#nettyå¿ƒè·³æ£€æµ‹æœºåˆ¶" class="header-anchor">#</a> Nettyå¿ƒè·³æ£€æµ‹æœºåˆ¶</h4> <h5 id="_1-æ¦‚è¿°-4"><a href="#_1-æ¦‚è¿°-4" class="header-anchor">#</a> 1.æ¦‚è¿°</h5> <p>å¿ƒè·³æ˜¯åœ¨ TCP é•¿è¿æ¥ä¸­, å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ä¹‹é—´å®šæœŸå‘é€çš„ä¸€ç§ç‰¹æ®Šçš„æ•°æ®åŒ…, é€šçŸ¥å¯¹æ–¹<strong>è‡ªå·±è¿˜åœ¨çº¿</strong>, ä»¥ç¡®ä¿ TCP è¿æ¥çš„æœ‰æ•ˆæ€§. è¿™å¯ä»¥ç”¨äº<strong>æ£€æµ‹è¿æ¥æ–­å¼€</strong>çš„æƒ…å†µ, æ¯”å¦‚å®¢æˆ·ç«¯<strong>ç›´æ¥æ–­ç”µ</strong>, å¯¼è‡´æœåŠ¡ç«¯å¹¶ä¸çŸ¥é“å®¢æˆ·ç«¯å·²ç»æ–­çº¿çš„æƒ…å†µ.</p> <p>Netty å®ç°å¿ƒè·³æœºåˆ¶çš„å…³é”®æ˜¯ <strong>IdleStateHandler</strong>, å…¶æ„é€ å™¨å¦‚ä¸‹:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">IdleStateHandler</span><span class="token punctuation">(</span><span class="token keyword">int</span> readerIdleTimeSeconds<span class="token punctuation">,</span> <span class="token keyword">int</span> writerIdleTimeSeconds<span class="token punctuation">,</span> <span class="token keyword">int</span> allIdleTimeSeconds<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span>readerIdleTimeSeconds<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span>writerIdleTimeSeconds<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span>allIdleTimeSeconds<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>è§£é‡Šä¸‹<strong>ä¸‰ä¸ªå‚æ•°</strong>çš„å«ä¹‰:</p> <ul><li><strong>readerIdleTimeSeconds</strong>: è¯»è¶…æ—¶. å³åœ¨æŒ‡å®šçš„æ—¶é—´é—´éš”å†…æ²¡æœ‰ä» Channel è¯»å–åˆ°æ•°æ®æ—¶, ä¼š<strong>è§¦å‘ä¸€ä¸ª READER_IDLE çš„ IdleStateEvent äº‹ä»¶</strong>.</li> <li><strong>writerIdleTimeSeconds</strong>: å†™è¶…æ—¶. å³åœ¨æŒ‡å®šçš„æ—¶é—´é—´éš”å†…æ²¡æœ‰æ•°æ®å†™å…¥åˆ° Channel æ—¶, ä¼š<strong>è§¦å‘ä¸€ä¸ª WRITER_IDLE çš„ IdleStateEvent äº‹ä»¶</strong>.</li> <li><strong>allIdleTimeSeconds</strong>: è¯»/å†™è¶…æ—¶. å³å½“åœ¨æŒ‡å®šçš„æ—¶é—´é—´éš”å†…<strong>æ²¡æœ‰è¯»æˆ–å†™æ“ä½œæ—¶</strong>, ä¼šè§¦å‘ä¸€ä¸ª ALL_IDLE çš„ IdleStateEvent äº‹ä»¶.</li></ul> <p>è¿™ä¸‰ä¸ªå‚æ•°é»˜è®¤çš„æ—¶é—´å•ä½æ˜¯<strong>ç§’</strong>. è‹¥éœ€è¦æŒ‡å®šå…¶ä»–æ—¶é—´å•ä½, å¯ä»¥ä½¿ç”¨å¦ä¸€ä¸ªæ„é€ æ–¹æ³•:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">IdleStateHandler</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> observeOutput<span class="token punctuation">,</span> <span class="token keyword">long</span> readerIdleTime<span class="token punctuation">,</span> <span class="token keyword">long</span> writerIdleTime<span class="token punctuation">,</span> <span class="token keyword">long</span> allIdleTime<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span> unit<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>è¦å®ç° Netty <strong>æœåŠ¡ç«¯å¿ƒè·³æ£€æµ‹æœºåˆ¶</strong>éœ€è¦åœ¨æœåŠ¡å™¨ç«¯çš„ <strong>ChannelInitializer</strong> ä¸­åŠ å…¥å¦‚ä¸‹ä»£ç , IdleStateHandler ä¹Ÿå®ç°äº† ChannelHandler æ¥å£, ä¹Ÿæ˜¯<strong>æ³¨å†Œåˆ° ChannelPipeline ä¸­</strong>.</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// æ³¨å†ŒIdleStateHandlerå®ç°å¿ƒè·³æ£€æµ‹</span>
pipeline<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">IdleStateHandler</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h5 id="_2-å¿ƒè·³æœºåˆ¶æºç åˆ†æ"><a href="#_2-å¿ƒè·³æœºåˆ¶æºç åˆ†æ" class="header-anchor">#</a> 2.å¿ƒè·³æœºåˆ¶æºç åˆ†æ</h5> <p>å…ˆçœ‹ä¸‹ IdleStateHandler ä¸­çš„ <strong>channelRead() æ–¹æ³•</strong>:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">channelRead</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">,</span> <span class="token class-name">Object</span> msg<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>readerIdleTimeNanos <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">||</span> allIdleTimeNanos <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        reading <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        firstReaderIdleEvent <span class="token operator">=</span> firstAllIdleEvent <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// è¿™é‡Œå¯¹æ¶ˆæ¯è¿›è¡Œé€ä¼ </span>
    ctx<span class="token punctuation">.</span><span class="token function">fireChannelRead</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>æœ€åä¸€å¥ä»£ç å…¶å®è¡¨ç¤ºè¯¥æ–¹æ³•<strong>åªæ˜¯è¿›è¡Œäº†é€ä¼ </strong>, ä¸åšä»»ä½•ä¸šåŠ¡é€»è¾‘å¤„ç†, è®© channelPipe ä¸­çš„<strong>ä¸‹ä¸€ä¸ª</strong> handler å¤„ç† channelRead() æ–¹æ³•.</p> <p>å†çœ‹ <strong>channelActive()</strong>  æ–¹æ³•:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">channelActive</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token comment">// This method will be invoked only if this handler was added</span>
    <span class="token comment">// before channelActive() event is fired.  If a user adds this handler</span>
    <span class="token comment">// after the channelActive() event, initialize() will be called by beforeAdd().</span>
    <span class="token comment">// é‡è¦</span>
    <span class="token function">initialize</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">channelActive</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>è¿™é‡Œ <strong>initialize()</strong>  æ–¹æ³•æ˜¯ IdleStateHandler çš„<strong>ç²¾é«“</strong>, æ¥ç€çœ‹çœ‹:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">initialize</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Avoid the case where destroy() is called before scheduling timeouts.</span>
    <span class="token comment">// See: https://github.com/netty/netty/issues/143</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>state<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">case</span> <span class="token number">1</span><span class="token operator">:</span>
        <span class="token keyword">case</span> <span class="token number">2</span><span class="token operator">:</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    state <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token function">initOutputChanged</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">;</span>

    lastReadTime <span class="token operator">=</span> lastWriteTime <span class="token operator">=</span> <span class="token function">ticksInNanos</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>readerIdleTimeNanos <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        readerIdleTimeout <span class="token operator">=</span> <span class="token function">schedule</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">ReaderIdleTimeoutTask</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">,</span>
                                     readerIdleTimeNanos<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">NANOSECONDS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>writerIdleTimeNanos <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        writerIdleTimeout <span class="token operator">=</span> <span class="token function">schedule</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">WriterIdleTimeoutTask</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">,</span>
                                     writerIdleTimeNanos<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">NANOSECONDS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>allIdleTimeNanos <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        allIdleTimeout <span class="token operator">=</span> <span class="token function">schedule</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">AllIdleTimeoutTask</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">,</span>
                                  allIdleTimeNanos<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">NANOSECONDS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><p>è¿™é‡Œä¼šè§¦å‘ä¸€ä¸ª <strong>Task å³ ReaderIdleTimeoutTask</strong>, å…¶ <strong>run() æ–¹æ³•</strong>å¦‚ä¸‹:</p> <blockquote><p>ReaderIdleTimeoutTask#run()</p></blockquote> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">long</span> nextDelay <span class="token operator">=</span> readerIdleTimeNanos<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>reading<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// (1)å½“å‰æ—¶é—´å‡å»æœ€åä¸€æ¬¡channelReadæ–¹æ³•è°ƒç”¨çš„æ—¶é—´</span>
        nextDelay <span class="token operator">-=</span> <span class="token function">ticksInNanos</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> lastReadTime<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
	<span class="token comment">// (2)è¯´æ˜è¶…æ—¶äº†</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>nextDelay <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// Reader is idle - set a new timeout and notify the callback.</span>
        readerIdleTimeout <span class="token operator">=</span> <span class="token function">schedule</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">,</span> readerIdleTimeNanos<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">NANOSECONDS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">boolean</span> first <span class="token operator">=</span> firstReaderIdleEvent<span class="token punctuation">;</span>
        firstReaderIdleEvent <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">IdleStateEvent</span> event <span class="token operator">=</span> <span class="token function">newIdleStateEvent</span><span class="token punctuation">(</span><span class="token class-name">IdleState</span><span class="token punctuation">.</span><span class="token constant">READER_IDLE</span><span class="token punctuation">,</span> first<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// (3)è§¦å‘ä¸‹ä¸€ä¸ªhandlerçš„userEventTriggeredæ–¹æ³•</span>
            <span class="token function">channelIdle</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> event<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            ctx<span class="token punctuation">.</span><span class="token function">fireExceptionCaught</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// Read occurred before the timeout - set a new timeout with shorter delay.</span>
        readerIdleTimeout <span class="token operator">=</span> <span class="token function">schedule</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">,</span> nextDelay<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">NANOSECONDS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><p>(1) å¤„ä»£ç æ˜¯ç”¨å½“å‰æ—¶é—´<strong>å‡å»æœ€åä¸€æ¬¡ channelRead() æ–¹æ³•è°ƒç”¨çš„æ—¶é—´</strong>, å‡å¦‚è¿™ä¸ªç»“æœæ˜¯ 6s, è¯´æ˜æœ€åä¸€æ¬¡è°ƒç”¨ channelRead() å·²ç»æ˜¯ 6s ä¹‹å‰çš„äº‹æƒ…äº†, å¦‚æœè®¾ç½®çš„æ˜¯ 5s, é‚£ä¹ˆ nextDelay åˆ™ä¸º -1, è¯´æ˜<strong>è¶…æ—¶äº†</strong>, é‚£ä¹ˆ (3) å¤„ä»£ç åˆ™ä¼šè§¦å‘ä¸‹ä¸€ä¸ª handler çš„ <strong>userEventTriggered()</strong>  æ–¹æ³•:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">channelIdle</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">,</span> <span class="token class-name">IdleStateEvent</span> evt<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    ctx<span class="token punctuation">.</span><span class="token function">fireUserEventTriggered</span><span class="token punctuation">(</span>evt<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>å¦‚æœ<strong>æ²¡æœ‰è¶…æ—¶åˆ™ä¸è§¦å‘</strong> userEventTriggered() æ–¹æ³•.</p> <h5 id="_3-ç¤ºä¾‹å®ç°"><a href="#_3-ç¤ºä¾‹å®ç°" class="header-anchor">#</a> 3.ç¤ºä¾‹å®ç°</h5> <p>Netty å¿ƒè·³æ£€æµ‹ä»£ç å¦‚ä¸‹.</p> <p>æœåŠ¡ç«¯å®ç°:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HeartBeatServer</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">EventLoopGroup</span> boss <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NioEventLoopGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">EventLoopGroup</span> worker <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NioEventLoopGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">ServerBootstrap</span> bootstrap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ServerBootstrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            bootstrap<span class="token punctuation">.</span><span class="token function">group</span><span class="token punctuation">(</span>boss<span class="token punctuation">,</span> worker<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token class-name">NioServerSocketChannel</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">childHandler</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ChannelInitializer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SocketChannel</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token annotation punctuation">@Override</span>
                    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">initChannel</span><span class="token punctuation">(</span><span class="token class-name">SocketChannel</span> ch<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
                        <span class="token comment">// å¾—åˆ°Pipeline</span>
                        <span class="token class-name">ChannelPipeline</span> pipeline <span class="token operator">=</span> ch<span class="token punctuation">.</span><span class="token function">pipeline</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token comment">// æ·»åŠ ç¼–è§£ç å™¨</span>
                        pipeline<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token string">&quot;decoder&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">StringDecoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        pipeline<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token string">&quot;encoder&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">StringEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token comment">// æ³¨å†ŒIdleStateHandler, å¹¶è®¾ç½®readerIdleTimeå‚æ•°, æŒ‡å®šè¶…è¿‡3ç§’</span>
                        <span class="token comment">// è¿˜æ²¡æ”¶åˆ°å®¢æˆ·ç«¯çš„è¿æ¥, ä¼šè§¦å‘IdleStateEventäº‹ä»¶å¹¶ä¸”</span>
                        <span class="token comment">// äº¤ç»™ä¸‹ä¸€ä¸ªhandlerå¤„ç†, ä¸‹ä¸€ä¸ªhandlerå¿…é¡»</span>
                        <span class="token comment">// å®ç°userEventTriggered()æ–¹æ³•å¤„ç†å¯¹åº”äº‹ä»¶</span>
                        pipeline<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">IdleStateHandler</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token comment">// æ³¨å†Œå¿ƒè·³å¤„ç†å™¨</span>
                        pipeline<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">HeartBeatServerHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Netty server start..&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">ChannelFuture</span> future <span class="token operator">=</span> bootstrap<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token number">9000</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            future<span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">closeFuture</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            worker<span class="token punctuation">.</span><span class="token function">shutdownGracefully</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            boss<span class="token punctuation">.</span><span class="token function">shutdownGracefully</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br></div></div><p>å®ç°æœåŠ¡ç«¯<strong>å¿ƒè·³å¤„ç†å™¨</strong> HeartBeatServerHandler. è¿™é‡Œä¸»è¦å¯¹<strong>è¶…æ—¶äº‹ä»¶è¿›è¡Œå¤„ç†</strong>, å¦‚æœè¶…è¿‡ä¸‰æ¬¡è¶…æ—¶, åˆ™ä¼šå…³é—­é€šé“.</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HeartBeatServerHandler</span> <span class="token keyword">extends</span> <span class="token class-name">SimpleChannelInboundHandler</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>

    <span class="token keyword">int</span> readIdleTimes <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">channelRead0</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">,</span> <span class="token class-name">String</span> s<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;æœåŠ¡ç«¯æ”¶åˆ°æ¶ˆæ¯: &quot;</span> <span class="token operator">+</span> s<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">&quot;Heartbeat Packet&quot;</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            ctx<span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">writeAndFlush</span><span class="token punctuation">(</span><span class="token string">&quot;ok&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;å…¶ä»–ä¿¡æ¯å¤„ç†... &quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// è¦†å†™å¿ƒè·³å¤„ç†çš„æ–¹æ³•</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">userEventTriggered</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">,</span> <span class="token class-name">Object</span> evt<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">IdleStateEvent</span> event <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">IdleStateEvent</span><span class="token punctuation">)</span> evt<span class="token punctuation">;</span>

        <span class="token class-name">String</span> eventType <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">switch</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span><span class="token function">state</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">case</span> <span class="token constant">READER_IDLE</span><span class="token operator">:</span>
                eventType <span class="token operator">=</span> <span class="token string">&quot;è¯»ç©ºé—²&quot;</span><span class="token punctuation">;</span>
                <span class="token comment">// è¯»ç©ºé—²çš„è®¡æ•°åŠ 1</span>
                readIdleTimes<span class="token operator">++</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token constant">WRITER_IDLE</span><span class="token operator">:</span>
                eventType <span class="token operator">=</span> <span class="token string">&quot;å†™ç©ºé—²&quot;</span><span class="token punctuation">;</span>
                <span class="token comment">// ä¸å¤„ç†</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token constant">ALL_IDLE</span><span class="token operator">:</span>
                eventType <span class="token operator">=</span> <span class="token string">&quot;è¯»å†™ç©ºé—²&quot;</span><span class="token punctuation">;</span>
                <span class="token comment">// ä¸å¤„ç†</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>

            <span class="token keyword">default</span><span class="token operator">:</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">remoteAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;è¶…æ—¶äº‹ä»¶: &quot;</span> <span class="token operator">+</span> eventType<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>readIdleTimes <span class="token operator">&gt;</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;[æœåŠ¡ç«¯]è¯»ç©ºé—²è¶…è¿‡3æ¬¡, å…³é—­è¿æ¥, é‡Šæ”¾æ›´å¤šèµ„æº.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            ctx<span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">writeAndFlush</span><span class="token punctuation">(</span><span class="token string">&quot;IDLE close&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            ctx<span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">channelActive</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>err<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">remoteAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; is active.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br></div></div><p><strong>å®¢æˆ·ç«¯åŠå…¶ Handler å¦‚ä¸‹</strong>. è¿™é‡Œä¸€ç›´å‘é€æ¶ˆæ¯åˆ°æœåŠ¡ç«¯æ¨¡æ‹Ÿå¿ƒè·³æœºåˆ¶, åŒæ—¶ä¼š<strong>éšæœºä¼‘çœ </strong>, è¿™ä¸ªä¼‘çœ æ—¶é—´å¯èƒ½è¶…è¿‡æœåŠ¡ç«¯è®¾ç½®çš„è¶…æ—¶æ—¶é—´, ä»è€Œæ¨¡æ‹Ÿå®¢æˆ·ç«¯æ–­çº¿.</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HeartBeatClient</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>

        <span class="token class-name">EventLoopGroup</span> eventLoopGroup <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NioEventLoopGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">Bootstrap</span> bootstrap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Bootstrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            bootstrap<span class="token punctuation">.</span><span class="token function">group</span><span class="token punctuation">(</span>eventLoopGroup<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token class-name">NioSocketChannel</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">handler</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ChannelInitializer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SocketChannel</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token annotation punctuation">@Override</span>
                        <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">initChannel</span><span class="token punctuation">(</span><span class="token class-name">SocketChannel</span> ch<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
                            <span class="token class-name">ChannelPipeline</span> pipeline <span class="token operator">=</span> ch<span class="token punctuation">.</span><span class="token function">pipeline</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            pipeline<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token string">&quot;decoder&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">StringDecoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            pipeline<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token string">&quot;encoder&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">StringEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token comment">// åªæ·»åŠ å¿ƒè·³å¤„ç†å™¨</span>
                            pipeline<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">HeartBeatClientHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;netty client start. . &quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Channel</span> channel <span class="token operator">=</span> bootstrap<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token string">&quot;127.0.0.1&quot;</span><span class="token punctuation">,</span> <span class="token number">9000</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">String</span> text <span class="token operator">=</span> <span class="token string">&quot;Heartbeat Packet&quot;</span><span class="token punctuation">;</span>
            <span class="token class-name">Random</span> random <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// ä¸€ç›´å‘é€å¿ƒè·³æ¶ˆæ¯</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span>channel<span class="token punctuation">.</span><span class="token function">isActive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// è¿™é‡Œéšæœºä¼‘çœ å‡ ç§’å‘é€ä¸€æ¬¡æ•°æ®</span>
                <span class="token keyword">int</span> num <span class="token operator">=</span> random<span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span>num <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                channel<span class="token punctuation">.</span><span class="token function">writeAndFlush</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            eventLoopGroup<span class="token punctuation">.</span><span class="token function">shutdownGracefully</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  
    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">HeartBeatClientHandler</span> <span class="token keyword">extends</span> <span class="token class-name">SimpleChannelInboundHandler</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">channelRead0</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">,</span> <span class="token class-name">String</span> msg<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Client received :&quot;</span> <span class="token operator">+</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">&quot;IDLE Close&quot;</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot; æœåŠ¡ç«¯å…³é—­è¿æ¥, å®¢æˆ·ç«¯ä¹Ÿå…³é—­&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                ctx<span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">closeFuture</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br></div></div><p>æ‰§è¡Œæ—¥å¿—å¦‚ä¸‹:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">Netty</span> server start<span class="token punctuation">.</span> <span class="token punctuation">.</span> 
<span class="token operator">/</span><span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span><span class="token operator">:</span><span class="token number">55846</span> is active<span class="token punctuation">.</span>
æœåŠ¡ç«¯æ”¶åˆ°æ¶ˆæ¯<span class="token operator">:</span> <span class="token class-name">Heartbeat</span> <span class="token class-name">Packet</span>
<span class="token operator">/</span><span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span><span class="token operator">:</span><span class="token number">55846</span>è¶…æ—¶äº‹ä»¶<span class="token operator">:</span> è¯»ç©ºé—²
æœåŠ¡ç«¯æ”¶åˆ°æ¶ˆæ¯<span class="token operator">:</span> <span class="token class-name">Heartbeat</span> <span class="token class-name">Packet</span>
<span class="token operator">/</span><span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span><span class="token operator">:</span><span class="token number">55846</span>è¶…æ—¶äº‹ä»¶<span class="token operator">:</span> è¯»ç©ºé—²
æœåŠ¡ç«¯æ”¶åˆ°æ¶ˆæ¯<span class="token operator">:</span> <span class="token class-name">Heartbeat</span> <span class="token class-name">Packet</span>
æœåŠ¡ç«¯æ”¶åˆ°æ¶ˆæ¯<span class="token operator">:</span> <span class="token class-name">Heartbeat</span> <span class="token class-name">Packet</span>
<span class="token operator">/</span><span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span><span class="token operator">:</span><span class="token number">55846</span>è¶…æ—¶äº‹ä»¶<span class="token operator">:</span> è¯»ç©ºé—²
æœåŠ¡ç«¯æ”¶åˆ°æ¶ˆæ¯<span class="token operator">:</span> <span class="token class-name">Heartbeat</span> <span class="token class-name">Packet</span>
<span class="token operator">/</span><span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span><span class="token operator">:</span><span class="token number">55846</span>è¶…æ—¶äº‹ä»¶<span class="token operator">:</span> è¯»ç©ºé—²
<span class="token punctuation">[</span>æœåŠ¡ç«¯<span class="token punctuation">]</span>è¯»ç©ºé—²è¶…è¿‡<span class="token number">3</span>æ¬¡<span class="token punctuation">,</span> å…³é—­è¿æ¥<span class="token punctuation">,</span> é‡Šæ”¾æ›´å¤šèµ„æº<span class="token punctuation">.</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><div class="language-java line-numbers-mode"><pre class="language-java"><code>netty client start<span class="token punctuation">.</span> <span class="token punctuation">.</span> 
<span class="token class-name">Client</span> received <span class="token operator">:</span>ok
<span class="token class-name">Client</span> received <span class="token operator">:</span>ok
<span class="token class-name">Client</span> received <span class="token operator">:</span>ok
<span class="token class-name">Client</span> received <span class="token operator">:</span><span class="token constant">IDLE</span> close
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h4 id="nettyé«˜å¹¶å‘é«˜æ€§èƒ½æ¶æ„è®¾è®¡æ€»ç»“ğŸŒŸ"><a href="#nettyé«˜å¹¶å‘é«˜æ€§èƒ½æ¶æ„è®¾è®¡æ€»ç»“ğŸŒŸ" class="header-anchor">#</a> Nettyé«˜å¹¶å‘é«˜æ€§èƒ½æ¶æ„è®¾è®¡æ€»ç»“ğŸŒŸ</h4> <p>æ€»ç»“ä¸€ä¸‹ Netty æ€§èƒ½å¥½çš„åŸå› :</p> <ul><li><strong>ä¸»ä» Reactor çº¿ç¨‹æ¨¡å‹</strong>.</li> <li>NIO <strong>å¤šè·¯å¤ç”¨</strong>éé˜»å¡.</li> <li><strong>æ— é”ä¸²è¡ŒåŒ–</strong>è®¾è®¡æ€æƒ³.</li> <li>æ”¯æŒ<strong>é«˜æ€§èƒ½åºåˆ—åŒ–</strong>åè®®.</li> <li><strong>é›¶æ‹·è´</strong>(ä½¿ç”¨ç›´æ¥å†…å­˜). å‚è€ƒ: Nettyé›¶æ‹·è´ğŸŒŸ.</li> <li>ByteBuf <strong>å†…å­˜æ± </strong>è®¾è®¡. å‚è€ƒ: ByteBufå†…å­˜æ± è®¾è®¡.</li> <li>çµæ´»çš„ TCP <strong>å‚æ•°é…ç½®</strong>èƒ½åŠ›.</li> <li>å¹¶å‘ä¼˜åŒ–.</li></ul> <h5 id="_1-æ— é”ä¸²è¡ŒåŒ–è®¾è®¡"><a href="#_1-æ— é”ä¸²è¡ŒåŒ–è®¾è®¡" class="header-anchor">#</a> 1.æ— é”ä¸²è¡ŒåŒ–è®¾è®¡</h5> <p>åœ¨å¤§å¤šæ•°åœºæ™¯ä¸‹, å¹¶è¡Œå¤šçº¿ç¨‹å¤„ç†å¯ä»¥æå‡ç³»ç»Ÿçš„å¹¶å‘æ€§èƒ½. ä½†å¦‚æœå¯¹å¹¶å‘è®¿é—®å¤„ç†ä¸å½“, ä¼šå¸¦æ¥ä¸¥é‡çš„<strong>é”ç«äº‰</strong>, åè€Œä¼šå¯¼è‡´æ€§èƒ½çš„ä¸‹é™. ä¸ºäº†å°½å¯èƒ½çš„é¿å…é”ç«äº‰å¸¦æ¥çš„æ€§èƒ½æŸè€—, å¯ä»¥é€šè¿‡<strong>ä¸²è¡ŒåŒ–è®¾è®¡</strong>, å³<strong>æ¶ˆæ¯çš„å¤„ç†å°½å¯èƒ½åœ¨åŒä¸€ä¸ªçº¿ç¨‹å†…å®Œæˆ, æœŸé—´ä¸è¿›è¡Œçº¿ç¨‹åˆ‡æ¢, è¿™æ ·å°±é¿å…äº†å¤šçº¿ç¨‹ç«äº‰å’ŒåŒæ­¥é”</strong>.</p> <p>ä¸ºæå‡æ€§èƒ½, Netty é‡‡ç”¨äº†<strong>ä¸²è¡Œæ— é”åŒ–è®¾è®¡</strong>, åœ¨ IO çº¿ç¨‹å†…éƒ¨è¿›è¡Œä¸²è¡Œæ“ä½œ, é¿å…å¤šçº¿ç¨‹ç«äº‰å¯¼è‡´çš„æ€§èƒ½ä¸‹é™. è¡¨é¢ä¸Šçœ‹, ä¸²è¡ŒåŒ–è®¾è®¡ä¼¼ä¹ CPU åˆ©ç”¨ç‡ä¸é«˜, å¹¶å‘ç¨‹åº¦ä¸å¤Ÿ. ä½†æ˜¯é€šè¿‡è°ƒæ•´ NIO çº¿ç¨‹æ± çš„çº¿ç¨‹å‚æ•°, å¯ä»¥<strong>åŒæ—¶å¯åŠ¨å¤šä¸ªä¸²è¡ŒåŒ–çš„çº¿ç¨‹</strong>å¹¶è¡Œè¿è¡Œ.</p> <p>Netty çš„ <strong>NioEventLoop</strong> è¯»å–åˆ°æ¶ˆæ¯ä¹‹å, <strong>ç›´æ¥è°ƒç”¨ ChannelPipeline çš„ fireChannelRead(Object msg)</strong> , åªè¦ç”¨æˆ·ä¸ä¸»åŠ¨åˆ‡æ¢çº¿ç¨‹, ä¸€ç›´ä¼šç”± <strong>NioEventLoop è°ƒç”¨åˆ°ç”¨æˆ·çš„ Handler, æœŸé—´ä¸è¿›è¡Œçº¿ç¨‹åˆ‡æ¢</strong>, è¿™ç§ä¸²è¡ŒåŒ–å¤„ç†æ–¹å¼é¿å…äº†å¤šçº¿ç¨‹æ“ä½œå¯¼è‡´çš„é”çš„ç«äº‰.</p> <p>ä¸€ä¸ª Pipeline ä¸­æœ‰<strong>å¤šä¸ª Handler ä¹Ÿä¼šåœ¨ä¸€ä¸ªçº¿ç¨‹å†…å…¨éƒ¨ä¸²è¡Œæ‰§è¡Œ, ä¸æ¶‰åŠçº¿ç¨‹åˆ‡æ¢ç­‰é—®é¢˜</strong>.</p> <h5 id="_2-çµæ´»çš„tcpå‚æ•°é…ç½®èƒ½åŠ›"><a href="#_2-çµæ´»çš„tcpå‚æ•°é…ç½®èƒ½åŠ›" class="header-anchor">#</a> 2.çµæ´»çš„TCPå‚æ•°é…ç½®èƒ½åŠ›</h5> <p>åˆç†è®¾ç½® <strong>TCP å‚æ•°</strong>åœ¨æŸäº›åœºæ™¯ä¸‹å¯¹äºæ€§èƒ½çš„æå‡å¯ä»¥èµ·åˆ°æ˜¾è‘—çš„æ•ˆæœ, ä¾‹å¦‚æ¥æ”¶ç¼“å†²åŒº SO_RCVBUF å’Œå‘é€ç¼“å†²åŒº SO_SNDBUF. å¦‚æœè®¾ç½®ä¸å½“, å¯¹æ€§èƒ½çš„å½±å“æ˜¯éå¸¸å¤§çš„. é€šå¸¸å»ºè®®å€¼ä¸º <strong>128K æˆ–è€… 256K</strong>.</p> <p>Netty åœ¨å¯åŠ¨è¾…åŠ©ç±» <strong>ChannelOption</strong> ä¸­å¯ä»¥çµæ´»çš„<strong>é…ç½® TCP å‚æ•°</strong>, æ»¡è¶³ä¸åŒçš„åœºæ™¯éœ€æ±‚.</p> <p><img src="https://nano-note.oss-cn-beijing.aliyuncs.com/images/image-20200727211530128.png" alt="" title="TCPé…ç½®å‚æ•°"></p> <h5 id="_3-å¹¶å‘ä¼˜åŒ–"><a href="#_3-å¹¶å‘ä¼˜åŒ–" class="header-anchor">#</a> 3.å¹¶å‘ä¼˜åŒ–</h5> <ul><li><strong>volatile</strong> çš„å¤§é‡ä¸”åˆç†çš„ä½¿ç”¨.</li> <li><strong>CAS</strong> å’ŒåŸå­ç±»çš„å¹¿æ³›ä½¿ç”¨.</li> <li>çº¿ç¨‹<strong>å®‰å…¨å®¹å™¨</strong>çš„ä½¿ç”¨.</li> <li>é€šè¿‡<strong>è¯»å†™é”</strong>æå‡å¹¶å‘æ€§èƒ½.</li></ul> <p>â€</p> <p>â€</p> <h4 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="header-anchor">#</a> å‚è€ƒèµ„æ–™</h4> <ul><li><a href="https://www.cnblogs.com/AIPAOJIAO/p/10631551.html" target="_blank" rel="noopener noreferrer">Nettyç²˜åŒ…æ‹†åŒ…è§£æ<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://www.cnblogs.com/rickiyang/p/13100413.html" target="_blank" rel="noopener noreferrer">Nettyå†…å­˜æ± <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul> <p>â€</p></div></div>  <div class="page-edit"><div class="edit-link"><a href="https://github.com/xugaoyi/vuepress-theme-vdoing/edit/main/docs/30.ç³»ç»Ÿ/3000.ç³»ç»Ÿ/150.ç³»ç»Ÿæ¥å…¥å±‚/300.Netty.md" target="_blank" rel="noopener noreferrer">ç¼–è¾‘</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <!----> <!----></div> <div class="page-nav-wapper"><div class="page-nav-centre-wrap"><a href="/pages/d4123d/" class="page-nav-centre page-nav-centre-prev"><div class="tooltip">æ·±å…¥æ‹†è§£Tomcatä¸Jetty(æå®¢æ—¶é—´)ğŸŒ¸</div></a> <a href="/pages/05077d/" class="page-nav-centre page-nav-centre-next"><div class="tooltip">åŸºç¡€</div></a></div> <div class="page-nav"><p class="inner"><span class="prev">
        â†
        <a href="/pages/d4123d/" class="prev">æ·±å…¥æ‹†è§£Tomcatä¸Jetty(æå®¢æ—¶é—´)ğŸŒ¸</a></span> <span class="next"><a href="/pages/05077d/">åŸºç¡€</a>â†’
      </span></p></div></div></div> <!----></main></div> <div class="footer"><div class="icons"><a href="mailto:1174520425@qq.com" title="å‘é‚®ä»¶" target="_blank" class="iconfont icon-youjian"></a><a href="https://github.com/nanodaemony" title="GitHub" target="_blank" class="iconfont icon-github"></a></div> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="æœ¬ç«™ä¸»é¢˜">Vdoing</a> 
    | Copyright Â© 2019-2025
    <span>è¾¾å°”æ–‡çš„çŒ¹ | MIT License</span></div> <div class="buttons"><div title="è¿”å›é¡¶éƒ¨" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="å»è¯„è®º" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="ä¸»é¢˜æ¨¡å¼" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          è·Ÿéšç³»ç»Ÿ
        </li><li class="iconfont icon-rijianmoshi">
          æµ…è‰²æ¨¡å¼
        </li><li class="iconfont icon-yejianmoshi">
          æ·±è‰²æ¨¡å¼
        </li><li class="iconfont icon-yuedu">
          é˜…è¯»æ¨¡å¼
        </li></ul></div></div> <!----> <!----> <!----></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.3f3e0e10.js" defer></script><script src="/assets/js/2.e9fcb30c.js" defer></script><script src="/assets/js/3.1998f389.js" defer></script><script src="/assets/js/167.009d47a3.js" defer></script>
  </body>
</html>
