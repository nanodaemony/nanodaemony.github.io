<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>OAuth2.0实战课(极客时间)🌟 | Pangolin Note</title>
    <meta name="generator" content="VuePress 1.9.5">
    <link rel="icon" href="/img/favicon.ico">
    <meta name="description" content="大道至简">
    <meta name="keywords" content="前端博客,个人技术博客,前端,前端开发,前端框架,web前端,前端面试题,技术文档,学习,面试,JavaScript,js,ES6,TypeScript,vue,python,css3,html5,Node,git,github,markdown">
    <meta name="baidu-site-verification" content="7F55weZDDc">
    <meta name="theme-color" content="#11a8cd">
    
    <link rel="preload" href="/assets/css/0.styles.56073ad3.css" as="style"><link rel="preload" href="/assets/js/app.3f3e0e10.js" as="script"><link rel="preload" href="/assets/js/2.e9fcb30c.js" as="script"><link rel="preload" href="/assets/js/3.1998f389.js" as="script"><link rel="preload" href="/assets/js/189.fac747e3.js" as="script"><link rel="prefetch" href="/assets/js/10.0b55747f.js"><link rel="prefetch" href="/assets/js/100.b8912a99.js"><link rel="prefetch" href="/assets/js/101.a6740c8a.js"><link rel="prefetch" href="/assets/js/102.e31e89b2.js"><link rel="prefetch" href="/assets/js/103.2c5dbdae.js"><link rel="prefetch" href="/assets/js/104.0e9c02f6.js"><link rel="prefetch" href="/assets/js/105.8288396c.js"><link rel="prefetch" href="/assets/js/106.62f43c11.js"><link rel="prefetch" href="/assets/js/107.70c90211.js"><link rel="prefetch" href="/assets/js/108.b488ce56.js"><link rel="prefetch" href="/assets/js/109.12942650.js"><link rel="prefetch" href="/assets/js/11.ac3fd1ca.js"><link rel="prefetch" href="/assets/js/110.1e57ecba.js"><link rel="prefetch" href="/assets/js/111.6e33b4ea.js"><link rel="prefetch" href="/assets/js/112.bd52831b.js"><link rel="prefetch" href="/assets/js/113.868c1ac9.js"><link rel="prefetch" href="/assets/js/114.090549d1.js"><link rel="prefetch" href="/assets/js/115.d97f6c2b.js"><link rel="prefetch" href="/assets/js/116.097c4b4e.js"><link rel="prefetch" href="/assets/js/117.4024cfe2.js"><link rel="prefetch" href="/assets/js/118.e3057cba.js"><link rel="prefetch" href="/assets/js/119.4ef1fa3b.js"><link rel="prefetch" href="/assets/js/12.863eaabe.js"><link rel="prefetch" href="/assets/js/120.78f9df50.js"><link rel="prefetch" href="/assets/js/121.8e16df87.js"><link rel="prefetch" href="/assets/js/122.f21c0107.js"><link rel="prefetch" href="/assets/js/123.ea1cb375.js"><link rel="prefetch" href="/assets/js/124.01c04c6e.js"><link rel="prefetch" href="/assets/js/125.d383e301.js"><link rel="prefetch" href="/assets/js/126.3162cb47.js"><link rel="prefetch" href="/assets/js/127.c6bebae6.js"><link rel="prefetch" href="/assets/js/128.d659db60.js"><link rel="prefetch" href="/assets/js/129.2afdcf48.js"><link rel="prefetch" href="/assets/js/13.4f59ce35.js"><link rel="prefetch" href="/assets/js/130.beb9ed9d.js"><link rel="prefetch" href="/assets/js/131.35b05f8a.js"><link rel="prefetch" href="/assets/js/132.d77f4f93.js"><link rel="prefetch" href="/assets/js/133.4ceda6e5.js"><link rel="prefetch" href="/assets/js/134.11390c5f.js"><link rel="prefetch" href="/assets/js/135.32f9e38f.js"><link rel="prefetch" href="/assets/js/136.6d8bb0f2.js"><link rel="prefetch" href="/assets/js/137.9c0ffeef.js"><link rel="prefetch" href="/assets/js/138.88d86e5f.js"><link rel="prefetch" href="/assets/js/139.8c2c3d6c.js"><link rel="prefetch" href="/assets/js/14.11c82d35.js"><link rel="prefetch" href="/assets/js/140.c5c375d3.js"><link rel="prefetch" href="/assets/js/141.d703f30b.js"><link rel="prefetch" href="/assets/js/142.6a005a44.js"><link rel="prefetch" href="/assets/js/143.9b2edf6f.js"><link rel="prefetch" href="/assets/js/144.3fd013c9.js"><link rel="prefetch" href="/assets/js/145.b05079c5.js"><link rel="prefetch" href="/assets/js/146.ed5360a6.js"><link rel="prefetch" href="/assets/js/147.7408d86f.js"><link rel="prefetch" href="/assets/js/148.f390b370.js"><link rel="prefetch" href="/assets/js/149.95017f0a.js"><link rel="prefetch" href="/assets/js/15.bd143bd5.js"><link rel="prefetch" href="/assets/js/150.f0ede764.js"><link rel="prefetch" href="/assets/js/151.b7093623.js"><link rel="prefetch" href="/assets/js/152.a82a6c83.js"><link rel="prefetch" href="/assets/js/153.965e3fb2.js"><link rel="prefetch" href="/assets/js/154.9e49311e.js"><link rel="prefetch" href="/assets/js/155.cef33ba5.js"><link rel="prefetch" href="/assets/js/156.bcc397ae.js"><link rel="prefetch" href="/assets/js/157.90824739.js"><link rel="prefetch" href="/assets/js/158.efd429b9.js"><link rel="prefetch" href="/assets/js/159.122ff5b7.js"><link rel="prefetch" href="/assets/js/16.2449162b.js"><link rel="prefetch" href="/assets/js/160.0b806535.js"><link rel="prefetch" href="/assets/js/161.835052c6.js"><link rel="prefetch" href="/assets/js/162.ca34e2d2.js"><link rel="prefetch" href="/assets/js/163.08000d04.js"><link rel="prefetch" href="/assets/js/164.a1cc0109.js"><link rel="prefetch" href="/assets/js/165.65444686.js"><link rel="prefetch" href="/assets/js/166.7d73c84f.js"><link rel="prefetch" href="/assets/js/167.009d47a3.js"><link rel="prefetch" href="/assets/js/168.0afeae2a.js"><link rel="prefetch" href="/assets/js/169.7654cb31.js"><link rel="prefetch" href="/assets/js/17.eb7f9def.js"><link rel="prefetch" href="/assets/js/170.58569530.js"><link rel="prefetch" href="/assets/js/171.7db9ed40.js"><link rel="prefetch" href="/assets/js/172.3cb50ed4.js"><link rel="prefetch" href="/assets/js/173.0846425f.js"><link rel="prefetch" href="/assets/js/174.9e95f111.js"><link rel="prefetch" href="/assets/js/175.ef2098f2.js"><link rel="prefetch" href="/assets/js/176.c2635fe9.js"><link rel="prefetch" href="/assets/js/177.4fa38e8e.js"><link rel="prefetch" href="/assets/js/178.2be7037f.js"><link rel="prefetch" href="/assets/js/179.bf3bba28.js"><link rel="prefetch" href="/assets/js/18.0455f4d1.js"><link rel="prefetch" href="/assets/js/180.72c5f597.js"><link rel="prefetch" href="/assets/js/181.42287bcc.js"><link rel="prefetch" href="/assets/js/182.6cd4bf1a.js"><link rel="prefetch" href="/assets/js/183.05dbbfd9.js"><link rel="prefetch" href="/assets/js/184.03de7e00.js"><link rel="prefetch" href="/assets/js/185.42dd210e.js"><link rel="prefetch" href="/assets/js/186.28ee0f8a.js"><link rel="prefetch" href="/assets/js/187.bb58697b.js"><link rel="prefetch" href="/assets/js/188.1bc8be96.js"><link rel="prefetch" href="/assets/js/19.ae9e35d6.js"><link rel="prefetch" href="/assets/js/190.ea533ac7.js"><link rel="prefetch" href="/assets/js/191.6dc6eb13.js"><link rel="prefetch" href="/assets/js/192.184d249f.js"><link rel="prefetch" href="/assets/js/193.4a06bc12.js"><link rel="prefetch" href="/assets/js/194.8cce60a9.js"><link rel="prefetch" href="/assets/js/195.93231a13.js"><link rel="prefetch" href="/assets/js/196.4a596bde.js"><link rel="prefetch" href="/assets/js/197.96c113cf.js"><link rel="prefetch" href="/assets/js/198.73ba3f67.js"><link rel="prefetch" href="/assets/js/199.74bab595.js"><link rel="prefetch" href="/assets/js/20.b542d0e7.js"><link rel="prefetch" href="/assets/js/200.69a6928a.js"><link rel="prefetch" href="/assets/js/201.9ffa7c5a.js"><link rel="prefetch" href="/assets/js/202.41edb652.js"><link rel="prefetch" href="/assets/js/203.7fabcef3.js"><link rel="prefetch" href="/assets/js/204.b0ae2f62.js"><link rel="prefetch" href="/assets/js/205.add8738b.js"><link rel="prefetch" href="/assets/js/206.f3a712ec.js"><link rel="prefetch" href="/assets/js/207.cd7dd729.js"><link rel="prefetch" href="/assets/js/208.78b33afa.js"><link rel="prefetch" href="/assets/js/209.9d3329ff.js"><link rel="prefetch" href="/assets/js/21.5a050318.js"><link rel="prefetch" href="/assets/js/210.d285d5ac.js"><link rel="prefetch" href="/assets/js/211.8791bb3f.js"><link rel="prefetch" href="/assets/js/212.84ed81a8.js"><link rel="prefetch" href="/assets/js/213.7b990580.js"><link rel="prefetch" href="/assets/js/214.da31f20c.js"><link rel="prefetch" href="/assets/js/215.9eeed659.js"><link rel="prefetch" href="/assets/js/216.9539f0ec.js"><link rel="prefetch" href="/assets/js/217.11b575be.js"><link rel="prefetch" href="/assets/js/218.a67f12f1.js"><link rel="prefetch" href="/assets/js/219.bfbb817a.js"><link rel="prefetch" href="/assets/js/22.2bc6f7e3.js"><link rel="prefetch" href="/assets/js/220.8b01342f.js"><link rel="prefetch" href="/assets/js/221.b450decd.js"><link rel="prefetch" href="/assets/js/222.97468507.js"><link rel="prefetch" href="/assets/js/223.b6dafd73.js"><link rel="prefetch" href="/assets/js/224.c86c18c6.js"><link rel="prefetch" href="/assets/js/225.b0dcf86e.js"><link rel="prefetch" href="/assets/js/226.02cc2999.js"><link rel="prefetch" href="/assets/js/227.8474ef5a.js"><link rel="prefetch" href="/assets/js/228.0298e421.js"><link rel="prefetch" href="/assets/js/229.6aeaf595.js"><link rel="prefetch" href="/assets/js/23.9995fce4.js"><link rel="prefetch" href="/assets/js/230.a5785286.js"><link rel="prefetch" href="/assets/js/231.d791daa4.js"><link rel="prefetch" href="/assets/js/232.97aeeb00.js"><link rel="prefetch" href="/assets/js/233.46e51e28.js"><link rel="prefetch" href="/assets/js/234.2cffe82f.js"><link rel="prefetch" href="/assets/js/235.14965da6.js"><link rel="prefetch" href="/assets/js/236.00a5afc0.js"><link rel="prefetch" href="/assets/js/237.3b73d52f.js"><link rel="prefetch" href="/assets/js/238.6e1db765.js"><link rel="prefetch" href="/assets/js/239.75866c5e.js"><link rel="prefetch" href="/assets/js/24.9141eeb2.js"><link rel="prefetch" href="/assets/js/240.af9c2cc9.js"><link rel="prefetch" href="/assets/js/241.388acab2.js"><link rel="prefetch" href="/assets/js/242.c60f2b48.js"><link rel="prefetch" href="/assets/js/243.d8e81b13.js"><link rel="prefetch" href="/assets/js/244.58b0b21d.js"><link rel="prefetch" href="/assets/js/245.c3768497.js"><link rel="prefetch" href="/assets/js/246.ac8bbe7a.js"><link rel="prefetch" href="/assets/js/247.d095f70a.js"><link rel="prefetch" href="/assets/js/248.e9f210b5.js"><link rel="prefetch" href="/assets/js/249.a9fad023.js"><link rel="prefetch" href="/assets/js/25.98e8593e.js"><link rel="prefetch" href="/assets/js/250.ae7f0ebb.js"><link rel="prefetch" href="/assets/js/251.9a617d55.js"><link rel="prefetch" href="/assets/js/252.ce082446.js"><link rel="prefetch" href="/assets/js/253.4575302d.js"><link rel="prefetch" href="/assets/js/254.5899a61b.js"><link rel="prefetch" href="/assets/js/255.66c69f31.js"><link rel="prefetch" href="/assets/js/256.8fd6c706.js"><link rel="prefetch" href="/assets/js/257.31b77e5e.js"><link rel="prefetch" href="/assets/js/258.eba48891.js"><link rel="prefetch" href="/assets/js/259.edf74b59.js"><link rel="prefetch" href="/assets/js/26.e69924ea.js"><link rel="prefetch" href="/assets/js/260.cf2ed36d.js"><link rel="prefetch" href="/assets/js/261.9e7792d8.js"><link rel="prefetch" href="/assets/js/262.e7b9433e.js"><link rel="prefetch" href="/assets/js/263.1185b25c.js"><link rel="prefetch" href="/assets/js/264.5e0f89cb.js"><link rel="prefetch" href="/assets/js/265.a38d3b94.js"><link rel="prefetch" href="/assets/js/266.2ef170b3.js"><link rel="prefetch" href="/assets/js/267.a7d14651.js"><link rel="prefetch" href="/assets/js/268.05b18748.js"><link rel="prefetch" href="/assets/js/269.dad48d6f.js"><link rel="prefetch" href="/assets/js/27.13612515.js"><link rel="prefetch" href="/assets/js/270.4f5a6b8d.js"><link rel="prefetch" href="/assets/js/271.7ebf6682.js"><link rel="prefetch" href="/assets/js/272.7c2fbfd1.js"><link rel="prefetch" href="/assets/js/273.8ee20732.js"><link rel="prefetch" href="/assets/js/274.d525242a.js"><link rel="prefetch" href="/assets/js/275.a8a19acb.js"><link rel="prefetch" href="/assets/js/276.df3a4eb4.js"><link rel="prefetch" href="/assets/js/277.336debda.js"><link rel="prefetch" href="/assets/js/278.c470625f.js"><link rel="prefetch" href="/assets/js/279.a91e1a64.js"><link rel="prefetch" href="/assets/js/28.ab7ae1df.js"><link rel="prefetch" href="/assets/js/280.87e25c9a.js"><link rel="prefetch" href="/assets/js/281.87c1ba25.js"><link rel="prefetch" href="/assets/js/282.dcd4dce0.js"><link rel="prefetch" href="/assets/js/283.abac2e00.js"><link rel="prefetch" href="/assets/js/284.f6079659.js"><link rel="prefetch" href="/assets/js/285.f1b39879.js"><link rel="prefetch" href="/assets/js/286.f6a79242.js"><link rel="prefetch" href="/assets/js/287.06bebe07.js"><link rel="prefetch" href="/assets/js/288.89e325df.js"><link rel="prefetch" href="/assets/js/289.3aa1bedd.js"><link rel="prefetch" href="/assets/js/29.ebe50f76.js"><link rel="prefetch" href="/assets/js/290.ee059c92.js"><link rel="prefetch" href="/assets/js/291.fa9a921a.js"><link rel="prefetch" href="/assets/js/292.2a8811cd.js"><link rel="prefetch" href="/assets/js/293.eec09cdf.js"><link rel="prefetch" href="/assets/js/294.dfac20dc.js"><link rel="prefetch" href="/assets/js/295.825d2070.js"><link rel="prefetch" href="/assets/js/296.f645861e.js"><link rel="prefetch" href="/assets/js/297.424fdb17.js"><link rel="prefetch" href="/assets/js/298.ebf87cdc.js"><link rel="prefetch" href="/assets/js/299.b8f19cbb.js"><link rel="prefetch" href="/assets/js/30.75237511.js"><link rel="prefetch" href="/assets/js/300.10fb6d4f.js"><link rel="prefetch" href="/assets/js/301.ef77c612.js"><link rel="prefetch" href="/assets/js/302.1b839763.js"><link rel="prefetch" href="/assets/js/303.609f7d98.js"><link rel="prefetch" href="/assets/js/304.1d255f19.js"><link rel="prefetch" href="/assets/js/305.b0234f2c.js"><link rel="prefetch" href="/assets/js/306.48677f64.js"><link rel="prefetch" href="/assets/js/307.14390d4b.js"><link rel="prefetch" href="/assets/js/308.fa730b28.js"><link rel="prefetch" href="/assets/js/309.0496b9e0.js"><link rel="prefetch" href="/assets/js/31.cf3f471a.js"><link rel="prefetch" href="/assets/js/310.a31676dc.js"><link rel="prefetch" href="/assets/js/311.ed53adc5.js"><link rel="prefetch" href="/assets/js/312.1b0ff2f1.js"><link rel="prefetch" href="/assets/js/313.bf123f32.js"><link rel="prefetch" href="/assets/js/314.4e6ce06b.js"><link rel="prefetch" href="/assets/js/315.8eb18560.js"><link rel="prefetch" href="/assets/js/32.74fef842.js"><link rel="prefetch" href="/assets/js/33.bc2d190b.js"><link rel="prefetch" href="/assets/js/34.d23438fc.js"><link rel="prefetch" href="/assets/js/35.7675c4d0.js"><link rel="prefetch" href="/assets/js/36.96a4161b.js"><link rel="prefetch" href="/assets/js/37.d1824f2f.js"><link rel="prefetch" href="/assets/js/38.4effff9e.js"><link rel="prefetch" href="/assets/js/39.6509914b.js"><link rel="prefetch" href="/assets/js/4.4d01750f.js"><link rel="prefetch" href="/assets/js/40.1509d08b.js"><link rel="prefetch" href="/assets/js/41.f2c1124f.js"><link rel="prefetch" href="/assets/js/42.e541d077.js"><link rel="prefetch" href="/assets/js/43.369de999.js"><link rel="prefetch" href="/assets/js/44.43959db0.js"><link rel="prefetch" href="/assets/js/45.282fbd31.js"><link rel="prefetch" href="/assets/js/46.1b83cfe9.js"><link rel="prefetch" href="/assets/js/47.c3a88e41.js"><link rel="prefetch" href="/assets/js/48.bc7c0a1b.js"><link rel="prefetch" href="/assets/js/49.92a4e5ba.js"><link rel="prefetch" href="/assets/js/5.c3991e24.js"><link rel="prefetch" href="/assets/js/50.9c488c6c.js"><link rel="prefetch" href="/assets/js/51.546ea632.js"><link rel="prefetch" href="/assets/js/52.0d2ccee1.js"><link rel="prefetch" href="/assets/js/53.6f52b5b1.js"><link rel="prefetch" href="/assets/js/54.c838b295.js"><link rel="prefetch" href="/assets/js/55.13af99ee.js"><link rel="prefetch" href="/assets/js/56.6be6d1ed.js"><link rel="prefetch" href="/assets/js/57.67c98b39.js"><link rel="prefetch" href="/assets/js/58.107e82ec.js"><link rel="prefetch" href="/assets/js/59.b3e5edc7.js"><link rel="prefetch" href="/assets/js/6.36a535f9.js"><link rel="prefetch" href="/assets/js/60.3b0b4ba5.js"><link rel="prefetch" href="/assets/js/61.3df843df.js"><link rel="prefetch" href="/assets/js/62.1213823d.js"><link rel="prefetch" href="/assets/js/63.e8f3f926.js"><link rel="prefetch" href="/assets/js/64.e1219050.js"><link rel="prefetch" href="/assets/js/65.5bf5bb0b.js"><link rel="prefetch" href="/assets/js/66.a2502afb.js"><link rel="prefetch" href="/assets/js/67.690dd59b.js"><link rel="prefetch" href="/assets/js/68.de7b0915.js"><link rel="prefetch" href="/assets/js/69.ac61dd61.js"><link rel="prefetch" href="/assets/js/7.5d254238.js"><link rel="prefetch" href="/assets/js/70.3edd41b1.js"><link rel="prefetch" href="/assets/js/71.d23407e9.js"><link rel="prefetch" href="/assets/js/72.a5bd01bc.js"><link rel="prefetch" href="/assets/js/73.c9f4dd57.js"><link rel="prefetch" href="/assets/js/74.66323fc1.js"><link rel="prefetch" href="/assets/js/75.e1a72e00.js"><link rel="prefetch" href="/assets/js/76.801268b4.js"><link rel="prefetch" href="/assets/js/77.3a5fda67.js"><link rel="prefetch" href="/assets/js/78.54d84cd4.js"><link rel="prefetch" href="/assets/js/79.fa10f4e3.js"><link rel="prefetch" href="/assets/js/8.e060e47d.js"><link rel="prefetch" href="/assets/js/80.d5b24fea.js"><link rel="prefetch" href="/assets/js/81.0e9da714.js"><link rel="prefetch" href="/assets/js/82.e96ff6d7.js"><link rel="prefetch" href="/assets/js/83.771cced1.js"><link rel="prefetch" href="/assets/js/84.220b69e7.js"><link rel="prefetch" href="/assets/js/85.7dcc5659.js"><link rel="prefetch" href="/assets/js/86.44ba2100.js"><link rel="prefetch" href="/assets/js/87.281da75d.js"><link rel="prefetch" href="/assets/js/88.12d88449.js"><link rel="prefetch" href="/assets/js/89.f28c86d3.js"><link rel="prefetch" href="/assets/js/9.8f9fef32.js"><link rel="prefetch" href="/assets/js/90.715cabb2.js"><link rel="prefetch" href="/assets/js/91.6ced7c82.js"><link rel="prefetch" href="/assets/js/92.c05b33ca.js"><link rel="prefetch" href="/assets/js/93.6bf5fb66.js"><link rel="prefetch" href="/assets/js/94.3561200e.js"><link rel="prefetch" href="/assets/js/95.0f2cf716.js"><link rel="prefetch" href="/assets/js/96.ac8487ea.js"><link rel="prefetch" href="/assets/js/97.48042b5a.js"><link rel="prefetch" href="/assets/js/98.441bb7f8.js"><link rel="prefetch" href="/assets/js/99.4b214d92.js">
    <link rel="stylesheet" href="/assets/css/0.styles.56073ad3.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu"><header class="navbar blur"><div title="目录" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/img/magic.png" alt="Pangolin Note" class="logo"> <span class="site-name can-hide">Pangolin Note</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">🏡首页</a></div><div class="nav-item"><a href="/basic/" class="nav-link">基础</a></div><div class="nav-item"><a href="/develop/" class="nav-link">开发</a></div><div class="nav-item"><a href="/middleware/" class="nav-link">系统</a></div><div class="nav-item"><a href="/algorithm/" class="nav-link">算法</a></div><div class="nav-item"><a href="/books/" class="nav-link">🍀读书笔记</a></div><div class="nav-item"><a href="/work/" class="nav-link">工作</a></div><div class="nav-item"><a href="/pangolin/" class="nav-link">🌸达尔文的猹</a></div><div class="nav-item"><a href="/pages/beb6c0bd8a66cea6/" class="nav-link">收藏</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/archives/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">归档</a></li></ul></div></div> <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><div class="blogger"><img src="/img/avatarnew.png"> <div class="blogger-info"><h3>达尔文的猹</h3> <span>大道至简 悟在天成</span></div></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">🏡首页</a></div><div class="nav-item"><a href="/basic/" class="nav-link">基础</a></div><div class="nav-item"><a href="/develop/" class="nav-link">开发</a></div><div class="nav-item"><a href="/middleware/" class="nav-link">系统</a></div><div class="nav-item"><a href="/algorithm/" class="nav-link">算法</a></div><div class="nav-item"><a href="/books/" class="nav-link">🍀读书笔记</a></div><div class="nav-item"><a href="/work/" class="nav-link">工作</a></div><div class="nav-item"><a href="/pangolin/" class="nav-link">🌸达尔文的猹</a></div><div class="nav-item"><a href="/pages/beb6c0bd8a66cea6/" class="nav-link">收藏</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/archives/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">归档</a></li></ul></div></div> <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>系统</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading"><span>分布式系统理论</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/129626/" class="sidebar-link">分布式系统基础</a></li><li><a href="/pages/fb5d35/" class="sidebar-link">分布式共识算法</a></li><li><a href="/pages/12ac37/" class="sidebar-link">分布式系统组件</a></li><li><a href="/pages/d03ebf/" class="sidebar-link">分布式技术原理与算法解析(极客时间)🌸</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading"><span>系统接入层</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/f1b6c4/" class="sidebar-link">Nginx基础</a></li><li><a href="/pages/d4123d/" class="sidebar-link">深入拆解Tomcat与Jetty(极客时间)🌸</a></li><li><a href="/pages/baee2f/" class="sidebar-link">Netty</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading"><span>服务治理-注册发现与RPC</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/05077d/" class="sidebar-link">基础</a></li><li><a href="/pages/51b6aa/" class="sidebar-link">RPC实战与核心原理(极客时间)🌸</a></li><li><a href="/pages/0966ee/" class="sidebar-link">Zookeeper</a></li><li><a href="/pages/3b7e05/" class="sidebar-link">Nacos</a></li><li><a href="/pages/7f31f8/" class="sidebar-link">Dubbo</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading"><span>服务治理-流量控制</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/44bfa8/" class="sidebar-link">负载均衡</a></li><li><a href="/pages/4d5a6c/" class="sidebar-link">限流</a></li><li><a href="/pages/e0c561/" class="sidebar-link">熔断</a></li><li><a href="/pages/12ae40/" class="sidebar-link">网关路由</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading open"><span>服务治理-系统监控与安全</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/8c9210/" class="sidebar-link">系统安全性</a></li><li><a href="/pages/c9bf40/" class="sidebar-link">系统监控组件</a></li><li><a href="/pages/3f3cf7/" class="sidebar-link">运维监控系统实战(极客时间)🌸</a></li><li><a href="/pages/e20e02/" aria-current="page" class="active sidebar-link">OAuth2.0实战课(极客时间)🌟</a><ul class="sidebar-sub-headers"></ul></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading"><span>中间件-消息队列</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/96d94c/" class="sidebar-link">消息队列基础</a></li><li><a href="/pages/abf16c/" class="sidebar-link">RabbitMQ</a></li><li><a href="/pages/4fc3f1/" class="sidebar-link">Kafka</a></li><li><a href="/pages/013cfe/" class="sidebar-link">RocketMQ</a></li><li><a href="/pages/ed8d92/" class="sidebar-link">Disruptor</a></li><li><a href="/pages/249149/" class="sidebar-link">消息队列高手课(极客时间)🌟</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading"><span>中间件-缓存</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/946847/" class="sidebar-link">缓存基础</a></li><li><a href="/pages/e46d56/" class="sidebar-link">本地缓存</a></li><li><a href="/pages/0abfb9/" class="sidebar-link">Redis基础</a></li><li><a href="/pages/09236a/" class="sidebar-link">Redis持久化</a></li><li><a href="/pages/867f9b/" class="sidebar-link">Redis主从复制</a></li><li><a href="/pages/50cae1/" class="sidebar-link">Redis哨兵</a></li><li><a href="/pages/43b45c/" class="sidebar-link">Redis集群</a></li><li><a href="/pages/a32379/" class="sidebar-link">Redis内存管理与运维</a></li><li><a href="/pages/386037/" class="sidebar-link">Redis核心技术与实战(极客时间)🌸</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading"><span>中间件-其他</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/23044d/" class="sidebar-link">定时任务-XXLJob</a></li><li><a href="/pages/459117/" class="sidebar-link">ES与检索</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading"><span>系统设计与优化</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/41a845/" class="sidebar-link">凤凰架构</a></li><li><a href="/pages/68cc0b/" class="sidebar-link">左耳听风(极客时间)🌟</a></li><li><a href="/pages/e3e99c/" class="sidebar-link">从0开始学微服务(极客时间)🌸</a></li><li><a href="/pages/1e5368/" class="sidebar-link">高并发系统设计40问(极客时间)🌸</a></li><li><a href="/pages/33599f/" class="sidebar-link">系统性能调优必知必会(极客时间)🌸</a></li><li><a href="/pages/c83472/" class="sidebar-link">后端技术面试38讲(极客时间)</a></li><li><a href="/pages/4404b6/" class="sidebar-link">架构实战案例解析(极客时间)🌸</a></li><li><a href="/pages/8f1c1d/" class="sidebar-link">如何设计一个秒杀系统(极客时间)</a></li></ul></section></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>容器</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading open"><span>容器</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/582acf/" class="sidebar-link">部署Minikube</a></li><li><a href="/pages/98e5e4/" class="sidebar-link">容器实战高手课(极客时间)🌸</a></li><li><a href="/pages/c6a42c/" class="sidebar-link">Kubernetes实战🌸</a></li><li><a href="/pages/f35c72/" class="sidebar-link">深入剖析Kubernetes(极客时间)🌸</a></li><li><a href="/pages/caa314/" class="sidebar-link">Istio</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading"><span>自动化运维</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/beb97f/" class="sidebar-link">持续集成(CICD)</a></li><li><a href="/pages/a0df2d/" class="sidebar-link">DevOps</a></li><li><a href="/pages/765815/" class="sidebar-link">SRE实战手册(极客时间)</a></li></ul></section></li></ul></section></li></ul> </aside> <div><main class="page"><div class="theme-vdoing-wrapper "><div class="articleInfo-wrap" data-v-06970110><div class="articleInfo" data-v-06970110><ul class="breadcrumbs" data-v-06970110><li data-v-06970110><a href="/" title="首页" class="iconfont icon-home router-link-active" data-v-06970110></a></li> <li data-v-06970110><a href="/middleware/#系统" data-v-06970110>系统</a></li><li data-v-06970110><a href="/middleware/#系统" data-v-06970110>系统</a></li><li data-v-06970110><a href="/middleware/#服务治理-系统监控与安全" data-v-06970110>服务治理-系统监控与安全</a></li></ul> <div class="info" data-v-06970110><div title="作者" class="author iconfont icon-touxiang" data-v-06970110><a href="https://github.com/nanodaemony" target="_blank" title="作者" class="beLink" data-v-06970110>NanoDaemony</a></div> <div title="创建时间" class="date iconfont icon-riqi" data-v-06970110><a href="javascript:;" data-v-06970110>2025-02-26</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-title">本文目录</div> <div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABKFJREFUSA3tVl1oFVcQnrMbrak3QUgkya1akpJYcrUtIqW1JvFBE9LiQ5v6JmJpolbMg32rVrhgoYK0QiMY6i9Y6EMaW5D+xFJaTYItIuK2Kr3+BJNwkxBj05sQY3b3nM6cs2dv9t7NT/vQJw/sndk5M/PNzJkzewGerP+pAmy+ON8lLzUJgA8ZYxYIYZmGYRnctDaWvJJAmTtfP1pvXsBCCPP8QFcCaRkZYACgDZFO4stNIcBCajEOlmmC9XpJ9bAGCaPaPmzPl32dvLSVu3BWCTQs0XQQ6g0DYgwLIoAZbBCdW/i+781o1VVlm/410mw4h06Y7bIPHNyWDyL4FHkX03Q8SrzNhZTZriieckWt7cL6MM85YcLpsi/7O9/iXFT6MswI0DmmpkSaJ0qLxFIm3+i1THHB3zmBH3PYx9CcykcLOeQVVa7QtdxTgQgEleX2AjHYfwA+2ddV77ruGoJUbhGDI09YSNXyMpUt5ylOzxgbUmtOp7NmbNt8v3arjTBfYELmLUV+M+nSawNNAUqpT3ClJWg5I3BLT+cGW/DXNGCa6tx1aakCGEigArTn4TDIPdrXXYKCZNrHLMCOEPvHBlLQ99s9eHB7EB6NTki73CVPQ2F5MSx/uRQixfmq7rK0wYD8w8E905bnPDfwoWs/rfv93NWN/ZfvwsLIU7A09gxECyISeGJkHAau98L97tuw7NXnoPyNF8FcYGLGKsOs0mN3OEyec9esGW/ZEl945dTP34wlR2FZVQWU1q0Cw8Tr7p+hgLLNL0FPxx/Q35mA8aEUrH6nCgwEl0tn7wUiZYJnNRh6DK4UH/k0lfyrsBKdPVv/AriGIQcEDQZ65LBAGe2Rzui9Ybjz7XUppz1/uKBbyVPGkN3ZAeC6hr0x7Nr38N5+EqkoOm17xpoqR9ohQF55ERSvr4Dkr3chNfC3DMzGJlNBElW8w9nsGQvhNGIzDkXzCg8cLK951xHsFBlTJspJNi3ZFIMF2AeDV3q8DNOB+YHi6QTrChDIWDBRi5U5f+ZMfJLu3ccrqxtdxk4SKH336LFxSmkqefwU5T8fhdSdQf9IVKD6aNiwI/hnmcAZ91isYMJIaCUCx9W098+LgruikeTqzqqxKPUwqJyCPJiyemVVZBOijDGjD38Os0jOiSPL1z3SPjXNANbiNPXAdzTfukjjuknNBbyz3nwgTd3AVFqUJ5hpHlq9MveLnWwttUfoygBmvVjuikxND3znrhsELnZk7k+OjIGxeNEkomyLVta0xxn+HZhjBc4YZ/AFjHjz9u3xRZl2BN4aq9nFwWh16IrQ1aHHEd3j1+4/dB9OtH4e29A2H1DyHQRmOSfQZ1Fy7MHBTGB6J/Djq6p3OxyO2cB+4Car7v/o3GXgfAkj23+x9ID1Teoamo/SXcbvSf2PX7Vc8DdCmE1vN9di+32P9/5YR3vLnhCVGUWBjEkr3yh4H8v9CzmsbdhzOKzsJKM90iFdaTMjRPhGVsakRvOaRidljo6H6G7j+ctrJpsP+4COhDIl0La2+FS4+5mlocBaXY5QnGZysIBYoeSsl5qQzrSj/cgNrfuEzlWBfwA+EjrZyWUvpAAAAABJRU5ErkJggg==">OAuth2.0实战课(极客时间)🌟<!----></h1>  <div class="theme-vdoing-content content__default"><h1 id="_520-oauth2-0实战课-极客时间-🌟"><a href="#_520-oauth2-0实战课-极客时间-🌟" class="header-anchor">#</a> 520.OAuth2.0实战课(极客时间)🌟</h1> <h3 id="开篇词"><a href="#开篇词" class="header-anchor">#</a> 开篇词</h3> <h4 id="为什么要学oauth2-0"><a href="#为什么要学oauth2-0" class="header-anchor">#</a> 为什么要学OAuth2.0</h4> <p>越来越多的第三方应用都在向用户提供使用微信登录的解决方案, 来减少用户注册的繁琐操作. 而这个解决方案的背后原理, 也是这门课要讲到的 OAuth 2.0 技术.</p> <h5 id="_1-oauth-2-0是什么"><a href="#_1-oauth-2-0是什么" class="header-anchor">#</a> 1.OAuth 2.0是什么</h5> <p>那 OAuth 2.0 到底是什么呢? 先从字面上来分析下. OAuth 2.0 一词中的 &quot;Auth&quot; 表示 &quot;授权&quot;, 字母 &quot;O&quot; 是 Open 的简称, 表示 &quot;开放&quot; , 连在一起就表示 &quot;<strong>开放授权</strong>&quot;. 这也是为什么使用 OAuth 的场景, 通常发生在<strong>开放平台</strong>的环境下.</p> <p>OAuth 2.0 之前还有 OAuth 1.0. 这里说下这两个版本的 OAuth 有什么区别.</p> <p>在 OAuth 1.0 的时候, 它有个 &quot;很大的愿望&quot; 就是想用一套授权机制来应对现实中的所有场景, 比如 Web 应用场景, 移动 App 应用场景, 官方应用场景等等, 但是这些场景并不是完全相同的. 比如官方应用场景, 你说还需要让用户来授权吗? 如果需要, 始终使用一套授权机制给用户带来的体验, 是好还是坏呢?</p> <p>到了 OAuth 2.0 的时候, 就解决了 OAuth 1.0 面临的这种尴尬. <strong>OAuth 2.0 不再局限于一种授权机制, 它扩充了授权许可机制类型, 有了授权码许可机制, 客户端凭据机制, 资源拥有者凭据机制和隐式许可机制. 这样的 OAuth 机制就能够很灵活地适应现实中的各种场景, 比如移动应用的场景, 官方应用的场景, 等等</strong>.</p> <p>此外, OAuth 1.0 的弊端还包括安全上的固化攻击等问题, 因此 OAuth 1.0 现在已经是废弃状态了. 所以直接使用 OAuth 2.0 就可以了.</p> <h5 id="_2-这门课是怎么设计的"><a href="#_2-这门课是怎么设计的" class="header-anchor">#</a> 2.这门课是怎么设计的</h5> <p>本门课分为基础篇和进阶篇两大模块, 每个模块都会安排一些实践内容.</p> <p>**第一部分是基础篇, 就是你必须要掌握的 OAuth 2.0 的基础知识. ** 这一模块会细致地讲解授权码许可(Authorization Code)类型的流程, 包括 OAuth 2.0 内部组件之间的通信方式, 以及授权服务, 客户端(第三方软件), 受保护资源服务这三个组件的原理.</p> <p>在此基础上, 还会讲解其他三种常见许可类型, 分别是<strong>资源拥有者凭据许可(Resource Owner Password Credentials), 隐式许可(Implicit), 客户端凭据许可(Client Credentials)的原理</strong>, 以及如何选择适合自己实际场景的授权类型. 这样就能掌握整个 OAuth 2.0 中所有许可类型的运转机制了, 并且能够从容地在实际工作环境中使用它们.</p> <p>在讲述这些基础内容的时候, 会用一个小明使用第三方&quot;小兔打单软件&quot;来打印自己在京东店铺的订单数据的例子, 来贯穿始终.</p> <p>学完基础篇的内容, 就可以把 OAuth 2.0 用到实际的工作场景了.</p> <p><strong>第二部分进阶篇的内容, 会侧重讲一些 OAuth 2.0 更高级的用法</strong>, 也就是如何更安全地用, 扩展地用 OAuth 2.0.</p> <p>这部分内容会包括如何在移动 App 中使用 OAuth 2.0, 因使用不当而导致的 OAuth 2.0 安全漏洞有哪些, 以及如何利用 OAuth 2.0 实现一个 OpenID Connect 用户身份认证协议.</p> <p><strong>同时在 <strong>​</strong></strong>**GitHub **<strong><strong>​</strong>上准备了一份非常简单, 可落地的</strong>通过 Java 语言来实现的代码. 可落地的地方在于, 虽然它是一份简单的代码, 但它不仅把整个 OAuth 2.0 的组件都跑通了, 还包含了实践一个 OIDC 协议的具体实现.</p> <p>这里总结一下 OAuth 2.0 的知识体系图, 先了解下整个课程的知识结构.</p> <p><img src="/img/5ed84a0129be0e3b3e8934b2b6327f51-20230729094013-thwpm8f.png" alt=""></p> <h3 id="基础篇"><a href="#基础篇" class="header-anchor">#</a> 基础篇</h3> <h4 id="oauth-2-0是要通过什么方式解决什么问题"><a href="#oauth-2-0是要通过什么方式解决什么问题" class="header-anchor">#</a> OAuth 2.0是要通过什么方式解决什么问题</h4> <p>当第一次使用极客时间 App 的时候, 你是直接使用了第三方帐号(比如微信, 微博)登录, 还是选择了重新注册新用户? 如果你选择了重新注册用户, 那你还得上传头像, 输入用户名等信息. 但如果你选择了使用第三方帐号微信来登录, 那极客时间会直接使用你微信的这些信息作为基础信息, 你就能省心很多.</p> <p>这是怎么实现的? 微信把我的个人信息给了极客时间, 它又是怎么保证我的数据安全的呢?</p> <p>其实, 微信这一系列授权背后的原理都可以归到一个词上, 那就是 OAuth 2.0. 下面就来看看 OAuth 2.0 到底是什么, 能干什么以及它是怎么干的.</p> <h5 id="_1-oauth-2-0是什么-2"><a href="#_1-oauth-2-0是什么-2" class="header-anchor">#</a> 1.OAuth 2.0是什么</h5> <p>用一句话总结来说, <strong>OAuth 2.0 就是一种授权协议</strong>.</p> <p>那如何理解这里的 &quot;授权&quot; 呢?</p> <p>举个咱们生活中的例子. 假如你是一名销售人员, 你想去百度拜访你的大客户王总. 到了百度的大楼之后, 保安拦住了你, 问你要工牌. 你说: &quot;保安大哥啊, 我是来拜访王总的, 哪里有什么工牌&quot;. 保安大哥说: &quot;那你要去前台做个登记&quot;. 然后你就赶紧来到前台, 前台问你是不是做了登记. 你说王总秘书昨天有要你的手机号, 说是已经做过预约. 小姐姐确认之后往你的手机发了个验证码, 你把验证码告诉了前台小姐姐之后, 她给了你一张门禁卡, 于是你就可以开心地去见王总了.</p> <p>这个例子里面就有一次授权. 本来你是没有权限进入百度大楼的, 但是经过前台小姐姐一系列的验证之后, 她发现你确实是来拜访客户的, 于是给了你一张临时工牌. <strong>这整个过程就是授权</strong>.</p> <p>再举一个电商的场景. 假如你是一个卖家, 在京东商城开了一个店铺, 日常运营中你要将订单打印出来以便给用户发货. 但打印这事儿也挺繁琐的, 之前你总是手工操作, 后来发现有个叫&quot;小兔&quot;的第三方软件, 它可以帮你高效率地处理这事. 那小兔是怎么访问到这些订单数据的呢? 其实是这样, <strong>京东商城提供了开放平台, 小兔通过京东商家开放平台的 API 就能访问到用户的订单数据. 只要你在软件里点击同意, 小兔就可以拿到一个访问令牌, 通过访问令牌来获取到你的订单数据帮你干活儿了</strong>. 这里也是有一次授权. 你要是不同意, 平台肯定不敢把这些数据给到第三方软件.</p> <h5 id="_2-为什么用oauth-2-0"><a href="#_2-为什么用oauth-2-0" class="header-anchor">#</a> 2.为什么用OAuth 2.0</h5> <p>基于上面两种场景的解决方案, 关于授权<strong>最容易想到的方案就是提供钥匙</strong>. 比如, 你要去百度拜访王总, 那前台小姐姐就给你张百度的工牌; 小兔要获取你的订单信息, 那你就把你的用户名和密码给它. 但稍微有些安全意识, 都不会这样做.</p> <p>因为你有了百度工牌, 那以后都可以随时自由地进出了, 这显然不是百度想要的. 所以百度有一套完整的机制, 通过给你一张临时工牌, 实现在保证安全的情况下, 还能让你去大楼里面见到王总. 相应地, 小兔软件请求访问你的订单数据的过程, 也会涉及这样一套授权机制, 那<strong>就是 OAuth 2.0. 它通过给小兔软件一个访问令牌, 而不是让小兔软件拿着你的用户名和密码, 去获取你的订单数据帮你干活儿</strong>.</p> <p>在如今的互联网世界里用到 OAuth 2.0 的地方非常多, 只是因为它隐藏了实现细节, 需要我们多做分析才能发现它. 比如, <strong>当使用微信登录其他网站或者 App 的时候, 当开始使用某个小程序的时候, 都在无感知的情况下用到了 OAuth 2.0</strong>.</p> <p>那总结来说, <mark><strong>OAuth 2.0 这种授权协议, 就是保证第三方(软件)只有在获得授权之后, 才可以进一步访问授权者的数据</strong></mark>. 因此, 常常还会听到一种说法, OAuth 2.0 是一种安全协议. 其实这种说法也是正确的.</p> <p><strong>现在访问授权者的数据主要是通过 Web API, 所以凡是要保护这种对外的 API 时, 都需要这样授权的方式</strong>. 而 OAuth 2.0 的这种颁发访问令牌的机制, 是再合适不过的方法了. 同时, 这样的 Web API 还在持续增加, 所以 OAuth 2.0 是目前 Web 上重要的安全手段之一了.</p> <h5 id="_3-oauth-2-0是怎样运转的"><a href="#_3-oauth-2-0是怎样运转的" class="header-anchor">#</a> 3.OAuth 2.0是怎样运转的</h5> <p>这里还是来看上面提到的小兔打单软件的例子. 假如小明在京东上面开了一个店铺, 小明要管理他的店铺里面的订单, 于是选择了使用小兔软件.</p> <p>现在把&quot;小明&quot;, &quot;小兔软件&quot;, &quot;京东商家开放平台&quot; 放到一个对话里面, 看看他们是怎么沟通的.</p> <ul><li><strong>小明</strong>: 你好, 小兔软件. 我正在 Google 浏览器上面, 需要访问你来帮我处理我在京东商城店铺的订单.</li> <li><strong>小兔软件</strong>: 好的, 小明, 我需要你给我授权. 现在我把你引导到京东商家开放平台上, 你在那里给我授权吧.</li> <li><strong>京东商家开放平台</strong>: 你好, 小明. 我收到了小兔软件跳转过来的请求, 现在已经准备好了一个授权页面. 你登录并确认后, 点击授权页面上面的授权按钮即可.</li> <li><strong>小明</strong>: 好的, 京东商家开放平台. 我看到了这个授权页面, 已经点授权按钮啦😄</li> <li><strong>京东商家开放平台</strong>: 你好, 小兔打单软件. 我收到了小明的授权, 现在要给你生成一个授权码 code 值, 我通过浏览器重定向到你的回调 URL 地址上面了.</li> <li><strong>小兔软件</strong>: 好的, 京东商家开放平台. 我现在从浏览器上拿到了授权码, 现在就用这个授权码来请求你, 请给我一个访问令牌 access_token 吧.</li> <li><strong>京东商家开放平台</strong>: 好的, 小兔打单软件, 访问令牌已经发送给你了.</li> <li><strong>小兔打单软件</strong>: 太好了, 我现在就可以使用访问令牌来获取小明店铺的订单了.</li> <li><strong>小明</strong>: 我已经能够看到我的订单了, 现在就开始打单操作了.</li></ul> <p>下面再用一张图来描述整个过程:</p> <p><img src="/img/e0c79756feceac5b52794e3ea08f2440-20230729094013-9o4csg7.png" alt="" title="小明使用小兔软件打印订单的整体流程"></p> <p>再分析下这个流程, 不难发现小兔软件最终的目的, 是要获取一个叫做 &quot;<strong>访问令牌</strong>&quot; 的东西. 从最后一步也能够看出来, 在小兔软件获取到<strong>访问令牌</strong>之后, 才有足够的 &quot;能力&quot; 去请求小明的店铺的订单, 也就是才能够帮助小明打印订单.</p> <p>那么小兔软件是怎么获取访问令牌的值的呢? 可以发现还有一个叫做 &quot;<strong>授权码</strong>&quot; 的东西, 也就是说小兔软件是拿<mark><strong>授权码换取的访问令牌</strong></mark>.</p> <p>小兔软件又是怎么拿到<strong>授权码</strong>的呢? 从图中流程刚开始的那一步就会发现, 是在<strong>小明授权之后, 才产生的授权码</strong>, 上面流程中后续的一切动作, 实际上都是在小明对小兔软件授权发生以后才产生的. 其中主要的动作, 就是<mark><strong>生成授权码 -&gt; 生成访问令牌 -&gt; 使用访问令牌</strong></mark>.</p> <p><mark>其实 </mark>​<mark>**OAuth 2.0 授权的核心就是颁发访问令牌, 使用访问令牌, **</mark>​<mark>而且不管是哪种类型的授权流程都是这样</mark>. 要记住这句话, 它是整个流程的核心.</p> <p>在小兔软件这个例子中呢, <mark><strong>使用的就是授权码许可(Authorization Code)类型. 它是 OAuth 2.0 中最经典, 最完备, 最安全, 应用最广泛的许可类型</strong></mark>. 除了授权码许可类型外, OAuth 2.0 针对不同的使用场景, 还有 3 种基础的许可类型, 分别是<strong>隐式许可</strong>(Implicit), <strong>客户端凭据许可</strong>(Client Credentials), <strong>资源拥有者凭据许可</strong>(Resource Owner Password Credentials). 相对而言, 这 3 种授权许可类型的流程, 在流程复杂度和安全性上都有所减弱. 因此本课程会频繁用<strong>授权码许可类型</strong>来举例.</p> <h5 id="_4-总结"><a href="#_4-总结" class="header-anchor">#</a> 4.总结</h5> <p>总结来说, 需要记住以下这 3 个关键点:</p> <ul><li><strong>OAuth 2.0 的核心是授权许可, 更进一步说就是令牌机制</strong>. 也就是说, 像小兔软件这样的第三方软件只有拿到了京东商家开放平台颁发的访问令牌, 也就是得到了授权许可, 然后才可以<strong>代表</strong>用户访问他们的数据.</li> <li>互联网中所有的受保护资源, 几乎都是以 Web API 的形式来提供访问的, 比如 App 要获取用户的头像, 昵称, 小兔软件要获取用户的店铺订单, 因此 OAuth 2.0 与安全相关, 是用来保护 Web API 的. 另外, 第三方软件通过 OAuth 2.0 取得访问权限之后, 用户便把这些权限<strong>委托</strong>给了第三方软件, 因此说 OAuth 2.0 是一种委托协议, 也没问题.</li> <li>也正因为像小兔这样的第三方软件, 每次都是用访问令牌而不是用户名和密码来请求用户的数据, 才大大减少了安全风险上的攻击面. 不然, 如果每次都带着用户名和密码来访问数量众多的 Web API , 是不是增加了这个攻击面”? 因此,  <strong>OAuth 2.0 的核心, 就是颁发访问令牌和使用访问令牌</strong>.</li></ul> <h4 id="授权码许可类型中-为什么一定要有授权码🌟"><a href="#授权码许可类型中-为什么一定要有授权码🌟" class="header-anchor">#</a> 授权码许可类型中, 为什么一定要有授权码🌟</h4> <p>前一讲提到了 OAuth 2.0 的授权码许可类型, 在小兔打单软件的例子里面, 小兔最终是通过<strong>访问令牌</strong>请求到小明的店铺里的订单数据. 同时还提到了, 这个<strong>访问令牌是通过授权码换来的</strong>.</p> <p>到这里估计你会问了, 为什么要用授权码来换令牌? 为什么不能直接颁发访问令牌呢?</p> <h5 id="_1-为什么需要授权码"><a href="#_1-为什么需要授权码" class="header-anchor">#</a> 1.为什么需要授权码</h5> <p>在 OAuth 2.0 的体系里面有 <strong>4 种角色</strong>, 按照官方的称呼它们分别是<mark><strong>资源拥有者, 客户端, 授权服务和受保护资源</strong></mark>. 不过, 这里的<strong>客户端</strong>, 我更愿意称其为<strong>第三方软件</strong>, 而且本课程中都是以第三方软件在举例子. 所以后续的讲解中会统一把它称为<strong>第三方软件</strong>. 所以在看官方资料的时候, 可以自己对应下.</p> <p>还是拿小兔软件来举例子, 将官方的称呼转换一下, 对应关系就是:</p> <ul><li><mark><strong>资源拥有者: 小明</strong></mark></li> <li><mark><strong>第三方软件: 小兔软件</strong></mark></li> <li><mark><strong>授权服务: 京东商家开放平台的授权服务</strong></mark></li> <li><mark><strong>受保护资源: 小明店铺在京东上面的订单</strong></mark></li></ul> <p><strong>OAuth 诞生之初就是为了解决 Web 浏览器场景下的授权问题</strong>, 所以基于浏览器的场景, 在前面小明使用小兔软件打印订单的整体流程的基础上, 画了一个<strong>授权码许可类型</strong>的序列图.</p> <p>这次为了能够更好地表述授权码许可流程, 这里把小兔软件的前端和后端分开展示, 并把京东商家开放平台的系统按照 OAuth 2.0 的组件拆分成了<strong>授权服务和受保护资源服务</strong>. 如下图所示:</p> <p><img src="/img/af72a19755be9dae945f63b9793b4610-20230729094013-3l00xls.png" alt="" title="以小兔软件为例, 授权码许可类型的序列图"></p> <p>从图中看到, 在第 4 步<strong>授权服务生成了授权码 code</strong>, 按照一开始提出来的问题, 如果不要授权码, 这一步实际上就可以直接返回访问令牌 access_token 了.</p> <p>按着这个没有授权码的思路继续想, 如果这里直接返回访问令牌, 那肯定不能使用重定向的方式. 因为<strong>这样会把安全保密性要求极高的访问令牌暴露在浏览器上</strong>, 从而将会面临访问令牌失窃的安全风险. 显然这是不能被允许的.</p> <p>也就是说, <strong>如果没有授权码的话, 就只能把访问令牌发送给第三方软件小兔的后端服务</strong>. 按照这样的逻辑, 上面的流程图就会变成下面这样:</p> <p><img src="/img/11dbe0c38bb01e3af606c8a7f070054c-20230729094013-tq28m6a.png" alt="" title="如果没有授权码, 直接把访问令牌发送给第三方软件小兔的后端服务"></p> <p>到这里, 看起来天衣无缝. 小明访问小兔软件, 小兔软件说要打单你得给我授权, 不然京东不干, 然后小兔软件就引导小明跳转到了京东的授权服务. 到授权服务之后, 京东商家开放平台验证了小兔的合法性以及小明的登录状态后, 生成了授权页面. 紧接着, 小明赶紧点击同意授权, 这时候, 京东商家开放平台知道可以把小明的订单数据给小兔软件.</p> <p>于是, 京东商家开放平台没含糊, 赶紧生成访问令牌 access_token, 并且通过后端服务的方式返回给了小兔软件. 这时候, 小兔软件就能正常工作了.</p> <p>但这样问题就来了, 什么问题呢?</p> <p><mark><strong>当小明被浏览器重定向到授权服务上之后, 小明跟小兔软件之间的 &quot;连接&quot; 就断了, 相当于此时此刻小明跟授权服务建立了 &quot;连接&quot; 后, 将一直 &quot;停留在授权服务的页面上&quot;</strong></mark> . 可以**看到图 2 中问号处的时序上, 小明再也没有重新 &quot;连接&quot; 到小兔软件. **</p> <p>但是这个时候<strong>小兔软件已经拿到了小明授权之后的访问令牌, 也使用访问令牌获取到了小明店铺里的订单数据</strong>. 这时, 考虑&quot;小明的感受&quot;, 小兔软件应该要<strong>通知</strong>到小明, 但是如何做呢? 现在&quot;连接断了&quot;, 这事儿恐怕就没那么容易了.</p> <p>所以为了让小兔软件能很容易地通知到小明, <strong>还必须让小明跟小兔软件重新建立起 &quot;连接&quot;</strong> . 这就是前面看到的第二次重定向, <mark><strong>小明授权之后, 又重新重定向回到了小兔软件的地址</strong></mark>上, 这样<strong>小明就跟小兔软件有了新的 &quot;连接&quot;</strong> .</p> <p>到这里, 就能理解在授权码许可的流程中, 为什么需要两次重定向了吧.</p> <p><mark><strong>为了重新建立起这样的一次连接, 又不能让访问令牌暴露出去, 就有了这样一个临时的, 间接的凭证: 授权码</strong></mark>. 因为小兔软件最终要拿到的是安全保密性要求极高的访问令牌, 并不是授权码, 而<mark><strong>授权码是可以暴露在浏览器上面的</strong></mark>. 这样有了授权码的参与, 访问令牌可以在后端服务之间传输, 同时还可以重新建立小明与小兔软件之间的&quot;连接&quot;. 这样通过一个授权码, 既照顾到了小明的体验, 又照顾了通信的安全.</p> <p>这就是为什么要有授权码的原因.</p> <p>那在执行授权码流程的时候, 授权码和访问令牌在小兔软件和授权服务之间到底是怎么流转的呢? 要回答这个问题, 就需要继续分析一下<strong>授权码许可类型的通信过程</strong>了.</p> <h5 id="_2-授权码许可类型的通信过程"><a href="#_2-授权码许可类型的通信过程" class="header-anchor">#</a> 2.授权码许可类型的通信过程</h5> <p>前面的通信过程中标识出来的步骤就有 9 个, 一步步地去分析看似会很复杂, 所以这里用另一个维度来分析以便于理解, 也就是<strong>从直接通信和间接通信</strong>的维度来分析. <mark><strong>这里所谓的间接通信就是指获取授权码的交互, 而直接通信就是指通过授权码换取访问令牌的交互</strong></mark>.</p> <p>接下来就一起分析下, 看看哪些是间接通信, 哪些是直接通信.</p> <h6 id="_1-间接通信"><a href="#_1-间接通信" class="header-anchor">#</a> (1)间接通信</h6> <p>先分析下为什么是&quot;间接&quot;.</p> <p>把图 1 中获取授权码 code 的流程细化, 并换个角度来看一看, 也就是将<strong>浏览器</strong>这个代理放到第三方软件小兔和授权服务中间. 于是有下面这张流程图:</p> <p><img src="/img/81c35e80d035b0e93018b56fe91da41b-20230729094013-b7wb9uq.png" alt="" title="获取授权码的交互过程"></p> <p>这个过程, 仿佛有这样的一段对话.</p> <ul><li>小明: 你好, 小兔软件, 我要访问你了.</li> <li>小兔软件: 好的, 我把你引到授权服务那里, 我需要授权服务给我一个授权码.</li> <li>授权服务: 小兔软件, <strong>我把授权码发给浏览器了</strong>.</li> <li>小兔软件: 好的, 我从浏览器拿到了授权码.</li></ul> <p>可以看到, 第三方软件小兔和授权服务之间, 并没有发生直接的通信, 而是<strong>通过浏览器这个&quot;中间人&quot; 来 &quot;搭线&quot; 的</strong>. 因此, 可以说这是一个间接通信的方式.</p> <h6 id="_2-直接通信"><a href="#_2-直接通信" class="header-anchor">#</a> (2)直接通信</h6> <p>再分析下, 授权码换取访问令牌的交互, 为什么是&quot;直接&quot;的. 再把前面图中获取访问令牌的流程细化, 就得到了下面的图示:</p> <p><img src="/img/15fc1bbe4c69630141be2a5d0394b7a6-20230729094013-yyyuukz.png" alt="" title="授权码换取访问令牌的交互过程"></p> <p>相比获取授权码过程的间接通信, 获取访问令牌的直接通信就比较容易理解了, 就是<mark><strong>第三方软件小兔获取到授权码 code 值后, 向授权服务发起获取访问令牌 access_token 的通信请求. 这个请求是第三方软件服务器跟授权服务的服务器之间的通信, 都是在后端服务器之间的请求和响应, 因此也叫作后端通信</strong></mark>.</p> <h6 id="_3-两个-一伙"><a href="#_3-两个-一伙" class="header-anchor">#</a> (3)两个&quot;一伙&quot;</h6> <p>了解了上面的通信方式之后, 可以看到 OAuth 2.0 中的 4 个角色是 &quot;两两站队&quot; 的: <mark><strong>资源拥有者和第三方软件&quot;站在一起&quot;, 因为第三方软件要代表资源拥有者去访问受保护资源; 授权服务和受保护资源&quot;站在一起&quot;, 因为授权服务负责颁发访问令牌, 受保护资源负责接收并验证访问令牌</strong></mark>.</p> <p><img src="/img/ff47ce9c357c6b5259cfc893fba9b7c4-20230729094013-9sszdik.png" alt="" title="OAuth 2.0 中的4个角色是&quot;两两站队&quot;"></p> <h5 id="_3-一定要有浏览器吗"><a href="#_3-一定要有浏览器吗" class="header-anchor">#</a> 3.一定要有浏览器吗?</h5> <p>前面介绍授权码流程的时候都是以浏览器参与的场景来讲的, 那么浏览器一定要参与到这个流程中吗? 其实, <strong>授权码许可流程, 不一定要有浏览器的参与</strong>. 接下来就继续分析下其中的逻辑.</p> <p>OAuth 2.0 发展之初, 开放生态环境相对单薄, 以浏览器为代理的 Web 应用居多, 授权码许可类型 &quot;理所当然&quot; 地被应用到了通过浏览器才能访问的 Web 应用中.</p> <p>但实际上, <mark><strong>OAuth 2.0 是一个授权理念, 或者说是一种授权思维</strong></mark>. 它的授权码模式的思维可以移植到很多场景中, 比如微信小程序. 在开发微信小程序应用时, 通过授权码模式获取用户登录信息, 官方文档的地址示例中给出的 <strong>grant_type=authorization_code</strong>, 就<strong>没有</strong>用到浏览器.</p> <p>根据微信官方文档描述, <strong>开发者获取用户登录态信息的过程正是一个授权码的许可流程</strong>:</p> <ol><li>首先, 开发者通过 wx.login(Object object) 方法<strong>获取到登录凭证 code 值</strong>, 这一步的流程是在<strong>小程序内部通过调用微信提供的 SDK 实现</strong>;</li> <li>然后, <strong>再通过该 code 值换取用户的 session_key 等信息</strong>, 也就是官方文档的 auth.code2Session() 方法, 同时<strong>该方法也是被强烈建议通过开发者的后端服务来调用</strong>的.</li></ol> <p>可以看到, <strong>这个过程并没有使用到浏览器, 但确实按照授权码许可的思想走了一个完整的授权码许可流程</strong>. 也就是说, <mark><strong>先通过小程序前端获取到 code 值, 再通过小程序的后端服务使用 code 值换取 session_key 等信息, 只不过是访问令牌 access_token 的值被换成了 session_key</strong></mark>.</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>GET https://api.weixin.qq.com/sns/jscode2session?appid<span class="token operator">=</span>APPID<span class="token operator">&amp;</span><span class="token assign-left variable">secret</span><span class="token operator">=</span>SECRET<span class="token operator">&amp;</span><span class="token assign-left variable">js_code</span><span class="token operator">=</span>JSCODE<span class="token operator">&amp;</span><span class="token assign-left variable">grant_type</span><span class="token operator">=</span>authorization_code
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>这整个过程体现的就是授权码许可流程的思想.</p> <h5 id="_4-总结-2"><a href="#_4-总结-2" class="header-anchor">#</a> 4.总结</h5> <p>本节从为什么需要授权码这个问题开始讲起, 并通过授权码把授权码许可流程整体的通信过程串了一遍, 提到了授权码这种方式解决的问题, 也提到了授权码流程的通信方式. 需要你记住以下两点.</p> <ul><li><strong>授权码许可流程有两种通信方式</strong>. 一种是前端通信, 因为它通过浏览器促成了授权码的交互流程, 比如京东商家开放平台的授权服务生成授权码发送到浏览器, 第三方软件小兔从浏览器获取授权码. <strong>正因为获取授权码的时候小兔软件和授权服务并没有发生直接的联系, 也叫做间接通信</strong>. 另外一种是后端通信, 在小兔软件获取到授权码之后, <strong>在后端服务直接发起换取访问令牌的请求, 也叫做直接通信.</strong></li> <li>在 OAuth 2.0 中, <strong>访问令牌被要求有极高的安全保密性</strong>, 因此不能让它暴露在浏览器上面, 只能通过第三方软件(比如小兔)的后端服务来获取和使用, 以最大限度地保障访问令牌的安全性. 正因为访问令牌的这种安全要求特性, 当需要前端通信, 比如浏览器上面的流转的时候, OAuth 2.0 才又提供了一个<mark><strong>临时的凭证: 授权码</strong></mark>. <strong>通过授权码的方式, 可以让用户小明在授权服务上给小兔授权之后, 还能重新回到小兔的操作页面上</strong>. 这样在保障安全性的情况下, 提升了小明在小兔上的体验.</li></ul> <p>从授权码许可流程中就可以看出来, 它完美地将 OAuth 2.0 的 4 个角色组织了起来, 并保证了它们之间的顺畅通信. <mark><strong>它提出的这种结构和思想都可以被迁移到其他环境或者协议上, 比如在微信小程序中使用授权码许可</strong></mark>​ **. **</p> <p>不过, 也正是因为有了授权码的参与, 才使得授权码许可要比其他授权许可类型, 在授权的流程上多出了好多步骤, <mark><strong>让授权码许可类型成为了 OAuth 2.0 体系中迄今流程最完备, 安全性最高的授权流程</strong></mark>. 在接下来的两讲还会重点讲解授权码许可类型下的授权服务.</p> <h4 id="授权服务-授权码和访问令牌的颁发流程是怎样的-🌟"><a href="#授权服务-授权码和访问令牌的颁发流程是怎样的-🌟" class="header-anchor">#</a> 授权服务-授权码和访问令牌的颁发流程是怎样的?🌟</h4> <p>接下来的三讲会着重讲解关于<strong>授权服务的工作流程</strong>, 授权过程中的令牌, 以及如何接入 OAuth 2.0. 这样一来就可以吃透授权码许可这一最经典, 最完备, 最常用的授权流程了, 以后再处理授权相关的逻辑就更得心应手了.</p> <p>在介绍授权码许可类型时, 提到了很多次 &quot;授权服务&quot;. 一句话概括, <mark><strong>授权服务就是负责颁发访问令牌的服务. 更进一步地讲, OAuth 2.0 的核心是授权服务, 而授权服务的核心就是令牌</strong></mark>.</p> <p>为什么这么说呢? 当第三方软件比如小兔, 要想获取小明在京东店铺的订单, 就必须先从京东商家开放平台的授权服务那里获取访问令牌, 进而通过访问令牌来 &quot;<strong>代表</strong>&quot; 小明去请求小明的订单数据. 这不恰恰就是整个 OAuth 2.0 授权体系的核心吗?</p> <p>那么, <strong>授权服务到底是怎么生成访问令牌</strong>的, 这其中包含了哪些操作呢? 还有一个问题是, 访问令牌过期了而用户又不在场的情况下, 又<strong>如何重新生成访问令牌</strong>呢?</p> <p>带着这两个问题, 就以授权码许可类型为例, 一起深入探索下授权服务这个核心组件吧.</p> <h5 id="_1-授权服务的工作过程"><a href="#_1-授权服务的工作过程" class="header-anchor">#</a> 1.授权服务的工作过程</h5> <p>开始之前先回想下小明给小兔软件授权订单数据的整个流程.</p> <p>小兔软件先要让小明去京东商家开放平台那里给它授权数据, 那这里是不是你觉得很奇怪? 你总不能说, &quot;嘿, 京东, 你把数据给小兔用吧&quot;, 那京东肯定会回复说, &quot;小明, 小兔是谁啊, 没在咱家备过案, 我不能给他, 万一是骗子呢?&quot;, 所以授权的<strong>第一步得确保被授权的第三方是合法的</strong>.</p> <p><mark><strong>所以, 授权这个大动作的前提, 肯定是小兔要去开放平台那里&quot;备案&quot;, 也就是注册. 注册完后, 京东才知道小兔是谁. 京东商家开放平台就会给小兔软件 app_id 和 app_secret 等信息, 以方便后面授权时的各种身份校验.</strong></mark></p> <p>同时, 注册的时候, <mark><strong>第三方软件也会请求受保护资源的可访问范围</strong></mark>. 比如, 小兔能否获取小明店铺 3 个月以前的订单, 能否获取每条订单的所有字段信息等等. <mark><strong>这个权限范围, 就是 scope</strong></mark>. 后面还会详细讲述范围控制.</p> <p>关于注册后的数据存储, 使用如下 Java 代码来模拟:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">//模拟第三方软件注册之后的数据库存储</span>
<span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> appMap <span class="token operator">=</span>  <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

appMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;app_id&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;APPID_RABBIT&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
appMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;app_secret&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;APPSECRET_RABBIT&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
appMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;redirect_uri&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;http://localhost:8080/AppServlet-ch03&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
appMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;scope&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;nickname address pic&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>备完案之后, 接着继续前进. 小明过来让平台把他的订单数据给小兔, 平台咔咔一查, 对了下暗号, <strong>发现小兔是合法的</strong>, 于是就要推进下一步了.</p> <p>前面讲过, 在授权码许可类型中, <mark><strong>授权服务的工作, 可以划分为两大部分, 一个是颁发授权码 code, 一个是颁发访问令牌 access_token</strong></mark>. 为了更能表达授权码和访问令牌的存在, 这里在图中用深色将其标注了出来:</p> <p><img src="/img/35d4f9a24a9243bc22b912b5a9890987-20230729094013-5o25q4a.png" alt=""></p> <p>先看看颁发授权码 code 的流程.</p> <h6 id="_1-过程一-颁发授权码code"><a href="#_1-过程一-颁发授权码code" class="header-anchor">#</a> (1)过程一:颁发授权码code</h6> <p>在这个过程中, 授权服务需要完成两部分工作, 分别是<strong>准备工作</strong>和<strong>生成授权码 code</strong>.</p> <p>这个&quot;准备&quot;都包括哪些工作? 可以想到, 小明在给第三方软件小兔打单软件进行授权的时候, 会看到<strong>授权页面上有一个授权按钮, 但是授权服务在小明看到这个授权按钮之前, 实际上已经做了一系列动作</strong>.</p> <p>这些动作, 就是<strong>所谓的</strong>​<mark><strong>准备工作, 包括验证基本信息, 验证权限范围(第一次)和生成授权请求页面</strong></mark>这三步. 下面具体分析下.</p> <blockquote><p>第一步, 验证基本信息.</p></blockquote> <p>**验证基本信息, 包括对第三方软件小兔合法性和回调地址合法性的校验. **</p> <p>在 Web 浏览器环境下, 颁发 code 的整个请求过程, 都是<strong>浏览器通过前端通信来完成</strong>, 这就意味着所有信息都有被冒充的风险. 因此, <strong>授权服务必须对第三方软件的存在性做判断</strong>.</p> <p>同样, <strong>回调地址也是可以被伪造</strong>的. 比如, 不法分子将其伪装成钓鱼页面, 或者是带有恶意攻击性的软件下载页面. 因此从安全上考虑, <strong>授权服务需要对回调地址做基本的校验</strong>.</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>appMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;redirect_uri&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>redirectUri<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 回调地址不存在</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>在授权服务的程序中, 这两步验证通过后, 就会生成或者响应一个页面(<strong>属于授权服务器上的页面</strong>), 以提示小明进行授权.</p> <blockquote><p>第二步, 验证权限范围(第一次).</p></blockquote> <p>既然是<strong>授权, 就会涉及范围</strong>. 比如, 使用微信登录第三方软件的时候, 会看到微信提示我们, 第三方软件可以获得你的昵称, 头像, 性别, 地理位置等. 如果不想让第三方软件获取你的某个信息, 那么可以不选择这一项. 同样在小兔中也是一样, 当小明为小兔进行授权的时候, 也可以选择给小兔的<strong>权限范围</strong>, 比如是否授予小兔获取 3 个月以前的订单的访问权限.</p> <p>这就意味着, 需要对小兔传过来的 <strong>scope 参数, 与小兔注册时申请的权限范围做比对</strong>. 如果请求过来的权限范围大于注册时的范围, 就需要作出越权提示. **记住, 此刻是第一次权限校验. **</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">String</span> scope <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span><span class="token string">&quot;scope&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">checkScope</span><span class="token punctuation">(</span>scope<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">// 超出注册的权限范围</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><blockquote><p>第三步, 生成授权请求页面.</p></blockquote> <p>这个授权请求页面就是<mark><strong>授权服务</strong></mark>​<mark>上的页面</mark>, 这里可以<mark><strong>理解为重定向到了授权服务官方的授权页面, 比如是跳转到了京东授权服务的页面, 注意这个页面通常需要提前登录京东账号, 不然会要求先登录</strong></mark>. 如下图所示:</p> <p><img src="/img/8fc31128f7f7884e25f7e54920fdd3af-20230729094013-fn8j5f5.png" alt=""></p> <p>页面上显示了小兔注册时申请的 today, history 两种权限, 小明可以选择缩小这个权限范围, 比如仅授予获取 today 信息的权限.</p> <p>至此, 颁发授权码 code 的准备工作就完成了. 需要注意这里一直强调说这也是准备工作, 因为当用户点击授权按钮 &quot;approve&quot; 后, 才会<strong>生成授权码 code 值和访问令牌 acces_token 值</strong>, &quot;一切才真正开始&quot;.</p> <p>这里需要说明下: 在上面的准备过程中, <mark><strong>忽略了小明登录的过程, 但只有用户登录了才可以对第三方软件进行授权, 授权服务才能够获得用户信息并最终生成 code 和 app_id(第三方软件的应用标识) + user(资源拥有者标识)之间的对应关系</strong></mark>.</p> <p>小明点击 &quot;approve&quot; 按钮之后, 生成授权码 code 的流程就正式开始了, 主要包括<mark><strong>验证权限范围(第二次), 处理授权请求生成授权码 code 和重定向至第三方软件这三大步</strong></mark>. 接下来, 一起分析下这三步.</p> <blockquote><p>第四步, 验证权限范围(第二次).</p></blockquote> <p>在步骤二中, 生成授权页面之前授权服务进行的第一次校验, 是对比小兔请求过来的权限范围 scope 和注册时的权限做的比对. 这里的第二次验证权限范围, <strong>是用小明进行授权之后的权限, 再次与小兔软件注册的权限做校验</strong>.</p> <p>那这里为什么又要校验一次呢? 因为这相当于一次用户的<strong>输入权限</strong>. 小明选择了一定的权限范围给到授权服务, 对于权限的校验要重视对待, 凡是输入性数据都会涉及到合法性检查. 另外, 这也是要求养成一种<strong>在服务端对输入数据的请求, 都尽可能做一次合法性校验的好习惯</strong>.</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> rscope <span class="token operator">=</span>request<span class="token punctuation">.</span><span class="token function">getParameterValues</span><span class="token punctuation">(</span><span class="token string">&quot;rscope&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">checkScope</span><span class="token punctuation">(</span>rscope<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">// 超出注册的权限范围</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><blockquote><p>第五步, 处理授权请求, 生成授权码 code.</p></blockquote> <p>当小明同意授权之后, <strong>授权服务会校验响应类型 response_type 的值</strong>. <strong>response_type 有 code 和 token 两种类型的值</strong>. 在这里, 是用授权码流程来举例的, 因此代码要验证 response_type 的值是否为 code.</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">String</span> responseType <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span><span class="token string">&quot;response_type&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token string">&quot;code&quot;</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>responseType<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p><mark><strong>在授权服务中, 需要将生成的授权码 code 值与 app_id, user 进行关系映射</strong></mark>. 也就是说, 一个授权码 code, 表示某一个用户给某一个第三方软件进行授权, 比如小明给小兔软件进行的授权. <mark><strong>同时需要将 code 值和这种映射关系保存起来, 以便在生成访问令牌 access_token 时使用</strong></mark>.</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// 模拟登录用户为USERTEST</span>
<span class="token class-name">String</span> code <span class="token operator">=</span> <span class="token function">generateCode</span><span class="token punctuation">(</span>appId<span class="token punctuation">,</span> <span class="token string">&quot;USERTEST&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">private</span> <span class="token class-name">String</span> <span class="token function">generateCode</span><span class="token punctuation">(</span><span class="token class-name">String</span> appId<span class="token punctuation">,</span> <span class="token class-name">String</span> user<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
    <span class="token class-name">String</span> code <span class="token operator">=</span> strb<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    codeMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>code<span class="token punctuation">,</span> appId <span class="token operator">+</span> <span class="token string">&quot;|&quot;</span> <span class="token operator">+</span> user <span class="token operator">+</span> <span class="token string">&quot;|&quot;</span> <span class="token operator">+</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> code<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>在生成了授权码 code 之后, 也按照上面所述绑定了响应的映射关系. 之前讲到<strong>授权码是临时的一次性凭证</strong>. 因此, 还需要为 code 设置一个<strong>有效期</strong>.</p> <p>OAuth 2.0 规范建议授权码 code 值有效期为 10 分钟, 并且<mark><strong>一个授权码 code 只能被使用一次</strong></mark>. 不过根据经验呢, 在生产环境中 code 的有效期一般不会超过 5 分钟. 关于授权码 code 相关的安全方面的内容, 后面还会详细讲述.</p> <p>同时, 授权服务还需要<strong>将生成的授权码 code 跟已经授权的权限范围 rscope 进行绑定并存储</strong>, 以便后续颁发访问令牌时, 能够通过 code 值取出授权范围并与访问令牌绑定. 因为第三方软件最终是通过访问令牌来请求受保护资源的.</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">Map</span><span class="token operator">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;</span> codeScopeMap <span class="token operator">=</span>  <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token operator">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 授权范围与授权码做绑定</span>
codeScopeMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>code<span class="token punctuation">,</span>rscope<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><blockquote><p>第六步, 重定向至第三方软件.</p></blockquote> <p><strong>生成授权码 code 值之后, 授权服务需要将该 code 值告知第三方软件小兔</strong>. 前面提到, 颁发授权码 code 是通过<strong>前端通信</strong>完成的, 因此这里采用<strong>重定向</strong>的方式. 这一步的重定向, 也是上一节提到的<strong>第二次重定向</strong>.</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> params <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
params<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;code&quot;</span><span class="token punctuation">,</span> code<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 构造第三方软件的回调地址, 并重定向到该地址</span>
<span class="token class-name">String</span> toAppUrl <span class="token operator">=</span> <span class="token class-name">URLParamsUtil</span><span class="token punctuation">.</span><span class="token function">appendParams</span><span class="token punctuation">(</span>redirectUri<span class="token punctuation">,</span> params<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 授权码流程的第二次重定向</span>
response<span class="token punctuation">.</span><span class="token function">sendRedirect</span><span class="token punctuation">(</span>toAppUrl<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>到此, <strong>颁发授权码 code 的流程全部完成</strong>. 当小兔获取到授权码 code 值以后, 就可以开始请求访问令牌 access_token 的值了, 也就是即将开始的过程二.</p> <h6 id="_2-过程二-颁发访问令牌access-token"><a href="#_2-过程二-颁发访问令牌access-token" class="header-anchor">#</a> (2)过程二: 颁发访问令牌access_token</h6> <p>前面在过程一中介绍了授权码 code 的生成流程, 但小兔最终是要获取到访问令牌 access_token, 才可以去请求受保护资源. 而<strong>授权码只是一个换取访问令牌 access_token 的临时凭证</strong>.</p> <p>当小兔拿着授权码 code 来请求的时候, 授权服务需要为之生成最终的请求访问令牌. <mark><strong>这个过程主要包括验证第三方软件小兔是否存在, 验证 code 值是否合法和生成 access_token 值这三大步</strong></mark>. 接下来一起分析下每一步.</p> <blockquote><p>第一步, 验证第三方软件是否存在.</p></blockquote> <p>此时, 接收到的 grant_type 的类型为 <strong>authorization_code</strong>.</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">String</span> grantType <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span><span class="token string">&quot;grant_type&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token string">&quot;authorization_code&quot;</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>grantType<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>由于颁发访问令牌是通过<strong>后端通信</strong>完成的, 所以这里除了要<strong>校验 app_id 外, 还要校验 app_secret</strong>.</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>appMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;app_id&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>appId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">// app_id不存在</span>
<span class="token punctuation">}</span>

<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>appMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;app_secret&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>appSecret<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">// app_secret不合法</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><blockquote><p>第二步, 验证授权码 code 值是否合法.</p></blockquote> <p>授权服务在颁发授权码 code 的阶段已经将 <strong>code 值存储</strong>了起来, 此时对比从 request 中接收到的 code 值和从存储中取出来的 code 值. 本示例中, code 值对应的 key 是 app_id 和 user 的组合值.</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">String</span> code <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span><span class="token string">&quot;code&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 验证code值</span>
<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isExistCode</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">// code不存在</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// 授权码一旦被使用, 须立即作废</span>
codeMap<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>这里一定要记住, <mark><strong>确认过授权码 code 值有效以后, 应该立刻从存储中删除当前的 code 值</strong></mark>, 以防止第三方软件恶意使用一个失窃的授权码 code 值来请求授权服务.</p> <blockquote><p>第三步, 生成访问令牌 access_token 值.</p></blockquote> <p>关于按照什么规则来生成访问令牌 access_token 的值, OAuth 2.0 规范中并没有明确规定, 但必须符合三个原则: <mark><strong>唯一性, 不连续性, 不可猜性</strong></mark>. 本示例是使用 UUID 来作为 access_token 的.</p> <p>和授权码 code 值一样, <strong>需要将访问令牌 access_token 值存储起来, 并将其与第三方软件的应用标识 app_id 和资源拥有者标识 user 进行关系映射</strong>. 也就是说, <mark><strong>一个访问令牌 access_token 表示某一个用户给某一个第三方软件进行授权</strong></mark>.</p> <p>同时, <mark><strong>授权服务还需要将授权范围跟访问令牌 access_token 做绑定</strong></mark>. 最后, 还需要为该访问令牌设置一个过期时间 expires_in, 比如 1 天.</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">Map</span><span class="token operator">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;</span> tokenScopeMap <span class="token operator">=</span>  <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token operator">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 生成访问令牌access_token的值</span>
<span class="token class-name">String</span> accessToken <span class="token operator">=</span> <span class="token function">generateAccessToken</span><span class="token punctuation">(</span>appId<span class="token punctuation">,</span> <span class="token string">&quot;USERTEST&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 授权范围与访问令牌绑定</span>
tokenScopeMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>accessToken<span class="token punctuation">,</span>codeScopeMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 生成访问令牌的方法</span>
<span class="token keyword">private</span> <span class="token class-name">String</span> <span class="token function">generateAccessToken</span><span class="token punctuation">(</span><span class="token class-name">String</span> appId<span class="token punctuation">,</span> <span class="token class-name">String</span> user<span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token class-name">String</span> accessToken <span class="token operator">=</span> <span class="token constant">UUID</span><span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> expires_in <span class="token operator">=</span> <span class="token string">&quot;1&quot;</span><span class="token punctuation">;</span><span class="token comment">// 1天时间过期</span>
    tokenMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>accessToken<span class="token punctuation">,</span> appId <span class="token operator">+</span> <span class="token string">&quot;|&quot;</span> <span class="token operator">+</span> user <span class="token operator">+</span> <span class="token string">&quot;|&quot;</span> <span class="token operator">+</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;|&quot;</span> <span class="token operator">+</span> expires_in<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> accessToken<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>正因为 OAuth 2.0 规范没有约束访问令牌内容的生成规则, 所以有更高的自由度. 既可以像 Demo 中那样生成一个 UUID 形式的数据存储起来, 让授权服务和受保护资源共享该数据; 也可以将一些必要的信息通过结构化的处理放入令牌本身. <mark><strong>将包含了一些信息的令牌, 称为结构化令牌, 简称 JWT</strong></mark>.</p> <p>至此, 授权码许可类型下授权服务的两大主要过程, 也就是<strong>颁发授权码和颁发访问令牌</strong>的流程, 就讲完了.</p> <p>接下来, 在阅读别人的授权流程代码, 或者是使用诸如通过微信登录的第三方软件的时候, 就会明白背后的原理了. 同时, 在自己搭建一个授权服务流程时, 也会更加得心应手. <strong>这一切的原因, 都在于颁发授权码和颁发访问令牌, 就是授权服务的核心</strong>.</p> <h5 id="_2-刷新令牌"><a href="#_2-刷新令牌" class="header-anchor">#</a> 2.刷新令牌</h5> <p>到这里, 应该还会注意到一个问题, 在生成访问令牌的时候, 还给它附加了一个过期时间 expires_in, 这意味着访问令牌会在一定的时间后失效. <strong>访问令牌失效, 就意味着资源拥有者给第三方软件的授权失效了</strong>, 第三方软件无法继续访问资源拥有者的受保护资源了.</p> <p>这时, 如果还想继续使用第三方软件, 就只能<strong>重新点击授权按钮</strong>, 比如小明给小兔软件授权以后, 正在愉快地处理他店铺的订单数据, 结果没过多久, 突然间小兔软件再次让小明进行授权. 此刻, 可以替小明感受一下他的心情.</p> <p>显然, 这样的用户体验非常糟糕. 为此, <strong>OAuth 2.0 中引入了刷新令牌的概念, 也就是刷新访问令牌 access_token 的值</strong>. 这就意味着, 有了刷新令牌, 用户在一定期限内无需重新点击授权按钮, 就可以继续使用第三方软件.</p> <p>接下来看看刷新令牌的工作原理.</p> <p><strong>刷新令牌也是给第三方软件使用</strong>的, 同样需要遵循<strong>先颁发再使用</strong>的原则. 因此还是从<strong>颁发和使用两个环节</strong>来学习刷新令牌. 不过, 这个颁发和使用流程和访问令牌有些是相同的, 这里只讲述其中的区别.</p> <h6 id="_1-颁发刷新令牌"><a href="#_1-颁发刷新令牌" class="header-anchor">#</a> (1)颁发刷新令牌</h6> <p>下面看看刷新令牌是如何颁发的.</p> <p>其实, <strong>颁发刷新令牌和颁发访问令牌是一起实现的</strong>, 都是在过程二的步骤三生成访问令牌 access_token 中生成的. 也就是说, <strong>第三方软件得到一个访问令牌的同时, 也会得到一个刷新令牌</strong>:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> refreshTokenMap <span class="token operator">=</span>  <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 生成刷新令牌refresh_token的值</span>
<span class="token class-name">String</span> refreshToken <span class="token operator">=</span> <span class="token function">generateRefreshToken</span><span class="token punctuation">(</span>appId<span class="token punctuation">,</span> <span class="token string">&quot;USERTEST&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">private</span> <span class="token class-name">String</span> <span class="token function">generateRefreshToken</span><span class="token punctuation">(</span><span class="token class-name">String</span> appId<span class="token punctuation">,</span> <span class="token class-name">String</span> user<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">String</span> refreshToken <span class="token operator">=</span> <span class="token constant">UUID</span><span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    refreshTokenMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>refreshToken<span class="token punctuation">,</span> appId <span class="token operator">+</span> <span class="token string">&quot;|&quot;</span> <span class="token operator">+</span> user <span class="token operator">+</span> <span class="token string">&quot;|&quot;</span> <span class="token operator">+</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> refreshToken<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p><strong>为什么要一起生成访问令牌和刷新令牌呢?</strong></p> <p>其实, 这就回到了刷新令牌的作用上了. 刷新令牌存在的初衷是, 在访问令牌失效的情况下, 为了不让用户频繁手动授权, 用来通过系统重新请求<strong>生成一个新的访问令牌</strong>. 那么, <mark><strong>如果访问令牌失效了, 而&quot;身边&quot;又没有一个刷新令牌可用, 岂不是又要麻烦用户进行手动授权了. 所以, 它必须得和访问令牌一起生成</strong></mark>.</p> <p>到这里, 就解决了刷新令牌的<strong>颁发问题</strong>.</p> <h6 id="_2-使用刷新令牌"><a href="#_2-使用刷新令牌" class="header-anchor">#</a> (2)使用刷新令牌</h6> <p>说到刷新令牌的使用, 需要先明白一点. 在 OAuth 2.0 规范中, <strong>刷新令牌是一种特殊的授权许可类型, 是嵌入在授权码许可类型下的一种特殊许可类型</strong>. 在授权服务的代码里, 当接收到这种授权许可请求的时候, 会<strong>先比较 grant_type 和 refresh_token 的值</strong>, 然后做下一步处理.</p> <p>这其中的流程主要包括如下两大步骤.</p> <blockquote><p>第一步, 接收刷新令牌请求, 验证基本信息.</p></blockquote> <p>此时请求中的 grant_type 值为 refresh_token.</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">String</span> grantType <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span><span class="token string">&quot;grant_type&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token string">&quot;refresh_token&quot;</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>grantType<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>和颁发访问令牌前的验证流程一样, 这里也需要验证第三方软件是否存在. 需要注意的是, 这里<strong>需要同时验证刷新令牌是否存在, 目的就是要保证传过来的刷新令牌的合法性</strong>.</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">String</span> refresh_token <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span><span class="token string">&quot;refresh_token&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>refreshTokenMap<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>refresh_token<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">// 该refresh_token值不存在</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>另外, 还需要验证刷新令牌是否属于该第三方软件. 授权服务是将颁发的刷新令牌与第三方软件, 当时的授权用户绑定在一起的, 因此这里需要判断该刷新令牌的归属合法性.</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">String</span> appStr <span class="token operator">=</span> refreshTokenMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;refresh_token&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>appStr<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span>appId<span class="token operator">+</span><span class="token string">&quot;|&quot;</span><span class="token operator">+</span><span class="token string">&quot;USERTEST&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">// 该refresh_token值不是颁发给该第三方软件的</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p><mark>**需要注意, 一个刷新令牌被使用以后, 授权服务需要将其废弃, 并重新颁发一个刷新令牌. **</mark></p> <blockquote><p>第二步, 重新生成访问令牌.</p></blockquote> <p>生成访问令牌的处理流程, 与颁发访问令牌环节的生成流程是一致的. 授权服务会将新的访问令牌和新的刷新令牌, 一起返回给第三方软件. 这里就不再赘述了.</p> <h5 id="_3-总结"><a href="#_3-总结" class="header-anchor">#</a> 3.总结</h5> <p>本节讲了授权码许可类型下授权服务的工作原理. 授权服务可以说是整个 OAuth 2.0 体系中的 &quot;灵魂&quot; 组件, 任何一种许可类型都离不开它的支持, 它也是最复杂的组件.</p> <p>这是因为它将复杂性尽可能地揽在了自己身上, 才使得诸如小兔这样的第三方软件接入 OAuth 2.0 的时候更加便捷. 那关于如何快速地接入 OAuth 2.0, 后面会详细展开.</p> <p>总结本节需要记住以下 3 点.</p> <ul><li>授权服务的核心就是, <strong>先颁发授权码 code 值, 再颁发访问令牌 access_token 值</strong>.</li> <li>在颁发访问令牌的<strong>同时还会颁发刷新令牌 refresh_token 值, 这种机制可以在无须用户参与的情况下用于生成新的访问令牌</strong>. 正如小明使用小兔软件的例子, 当访问令牌过期的时候, 刷新令牌的存在可以大大提高小明使用小兔软件的体验.</li> <li>授权还要有授权范围, **不能让第三方软件获得比注册时权限范围还大的授权, 也不能获得超出了用户授权的权限范围, 始终确保最小权限安全原则. ** 比如, 小明只为小兔软件授予了获取当天订单的权限, 那么小兔软件就不能访问小明店铺里面的历史订单数据.</li></ul> <p>可以参考对比一下微信的官方文档关于第三方登录的流程:<a href="https://developers.weixin.qq.com/doc/oplatform/Website_App/WeChat_Login/Wechat_Login.html" target="_blank" rel="noopener noreferrer">https://developers.weixin.qq.com/doc/oplatform/Website_App/WeChat_Login/Wechat_Login.html<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h4 id="在oauth-2-0中使用jwt结构化令牌"><a href="#在oauth-2-0中使用jwt结构化令牌" class="header-anchor">#</a> 在OAuth 2.0中使用JWT结构化令牌</h4> <p>前一节讲到了授权服务的核心就是<strong>颁发访问令牌</strong>, 而 OAuth 2.0 规范<strong>并没有约束访问令牌内容的生成规则, 只要符合唯一性, 不连续性, 不可猜性</strong>就够了. 这就意味着可以灵活选择令牌的形式, 既可以是没有内部结构且不包含任何信息含义的随机字符串, 也可以是具有<strong>内部结构且包含有信息含义</strong>的字符串.</p> <p>随机字符串这样的方式就不再介绍了, 之前课程中生成令牌的方式都是默认一个随机字符串. 而在结构化令牌这方面, 目前用得最多的就是 <strong>JWT 令牌</strong>了.</p> <h5 id="_1-jwt结构化令牌"><a href="#_1-jwt结构化令牌" class="header-anchor">#</a> 1.JWT结构化令牌</h5> <p>关于什么是 JWT, 官方定义是这样描述的:</p> <blockquote><p>JSON Web Token(JWT)是一个开放标准(RFC 7519), 它定义了一种紧凑的, 自包含的方式, 用于作为 JSON 对象在各方之间安全地传输信息.</p></blockquote> <p>这个定义是不是很费解? 简单理解下, <mark><strong>JWT 就是用一种结构化封装的方式来生成 token 的技术. 结构化后的 token 可以被赋予非常丰富的含义, 这也是它与原先毫无意义的, 随机的字符串形式 token 的最大区别</strong></mark>.</p> <p>结构化之后, 令牌本身就可以被 &quot;塞进&quot; 一些有用的信息, 比如小明为小兔软件进行了授权的信息, 授权的范围信息等. 或者可以形象地将其理解为这是一种 &quot;自编码&quot; 的能力, 而这些恰恰是无结构化令牌所不具备的.</p> <p><mark><strong>JWT 这种结构化体可以分为 HEADER(头部), PAYLOAD(数据体)和 SIGNATURE(签名)三部分.</strong></mark>  经过签名之后的 JWT 的整体结构, 是被<strong>句点符号</strong>分割的三段内容, 结构为 <mark><strong>header.payload.signature</strong></mark>. 比如下面这个示例:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9<span class="token punctuation">.</span>eyJzdWIiOiJVU0VSVEVTVCIsImV4cCI6MTU4NDEwNTc5MDcwMywiaWF0IjoxNTg0MTA1OTQ4MzcyfQ<span class="token punctuation">.</span><span class="token number">1</span>HbleXbvJ_2SW8ry30cXOBGR9FW4oSWBd3PWaWKsEXE
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>**注意: JWT 内部没有换行, 这里只是为了展示方便, 才将其用三行来表示. **</p> <p>可以把 JWT 令牌放到 https://jwt.io/ 网站的在线校验工具中进行校验, 就可以看到解码之后的数据:</p> <p><img src="/img/1d29b5136d73705e87e89c0b91973358-20230729094013-p0un4m8.png" alt="" title="由在线校验工具解码后的JWT令牌"></p> <p>解析后呈现出来的就是结构化的内容了. 接下来具体说说 JWT 的这三部分.</p> <ul><li><strong>HEADER</strong> 表示装载<strong>令牌类型和算法</strong>等信息, 是 JWT 的头部. 其中, typ 表示第二部分 PAYLOAD 是 JWT 类型, alg 表示使用 HS256 对称签名的算法.</li> <li><strong>PAYLOAD</strong> 表示是 JWT 的<strong>数据体</strong>, 代表了一组数据. 其中, sub(令牌的主体, 一般设为资源拥有者的唯一标识), exp(令牌的过期时间戳), iat(令牌颁发的时间戳)是 JWT 规范性的声明, 代表的是常规性操作. 更多的通用声明, 可以参考 RFC 7519 开放标准. 不过, 在一个 JWT 内可以包含一切合法的 JSON 格式的数据, 也就是说, PAYLOAD 表示的一组数据允许自定义声明.</li> <li><strong>SIGNATURE</strong> 表示对 JWT 信息的<strong>签名</strong>. 它有什么作用呢? 我们可能认为, 有了 HEADER 和 PAYLOAD 两部分内容后, 就可以让令牌携带信息了, 似乎就可以在网络中传输了, 但是在网络中传输这样的信息体是不安全的, 因为数据在&quot;裸奔&quot;啊. 所以, 还需要对其进行加密签名处理, <strong>而 SIGNATURE 就是对信息的签名结果, 当受保护资源接收到第三方软件的签名后需要验证令牌的签名是否合法</strong>.</li></ul> <p>现在知道了 JWT 的结构以及每部分的含义, 那么具体到 OAuth 2.0 的授权流程中, JWT 令牌是如何被使用的呢? 在讲如何使用之前呢, 先说说 &quot;<strong>令牌内检</strong>&quot;.</p> <h5 id="_2-令牌内检"><a href="#_2-令牌内检" class="header-anchor">#</a> 2.令牌内检</h5> <p>什么是令牌内检呢? <strong>授权服务颁发令牌, 受保护资源服务就要验证令牌</strong>. 前面讲过, 授权服务和受保护资源服务, 它俩是&quot;一伙的&quot;. **受保护资源来调用授权服务提供的检验令牌的服务, 这种校验令牌的方式称为令牌内检. **</p> <p>有时候授权服务依赖一个数据库, 然后受保护资源服务也依赖这个数据库, 也就是 &quot;共享数据库&quot;. 不过, 在如今微服务的环境下, 不同的系统之间是依靠<strong>服务</strong>而<strong>不是数据库</strong>来通信了, 比如授权服务给受保护资源服务提供一个 RPC 服务. 如下图所示.</p> <p><img src="/img/e2a4f6ac061bcfb8be47e0e6b552d7ef-20230729094013-babz1qs.png" alt="" title="授权服务提供接口服务, 供受保护资源校验令牌"></p> <p>那么, 在有了 JWT 令牌之后, 就多了一种选择, <strong>因为 JWT 令牌本身就包含了之前所要依赖数据库或者依赖 RPC 服务才能拿到的信息, 比如上面提到的哪个用户为哪个软件进行了授权等信息</strong>. 这样就不需要再调一次 RPC 接口了.</p> <p>接下来就看看有了 JWT 令牌之后, 整体的<strong>内检流程</strong>会变成什么样子.</p> <h5 id="_3-jwt是如何被使用的"><a href="#_3-jwt是如何被使用的" class="header-anchor">#</a> 3.JWT是如何被使用的?</h5> <p>有了 JWT 令牌之后的通信方式, 就如下图所示了, <mark><strong>授权服务&quot;扔出&quot;一个令牌, 受保护资源服务&quot;接住&quot;这个令牌, 然后自己开始解析令牌本身所包含的信息就可以了, 而不需要再去查询数据库或者请求 RPC 服务</strong></mark>. 这样也实现了上面说的令牌内检.</p> <p><img src="/img/1f2c92b9948a6271c26bc23544096daf-20230729094013-kbsyqik.png" alt="" title="受保护资源服务可直接解析JWT令牌"></p> <p>为了更能突出 JWT 令牌的位置, 上图简化了逻辑关系. 实际上, <strong>授权服务颁发了 JWT 令牌后给到了小兔软件, 小兔软件拿着 JWT 令牌来请求受保护资源服务, 也就是小明在京东店铺的订单. 很显然, JWT 令牌需要在公网上做传输. 所以在传输过程中, JWT 令牌需要进行 Base64 编码以防止乱码, 同时还需要进行签名及加密处理来防止数据信息泄露</strong>.</p> <p>如果是自己处理这些编码, 加密等工作的话, 就会增加额外的编码负担. 好在可以借助一些开源的工具来帮助我们处理这些工作. 比如下面的 Demo 中, 给出了开源 JJWT(Java JWT)的使用方法.</p> <p>JJWT 是目前 Java 开源的, 比较方便的 JWT 工具, 封装了 Base64URL 编码和对称 HMAC, 非对称 RSA 的一系列签名算法. 使用 JJWT, 我们只关注上层的业务逻辑实现, 而无需关注编解码和签名算法的具体实现, 这类开源工具可以做到开箱即用.</p> <p>这个 Demo 的代码如下, 使用 JJWT 可以很方便地生成一个<strong>经过签名的 JWT 令牌, 以及解析一个 JWT 令牌</strong>.</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">String</span> sharedTokenSecret<span class="token operator">=</span><span class="token string">&quot;hellooauthhellooauthhellooauthhellooauth&quot;</span><span class="token punctuation">;</span><span class="token comment">// 密钥</span>
<span class="token class-name">Key</span> key <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SecretKeySpec</span><span class="token punctuation">(</span>sharedTokenSecret<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token class-name">SignatureAlgorithm</span><span class="token punctuation">.</span><span class="token constant">HS256</span><span class="token punctuation">.</span><span class="token function">getJcaName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 生成JWT令牌</span>
<span class="token class-name">String</span> jwts <span class="token operator">=</span> <span class="token class-name">Jwts</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setHeaderParams</span><span class="token punctuation">(</span>headerMap<span class="token punctuation">)</span>
                  <span class="token punctuation">.</span><span class="token function">setClaims</span><span class="token punctuation">(</span>payloadMap<span class="token punctuation">)</span>
                  <span class="token punctuation">.</span><span class="token function">signWith</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token class-name">SignatureAlgorithm</span><span class="token punctuation">.</span><span class="token constant">HS256</span><span class="token punctuation">)</span>
                  <span class="token punctuation">.</span><span class="token function">compact</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">// 解析JWT令牌</span>
<span class="token class-name">Jws</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Claims</span><span class="token punctuation">&gt;</span></span> claimsJws <span class="token operator">=</span><span class="token class-name">Jwts</span><span class="token punctuation">.</span><span class="token function">parserBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setSigningKey</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">parseClaimsJws</span><span class="token punctuation">(</span>jwts<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">JwsHeader</span> header <span class="token operator">=</span> claimsJws<span class="token punctuation">.</span><span class="token function">getHeader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Claims</span> body <span class="token operator">=</span> claimsJws<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>使用 JJWT 解析 JWT 令牌时包含了验证签名的动作, 如果签名不正确就会抛出异常信息. 可以借助这一点来对签名做校验, 从而判断是否是一个没有被伪造过的, 合法的 JWT 令牌.</p> <p>异常信息, 一般是如下的样子:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token constant">JWT</span> signature does not match locally computed signature<span class="token punctuation">.</span> <span class="token constant">JWT</span> validity cannot be asserted and should not be trusted<span class="token punctuation">.</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>以上就是借助开源工具, 将 JWT 令牌应用到授权服务流程中的方法了.</p> <h5 id="_4-为什么要使用jwt令牌"><a href="#_4-为什么要使用jwt令牌" class="header-anchor">#</a> 4.为什么要使用JWT令牌</h5> <p>到这里, 你是不是一直都有一个疑问: <strong>为什么要绕这么大一个弯子, 使用 JWT, 而不是使用没有啥内部结构, 也不包含任何信息的随机字符串呢? JWT 到底有什么好处</strong>?</p> <p>这里就总结下使用 <mark><strong>JWT 格式令牌的三大好处</strong></mark>.</p> <ol><li><strong>JWT 的核心思想, 就是用计算代替存储, 有些 &quot;时间换空间&quot; 的感觉</strong>. 当然, 这种经过计算并结构化封装的方式, 也减少了 &quot;共享数据库&quot; 因远程调用而带来的网络传输消耗, 所以也有可能是节省时间的.</li> <li><strong>第二个好处也是一个重要特性, 也就是加密</strong>. 因为 JWT 令牌内部已经包含了重要的信息, 所以在整个传输过程中都必须被要求是密文传输的, <strong>这样被强制要求了加密也就保障了传输过程中的安全性</strong>. 这里的加密算法, 既可以是对称加密, 也可以是非对称加密.</li> <li><strong>使用 JWT 格式的令牌, 有助于增强系统的可用性和可伸缩性</strong>. 这一点要怎么理解呢? 前面讲到了, 这种 JWT 格式的令牌, 通过 &quot;自编码&quot; 的方式包含了身份验证需要的信息, 不再需要服务端进行额外的存储, 所以每次的请求都是<strong>无状态会话</strong>. 这就符合了尽可能遵循无状态架构设计的原则, 也就是增强了系统的<strong>可用性和伸缩性</strong>.</li></ol> <p>但万物皆有两面性, <mark><strong>JWT 令牌也有缺点</strong></mark>.</p> <p>JWT 格式令牌的最大问题在于 &quot;覆水难收&quot;, 也就是说, <strong>没办法在使用过程中修改令牌状态</strong>.</p> <p>还是借助小明使用小兔软件例子来说明. 小明在使用小兔软件的时候, 是不是有可能因为某种原因修改了在京东的密码, 或者是不是有可能突然取消了给小兔的授权? 这时候, 令牌的状态是不是就要有相应的变更, 将原来对应的令牌置为无效.</p> <p><strong>但使用 JWT 格式令牌时, 每次颁发的令牌都不会在服务端存储, 这样要改变令牌状态的时候, 就无能为力了. 因为服务端并没有存储这个 JWT 格式的令牌. 这就意味着, JWT 令牌在有效期内, 是可以&quot;横行无止&quot;的.</strong></p> <p>为了解决这个问题, 可以把 JWT 令牌存储到远程的分布式内存数据库中吗? 显然不能, 因为这会违背 JWT 的初衷(将信息通过结构化的方式存入令牌本身). 因此通常会有两种做法:</p> <ol><li>将每次生成 JWT 令牌时的<strong>秘钥粒度缩小到用户级别</strong>, 也就是一个用户一个秘钥. 这样当用户取消授权或者修改密码后, 就可以让这个密钥一起修改. 一般情况下, 这种方案需要配套一个单独的密钥管理服务.</li> <li>在不提供用户主动取消授权的环境里面, 如果只考虑到修改密码的情况, 那么就可以<strong>把用户密码作为 JWT 的密钥</strong>. 当然这也是用户粒度级别的. 这样一来, 用户修改密码也就相当于修改了密钥.</li></ol> <h5 id="_5-令牌的生命周期"><a href="#_5-令牌的生命周期" class="header-anchor">#</a> 5.令牌的生命周期</h5> <p>上面讲了 JWT 令牌有效期的问题, 讲到了它的失效处理, 另外前面也提到, 授权服务颁发访问令牌的时候, 都会设置一个过期时间, 其实这都属于<strong>令牌的生命周期</strong>的管理问题. 接下来讲一讲令牌的生命周期.</p> <p>**万物皆有周期, 这是自然规律, 令牌也不例外, 无论是 JWT 结构化令牌还是普通的令牌. 它们都有有效期, 只不过, JWT 令牌可以把有效期的信息存储在本身的结构体中. **</p> <p>具体到 OAuth 2.0 的令牌生命周期, 通常会有三种情况.</p> <ol><li>第一种情况是令牌的<strong>自然过期</strong>过程, 这也是最常见的情况. 这个过程是, 从授权服务创建一个令牌开始, 到第三方软件使用令牌, 再到受保护资源服务验证令牌, 最后再到令牌失效. 同时这个过程也不排除主动销毁令牌的事情发生, 比如令牌被泄露, 授权服务可以做主让令牌失效.</li> <li>生命周期的第二种情况, 也就是上一讲提到的, 访问令牌失效之后可以使用<strong>刷新令牌</strong>请求新的访问令牌来代替失效的访问令牌, 以提升用户使用第三方软件的体验.</li> <li>生命周期的第三种情况, 就是让第三方软件比如小兔, <strong>主动发起令牌失效的请求</strong>, 然后授权服务收到请求之后让令牌立即失效. 想一下, 什么情况下会需要这种机制, 也就是想一下第三方软件这样做的 &quot;动机&quot;, 毕竟一般情况下 &quot;我们很难放弃已经拥有的事物&quot;. 比如有些时候, 用户和第三方软件之间存在一种订购关系, 比如小明购买了小兔软件, 那么在订购时长到期或者退订, 且小明授权的 token 还没有到期的情况下, 就需要有这样的一种<strong>令牌撤回协议</strong>, 来支持小兔软件主动发起令牌失效的请求. 作为平台一方比如京东商家开放平台, 也建议有责任的第三方软件比如小兔软件, 遵守这样的一种令牌撤回协议.</li></ol> <p>这里将以上三种情况整理成了一份序列图, 以便于理解. 同时, 为了突出令牌, 这里将访问令牌和刷新令牌, 特意用深颜色标识出来, 并单独作为两个角色放进了整个序列图中.</p> <p><img src="/img/59347c37af1baa004bad02551b683036-20230729094013-io586cr.png" alt="" title="令牌生命周期"></p> <h5 id="_6-总结"><a href="#_6-总结" class="header-anchor">#</a> 6.总结</h5> <p>OAuth 2.0 的核心是授权服务, 更进一步讲是令牌, **没有令牌就没有 OAuth, **令牌表示的是授权行为之后的结果.</p> <p>一般情况下令牌对第三方软件来说是一个随机的字符串, 是不透明的. 令牌可以是一个无意义的字符串. 但大家 &quot;不甘于&quot; 这样的满足, 于是开始探索新的生成令牌的方式, 也就有了 JWT 令牌, 这样一来既不需要通过共享数据库, 也不需要通过授权服务提供接口的方式来做令牌校验了. 这就相当于通过 JWT 这种结构化的方式, 在做令牌校验的时候多了一种选择.</p> <p>本节需要记住以下几点内容:</p> <ul><li>JWT 令牌是一种结构化, 信息化令牌, <strong>结构化可以组织用户的授权信息, 信息化就是令牌本身包含了授权信息</strong>.</li> <li>虽然本节重点是 JWT 令牌, 但不论是结构化的令牌还是非结构化的令牌, 对于第三方软件来讲, 它都不关心, 因为<strong>令牌在 OAuth 2.0 系统中对于第三方软件都是不透明的</strong>. 需要<strong>关心令牌的, 是授权服务和受保护资源服务</strong>.</li> <li>需要注意 JWT 令牌的失效问题. 在使用了 JWT 令牌之后, 远程的服务端上面是<strong>不存储</strong>的, 因为不再有这个必要, JWT 令牌本身就包含了信息. 那么, 如何来控制它的有效性问题呢? 本讲给出了两种建议, **一种是建立一个秘钥管理系统, 将生成秘钥的粒度缩小到用户级别, 另外一种是直接将用户密码当作密钥. **</li></ul> <h4 id="如何安全快速地接入oauth-2-0"><a href="#如何安全快速地接入oauth-2-0" class="header-anchor">#</a> 如何安全快速地接入OAuth 2.0</h4> <p>前面讲授权服务的流程的时候提到, <strong>授权服务将 OAuth 2.0 的复杂性都揽在了自己身上</strong>, 这也是授权服务为什么是 OAuth 2.0 体系的核心的原因之一.</p> <p>虽然授权服务做了大部分工作, 但是在 OAuth 2.0 的体系里面, 除了资源拥有者是作为用户参与, 还有另外两个系统角色, 也就是<strong>第三方软件和受保护资源服务</strong>. 本节就站在这两个角色的角度, 看看它们应该做哪些工作, 才能接入到 OAuth 2.0 的体系里面.</p> <p>现在就来看看, 作为第三方软件的小兔和京东的受保护资源服务, 具体需要着重处理哪些工作.</p> <blockquote><p>注: 另外说明一点, 为了脱敏的需要, 在下面的讲述中, 只是把京东商家开放平台作为一个角色使用, 以便有场景感, 来帮助你理解.</p></blockquote> <h5 id="_1-构建第三方软件应用"><a href="#_1-构建第三方软件应用" class="header-anchor">#</a> 1.构建第三方软件应用</h5> <p>先来思考一下: 如果要基于京东商家开放平台构建一个小兔打单软件的应用, 小兔软件的研发人员应该做哪些工作?</p> <p>是不是要到京东商家开放平台申请注册为开发者, 在成为开发者以后再创建一个应用, 之后就开始开发了, 对吧? 没错, 一定是这样的流程. 那么, 开发第三方软件应用的过程中, 需要重点关注哪些内容呢?</p> <p>先总结下, 这些内容包括 4 部分, 分别是: <mark><strong>注册信息, 引导授权, 使用访问令牌, 使用刷新令牌</strong></mark>​ **. **</p> <p><img src="/img/dbfc29d49cabc571e0b3c0266d9867f3-20230729094013-17zey4l.png" alt="" title="开发第三方软件应用应该关注的内容"></p> <blockquote><p>第一点: 注册信息.</p></blockquote> <p>首先, 小兔软件只有先有了身份, 才可以参与到 OAuth 2.0 的流程中去. 也就是说, 小兔软件需要<strong>先拥有自己的 app_id 和 app_serect 等信息, 同时还要填写自己的回调地址 redirect_uri, 申请权限</strong>等信息.</p> <p>这种方式的注册有时候也称为<strong>静态注册</strong>, 也就是小兔软件的研发人员提前登录到京东商家开放平台进行手动注册, 以便后续使用这些注册的相关信息来请求访问令牌.</p> <blockquote><p>第二点: 引导授权.</p></blockquote> <p>当用户需要使用第三方软件, 来操作其在受保护资源上的数据, <strong>就需要第三方软件来引导授权</strong>. 比如小明要使用小兔打单软件来对店铺里面的订单发货打印, 那小明<strong>首先访问的一定是小兔软件</strong>(原则上是直接访问第三方软件, 不过在后面讲到服务市场这种场景的时候, 会有稍微不同), 不会是授权服务, 更不会是受保护资源服务.</p> <p>但是小兔软件需要小明的授权, 只有授权服务才能允许小明这样做. 所以呢, 小兔软件需要 &quot;配合&quot; 小明做的第一件事儿, 就是<strong>将小明引导至授权服务</strong>, 如下面代码所示.</p> <p>那去做什么呢? 其实就是<strong>让用户为第三方软件授权, 得到了授权之后, 第三方软件才可以代表用户去访问数据</strong>. 也就是说, 小兔打单软件获得授权之后, 才能够代表小明处理其在京东店铺上的订单数据.</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// 重定向到授权页</span>
<span class="token class-name">String</span> oauthUrl <span class="token operator">=</span> <span class="token string">&quot;http://localhost:8081/OauthServlet-ch03?reqType=oauth&quot;</span><span class="token punctuation">;</span>
response<span class="token punctuation">.</span><span class="token function">sendRedirect</span><span class="token punctuation">(</span>toOauthUrl<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><blockquote><p>第三点: 使用访问令牌.</p></blockquote> <p><strong>拿到令牌后去使用令牌, 才是第三方软件的最终目的</strong>. 然后看看如何使用令牌. 目前 OAuth 2.0 的令牌只支持一种类型, 那就是 <mark><strong>bearer 令牌</strong></mark>, 也就是之前讲到的可以是<strong>任意字符串格式的令牌</strong>.</p> <p>官方规范给出的使用访问令牌请求的方式, 有三种, 分别是:</p> <ol><li><strong>Form-Encoded Body Parameter</strong>(表单参数)</li></ol> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token constant">POST</span> <span class="token operator">/</span>resource <span class="token constant">HTTP</span><span class="token operator">/</span><span class="token number">1.1</span>
<span class="token class-name">Host</span><span class="token operator">:</span> server<span class="token punctuation">.</span>example<span class="token punctuation">.</span>com
<span class="token class-name">Content</span><span class="token operator">-</span><span class="token class-name">Type</span><span class="token operator">:</span> application<span class="token operator">/</span>x<span class="token operator">-</span>www<span class="token operator">-</span>form<span class="token operator">-</span>urlencoded

access_token<span class="token operator">=</span>b1a64d5c<span class="token operator">-</span><span class="token number">5e0</span>c<span class="token operator">-</span><span class="token number">4</span>a70<span class="token operator">-</span><span class="token number">9711</span><span class="token operator">-</span><span class="token number">7</span>af6568a61fb
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><ol start="2"><li><strong>URI Query Parameter</strong>(URI 查询参数)</li></ol> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token constant">GET</span> <span class="token operator">/</span>resource<span class="token operator">?</span>access_token<span class="token operator">=</span>b1a64d5c<span class="token operator">-</span><span class="token number">5e0</span>c<span class="token operator">-</span><span class="token number">4</span>a70<span class="token operator">-</span><span class="token number">9711</span><span class="token operator">-</span><span class="token number">7</span>af6568a61fb <span class="token constant">HTTP</span><span class="token operator">/</span><span class="token number">1.1</span>
<span class="token class-name">Host</span><span class="token operator">:</span> server<span class="token punctuation">.</span>example<span class="token punctuation">.</span>com
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><ol start="3"><li><strong>Authorization Request Header Field</strong>(授权请求头部字段)</li></ol> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token constant">GET</span> <span class="token operator">/</span>resource <span class="token constant">HTTP</span><span class="token operator">/</span><span class="token number">1.1</span>
<span class="token class-name">Host</span><span class="token operator">:</span> server<span class="token punctuation">.</span>example<span class="token punctuation">.</span>com
<span class="token class-name">Authorization</span><span class="token operator">:</span> <span class="token class-name">Bearer</span> b1a64d5c<span class="token operator">-</span><span class="token number">5e0</span>c<span class="token operator">-</span><span class="token number">4</span>a70<span class="token operator">-</span><span class="token number">9711</span><span class="token operator">-</span><span class="token number">7</span>af6568a61fb
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>也就是说, 这三种方式都可以请求到受保护资源服务. 那采用哪种方式最合适呢?</p> <p>根据 OAuth 2.0 的官方建议, 系统在接入 OAuth 2.0 之前信息传递的请求载体是 JSON 格式的, 那么如果继续采用表单参数提交的方式, 令牌就无法加入进去了, 因为格式不符. 如果这时采用参数传递的方式呢, 整个 URI 会被整体复制, 安全性是最差的. 而请求头部字段的方式就没有上述的这些问题, 因此<mark><strong>官方的建议是采用 Authorization 的方式来传递令牌</strong></mark>.</p> <p>但是<mark><strong>建议采用表单提交, 也就是 POST 的方式来提交令牌</strong></mark>​ **, ** 类似如下代码所示. 原因是这样的, 从官方的建议中也可以看出, 它指的是在接入 OAuth 2.0 之前, 如果已经采用了 JSON 数据格式请求体的情况下, 不建议使用表单提交. 但如果刚开始的时候, 只要三方软件和平台之间约束好了, 大家一致采用表单提交, 就没有任何问题了. <strong>因为表单提交的方式在保证安全传输的同时, 还不需要去额外处理 Authorization 头部信息</strong>.</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">String</span> protectedURl <span class="token operator">=</span> <span class="token string">&quot;http://localhost:8082/ProtectedServlet-ch03&quot;</span><span class="token punctuation">;</span>
<span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> paramsMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

paramsMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;app_id&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;APPID_RABBIT&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
paramsMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;app_secret&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;APPSECRET_RABBIT&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
paramsMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;token&quot;</span><span class="token punctuation">,</span> accessToken<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">String</span> result <span class="token operator">=</span> <span class="token class-name">HttpURLClient</span><span class="token punctuation">.</span><span class="token function">doPost</span><span class="token punctuation">(</span>protectedURl<span class="token punctuation">,</span> <span class="token class-name">HttpURLClient</span><span class="token punctuation">.</span><span class="token function">mapToStr</span><span class="token punctuation">(</span>paramsMap<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><blockquote><p>第四点: 使用刷新令牌.</p></blockquote> <p>在讲授权服务的时候提到过, 如果访问令牌过期了, 小兔软件总不能立马提示并让小明重新授权一次, 否则小明的体验将会非常不好. 为了解决这个问题呢, 就用到了<strong>刷新令牌</strong>.</p> <p>使用刷新令牌的方式跟使用访问令牌是一样的, 具体可以参照上面讲的访问令牌的方式. 关于刷新令牌的使用, <strong>最需要关心的是什么时候会来决定使用刷新令牌</strong>.</p> <p>在小兔打单软件收到访问令牌的同时, 也会收到访问令牌的过期时间 expires_in. 一个设计良好的第三方应用, <strong>应该将 expires_in 值保存下来并定时检测</strong>; 如果<strong>发现 expires_in 即将过期, 则需要利用 refresh_token 去重新请求授权服务, 以便获取新的, 有效的访问令牌</strong>.</p> <p>这种<strong>定时检测</strong>的方法可以提前发现访问令牌是否即将过期. 此外, 还有一种方法是&quot;现场&quot;发现. 也就是说, 比如小兔软件访问小明店铺订单的时候, 突然收到一个访问令牌失效的响应, 此时小兔软件立即使用 refresh_token 来请求一个访问令牌, 以便继续代表小明使用他的数据.</p> <p>综合来看的话, 定时检测的方式, 需要额外开发一个定时任务; 而&quot;现场&quot;发现, 就没有这种额外的工作量. 具体采用哪一种方式, 可以结合自己的实际情况. 不过还是<strong>建议采用定时检测这种方式, 因为它可以带来&quot;提前量&quot;</strong> , 以便让有更好的主动性, 而现场发现就有点被动了.</p> <p>要再次注意的是, <strong>刷新令牌是一次性的, 使用之后就会失效</strong>, 但是它的<strong>有效期会比访问令牌要长</strong>. 这个时候可能会想到, <mark><strong>如果刷新令牌也过期了怎么办? 在这种情况下, 就需要将刷新令牌和访问令牌都放弃, 相当于回到了系统的初始状态, 只能让用户小明重新授权了</strong></mark>.</p> <p>总结下, 在构建第三方应用时, 需要重点关注的就是<strong>注册, 授权, 访问令牌, 刷新令牌</strong>. 只要掌握了这四部分内容, 在类似京东这样的开放平台上开发小兔软件, 就不再是什么困难的事情了.</p> <h5 id="_2-服务市场中的第三方应用软件"><a href="#_2-服务市场中的第三方应用软件" class="header-anchor">#</a> 2.服务市场中的第三方应用软件</h5> <p>在构建第三方应用的引导授权时, 前面说用户第一次&quot;触摸&quot;到的一定是第三方软件, 但这并不是绝对的. 这个不绝对, 就发生在服务市场这样的场景里.</p> <p>那什么是服务市场呢? 就是你开发的软件, 比如小兔打单软件, 店铺装修软件等, 都发布到这样一个市场里面售卖. 这样, 当用户购买了这些软件之后, 就可以在服务市场里面看到有个&quot;立即使用&quot;的按钮. 点击这个按钮, 用户就可以直接访问自己购买的第三方软件了.</p> <p>比如, 京东的京麦服务市场里有个&quot;我的服务&quot;目录, 里面就存放了我购买的打单软件. 小明就可以直接点击&quot;立即使用&quot;, 继而进入小兔打单软件, 如下图所示.</p> <p><img src="/img/369a2bf869bb81ea611fec44ce3916c1-20230729094013-jc5f3vi.png" alt="">​那么, 这里需要注意的是, <strong>作为第三方开发者来构建第三方软件的时候, 在授权码环节除了要接收授权码 code 值之外, 还要接收用户的订购相关信息, 比如服务的版本号, 服务代码标识等信息</strong>.</p> <p>以上就是关于构建第三方软件时需要注意的一些细节问题了.</p> <h5 id="_3-构建受保护资源服务"><a href="#_3-构建受保护资源服务" class="header-anchor">#</a> 3.构建受保护资源服务</h5> <p>接下来再谈谈构建<strong>受保护资源服务</strong>的时候, 又需要重点处理哪些工作.</p> <p>先想一想, 实际上在整个开放授权的环境中, <mark><strong>受保护资源最终指的还是 Web API</strong></mark>, 比如访问头像的 API, 访问昵称的 API. 对应到打单软件中, 受保护资源就是订单查询 API, 批量查询 API 等.</p> <p>在互联网上的系统之间的通信, 基本都是以 Web API 为载体的形式进行. 因此, <strong>当说受保护资源被授权服务保护着时, 实际上说的是授权服务最终保护的是这些 Web API</strong>. 在构建受保护资源服务的时候, 除了基本的要检查令牌的合法性, 还需要做些什么呢? **最重要的就是权限范围了. **</p> <p>在处理受保护资源服务中的逻辑的时候, <strong>校验权限的处理会占据很大的比重</strong>. 因为访问令牌来的时候, 肯定要多看看令牌到底能操作哪些功能, 又能访问哪些数据. 把这些权限的类别总结归纳下来, 最常见的大概有以下几类.</p> <p><img src="/img/e220e72c930e21602e5fb5f96a94dac8-20230729094013-nhn0yia.png" alt="" title="3类权限类别"></p> <p>接下来具体说说这些权限是如何使用的.</p> <blockquote><p>不同的权限对应不同的操作.</p></blockquote> <p>这里的操作, 其实对应的是 <strong>Web API</strong>, 比如目前京东商家开放平台提供有查询商品 API, 新增商品 API, 删除商品 API 这三种. 如果小兔软件请求过来的一个访问令牌 access_token 的 scope 权限范围只对应了查询商品 API, 新增商品 API, 那么包含这个 access_token 值的请求, 就不能执行删除商品 API 的操作.</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// 不同的权限对应不同的操作</span>
<span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> scope <span class="token operator">=</span> <span class="token class-name">OauthServlet</span><span class="token punctuation">.</span>tokenScopeMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>accessToken<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">StringBuffer</span> sbuf <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> scope<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    sbuf<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>scope<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;|&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span>sbuf<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">&quot;query&quot;</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">queryGoods</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span>sbuf<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">&quot;add&quot;</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">addGoods</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span>sbuf<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">&quot;del&quot;</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">delGoods</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><blockquote><p>不同的权限对应不同的数据.</p></blockquote> <p>这里的数据, 就是<strong>指某一个 API 里包含的属性字段信息</strong>. 比如, 有一个查询小明信息的 API, 返回的信息包括 Contact(email, phone, qq), Like(Basketball, Swimming), Personal Data(sex, age, nickname). 如果小兔软件请求过来的一个访问令牌 access_token 的 scope 权限范围只对应了 Personal Data, 那么包含该 access_token 值的请求就不能获取到 Contact 和 Like 的信息, 关于这部分的代码, 实际跟不同权限对应不同操作的代码类似.</p> <p>看到这里就可以明白, 这种权限范围的粒度要比&quot;不同的权限对应不同的操作&quot;的粒度要小. 这正是遵循了最小权限范围原则.</p> <blockquote><p>不同的用户对应不同的数据.</p></blockquote> <p>这种权限是什么意思呢? 其实, 这种权限实际上<strong>只是换了一种维度</strong>, 将其定位到了用户上面.</p> <p>一些基础类信息, 比如获取地理位置, 获取天气预报等, 不会带有用户归属属性, 也就是说这些信息并不归属于某个用户, 是一类公有信息. 对于这样的信息, 平台提供出去的 API 接口都是 &quot;中性&quot; 的, 没有用户属性.</p> <p>但是更多的场景却是基于用户属性的. 还是以小兔打单软件为例, 商家每次打印物流面单的时候, 小兔打单软件都要知道是哪个商家的订单. 这种情况下, 商家为小兔软件授权, 小兔软件获取的 access_token 实际上就<strong>包含了商家这个用户属性</strong>.</p> <p>京东商家开放平台的受保护资源服务每次接收到小兔软件的请求时, 都会根据该请求中 access_token 的值找到对应的商家 ID, 继而根据商家 ID 查询到商家的订单信息, 也就是不同的商家对应不同的订单数据.</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// 不同的用户对应不同的数据</span>
<span class="token class-name">String</span> user <span class="token operator">=</span> <span class="token class-name">OauthServlet</span><span class="token punctuation">.</span>tokenMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>accessToken<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">queryOrders</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>在上面讲三种权限的时候, 举的例子实际上都属于一个系统提供了查询, 添加, 删除这样的所有服务. 此时你可能会想到, 现在的系统不已经是分布式系统环境了么, <strong>如果有很多个受保护资源服务, 比如提供用户信息查询的用户资源服务, 提供商品查询的商品资源服务, 提供订单查询的订单资源服务, 那么每个受保护资源服务岂不是都要把上述的权限范围校验执行一遍吗, 这样不就会有大量的重复工作产生么</strong>?</p> <p>确实会有这种情况. <mark><strong>为了应对这种情况, 应该有一个统一的网关层来处理这样的校验, 所有的请求都会经过 API GATEWAY 跳转到不同的受保护资源服务</strong></mark>. 这样就不需要在每一个受保护资源服务上都做一遍权限校验的工作了, 而只需要<strong>在 API GATEWAY 这一层做权限校验</strong>就可以了. 系统结构如下图所示.</p> <p><img src="/img/8c2f08d40d91f589bacd8417017cfa32-20230729094013-lygo1yw.png" alt="" title="由统一的网关层处理权限校验"></p> <h5 id="_4-总结-3"><a href="#_4-总结-3" class="header-anchor">#</a> 4.总结</h5> <p>本节开始的时候, 提到 OAuth 2.0 的复杂性实际上都给了授权服务来承担, 接着从第三方软件和受保护资源的角度, 分别介绍了这两部分系统在接入 OAuth 2.0 的时候应该注意哪些方面.</p> <p>总结下来本节记住以下两点.</p> <ul><li>对于第三方软件, 比如小兔打单软件来讲, <strong>它的主要目的就是获取访问令牌, 使用访问令牌</strong>, 这当然也是整个 OAuth 2.0 的目的, 就是让第三方软件来做这两件事. 在这个过程中需要强调的是, 第三方软件在使用访问令牌的时候有三种方式, 建议在平台和第三方软件约定好的前提下, <strong>优先采用 Post 表单提交的方式</strong>.</li> <li>受保护资源系统, 比如小兔软件要访问开放平台的订单数据服务, 它需要注意的是权限的问题, 这个权限范围主要包括, <strong>不同的权限会有不同的操作, 不同的权限也会对应不同的数据, 不同的用户也会对应不同的数据</strong>.</li></ul> <h4 id="除了授权码许可类型-oauth-2-0还支持什么授权流程"><a href="#除了授权码许可类型-oauth-2-0还支持什么授权流程" class="header-anchor">#</a> 除了授权码许可类型, OAuth 2.0还支持什么授权流程</h4> <p><strong>授权码许可的流程最完备, 最安全没错儿, 但它适合所有的授权场景吗? 在有些场景下使用授权码许可授权, 是不是过于复杂了, 是不是根本就没必要这样?</strong></p> <p>比如, 小兔打单软件是京东<strong>官方开发</strong>的一款软件, 那么小明在使用小兔的时候, 还需要小兔再走一遍授权码许可类型的流程吗? 估计你也猜到答案了, 肯定是不需要了.</p> <p>授权码许可流程中通过授权码这种临时的中间值, 让小明这样的用户参与进来, 从而让小兔软件和京东之间建立联系, 进而让小兔代表小明去访问他在京东店铺的订单数据.</p> <p>现在小兔被&quot;招安&quot;了, 是京东自家的了, <strong>是被京东充分信任的, 没有&quot;第三方软件&quot;的概念</strong>了. 同时小明也是京东店铺的商家, 也就是说软件和用户都是京东的资产. 这时显然没有必要再使用授权码许可类型进行授权了. 但是小兔依然要通过互联网访问订单数据的 Web API, 来提供为小明打单的功能.</p> <p>于是, 为了保护这些场景下的 Web API, 又为了让 OAuth 2.0 更好地适应现实世界的更多场景, 来解决比如上述小兔软件这样的案例, OAuth 2.0 体系中还提供了<strong>资源拥有者凭据许可类型</strong>.</p> <h5 id="_1-资源拥有者凭据许可"><a href="#_1-资源拥有者凭据许可" class="header-anchor">#</a> 1.资源拥有者凭据许可</h5> <p>从&quot;资源拥有者凭据许可&quot;这个命名就可以大概理解它的含义. <strong>资源拥有者的凭据, 就是用户的凭据, 就是用户名和密码</strong>. 可见, 这是最糟糕的一种方式. 那为什么 OAuth 2.0 还支持这种许可类型, 而且编入了 OAuth 2.0 的规范呢?</p> <p>先来思考一下. 正如上面提到的, 小兔此时就是京东官方出品的一款软件, 小明也是京东的用户, 那么小明其实是可以使用用户名和密码来直接使用小兔这款软件的. 原因很简单, 那就是这里不再有&quot;第三方&quot;的概念了.</p> <p><strong>但如果每次小兔都是拿着小明的用户名和密码来通过调用 Web API 的方式, 来访问小明店铺的订单数据, 甚至还有商品信息等, 在调用这么多 API 的情况下, 无疑增加了用户名和密码等敏感信息的攻击面.</strong></p> <p>如果是使用了 <strong>token</strong> 来代替这些敏感信息, 不就能很大程度上保护敏感信息数据了吗? 这样小兔软件<strong>只需要使用一次用户名和密码数据来换回一个 token, 进而通过 token 来访问小明店铺的数据, 以后就不会再使用用户名和密码了</strong>.</p> <p>接下来一起看下这种许可类型的流程, 如下图所示:</p> <p><img src="/img/7a045aa15e99de851a951b46d7255b95-20230729094013-plignrr.png" alt="" title="资源拥有者凭据许可类型的流程"></p> <p>步骤 1: 当用户访问第三方软件小兔时, 会提示输入用户名和密码. <strong>索要用户名和密码, 就是资源拥有者凭据许可类型的特点</strong>.</p> <p>步骤 2: <strong>这里的 grant_type 的值为 password</strong>, 告诉<strong>授权服务使用资源拥有者凭据许可凭据的方式</strong>去请求访问.</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> params <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
params<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;grant_type&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;password&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
params<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;app_id&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;APPIDTEST&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
params<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;app_secret&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;APPSECRETTEST&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
params<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;NAMETEST&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
params<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;password&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;PASSWORDTEST&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">String</span> accessToken <span class="token operator">=</span> <span class="token class-name">HttpURLClient</span><span class="token punctuation">.</span><span class="token function">doPost</span><span class="token punctuation">(</span>oauthURl<span class="token punctuation">,</span> <span class="token class-name">HttpURLClient</span><span class="token punctuation">.</span><span class="token function">mapToStr</span><span class="token punctuation">(</span>params<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>步骤 3: <strong>授权服务在验证用户名和密码之后, 生成 access_token 的值并返回给第三方软件</strong>.</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">&quot;password&quot;</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>grantType<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">String</span> appSecret <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span><span class="token string">&quot;app_secret&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> username <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span><span class="token string">&quot;username&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> password <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span><span class="token string">&quot;password&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token string">&quot;APPSECRETTEST&quot;</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>appSecret<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        response<span class="token punctuation">.</span><span class="token function">getWriter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token string">&quot;app_secret is not available&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token string">&quot;USERNAMETEST&quot;</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        response<span class="token punctuation">.</span><span class="token function">getWriter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token string">&quot;username is not available&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token string">&quot;PASSWORDTEST&quot;</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>password<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        response<span class="token punctuation">.</span><span class="token function">getWriter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token string">&quot;password is not available&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">String</span> accessToken <span class="token operator">=</span> <span class="token function">generateAccessToken</span><span class="token punctuation">(</span>appId<span class="token punctuation">,</span> <span class="token string">&quot;USERTEST&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//生成访问令牌access_token的值</span>
    response<span class="token punctuation">.</span><span class="token function">getWriter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>accessToken<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><p>因此, <strong>如果软件是官方出品的, 又要使用 OAuth 2.0 来保护 Web API, 那么就可以采用资源拥有者凭据许可类型</strong>.</p> <p>除了资源拥有者凭据许可类型外, OAuth 2.0 体系针对现实的环境还提供了<strong>客户端凭据许可和隐式许可类型</strong>.</p> <h5 id="_2-客户端凭据许可"><a href="#_2-客户端凭据许可" class="header-anchor">#</a> 2.客户端凭据许可</h5> <p>如果<strong>没有明确的资源拥有者</strong>, 换句话说就是, 小兔软件访问了一个<strong>不需要用户小明授权的数据</strong>, 比如获取京东 LOGO 的图片地址, 这个 LOGO 信息不属于任何一个第三方用户, 再比如其它类型的第三方软件来访问平台提供的省份信息, 省份信息也不属于任何一个第三方用户.</p> <p>此时, <mark>在授权流程中, 就</mark>​<mark><strong>不再需要资源拥有者这个角色</strong></mark>​<mark>了. 当然</mark>​<mark><strong>也可以形象地理解为 &quot;资源拥有者被塞进了第三方软件中&quot; 或者 &quot;第三方软件就是资源拥有者&quot;</strong></mark> . 这种场景下的授权, 便是客户端凭据许可, 第三方软件<strong>可以直接使用注册时的 app_id 和 app_secret 来换回访问令牌 token 的值</strong>.</p> <p>还是以小明使用小兔软件为例, 来看下客户端凭据许可的整个授权流程, 如下图所示:</p> <p><img src="/img/a99895111dcc51f278b2f9f1edc18b7c-20230729094013-1mqb4b4.png" alt="" title="客户端凭据许可授权流程"></p> <p><strong>因为授权过程没有了资源拥有者小明的参与, 小兔软件的后端服务可以随时发起 access_token 的请求, 所以这种授权许可也不需要刷新令牌.</strong></p> <p>这样一来, 客户端凭据许可类型的关键流程, 就是以下两大步.</p> <p>步骤 1: 第三方软件小兔通过后端服务向授权服务发送请求, <strong>这里 grant_type 的值为 client_credentials</strong>, 告诉授权服务要使用<strong>第三方软件凭据</strong>的方式去请求访问.</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> params <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
params<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;grant_type&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;client_credentials&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
params<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;app_id&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;APPIDTEST&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
params<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;app_secret&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;APPSECRETTEST&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">String</span> accessToken <span class="token operator">=</span> <span class="token class-name">HttpURLClient</span><span class="token punctuation">.</span><span class="token function">doPost</span><span class="token punctuation">(</span>oauthURl<span class="token punctuation">,</span> <span class="token class-name">HttpURLClient</span><span class="token punctuation">.</span><span class="token function">mapToStr</span><span class="token punctuation">(</span>params<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>步骤 2: <strong>在验证 app_id 和 app_secret 的合法性之后, 生成 access_token 的值并返回</strong>.</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">String</span> grantType <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span><span class="token string">&quot;grant_type&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">String</span> appId <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span><span class="token string">&quot;app_id&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token string">&quot;APPIDTEST&quot;</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>appId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    response<span class="token punctuation">.</span><span class="token function">getWriter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token string">&quot;app_id is not available&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">&quot;client_credentials&quot;</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>grantType<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">String</span> appSecret <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span><span class="token string">&quot;app_secret&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token string">&quot;APPSECRETTEST&quot;</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>appSecret<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        response<span class="token punctuation">.</span><span class="token function">getWriter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token string">&quot;app_secret is not available&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">String</span> accessToken <span class="token operator">=</span> <span class="token function">generateAccessToken</span><span class="token punctuation">(</span>appId<span class="token punctuation">,</span> <span class="token string">&quot;USERTEST&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//生成访问令牌access_token的值</span>
    response<span class="token punctuation">.</span><span class="token function">getWriter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>accessToken<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>再小结下: <strong>在获取一种不属于任何一个第三方用户的数据时, 并不需要类似小明这样的用户参与, 此时便可以使用客户端凭据许可类型</strong>.</p> <h5 id="_3-隐式许可"><a href="#_3-隐式许可" class="header-anchor">#</a> 3.隐式许可</h5> <p>再想象一下, 如果小明使用的小兔打单软件<strong>应用没有后端服务, 就是在浏览器里面执行的</strong>, 比如纯粹的 JavaScript 应用, 应该如何使用 OAuth 2.0 呢? <strong>这种情况下的授权流程就可以使用隐式许可流程, 可以理解为第三方软件小兔直接嵌入浏览器中了</strong>.</p> <p>在这种情况下, <strong>小兔软件对于浏览器就没有任何保密的数据可以隐藏</strong>了, 也不再需要应用密钥 app_secret 的值了, 也不用再通过授权码 code 来换取访问令牌 access_token 的值了. <strong>因为使用授权码的目的之一, 就是把浏览器和第三方软件的信息做一个隔离, 确保浏览器看不到第三方软件最重要的访问令牌 access_token 的值</strong>.</p> <p>因此, <mark><strong>隐式许可授权流程的安全性会降低很多</strong></mark>. 在授权流程中, 没有服务端的小兔软件相当于是嵌入到了浏览器中, 访问浏览器的过程相当于接触了小兔软件的全部, 因此这里用虚线框来表示小兔软件, 整个授权流程如下图所示:</p> <p><img src="/img/9915a1b324455de79813fe4235248851-20230729094013-aep3tfa.png" alt="" title="隐式许可授权流程"></p> <p>接下来, 使用 Servlet 的 Get 请求来模拟这个流程, 一起看看相关的示例代码.</p> <p>步骤 1: 用户通过浏览器访问第三方软件小兔. 此时, 第三方软件小兔实际上是<strong>嵌入浏览器中执行的应用程序</strong>.</p> <p>步骤 2: 这个流程和授权码流程类似, 只是需要特别注意一点, <strong>response_type 的值变成了 token</strong>, 是要告诉授权服务<strong>直接返回 access_token 的值</strong>. 隐式许可流程是唯一在前端通信中要求返回 access_token 的流程. 对, 就这么大胆, 但不安全.</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> params <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 告诉授权服务直接返回access_token</span>
params<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;response_type&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;token&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
params<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;redirect_uri&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;http://localhost:8080/AppServlet-ch02&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
params<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;app_id&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;APPIDTEST&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 构造请求授权的URl</span>
<span class="token class-name">String</span> toOauthUrl <span class="token operator">=</span> <span class="token class-name">URLParamsUtil</span><span class="token punctuation">.</span><span class="token function">appendParams</span><span class="token punctuation">(</span>oauthUrl<span class="token punctuation">,</span> params<span class="token punctuation">)</span><span class="token punctuation">;</span>

response<span class="token punctuation">.</span><span class="token function">sendRedirect</span><span class="token punctuation">(</span>toOauthUrl<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>步骤 3: <strong>生成 acccess_token 的值, 通过前端通信返回给第三方软件小兔</strong>.</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">String</span> responseType <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span><span class="token string">&quot;response_type&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">String</span> redirectUri <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span><span class="token string">&quot;redirect_uri&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">String</span> appId <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span><span class="token string">&quot;app_id&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token string">&quot;APPIDTEST&quot;</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>appId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">&quot;token&quot;</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>responseType<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 隐式许可流程(模拟), DEMO CODE, 注意: 该流程全部在前端通信中完成</span>
    <span class="token comment">// 生成访问令牌access_token的值</span>
    <span class="token class-name">String</span> accessToken <span class="token operator">=</span> <span class="token function">generateAccessToken</span><span class="token punctuation">(</span>appId<span class="token punctuation">,</span> <span class="token string">&quot;USERTEST&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> params <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    params<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;redirect_uri&quot;</span><span class="token punctuation">,</span> redirectUri<span class="token punctuation">)</span><span class="token punctuation">;</span>
    params<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;access_token&quot;</span><span class="token punctuation">,</span> accessToken<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 构造第三方软件的回调地址, 并重定向到该地址</span>
    <span class="token class-name">String</span> toAppUrl <span class="token operator">=</span> <span class="token class-name">URLParamsUtil</span><span class="token punctuation">.</span><span class="token function">appendParams</span><span class="token punctuation">(</span>redirectUri<span class="token punctuation">,</span> params<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 使用sendRedirect方式模拟前端通信</span>
    response<span class="token punctuation">.</span><span class="token function">sendRedirect</span><span class="token punctuation">(</span>toAppUrl<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p>如果你的软件就是<strong>直接嵌入到了浏览器中运行, 而且还没有服务端的参与</strong>, 并且还想使用 OAuth 2.0 流程的话, 那么便可以直接使用隐式许可类型了.</p> <h5 id="_4-如何选择许可类型"><a href="#_4-如何选择许可类型" class="header-anchor">#</a> 4.如何选择许可类型</h5> <p>到现在已经理解了 OAuth 2.0 的 4 种授权许可类型的原理与流程. 那么应该如何选择到底使用哪种授权许可类型呢?</p> <p><strong>一般的建议是在对接 OAuth 2.0 的时候</strong>​<mark><strong>先考虑授权码许可类型</strong></mark>​ <strong>, 其次再结合现实生产环境来选择:</strong></p> <ol><li>**如果小兔软件是官方出品, 那么可以直接使用资源拥有者凭据许可; **</li> <li>**如果小兔软件就是只嵌入到浏览器端的应用且没有服务端, 那就只能选择隐式许可; **</li> <li>**如果小兔软件获取的信息不属于任何一个第三方用户, 那可以直接使用客户端凭据许可类型. **</li></ol> <h5 id="_5-总结"><a href="#_5-总结" class="header-anchor">#</a> 5.总结</h5> <p>前面一共讲了 4 种授权许可类型, <mark>它们最显著的区别就是</mark>​<mark><strong>获取访问令牌 access_token 的方式不同</strong></mark>. 最后通过一张表格来对比下:</p> <table><thead><tr><th style="text-align:center;">授权许可类型</th> <th>获取访问令牌 access_token 的方式</th></tr></thead> <tbody><tr><td style="text-align:center;"><mark><strong>授权码许可</strong></mark></td> <td>通过授权码 code 获取 access_token</td></tr> <tr><td style="text-align:center;">客户端凭证许可</td> <td>通过第三方软件的 app_id 和 app_secret 获取 access_token</td></tr> <tr><td style="text-align:center;">隐式许可</td> <td>通过嵌入浏览器中的第三方软件的 app_id 来获取 access_token</td></tr> <tr><td style="text-align:center;">资源拥有者凭证许可</td> <td>通过资源拥有者的用户名和密码获取 access_token</td></tr></tbody></table> <p>除了上面这张表格所展现的 4 种授权许可类型的区别之外, 本节需要记住以下两点.</p> <ul><li><strong>所有的授权许可类型中, 授权码许可类型的安全性是最高的</strong>. 因此只要具备使用授权码许可类型的条件, 一定要首先授权码许可类型.</li> <li><strong>所有的授权许可类型都是为了解决现实中的实际问题, 因此还要结合实际的生产环境, 在保障安全性的前提下选择最合适的授权许可类型</strong>, 比如使用客户端凭据许可类型的小兔软件就是一个案例.</li></ul> <h3 id="进阶篇"><a href="#进阶篇" class="header-anchor">#</a> 进阶篇</h3> <h4 id="如何在移动app中使用oauth-2-0"><a href="#如何在移动app中使用oauth-2-0" class="header-anchor">#</a> 如何在移动App中使用OAuth 2.0</h4> <p>前面几讲都是<strong>基于 Web 应用</strong>的场景来讲解的 OAuth 2.0. 除了 Web 应用外, 现实环境中还有非常多的移动 App. <strong>在移动 App 中, 能不能使用 OAuth 2.0 , 又该如何使用 OAuth 2.0 呢?</strong></p> <p>没错, OAuth 2.0 最初的应用场景确实是 Web 应用, 但是它的伟大之处就在于, <strong>它把自己的核心协议定位成了一个框架而不是单个的协议. 这样做的好处是, 可以基于这个基本的框架协议, 在一些特定的领域进行扩展</strong>.</p> <p>因此, 到了桌面或者移动的场景下, OAuth 2.0 的协议一样适用. 考虑到授权码许可是最完备, 最安全的许可类型, 所以在讲移动 App 如何使用 OAuth 2.0 的时候, 依然会用授权码许可来讲解, 毕竟&quot;要用就用最好的&quot;.</p> <p>当开发一款移动 App 的时候, 可以选择<strong>没有 Server 端的 &quot;纯 App&quot; 架构</strong>, 比如这款 App 不需要跟自己的 Server 端通信, 或者可以调用其它开放的 HTTP 接口; 当然也可以选择有服务端的架构, 比如这款 App 还想把用户的操作日志记录下来并保存到 Server 端的数据库中.</p> <p>那总结下来呢, 移动 App 可以分为两类, 一类是没有 Server 端的 App 应用, 一类是有 Server 端的 App 应用.</p> <p><img src="/img/bfe5720fa6684dd43e468dabbc6d9822-20230729094013-4t83m0a.png" alt="" title="两类移动App"></p> <p>这两类 App 在使用 OAuth 2.0 时的最大区别, 在于<strong>获取访问令牌的方式</strong>:</p> <ol><li>**如果有 Server 端, 就建议通过 Server 端和授权服务做交互来换取访问令牌; **</li> <li>**如果没有 Server 端, 那么只能通过前端通信来跟授权服务做交互, 比如在上一讲中提到的隐式许可授权类型. 当然这种方式的安全性就降低了很多. **</li></ol> <h5 id="_1-没有server端的app"><a href="#_1-没有server端的app" class="header-anchor">#</a> 1.没有Server端的App</h5> <p>有些时候, 可能觉得自己开发一个 App 不需要一个 Server 端. 那就先来看看没有 Server 端的 App 应用如何使用授权码许可类型. 在一个没有 Server 端支持的纯 App 应用中, 首先想到的是, 如何可以像 Web 服务那样, 让请求和响应&quot;来去自如&quot;呢.</p> <p>你可能会想, 是不是可以将一个&quot;迷你&quot;的 Web 服务器嵌入到 App 里面去, 这样不就可以像 Web 应用那样来使用 OAuth 2.0 了么? 确实这是行得通的, 而且已经有 App 这样做了.</p> <p>这样的 App 通过监听运行在 localhost 上的 Web 服务器 URI, 就可以做到跟普通的 Web 应用一样的通信机制. 但这种方式不是这次要讲的重点. 因为当使用这种方式的时候, 请求访问令牌时需要的 app_secret 就只能保存在用户本地设备上, 而这并不是建议的做法.</p> <p><strong>问题的关键在于如何保存 app_secret</strong>, 因为 App 会被安装在成千上万个终端设备上, app_secret 一旦被破解, 就将会造成灾难性的后果. 如果不用 app_secret, 也能在授权码流程里换回访问令牌 access_token, 不就可以了吗?</p> <p>确实可以, 但新的问题也来了. 在授权码许可类型的流程中, 如果没有了 app_secret 这一层的保护, 那么通过授权码 code 换取访问令牌的时候, 就只有授权码 code 在&quot;冲锋陷阵&quot;了. 这时, 授权码 code 一旦失窃, 就会带来严重的安全问题. 那么, 既不使用 app_secret, 还要防止授权码 code 失窃, 有什么好的方法吗?</p> <p>有, OAuth 2.0 里面就有这样的指导方法. 这个方法就是将要介绍的 <strong>PKCE 协议</strong>, 全称是 Proof Key for Code Exchange by OAuth Public Clients.</p> <p>在下面的流程图中, 为了突出<strong>第三方软件使用 PKCE 协议时与授权服务之间的通信过程</strong>, 这里省略了受保护资源服务和资源拥有者的角色:</p> <p><img src="/img/23bc1fa619dc035eab6b09e8799c61f0-20230729094013-zir5c2b.png" alt="" title="使用PKCE协议的流程图"></p> <p>下面分析下这个流程中的重点.</p> <p>首先, App 自己要生成一个随机的, 长度在 43 ~ 128 字符之间的, 参数为 <strong>code_verifier</strong> 的字符串验证码; 接着再利用这个 <strong>code_verifier, <strong>​</strong></strong>**来生成一个被称为 &quot;挑战码&quot; 的参数 **<strong><strong>​</strong>code_challenge</strong>.</p> <p>那怎么生成这个 code_challenge 的值呢? OAuth 2.0 规范里面给出了两种方法, 就是看 code_challenge_method 这个参数的值:</p> <ol><li>一种 code_challenge_method=plain, 此时 code_verifier 的值就是 code_challenge 的值;</li> <li>另外一种 code_challenge_method=S256, 就是将 code_verifier 值进行 ASCII 编码之后再进行哈希, 然后再将哈希之后的值进行 BASE64-URL 编码, 如下代码所示.</li></ol> <div class="language-java line-numbers-mode"><pre class="language-java"><code>code_challenge <span class="token operator">=</span> <span class="token constant">BASE64URL</span><span class="token operator">-</span><span class="token function">ENCODE</span><span class="token punctuation">(</span><span class="token function">SHA256</span><span class="token punctuation">(</span><span class="token function">ASCII</span><span class="token punctuation">(</span>code_verifier<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>这两个值跟授权码流程有什么关系, 又怎么利用它们?</p> <p>授权码流程简单概括起来有两步, 第一步是获取授权码 code, 第二步是用 app_id + app_secret + code 获取访问令牌 access_token. 刚才的&quot;目标&quot;不是设想不使用 app_secret, 但同时又能保证授权码流程的安全性么?</p> <p>没错. code_verifier 和 code_challenge 这两个参数, 就是来实现这个&quot;目标&quot;的.</p> <p>在<strong>第一步获取授权码 code 的时候, 使用 code_challenge</strong> 参数. 需要注意的是, 要同时将 code_challenge_method 参数也传过去, 目的是让授权服务知道生成 code_challenge 值的方法是 plain 还是 S256.</p> <div class="language-http line-numbers-mode"><pre class="language-http"><code><span class="token header"><span class="token header-name keyword">https</span><span class="token punctuation">:</span><span class="token header-value">//authorization-server.com/auth?</span></span>
response_type=code&amp;
app_id=APP_ID&amp;
redirect_uri=REDIRECT_URI&amp;
code_challenge=CODE_CHALLENGE&amp;
code_challenge_method=S256
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>在<strong>第二步获取访问令牌的时候, 使用 code_verifier 参数</strong>, 授权服务此时会将 code_verifier 的值进行一次运算. 那怎么运算呢? 就是上面 code_challenge_method=S256 的这种方式.</p> <p>没错, 第一步请求授权码的时候, 已经告诉授权服务生成 code_challenge 的方法了. 所以在第二步的过程中, 授权服务将运算的值跟第一步接收到的值做比较, 如果相同就颁发访问令牌.</p> <div class="language-http line-numbers-mode"><pre class="language-http"><code>POST https://api.authorization-server.com/token?
grant_type=authorization_code&amp;
code=AUTH_CODE_HERE&amp;
redirect_uri=REDIRECT_URI&amp;
app_id=APP_ID&amp;
code_verifier=CODE_VERIFIER
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>现在就知道了如何使用 code_verifier 和 code_challenge 这两个参数. 总结一下就是, <strong>换取授权码 code 的时候, 使用 code_challenge 参数值; 换取访问令牌的时候, 使用 code_verifier 参数值</strong>. 那么为什么要这样做? 下面来分析一下.</p> <p>我们的目标是没有 Server 端的手机 App, 也可以使用授权码许可流程. app_secret 不能用, 因为它只能被存在用户的设备上, 担心被泄露. 那么, 在没有了 app_secret 这层保护的前提下, 即使授权码 code 被截获, 再加上 code_challenge 也同时被截获了, 那也没有办法由 code_challenge 逆推出 code_verifier 的值. 而恰恰在第二步换取访问令牌的时候, 授权服务需要的就是 code_verifier 的值. 因此这也就<strong>避免了访问令牌被恶意换取的安全问题</strong>.</p> <p>现在, 可以通过 PKCE 协议的帮助, 让没有 Server 端的 App 也能够安全地使用授权码许可类型进行授权了. 但是, 按照 OAuth 2.0 的规范建议, <strong>通过后端通信来换取访问令牌是较为安全的方式</strong>. 所以还是尽量搞个服务端.</p> <h5 id="_2-有server端的app"><a href="#_2-有server端的app" class="header-anchor">#</a> 2.有Server端的App</h5> <p>接入微信登录时, 可以在微信的官方文档上看到下面这句话:</p> <blockquote><p>微信 OAuth 2.0 授权登录目前支持 authorization_code 模式, 适用于拥有 Server 端的应用授权.</p></blockquote> <p>没错, 微信的 OAuth 2.0 授权登录, 就是建议需要一个 Server 端来支持这样的授权接入.</p> <p>那么, 有 Server 端支持的 App 又是如何使用 OAuth 2.0 的授权码许可流程的呢?</p> <p>仍以微信登录为例, 看一下官方的流程图:</p> <p><img src="/img/44553fc2ee3a8fee58cc30e99334cbe6-20230729094013-bgmrdri.png" alt="" title="微信登录流程图"></p> <p>看到这个图, 是不是觉得特别熟悉, <strong>跟普通的授权码流程没有区别</strong>, 仍是两步走的策略: <mark><strong>第一步换取授权码 code, 第二步通过授权码 code 换取访问令牌 access_token</strong></mark>.</p> <p>这里的第三方应用, 就是作为开发者来开发的应用, 包含了移动 App 和 Server 端. 将其细化得到下面这张图:</p> <p><img src="/img/9bfce2629086662cb6d568be8afad6a7-20230729094013-9yawhlo.png" alt="" title="有Server端的App的授权流程"></p> <p><strong>从上图就会发现有 Server 端的 App 在使用授权码流程的时候, 跟普通的 Web 应用几乎没有任何差别.</strong></p> <p>大概流程是: 当访问第三方 App 的时候, <strong>需要用到微信来登录; 第三方 App 可以拉起微信的 App</strong>, 用户会在微信的 App 里面进行登录及授权; <strong>微信 Server 端验证成功之后会返回一个授权码 code, 通过微信 App 传递给了第三方 App</strong>; 后面的流程就是熟悉的<strong>使用授权码 code 和 app_secret, 换取访问令牌 access_token 的值</strong>了.</p> <p><strong>这次使用 app_secret 的时候, 是在第三方 App 的 Server 端来使用的, 因此安全性上没有任何问题.</strong></p> <h5 id="_3-总结-2"><a href="#_3-总结-2" class="header-anchor">#</a> 3.总结</h5> <p>本节重点讲了两块内容, 没有 Server 端的 App 和有 Server 端的 App 分别是如何使用授权码许可类型的.</p> <p>本节需要记住以下两点内容.</p> <ul><li>使用 OAuth 2.0 协议的目的, 就是要起到安全性的作用, 但有些时候, 因为使用不当反而会造成更大的安全问题, 比如将 app_secret 放入 App 中的最基本错误. 如果放弃了 app_secret, 又是如何让没有 Server 端的 App 安全地使用授权码许可协议呢? 针对这种情况, <strong>本节介绍了 PKCE 协议</strong>. 它是一种在失去 app_secret 保护的时候, 防止授权码失窃的解决方案.</li> <li>建议在开发移动 App 的时候, 尽可能地都要搭建一个 Server 端, <strong>因为通过后端通信来传输访问令牌比通过前端通信传输要安全得多</strong>. 很多官方的开放平台在提供 OAuth 2.0 服务的时候, 都会建议开发者要有一个相应的 Server 端.</li></ul> <h4 id="实践oauth-2-0时-使用不当可能会导致哪些安全漏洞"><a href="#实践oauth-2-0时-使用不当可能会导致哪些安全漏洞" class="header-anchor">#</a> 实践OAuth 2.0时, 使用不当可能会导致哪些安全漏洞?</h4> <p>关于 OAuth 2.0 的使用还有哪些<strong>安全方面的防范措施</strong>是要注意的呢, 本节将会进行介绍.</p> <p>当知道这一讲的主题是 OAuth 2.0 的安全漏洞时, 你可能要问了: <strong>OAuth 2.0 不是一种安全协议吗, 不是保护 Web API 的吗? 为啥 OAuth 2.0 自己还有安全的问题?</strong></p> <p>首先, OAuth 2.0 的确是一种安全协议. 这没啥问题, 但是它有很多使用规范, 比如授权码是一个临时凭据只能被使用一次, 要对重定向 URI 做校验等. 那么如果使用的时候没有按照这样的规范来实施, 就会有安全漏洞了. 其次, OAuth 2.0 既然是生长在互联网这个大环境中, 就一样会面对互联网上常见安全风险的攻击, 比如跨站请求伪造(Cross-site request forgery, CSRF), 跨站脚本攻击(Cross Site Scripting, XSS). 最后, 除了这些常见攻击类型外, OAuth 2.0 自身也有可被利用的安全漏洞, 比如授权码失窃, 重定向 URI 伪造.</p> <p>所以<strong>在实践 OAuth 2.0 的过程中, 安全问题一定是重中之重</strong>. 下面挑选了 5 个典型的安全问题, <strong>其中 CSRF, XSS, 水平越权这三种是互联网环境下常见的安全风险, 授权码失窃和重定向 URI 被篡改属于 OAuth2.0 专属的安全风险</strong>.</p> <p>接下来看看这些安全风险的由来, 以及如何应对.</p> <h5 id="_1-csrf攻击"><a href="#_1-csrf攻击" class="header-anchor">#</a> 1.CSRF攻击</h5> <p>对于 CSRF 的定义, 《OAuth 2 in Action》这本书里的解释非常贴切: 恶意软件让浏览器向<strong>已完成用户身份认证</strong>的网站发起请求, 并<strong>执行有害的操作</strong>, 就是跨站请求伪造攻击.</p> <p>它是互联网上最为常见的攻击之一. 在实践 OAuth2.0 的过程, 其实就是在构建一次互联网的应用. 因此, OAuth 2.0 同样也会面临这个攻击. 接下来通过一个案例来说明这个攻击类型.</p> <p>有一个软件 A, 让它来扮演攻击者, 让它的开发者按照正常的流程使用极客时间. 当该攻击者授权后, 拿到<strong>授权码的值 codeA</strong> 之后, &quot;立即按下了暂停键&quot;, 不继续往下走了. 那它想干啥呢, 继续往下看.</p> <p>这时, <strong>有一个第三方软件 B, 比如 Web 版极客时间, 来扮演受害者吧. <strong>​</strong></strong>**当然最终的受害者是用户, 这里是用 Web 版极客时间来作为被软件 A 攻击的对象******​ **. **</p> <p>极客时间用于接收授权码的回调地址为 <code>https://time.geekbang.org/callback</code>​. 有一个用户 G 已经在极客时间的<strong>平台登录, 且对极客时间进行了授权</strong>, 也就是用户 G 已经在极客时间平台上有登录态了.</p> <p>如果此时攻击者软件 A, 在自己的网站上构造了一个恶意页面:</p> <div class="language-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">src</span> <span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>https://time.geekbang.org/callback?code=codeA<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>如果这个时候用户 G 被攻击者软件 A 诱导而点击了这个恶意页面, 那结果就是, <strong>极客时间使用 codeA 值去继续 OAuth 2.0 的流程了</strong>. 这其实就走完了一个 CSRF 攻击的过程, 如下图所示:</p> <p><img src="/img/4b1545fa517a76bd576427792ded9bff-20230729094013-f71bs88.png" alt="" title="CSRF攻击过程"></p> <p>如果将 OAuth 2.0 用于了身份认证, 那么就会造成严重的后果, 因为用户 G 使用的极客时间的<strong>授权上下文环境</strong>跟攻击者软件 A 的<strong>授权上下文环境</strong>绑定在了一起. 为了解释两个上下文环境绑定在一起可能带来的危害, 还是拿极客时间来举例.</p> <p>假如极客时间提供了用户账号和微信账号做绑定的功能, 也就是说用户先用自己的极客时间的账号登录, 然后可以绑定微信账号, 以便后续可以使用微信账号来登录. 在绑定微信账号的时候, 微信会咨询你是否给极客时间授权, 让它获取你在微信上的个人信息. 这时候就需要用到 OAuth 2.0 的授权流程.</p> <p>如果攻击者软件 A, 通过自己的极客时间账号事先做了上面的绑定操作, 也就是<strong>说攻击者已经可以使用自己的微信账号来登录极客时间</strong>了. 如果软件 A 想要&quot;搞事情&quot;了, 便在发起了一个<strong>授权请求后构造了一个攻击页面</strong>, 里面包含的模拟代码正如上面描述的那样, 来诱导用户 G 点击.</p> <p>而用户 G 已经用极客时间的账号登录了极客时间, 此时正要去做跟微信账号的绑定. 如果这个时候他刚好点击了攻击者 A &quot;种下&quot;的这个恶意页面, 那么<strong>后面换取授权的访问令牌 access_token, 以及通过 accces_token 获取的信息就都是攻击者软件 A 的</strong>了.</p> <p>这就相当于, <strong>用户 G 将自己的极客时间的账号跟攻击者软件 A 的微信账号绑定在了一起</strong>. 这样一来, 后续攻击者软件 A 就能够通过自己的微信账号, 来登录用户 G 的极客时间了. 这个后果可想而知.</p> <p>那如何避免这种攻击呢? 方法也很简单, 实际上 OAuth 2.0 中也有这样的建议, 就是<mark><strong>使用 state 参数</strong></mark>, 它是一个随机值的参数.</p> <p>还是以上面的场景为例, <strong>当极客时间请求授权码的时候附带一个自己生成 state 参数值, 同时授权服务也要按照规则将这个随机的 state 值跟授权码 code 一起返回给极客时间</strong>. 这样, 当极客时间接收到授权码的时候, 就要在极客时间这一侧做一个 state 参数值的比对校验, 如果相同就继续流程, 否则直接拒绝后续流程.</p> <p>在这样的情况下, 软件 A 要想再发起 CSRF 攻击, 就必须另外构造一个 state 值, 而这个 state 没那么容易被伪造. 这本就是一个随机的数值, 而且在生成时就遵从了被 &quot;猜中&quot; 的概率要极小的建议. 比如, 生成一个 6 位字母和数字的组合值, 显然要比生成一个 6 位纯数字值被 &quot;猜中&quot; 的概率要小. 所以, 软件 B 通过使用 state 参数, 就实现了一个基本的防跨站请求伪造保护.</p> <p>再来总结下, 这个攻击过程本质上就是, <strong>软件 A(攻击者)用自己的授权码 codeA 的值, 通过 CSRF 攻击, &quot;替换&quot; 了软件 B 的授权码的值</strong>.</p> <h5 id="_2-xss攻击"><a href="#_2-xss攻击" class="header-anchor">#</a> 2.XSS攻击</h5> <p><strong>XSS 攻击的主要手段是将恶意脚本注入到请求的输入中, 攻击者可以通过注入的恶意脚本来进行攻击行为, 比如搜集数据等</strong>. 推荐看看《XSS 攻击原理分析与防御技术》这篇文章, 它很清晰地分析了 XSS 的原理以及防御方法. 这里主要看看它是怎么在 OAuth 2.0 的流程中&quot;发挥&quot;的.</p> <p><strong>当请求抵达受保护资源服务时, 系统需要做校验, 比如第三方软件身份合法性校验, 访问令牌 access_token 的校验, 如果这些信息都不能被校验通过, 受保护资源服务就会返回错误的信息</strong>.</p> <p><img src="/img/97538156d69d95385ae8522fb4461791-20230729094013-688apzq.png" alt="" title="XSS攻击过程"></p> <p>大多数情况下, <strong>受保护资源都是把输入的内容, 比如 app_id invalid, access_token invalid, 再回显一遍, 这时就会被 XSS 攻击者捕获到机会</strong>. 试想下, 如果攻击者传入了一些恶意的, 搜集用户数据的 JavaScript 代码, 受保护资源服务直接原路返回到用户的页面上, 那么<strong>当用户触发到这些代码的时候就会遭受到攻击</strong>.</p> <p>因此, 受保护资源服务就需要对这类 XSS 漏洞做修复, 而具体的修复方法跟其它网站防御 XSS 类似, 最简单的方法就是<mark><strong>对此类非法信息做转义过滤</strong></mark>, 比如对包含<code>&lt;script&gt;</code>​, <code>&lt;img&gt;</code>​, <code>&lt;a&gt;</code>​等标签的信息进行转义过滤.</p> <p>CSRF 攻击, XSS 攻击应该是所有 Web 系统都需要共同防范的. 在实施 OAuth 2.0 架构的时候, 也一定要考虑到这层防护, 否则就会给用户造成伤害.</p> <h5 id="_3-水平越权"><a href="#_3-水平越权" class="header-anchor">#</a> 3.水平越权</h5> <p><mark><strong>水平越权是指, 在请求受保护资源服务数据的时候, 服务端应用程序未校验这条数据是否归属于当前授权的请求用户</strong></mark>. 这样不法者用自己获得的授权来访问受保护资源服务的时候, 就<strong>有可能获取其他用户的数据</strong>, 导致水平越权漏洞问题的发生. 攻击者可越权的操作有增加, 删除, 修改和查询, 无论更新操作还是查询操作都有相当的危害性.</p> <p>还是看一个具体的例子. 以小兔打单软件为例, 第三方开发者开发了这款打单软件, 目前有两个商家 A 和商家 B 购买并使用. 现在小兔打单软件上面提供了根据订单 ID 查询订单数据的功能, 如下图所示.</p> <p><img src="/img/ec93273b8aaf49c2c641b7b51459f85b-20230729094013-mpvetgj.png" alt="" title="水平越权发生场景"></p> <p>商家 A 和商家 B 分别给小兔打单软件应用做了授权, 也就是说, 小兔打单软件可以获取商家 A 和商家 B 的订单数据. 此时没有任何问题, **那么商家 A 可以获取商家 B 的订单数据吗? ** 答案是, <strong>极有可能的</strong>.</p> <p>在开放平台环境下, <strong>授权关系的校验是由一般由开放网关这一层来处理, 因为受保护资源服务会散落在各个业务支持部门</strong>. 请求数据通过开放网关之后由访问令牌 access_token 获取了用户的身份, 比如商家 ID, 就会透传到受保护资源服务, 也就是上游接口提供方的系统.</p> <p>此时, <strong>如果受保护资源服务没有对商家 ID 和订单 ID 做归属判断, 就有可能发生商家 A 获取商家 B 订单数据的问题, 造成水平越权问题</strong>.</p> <p><img src="/img/9328d4e530b61f56fb372d71c35d2ca4-20230729094013-hzmzi3u.png" alt="" title="水平越权示例图"></p> <p><strong>发生水平越权问题的根本原因, 还是开发人员的认知与意识不够</strong>. 如果认知与意识跟得上, 那在设计之初增加归属关系判断, 比如上面提到的订单 ID 和商家 ID 的归属关系判断, 就能在很大程度上避免这个漏洞.</p> <p>同时, 在开放平台环境下, 由于开放网关和数据接口提供方来自不同的业务部门, 防止水平校验的逻辑处理很容易被遗漏:</p> <ol><li>一方面, 开放网关的作用是将用户授权之后的访问令牌 access_token 信息转换成真实的用户信息, 比如上面提到的商家 ID, 然后传递到接口提供方, 数据归属判断逻辑只能在接口提供方内部处理;</li> <li>另一方面, 数据提供方往往会认为开放出的接口是被&quot;跟自己一个公司的系统所调用的&quot;, 容易忽略水平校验的逻辑处理.</li></ol> <p>所以在开放平台环境下, 就要更加重视与防范数据的越权问题.</p> <p>以上, CSRF 攻击, XSS 攻击, 水平越权这三种攻击类型, 它们都属于 OAuth 2.0 面临的互联网非常常见的通用攻击类型.</p> <h5 id="_4-授权码失窃"><a href="#_4-授权码失窃" class="header-anchor">#</a> 4.授权码失窃</h5> <p>接下来再看两种 OAuth 2.0 <strong>专有的安全攻击, 分别是授权码失窃, 重定向 URI 被篡改</strong>.</p> <p>举个例子, 先来看看授权码失窃这个场景. 如果第三方软件 A 有合法的 app_id 和 app_secret, 那么当它去请求访问令牌的时候, 也是合法的. 这个时候没有任何问题.</p> <p>如果有一个用户 G 对第三方软件 B, 比如极客时间, <strong>进行授权并产生了一个授权码 codeB</strong>, 但并没有对攻击者软件 A 授权. 此时, 软件 A 是不能访问用户 G 的所有数据的. 但这时, 如果软件 A 获取了这个 codeB, 是不是就能够在没有获得用户 G 授权的情况下访问用户 G 的数据了? 整个过程如下图所示.</p> <p><img src="/img/038f2fa53b40f965b7ca5dbfa97bf7ec-20230729094013-boljetl.png" alt="" title="授权码失窃攻击过程"></p> <p>**这时问题的根源就在于两点: **</p> <ol><li>**授权服务在进行授权码校验的时候, 没有校验 app_id_B; **</li> <li>**软件 B(也就是极客时间)使用过一次 codeB 的值之后, 授权服务没有删除这个 codeB; **</li></ol> <p>看到这里, 通过校验 app_id_B, 并删除掉使用过一次的授权码及其对应的访问令牌, 就可以从根本上来杜绝授权码失窃带来的危害了.</p> <h5 id="_5-重定向uri被篡改"><a href="#_5-重定向uri被篡改" class="header-anchor">#</a> 5.重定向URI被篡改</h5> <p>说到这里, 授权码到底是怎么失窃的? 下面介绍的就是授权码失窃的可能的方法之一, 这也是 OAuth 2.0 中因重定向 URI 校验方法不当而遭受到的一种危害. 这种安全攻击类型, 就是重定向 URI 被篡改.</p> <p>有的时候, <strong>授权服务提供方并没有对第三方软件的回调 URI 做完整性要求和完整性校验</strong>. 比如, 第三软件 B 极客时间的详细回调 URI 是 <code>https://time.geekbang.org/callback</code>​, 那么在完整性校验缺失的情况下, 只要以 <code>https://time.geekbang.org</code>​ 开始的回调 URI 地址, 都会被认为是合法的.</p> <p>此时, 如果黑客在 <code>https://time.geekbang.org/page/</code>​ 下, 创建了一个页面 <strong>hacker.html</strong>. 这个页面的内容可以很简单, 其目的就是让请求能够抵达攻击者的服务.</p> <div class="language-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">src</span> <span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>https://clientA.com/catch<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>好了, 继续看下接下来的攻击流程:</p> <p>首先, 黑客将构造的攻击页面放到对应的 hacker.html 上, 也就是 <code>https://time.geekbang.org/page/hacker.html</code>​ 上 , 同时构造出了一个新的重定向 URI, 即 <code>https://time.geekbang.org/page/welcome/back.html../hacker.html</code>​.</p> <p>然后, 黑客利用一些钓鱼手段诱导用户, 去点击下面的这个地址:</p> <div class="language-http line-numbers-mode"><pre class="language-http"><code><span class="token header"><span class="token header-name keyword">https</span><span class="token punctuation">:</span><span class="token header-value">//oauth-server.com/auth?respons_type=code&amp;client_id=CLIENTID&amp;redirect_uri=https://time.geekbang.org/page/welcome/back.html../hacker.html</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>这样当授权服务做出响应进行重定向请求的时候, <strong>授权码 code 就返回到了 hacker.html 这个页面</strong>上.</p> <p>最后, 黑客在 <code>https://clientA.com/catch</code>​ 页面上, 解析 Referrer 头部就会得到<strong>用户的授权码</strong>, 继而就可以像授权码失窃的场景中那样去换取访问令牌了.</p> <p>看到这里就知道了, 如果授权服务要求的回调 URI 是 <code>https://time.geekbang.org/callback</code>​, 并做了回调 URI 的完整性校验, 那么被篡改之后的回调地址 <code>https://time.geekbang.org/page/welcome/back.html../hacker.html</code>​ 就不会被授权服务去发起重定向请求.</p> <p>严格来讲, 要发生这样的漏洞问题, 条件还是比较苛刻的. 只要在授权服务验证第三方软件的请求时做了签名校验, 那么攻击者在只拿到授权码 code 的情况下, 仍然无法获取访问令牌, 因为第三方软件只有通过访问令牌才能够访问用户的数据.</p> <h5 id="_6-总结-2"><a href="#_6-总结-2" class="header-anchor">#</a> 6.总结</h5> <p>本节需要记住以下三个知识点:</p> <ul><li>互联网场景的安全攻击类型比如 CSRF, XSS 等, 在 OAuth 2.0 中一样要做防范, 因为 OAuth 2.0 本身就是应用在互联网场景中.</li> <li>除了常见的互联网安全攻击, OAuth 2.0 也有自身的安全风险问题, 比如授权码失窃, 重定向 URI 被篡改. 这些安全问题, 本身从攻击的 &quot;技术含量&quot; 上并不高, 但导致这些安全风险的因素, 往往就是<strong>开发人员的安全意识不够</strong>. 比如, 没有意识到水平越权中的数据归属逻辑判断, 需要加入到代码逻辑中.</li> <li>其实, OAuth 2.0 的规范里面对这些安全问题都有对应的规避方式, 但都要求使用的时候一定要非常严谨. 比如, 重定向 URI 的校验方式, 规范里面是允许模糊校验的, 但在结合实际环境的时候, 又必须做到精确匹配校验才可以保障 OAuth 2.0 流转的安全性.</li></ul> <p>本节思维导图如下:</p> <p><img src="/img/9744c3c92a4e3c726be369ba423b39d5-20230729094013-ll8jft7.png" alt=""></p> <h4 id="实战-利用oauth-2-0实现一个openid-connect用户身份认证协议"><a href="#实战-利用oauth-2-0实现一个openid-connect用户身份认证协议" class="header-anchor">#</a> 实战-利用OAuth 2.0实现一个OpenID Connect用户身份认证协议</h4> <p>如果你是一个第三方软件开发者, 在实现用户登录的逻辑时, 除了可以让用户新注册一个账号再登录外, 还可以接入微信, 微博等平台, 让用户使用自己的微信, 微博账号去登录. 同时, <strong>如果你的应用下面又有多个子应用, 还可以让用户只登录一次就能访问所有的子应用, 来提升用户体验</strong>.</p> <p>这就是<strong>联合登录和单点登录</strong>了. 再继续深究, 它们其实都是 <strong>OpenID Connect(简称 OIDC)的应用场景</strong>的实现. 那 OIDC 又是什么呢?</p> <p><strong>本节就来学习下 OIDC 和 OAuth 2.0 的关系, 以及如何用 OAuth 2.0 来实现一个 OIDC 用户身份认证协议.</strong></p> <h5 id="_1-oidc是什么"><a href="#_1-oidc是什么" class="header-anchor">#</a> 1.OIDC是什么?</h5> <p>OIDC 其实就是一种<strong>用户身份认证的开放标准</strong>. 使用微信账号登录极客时间的场景, 就是这种开放标准的实践.</p> <p>说到这里可能要发问了: &quot;不对呀, 使用微信登录第三方 App 用的不是 OAuth 2.0 开放协议吗, 怎么又扯上 OIDC 了?&quot;</p> <p>**没错, 用微信登录某第三方软件, 确实使用的是 OAuth 2.0. 但 OAuth2.0 是一种授权协议, 而不是身份认证协议. **​<mark><strong>OIDC 才是身份认证协议, 而且是基于 OAuth 2.0 来执行用户身份认证的互通协议. 更概括地说, OIDC 就是直接基于 OAuth 2.0 构建的身份认证框架协议</strong></mark>​ **. **</p> <p>换种表述方式, <strong>==OIDC = 授权协议 + 身份认证==</strong>, 是 OAuth 2.0 的超集. 为方便理解, 可以把 OAuth 2.0 理解为面粉, 把 OIDC 理解为面包. 这就容易理解它们的关系了. 因此, 说 &quot;第三方 App 使用微信登录用到了 OAuth 2.0&quot; 没有错, 说 &quot;使用到了 OIDC&quot; 更没有错.</p> <p>考虑到<strong>单点登录, 联合登录, 都遵循的是 OIDC 的标准流程</strong>, 因此本节就讲讲如何利用 OAuth2.0 来实现一个 OIDC. 掌握了这一点, 再去做单点登录, 联合登录的场景, 以及其他更多关于身份认证的场景, 就都不再是问题了.</p> <h5 id="_2-oidc和oauth-2-0的角色对应关系"><a href="#_2-oidc和oauth-2-0的角色对应关系" class="header-anchor">#</a> 2.OIDC和OAuth 2.0的角色对应关系</h5> <p>说到 &quot;如何利用 OAuth 2.0 来构建 OIDC 这样的认证协议&quot;, 可以想到一个切入点, 这个切入点就是 OAuth 2.0 的四种角色.</p> <p>OAuth 2.0 的授权码许可流程的运转, <strong>需要资源拥有者, 第三方软件, 授权服务, 受保护资源这 4 个角色间的顺畅通信, 配合才能够完成</strong>. 如果要想在 OAuth 2.0 的授权码许可类型的基础上来构建 OIDC 的话, 这 4 个角色仍然要继续发挥 &quot;它们的价值&quot;. 这 4 个角色又是怎么对应到 OIDC 中的参与方的?</p> <p>那么就先想想一个关于身份认证的协议框架, 应该有什么角色. 它<mark><strong>需要一个登录第三方软件的最终用户, 一个第三方软件, 以及一个认证服务来为这个用户提供身份证明的验证判断</strong></mark>.</p> <p>没错, 这就是 OIDC 的<strong>三个主要角色</strong>了. 在 OIDC 的官方标准框架中, 这三个角色的名字是:</p> <ol><li><mark>**EU(End User), 代表最终用户. **</mark></li> <li><mark>**RP(Relying Party), 代表认证服务的依赖方, 就是上面提到的第三方软件. **</mark></li> <li><mark>**OP(OpenID Provider), 代表提供身份认证服务方. **</mark></li></ol> <p>EU, RP 和 OP 这三个角色对于 OIDC 非常重要, 后面也会时常使用简称来描述.</p> <p>现在很多 App 都接入了微信登录, 那么<strong>微信登录就是一个大的身份认证服务(OP)</strong> . 一旦有了微信账号, 就可以<strong>登录所有接入了微信登录体系的 App(RP)</strong> , 这就是常说的<strong>联合登录</strong>.</p> <p>现在就借助极客时间的例子, 来看一下 OAuth 2.0 的 4 个角色和 OIDC 的 3 个角色之间的对应关系:</p> <p><img src="/img/09954f272a4692cfad2e70d1f93f61ff-20230729094013-xwwgyww.png" alt="" title="OAuth 2.0和OIDC的角色对应关系"></p> <h5 id="_3-oidc和oauth-2-0的关键区别"><a href="#_3-oidc和oauth-2-0的关键区别" class="header-anchor">#</a> 3.OIDC和OAuth 2.0的关键区别</h5> <p>看到这张角色对应关系图, 是不是有点恍然大悟的感觉: <strong>要实现一个 OIDC 协议, 不就是直接实现一个 OAuth 2.0 协议吗</strong>. 没错, <strong>OIDC 就是基于 OAuth 2.0 来实现的一个身份认证协议框架</strong>.</p> <p>再画一张 OIDC 的通信流程图, 就更清楚 OIDC 和 OAuth 2.0 的关系了:</p> <p><img src="/img/c4d079b624afbdce7ffdecb2e40a9a2a-20230729094013-vjx4vst.png" alt="" title="基于授权码流程的OIDC通信流程"></p> <p><mark>可以发现, 一个基于授权码流程的 OIDC 协议流程, 跟 OAuth 2.0 中的授权码许可的流程几乎完全一致, 唯一的区别就是多返回了一个 </mark>​<mark><strong>ID_TOKEN</strong></mark>​<mark>, 称之为 </mark>​<mark><strong>ID 令牌</strong></mark>​<mark>. 这个令牌是身份认证的关键</mark>.</p> <p>所以接下来就着重讲一下这个令牌, 而不再细讲 OIDC 的整个流程.</p> <h6 id="_1-oidc中的id令牌生成和解析方法"><a href="#_1-oidc中的id令牌生成和解析方法" class="header-anchor">#</a> (1)OIDC中的ID令牌生成和解析方法</h6> <p>前面 OIDC 通信流程的第 6 步, 可以看到 <strong>ID 令牌(ID_TOKEN)和访问令牌(ACCESS_TOKEN)是一起返回</strong>的. 关于为什么要同时返回两个令牌, 后面再详细分析. 先把焦点放在 ID 令牌上.</p> <p><mark>**我们知道, 访问令牌不需要被第三方软件解析, 因为它对第三方软件来说是不透明的. 但 ID 令牌需要能够被第三方软件解析出来, 因为第三方软件需要获取 ID 令牌里面的内容, 来处理用户的登录态逻辑. **</mark></p> <p>那 <strong>ID 令牌的内容是什么呢</strong>?</p> <p>首先, <strong>ID 令牌是一个 JWT 格式的令牌</strong>. 这里需要强调的是, 虽然 JWT 令牌是一种自包含信息体的令牌, 为将其作为 ID 令牌带来了方便性, 但是因为 ID 令牌需要能够标识出用户, 失效时间等属性来达到身份认证的目的, 所以要将其作为 OIDC 的 ID 令牌时, 下面这 5 个 <strong>JWT 声明参数</strong>也是必须要有的.</p> <ol><li><strong>iss</strong>: 令牌的颁发者, 其值就是身份认证服务(OP)的 URL.</li> <li><strong>sub</strong>: 令牌的主题, 其值是一个能够代表最终用户(EU)的全局唯一标识符.</li> <li><strong>aud</strong>: 令牌的目标受众, 其值是三方软件(RP)的 app_id.</li> <li><strong>exp</strong>: 令牌的到期时间戳, 所有的 ID 令牌都会有一个过期时间.</li> <li><strong>iat</strong>: 颁发令牌的时间戳.</li></ol> <p>生成 ID 令牌这部分的示例代码如下:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// GENATE ID TOKEN</span>
<span class="token class-name">String</span> id_token <span class="token operator">=</span> <span class="token function">genrateIdToken</span><span class="token punctuation">(</span>appId<span class="token punctuation">,</span> user<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">private</span> <span class="token class-name">String</span> genrateIdToken <span class="token punctuation">(</span><span class="token class-name">String</span> appId<span class="token punctuation">,</span> <span class="token class-name">String</span> user<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token class-name">String</span> sharedTokenSecret <span class="token operator">=</span> <span class="token string">&quot;hellooauthhellooauthhellooauthhellooauth&quot;</span><span class="token punctuation">;</span><span class="token comment">// 秘钥</span>
    <span class="token class-name">Key</span> key <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SecretKeySpec</span><span class="token punctuation">(</span>sharedTokenSecret<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                <span class="token class-name">SignatureAlgorithm</span><span class="token punctuation">.</span><span class="token constant">HS256</span><span class="token punctuation">.</span><span class="token function">getJcaName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 采用HS256算法</span>

    <span class="token comment">// ID令牌的头部信息</span>
    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> headerMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    headerMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;typ&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;JWT&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    headerMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;alg&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;HS256&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// ID令牌的主体信息</span>
    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> payloadMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    payloadMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;iss&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;http://localhost:8081/&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    payloadMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;sub&quot;</span><span class="token punctuation">,</span> user<span class="token punctuation">)</span><span class="token punctuation">;</span>
    payloadMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;aud&quot;</span><span class="token punctuation">,</span> appId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    payloadMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;exp&quot;</span><span class="token punctuation">,</span> <span class="token number">1584105790703L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    payloadMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;iat&quot;</span><span class="token punctuation">,</span> <span class="token number">1584105948372L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token class-name">Jwts</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setHeaderParams</span><span class="token punctuation">(</span>headerMap<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setClaims</span><span class="token punctuation">(</span>payloadMap<span class="token punctuation">)</span>
               <span class="token punctuation">.</span><span class="token function">signWith</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token class-name">SignatureAlgorithm</span><span class="token punctuation">.</span><span class="token constant">HS256</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">compact</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><p>接下来, 再看看<strong>处理用户登录状态的逻辑是如何处理的</strong>.</p> <p>可以先试想一下, 如果不跟 OIDC 扯上关系, 也就是单纯构建一个用户身份认证登录系统, 是不是得<strong>保存用户登录的会话关系</strong>. 一般的做法是, 要么放在远程服务器上, 要么写进浏览器的 cookie 中, 同时为会话 ID 设置一个过期时间.</p> <p><strong>但当有了一个 JWT 这样的结构化信息体的时候, 尤其是包含了令牌的主题和过期时间后, 不就是有了一个 &quot;天然&quot; 的会话关系信息么.</strong></p> <p>所以, 依靠 JWT 格式的 ID 令牌, 就足以让解决身份认证后的<strong>登录态问题</strong>. 这也就是为什么在 OIDC 协议里面要返回 ID 令牌的原因, <mark><strong>ID 令牌才是 OIDC 作为身份认证协议的关键所在</strong></mark>.</p> <p>那么有了 ID 令牌后, 第三方软件应该如何解析它呢? 接下来看一段解析 ID 令牌的具体代码, 如下:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> parseJwt <span class="token punctuation">(</span><span class="token class-name">String</span> jwt<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token class-name">String</span> sharedTokenSecret <span class="token operator">=</span> <span class="token string">&quot;hellooauthhellooauthhellooauthhellooauth&quot;</span><span class="token punctuation">;</span><span class="token comment">// 密钥</span>
    <span class="token class-name">Key</span> key <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SecretKeySpec</span><span class="token punctuation">(</span>sharedTokenSecret<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                <span class="token class-name">SignatureAlgorithm</span><span class="token punctuation">.</span><span class="token constant">HS256</span><span class="token punctuation">.</span><span class="token function">getJcaName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// HS256算法</span>

    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Jws</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Claims</span><span class="token punctuation">&gt;</span></span> claimsJws <span class="token operator">=</span> <span class="token class-name">Jwts</span><span class="token punctuation">.</span><span class="token function">parserBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setSigningKey</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">parseClaimsJws</span><span class="token punctuation">(</span>jwt<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 解析ID令牌主体信息</span>
    <span class="token class-name">Claims</span> body <span class="token operator">=</span> claimsJws<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;sub&quot;</span><span class="token punctuation">,</span> body<span class="token punctuation">.</span><span class="token function">getSubject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;aud&quot;</span><span class="token punctuation">,</span> body<span class="token punctuation">.</span><span class="token function">getAudience</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;iss&quot;</span><span class="token punctuation">,</span> body<span class="token punctuation">.</span><span class="token function">getIssuer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;exp&quot;</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>body<span class="token punctuation">.</span><span class="token function">getExpiration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;iat&quot;</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>body<span class="token punctuation">.</span><span class="token function">getIssuedAt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> map<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>需要特别指出的是, 第三方软件解析并验证 ID 令牌的合法性之后, 不需要将整个 JWT 信息保存下来, 只需保留 JWT 中的 <strong>PAYLOAD</strong>(数据体)部分就可以了. 因为正是这部分内容, 包含了身份认证所需要的用户唯一标识等信息.</p> <p>另外, 在验证 JWT 合法性的时候, 因为 ID 令牌本身已经被身份认证服务(OP)的密钥签名过, 所以关键的一点是合法性校验时需要做签名校验.</p> <p><strong>这样当第三方软件(RP)拿到 ID 令牌之后, 就已经获得了处理身份认证标识动作的信息, 也就是拿到了那个能够唯一标识最终用户(EU)的 ID 值, 比如 3521</strong>.</p> <h6 id="_2-用访问令牌获取id令牌之外的信息"><a href="#_2-用访问令牌获取id令牌之外的信息" class="header-anchor">#</a> (2)用访问令牌获取ID令牌之外的信息</h6> <p>为了提升第三方软件对用户的友好性, 在页面上显示 &quot;您好, 3521&quot; 肯定不如显示 &quot;您好, 小明同学&quot; 的体验好. 这里的 &quot;小明同学&quot;, 就是用户的昵称.</p> <p>那如何来获取 &quot;小明同学&quot; 这个昵称呢. 这也很简单, 就是<mark><strong>通过返回的访问令牌 access_token 来重新发送一次请求</strong></mark>. 当然, 这个流程前面已经讲过, 它属于 OAuth 2.0 标准流程中的请求受保护资源服务的流程.</p> <p><strong>这也就是为什么在 OIDC 协议里面, 既要返回 ID 令牌又要返回访问令牌的原因了</strong>. <mark><strong>在保证用户身份认证功能的前提下, 如果想获取更多的用户信息, 就再通过访问令牌获取. 在 OIDC 框架里, 这部分内容叫做创建 UserInfo 端点和获取 UserInfo 信息</strong></mark>.</p> <p>这样看下来, 细粒度地去看 OIDC 的流程就是: <mark><strong>生成 ID 令牌 -&gt; 创建 UserInfo 端点 -&gt; 解析 ID 令牌 -&gt; 记录登录状态 -&gt; 获取 UserInfo</strong></mark>.</p> <p>利用 OAuth 2.0 实现一个 OIDC 框架的工作就做完了.</p> <p>总结一下, 用 OAuth 2.0 实现 OIDC 的最关键的方法是: <mark><strong>在原有 OAuth 2.0 流程的基础上增加 ID 令牌和 UserInfo 端点, 以保障 OIDC 中的第三方软件能够记录用户状态和获取用户详情的功能</strong></mark>. 因为第三方软件可以通过解析 ID 令牌的关键用户标识信息来记录用户状态, 同时可以通过 Userinfo 端点来获取更详细的用户信息. 有了用户态和用户信息, 也就理所当然地实现了一个身份认证.</p> <h5 id="_4-单点登录"><a href="#_4-单点登录" class="header-anchor">#</a> 4.单点登录</h5> <p>接下来, 就具体看看如何实现<strong>单点登录(Single Sign On, SSO)</strong> . 一个用户 G 要登录第三方软件 A, A 有三个子应用, 域名分别是 a1.com, a2.com, a3.com. 如果 A 想要为用户提供更流畅的登录体验, 让用户 G 登录了 a1.com 之后也能顺利登录其他两个域名, 就可以创建一个身份认证服务, 来支持 a1.com, a2.com 和 a3.com 的登录. 这就是单点登录, <strong>一次登录, 畅通所有</strong>.</p> <p>那么, 可以使用 OIDC 协议标准来实现这样的单点登录吗? 只能说 &quot;太可以了&quot;. 如下图所示, 只需要<strong>让第三方软件(RP)重复 OIDC 的通信流程</strong>就可以了.</p> <p><img src="/img/077f8c0992dc9943deaf4741830b20f8-20230729094013-am95gfz.png" alt="" title="单点登录的通信流程"></p> <p>所以单点登录就是 OIDC 的一种具体应用方式, 只要掌握了 OIDC 框架的原理, 实现单点登录就不在话下了. 关于单点登录的具体实现, 在 GitHub 上搜索 &quot;通过 OIDC 来实现单点登录&quot;, 就可以看到很多相关的开源内容.</p> <h5 id="_5-总结-2"><a href="#_5-总结-2" class="header-anchor">#</a> 5.总结</h5> <p>在一些较大的, 已经具备身份认证服务的平台上, 可能并没有发现 OIDC 的描述, 但大可不必纠结. 有时候, 我们可能会困惑于, <strong>到底是先有 OIDC 这样的标准, 还是先有类似微信登录这样的身份认证实现方式</strong>?</p> <p>其实, 要理解这层先后关系, 可以拿设计模式来举例. 当想设计一个较为松耦合, 可扩展的系统时, 即使没有接触过设计模式, 通过不断地尝试修改后, 也会得出一个逐渐符合了设计模式那样&quot;味道&quot;的代码架构思路. 理解 OIDC 解决身份认证问题的思路, 也是同样的道理.</p> <p>本节在 OAuth2.0 的基础上实现了一个 OIDC 的流程, 需要记住以下两点.</p> <ul><li><strong>OAuth 2.0 不是一个身份认证协议</strong>, 请一定要记住这点. 身份认证强调的是&quot;谁的问题&quot;, 而 OAuth2.0 强调的是授权, 是&quot;可不可以&quot;的问题. <mark><strong>但是可以在 OAuth2.0 的基础上, 通过增加 ID 令牌来获取用户的唯一标识, 从而就能够去实现一个身份认证协议</strong></mark>.</li> <li>有些 App 不想非常麻烦地自己设计一套注册和登录认证流程, 就会寻求统一的解决方案, 然后势必会出现一个平台来收揽所有类似的认证登录场景. 再反过来理解也是成立的. 如果有个拥有海量用户的, 大流量的访问平台, 来<strong>提供一套统一的登录认证服务</strong>, 让其他第三方应用来对接, 不就可以解决一个用户使用同一个账号来登录众多第三方 App 的问题了吗? 而 <strong>OIDC, 就是这样的登录认证场景的开放解决方案</strong>.</li></ul> <h4 id="oauth-2-0的工作流程与安全问题"><a href="#oauth-2-0的工作流程与安全问题" class="header-anchor">#</a> OAuth 2.0的工作流程与安全问题</h4> <p>本节会把已经讲过的内容再串一遍, 就像学生时代每个学期即将结束时的一次串讲, 来回顾下 OAuth 2.0 的整个<strong>知识体系</strong>.</p> <h5 id="_1-oauth-2-0工作流程串讲"><a href="#_1-oauth-2-0工作流程串讲" class="header-anchor">#</a> 1.OAuth 2.0工作流程串讲</h5> <p><img src="/img/2cd21e40ce186b58dd658a0e849a2e6e-20230729094013-n97yaeh.png" alt=""></p> <p>前面一直在讲 OAuth 2.0 是一种<strong>授权协议</strong>, 这种协议可以让第三方软件<strong>代表</strong>用户去执行被允许的操作. 那么, 第三方软件就需要向用户索取<strong>授权</strong>来获得那个令牌.</p> <p>回想下前面拜访百度王总的例子. 只有拿到前台小姐姐给你的门禁卡, 你才能够进入百度大楼. 这个过程就相当于前台小姐姐给你做了一次授权, 而这个授权的凭证就是门禁卡. 对应到我们的系统中, 门禁卡便相当于访问令牌.</p> <p>通过&quot;代表&quot;, &quot;授权&quot;这样的关键词, 可以认识到, OAuth 2.0 是一个<strong>授权协议, 也是一个安全协议</strong>. 那如果说它也是一种委托协议, 也不要吃惊.</p> <p>试想一下, 用户在微信平台上有修改昵称, 修改头像, 修改个人兴趣的权限, 当第三方软件请求让自己代表用户来操作这些权限的时候, 就是第三方软件请求用户把这些权限<strong>委托</strong>给自己, 用户在批准了委托请求之后, 才可以代表用户去执行这些操作.</p> <p>细想一下, <mark><strong>委托才是 OAuth 2.0 授权概念的根基, 因为没有&quot;委托&quot;之意就不会有&quot;代表&quot;行为的发生</strong></mark>.</p> <p>在整个课程讲述授权的过程中, 频繁举例和强调的就是<strong>授权码许可流程</strong>. 在学习授权码流程的时候, 最困惑的一点恐怕莫过于 &quot;为什么要多此一举, 非得通过一个<strong>授权码 code</strong> 来换取访问令牌 access_token&quot;. 再来分析下, 第三方软件要获取访问令牌, 只能通过两个渠道:</p> <ol><li>一个渠道是第三方软件的前端页面. 但是如果直接返回到前端页面上, 访问令牌是很容易被通过浏览器截获的, 所以显然不可取.</li> <li>另外一个渠道是通过后端传输. 第三方软件的后端和授权服务的后端之间通信, 这样就可以避免令牌被直接暴露的问题.</li></ol> <p>再往深了想, 第三方软件的后端总不能向授权服务的后端 &quot;硬要&quot; 吧, 总要告诉授权服务是要哪个用户的 access_token 吧, 所以还需要用户的参与.</p> <p>用户一旦参与进来, 访问的第一个页面是第三方软件, 用户要授权, 第三方软件就需要把用户引导到授权服务页面. 但这个时候, <strong>用户就跟第三方软件之间没有任何&quot;通信连接&quot;了</strong>. 如果授权服务通过后端通信直接将令牌给了第三方软件的后端, 那第三方软件该如何通知用户呢, 恐怕就不太好实现了.</p> <p>**这种情况下就很巧妙地引入了授权码 code: 先把 code 通过重定向返回到第三方软件的页面; 第三方软件通过浏览器获取到 code 后, 再通过后端通信换取 access_token; 待拿到 token 之后, 由于此时用户已经在第三方软件的服务上, 所以可以很容易地通知到用户. **</p> <p>以上就是授权码许可的整体工作流程了. 这是 OAuth 2.0 授权体系中最完备的流程, 其他的授权许可类型, 比如资源拥有者凭据许可, 客户端凭据许可, 隐式许可, 都是以此为基础. 因此<strong>只要能理解授权码许可的流程, 也就掌握了整个 OAuth 2.0 中所有许可类型的运转机制</strong>, 在实际工作场景中用上 OAuth 2.0 将不再是问题.</p> <h5 id="_2-oauth-2-0安全问题串讲"><a href="#_2-oauth-2-0安全问题串讲" class="header-anchor">#</a> 2.OAuth 2.0安全问题串讲</h5> <p>在实践 OAuth 2.0 的过程中, 还必须按照规范建议来执行, 否则便会引发一系列的安全问题. 这也往往导致有人会发出这样的疑问, OAuth 2.0 不是安全的吗? 它不是一直在保护着互联网上成千上万个 Web API 吗, 不也说它是一种安全协议吗?</p> <p>首先 OAuth 2.0 是安全协议没问题, 但<strong>如果使用不当也会引起安全上的问题</strong>. 比如前面提到了一个很广泛的跨站请求伪造问题. 之所以出现这样的安全问题, 就是因为没有遵循 OAuth 2.0 的使用建议, 比如没有使用 state 这样的参数来做请求的校验, 或者是没有遵循授权码 code 值只能使用一次, 并且还要清除使用过的 code 值跟 token 值之间的绑定关系的建议.</p> <p>在安全问题上, 其实一直都没有特别说明一点, 那就是<mark><strong>在使用 OAuth 2.0 的流程中, HTTP 通信要使用 HTTPS 协议来保护数据传输的安全性</strong></mark>. 这是因为 OAuth 2.0 支持的 bearer 令牌类型, 也就是任意字符串格式的令牌, 并没有提供且没有要求使用信息签名的机制.</p> <p>你可能会说, JWT 令牌有这样的加密机制啊. 但其实这也正说明了 OAuth 2.0 是一个没有约束普通令牌的规则, 所以才有了 JWT 这样对 OAuth 2.0 的额外补充. 实际上, <strong>JWT 跟 OAuth 2.0 并没有直接关系, 它只是一种结构化的信息存储, 可以被用在除了 OAuth 2.0 以外的任何地方</strong>. 比如重置密码的时候, 会给你的邮箱发送一个链接, 这个链接就需要能够标识出用户是谁, 不能篡改, 有效期 5 分钟, 这些特征都跟 JWT 相符合. 也就是说, JWT 并不是 OAuth 2.0 协议规范所涵盖的内容.</p> <p>OAuth 2.0 似乎没有自己的规则约束机制, 或者说只有比较弱的约束, 但其实不是不约束, 而是<strong>它就致力于做好授权框架这一件事儿</strong>.</p> <p><strong>除此之外, OAuth 2.0 都是用开放的心态来提供基础的支持</strong>, 比如 OpenID Connect(OIDC)身份认证协议框架. 这种开放的方式, 使得可以用 &quot;OAuth 2.0 + 另外一个技术&quot; 来变成一个新的技术. 这就是一个伟大的, 可操作的组合了, 可以解决不同场景的需求.</p> <p>也许正是因为 OAuth 2.0 可以支持类似 OIDC 这样的身份认证协议, 导致大家总是认为 OAuth 2.0 是一种身份认证协议. 当然了, <strong>OAuth 2.0 并不是身份认证协议</strong>, 前面用面粉和面包来类比 OAuth 2.0 和 OIDC 的关系.</p> <p>究竟是什么原因导致大家对 OAuth 2.0 有这样的误解呢? 大概原因是, OAuth 2.0 中确实包含了身份认证的内容, 即授权服务需要让用户登录以后才可以进行用户确认授权的操作. 但这样的流程, 仅仅是 <strong>OAuth 2.0 涉及到了身份认证的行为, 还不足以让 OAuth 2.0 成为一个真正的用户身份认证协议</strong>. 因为 OAuth 2.0 关心的只有两点, 颁发令牌和使用令牌, 并且令牌对第三方软件是不透明的; 同时, 受保护资源服务也不关心是哪个用户来请求, 只要有合法的令牌 &quot;递&quot; 过来, 就会给出正确的响应, 把数据返回给第三方软件.</p> <h5 id="_3-再强调都不为过的安全意识"><a href="#_3-再强调都不为过的安全意识" class="header-anchor">#</a> 3.再强调都不为过的安全意识</h5> <p>根据笔者在开放平台上这些年的工作经验, 安全意识是实践 OAuth 2.0 过程中, 再怎么强调都不为过的问题.</p> <p>因为总结起来, <strong>要说使用 OAuth 2.0 的过程中如果能有哪个机会让你&quot;栽个大跟头&quot;的话, 那这个机会一定是在安全上</strong>: OAuth 2.0 本就是致力于保护开放的 Web API, 保护用户在平台上的资源, 如果因为 OAuth 2.0 使用不当而造成安全问题, 确实是一件非常 丢人的事情.</p> <p>而 OAuth2.0 的<strong>流程里面能够为安全做贡献的只有两方, 一方是第三方软件, 一方是平台方</strong>. 在安全性这个问题上, 第三方软件开发者的安全意识参差不齐. 那针对这一点, 就需要平台方在其官方文档上重笔描述, 并给出常见安全漏洞相应的解决方案. 同时, 作为平台方的内部开发人员, 对安全的问题同样不能忽视, 而且要有更高的安全意识和认知.</p> <p>**只有第三方软件开发者和平台方的研发人员共同保有较高的安全意识, 才能让安全的墙垒得越来越高, 让攻击者的成本越来越高. 因为安全的本质就是成本问题. **</p> <h5 id="_4-总结-4"><a href="#_4-总结-4" class="header-anchor">#</a> 4.总结</h5> <p>本节需要记住以下三点:</p> <ul><li>OAuth 2.0 是一个授权协议, 它通过访问令牌来表示这种授权. 第三软件拿到访问令牌之后, 就可以使用访问令牌来代表用户去访问用户的数据了. 所以<strong>授权的核心就是获取访问令牌和使用访问令牌</strong>.</li> <li>OAuth 2.0 是一个安全协议, 但是<strong>如果使用不当, 它并不能保证一定是安全的</strong>. 如果不按照 OAuth 2.0 规范中的建议来实施, 就会有安全风险. 比如没有遵循授权服务中的授权码只能使用一次, 第三方软件的重定向 URL 要精确匹配等建议.</li> <li>安全防护的过程一直都是&quot;魔高一尺道高一丈&quot;, 相互攀升的过程. 因此在使用 OAuth 2.0 的过程中, 第三方软件和平台方都要有足够的安全意识, 来把安全的墙筑得更高.</li></ul> <p><strong>无论使用 OAuth 2.0 目的是保护 API, 还是作为用户身份认证的基础, OAuth 2.0 都只是解决这些问题的一种工具. 而掌握 OAuth 2.0 这种工具的原理及其使用场景, 将会帮助你更高效, 更优雅地解决这些问题.</strong></p> <h4 id="实战案例-使用spring-security搭建一套基于jwt的oauth-2-0架构"><a href="#实战案例-使用spring-security搭建一套基于jwt的oauth-2-0架构" class="header-anchor">#</a> 实战案例-使用Spring Security搭建一套基于JWT的OAuth 2.0架构</h4> <p>Spring Security 因为功能多, 组件抽象程度高, 配置方式多样, 导致了强大且复杂的特性. 也因此, Spring Security 的学习成本几乎是 Spring 家族中最高的. 但不仅于此, 在结合实际的复杂业务场景使用 Spring Security 时, 还要去理解一些组件的工作原理和流程, 不然需要自定义和扩展框架的时候就会手足无措. 这就让使用 Spring Security 的门槛更高了.</p> <p>因此, 在决定使用 Spring Security 搭建整套安全体系(授权, 认证, 权限, 审计)之前, 还需要考虑的是: <strong>将来的业务会多复杂, 徒手写一套安全体系来得划算, 还是使用 Spring Security 更好</strong>?</p> <p>反过来说, 如果应用已经使用了 Spring Security 来做鉴权, 认证和权限管理的话, 那么仍然使用 Spring Security 来实现 OAuth 的成本是很低的. 而且在学习了 OAuth 2.0 的流程打下扎实的基础之后, 再使用 Spring Security 来配置 OAuth 2.0 就不会那么迷茫了.</p> <p>本节使用 Spring Security 来一步一步地搭建一套基于 JWT 的 OAuth 2.0 授权体系. 这些内容会涉及 <strong>OAuth 2.0 的三角色(客户端, 授权服务, 受保护资源), 以及资源拥有者凭据许可, 客户端凭据许可和授权码许可这三种常用的授权许可类型</strong>(隐式许可类型, 不太安全也不太常用). 同时还会演示 OAuth 2.0 的权限控制, 以及使用 OAuth 2.0 <strong>实现 SSO 单点登录体系</strong>.</p> <h5 id="_1-项目准备工作"><a href="#_1-项目准备工作" class="header-anchor">#</a> 1.项目准备工作</h5> <p>实战之前, 先来搭建项目父依赖和初始化数据库结构, 为后面具体的编码做准备.</p> <p>首先创建一个父 POM, 内含三个模块:</p> <ol><li>springsecurity101-cloud-oauth2-client: 用来扮演<strong>客户端</strong>角色;</li> <li>springsecurity101-cloud-oauth2-server: 用来扮演<strong>授权服务器</strong>角色;</li> <li>springsecurity101-cloud-oauth2-userservice: 是用户服务, 用来扮演<strong>资源提供者</strong>角色.</li></ol> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>project</span> <span class="token attr-name"><span class="token namespace">xmlns:</span>xsi</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>http://www.w3.org/2001/XMLSchema-instance<span class="token punctuation">&quot;</span></span>
<span class="token attr-name">xmlns</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>http://maven.apache.org/POM/4.0.0<span class="token punctuation">&quot;</span></span>
<span class="token attr-name"><span class="token namespace">xsi:</span>schemaLocation</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>modelVersion</span><span class="token punctuation">&gt;</span></span>4.0.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>modelVersion</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>me.josephzhu<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>springsecurity101<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>packaging</span><span class="token punctuation">&gt;</span></span>pom<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>packaging</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.0-SNAPSHOT<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>parent</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-parent<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>2.2.1.RELEASE<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>relativePath</span><span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>parent</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>modules</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>module</span><span class="token punctuation">&gt;</span></span>springsecurity101-cloud-oauth2-client<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>module</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>module</span><span class="token punctuation">&gt;</span></span>springsecurity101-cloud-oauth2-server<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>module</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>module</span><span class="token punctuation">&gt;</span></span>springsecurity101-cloud-oauth2-userservice<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>module</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>modules</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>properties</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>project.build.sourceEncoding</span><span class="token punctuation">&gt;</span></span>UTF-8<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>project.build.sourceEncoding</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>project.reporting.outputEncoding</span><span class="token punctuation">&gt;</span></span>UTF-8<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>project.reporting.outputEncoding</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>java.version</span><span class="token punctuation">&gt;</span></span>1.8<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>java.version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>properties</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.projectlombok<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>lombok<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>optional</span><span class="token punctuation">&gt;</span></span>true<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>optional</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencyManagement</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-dependencies<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>Greenwich.SR4<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>type</span><span class="token punctuation">&gt;</span></span>pom<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>type</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">&gt;</span></span>import<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencyManagement</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>build</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugins</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugin</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-maven-plugin<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugin</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugins</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>build</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>project</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br></div></div><p>然后来创建一个 oauth 数据库, 初始化将来会用到的 5 个表.</p> <ol><li>authorities 表: 记录<strong>账号的权限</strong>, 需要在后面配置.</li> <li>oauth_approvals 表: 记录<strong>授权批准的状态</strong>.</li> <li>oauth_client_details 表: 记录 <strong>OAuth 的客户端</strong>, 需要在后面做配置.</li> <li>oauth_code 表: 记录<strong>授权码</strong>.</li> <li>users 表: 记录<strong>账号</strong>, 需要在后面做初始化.</li></ol> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">SET</span> NAMES utf8mb4<span class="token punctuation">;</span>
<span class="token keyword">SET</span> FOREIGN_KEY_CHECKS <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

<span class="token comment">-- ----------------------------</span>
<span class="token comment">-- Table structure for authorities</span>
<span class="token comment">-- ----------------------------</span>
<span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> <span class="token identifier"><span class="token punctuation">`</span>authorities<span class="token punctuation">`</span></span><span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">`</span>authorities<span class="token punctuation">`</span></span> <span class="token punctuation">(</span>
    <span class="token identifier"><span class="token punctuation">`</span>username<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>authority<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    <span class="token keyword">UNIQUE</span> <span class="token keyword">KEY</span> <span class="token identifier"><span class="token punctuation">`</span>ix_auth_username<span class="token punctuation">`</span></span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>username<span class="token punctuation">`</span></span><span class="token punctuation">,</span><span class="token identifier"><span class="token punctuation">`</span>authority<span class="token punctuation">`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token keyword">CONSTRAINT</span> <span class="token identifier"><span class="token punctuation">`</span>fk_authorities_users<span class="token punctuation">`</span></span> <span class="token keyword">FOREIGN</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>username<span class="token punctuation">`</span></span><span class="token punctuation">)</span> <span class="token keyword">REFERENCES</span> <span class="token identifier"><span class="token punctuation">`</span>users<span class="token punctuation">`</span></span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>username<span class="token punctuation">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8mb4<span class="token punctuation">;</span>

<span class="token comment">-- ----------------------------</span>
<span class="token comment">-- Table structure for oauth_approvals</span>
<span class="token comment">-- ----------------------------</span>
<span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> <span class="token identifier"><span class="token punctuation">`</span>oauth_approvals<span class="token punctuation">`</span></span><span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">`</span>oauth_approvals<span class="token punctuation">`</span></span> <span class="token punctuation">(</span>
    <span class="token identifier"><span class="token punctuation">`</span>userId<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>clientId<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>partnerKey<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>scope<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>status<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>expiresAt<span class="token punctuation">`</span></span> <span class="token keyword">datetime</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>lastModifiedAt<span class="token punctuation">`</span></span> <span class="token keyword">datetime</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8<span class="token punctuation">;</span>

<span class="token comment">-- ----------------------------</span>
<span class="token comment">-- Table structure for oauth_client_details</span>
<span class="token comment">-- ----------------------------</span>
<span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> <span class="token identifier"><span class="token punctuation">`</span>oauth_client_details<span class="token punctuation">`</span></span><span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">`</span>oauth_client_details<span class="token punctuation">`</span></span> <span class="token punctuation">(</span>
    <span class="token identifier"><span class="token punctuation">`</span>client_id<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>resource_ids<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>client_secret<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>scope<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>authorized_grant_types<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>web_server_redirect_uri<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>authorities<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>access_token_validity<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>refresh_token_validity<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>additional_information<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">4096</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>autoapprove<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
<span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>client_id<span class="token punctuation">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8mb4<span class="token punctuation">;</span>

<span class="token comment">-- ----------------------------</span>
<span class="token comment">-- Table structure for oauth_code</span>
<span class="token comment">-- ----------------------------</span>
<span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> <span class="token identifier"><span class="token punctuation">`</span>oauth_code<span class="token punctuation">`</span></span><span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">`</span>oauth_code<span class="token punctuation">`</span></span> <span class="token punctuation">(</span>
    <span class="token identifier"><span class="token punctuation">`</span>code<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>authentication<span class="token punctuation">`</span></span> <span class="token keyword">blob</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8mb4<span class="token punctuation">;</span>

<span class="token comment">-- ----------------------------</span>
<span class="token comment">-- Table structure for users</span>
<span class="token comment">-- ----------------------------</span>
<span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> <span class="token identifier"><span class="token punctuation">`</span>users<span class="token punctuation">`</span></span><span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">`</span>users<span class="token punctuation">`</span></span> <span class="token punctuation">(</span>
    <span class="token identifier"><span class="token punctuation">`</span>username<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>password<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>enabled<span class="token punctuation">`</span></span> <span class="token keyword">tinyint</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>username<span class="token punctuation">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8mb4<span class="token punctuation">;</span>

<span class="token keyword">SET</span> FOREIGN_KEY_CHECKS <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br></div></div><p>这 5 个表是 Spring Security OAuth 需要用到的存储表. 这里并没有在数据库中创建相应的表来存放访问令牌和刷新令牌. 这是因为之后的实现会<strong>使用 JWT 来传输令牌信息, 以便进行本地校验, 所以并不一定要将其存放到数据库</strong>中. 基本上所有的这些表都是可以自己扩展的, 只需要继承实现 Spring 的一些既有类即可, 这里不做展开.</p> <h5 id="_2-搭建授权服务器"><a href="#_2-搭建授权服务器" class="header-anchor">#</a> 2.搭建授权服务器</h5> <p>接下来开始搭建授权服务器和受保护资源服务器. 先创建第一个模块, 也就是授权服务器. 首先创建 POM, 配置依赖:</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token prolog">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>project</span> <span class="token attr-name"><span class="token namespace">xmlns:</span>xsi</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>http://www.w3.org/2001/XMLSchema-instance<span class="token punctuation">&quot;</span></span>
<span class="token attr-name">xmlns</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>http://maven.apache.org/POM/4.0.0<span class="token punctuation">&quot;</span></span>
<span class="token attr-name"><span class="token namespace">xsi:</span>schemaLocation</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>parent</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>springsecurity101<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>me.josephzhu<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.0-SNAPSHOT<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>parent</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>modelVersion</span><span class="token punctuation">&gt;</span></span>4.0.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>modelVersion</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>springsecurity101-cloud-oauth2-server<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-oauth2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-jdbc<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>mysql<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>mysql-connector-java<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-web<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-thymeleaf<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>project</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br></div></div><p>这里使用了 Spring Cloud 的 <strong>spring-cloud-starter-oauth2 组件</strong>, 而不是直接使用的 Spring Security, 因为前者做了一些自动化配置的工作, 使用起来会更方便.</p> <p>此外还在 POM 中加入了数据访问, Web 等依赖, 因为受保护资源服务器需要使用数据库来保存客户端的信息, 用户信息等数据, 同时也会引入 thymeleaf 模板引擎依赖, 来稍稍美化一下登录页面.</p> <p>然后创建一个配置文件 application.yml 实现程序配置:</p> <div class="language-yml line-numbers-mode"><pre class="language-yml"><code><span class="token key atrule">server</span><span class="token punctuation">:</span>
<span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8080</span>

<span class="token key atrule">spring</span><span class="token punctuation">:</span>
<span class="token key atrule">application</span><span class="token punctuation">:</span>
<span class="token key atrule">name</span><span class="token punctuation">:</span> oauth2<span class="token punctuation">-</span>server
<span class="token key atrule">datasource</span><span class="token punctuation">:</span>
<span class="token key atrule">url</span><span class="token punctuation">:</span> jdbc<span class="token punctuation">:</span>mysql<span class="token punctuation">:</span>//localhost<span class="token punctuation">:</span>6657/oauth<span class="token punctuation">?</span>useSSL=false
<span class="token key atrule">username</span><span class="token punctuation">:</span> root
<span class="token key atrule">password</span><span class="token punctuation">:</span> kIo9u7Oi0eg
<span class="token key atrule">driver-class-name</span><span class="token punctuation">:</span> com.mysql.jdbc.Driver
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>这里配置了 oauth 数据库的连接字符串, 定义了授权服务器的监听端口是 8080.</p> <p>最后, 使用 keytool 工具<strong>生成密钥对, 把密钥文件 jks 保存到资源目录下, 并要导出一个公钥留作以后使用</strong>.</p> <p>以上完成了项目框架搭建工作, 接下来正式开始编码.</p> <p>第一步, 创建一个<strong>最核心的类用于配置授权服务器</strong>.</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Configuration</span>
<span class="token annotation punctuation">@EnableAuthorizationServer</span> <span class="token comment">// 开启授权服务器</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OAuth2ServerConfiguration</span> <span class="token keyword">extends</span> <span class="token class-name">AuthorizationServerConfigurerAdapter</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">DataSource</span> dataSource<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">AuthenticationManager</span> authenticationManager<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 配置使用数据库来维护客户端信息. 虽然在各种Demo中经常看到的是在内存中维护客户端信息, 通过配置直接写死在这里. 
     * 但是对于实际的应用一般都会用数据库来维护这个信息, 甚至还会建立一套工作流来允许客户端自己申请ClientID, 实现OAuth客户端接入的审批. 
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">ClientDetailsServiceConfigurer</span> clients<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        clients<span class="token punctuation">.</span><span class="token function">jdbc</span><span class="token punctuation">(</span>dataSource<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 这里干了两件事儿. 首先, 打开了验证Token的访问权限(以便之后演示). 
     * 然后允许ClientSecret明文方式保存, 并且可以通过表单提交(而不仅仅是Basic Auth方式提交), 之后会演示到这个. 
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">AuthorizationServerSecurityConfigurer</span> security<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        security<span class="token punctuation">.</span><span class="token function">checkTokenAccess</span><span class="token punctuation">(</span><span class="token string">&quot;permitAll()&quot;</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">allowFormAuthenticationForClients</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">passwordEncoder</span><span class="token punctuation">(</span><span class="token class-name">NoOpPasswordEncoder</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 干了以下4件事儿: 
     * 1. 配置令牌存放方式为JWT方式, 而不是内存, 数据库或Redis方式. 
     * JWT是Json Web Token的缩写, 也就是使用JSON数据格式包装的令牌, 由.号把整个JWT分隔为头, 数据体, 签名三部分. 
     * JWT保存Token虽然易于使用但是不是那么安全, 一般用于内部, 且需要走HTTPS并配置比较短的失效时间. 
     * 2. 配置JWT Token的非对称加密来进行签名
     * 3. 配置一个自定义的Token增强器, 把更多信息放入Token中
     * 4. 配置使用JDBC数据库方式来保存用户的授权批准记录
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">AuthorizationServerEndpointsConfigurer</span> endpoints<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">TokenEnhancerChain</span> tokenEnhancerChain <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TokenEnhancerChain</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        tokenEnhancerChain<span class="token punctuation">.</span><span class="token function">setTokenEnhancers</span><span class="token punctuation">(</span>
            <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span><span class="token function">tokenEnhancer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">jwtTokenEnhancer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        endpoints<span class="token punctuation">.</span><span class="token function">approvalStore</span><span class="token punctuation">(</span><span class="token function">approvalStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                 <span class="token punctuation">.</span><span class="token function">authorizationCodeServices</span><span class="token punctuation">(</span><span class="token function">authorizationCodeServices</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                 <span class="token punctuation">.</span><span class="token function">tokenStore</span><span class="token punctuation">(</span><span class="token function">tokenStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                 <span class="token punctuation">.</span><span class="token function">tokenEnhancer</span><span class="token punctuation">(</span>tokenEnhancerChain<span class="token punctuation">)</span>
                 <span class="token punctuation">.</span><span class="token function">authenticationManager</span><span class="token punctuation">(</span>authenticationManager<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 使用JDBC数据库方式来保存授权码</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">AuthorizationCodeServices</span> <span class="token function">authorizationCodeServices</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">JdbcAuthorizationCodeServices</span><span class="token punctuation">(</span>dataSource<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 使用JWT存储</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">TokenStore</span> <span class="token function">tokenStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">JwtTokenStore</span><span class="token punctuation">(</span><span class="token function">jwtTokenEnhancer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 使用JDBC数据库方式来保存用户的授权批准记录</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">JdbcApprovalStore</span> <span class="token function">approvalStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">JdbcApprovalStore</span><span class="token punctuation">(</span>dataSource<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 自定义的Token增强器, 把更多信息放入Token中</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">TokenEnhancer</span> <span class="token function">tokenEnhancer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">CustomTokenEnhancer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 配置JWT使用非对称加密方式来验证</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">protected</span> <span class="token class-name">JwtAccessTokenConverter</span> <span class="token function">jwtTokenEnhancer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">KeyStoreKeyFactory</span> keyStoreKeyFactory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">KeyStoreKeyFactory</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ClassPathResource</span><span class="token punctuation">(</span><span class="token string">&quot;jwt.jks&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;mySecretKey&quot;</span><span class="token punctuation">.</span><span class="token function">toCharArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">JwtAccessTokenConverter</span> converter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JwtAccessTokenConverter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        converter<span class="token punctuation">.</span><span class="token function">setKeyPair</span><span class="token punctuation">(</span>keyStoreKeyFactory<span class="token punctuation">.</span><span class="token function">getKeyPair</span><span class="token punctuation">(</span><span class="token string">&quot;jwt&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> converter<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 配置登录页面的视图信息(其实可以独立一个配置类, 这样会更规范)</span>
    <span class="token annotation punctuation">@Configuration</span>
    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">MvcConfig</span> <span class="token keyword">implements</span> <span class="token class-name">WebMvcConfigurer</span> <span class="token punctuation">{</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addViewControllers</span><span class="token punctuation">(</span><span class="token class-name">ViewControllerRegistry</span> registry<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            registry<span class="token punctuation">.</span><span class="token function">addViewController</span><span class="token punctuation">(</span><span class="token string">&quot;login&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setViewName</span><span class="token punctuation">(</span><span class="token string">&quot;login&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br></div></div><p>第二步, 刚才在第一步的代码中还用到了一个自定义的 Token 增强器, 把<strong>用户信息嵌入到 JWT Token 中</strong>去(如果使用的是客户端凭据许可类型, 这段代码无效, 因为和用户没关系).</p> <p>这是一个常见需求. 因为默认情况下 Token 中只会有用户名这样的基本信息, 因此往往<strong>需要把关于用户的更多信息返回给客户端</strong>(在实际应用中, 可能会从数据库或外部服务查询更多的用户信息加入到 JWT Token 中去). 这个时候, 就可以<strong>自定义增强器</strong>来丰富 Token 的内容:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CustomTokenEnhancer</span> <span class="token keyword">implements</span> <span class="token class-name">TokenEnhancer</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">OAuth2AccessToken</span> <span class="token function">enhance</span><span class="token punctuation">(</span><span class="token class-name">OAuth2AccessToken</span> accessToken<span class="token punctuation">,</span> <span class="token class-name">OAuth2Authentication</span> authentication<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Authentication</span> userAuthentication <span class="token operator">=</span> authentication<span class="token punctuation">.</span><span class="token function">getUserAuthentication</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>userAuthentication <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">Object</span> principal <span class="token operator">=</span> authentication<span class="token punctuation">.</span><span class="token function">getUserAuthentication</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPrincipal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 把用户标识嵌入JWT Token中去(Key是userDetails)</span>
            <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> additionalInfo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            additionalInfo<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;userDetails&quot;</span><span class="token punctuation">,</span> principal<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">DefaultOAuth2AccessToken</span><span class="token punctuation">)</span> accessToken<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setAdditionalInformation</span><span class="token punctuation">(</span>additionalInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> accessToken<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>第三步, 实现<strong>安全方面的配置</strong>.</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WebSecurityConfig</span> <span class="token keyword">extends</span> <span class="token class-name">WebSecurityConfigurerAdapter</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">DataSource</span> dataSource<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">AuthenticationManager</span> <span class="token function">authenticationManagerBean</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">authenticationManagerBean</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 配置用户账户的认证方式. 显然把用户存在了数据库中希望配置JDBC的方式.
     * 此外还配置了使用BCryptPasswordEncoder哈希来保存用户的密码(生产环境中, 用户密码肯定不能是明文保存的)
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">AuthenticationManagerBuilder</span> auth<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        auth<span class="token punctuation">.</span><span class="token function">jdbcAuthentication</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">dataSource</span><span class="token punctuation">(</span>dataSource<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">passwordEncoder</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BCryptPasswordEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 开放/login和/oauth/authorize两个路径的匿名访问. 前者用于登录, 后者用于换授权码, 这两个端点访问的时机都在登录之前.
     * 设置/login使用表单验证进行登录.
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">HttpSecurity</span> http<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        http<span class="token punctuation">.</span><span class="token function">authorizeRequests</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">antMatchers</span><span class="token punctuation">(</span><span class="token string">&quot;/login&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;/oauth/authorize&quot;</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">permitAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">anyRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">authenticated</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">formLogin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">loginPage</span><span class="token punctuation">(</span><span class="token string">&quot;/login&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br></div></div><p>第四步, 在资源目录下创建一个 templates 文件夹, 然后创建一个 login.html 登录页:</p> <div class="language-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>uk-height-1-1<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>uk-vertical-align uk-text-center uk-height-1-1<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>uk-vertical-align-middle<span class="token punctuation">&quot;</span></span> <span class="token special-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span><span class="token value css language-css"><span class="token property">width</span><span class="token punctuation">:</span> 250px<span class="token punctuation">;</span></span><span class="token punctuation">&quot;</span></span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">&gt;</span></span>Login Form<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>uk-text-danger<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">th:</span>if</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>${param.error}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
      用户名或密码错误...
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>uk-panel uk-panel-box uk-form<span class="token punctuation">&quot;</span></span> <span class="token attr-name">method</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>post<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">th:</span>action</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>@{/login}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>uk-form-row<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>uk-width-1-1 uk-form-large<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>text<span class="token punctuation">&quot;</span></span> <span class="token attr-name">placeholder</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>Username<span class="token punctuation">&quot;</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>username<span class="token punctuation">&quot;</span></span>
               <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>reader<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>uk-form-row<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>uk-width-1-1 uk-form-large<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>password<span class="token punctuation">&quot;</span></span> <span class="token attr-name">placeholder</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>Password<span class="token punctuation">&quot;</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>password<span class="token punctuation">&quot;</span></span>
               <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>reader<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>uk-form-row<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>uk-width-1-1 uk-button uk-button-primary uk-button-large<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>Login<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">&gt;</span></span>

  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><p>至此, 授权服务器的编码工作就完成了.</p> <h5 id="_3-搭建受保护资源服务器"><a href="#_3-搭建受保护资源服务器" class="header-anchor">#</a> 3.搭建受保护资源服务器</h5> <p>接下来搭建一个<strong>用户服务模拟资源提供者(受保护资源服务器)</strong> . 先看看项目初始化工作.</p> <p>这次创建的 POM 没有什么特殊, 依赖了 spring-cloud-starter-oauth2:</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token prolog">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>project</span> <span class="token attr-name"><span class="token namespace">xmlns:</span>xsi</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>http://www.w3.org/2001/XMLSchema-instance<span class="token punctuation">&quot;</span></span>
<span class="token attr-name">xmlns</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>http://maven.apache.org/POM/4.0.0<span class="token punctuation">&quot;</span></span>
<span class="token attr-name"><span class="token namespace">xsi:</span>schemaLocation</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>parent</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>springsecurity101<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>me.josephzhu<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.0-SNAPSHOT<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>parent</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>modelVersion</span><span class="token punctuation">&gt;</span></span>4.0.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>modelVersion</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>springsecurity101-cloud-oauth2-userservice<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-oauth2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-web<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>project</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><p>配置文件非常简单, 只是声明了资源服务端口为 8081:</p> <div class="language-yml line-numbers-mode"><pre class="language-yml"><code><span class="token key atrule">server</span><span class="token punctuation">:</span>
<span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8081</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>同时还要记得把之前在项目准备工作时生成的<strong>密钥对的公钥命名为 public.cert, 并放到资源文件下</strong>. 这样, <strong>资源服务器可以本地校验 JWT 的合法性</strong>. 内容大概是这样的:</p> <div class="language-yml line-numbers-mode"><pre class="language-yml"><code><span class="token punctuation">---</span><span class="token punctuation">-</span><span class="token punctuation">-</span>BEGIN PUBLIC KEY<span class="token punctuation">---</span><span class="token punctuation">-</span><span class="token punctuation">-</span>
MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAwR84LFHwnK5GXErnwkmD
mPOJl4CSTtYXCqmCtlbF+5qVOosu0YsM2DsrC9O2gun6wVFKkWYiMoBSjsNMSI3Z
w5JYgh+ldHvA+MIex2QXfOZx920M1fPUiuUPgmnTFS+Z3lmK3/T6jJnmciUPY1pe
h4MXL6YzeI0q4W9xNBBeKT6FDGpduc0FC3OlXHfLbVOThKmAUpAWFDwf9/uUA//l
3PLchmV6VwTcUaaHp5W8Af/GU4lPGZbTAqOxzB9ukisPFuO1DikacPhrOQgdxtqk
LciRTa884uQnkFwSguOEUYf3ni8GNRJauIuW0rVXhMOs78pKvCKmo53M0tqeC6ul
+QIDAQAB
<span class="token punctuation">---</span><span class="token punctuation">-</span><span class="token punctuation">-</span>END PUBLIC KEY<span class="token punctuation">---</span><span class="token punctuation">-</span><span class="token punctuation">-</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>下面正式开始编码.</p> <p>第一步, 创建一个可以匿名访问的接口 GET /hello, 用来测试无需登录就可以访问的服务端资源:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@RestController</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HelloController</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;hello&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">hello</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">&quot;Hello&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>第二步, 创建三个需要<strong>登录 + 授权才能访问到的接口</strong>. 这里通过 @PreAuthorize 在方法执行前进行权限控制:</p> <ol><li>GET /user/name 接口, 读权限或写权限可访问, 返回登录用户名;</li> <li>GET /user 接口, 读权限或写权限可访问, 返回登录用户信息;</li> <li>POST /user 接口, 只有写权限可以访问, 返回访问令牌中的额外信息(也就是自定义的 Token 增强器 CustomTokenEnhancer 加入到访问令牌中的额外信息, Key 是 userDetails), 这里也演示了使用 TokenStore 来解析 Token 的方式.</li></ol> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@RestController</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">&quot;user&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserController</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">TokenStore</span> tokenStore<span class="token punctuation">;</span>

    <span class="token comment">// 读权限或写权限可访问, 返回登录用户名</span>
    <span class="token annotation punctuation">@PreAuthorize</span><span class="token punctuation">(</span><span class="token string">&quot;hasAuthority('READ') or hasAuthority('WRITE')&quot;</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">name</span><span class="token punctuation">(</span><span class="token class-name">OAuth2Authentication</span> authentication<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> authentication<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 读权限或写权限可访问, 返回登录用户信息</span>
    <span class="token annotation punctuation">@PreAuthorize</span><span class="token punctuation">(</span><span class="token string">&quot;hasAuthority('READ') or hasAuthority('WRITE')&quot;</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@GetMapping</span>
    <span class="token keyword">public</span> <span class="token class-name">OAuth2Authentication</span> <span class="token function">read</span><span class="token punctuation">(</span><span class="token class-name">OAuth2Authentication</span> authentication<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> authentication<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 只有写权限可以访问, 返回访问令牌中的额外信息</span>
    <span class="token annotation punctuation">@PreAuthorize</span><span class="token punctuation">(</span><span class="token string">&quot;hasAuthority('WRITE')&quot;</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@PostMapping</span>
    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">write</span><span class="token punctuation">(</span><span class="token class-name">OAuth2Authentication</span> authentication<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">OAuth2AuthenticationDetails</span> details <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">OAuth2AuthenticationDetails</span><span class="token punctuation">)</span> authentication<span class="token punctuation">.</span><span class="token function">getDetails</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">OAuth2AccessToken</span> accessToken <span class="token operator">=</span> tokenStore<span class="token punctuation">.</span><span class="token function">readAccessToken</span><span class="token punctuation">(</span>details<span class="token punctuation">.</span><span class="token function">getTokenValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> accessToken<span class="token punctuation">.</span><span class="token function">getAdditionalInformation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getOrDefault</span><span class="token punctuation">(</span><span class="token string">&quot;userDetails&quot;</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br></div></div><p>第三步, 创建核心的资源服务器配置类. 这里需要注意下面两点:</p> <ol><li>这里硬编码了资源服务器的 ID 为 userservice;</li> <li>现在使用的是<strong>不落数据库的 JWT 方式 + 非对称加密, 需要通过本地公钥进行验证</strong>, 因此在这里配置了公钥的路径.</li></ol> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Configuration</span>
<span class="token annotation punctuation">@EnableResourceServer</span> <span class="token comment">// 启用资源服务器</span>
<span class="token annotation punctuation">@EnableGlobalMethodSecurity</span><span class="token punctuation">(</span>prePostEnabled <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token comment">// 启用方法注解方式来进行权限控制</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ResourceServerConfiguration</span> <span class="token keyword">extends</span> <span class="token class-name">ResourceServerConfigurerAdapter</span> <span class="token punctuation">{</span>

    <span class="token comment">// 声明了资源服务器的ID是userservice, 声明了资源服务器的TokenStore是JWT</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">ResourceServerSecurityConfigurer</span> resources<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        resources<span class="token punctuation">.</span><span class="token function">resourceId</span><span class="token punctuation">(</span><span class="token string">&quot;userservice&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">tokenStore</span><span class="token punctuation">(</span><span class="token function">tokenStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 配置TokenStore</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">TokenStore</span> <span class="token function">tokenStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">JwtTokenStore</span><span class="token punctuation">(</span><span class="token function">jwtAccessTokenConverter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 配置公钥</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">protected</span> <span class="token class-name">JwtAccessTokenConverter</span> <span class="token function">jwtAccessTokenConverter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">JwtAccessTokenConverter</span> converter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JwtAccessTokenConverter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Resource</span> resource <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ClassPathResource</span><span class="token punctuation">(</span><span class="token string">&quot;public.cert&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> publicKey <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            publicKey <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span><span class="token class-name">FileCopyUtils</span><span class="token punctuation">.</span><span class="token function">copyToByteArray</span><span class="token punctuation">(</span>resource<span class="token punctuation">.</span><span class="token function">getInputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        converter<span class="token punctuation">.</span><span class="token function">setVerifierKey</span><span class="token punctuation">(</span>publicKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> converter<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 配置了除了/user路径之外的请求可以匿名访问</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">HttpSecurity</span> http<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        http<span class="token punctuation">.</span><span class="token function">authorizeRequests</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">antMatchers</span><span class="token punctuation">(</span><span class="token string">&quot;/user/**&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">authenticated</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">anyRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">permitAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br></div></div><p>到这里来想一下, 如果授权服务器产生 Token 的话, <strong>受保护资源服务器必须要有一种办法来验证 Token</strong>, 那如果这里的 Token 不是 JWT 的方式, 可以怎么办呢?</p> <p>下面是几个方案:</p> <ol><li>首先, Token 可以保存在数据库或 Redis 中, 资源服务器和授权服务器共享底层的 TokenStore 来验证;</li> <li>然后, 资源服务器可以使用 RemoteTokenServices, 来从授权服务器的 /oauth/check_token 端点进行 Token 校验.</li></ol> <p>到这里, 资源服务器就配置完成了, 还在资源服务器中分别创建了两个控制器 HelloController 和 UserController, 用于分别测试可以匿名访问以及受到权限保护的资源.</p> <h5 id="_4-初始化数据配置"><a href="#_4-初始化数据配置" class="header-anchor">#</a> 4.初始化数据配置</h5> <p>在实现了授权服务器和受保护资源服务器代码后, 再来初始化 oauth 数据库的数据就非常容易理解了. 总结起来, 需要配置<strong>用户, 权限和客户端</strong>三部分.</p> <p>配置两个用户. 其中, 读用户 reader 具有读权限, 密码为 reader; 写用户 writer 具有读写权限, 密码为 writer. 密码使用的是 BCryptPasswordEncoder 加密.</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token identifier"><span class="token punctuation">`</span>users<span class="token punctuation">`</span></span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'reader'</span><span class="token punctuation">,</span> <span class="token string">'$2a$04$C6pPJvC1v6.enW6ZZxX.luTdpSI/1gcgTVN7LhvQV6l/AfmzNU/3i'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token identifier"><span class="token punctuation">`</span>users<span class="token punctuation">`</span></span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'writer'</span><span class="token punctuation">,</span> <span class="token string">'$2a$04$M9t2oVs3/VIreBMocOujqOaB/oziWL0SnlWdt8hV4YnlhQrORA0fS'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>配置两个权限, 也就是配置 reader 用户具有读权限, writer 用户具有写权限:</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token identifier"><span class="token punctuation">`</span>authorities<span class="token punctuation">`</span></span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'reader'</span><span class="token punctuation">,</span> <span class="token string">'READ'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token identifier"><span class="token punctuation">`</span>authorities<span class="token punctuation">`</span></span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'writer'</span><span class="token punctuation">,</span> <span class="token string">'READ,WRITE'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>配置三个客户端, 其中客户端 userservice1 使用资源拥有者凭据许可类型, 客户端 userservice2 使用客户端凭据许可类型, 客户端 userservice3 使用授权码许可类型.</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token identifier"><span class="token punctuation">`</span>oauth_client_details<span class="token punctuation">`</span></span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'userservice1'</span><span class="token punctuation">,</span> <span class="token string">'userservice'</span><span class="token punctuation">,</span> <span class="token string">'1234'</span><span class="token punctuation">,</span> <span class="token string">'FOO'</span><span class="token punctuation">,</span> <span class="token string">'password,refresh_token'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">,</span> <span class="token string">'READ,WRITE'</span><span class="token punctuation">,</span> <span class="token number">7200</span><span class="token punctuation">,</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span> <span class="token string">'true'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token identifier"><span class="token punctuation">`</span>oauth_client_details<span class="token punctuation">`</span></span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'userservice2'</span><span class="token punctuation">,</span> <span class="token string">'userservice'</span><span class="token punctuation">,</span> <span class="token string">'1234'</span><span class="token punctuation">,</span> <span class="token string">'FOO'</span><span class="token punctuation">,</span> <span class="token string">'client_credentials,refresh_token'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">,</span> <span class="token string">'READ,WRITE'</span><span class="token punctuation">,</span> <span class="token number">7200</span><span class="token punctuation">,</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span> <span class="token string">'true'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token identifier"><span class="token punctuation">`</span>oauth_client_details<span class="token punctuation">`</span></span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'userservice3'</span><span class="token punctuation">,</span> <span class="token string">'userservice'</span><span class="token punctuation">,</span> <span class="token string">'1234'</span><span class="token punctuation">,</span> <span class="token string">'FOO'</span><span class="token punctuation">,</span> <span class="token string">'authorization_code,refresh_token'</span><span class="token punctuation">,</span> <span class="token string">'https://baidu.com,http://localhost:8082/ui/login,http://localhost:8083/ui/login,http://localhost:8082/ui/remoteCall'</span><span class="token punctuation">,</span> <span class="token string">'READ,WRITE'</span><span class="token punctuation">,</span> <span class="token number">7200</span><span class="token punctuation">,</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span> <span class="token string">'false'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>值得说明的是:</p> <ol><li>三个客户端账号能使用的<strong>资源 ID</strong> 都是 userservice, <strong>对应受保护资源服务器刚才配置的资源 ID</strong>, 也就是 userservice, 这两者需要一致.</li> <li>三个客户端账号的密码都是 1234.</li> <li>三个客户端账号的授权范围都是 FOO(并不是关键信息), 它们可以拿到的权限是读写. 不过, 对于和用户相关的授权许可类型(比如资源拥有者凭据许可, 授权码许可), 最终拿到的权限还取决于客户端权限和用户权限的交集.</li> <li>通过 grant_types 字段配置支持不同的授权许可类型. 这里为了便于测试观察, 这里给三个客户端账号各自配置了一种授权许可类型; 在实际业务场景中, 完全可以为同一个客户端配置支持 OAuth 2.0 的四种授权许可类型.</li> <li>userservice1 和 userservice2 配置了用户自动批准授权(不会弹出一个页面要求用户进行授权).</li></ol> <h5 id="_5-演示三种授权许可类型"><a href="#_5-演示三种授权许可类型" class="header-anchor">#</a> 5.演示三种授权许可类型</h5> <p>到这里授权服务器和受保护资源服务器程序都搭建完成了, 数据库也配置了用于测试的用户, 权限和客户端. 下面使用 Postman 来手工测试一下 OAuth 2.0 的授权码许可, 资源拥有者凭据许可, 客户端凭据许可这三种授权许可类型.</p> <h6 id="_1-资源拥有者凭据许可类型"><a href="#_1-资源拥有者凭据许可类型" class="header-anchor">#</a> (1)资源拥有者凭据许可类型</h6> <p>首先测试的是<strong>资源拥有者凭据许可</strong>, POST 请求地址是:</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code>http:<span class="token comment">//localhost:8080/oauth/token?grant_type=password&amp;client_id=userservice1&amp;client_secret=1234&amp;username=writer&amp;password=writer</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>得到如下图所示结果:</p> <p><img src="/img/c464fed8294ae77b40853dc1b1aeb5ca-20230729094013-zfshzon.png" alt=""></p> <p>使用 JWT 解析工具看下请求 Token 中的信息:</p> <p><img src="/img/62b0b153c8dadc17cb872409c78b4cd0-20230729094013-1lbnv5p.png" alt=""></p> <p>可以看到, Token 中果然包含了 <strong>Token 增强器加入的 userDetails 自定义信息</strong>. 如果把公钥粘贴到页面的话, 可以看到这个 JWT 校验成功了:</p> <p><img src="/img/3074623c88375924085c3307a2abfbbc-20230729094013-r85qs8l.png" alt=""></p> <p>除了本地校验外, 还可以<strong>访问授权服务器来校验 JWT</strong>:</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code>http:<span class="token comment">//localhost:8080/oauth/check_token?client_id=userservice1&amp;client_secret=1234&amp;token=...</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>得到如下结果:</p> <p><img src="/img/176fd6031a6185641fa6d6af31b6a4c0-20230729094013-eckr04m.png" alt=""></p> <h6 id="_2-客户端授权许可类型"><a href="#_2-客户端授权许可类型" class="header-anchor">#</a> (2)客户端授权许可类型</h6> <p>再来测试下客户端授权许可类型. POST 请求地址:</p> <div class="language-http line-numbers-mode"><pre class="language-http"><code><span class="token header"><span class="token header-name keyword">http</span><span class="token punctuation">:</span><span class="token header-value">//localhost:8080/oauth/token?grant_type=client_credentials&amp;client_id=userservice2&amp;client_secret=1234</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>如下图所示, 可以直接拿到 Token:</p> <p><img src="/img/ce9f95779131b38c2eb0bdb91196fe8b-20230729094013-3nl67t3.png" alt=""></p> <p>这里需要注意的是, <strong>并没有提供刷新令牌</strong>. 这是因为, <strong>刷新令牌用于避免访问令牌失效后需要用户再次登录的问题, 而客户端授权许可类型没有用户的概念, 因此没有刷新令牌, 也无法注入额外的 userDetails 信息</strong>.</p> <p><img src="/img/d4c68440cd55741d9dbc40c3123d5ba9-20230729094013-tizk1lr.png" alt=""></p> <p>也可以试一下, 如果授权服务器没有开启 <strong>allowFormAuthenticationForClients</strong> 参数(允许表单提交认证)的话, 客户端的凭证需要通过 <strong>Basic Auth</strong> 传过去而不是通过 Post:</p> <p><img src="/img/b655bce82cede25c446735a82d66372c-20230729094013-3jwvy9e.png" alt=""></p> <h6 id="_3-授权码许可类型"><a href="#_3-授权码许可类型" class="header-anchor">#</a> (3)授权码许可类型</h6> <p>最后来测试下比较复杂的<strong>授权码许可</strong>.</p> <p><strong>第一步</strong>, 打开浏览器访问地址:</p> <div class="language-http line-numbers-mode"><pre class="language-http"><code><span class="token header"><span class="token header-name keyword">http</span><span class="token punctuation">:</span><span class="token header-value">//localhost:8080/oauth/authorize?response_type=code&amp;client_id=userservice3&amp;redirect_uri=https://baidu.com</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>注意客户端跳转地址需要和数据库中配置的一致(百度的 URL https://baidu.com 之前已经在数据库中有配置了). 访问后页面会直接跳转到登录界面, 使用用户名 &quot;reader&quot;, 密码 &quot;reader&quot; 来登录:</p> <p><img src="/img/539b9f65aee52672695a75bb46a59ad5-20230729094013-wzg9ojc.png" alt=""></p> <p>由于在数据库中设置的是禁用自动批准授权的模式, 所以登录后来到了批准界面:</p> <p><img src="/img/c1581050e1a83b7105ba124bd963c1d1-20230729094013-qrocyzo.png" alt=""></p> <p>点击同意后可以看到, 数据库中也会产生<strong>授权通过</strong>记录:</p> <p><img src="/img/d1f3332cade2c8221a741614a8468fb8-20230729094013-ae51o8o.png" alt=""></p> <p>**第二步, ** 可以看到浏览器转到了百度并且提供了授权码:</p> <div class="language-http line-numbers-mode"><pre class="language-http"><code><span class="token header"><span class="token header-name keyword">https</span><span class="token punctuation">:</span><span class="token header-value">//www.baidu.com/?code=XKkHGY</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>数据库中也记录了授权码:</p> <p><img src="/img/67e92b6c5de07c5556625d68328fe421-20230729094013-a5ttmcg.png" alt=""></p> <p>然后 POST 访问下面的地址(code 参数替换为刚才获得的授权码):</p> <div class="language-http line-numbers-mode"><pre class="language-http"><code><span class="token header"><span class="token header-name keyword">http</span><span class="token punctuation">:</span><span class="token header-value">//localhost:8080/oauth/token?grant_type=authorization_code&amp;client_id=userservice3&amp;client_secret=1234&amp;code=XKkHGY&amp;redirect_uri=https://baidu.com</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>可以<strong>通过授权码换取访问令牌</strong>:</p> <p><img src="/img/6f1c72fca896da19d7767645023eb73b-20230729094013-ctnk7rc.png" alt=""></p> <p>虽然 userservice3 客户端可以有读权限和写权限, 但是因为登录的用户 reader 只有读权限, 所以最后拿到也只有读权限.</p> <h5 id="_6-演示权限控制"><a href="#_6-演示权限控制" class="header-anchor">#</a> 6.演示权限控制</h5> <p>现在来测试一下之前定义的两个账号, 也就是读账号和写账号, 看看它们的权限控制是否有效.</p> <p>首先, 测试一下安全配置, 访问 /hello 端点不需要认证可以匿名访问:</p> <p><img src="/img/64a63a32b2cfc980a79864e0444e3fb8-20230729094013-piz9w03.png" alt=""></p> <p>访问 /user 需要身份认证:</p> <p><img src="/img/5e93cd1490e64fc787a111d1041ec99e-20230729094013-f6z1ehy.png" alt=""></p> <p>不管以哪种模式拿到访问令牌, 用具有读权限的访问令牌访问资源服务器的如下地址(<strong>请求头加入 Authorization: Bearer XXXXXXXXXX, 其中 XXXXXXXXXX 代表访问令牌</strong>):</p> <div class="language-http line-numbers-mode"><pre class="language-http"><code><span class="token header"><span class="token header-name keyword">http</span><span class="token punctuation">:</span><span class="token header-value">//localhost:8081/user/</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>可以得到如下结果:</p> <p><img src="/img/28881cf6cd5371ea514af08b335c1be7-20230729094013-3vgthex.png" alt=""></p> <p>以 POST 方式访问 http://localhost:8081/user/, 显然是失败的:</p> <p><img src="/img/9a18b3ac8e3f7dd2156654ac34c9157d-20230729094013-22rcact.png" alt=""></p> <p>因为这个接口要求有写权限:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@PreAuthorize</span><span class="token punctuation">(</span><span class="token string">&quot;hasAuthority('WRITE')&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@PostMapping</span>
<span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">write</span><span class="token punctuation">(</span><span class="token class-name">OAuth2Authentication</span> authentication<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>换一个具有读写权限的访问令牌来试试:</p> <p><img src="/img/c240616905db2056c00c4ae569d1f8a5-20230729094013-htj6vuw.png" alt=""></p> <p>可以发现, 果然访问成功了. 这里输出的内容是 Token 中的 userDetails 额外信息, 说明资源服务器的权限控制有效.</p> <h5 id="_7-搭建客户端程序"><a href="#_7-搭建客户端程序" class="header-anchor">#</a> 7.搭建客户端程序</h5> <p>上面的演示使用的是 Postman, 也就是手动 HTTP 请求的方式来申请和使用 Token. 最后来搭建一个 OAuth 客户端程序自动实现这个过程.</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token prolog">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>project</span> <span class="token attr-name"><span class="token namespace">xmlns:</span>xsi</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>http://www.w3.org/2001/XMLSchema-instance<span class="token punctuation">&quot;</span></span>
<span class="token attr-name">xmlns</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>http://maven.apache.org/POM/4.0.0<span class="token punctuation">&quot;</span></span>
<span class="token attr-name"><span class="token namespace">xsi:</span>schemaLocation</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>parent</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>springsecurity101<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>me.josephzhu<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.0-SNAPSHOT<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>parent</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>springsecurity101-cloud-oauth2-client<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>modelVersion</span><span class="token punctuation">&gt;</span></span>4.0.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>modelVersion</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-oauth2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-web<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-thymeleaf<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>project</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br></div></div><p>配置文件如下:</p> <div class="language-yml line-numbers-mode"><pre class="language-yml"><code><span class="token key atrule">server</span><span class="token punctuation">:</span>
<span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8083</span>
<span class="token key atrule">servlet</span><span class="token punctuation">:</span>
<span class="token key atrule">context-path</span><span class="token punctuation">:</span> /ui
<span class="token key atrule">security</span><span class="token punctuation">:</span>
<span class="token key atrule">oauth2</span><span class="token punctuation">:</span>
<span class="token key atrule">client</span><span class="token punctuation">:</span>
<span class="token key atrule">clientId</span><span class="token punctuation">:</span> userservice3
<span class="token key atrule">clientSecret</span><span class="token punctuation">:</span> <span class="token number">1234</span>
<span class="token key atrule">accessTokenUri</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//localhost<span class="token punctuation">:</span>8080/oauth/token
<span class="token key atrule">userAuthorizationUri</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//localhost<span class="token punctuation">:</span>8080/oauth/authorize
<span class="token key atrule">scope</span><span class="token punctuation">:</span> FOO
<span class="token key atrule">resource</span><span class="token punctuation">:</span>
<span class="token key atrule">jwt</span><span class="token punctuation">:</span>
<span class="token key atrule">key-value</span><span class="token punctuation">:</span> <span class="token punctuation">|</span>
<span class="token punctuation">---</span><span class="token punctuation">-</span><span class="token punctuation">-</span>BEGIN PUBLIC KEY<span class="token punctuation">---</span><span class="token punctuation">-</span><span class="token punctuation">-</span>
<span class="token important">***</span>
<span class="token punctuation">---</span><span class="token punctuation">-</span><span class="token punctuation">-</span>END PUBLIC KEY<span class="token punctuation">---</span><span class="token punctuation">-</span><span class="token punctuation">-</span>
<span class="token key atrule">spring</span><span class="token punctuation">:</span>
<span class="token key atrule">thymeleaf</span><span class="token punctuation">:</span>
<span class="token key atrule">cache</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>

<span class="token comment">#logging:#</span>
<span class="token comment">##  level:</span>
<span class="token comment">##    ROOT: DEBUG</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><p>客户端项目端口 8082, 几个需要说明的地方:</p> <ol><li>本地测试的时候有一个坑, 也就是需要配置 <strong>context-path</strong>, 否则可能会出现客户端和授权服务器服务端 Cookie 干扰, 导致 CSRF 防御触发的问题. 这个问题出现后程序没有任何错误日志输出, 只有开启 DEBUG 模式后才能看到 DEBUG 日志里有提示, 因此这个问题非常难以排查.</li> <li>作为 OAuth 客户端, <strong>需要配置 OAuth 服务端获取 Token 的地址, 授权(获取授权码)的地址, 需要配置客户端的 ID, 密码和授权范围</strong>.</li> <li>因为使用的是 JWT Token, 需要配置公钥(当然, 如果不在这里直接配置公钥的话, 也可以配置从授权服务器服务端获取公钥).</li></ol> <p>接下来开始编码.</p> <p>第一步, 实现 MVC 的配置:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Configuration</span>
<span class="token annotation punctuation">@EnableWebMvc</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WebMvcConfig</span> <span class="token keyword">implements</span> <span class="token class-name">WebMvcConfigurer</span> <span class="token punctuation">{</span>

    <span class="token comment">// 配置RequestContextListener用于启用session scope的Bean</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">RequestContextListener</span> <span class="token function">requestContextListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">RequestContextListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 配置index路径的首页Controller</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addViewControllers</span><span class="token punctuation">(</span><span class="token class-name">ViewControllerRegistry</span> registry<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        registry<span class="token punctuation">.</span><span class="token function">addViewController</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setViewName</span><span class="token punctuation">(</span><span class="token string">&quot;forward:/index&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        registry<span class="token punctuation">.</span><span class="token function">addViewController</span><span class="token punctuation">(</span><span class="token string">&quot;/index&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>这里做了两件事情:</p> <ul><li>配置 RequestContextListener, 用于启用 session scope 的 Bean;</li> <li>配置了 index 路径的首页 Controller.</li></ul> <p>第二步, 实现安全方面的配置:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Configuration</span>
<span class="token annotation punctuation">@Order</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WebSecurityConfig</span> <span class="token keyword">extends</span> <span class="token class-name">WebSecurityConfigurerAdapter</span> <span class="token punctuation">{</span>

    <span class="token comment">// /路径和/login路径允许访问, 其它路径需要身份认证后才能访问</span>
    <span class="token annotation punctuation">@Overrideprotected</span>
    <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">HttpSecurity</span> http<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        http<span class="token punctuation">.</span><span class="token function">authorizeRequests</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">antMatchers</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;/login/**&quot;</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">permitAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">anyRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">authenticated</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>这里实现的是 / 路径和 /login 路径允许访问, 其它路径需要身份认证后才能访问.</p> <p>第三步创建一个控制器:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@RestController</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DemoController</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">OAuth2RestTemplate</span> restTemplate<span class="token punctuation">;</span>

    <span class="token comment">// 演示登录后才能访问的安全页面</span>
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/securedPage&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">ModelAndView</span> <span class="token function">securedPage</span><span class="token punctuation">(</span><span class="token class-name">OAuth2Authentication</span> authentication<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ModelAndView</span><span class="token punctuation">(</span><span class="token string">&quot;securedPage&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addObject</span><span class="token punctuation">(</span><span class="token string">&quot;authentication&quot;</span><span class="token punctuation">,</span> authentication<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 演示通过OAuth2RestTemplate调用受保护资源</span>
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/remoteCall&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">remoteCall</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">ResponseEntity</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> responseEntity <span class="token operator">=</span> restTemplate<span class="token punctuation">.</span><span class="token function">getForEntity</span><span class="token punctuation">(</span><span class="token string">&quot;http://localhost:8081/user/name&quot;</span><span class="token punctuation">,</span>
                                                                          <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> responseEntity<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><p>这里实现了两个功能:</p> <p>securedPage 页面, 实现的功能是, 把用户信息作为模型传入了视图, 这样打开页面后就能显示用户名和权限.</p> <p>remoteCall 接口, 实现的功能是, 通过引入 OAuth2RestTemplate, 在登录后就可以使用凭据直接从受保护资源服务器拿资源, 不需要繁琐地实现获得访问令牌, 在请求头里加入访问令牌的过程.</p> <p>第四步, 配置一下刚才用到的 OAuth2RestTemplate Bean, 并启用 OAuth2Sso 功能:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Configuration</span>
<span class="token annotation punctuation">@EnableOAuth2Sso</span> <span class="token comment">// 这个注解包含了@EnableOAuth2Client</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OAuthClientConfig</span> <span class="token punctuation">{</span>

    <span class="token comment">// 定义了OAuth2RestTemplate, 网上一些比较老的资料给出的是手动读取配置文件来实现, </span>
    <span class="token comment">// 最新版本已经可以自动注入OAuth2ProtectedResourceDetails</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">OAuth2RestTemplate</span> <span class="token function">oauth2RestTemplate</span><span class="token punctuation">(</span><span class="token class-name">OAuth2ClientContext</span> oAuth2ClientContext<span class="token punctuation">,</span>
                                                 <span class="token class-name">OAuth2ProtectedResourceDetails</span> details<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">OAuth2RestTemplate</span><span class="token punctuation">(</span>details<span class="token punctuation">,</span> oAuth2ClientContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>第五步, 实现首页:</p> <div class="language-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>container<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>col-sm-12<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">&gt;</span></span>Spring Security SSO Client<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>btn btn-primary<span class="token punctuation">&quot;</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>securedPage<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>Login<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>以及登录后才能访问的 securedPage 页面:</p> <div class="language-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>container<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>col-sm-12<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">&gt;</span></span>Secured Page<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">&gt;</span></span>
    Welcome, <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name"><span class="token namespace">th:</span>text</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>${authentication.name}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>Name<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span>
    Your authorities are <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name"><span class="token namespace">th:</span>text</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>${authentication.authorities}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>authorities<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>客户端程序搭建好之后, 先来测试一下<strong>单点登录</strong>的功能. 启动客户端项目, 打开浏览器访问:</p> <div class="language-html line-numbers-mode"><pre class="language-html"><code>http://localhost:8082/ui/securedPage
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>可以看到, 页面自动转到了授权服务器(8080 端口)的登录页面:</p> <p><img src="/img/00e5ca3792a65ff8b5f17aa9148bf549-20230729094013-9te8r2f.png" alt=""></p> <p>登录后显示了当前用户名和权限:</p> <p><img src="/img/1e97d1cd34139615fdf92aeaed3194e7-20230729094013-k72m7m8.png" alt=""></p> <p>再启动<strong>另一个客户端网站</strong>, 端口改为 8083, 然后访问同样的地址:</p> <p><img src="/img/8ff71377153e47ad6791713f883b1af8-20230729094013-9xf6m5w.png" alt=""></p> <p><strong>可以看到直接是登录状态, 单点登录测试成功</strong>. 是不是很方便? 其实, 为了达成单点登录的效果, 程序在背后自动实现了多次 302 重定向, 整个流程为:</p> <div class="language-html line-numbers-mode"><pre class="language-html"><code>http://localhost:8083/ui/securedPage -&gt;
http://localhost:8083/ui/login -&gt;
http://localhost:8080/oauth/authorize?client_id=userservice3&amp;redirect_uri=http://localhost:8083/ui/login&amp;response_type=code&amp;scope=FOO&amp;state=Sobjqe -&gt;
http://localhost:8083/ui/login?code=CDdvHa&amp;state=Sobjqe -&gt;
http://localhost:8083/ui/securedPage
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>演示客户端请求资源服务器资源还记得吗, 在前面搭建客户端程序中, 还定义了一个 remoteCall 接口, 直接使用 OAuth2RestTemplate 来访问远程资源服务器的资源. 现在来测试一下这个接口是否可以实现自动的 OAuth 流程. 访问:</p> <div class="language-http line-numbers-mode"><pre class="language-http"><code><span class="token header"><span class="token header-name keyword">http</span><span class="token punctuation">:</span><span class="token header-value">//localhost:8082/ui/remoteCall</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>会先转到授权服务器登录, 登录后自动跳转回来:</p> <p><img src="/img/2af275ce7e8d377c6ce95d1adb014e39-20230729094013-cqj22qf.png" alt=""></p> <p>可以看到输出了用户名, 对应的资源服务器服务端接口是:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@PreAuthorize</span><span class="token punctuation">(</span><span class="token string">&quot;hasAuthority('READ') or hasAuthority('WRITE')&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">name</span><span class="token punctuation">(</span><span class="token class-name">OAuth2Authentication</span> authentication<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> authentication<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>换一个 writer 用户登录试试, 也能得到正确的输出:</p> <p><img src="/img/db773012ebaaced230400bb40b7ca386-20230729094013-hsxsl38.png" alt=""></p> <h5 id="_8-总结"><a href="#_8-总结" class="header-anchor">#</a> 8.总结</h5> <p>本节完整演示了如何使用 Spring Cloud 的 OAuth 2.0 组件基于三个程序角色(授权服务器, 受保护资源服务器和客户端)实现三种 OAuth 2.0 的授权许可类型(资源拥有者凭据许可, 客户端凭据许可和授权码许可).</p> <p>先演示了三种授权许可类型的手动流程, 然后也演示了如何实现权限控制和单点登录, 以及如何使用客户端程序来实现自动的 OAuth 2.0 流程.</p> <h4 id="架构案例-基于oauth-2-0-jwt的微服务参考架构"><a href="#架构案例-基于oauth-2-0-jwt的微服务参考架构" class="header-anchor">#</a> 架构案例-基于OAuth 2.0/JWT的微服务参考架构</h4> <p>前面几讲一起学习了 OAuth 2.0 在开放环境中的使用过程. 那么 <strong>OAuth 2.0 不仅仅可以用在开放的场景中, 它可以应用到任何需要授权 / 鉴权的地方, 包括微服务</strong>.</p> <p>从单体到微服务架构的演进, 是当前企业数字化转型的一大趋势. OAuth 2.0 是当前业界标准的授权协议, 它的核心是若干个针对不同场景的令牌颁发和管理流程; 而 JWT 是一种轻量级, 自包含的令牌, 可用于在微服务间安全地传递用户信息.</p> <p>虽然有不少企业已经部分或全部转型到微服务架构, 但是在授权认证机制方面, 它们一般都是定制自研的, 比方说携程和拍拍贷的令牌服务. 之所以定制自研, 主要原因在于标准的 OAuth 2.0 协议相对比较复杂, 门槛也比较高. 定制自研固然可以暂时解决企业的问题, 但是不具备通用性, 也可能有很多潜在的安全风险.</p> <p>**那么, 到底应该如何将行业标准的 OAuth 2.0/JWT 和微服务集成起来呢, 又有没有可落地的参考架构呢? **</p> <p>针对这个问题, 本节来分享一种可落地的参考架构. 这个架构的思想源于 MICRO-SERVICES ARCHITECTURE WITH OAUTH2 AND JWT – PART 1 – OVERVIEW 这篇文章. 根据原作者 Thijs 的描述, 他提出的架构已经在企业落地架构了. 如果你还想获得关于原架构的更多细节, 建议进一步参考 &quot;What is PKCE?&quot; 这篇文章. Thijs 给出的架构确实具有可落地性和参考价值, 但是他的架构里面对某些微服务层次的命名, 例如 BFF 和 Facade 层, 和目前主流的微服务架构不符, 还有他的架构应该是手绘, 不够清晰, 也不容易理解.</p> <p>因此这里会改进 Thijs 给出的架构, 并补充针对不同场景的流程. 为了方便理解, 在接下来的讲述中, 会假定有这样一家叫 ACME 的新零售公司, 它已经实现了数字化转型, 微服务电商平台是支持业务运作的核心基础设施.</p> <p>在业务架构方面, ACME 有近千家线下门店, 这些门店通过 POS 系统和电商平台对接. 公司还有一些物流发货中心, 拣选(Order Picking)系统也要和电商平台对接. 另外公司还有很多送货司机, 通过 App 和电商平台对接. 当然, ACME 还有一些电商网站, 做线上营销和销售, 这些网站是电商平台的主要流量源.</p> <p>虽然支持 ACME 公司业务运作的技术平台很复杂, 但是它的核心可以用一个简化的微服务架构图来描述:</p> <p><img src="/img/810fb94d0f8b50527baca062606c2c9e-20230729094013-3ydvuzb.png" alt=""></p> <p>可以看出, 这个微服务架构是运行在 <strong>Kubernetes</strong> 集群中的. 当然了, 这个架构实际上并不一定需要 Kubernetes 环境, 用传统数据中心也可以. 另外它的<strong>整体认证授权架构是基于 OAuth 2.0/JWT</strong> 实现的.</p> <p>接下来按这个微服务架构的分层方式, 依次分析下它的每一层, <strong>以及应用认证 / 授权和服务调用的相关流程</strong>. 这样不仅可以理解一个典型的微服务架构该如何分层, 还可以弄清楚 OAuth 2.0/JWT 该如何与微服务进行集成.</p> <h5 id="_1-微服务分层架构"><a href="#_1-微服务分层架构" class="header-anchor">#</a> 1.微服务分层架构</h5> <p>ACME 公司的微服务架构, 大致可以分为 <strong>Nginx 反向代理层, Web 应用层, Gateway 网关层, BEF 层和领域服务层, 还包括一个 IDP 服务</strong>. 总体上讲, 这是一种目前主流的微服务架构分层方式, 每一层职责单一, 清晰.</p> <p>接下来具体看看每一层的主要功能.</p> <h6 id="_1-nginx反向代理层"><a href="#_1-nginx反向代理层" class="header-anchor">#</a> (1)Nginx反向代理层</h6> <p>首先, Nginx 集群是整个平台的<strong>流量入口</strong>. Nginx 是 7 层 HTTP 反向代理, 主要功能是实现反向路由, 也就是<strong>将外部流量根据 HOST 主机头或者 PATH, 路由到不同的后端, 比方说路由到 Web 应用, 或者直接到网关 Gateway</strong>.</p> <p>**在 Kubernetes 体系中, Nginx 是和 Ingress Controller(入口控制器)配合工作的(总称为 Nginx Ingress), Ingress Controller 支持通过 Ingress Rules, 配置 Nginx 的路由规则. **</p> <h6 id="_2-web应用层"><a href="#_2-web应用层" class="header-anchor">#</a> (2)Web应用层</h6> <p>这一层主要是一些 Web 应用, <strong>html/css/js 等资源</strong>就住在这一层.</p> <p>Web 服务层通常采用传统的 <strong>Web MVC + 模版引擎方式处理</strong>, 可以实现服务器端渲染, 也可以采用单页 SPA 方式. 这一层主要由公司的前端团队负责, 通常会使用 Node.js 技术栈来实现, 也可以采用 Spring MVC 技术栈实现. 具体怎么实现, 要看公司的前端团队更擅长哪种技术. <strong>当这一层需要后台数据时, 可以通过网关调用后台服务获取数据</strong>.</p> <h6 id="_3-gateway网关层"><a href="#_3-gateway网关层" class="header-anchor">#</a> (3)Gateway网关层</h6> <p><strong>这一层是微服务调用流量的入口</strong>. 网关的主要职责是反向路由, 也就是将前端请求根据 HOST 主机头, 或者 PATH, 或者查询参数, <strong>路由到后端目标微服务</strong>(比如, 图中的 IDP/BFF 或者直接到领域服务).</p> <p>另外, 网关还承担两个重要的安全职责:</p> <ol><li><strong>一个是令牌的校验和转换</strong>, 将前端传递过来的 OAuth 2.0 访问令牌, 通过调用 IDP 进行校验, 并转换为包含用户和权限信息的 JWT 令牌, 再将 JWT 令牌向后台微服务传递.</li> <li><strong>另外一个是权限校验</strong>, 网关的路由表可以和 OAuth 2.0 的 Scope 进行关联. 这样网关根据请求令牌中的权限范围 Scope, 就可以判断请求是否具有调用后台服务的权限.</li></ol> <p>另外, 网关还需承担集中式限流, 日志监控, 以及支持 CORS 等功能.</p> <p>对于网关层的技术选型, 当前主流的 API 网关产品, 像 Netflix 开源的 Zuul, Spring Cloud Gateway 等, 都可以考虑.</p> <h6 id="_4-idp服务"><a href="#_4-idp服务" class="header-anchor">#</a> (4)IDP服务</h6> <p>IDP 是 Identity Provider 的简称, 主要负责 OAuth 2.0 <strong>授权协议处理</strong>, OAuth 2.0 和 JWT <strong>令牌颁发和管理, 以及用户认证</strong>等功能. IDP 使用后台的 Login-Service 进行用户认证.</p> <p>对于 IDP 的技术选型, 当前主流的 <strong>Spring Security OAuth</strong>, 或者 RedHat 开源的 KeyCloak, 都可以考虑. 其中, Spring Security OAuth 是一个 OAuth 2.0 的开发框架, 适合企业定制. KeyCloak 则是一个开箱即用的 OAuth 2.0/OIDC 产品.</p> <h6 id="_5-bff层"><a href="#_5-bff层" class="header-anchor">#</a> (5)BFF层</h6> <p>BFF 是 Backend for Frontend 的简称, 主要实现<strong>对后台领域服务的聚合</strong>(Aggregation, 有点类似数据库的 Join)功能, 同时为不同的前端体验(PC/Mobile/ 开放平台等)提供更友好的 API 和数据格式.</p> <p>BFF 中可以包含一些业务逻辑, 甚至还可以有自己的数据库存储. 通常, BFF 要调用两个或两个以上的领域服务, 甚至还可能调用其它的 BFF(当然一般并不建议这样调用, 因为这样会让调用关系变得错综复杂, 无法理解).</p> <p>如果 BFF 需要获取调用用户或者 OAuth 2.0 Scope 相关信息, 它可以从传递过来的 JWT 令牌中直接获取.</p> <p>BFF 服务可以用 Node.js 开发, 也可以用 Java/Spring 等框架开发.</p> <h6 id="_6-领域服务层"><a href="#_6-领域服务层" class="header-anchor">#</a> (6)领域服务层</h6> <p>领域服务层在整个微服务架构的底层. 这些服务包含业务逻辑, 通常有自己独立的数据库存储, 还可以根据需要调用外部的服务.</p> <p>根据微服务分层原则, <strong>领域服务禁止调用其它的领域服务</strong>, 更不允许反向调用 BFF 服务. 这样做是为了保持微服务职责单一(Single Responsibility)和有界上下文(Bounded Context), 避免复杂的领域依赖. 领域服务是独立的开发, 测试和发布单位. 在电商领域, 常见的领域服务有用户服务, 商品服务, 订单服务和支付服务等.</p> <p>和 BFF 一样, 如果领域服务需要获取调用用户或者 OAuth 2.0 Scope 相关信息, 它可以从传递过来的 JWT 令牌中直接获取.</p> <p>可以看到, <strong>领域服务和 BFF 服务都是无状态</strong>的, 它们本身并不存储用户状态, 而是<strong>通过传递过来的 JWT 数据获取用户信息</strong>. 所以在整个架构中, 微服务都是无状态, 可以按需水平扩展的, 状态要么存在用户端(浏览器或者手机 App 中), 要么存在集中的数据库中.</p> <h5 id="_2-oauth-2-0-jwt如何与微服务进行集成"><a href="#_2-oauth-2-0-jwt如何与微服务进行集成" class="header-anchor">#</a> 2.OAuth 2.0/JWT如何与微服务进行集成?</h5> <p>以上就是 ACME 公司的整个微服务架构的层次了. 这个分层架构, 对于大部分的互联网业务系统场景都适用. 因此如果你是一家企业的架构师, 需要设计一套微服务架构, 完全可以参考它来设计. 接下来再演示几个典型的<strong>应用认证场景</strong>, 以及相应的服务调用流程, 来帮助你理解 OAuth 2.0/JWT 是如何和微服务进行集成的.</p> <h6 id="_1-场景1-第一方web应用-资源拥有者凭据模式"><a href="#_1-场景1-第一方web应用-资源拥有者凭据模式" class="header-anchor">#</a> (1)场景1:第一方Web应用+资源拥有者凭据模式</h6> <p>这个场景是<strong>用户访问 ACME 公司自己的电商网站</strong>, 假设这个电商网站是用 Spring MVC 开发的. 考虑到这是一个第一方场景(也就是公司自己开发的网站应用), 可以选 OAuth 2.0 的<strong>资源拥有者凭据许可</strong>(Resource Owner Password Credentials Grant), 也可以选更安全的授权码许可(Authorization Code Grant). 因为这里没有第三方的概念, 所以就选相对简单的资源拥有者凭据许可.</p> <p>下面是一个认证授权流程样例. 注意这个只是突出了关键步骤, 实际生产的话, 还有很多需要完善和优化的地方. 另外, 为描述简单, 这里假定一个成功流程.</p> <p><img src="/img/af6b37e70d388b0a96548cadff5d79a8-20230729094013-zjz0lh3.png" alt=""></p> <p>在上面的图中, <strong>用户对应 OAuth 2.0 中的资源拥有者, ACME IDP 对应 OAuth 2.0 中的授权服务</strong>. 另外, 前面架构图中的<strong>后台微服务(包括 BFF 和基础领域服务), 对应 OAuth 2.0 中的受保护资源</strong>.</p> <p>下面是流程说明:</p> <ul><li>用户通过浏览器访问 ACME 公司的电商网站, 点击登录链接.</li> <li>Web 应用返回登录界面(这个登录页可以是网站自己定制开发).</li> <li>用户输入用户名, 密码进行认证.</li> <li>Web 应用将用户名, 密码, 通过网关转发到 IDP 的令牌获取端点(POST /oauth2/token, grant_type=password).</li> <li>IDP 通过 Login Service 对用户进行认证.</li> <li>IDP 认证通过, 返回有效访问令牌(根据需要也可以返回刷新令牌).</li> <li>Web 应用接收到访问令牌, 创建用户 Session, 并将 OAuth 2.0 令牌保存其中, 然后返回登录成功到用户端.</li> <li>用户浏览器中记录 Session Cookie, 登录成功.</li></ul> <p>接下来再来看看<strong>认证授权之后的服务调用流程</strong>. 同样这里也只是突出了关键步骤, 并假定是一个成功流程.</p> <p><img src="/img/aef00e8d0c6fb3de724f278e9c28abe4-20230729094013-9exfpfs.png" alt=""></p> <p>流程如下:</p> <ul><li>用户登录后, 在网站上点击查看自己的购物历史记录.</li> <li>Web 应用通过网关调用后台 API(查询用户的购物历史记录), 请求 <strong>HTTP header 中带上 OAuth 2.0 令牌</strong>(来自用户 Session).</li> <li>网关截取 OAuth 2.0 令牌, 去 IDP 进行校验.</li> <li>IDP 校验令牌通过, 再通过令牌查询用户和 Scope 信息, 构建 JWT 令牌, 返回.</li> <li>网关获得 JWT 令牌, 校验 Scope 是否有权限调用 API, 如果有就转发到后台 API 进行调用.</li> <li>后台 BFF(或者领域服务)通过传递过来的 JWT 获取用户信息, 根据用户 ID 查询购物历史记录, 返回.</li> <li>Web 应用获得用户的购物历史数据, 可以根据需要缓存在 Session 中, 再返回用户端.</li> <li>购物历史数据返回到用户浏览器端.</li></ul> <p>注意, 这个服务调用流程, 也可以应用在其他场景中, 比如接下来介绍的&quot;第一方移动应用 + 授权码许可模式&quot;和&quot;第三方 Web 应用 + 授权码许可模式&quot;. 基本上只要理解了这个流程原理, 就可以根据实际场景灵活套用.</p> <h6 id="_2-场景2-第一方移动应用-授权码许可模式"><a href="#_2-场景2-第一方移动应用-授权码许可模式" class="header-anchor">#</a> (2)场景2:第一方移动应用+授权码许可模式</h6> <p>第二个场景是<strong>用户通过手机访问 ACME 公司自己的电商 App</strong>. 这是第一方的原生应用(Native App)场景, 通常考虑选用 OAuth 2.0 的用户名密码模式, 但是并不安全(参考 MICRO-SERVICES ARCHITECTURE WITH OAUTH2 AND JWT – PART 3 – IDP 的 Security Consideration 部分), 所以业界<strong>建议采用授权码模式, 而且是要支持 PKCE 扩展的授权码模式</strong>.</p> <p>接下来看看这个认证授权的流程. 同样这里只是突出了关键步骤, 并假定是一个成功流程.</p> <p><img src="/img/ff1865cfe7895288b818c1d91ca3621c-20230729094013-djsits0.png" alt=""></p> <p>流程如下:</p> <ul><li>用户访问电商 App, 点击登录.</li> <li>App 生成 PKCE 相关的 code verifier + challenge.</li> <li>App 以内嵌方式启动手机浏览器, 访问 IDP 的统一认证页 (GET /authorize), 请求带上 PKCE 的 code challenge 相关参数.</li> <li>IDP 返回统一认证页.</li> <li>用户认证和授权.</li> <li>IDP 通过 Login Service 对用户进行认证.</li> <li>IDP 返回授权码到 App 浏览器.</li> <li>App 截取浏览器带回的授权码, 将授权码 + PKCE code verifer, 通过网关转发到 IDP 的令牌获取端点(POST /oauth2/token, grant_type=authorization-code).</li> <li>IDP 校验 PKCE 和授权码, 校验通过则返回有效访问令牌.</li> <li>App 获取令牌, 本地存储, 登录成功.</li></ul> <p><strong>之后, App 如果需要和后台交互, 可直接通过网关调用后台微服务, 请求 HTTP header 中带上 OAuth 2.0 访问令牌即可. 后续的服务调用流程, 和&quot;第一方应用 + 资源拥有者凭据模式&quot;类似.</strong></p> <h6 id="_3-场景3-第三方web应用-授权码模式"><a href="#_3-场景3-第三方web应用-授权码模式" class="header-anchor">#</a> (3)场景3:第三方Web应用+授权码模式</h6> <p>第三个场景是<strong>某第三方合作厂商开发了一个 Web 网站, 要访问 ACME 公司的电商开放平台 API</strong>. 这是一个第三方 Web 应用场景, 通常选用 OAuth 2.0 的<strong>授权码许可模式</strong>.</p> <p>接下来看看这个认证授权的流程. 同样这里只是突出了关键步骤, 并假设是一个成功流程.</p> <p><img src="/img/300fbe5ac3b996b1deb8841cbff863f4-20230729094013-4zcy7h2.png" alt=""></p> <p>流程如下:</p> <ul><li>用户访问这个第三方 Web 应用, 点击登录链接.</li> <li>Web 应用后台向 ACME 公司的 IPD 服务发送申请授权码请求(GET /authorize).</li> <li>用户被重定向到 ACME 公司的 IDP 统一登录页面.</li> <li>用户进行认证和授权.</li> <li>IDP 通过 Login Service 对用户进行认证.</li> <li>认证和授权通过, IDP 返回授权码.</li> <li>Web 应用获得授权码, 再向 IDP 服务的令牌获取端点发起请求(POST /oauth2/token, grant_type=authorization-code).</li> <li>IDP 校验授权码, 校验通过则返回有效 OAuth 2.0 令牌(根据需要也可以返回刷新令牌).</li> <li>Web 应用创建用户 Session, 将 OAuth 2.0 令牌保存在 Session 中, 然后返回登录成功到用户端.</li> <li>用户浏览器中记录 Session Cookie, 登录成功.</li></ul> <p><strong>之后, 第三方 Web 应用如果需要和 ACME 电商平台交互, 可直接通过网关调用微服务, 请求 HTTP header 中带上 OAuth 2.0 访问令牌即可. 后续的服务调用流程, 和前面的&quot;第一方应用 + 资源拥有者凭据模式&quot;类似.</strong></p> <h6 id="_4-额外说明"><a href="#_4-额外说明" class="header-anchor">#</a> (4)额外说明</h6> <p>除了上面的三个主要场景和流程, 还要和你分享 6 点. 这 6 点是对上面基本流程的补充, 也是企业级的 OAuth 2.0 应用要额外考虑的.</p> <p><strong>第一点是, IDP 的 API 要支持从 OAuth 2.0 访问令牌到 JWT 令牌的互转</strong>. 本节提到的集成架构采用 OAuth 2.0 访问令牌 + JWT 令牌的混合模式, 中间需要实现 OAuth 2.0 访问令牌到 JWT 令牌的互转. 这个互转 API 并非 OAuth 2.0 的标准, 有些 IDP 产品(比方 Spring Security OAuth)可能并不支持, 因此需要用户定制扩展.</p> <p><strong>第二点是, 关于单页 SPA 应用场景</strong>. 关于单页 SPA 应用场景, 简单做法是采用隐式许可, 但是这个模式是 OAuth 2.0 中比较不安全的, 所以一般不建议采用. 对于纯单页 SPA 应用, 业界推荐的做法是:</p> <ol><li>如果浏览器支持 Web Crypto for PKCE, 则可以考虑使用类似&quot;第一方移动应用&quot;场景下的授权码许可 + PKCE 扩展流程;</li> <li>否则, 考虑 SPA + 传统 Web 混合(hybrid)模式, 前端页面可以住在客户浏览器端中, 但登录认证还是由后台 Web 站点配合实现, 走类似&quot;第一方 Web 应用&quot;场景的资源拥有者凭据模式, 或者&quot;第三方 Web 应用&quot;场景下的授权码许可模式.</li></ol> <p><strong>第三点是, 关于 SSO 单点登录场景</strong>. 为了简化描述, 上面的流程没有考虑 SSO 单点登录场景. 如果要支持 Web SSO, 那么各种应用场景都必须通过浏览器 + IDP 登录页集中登录, 并且 <strong>IDP 要支持 Session, 用于维护登录态</strong>. 如果 IDP 以集群方式部署的话, 还要考虑粘性 Sticky Session 或者集中式 Session.</p> <p>这样, 当用户通过一个 Web 应用登录后, 后续如果再用其它 Web 应用登录的话, 只要 IDP 上的 Session 还存在, 那么这个登录就可以自动完成, 相当于单点登录.</p> <p>当然, 如果要支持 SSO, IDP 的 Session Cookie 要种在 Web 应用的根域上, 也就是说不同 Web 应用的根域必须相同, 否则会有跨域问题.</p> <p><strong>第四点是关于 IDP 和网关的部署方式</strong>. 前面的几张架构图中, IDP 虽然躲在网关后面, 但实际上 IDP 可以直接通过 Nginx 对外暴露, 不经过网关. 或者 IDP 的登录授权页面, 可以通过 Nginx 直接暴露, API 接口则走网关.</p> <p><strong>第五点是关于刷新令牌</strong>. 为了简化描述, 上面的流程没有详细说明刷新令牌的集成方式. 企业根据场景需要, 可以<strong>启用刷新令牌</strong>, 来延长用户的登录时间, 具体的集成方式需要考虑安全性的需求.</p> <p><strong>第六点是关于 Web Session</strong>. 为了简化描述, 在上面的流程中, Web 应用登录成功后假设启用 Web Session, 也就是服务器端 Session. 在实际场景中, Web Session 并非唯一选择, 也可以采用简单的客户端 Session 方式, 也称无状态 Session, 也就是在客户端浏览器 Cookie 中保存 OAuth 2.0 访问令牌.</p> <h5 id="_3-小结"><a href="#_3-小结" class="header-anchor">#</a> 3.小结</h5> <p>本节需要记住以下四点.</p> <ul><li>目前主流的微服务架构大致可以分为 5 层, 分别是: <strong>Nginx 流量接入层 -&gt; Web 应用层 -&gt; API 网关层 -&gt; BFF 聚合层 -&gt; 领域服务层</strong>. 这个架构可以住在云原生的 Kubernetes 环境中, 也可以住在传统数据中心里头.</li> <li><strong>API 网关是微服务调用的入口, 承担重要的安全认证和鉴权功能</strong>. 主要的安全操作包括: (1)通过 IDP 校验 OAuth 2.0 访问令牌, 并获取带用户和权限信息的 JWT 令牌; (2)基于 OAuth 2.0 的 Scope 对 API 调用进行鉴权.</li> <li><strong>在微服务架构体系下, 通常需要一个集中的 IDP 服务, 它相当于一个 Authentication &amp; Authorization as a Service 角色, 负责令牌颁发 / 校验 / 管理, 还有用户认证.</strong></li> <li>本节提出的架构中, Web 应用层(网关之前)的安全机制主要基于 OAuth 2.0 访问令牌实现(它是一种<strong>透明令牌</strong>或者称<strong>引用令牌</strong>), 微服务层(网关之后)的安全机制主要基于 JWT 令牌实现(它是一种<strong>不透明</strong>的<strong>自包含令牌</strong>). 网关层在中间实现两种令牌的转换. 这是一种 OAuth 2.0 访问令牌 + JWT 令牌的混合模式. 之所以这样设计, 是因为 Web 层靠近用户端, 如果采用 JWT 令牌, 会暴露用户信息, 有一定的安全风险, 所以采用 OAuth 2.0 访问令牌, 它是一个无意义随机字符串. 而在网关之后, 安全风险相对低, 同时很多服务需要用户信息, 所以采用自包含用户信息的 JWT 令牌更合适. 当然, 如果企业内网没有特别的安全考量, 也可以直接传递完全透明的用户信息(例如使用 JSON 格式).</li></ul> <h4 id="各大开放平台是如何使用oauth-2-0的"><a href="#各大开放平台是如何使用oauth-2-0的" class="header-anchor">#</a> 各大开放平台是如何使用OAuth 2.0的?</h4> <p>前面提到了很多次开放平台, 不难理解, 它的作用就是<strong>企业把自己的业务能力主要以开放 API 的形式, 赋能给外部开发者</strong>. 而作为第三方开发者或者 ISV(独立软件供应商)在接入这些开放平台的时候, 最应该关心的就是它们的官方文档, 关注接入的流程是怎样的, 对应的 API 是什么, 每个 API 都传递哪些参数, 也就差不多够了.</p> <p>不过当你去各大开放平台上面看这些文档的时候, 就会发现这些文档非常分散. 其中的原因也很简单, 那就是开放平台为了让已经具备 OAuth 2.0 知识的研发人员去快速地对接平台上面的业务, 把各类对接流程做了分类归档. 比如, 你会发现微信开放平台上有使用授权码获取授权信息的文档, 也有获取令牌的文档, <strong>但并没有一份整体的, 能够串起来的文档说明</strong>. 这其实也就间接提高了使用门槛, 因为如果不懂 OAuth 2.0, 基本是没办法理解那些分类的.</p> <p>在正式介绍各大开放平台的使用细节之前, 先来看看大厂的开放平台全局体系. 各个开放平台基本的系统结构和授权系统在中间的交互流程, <mark><strong>大同小异, 都是通过授权服务来授权, 通过网关来鉴权</strong></mark>. 接下来就以京东商家开放平台为例来看看开放平台的体系到底是什么样子的.</p> <h5 id="_1-开放平台体系是什么样子的"><a href="#_1-开放平台体系是什么样子的" class="header-anchor">#</a> 1.开放平台体系是什么样子的?</h5> <p>首先来看一下京东商家开放平台全局体系的结构, 如下图所示.</p> <p><img src="/img/808b980e2674314863751ebedd17aff6-20230729094013-kmmgz2f.png" alt="" title="京东商家开放平台体系结构示意图"></p> <p>可以把这个架构体系分为<strong>三部分</strong>来看:</p> <ol><li><strong>第三方软件</strong>, 一般是指第三方开发者或者 ISV 通过对接开放平台来实现的应用软件, 比如小兔打单软件.</li> <li><strong>京东商家开放平台, 包含 API 网关服务, OAuth 2.0 授权服务和第三方软件开发者中心服务</strong>. 其中, API 网关服务和 OAuth 2.0 授权服务, 是开放平台的&quot;两条腿&quot;; 第三方软件开发者中心服务, 是为开发者提供管理第三方软件应用基本信息的服务, 比如 app_id, app_secret 等信息.</li> <li><strong>京东内部的各个微服务, 比如订单服务, 商品服务等</strong>. 这些微服务, 就是之前提到的<strong>受保护资源服务</strong>.</li></ol> <p>从图中还可以看到这个体系整体的调用关系是: <strong>第三方软件通过 HTTP 协议请求到开放平台, 更具体地说是开放平台的 API 网关服务, 然后由 API 网关通过内部的 RPC 调用到各个微服务</strong>.</p> <p>接下来再以用户小明使用小兔打单软件为例, 来看看这些系统角色之间具体又是怎样交互的.</p> <p><img src="/img/dba4c4f1f81b63d8edfb987b9d64fe03-20230729094013-jjmn1zx.png" alt="" title="开放平台体系交互示意图"></p> <p>到这里, 可以发现, 在开放平台体系中各个系统角色间的交互可以归结为:</p> <p>当用户小明访问小兔软件的时候, 小兔会首先<strong>向开放平台的 OAuth 2.0 授权服务去请求访问令牌, 接着小兔拿着访问令牌去请求 API 网关服务</strong>;</p> <p>在 API 网关服务中, 会做最基本的两种校验, 一种是访问令牌的合法性校验, 比如访问令牌是否过期的校验, 另一种是小兔打单软件的基本信息的合法性校验, 比如 app_id 和 app_secret 的校验;</p> <p>都校验成功之后, API 网关服务会发起最终的数据请求.</p> <p>这里需要说明的是, 前面提到, 验证访问令牌或者第三方软件应用信息的时候, 都是在受保护资源服务中去做的. <mark><strong>当有了 API 网关这一层的时候, 这些校验工作就会都落到了 API 网关的身上, 因为不能让很多个受保护资源服务做同样的事情</strong></mark>.</p> <p>理解了京东商家开放平台的体系结构后, 可以小结一下. 依靠开放平台提供的能力, 可以说<strong>开放平台, 用户和开发者实现了三赢</strong>: 小明因为使用小兔提高了打单效率; 小兔的开发者因为小明的订购服务获得了收益; 而通过开放出去的 API 让小兔帮助小明能够极快地处理 C 端用户的订单, 京东提高了用户的使用体验.</p> <p>同时开放也是一把双刃剑. 理想状态下, 平台, 开发者, 用户可以实现三赢, 但正如前面提到的, 安全的问题绝不容忽视, 而用户的信息安全又是重中之重.</p> <p><strong>接下来就分享一个开放平台体系是如何解决访问令牌安全问题的案例.</strong></p> <p>前面已经知道, 用户给第三方软件授权之后, 授权服务就会生成一个访问令牌, 而且这个访问令牌是跟用户关联的. 比如小明给小兔打单软件进行了授权, 那么此时访问令牌的粒度就是: 小兔打单软件 + 小明. 并且小兔打单软件可以拿着这个访问令牌去代表小明访问小明的数据; 如果访问令牌过期了, 小兔打单软件还可以继续使用刷新令牌来访问, 直到刷新令牌也过期了.</p> <p>现在问题来了, 如果小明<strong>注销了账号</strong>, 或者修改了自己的密码, 那他之前为其它第三方软件进行授权的访问令牌就<strong>应该立即失效</strong>. 否则, 在刷新令牌过期之前, 第三方软件可以一直拿着之前的访问令牌去请求数据. 这显然不合理.</p> <p>所以在这种情况下, <strong>授权服务就要通过 MQ(消息队列)接收用户的注销和修改密码这两类消息, 然后对访问令牌进行清理</strong>.</p> <p><img src="/img/a864a3aa3f35d71b4a1ece9958279299-20230729094013-82ue0ef.png" alt="" title="访问令牌的清理"></p> <p>其实, 这个案例中解决访问令牌安全问题的方式, 不仅仅适用于开放平台, 还可以为你在企业内构建自己的 OAuth 2.0 授权体系结构时提供借鉴.</p> <p>以上就是开放平台整体的结构, 以及其中需要重点关注的用户访问令牌的安全性问题了. 作为第三方软件开发者, 在对接到这些开放平台或者浏览它们的网站时, 几乎都能看到类似这样的一句话: &quot;<mark><strong>所有接口都需要接入 OAuth 授权, 经过用户确认授权后才可以调用</strong></mark>&quot;, 这正是 OAuth 2.0 的根本性作用.</p> <h5 id="_2-各大开放平台授权流程"><a href="#_2-各大开放平台授权流程" class="header-anchor">#</a> 2.各大开放平台授权流程</h5> <p>理解了开放平台的脉络之后, 接下来通过一组图看一看开放平台是如何使用 OAuth 2.0 授权流程的.</p> <p>以微信, 支付宝, 美团为例, 看看它们在开放授权上是如何使用 OAuth 2.0 的.</p> <p>下面是微信官方的授权流程图:</p> <p><img src="/img/8ede3b2d84f9ef6893e51ef72b8e80d2-20230729094013-khc7hcl.png" alt="" title="微信开放平台授权流程图"></p> <p>下面是支付宝官方的授权流程图:</p> <p><img src="/img/11840067d2ab289b327ff867cf26b685-20230729094013-6ho5x49.png" alt="" title="支付宝开放平台授权流程图"></p> <p>下面是美团官方的授权流程图:</p> <p><img src="/img/fd8395f326b4453dea1e2adc6c658b33-20230729094013-89tf61p.png" alt="" title="美团开放平台授权流程图"></p> <p>可以在这三张授权流程图中看到, <strong>都有和授权码 code 相关的文字</strong>. 这就说明, <mark><strong>它们都建议开发者首选授权码流程</strong></mark>. 这也是为什么前面很强调它的原因.</p> <p>作为开发者在对接开放平台的时候, 最关心的就是它们提供的官方对接文档了. 而<strong>这些文档里面, 最让人头疼就是那些通信过程中需要传递的参数</strong>了. 下面以京东商家开放平台为例, 串下这些参数背后的含义, 以及关键点. 这样在做具体接入操作的时候, 就可以举重若轻了.</p> <h5 id="_3-授权码流程中的参数说明"><a href="#_3-授权码流程中的参数说明" class="header-anchor">#</a> 3.授权码流程中的参数说明</h5> <p>概括来讲, 在京东商家开放平台的授权服务这一侧, 提供服务的就是两个端点: 负责生成授权码的<strong>授权端点</strong>以及负责颁发访问令牌的<strong>令牌端点</strong>. 整个授权过程中, 虽然看着有很多参数, 但可以围绕这两条线, 来对它们做归类.</p> <p>接下来, 继续以小兔打单软件为例, 来看一下它在对接京东商家开放平台的时候都用到了哪些参数.</p> <p>小明在使用小兔打单软件的时候, <strong>首先被小兔通过重定向的方式引导到京东商家开放平台的授权服务上, 其实就是引导到了授权服务的授权端点上</strong>. 这个重定向的过程中用到的参数如下:</p> <p><img src="/img/7545bea290ff2a9fbbbd390206e6e9d8-20230729094013-qhsexg2.png" alt="" title="重定向过程用到的参数"></p> <p>这里需要强调的是, 对于 state 参数, 现在官方都是&quot;推荐&quot;使用. 前面说过, <strong>OAuth 2.0 官方建议的避免 CSRF 攻击的方式, 就是使用 state 参数. 所以安全起见, 还是应该使用</strong>.</p> <p>接着, 京东商家开放平台授权服务的授权端点, 会向小兔软件做出响应. 这个<strong>响应的过程用到的基本参数</strong>, 如下:</p> <p><img src="/img/9930a2dbe95e73b263e0c6d4eb3cf079-20230729094013-wvrdg8d.png" alt="" title="授权端点响应小兔软件用到的参数"></p> <p>对于授权码 code 的值, 一般建议的最长生命周期是 10 分钟. 另外小兔打单软件只能被允许使用一次该授权码的值, 如果使用一次之后还用同样的授权码值来请求, <strong>授权服务必须拒绝</strong>.</p> <p>对于这次的 state 值, 授权服务每次都是必须要返回给小兔打单软件的. 无论小兔打单软件在起初的时候有没有发送该值, 都必须返回回去, 如果没有就返回空. 这样当小兔打单软件日后升级增加该值的时候, 京东商家开放平台就不需要改动任何代码逻辑了.</p> <p><strong>在拿到授权码 code 的值之后, 接下来就是小兔打单软件向京东商家开放平台的授权服务的令牌端点发起请求, 申请访问令牌</strong>. 这个过程中需要传递的基本参数, 如下:</p> <p><img src="/img/8f38e1ad05b9ed1069529ee3677e39cd-20230729094013-28diykq.png" alt="" title="申请访问令牌需要传递的基本参数"></p> <p>在授权服务接收到小兔打单软件申请访问令牌的请求后, 像授权端点一样, <strong>令牌端点也需要向小兔打单软件做出响应. 这个过程涉及到的基本参数</strong>, 如下:</p> <p><img src="/img/1fba77efe0f62e03728da503e9d84536-20230729094013-20gt0p1.png" alt="" title="令牌端点响应小兔软件涉及的参数"></p> <p>对于这里返回的 scope 值, 要强调下, 其实就是小兔软件<strong>被允许的实际的权限范围</strong>, 因为小明有可能给小兔软件授予了小于它在开放平台注册时申请的权限范围. 比如, 小兔打单软件申请了查询历史订单, 查询当天订单两个 API 的权限, 但小明可能只给小兔授权了查询当天订单 API 的权限.</p> <h5 id="_4-总结-5"><a href="#_4-总结-5" class="header-anchor">#</a> 4.总结</h5> <p>本节需要记住以下三点内容.</p> <ul><li><strong>当有多个受保护资源服务的时候, 基本的鉴权工作, 包括访问令牌的验证, 第三方软件应用信息的验证都应该抽出一个 API 网关层, 并把这些基本的工作放到这个 API 网关层.</strong></li> <li>**各大开放平台都是推荐使用授权码许可流程, 无论是网页版的 Web 应用程序, 还是移动应用程序. **</li> <li>**对于第三方软件开发者重点关注的参数, 可以从授权服务的授权端点和令牌端点来区分, 授权端点重点是授权码请求和响应的处理, 令牌端点重点是访问令牌请求和响应的处理. **</li></ul> <h4 id="oauth-2-0常见问题答疑"><a href="#oauth-2-0常见问题答疑" class="header-anchor">#</a> OAuth 2.0常见问题答疑</h4> <p>这里归纳出了几个常见疑问:</p> <ul><li>发明 OAuth 的目的到底是什么?</li> <li>OAuth 2.0 是身份认证协议吗?</li> <li>有了刷新令牌, 是不是就可以让访问令牌一直有效了?</li> <li>使用了 HTTPS, 是不是就能确保 JWT 格式令牌的数据安全?</li> <li>ID 令牌和访问令牌之间有联系吗?</li> <li>PKCE 协议到底解决的是什么问题?</li></ul> <h5 id="_1-发明oauth的目的到底是什么"><a href="#_1-发明oauth的目的到底是什么" class="header-anchor">#</a> 1.发明OAuth的目的到底是什么?</h5> <p>**OAuth 协议的设计初衷, 就是让最终用户也就是资源拥有者(小明), 将他们在受保护资源服务器(京东商家开放平台)上的部分权限(查询当天订单)委托给第三方应用(小兔打单软件), 使得第三方应用(小兔)能够代表最终用户(小明)执行操作(查询当天订单). **</p> <p><mark>这便是 OAuth 协议设计的目的. 在 OAuth 协议中, 通过为</mark>​<mark><strong>每个第三方软件和每个用户的组合</strong></mark>​<mark>分别生成对受保护资源具有</mark>​<mark><strong>受限的访问权限的凭据, 也就是访问令牌</strong></mark>​<mark>, 来代替之前的用户名和密码. </mark>​<mark><strong>而生成访问令牌之前的登录操作, 又是在用户跟平台之间进行的, 第三方软件根本无从得知用户的任何信息</strong></mark>​ **. **</p> <p>这样第三方软件的逻辑处理就大大简化了, 它今后的动作就变成了<strong>请求访问令牌, 使用访问令牌, 访问受保护资源</strong>, 同时在第三方软件调用大量 API 的时候, **不再传输用户名和密码, 从而减少了网络安全的攻击面. **</p> <p>从安全的角度来讲, <strong>为每个第三方软件和每个用户的组合来生成一个访问令牌</strong>的方式, 可以减少对平台更多用户造成的危害. 因为这样一来, 单个第三方软件被攻破而带来的危害, 仅仅会让这一个第三方软件的用户受到影响.</p> <p>那么有的同学就要会问了, 这样攻击的对象就会转移到授权服务身上. 这个想法没错, 但保护一个授权服务肯定要比保护成千上万个, 由不同研发人员开发的第三方软件容易得多.</p> <h5 id="_2-oauth-2-0是身份认证协议吗"><a href="#_2-oauth-2-0是身份认证协议吗" class="header-anchor">#</a> 2.OAuth 2.0是身份认证协议吗?</h5> <p>前面一直在强调, <mark><strong>OAuth 2.0 是一种授权协议, &quot;它一心只专注于干好授权这件事儿&quot;, OAuth 2.0 不是身份认证协议</strong></mark>​ **. ** 很多人都曾错误地认为它是身份认证协议. 因为他们觉得有用户参与其中, 比如小明在使用小兔打单软件之前, 要向授权服务进行登录操作从而进行身份认证 , 那 OAuth 2.0 就应该是一个身份认证协议啊.</p> <p>但是, 小明必须登录之后才能进行授权, <strong>是一个额外的需求, 登录跟授权体系是独立</strong>的. 虽然登录操作看似 &quot;内嵌&quot; 在了 OAuth 2.0 的流程中, 但生产环境中<strong>登录和授权还是两套独立存在的系统</strong>. 所以说, **像这种 &quot;内嵌&quot; 的身份认证行为, 并不是说 OAuth 2.0 自身承担起了身份认证协议的责任. **</p> <p>同时, <strong>身份认证会告诉第三方软件当前的用户是谁, 但实际上 OAuth 2.0 自始至终都没有向第三方软件透露过关于用户的任何信息</strong>. 这一点, 在讲发明 OAuth 协议的目的时也提到过. 可以再想想小兔打单软件的例子, 看是不是这样: <strong>小兔打单软件永远也不会知道小明的任何信息, 它仅仅是请求访问令牌, 使用访问令牌并最终调用查询订单的 API</strong>.</p> <h5 id="_3-有了刷新令牌-是不是就可以让访问令牌一直有效了"><a href="#_3-有了刷新令牌-是不是就可以让访问令牌一直有效了" class="header-anchor">#</a> 3.有了刷新令牌,是不是就可以让访问令牌一直有效了?</h5> <p>要回答这个问题, 先复习下访问令牌和刷新令牌相关的几个知识点.</p> <ul><li>第一, OAuth 2.0 的核心是授权, 授权的核心是令牌, 也就是访问令牌.</li> <li>第二, 为了提高用户的体验, OAuth 2.0 提供了刷新令牌的机制, 使得访问令牌过期后, 第三方软件在无需用户再次授权的情况下, 可以重新请求一个访问令牌.</li> <li>第三, 在使用上, <mark><strong>刷新令牌只能用在授权服务上, 而访问令牌只能用在受保护资源服务上</strong></mark>​ **. **</li></ul> <p>有了这些知识做基础, 可以继续分析这个问题了.</p> <p>当访问令牌被 &quot;递给&quot; 受保护资源服务的时候, 受保护资源服务需要对访问令牌进行验证, 还要对访问令牌关联的权限和第三方软件的请求进行权限匹配校验. 当访问令牌过期的时候, 使用刷新令牌请求到的访问令牌, 是<strong>授权服务重新生成</strong>的, 而不是延长了原访问令牌的有效期.</p> <p>当前的这个刷新令牌被使用之后, 授权服务可以自行决定是颁发一个新的刷新令牌, 还是仍然给第三方软件返回上一个刷新令牌. 安全起见, 建议是<strong>返回一个新的刷新令牌</strong>. 这时可能就有一个疑问了: <strong>第三方软件已经换了一个访问令牌了, 刷新令牌又一直存在, 那是不是就可以一直使用刷新令牌来获取访问令牌了呢?</strong></p> <p>要知道的是, **刷新令牌也有有效期. ** 尽管生成了新的刷新令牌, 但它的有效期不会改变, 有效期的时间戳仍然是上一个刷新令牌的. 刷新令牌的有效期到了, 就不能再继续用它来申请新的访问令牌了.</p> <h5 id="_4-使用了https-是不是就能确保jwt格式令牌的数据安全"><a href="#_4-使用了https-是不是就能确保jwt格式令牌的数据安全" class="header-anchor">#</a> 4.使用了HTTPS,是不是就能确保JWT格式令牌的数据安全?</h5> <p><strong>OAuth 2.0 的使用从来都不应该脱离 HTTPS</strong>. 因为访问令牌, 应用密钥敏感信息要在网络上传输, 都离不开 HTTPS 的保护. 但是, HTTPS 也只是保证了访问令牌等重要信息在网络传输上的安全.</p> <p>在 OAuth 2.0 的规范中, 访问令牌对第三方软件是不透明的, 从来都不应该被任何第三方软件解析到. 由于 JWT 格式的令牌自包含了用户相关的信息, 比如用户标识, 因此仅仅对它进行签名还不够. 要避免第三方软件有机会获取访问令牌所包含的信息, 那在与第三方软件交互的环境下使用 JWT 格式的令牌时, 还要对它<strong>进行加密</strong>来保障令牌的安全, 而不是仅仅依靠 HTTPS.</p> <h5 id="_5-id令牌和访问令牌之间有联系吗"><a href="#_5-id令牌和访问令牌之间有联系吗" class="header-anchor">#</a> 5.ID令牌和访问令牌之间有联系吗?</h5> <p>前面在用 OAuth 2.0 实现一个 OpenID Connect 身份认证协议的时候, 讲到了 ID 令牌. 这里再解释一下, 因为认识到 ID 令牌和访问令牌的联系与区别, 对于利用 OAuth 2.0 搭建一个身份认证协议来说太重要了.</p> <p>先来总结下 ID 令牌和访问令牌的作用:</p> <ol><li>ID 令牌, 也就是 <strong>ID_TOKEN</strong>, 代表的是<strong>用户身份令牌</strong>, 可以说是一个单独的<strong>身份认证结果</strong>, 永远不会像访问令牌那样作为一个参数, 去传递给其它外部服务;</li> <li>访问令牌, 也就是 <strong>ACCESS_TOKEN</strong>, 就是一个令牌, 是<strong>要被第三方软件用来作为凭证, 从而代表用户去请求受保护资源服务的</strong>.</li></ol> <p>这两种令牌是截然不同的. 接下来就分析下, 它们的区别都体现在哪些方面.</p> <ul><li>第一, <strong>ID 令牌是对访问令牌的补充, 而不是要替换访问令牌</strong>. 之所以采用这样双令牌的方式, 就是想让早先存在的访问令牌, 可以在 OAuth 2.0 中继续保持对第三方软件的不透明性, 而让后来新增的 ID 令牌要能够被解析, 目的就是方便应用到<strong>身份认证协议</strong>中.</li> <li>第二, <strong>ID 令牌和访问令牌有不同的生命周期, ID 令牌的生命周期相对来说更短些</strong>. 因为 ID 令牌的作用就是代表一个单独的身份认证结果, 它的使命就是用来标识用户的. 而这个标识并不是用户名, 用户登录的时候用的是用户名而不是这个 ID 令牌, 所以如果用户注销或者退出了登录, ID 令牌的生命周期就随之结束了. 访问令牌可以在用户离开后的很长时间内, 继续被第三方软件用来请求受保护资源服务. 比如, 小明使用了小兔打单软件的批量导出订单功能, 如果耗时相对比较长, 小明不必一直在场.</li></ul> <h5 id="_6-pkce协议到底解决的是什么问题"><a href="#_6-pkce协议到底解决的是什么问题" class="header-anchor">#</a> 6.PKCE协议到底解决的是什么问题?</h5> <p>要理解 PKCE 协议到底解决了什么问题, 就要先看一下它被推出的背景. 2012 年 10 月 OAuth 2.0 的正式授权协议框架, 也就是官方的 RFC 6749 被正式发布, 2015 年 9 月增补了 PKCE 协议, 也就是官方的 RFC 7636. 从时间上来看, 从正式发布 OAuth 2.0 授权协议到增补发布了 PKCE 协议, 整整间隔了三年, 而<strong>这三年恰恰是移动应用蓬勃发展的时期</strong>.</p> <p>同时, 在原生的移动客户端应用保存秘钥又存在特殊的安全问题, 使用 OAuth 2.0 授权码许可类型的客户端又容易受到授权码窃听的攻击.</p> <p>所以, PKCE 被增补发布的背景是, 移动应用大力发展, 同时原生客户端使用 OAuth 2.0 面临着安全风险. 这样就能理解了, <strong>发布 PKCE 协议的目的, 主要就是缓解针对公开客户端的攻击, 提高授权码使用的安全性</strong>.</p> <h3 id="结束语"><a href="#结束语" class="header-anchor">#</a> 结束语</h3> <h4 id="把学习当成一种习惯"><a href="#把学习当成一种习惯" class="header-anchor">#</a> 把学习当成一种习惯</h4> <p><strong>学习从来都不是一件容易的事情, 夸张一点讲有点反人性</strong>. 但是, 学习一定要养成一种习惯. 《程序员思维修炼》这本书中有这么一段话:</p> <blockquote><p>知识投资也是一样. 你需要定期投资最低限度的时间量. 养成一种习惯, 如果需要的话. 躲到你的家庭办公室里去或者走进有无线网络的咖啡厅. 并非每期学习都同样富有成效, 但是只要定期安排学习, 长期来看一定会成功. 如果你一直在等待空闲时间或者等待灵感的突现, 那么它永远都不会发生.</p></blockquote> <p>下面再谈一谈具体的学习方法.</p> <p>这里按照层次由低到高把学习分为<strong>基础学习, 分析学习和主题学习</strong>:</p> <ol><li>基础学习, 就是从知识点最基本的理论开始学习;</li> <li>分析学习, 就是对知识的结构脉络做梳理, 并带着问题去学习;</li> <li>主题学习, 就是对同一个知识点, 分别找到不同的资料来学习.</li></ol> <p>这样看, 基础学习和分析学习属于&quot;点&quot;的学习, 而主题学习就属于&quot;面&quot;的学习, 整体下来就是从点到面构建知识网络的过程. 接下来就看看 OAuth 2.0 的学习, 是怎么对应到这三个层次的.</p> <p>在基础学习的过程中, 要学习 OAuth 2.0 的四种基本角色, 包括资源拥有者(也就是用户), 客户端(也就是第三方软件), 授权服务, 受保护资源服务; 还要学 OAuth 2.0 的四种基本授权许可类型, 包括授权码许可类型, 隐式许可类型, 客户端凭据许可类型, 资源拥有者凭据许可类型.</p> <p>当确定了基础学习阶段的学习范围之后, 就要将这些角色带入到每个许可类型中, 让这些角色&quot;转起来&quot;, 这时就可以用小明使用小兔打单软件的例子串起整个 OAuth 2.0 的工作流程.</p> <p>在分析学习的过程中, 就需要将 OAuth 2.0 的知识体系结构进行一个梳理, 同时把学习时遇到的问题都列出来, 然后逐一分析. 这些问题可能是: 为什么授权码许可流程一定要有授权码, 为什么授权码许可一定要有两次重定向, 如何管理 JWT 格式的令牌的生命周期, 当访问令牌失效了一定要让用户重新授权吗, 刷新令牌会一直有效吗, ID 令牌和访问令牌之间有联系吗, 等等.</p> <p>在主题学习的过程中, 可以把要重点理解的内容当成一个主题, 去横向地学习. 怎么才能叫做横向? 比如, 要知道 PKCE 到底解决了什么问题, 那么就可以把 PKCE 当成一个主题来学习, 要去查阅跟它相关的任何资料, 可以找 OAuth 2.0 的官方文档. 总之, 这是一个研究方向.</p> <p>​​</p> <p>‍</p> <p>‍</p></div></div>  <div class="page-edit"><div class="edit-link"><a href="https://github.com/xugaoyi/vuepress-theme-vdoing/edit/main/docs/30.系统/3000.系统/400.服务治理-系统监控与安全/520.OAuth2.0实战课(极客时间)🌟.md" target="_blank" rel="noopener noreferrer">编辑</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <!----> <!----></div> <div class="page-nav-wapper"><div class="page-nav-centre-wrap"><a href="/pages/3f3cf7/" class="page-nav-centre page-nav-centre-prev"><div class="tooltip">运维监控系统实战(极客时间)🌸</div></a> <a href="/pages/96d94c/" class="page-nav-centre page-nav-centre-next"><div class="tooltip">消息队列基础</div></a></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/pages/3f3cf7/" class="prev">运维监控系统实战(极客时间)🌸</a></span> <span class="next"><a href="/pages/96d94c/">消息队列基础</a>→
      </span></p></div></div></div> <!----></main></div> <div class="footer"><div class="icons"><a href="mailto:1174520425@qq.com" title="发邮件" target="_blank" class="iconfont icon-youjian"></a><a href="https://github.com/nanodaemony" title="GitHub" target="_blank" class="iconfont icon-github"></a></div> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="本站主题">Vdoing</a> 
    | Copyright © 2019-2025
    <span>达尔文的猹 | MIT License</span></div> <div class="buttons"><div title="返回顶部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去评论" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主题模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          跟随系统
        </li><li class="iconfont icon-rijianmoshi">
          浅色模式
        </li><li class="iconfont icon-yejianmoshi">
          深色模式
        </li><li class="iconfont icon-yuedu">
          阅读模式
        </li></ul></div></div> <!----> <!----> <!----></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.3f3e0e10.js" defer></script><script src="/assets/js/2.e9fcb30c.js" defer></script><script src="/assets/js/3.1998f389.js" defer></script><script src="/assets/js/189.fac747e3.js" defer></script>
  </body>
</html>
