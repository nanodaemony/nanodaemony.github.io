<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Redis集群 | Pangolin Note</title>
    <meta name="generator" content="VuePress 1.9.5">
    <link rel="icon" href="/img/favicon.ico">
    <meta name="description" content="大道至简">
    <meta name="keywords" content="前端博客,个人技术博客,前端,前端开发,前端框架,web前端,前端面试题,技术文档,学习,面试,JavaScript,js,ES6,TypeScript,vue,python,css3,html5,Node,git,github,markdown">
    <meta name="baidu-site-verification" content="7F55weZDDc">
    <meta name="theme-color" content="#11a8cd">
    
    <link rel="preload" href="/assets/css/0.styles.56073ad3.css" as="style"><link rel="preload" href="/assets/js/app.3f3e0e10.js" as="script"><link rel="preload" href="/assets/js/2.e9fcb30c.js" as="script"><link rel="preload" href="/assets/js/3.1998f389.js" as="script"><link rel="preload" href="/assets/js/160.0b806535.js" as="script"><link rel="prefetch" href="/assets/js/10.0b55747f.js"><link rel="prefetch" href="/assets/js/100.b8912a99.js"><link rel="prefetch" href="/assets/js/101.a6740c8a.js"><link rel="prefetch" href="/assets/js/102.e31e89b2.js"><link rel="prefetch" href="/assets/js/103.2c5dbdae.js"><link rel="prefetch" href="/assets/js/104.0e9c02f6.js"><link rel="prefetch" href="/assets/js/105.8288396c.js"><link rel="prefetch" href="/assets/js/106.62f43c11.js"><link rel="prefetch" href="/assets/js/107.70c90211.js"><link rel="prefetch" href="/assets/js/108.b488ce56.js"><link rel="prefetch" href="/assets/js/109.12942650.js"><link rel="prefetch" href="/assets/js/11.ac3fd1ca.js"><link rel="prefetch" href="/assets/js/110.1e57ecba.js"><link rel="prefetch" href="/assets/js/111.6e33b4ea.js"><link rel="prefetch" href="/assets/js/112.bd52831b.js"><link rel="prefetch" href="/assets/js/113.868c1ac9.js"><link rel="prefetch" href="/assets/js/114.090549d1.js"><link rel="prefetch" href="/assets/js/115.d97f6c2b.js"><link rel="prefetch" href="/assets/js/116.097c4b4e.js"><link rel="prefetch" href="/assets/js/117.4024cfe2.js"><link rel="prefetch" href="/assets/js/118.e3057cba.js"><link rel="prefetch" href="/assets/js/119.4ef1fa3b.js"><link rel="prefetch" href="/assets/js/12.863eaabe.js"><link rel="prefetch" href="/assets/js/120.78f9df50.js"><link rel="prefetch" href="/assets/js/121.8e16df87.js"><link rel="prefetch" href="/assets/js/122.f21c0107.js"><link rel="prefetch" href="/assets/js/123.ea1cb375.js"><link rel="prefetch" href="/assets/js/124.01c04c6e.js"><link rel="prefetch" href="/assets/js/125.d383e301.js"><link rel="prefetch" href="/assets/js/126.3162cb47.js"><link rel="prefetch" href="/assets/js/127.c6bebae6.js"><link rel="prefetch" href="/assets/js/128.d659db60.js"><link rel="prefetch" href="/assets/js/129.2afdcf48.js"><link rel="prefetch" href="/assets/js/13.4f59ce35.js"><link rel="prefetch" href="/assets/js/130.beb9ed9d.js"><link rel="prefetch" href="/assets/js/131.35b05f8a.js"><link rel="prefetch" href="/assets/js/132.d77f4f93.js"><link rel="prefetch" href="/assets/js/133.4ceda6e5.js"><link rel="prefetch" href="/assets/js/134.11390c5f.js"><link rel="prefetch" href="/assets/js/135.32f9e38f.js"><link rel="prefetch" href="/assets/js/136.6d8bb0f2.js"><link rel="prefetch" href="/assets/js/137.9c0ffeef.js"><link rel="prefetch" href="/assets/js/138.88d86e5f.js"><link rel="prefetch" href="/assets/js/139.8c2c3d6c.js"><link rel="prefetch" href="/assets/js/14.11c82d35.js"><link rel="prefetch" href="/assets/js/140.c5c375d3.js"><link rel="prefetch" href="/assets/js/141.d703f30b.js"><link rel="prefetch" href="/assets/js/142.6a005a44.js"><link rel="prefetch" href="/assets/js/143.9b2edf6f.js"><link rel="prefetch" href="/assets/js/144.3fd013c9.js"><link rel="prefetch" href="/assets/js/145.b05079c5.js"><link rel="prefetch" href="/assets/js/146.ed5360a6.js"><link rel="prefetch" href="/assets/js/147.7408d86f.js"><link rel="prefetch" href="/assets/js/148.f390b370.js"><link rel="prefetch" href="/assets/js/149.95017f0a.js"><link rel="prefetch" href="/assets/js/15.bd143bd5.js"><link rel="prefetch" href="/assets/js/150.f0ede764.js"><link rel="prefetch" href="/assets/js/151.b7093623.js"><link rel="prefetch" href="/assets/js/152.a82a6c83.js"><link rel="prefetch" href="/assets/js/153.965e3fb2.js"><link rel="prefetch" href="/assets/js/154.9e49311e.js"><link rel="prefetch" href="/assets/js/155.cef33ba5.js"><link rel="prefetch" href="/assets/js/156.bcc397ae.js"><link rel="prefetch" href="/assets/js/157.90824739.js"><link rel="prefetch" href="/assets/js/158.efd429b9.js"><link rel="prefetch" href="/assets/js/159.122ff5b7.js"><link rel="prefetch" href="/assets/js/16.2449162b.js"><link rel="prefetch" href="/assets/js/161.835052c6.js"><link rel="prefetch" href="/assets/js/162.ca34e2d2.js"><link rel="prefetch" href="/assets/js/163.08000d04.js"><link rel="prefetch" href="/assets/js/164.a1cc0109.js"><link rel="prefetch" href="/assets/js/165.65444686.js"><link rel="prefetch" href="/assets/js/166.7d73c84f.js"><link rel="prefetch" href="/assets/js/167.009d47a3.js"><link rel="prefetch" href="/assets/js/168.0afeae2a.js"><link rel="prefetch" href="/assets/js/169.7654cb31.js"><link rel="prefetch" href="/assets/js/17.eb7f9def.js"><link rel="prefetch" href="/assets/js/170.58569530.js"><link rel="prefetch" href="/assets/js/171.7db9ed40.js"><link rel="prefetch" href="/assets/js/172.3cb50ed4.js"><link rel="prefetch" href="/assets/js/173.0846425f.js"><link rel="prefetch" href="/assets/js/174.9e95f111.js"><link rel="prefetch" href="/assets/js/175.ef2098f2.js"><link rel="prefetch" href="/assets/js/176.c2635fe9.js"><link rel="prefetch" href="/assets/js/177.4fa38e8e.js"><link rel="prefetch" href="/assets/js/178.2be7037f.js"><link rel="prefetch" href="/assets/js/179.bf3bba28.js"><link rel="prefetch" href="/assets/js/18.0455f4d1.js"><link rel="prefetch" href="/assets/js/180.72c5f597.js"><link rel="prefetch" href="/assets/js/181.42287bcc.js"><link rel="prefetch" href="/assets/js/182.6cd4bf1a.js"><link rel="prefetch" href="/assets/js/183.05dbbfd9.js"><link rel="prefetch" href="/assets/js/184.03de7e00.js"><link rel="prefetch" href="/assets/js/185.42dd210e.js"><link rel="prefetch" href="/assets/js/186.28ee0f8a.js"><link rel="prefetch" href="/assets/js/187.bb58697b.js"><link rel="prefetch" href="/assets/js/188.1bc8be96.js"><link rel="prefetch" href="/assets/js/189.fac747e3.js"><link rel="prefetch" href="/assets/js/19.ae9e35d6.js"><link rel="prefetch" href="/assets/js/190.ea533ac7.js"><link rel="prefetch" href="/assets/js/191.6dc6eb13.js"><link rel="prefetch" href="/assets/js/192.184d249f.js"><link rel="prefetch" href="/assets/js/193.4a06bc12.js"><link rel="prefetch" href="/assets/js/194.8cce60a9.js"><link rel="prefetch" href="/assets/js/195.93231a13.js"><link rel="prefetch" href="/assets/js/196.4a596bde.js"><link rel="prefetch" href="/assets/js/197.96c113cf.js"><link rel="prefetch" href="/assets/js/198.73ba3f67.js"><link rel="prefetch" href="/assets/js/199.74bab595.js"><link rel="prefetch" href="/assets/js/20.b542d0e7.js"><link rel="prefetch" href="/assets/js/200.69a6928a.js"><link rel="prefetch" href="/assets/js/201.9ffa7c5a.js"><link rel="prefetch" href="/assets/js/202.41edb652.js"><link rel="prefetch" href="/assets/js/203.7fabcef3.js"><link rel="prefetch" href="/assets/js/204.b0ae2f62.js"><link rel="prefetch" href="/assets/js/205.add8738b.js"><link rel="prefetch" href="/assets/js/206.f3a712ec.js"><link rel="prefetch" href="/assets/js/207.cd7dd729.js"><link rel="prefetch" href="/assets/js/208.78b33afa.js"><link rel="prefetch" href="/assets/js/209.9d3329ff.js"><link rel="prefetch" href="/assets/js/21.5a050318.js"><link rel="prefetch" href="/assets/js/210.d285d5ac.js"><link rel="prefetch" href="/assets/js/211.8791bb3f.js"><link rel="prefetch" href="/assets/js/212.84ed81a8.js"><link rel="prefetch" href="/assets/js/213.7b990580.js"><link rel="prefetch" href="/assets/js/214.da31f20c.js"><link rel="prefetch" href="/assets/js/215.9eeed659.js"><link rel="prefetch" href="/assets/js/216.9539f0ec.js"><link rel="prefetch" href="/assets/js/217.11b575be.js"><link rel="prefetch" href="/assets/js/218.a67f12f1.js"><link rel="prefetch" href="/assets/js/219.bfbb817a.js"><link rel="prefetch" href="/assets/js/22.2bc6f7e3.js"><link rel="prefetch" href="/assets/js/220.8b01342f.js"><link rel="prefetch" href="/assets/js/221.b450decd.js"><link rel="prefetch" href="/assets/js/222.97468507.js"><link rel="prefetch" href="/assets/js/223.b6dafd73.js"><link rel="prefetch" href="/assets/js/224.c86c18c6.js"><link rel="prefetch" href="/assets/js/225.b0dcf86e.js"><link rel="prefetch" href="/assets/js/226.02cc2999.js"><link rel="prefetch" href="/assets/js/227.8474ef5a.js"><link rel="prefetch" href="/assets/js/228.0298e421.js"><link rel="prefetch" href="/assets/js/229.6aeaf595.js"><link rel="prefetch" href="/assets/js/23.9995fce4.js"><link rel="prefetch" href="/assets/js/230.a5785286.js"><link rel="prefetch" href="/assets/js/231.d791daa4.js"><link rel="prefetch" href="/assets/js/232.97aeeb00.js"><link rel="prefetch" href="/assets/js/233.46e51e28.js"><link rel="prefetch" href="/assets/js/234.2cffe82f.js"><link rel="prefetch" href="/assets/js/235.14965da6.js"><link rel="prefetch" href="/assets/js/236.00a5afc0.js"><link rel="prefetch" href="/assets/js/237.3b73d52f.js"><link rel="prefetch" href="/assets/js/238.6e1db765.js"><link rel="prefetch" href="/assets/js/239.75866c5e.js"><link rel="prefetch" href="/assets/js/24.9141eeb2.js"><link rel="prefetch" href="/assets/js/240.af9c2cc9.js"><link rel="prefetch" href="/assets/js/241.388acab2.js"><link rel="prefetch" href="/assets/js/242.c60f2b48.js"><link rel="prefetch" href="/assets/js/243.d8e81b13.js"><link rel="prefetch" href="/assets/js/244.58b0b21d.js"><link rel="prefetch" href="/assets/js/245.c3768497.js"><link rel="prefetch" href="/assets/js/246.ac8bbe7a.js"><link rel="prefetch" href="/assets/js/247.d095f70a.js"><link rel="prefetch" href="/assets/js/248.e9f210b5.js"><link rel="prefetch" href="/assets/js/249.a9fad023.js"><link rel="prefetch" href="/assets/js/25.98e8593e.js"><link rel="prefetch" href="/assets/js/250.ae7f0ebb.js"><link rel="prefetch" href="/assets/js/251.9a617d55.js"><link rel="prefetch" href="/assets/js/252.ce082446.js"><link rel="prefetch" href="/assets/js/253.4575302d.js"><link rel="prefetch" href="/assets/js/254.5899a61b.js"><link rel="prefetch" href="/assets/js/255.66c69f31.js"><link rel="prefetch" href="/assets/js/256.8fd6c706.js"><link rel="prefetch" href="/assets/js/257.31b77e5e.js"><link rel="prefetch" href="/assets/js/258.eba48891.js"><link rel="prefetch" href="/assets/js/259.edf74b59.js"><link rel="prefetch" href="/assets/js/26.e69924ea.js"><link rel="prefetch" href="/assets/js/260.cf2ed36d.js"><link rel="prefetch" href="/assets/js/261.9e7792d8.js"><link rel="prefetch" href="/assets/js/262.e7b9433e.js"><link rel="prefetch" href="/assets/js/263.1185b25c.js"><link rel="prefetch" href="/assets/js/264.5e0f89cb.js"><link rel="prefetch" href="/assets/js/265.a38d3b94.js"><link rel="prefetch" href="/assets/js/266.2ef170b3.js"><link rel="prefetch" href="/assets/js/267.a7d14651.js"><link rel="prefetch" href="/assets/js/268.05b18748.js"><link rel="prefetch" href="/assets/js/269.dad48d6f.js"><link rel="prefetch" href="/assets/js/27.13612515.js"><link rel="prefetch" href="/assets/js/270.4f5a6b8d.js"><link rel="prefetch" href="/assets/js/271.7ebf6682.js"><link rel="prefetch" href="/assets/js/272.7c2fbfd1.js"><link rel="prefetch" href="/assets/js/273.8ee20732.js"><link rel="prefetch" href="/assets/js/274.d525242a.js"><link rel="prefetch" href="/assets/js/275.a8a19acb.js"><link rel="prefetch" href="/assets/js/276.df3a4eb4.js"><link rel="prefetch" href="/assets/js/277.336debda.js"><link rel="prefetch" href="/assets/js/278.c470625f.js"><link rel="prefetch" href="/assets/js/279.a91e1a64.js"><link rel="prefetch" href="/assets/js/28.ab7ae1df.js"><link rel="prefetch" href="/assets/js/280.87e25c9a.js"><link rel="prefetch" href="/assets/js/281.87c1ba25.js"><link rel="prefetch" href="/assets/js/282.dcd4dce0.js"><link rel="prefetch" href="/assets/js/283.abac2e00.js"><link rel="prefetch" href="/assets/js/284.f6079659.js"><link rel="prefetch" href="/assets/js/285.f1b39879.js"><link rel="prefetch" href="/assets/js/286.f6a79242.js"><link rel="prefetch" href="/assets/js/287.06bebe07.js"><link rel="prefetch" href="/assets/js/288.89e325df.js"><link rel="prefetch" href="/assets/js/289.3aa1bedd.js"><link rel="prefetch" href="/assets/js/29.ebe50f76.js"><link rel="prefetch" href="/assets/js/290.ee059c92.js"><link rel="prefetch" href="/assets/js/291.fa9a921a.js"><link rel="prefetch" href="/assets/js/292.2a8811cd.js"><link rel="prefetch" href="/assets/js/293.eec09cdf.js"><link rel="prefetch" href="/assets/js/294.dfac20dc.js"><link rel="prefetch" href="/assets/js/295.825d2070.js"><link rel="prefetch" href="/assets/js/296.f645861e.js"><link rel="prefetch" href="/assets/js/297.424fdb17.js"><link rel="prefetch" href="/assets/js/298.ebf87cdc.js"><link rel="prefetch" href="/assets/js/299.b8f19cbb.js"><link rel="prefetch" href="/assets/js/30.75237511.js"><link rel="prefetch" href="/assets/js/300.10fb6d4f.js"><link rel="prefetch" href="/assets/js/301.ef77c612.js"><link rel="prefetch" href="/assets/js/302.1b839763.js"><link rel="prefetch" href="/assets/js/303.609f7d98.js"><link rel="prefetch" href="/assets/js/304.1d255f19.js"><link rel="prefetch" href="/assets/js/305.b0234f2c.js"><link rel="prefetch" href="/assets/js/306.48677f64.js"><link rel="prefetch" href="/assets/js/307.14390d4b.js"><link rel="prefetch" href="/assets/js/308.fa730b28.js"><link rel="prefetch" href="/assets/js/309.0496b9e0.js"><link rel="prefetch" href="/assets/js/31.cf3f471a.js"><link rel="prefetch" href="/assets/js/310.a31676dc.js"><link rel="prefetch" href="/assets/js/311.ed53adc5.js"><link rel="prefetch" href="/assets/js/312.1b0ff2f1.js"><link rel="prefetch" href="/assets/js/313.bf123f32.js"><link rel="prefetch" href="/assets/js/314.4e6ce06b.js"><link rel="prefetch" href="/assets/js/315.8eb18560.js"><link rel="prefetch" href="/assets/js/32.74fef842.js"><link rel="prefetch" href="/assets/js/33.bc2d190b.js"><link rel="prefetch" href="/assets/js/34.d23438fc.js"><link rel="prefetch" href="/assets/js/35.7675c4d0.js"><link rel="prefetch" href="/assets/js/36.96a4161b.js"><link rel="prefetch" href="/assets/js/37.d1824f2f.js"><link rel="prefetch" href="/assets/js/38.4effff9e.js"><link rel="prefetch" href="/assets/js/39.6509914b.js"><link rel="prefetch" href="/assets/js/4.4d01750f.js"><link rel="prefetch" href="/assets/js/40.1509d08b.js"><link rel="prefetch" href="/assets/js/41.f2c1124f.js"><link rel="prefetch" href="/assets/js/42.e541d077.js"><link rel="prefetch" href="/assets/js/43.369de999.js"><link rel="prefetch" href="/assets/js/44.43959db0.js"><link rel="prefetch" href="/assets/js/45.282fbd31.js"><link rel="prefetch" href="/assets/js/46.1b83cfe9.js"><link rel="prefetch" href="/assets/js/47.c3a88e41.js"><link rel="prefetch" href="/assets/js/48.bc7c0a1b.js"><link rel="prefetch" href="/assets/js/49.92a4e5ba.js"><link rel="prefetch" href="/assets/js/5.c3991e24.js"><link rel="prefetch" href="/assets/js/50.9c488c6c.js"><link rel="prefetch" href="/assets/js/51.546ea632.js"><link rel="prefetch" href="/assets/js/52.0d2ccee1.js"><link rel="prefetch" href="/assets/js/53.6f52b5b1.js"><link rel="prefetch" href="/assets/js/54.c838b295.js"><link rel="prefetch" href="/assets/js/55.13af99ee.js"><link rel="prefetch" href="/assets/js/56.6be6d1ed.js"><link rel="prefetch" href="/assets/js/57.67c98b39.js"><link rel="prefetch" href="/assets/js/58.107e82ec.js"><link rel="prefetch" href="/assets/js/59.b3e5edc7.js"><link rel="prefetch" href="/assets/js/6.36a535f9.js"><link rel="prefetch" href="/assets/js/60.3b0b4ba5.js"><link rel="prefetch" href="/assets/js/61.3df843df.js"><link rel="prefetch" href="/assets/js/62.1213823d.js"><link rel="prefetch" href="/assets/js/63.e8f3f926.js"><link rel="prefetch" href="/assets/js/64.e1219050.js"><link rel="prefetch" href="/assets/js/65.5bf5bb0b.js"><link rel="prefetch" href="/assets/js/66.a2502afb.js"><link rel="prefetch" href="/assets/js/67.690dd59b.js"><link rel="prefetch" href="/assets/js/68.de7b0915.js"><link rel="prefetch" href="/assets/js/69.ac61dd61.js"><link rel="prefetch" href="/assets/js/7.5d254238.js"><link rel="prefetch" href="/assets/js/70.3edd41b1.js"><link rel="prefetch" href="/assets/js/71.d23407e9.js"><link rel="prefetch" href="/assets/js/72.a5bd01bc.js"><link rel="prefetch" href="/assets/js/73.c9f4dd57.js"><link rel="prefetch" href="/assets/js/74.66323fc1.js"><link rel="prefetch" href="/assets/js/75.e1a72e00.js"><link rel="prefetch" href="/assets/js/76.801268b4.js"><link rel="prefetch" href="/assets/js/77.3a5fda67.js"><link rel="prefetch" href="/assets/js/78.54d84cd4.js"><link rel="prefetch" href="/assets/js/79.fa10f4e3.js"><link rel="prefetch" href="/assets/js/8.e060e47d.js"><link rel="prefetch" href="/assets/js/80.d5b24fea.js"><link rel="prefetch" href="/assets/js/81.0e9da714.js"><link rel="prefetch" href="/assets/js/82.e96ff6d7.js"><link rel="prefetch" href="/assets/js/83.771cced1.js"><link rel="prefetch" href="/assets/js/84.220b69e7.js"><link rel="prefetch" href="/assets/js/85.7dcc5659.js"><link rel="prefetch" href="/assets/js/86.44ba2100.js"><link rel="prefetch" href="/assets/js/87.281da75d.js"><link rel="prefetch" href="/assets/js/88.12d88449.js"><link rel="prefetch" href="/assets/js/89.f28c86d3.js"><link rel="prefetch" href="/assets/js/9.8f9fef32.js"><link rel="prefetch" href="/assets/js/90.715cabb2.js"><link rel="prefetch" href="/assets/js/91.6ced7c82.js"><link rel="prefetch" href="/assets/js/92.c05b33ca.js"><link rel="prefetch" href="/assets/js/93.6bf5fb66.js"><link rel="prefetch" href="/assets/js/94.3561200e.js"><link rel="prefetch" href="/assets/js/95.0f2cf716.js"><link rel="prefetch" href="/assets/js/96.ac8487ea.js"><link rel="prefetch" href="/assets/js/97.48042b5a.js"><link rel="prefetch" href="/assets/js/98.441bb7f8.js"><link rel="prefetch" href="/assets/js/99.4b214d92.js">
    <link rel="stylesheet" href="/assets/css/0.styles.56073ad3.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu"><header class="navbar blur"><div title="目录" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/img/magic.png" alt="Pangolin Note" class="logo"> <span class="site-name can-hide">Pangolin Note</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">🏡首页</a></div><div class="nav-item"><a href="/basic/" class="nav-link">基础</a></div><div class="nav-item"><a href="/develop/" class="nav-link">开发</a></div><div class="nav-item"><a href="/middleware/" class="nav-link">系统</a></div><div class="nav-item"><a href="/algorithm/" class="nav-link">算法</a></div><div class="nav-item"><a href="/books/" class="nav-link">🍀读书笔记</a></div><div class="nav-item"><a href="/work/" class="nav-link">工作</a></div><div class="nav-item"><a href="/pangolin/" class="nav-link">🌸达尔文的猹</a></div><div class="nav-item"><a href="/pages/beb6c0bd8a66cea6/" class="nav-link">收藏</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/archives/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">归档</a></li></ul></div></div> <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><div class="blogger"><img src="/img/avatarnew.png"> <div class="blogger-info"><h3>达尔文的猹</h3> <span>大道至简 悟在天成</span></div></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">🏡首页</a></div><div class="nav-item"><a href="/basic/" class="nav-link">基础</a></div><div class="nav-item"><a href="/develop/" class="nav-link">开发</a></div><div class="nav-item"><a href="/middleware/" class="nav-link">系统</a></div><div class="nav-item"><a href="/algorithm/" class="nav-link">算法</a></div><div class="nav-item"><a href="/books/" class="nav-link">🍀读书笔记</a></div><div class="nav-item"><a href="/work/" class="nav-link">工作</a></div><div class="nav-item"><a href="/pangolin/" class="nav-link">🌸达尔文的猹</a></div><div class="nav-item"><a href="/pages/beb6c0bd8a66cea6/" class="nav-link">收藏</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/archives/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">归档</a></li></ul></div></div> <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>系统</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading"><span>分布式系统理论</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/129626/" class="sidebar-link">分布式系统基础</a></li><li><a href="/pages/fb5d35/" class="sidebar-link">分布式共识算法</a></li><li><a href="/pages/12ac37/" class="sidebar-link">分布式系统组件</a></li><li><a href="/pages/d03ebf/" class="sidebar-link">分布式技术原理与算法解析(极客时间)🌸</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading"><span>系统接入层</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/f1b6c4/" class="sidebar-link">Nginx基础</a></li><li><a href="/pages/d4123d/" class="sidebar-link">深入拆解Tomcat与Jetty(极客时间)🌸</a></li><li><a href="/pages/baee2f/" class="sidebar-link">Netty</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading"><span>服务治理-注册发现与RPC</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/05077d/" class="sidebar-link">基础</a></li><li><a href="/pages/51b6aa/" class="sidebar-link">RPC实战与核心原理(极客时间)🌸</a></li><li><a href="/pages/0966ee/" class="sidebar-link">Zookeeper</a></li><li><a href="/pages/3b7e05/" class="sidebar-link">Nacos</a></li><li><a href="/pages/7f31f8/" class="sidebar-link">Dubbo</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading"><span>服务治理-流量控制</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/44bfa8/" class="sidebar-link">负载均衡</a></li><li><a href="/pages/4d5a6c/" class="sidebar-link">限流</a></li><li><a href="/pages/e0c561/" class="sidebar-link">熔断</a></li><li><a href="/pages/12ae40/" class="sidebar-link">网关路由</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading"><span>服务治理-系统监控与安全</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/8c9210/" class="sidebar-link">系统安全性</a></li><li><a href="/pages/c9bf40/" class="sidebar-link">系统监控组件</a></li><li><a href="/pages/3f3cf7/" class="sidebar-link">运维监控系统实战(极客时间)🌸</a></li><li><a href="/pages/e20e02/" class="sidebar-link">OAuth2.0实战课(极客时间)🌟</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading"><span>中间件-消息队列</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/96d94c/" class="sidebar-link">消息队列基础</a></li><li><a href="/pages/abf16c/" class="sidebar-link">RabbitMQ</a></li><li><a href="/pages/4fc3f1/" class="sidebar-link">Kafka</a></li><li><a href="/pages/013cfe/" class="sidebar-link">RocketMQ</a></li><li><a href="/pages/ed8d92/" class="sidebar-link">Disruptor</a></li><li><a href="/pages/249149/" class="sidebar-link">消息队列高手课(极客时间)🌟</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading open"><span>中间件-缓存</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/946847/" class="sidebar-link">缓存基础</a></li><li><a href="/pages/e46d56/" class="sidebar-link">本地缓存</a></li><li><a href="/pages/0abfb9/" class="sidebar-link">Redis基础</a></li><li><a href="/pages/09236a/" class="sidebar-link">Redis持久化</a></li><li><a href="/pages/867f9b/" class="sidebar-link">Redis主从复制</a></li><li><a href="/pages/50cae1/" class="sidebar-link">Redis哨兵</a></li><li><a href="/pages/43b45c/" aria-current="page" class="active sidebar-link">Redis集群</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/pages/a32379/" class="sidebar-link">Redis内存管理与运维</a></li><li><a href="/pages/386037/" class="sidebar-link">Redis核心技术与实战(极客时间)🌸</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading"><span>中间件-其他</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/23044d/" class="sidebar-link">定时任务-XXLJob</a></li><li><a href="/pages/459117/" class="sidebar-link">ES与检索</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading"><span>系统设计与优化</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/41a845/" class="sidebar-link">凤凰架构</a></li><li><a href="/pages/68cc0b/" class="sidebar-link">左耳听风(极客时间)🌟</a></li><li><a href="/pages/e3e99c/" class="sidebar-link">从0开始学微服务(极客时间)🌸</a></li><li><a href="/pages/1e5368/" class="sidebar-link">高并发系统设计40问(极客时间)🌸</a></li><li><a href="/pages/33599f/" class="sidebar-link">系统性能调优必知必会(极客时间)🌸</a></li><li><a href="/pages/c83472/" class="sidebar-link">后端技术面试38讲(极客时间)</a></li><li><a href="/pages/4404b6/" class="sidebar-link">架构实战案例解析(极客时间)🌸</a></li><li><a href="/pages/8f1c1d/" class="sidebar-link">如何设计一个秒杀系统(极客时间)</a></li></ul></section></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>容器</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading open"><span>容器</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/582acf/" class="sidebar-link">部署Minikube</a></li><li><a href="/pages/98e5e4/" class="sidebar-link">容器实战高手课(极客时间)🌸</a></li><li><a href="/pages/c6a42c/" class="sidebar-link">Kubernetes实战🌸</a></li><li><a href="/pages/f35c72/" class="sidebar-link">深入剖析Kubernetes(极客时间)🌸</a></li><li><a href="/pages/caa314/" class="sidebar-link">Istio</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading"><span>自动化运维</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/beb97f/" class="sidebar-link">持续集成(CICD)</a></li><li><a href="/pages/a0df2d/" class="sidebar-link">DevOps</a></li><li><a href="/pages/765815/" class="sidebar-link">SRE实战手册(极客时间)</a></li></ul></section></li></ul></section></li></ul> </aside> <div><main class="page"><div class="theme-vdoing-wrapper "><div class="articleInfo-wrap" data-v-06970110><div class="articleInfo" data-v-06970110><ul class="breadcrumbs" data-v-06970110><li data-v-06970110><a href="/" title="首页" class="iconfont icon-home router-link-active" data-v-06970110></a></li> <li data-v-06970110><a href="/middleware/#系统" data-v-06970110>系统</a></li><li data-v-06970110><a href="/middleware/#系统" data-v-06970110>系统</a></li><li data-v-06970110><a href="/middleware/#中间件-缓存" data-v-06970110>中间件-缓存</a></li></ul> <div class="info" data-v-06970110><div title="作者" class="author iconfont icon-touxiang" data-v-06970110><a href="https://github.com/nanodaemony" target="_blank" title="作者" class="beLink" data-v-06970110>NanoDaemony</a></div> <div title="创建时间" class="date iconfont icon-riqi" data-v-06970110><a href="javascript:;" data-v-06970110>2025-02-26</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-title">本文目录</div> <div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABH1JREFUSA3tVl1oHFUUPmdmd2ltklqbpJDiNnXFmgbFktho7YMPNiJSSZM0+CAYSkUELVhM6YuwIPpgoOKDqOBDC0XE2CQoNtQXBUFTTcCi+Wlh1V2TQExsUzcltd3M9Tt3ZjZzZ2fT+OJTL8yeM+eee757fmeJbq//KQL8X3DUSFOcfr7cRsRtxNQMWueeVzOkaITIGqQHNg5y8+jNW9ldM7A6nTpAjuolUikAwq7CE3WcM2RRDz+XGVgN3FptU/aUSlvq9Pa3iZ1+sgAqJyyAFqkipd9dqiwHF3P65YycLWc/6sqGrvoEoIp6DOFaX5h6+dnfjkWprwqsPk0dUGq5vySwDImC10KxFHgGL1SWoc92O3eVht09qdXNH11I2SsTsJYqMWzihqGMi+A+Garf3BAuuLI5oGlULyNfyB/HYNujwktOfRrMr5t77NmevqaUopx0grnKAyvVpmwUDB4x6FPXuGvYLTDwWsejwgtgkYKPqRJg8SV6xaiZ3ZTppGneS4yfH5/66fZSDHv+QZci/+h5c5UHtpy67JUqGppM0sh0Nc1dW6/N1W5Yoqat8/TU/VnadmdeW2PLLSyh0cvxBs3KbqTmwYPpxN4do/mzE8nEpvX/UMu2Wbp74zUAK5q6WkHns7V0eWkdPbPzd3rxkTGybadYySumVzhcaJFbs5UrEkQ/+CK8gF5dnh/6ciIZ73gwQ927L1IitoxKLXYP3SjYdOrHHfTZhRRlFyrorafPk20B3HPD1y2G3qKZME5Jcf3t/HUC13/8tSd++vqFveMUTwAUxSUFI1QekR1+bIze3D9MF2aq6cPvG72CgnldWCFqyRw3lwH8ZMerjTD9ElRO7Gv44wNpC90aASqGfVlz/Rx17srQ57/UU26hkhQqUB7dBR71WmzQhHUnblGmVOEw0jhbV1n9OlXUDCIRGaNV5Jp43N516fN7JmnTHdfp7Hgy0luO4aMhtkLL8Bi3bUWYvzh5Mn1dTxrL6QmGuRhGL/TiTTxRoEdTszSaq9GR0NGA3KdkOz3hqSV3MIDhQ5IVX/Ivx3umBti2es2h4eZby7x8br1rkf7Mo90AqC8aQ3sJeNzqFRu+vSANAQe3PL7l0HGOAdwDCeZYvNKeoZp1Qfs6Aipndh86HmFRi0LAnEO47wsqM6cdfjh3jBPUzhZy7nvlUfFsamED1VQt6aISHVymXZ/B2aCtIG8AI8xfobj2d3en1wWVhOeHELKmLQ1s211s88comkv4UCwWyF787mJdYXtNfhKAXVqnKTq8QZvGAGGOfaTo5pGZ/PwbUCr5+DPr/1J92JNHr9aOl/F3iI5+O1nfybsGxoimvZ3ViWSluDITw3P37mypheDIPY0tw7+O/5ApbkYw+zpfaUVu32Pi98+defdUhEpZkRFq0aqyNh9FuL9hpYbEm6iwi0z2REd09ZmyENEbuhjDWzKvZXTqKYaBIr3tt5kuPtQBZFvEUwHt60vfCNu41XsksH9Ij1BMMz1Y0OOunHNShFIP5868g5zeXmuLwL9T4b6Q2+KejgAAAABJRU5ErkJggg==">Redis集群<!----></h1>  <div class="theme-vdoing-content content__default"><h1 id="_34-redis集群"><a href="#_34-redis集群" class="header-anchor">#</a> 34.Redis集群</h1> <h4 id="集群架构基础"><a href="#集群架构基础" class="header-anchor">#</a> 集群架构基础</h4> <h5 id="_1-集群架构"><a href="#_1-集群架构" class="header-anchor">#</a> 1.集群架构</h5> <p>在 Redis3.0 以前的版本要实现集群一般是借助哨兵 Sentinel 工具来监控 master 节点的状态, 如果 master 节点异常, 则会做主从切换, 将某一台 slave 作为 master, <strong>哨兵的配置略微复杂, 并且性能和高可用性等各方面表现一般, 特别是在主从切换的瞬间存在访问闪断的情况, 而且哨兵模式只有一个主节点对外提供服务, 没法支持很高的并发, 且单个主节点内存也不宜设置得过大, 否则会导致持久化文件过大, 影响数据恢复或主从同步的效率.</strong></p> <p>因此演变出了 Redis 集群架构.</p> <p><img src="/img/image-20240106211006-eukxvsd.png" alt="image"></p> <p>Redis Cluster 是 Redis 的<strong>分布式</strong>解决方案. 当遇到单机<strong>内存, 并发, 流量等瓶颈</strong>时可以采用 cluster 架构的解决方案. Redis 集群是一个由多个主从节点群组成的分布式服务器群, 它具有复制, 高可用和分片特性. Redis 集群<strong>不需要 sentinel 哨兵也能完成节点移除和故障转移的功能</strong>. 需要将每个节点设置成集群模式, 这种集群模式没有中心节点, 可水平扩展, 据官方文档称可以线性扩展到上万个节点(官方推荐不超过 1000 个节点). Redis 集群的性能和高可用性均优于之前版本的哨兵模式, 且集群配置非常简单.</p> <p>集群中的每一个 Redis 节点都<strong>互相两两相连</strong>, 客户端任意<strong>直连</strong>到集群中的<strong>任意一台</strong>, 就可以对其他 Redis 节点进行<strong>读写</strong>操作.</p> <p><img src="https://nano-note.oss-cn-beijing.aliyuncs.com/images/image-20220523222556276.png" alt=""></p> <blockquote><p>集群的作用</p></blockquote> <p>**数据分区: ** 数据分区(或称数据分片)是集群最核心的功能. 集群将数据分散到多个节点, 一方面突破了 Redis 单机内存大小的限制, <strong>存储容量大大增加</strong>; <strong>另一方面</strong>每个主节点都可以对外提供读服务和写服务, <strong>大大提高了集群的响应能力</strong>.</p> <p><strong>高可用: <strong>​<strong><strong>集群支持</strong></strong>​</strong>主从复制</strong>和主节点的<strong>自动故障转移</strong>(与哨兵类似), 当任一节点发生故障时, 集群仍然可以对外提供服务.</p> <blockquote><p>集群的限制</p></blockquote> <p>Redis 集群相对单机在功能上存在一些限制.</p> <ul><li>对 <strong>key 的批量操作支持有限</strong>. 如 mset, mget, 目前只支持具有<strong>相同 slot 值</strong>的 key 执行批量操作. 对于映射为不同 slot 值的 key 由于执行 mget, mget 等操作可能存在于多个节点上因此不被支持.</li> <li><strong>key 事务操作支持有限</strong>. 同理只支持多 key 在<strong>同一节点</strong>上的事务操作, 当多个 key 分布在不同的节点上时无法使用事务功能.</li> <li>key 作为数据分区的最小粒度, 因此<strong>不能将一个大</strong>的键值对象如 hash, list 等映射到不同的节点.</li> <li>不支持多数据库空间. 单机下的 Redis 可以支持 16 个数据库, 集群模式下<strong>只能使用一个</strong>数据库空间, 即 db0.</li> <li>复制结构<strong>只支持一层</strong>, 从节点只能复制主节点, 不支持嵌套树状复制结构.</li></ul> <h5 id="_2-redis集群数据分区🌟"><a href="#_2-redis集群数据分区🌟" class="header-anchor">#</a> 2.Redis集群数据分区🌟</h5> <p>对于分布式存储来说, 有不同的数据存储分区方式, 参考: 数据分布方式.</p> <p><strong>Redis Cluster</strong> 就是<strong>采用虚拟槽分区</strong>. 所有<strong>键</strong>根据<strong>哈希函数</strong>映射到 <strong>0 ~ 16383</strong> 整数槽内, Cluster 默认会对 key 值使用 <strong>crc16 算法</strong>进行 hash 得到一个整数值, 然后用这个整数值对 16384 进行取模来得到具体槽位. 计算公式: <strong>==slot = CRC16(key) &amp; 16383==</strong>. 每一个节点负责维护一部分<strong>槽以及槽所映射的键值数据</strong>.</p> <p><img src="https://nano-note.oss-cn-beijing.aliyuncs.com/images/image-20220523220809355.png" alt=""></p> <p>一个集群中分槽的例子.</p> <p><img src="https://nano-note.oss-cn-beijing.aliyuncs.com/images/image-20220523220845778.png" alt=""></p> <p>当前集群有 <strong>5 个节点</strong>, 每个节点平均大约负责 <strong>3276</strong> 个槽. 由于采用<strong>高质量的哈希算法</strong>, 每个槽所映射的数据通常比较均匀, 将数据平均划分到 5 个节点进行<strong>数据分区</strong>.</p> <p><strong>当 Redis Cluster 的客户端来连接集群时, 它也会得到一份集群的槽位配置信息并将其缓存在客户端本地</strong>. 这样当客户端要查找某个 key 时, 可以直接定位到目标节点. 同时因为槽位的信息可能会存在客户端与服务器不一致的情况, 还需要纠正机制来实现槽位信息的校验调整.</p> <h4 id="集群配置"><a href="#集群配置" class="header-anchor">#</a> 集群配置</h4> <p>搭建集群的三个步骤:</p> <ul><li>准备节点.</li> <li>节点握手.</li> <li>分配槽.</li></ul> <h5 id="_1-节点准备"><a href="#_1-节点准备" class="header-anchor">#</a> 1.节点准备</h5> <p>Redis 集群一般由多个节点组成, 节点数量<strong>至少为 6 个</strong>才能保证组成完整高可用的集群. 每个节点需要<strong>开启配置 &quot;cluster-enabled yes&quot;</strong> , 让 Redis 运行在集群模式下.</p> <p>建议为集群内所有节点<strong>统一目录</strong>, 一般划分三个目录: <strong>conf, data, log</strong>, 分别存放<strong>配置, 数据和日志</strong>相关文件. 把 6 个节点<strong>配置</strong>统一放在 conf 目录下, 集群相关配置如下:</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># 节点端口</span>
port <span class="token number">6379</span>
<span class="token comment"># 开启集群模式</span>
cluster-enabled <span class="token function">yes</span>
<span class="token comment"># 节点超时时间, 单位毫秒</span>
cluster-node-timeout <span class="token number">15000</span>
<span class="token comment"># 集群内部配置文件</span>
cluster-config-file <span class="token string">&quot;nodes-6379.conf&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>其他配置和<strong>单机模式一致</strong>即可, 这里配置文件命名规则 <strong>redis-{port}.conf</strong>, 准备好配置后<strong>启动所有节点</strong>.</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ redis-server conf/redis-6379.conf
$ redis-server conf/redis-6380.conf
$ redis-server conf/redis-6381.conf
$ redis-server conf/redis-6382.conf
$ redis-server conf/redis-6383.conf
$ redis-server conf/redis-6384.conf
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>检查<strong>节点日志</strong>是否正确, 日志内容如下:</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ <span class="token function">cat</span> log/redis-6379.log
* No cluster configuration found, I'm cfb28ef1deee4e0fa78da86abe5d24566744411e
<span class="token comment"># Server started, Redis version 3.0.7</span>
* The server is now ready to accept connections on port <span class="token number">6379</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>6379 节点<strong>启动成功</strong>, 第一次启动时如果没有集群配置文件, 它会<strong>自动创建</strong>一份.</p> <p>集群模式的 Redis 除了原有的配置文件之外<strong>又加了一份集群配置文件</strong>. 当集群内节点信息发生变化, 如添加节点, 节点下线, 故障转移等. 节点会<strong>自动保存</strong>集群状态到配置文件中. 需要注意的是, Redis <strong>自动维护集群配置文件</strong>, 不要手动修改, 防止节点重启时产生集群信息错乱.</p> <p>节点 6379 首次启动后生成集群配置如下:</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ <span class="token function">cat</span> data/nodes-6379.conf
cfb28ef1deee4e0fa78da86abe5d24566744411e <span class="token number">127.0</span>.0.1:6379 myself,master - <span class="token number">0</span> <span class="token number">0</span> <span class="token number">0</span> connected
vars currentEpoch <span class="token number">0</span> lastVoteEpoch <span class="token number">0</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>文件内容记录了集群<strong>初始状态</strong>, 这里最重要的是<strong>节点 ID</strong>, 它是一个 40 位 16 进制字符串, 用于<strong>唯一标识集群内一个节点</strong>, 之后很多集群操作都要借助于节点 ID 完成. 注意: 节点 ID <strong>不同于运行 ID</strong>. 节点 ID 在集群初始化时<strong>只创建一次</strong>, 节点重启时会加载集群配置文件进行<strong>重用</strong>, 而 Redis 的<strong>运行 ID 每次重启都会变化</strong>.</p> <p>在节点 6380 执行 <strong>cluster nodes</strong> 命令获取集群节点状态:</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token number">127.0</span>.0.1:638<span class="token operator"><span class="token file-descriptor important">0</span>&gt;</span> cluster nodes
8e41673d59c9568aa9d29fb174ce733345b3e8f1 <span class="token number">127.0</span>.0.1:6380 myself,master - <span class="token number">0</span> <span class="token number">0</span> <span class="token number">0</span> connected
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>每个节点目前只能识别出<strong>自己</strong>的节点信息. 如果启动 6 个节点, 但每个节点彼此并不知道对方的存在, 需要通过<strong>节点握手</strong>让 6 个节点彼此<strong>建立联系</strong>从而组成一个集群.</p> <h5 id="_2-节点握手"><a href="#_2-节点握手" class="header-anchor">#</a> 2.节点握手</h5> <p>节点握手是指一批运行在集群模式下的节点通过 <strong>Gossip 协议</strong>彼此通信, 达到感知对方的过程. 节点握手是集群彼此通信的第一步, 由<strong>客户端</strong>发起命令: <strong>cluster meet {ip} {port}</strong> . 两个结点直接先用 <strong>meet</strong> 消息进行握手(成功后回复 pong 消息), 然后使用 <strong>ping/pong</strong> 消息维护<strong>正常通信</strong>.</p> <p><img src="https://nano-note.oss-cn-beijing.aliyuncs.com/images/image-20220523223000635.png" alt=""></p> <p>只需要在集群内<strong>任意节点</strong>上执行 cluster meet 命令<strong>加入新节点</strong>, 握手状态会通过<strong>消息</strong>在集群内<strong>传播</strong>, 这样其他节点会<strong>自动发现新节点并发起握手流程</strong>.</p> <p>最后执行 cluster nodes 命令确认 6 个节点都彼此感知并组成集群:</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> cluster nodes
4fa7eac4080f0b667ffeab9b87841da49b84a6e4 <span class="token number">127.0</span>.0.1:6384 master - <span class="token number">0</span> <span class="token number">1468073975551</span>
<span class="token number">5</span> connected
cfb28ef1deee4e0fa78da86abe5d24566744411e <span class="token number">127.0</span>.0.1:6379 myself,master - <span class="token number">0</span> <span class="token number">0</span> <span class="token number">0</span> connected
be9485a6a729fc98c5151374bc30277e89a461d8 <span class="token number">127.0</span>.0.1:6383 master - <span class="token number">0</span> <span class="token number">1468073978579</span>
<span class="token number">4</span> connected
40622f9e7adc8ebd77fca0de9edfe691cb8a74fb <span class="token number">127.0</span>.0.1:6382 master - <span class="token number">0</span> <span class="token number">1468073980598</span>
<span class="token number">3</span> connected
8e41673d59c9568aa9d29fb174ce733345b3e8f1 <span class="token number">127.0</span>.0.1:6380 master - <span class="token number">0</span> <span class="token number">1468073974541</span>
<span class="token number">1</span> connected
40b8d09d44294d2e23c7c768efc8fcd153446746 <span class="token number">127.0</span>.0.1:6381 master - <span class="token number">0</span> <span class="token number">1468073979589</span>
<span class="token number">2</span> connected
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>节点建立握手之后集群<strong>还不能正常工作</strong>, 这时集群处于<strong>下线状态</strong>, 所有数据读写都被禁止. 因为目前所有的<strong>槽</strong>没有分配到节点, 因此<strong>集群无法完成槽到节点的映射</strong>. 只有当 16384 个槽<strong>全部分配</strong>给节点后, 集群才进入<strong>在线状态</strong>.</p> <h5 id="_3-分配数据槽"><a href="#_3-分配数据槽" class="header-anchor">#</a> 3.分配数据槽</h5> <p>Redis 集群把所有的数据映射到 <strong>16384 个槽</strong>中. 每个 key 会映射为一个<strong>固定的槽</strong>, 只有当节点分配了槽, 才能响应与这些槽关联的键命令.</p> <p><img src="https://nano-note.oss-cn-beijing.aliyuncs.com/images/image-20220523224414128.png" alt=""></p> <p>Redis 集群中内置了 <strong>16384</strong> 个哈希槽. 当客户端连接到 Redis 集群后, 会同时得到一份关于这个<strong>集群的配置信息</strong>, 当客户端具体对某一个 <strong>key 值</strong>进行操作时, 会计算出它的一个 <strong>Hash 值</strong>, 然后把<strong>结果对 16384 求余数</strong>, 这样每个 key 都会<strong>对应一个编号在 0-16383 之间的哈希槽</strong>, Redis 会根据节点数量 <strong>大致均等</strong> 的将哈希槽映射到不同的节点.</p> <p>通过 <strong>cluster addslots</strong> 命令为节点分配槽. 这里利用 bash 特性批量设置槽, 命令如下:</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ redis-cli <span class="token parameter variable">-h</span> <span class="token number">127.0</span>.0.1 <span class="token parameter variable">-p</span> <span class="token number">6379</span> cluster addslots <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">..</span>.5461<span class="token punctuation">}</span>
$ redis-cli <span class="token parameter variable">-h</span> <span class="token number">127.0</span>.0.1 <span class="token parameter variable">-p</span> <span class="token number">6380</span> cluster addslots <span class="token punctuation">{</span><span class="token number">5462</span><span class="token punctuation">..</span>.10922<span class="token punctuation">}</span>
$ redis-cli <span class="token parameter variable">-h</span> <span class="token number">127.0</span>.0.1 <span class="token parameter variable">-p</span> <span class="token number">6381</span> cluster addslots <span class="token punctuation">{</span><span class="token number">10923</span><span class="token punctuation">..</span>.16383<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>把 16384 个 slot 平均分配给 6379, 6380, 6381 <strong>三个</strong>节点. 执行 cluster info 查看集群状态, 如下所示:</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> cluster info
cluster_state:ok
cluster_slots_assigned:16384
cluster_slots_ok:16384
cluster_slots_pfail:0
cluster_slots_fail:0
cluster_known_nodes:6
cluster_size:3
cluster_current_epoch:5
cluster_my_epoch:0
cluster_stats_messages_sent:4874
cluster_stats_messages_received:4726
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>当前集群状态是 OK, 集群进入<strong>在线状态</strong>. 所有的槽都已经分配给节点, 执行 cluster nodes 命令可以看到<strong>节点和槽的分配关系</strong>:</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> cluster nodes
4fa7eac4080f0b667ffeab9b87841da49b84a6e4 <span class="token number">127.0</span>.0.1:6384 master - <span class="token number">0</span> <span class="token number">1468076240123</span>
<span class="token number">5</span> connected
cfb28ef1deee4e0fa78da86abe5d24566744411e <span class="token number">127.0</span>.0.1:6379 myself,master - <span class="token number">0</span> <span class="token number">0</span> <span class="token number">0</span> connected
<span class="token number">0</span>-5461
be9485a6a729fc98c5151374bc30277e89a461d8 <span class="token number">127.0</span>.0.1:6383 master - <span class="token number">0</span> <span class="token number">1468076239622</span>
<span class="token number">4</span> connected
40622f9e7adc8ebd77fca0de9edfe691cb8a74fb <span class="token number">127.0</span>.0.1:6382 master - <span class="token number">0</span> <span class="token number">1468076240628</span>
<span class="token number">3</span> connected
8e41673d59c9568aa9d29fb174ce733345b3e8f1 <span class="token number">127.0</span>.0.1:6380 master - <span class="token number">0</span> <span class="token number">1468076237606</span>
<span class="token number">1</span> connected
<span class="token number">5462</span>-10922
40b8d09d44294d2e23c7c768efc8fcd153446746 <span class="token number">127.0</span>.0.1:6381 master - <span class="token number">0</span> <span class="token number">1468076238612</span>
<span class="token number">2</span> connected
<span class="token number">10923</span>-16383
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>目前还有三个节点<strong>没有使用</strong>, 作为一个完整的集群, 每个负责<strong>处理槽的节点应该具有从节点</strong>, 保证当它出现故障时可以<strong>自动进行故障转移</strong>. 集群模式下, Reids 节点角色分为<strong>主节点和从节点</strong>. 首次启动的节点和<strong>被分配槽的节点都是主节点</strong>, 从节点负责<strong>复制</strong>主节点槽信息和相关的数据.</p> <p>使用 <strong>cluster replicate {nodeId}</strong>  命令让一个节点成为<strong>从节点</strong>. 其中命令执行必须在对应的<strong>从节点上</strong>执行, nodeId 是要复制主节点的节点 ID, 命令如下:</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token number">127.0</span>.0.1:638<span class="token operator"><span class="token file-descriptor important">2</span>&gt;</span>cluster replicate cfb28ef1deee4e0fa78da86abe5d24566744411e
OK
<span class="token number">127.0</span>.0.1:638<span class="token operator"><span class="token file-descriptor important">3</span>&gt;</span>cluster replicate 8e41673d59c9568aa9d29fb174ce733345b3e8f1
OK
<span class="token number">127.0</span>.0.1:638<span class="token operator"><span class="token file-descriptor important">4</span>&gt;</span>cluster replicate 40b8d09d44294d2e23c7c768efc8fcd153446746
OK
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>Redis 集群模式下的主从复制使用了之前介绍的 Redis 复制流程, 依然<strong>支持全量和部分复制. <strong>​<strong><strong>复制完成后, 整个集群的</strong></strong>​</strong>结构</strong>如下图所示.</p> <p><img src="https://nano-note.oss-cn-beijing.aliyuncs.com/images/image-20220523224624184.png" alt=""></p> <p>上述即依照 Redis 协议<strong>手动建立</strong>一个集群. 它由 6 个节点构成, 3 个主节点负责处理槽和相关数据, 3 个从节点负责故障转移. 手动比较复杂, Redis 官方提供了 <strong>redis-trib.rb</strong> 工具方便快速搭建集群, 用这个工具需要安装 Ruby 环境.</p> <h5 id="_4-集群搭建完整示例"><a href="#_4-集群搭建完整示例" class="header-anchor">#</a> 4.集群搭建完整示例</h5> <p><strong>(1)第一步: 创建集群节点配置文件</strong></p> <p>创建一个名为 <strong>redis-cluster</strong> 的目录:</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token function">mkdir</span> <span class="token parameter variable">-p</span> ~/Desktop/redis-cluster
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>然后创建<strong>六个</strong>配置文件, 分别命名为: <strong>redis_7000.conf/redis_7001.conf.....redis_7005.conf</strong>, 然后根据不同的端口号修改对应的端口值就好了:</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># 后台执行</span>
daemonize <span class="token function">yes</span>
<span class="token comment"># 端口号</span>
port <span class="token number">7000</span>
<span class="token comment"># 为每一个集群节点指定一个 pid_file</span>
pidfile ~/Desktop/redis-cluster/redis_7000.pid
<span class="token comment"># 启动集群模式</span>
cluster-enabled <span class="token function">yes</span>
<span class="token comment"># 每一个集群节点都有一个配置文件, 这个文件是不能手动编辑的. 确保每一个集群节点的配置文件不通</span>
cluster-config-file nodes-7000.conf
<span class="token comment"># 集群节点的超时时间, 单位: ms, 超时后集群会认为该节点失败</span>
cluster-node-timeout <span class="token number">5000</span>
<span class="token comment"># 最后将 appendonly 改成 yes(AOF 持久化)</span>
appendonly <span class="token function">yes</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>记得把对应上述配置文件中<strong>根端口对应的配置都修改掉</strong>(port/ pidfile/ cluster-config-file).</p> <p><strong>(2)第二步: 分别启动6个Redis实例</strong></p> <p>根据 6 个配置文件启动 6 个 Redis 实例.</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ redis-server ~/redis-cluster/redis_7000.conf
$ redis-server ~/redis-cluster/redis_7001.conf
$ redis-server ~/redis-cluster/redis_7002.conf
$ redis-server ~/redis-cluster/redis_7003.conf
$ redis-server ~/redis-cluster/redis_7004.conf
$ redis-server ~/redis-cluster/redis_7005.conf
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>执行 <strong>ps -ef | grep redis</strong> 查看是否启动成功:</p> <p><img src="https://nano-note.oss-cn-beijing.aliyuncs.com/images/7896890-452c3152054c36f1.png" alt=""></p> <p>可以看到 6 个 Redis 节点都以集群方式成功启动, <strong>但现在每个节点还处于独立的状态</strong>, 也就是说它们每一个都各自成了一个集群, 还没有互相联系起来, 需要手动地把它们之间建立起联系.</p> <p><strong>(3)第三步: 建立集群</strong></p> <p>执行下列命令:</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ redis-cli <span class="token parameter variable">--cluster</span> create --cluster-replicas <span class="token number">1</span> <span class="token number">127.0</span>.0.1:7000 <span class="token number">127.0</span>.0.1:7001 <span class="token number">127.0</span>.0.1:7002 <span class="token number">127.0</span>.0.1:7003 <span class="token number">127.0</span>.0.1:7004 <span class="token number">127.0</span>.0.1:7005
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>这里  <strong>--replicas 1</strong> 的意思是: 希望为集群中的<strong>每个主节点创建一个从节点</strong>.</p> <p>观察输出:</p> <p><img src="https://nano-note.oss-cn-beijing.aliyuncs.com/images/7896890-d5ab644e76e9cc87.png" alt=""></p> <p>看到  <strong>[OK]</strong>  就表示集群已经搭建成功了, 这里成功创建了<strong>三主三从</strong>的集群.</p> <p><strong>(4)第四步: 验证集群</strong></p> <p>先使用 <strong>redis-cli</strong> 任意连接一个节点:</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>redis-cli <span class="token parameter variable">-c</span> <span class="token parameter variable">-h</span> <span class="token number">127.0</span>.0.1 <span class="token parameter variable">-p</span> <span class="token number">7000</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><ul><li><strong>-c 表示集群模式; -h 指定 ip 地址; -p 指定端口.</strong></li></ul> <p>然后随便 &quot;set&quot; 一些值观察控制台输入:</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token number">127.0</span>.0.1:700<span class="token operator"><span class="token file-descriptor important">0</span>&gt;</span> SET name wmyskxz
-<span class="token operator">&gt;</span> Redirected to slot <span class="token punctuation">[</span><span class="token number">5798</span><span class="token punctuation">]</span> located at <span class="token number">127.0</span>.0.1:7001
OK
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>可以看到 Redis 自动进行了 <strong>Redirected 操作</strong>跳转到了 7001 这个实例上.</p> <p>再使用 <strong>cluster info(查看集群信息) 和 cluster nodes</strong>(查看节点列表) 来分别看看(任意节点输入均可):</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token number">127.0</span>.0.1:700<span class="token operator"><span class="token file-descriptor important">1</span>&gt;</span> CLUSTER INFO
cluster_state:ok
cluster_slots_assigned:16384
cluster_slots_ok:16384
cluster_slots_pfail:0
cluster_slots_fail:0
cluster_known_nodes:6
cluster_size:3
cluster_current_epoch:6
cluster_my_epoch:2
cluster_stats_messages_ping_sent:1365
cluster_stats_messages_pong_sent:1358
cluster_stats_messages_meet_sent:4
cluster_stats_messages_sent:2727
cluster_stats_messages_ping_received:1357
cluster_stats_messages_pong_received:1369
cluster_stats_messages_meet_received:1
cluster_stats_messages_received:2727

<span class="token number">127.0</span>.0.1:700<span class="token operator"><span class="token file-descriptor important">1</span>&gt;</span> CLUSTER NODES
56a04742f36c6e84968cae871cd438935081e86f <span class="token number">127.0</span>.0.1:7003@17003 slave 4ec8c022e9d546c9b51deb9d85f6cf867bf73db6 <span class="token number">0</span> <span class="token number">1584428884000</span> <span class="token number">4</span> connected
4ec8c022e9d546c9b51deb9d85f6cf867bf73db6 <span class="token number">127.0</span>.0.1:7000@17000 master - <span class="token number">0</span> <span class="token number">1584428884000</span> <span class="token number">1</span> connected <span class="token number">0</span>-5460
e2539c4398b8258d3f9ffa714bd778da107cb2cd <span class="token number">127.0</span>.0.1:7005@17005 slave a3406db9ae7144d17eb7df5bffe8b70bb5dd06b8 <span class="token number">0</span> <span class="token number">1584428885222</span> <span class="token number">6</span> connected
d31cd1f423ab1e1849cac01ae927e4b6950f55d9 <span class="token number">127.0</span>.0.1:7004@17004 slave 236cefaa9cdc295bc60a5bd1aed6a7152d4f384d <span class="token number">0</span> <span class="token number">1584428884209</span> <span class="token number">5</span> connected
236cefaa9cdc295bc60a5bd1aed6a7152d4f384d <span class="token number">127.0</span>.0.1:7001@17001 myself,master - <span class="token number">0</span> <span class="token number">1584428882000</span> <span class="token number">2</span> connected <span class="token number">5461</span>-10922
a3406db9ae7144d17eb7df5bffe8b70bb5dd06b8 <span class="token number">127.0</span>.0.1:7002@17002 master - <span class="token number">0</span> <span class="token number">1584428884000</span> <span class="token number">3</span> connected <span class="token number">10923</span>-16383
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><h4 id="集群客户端操作"><a href="#集群客户端操作" class="header-anchor">#</a> 集群客户端操作</h4> <h5 id="_1-java操作集群"><a href="#_1-java操作集群" class="header-anchor">#</a> 1.Java操作集群</h5> <p>使用 Jedis 操作集群的示例代码:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">JedisClusterTest</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>

        <span class="token class-name">JedisPoolConfig</span> config <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JedisPoolConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        config<span class="token punctuation">.</span><span class="token function">setMaxTotal</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        config<span class="token punctuation">.</span><span class="token function">setMaxIdle</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        config<span class="token punctuation">.</span><span class="token function">setMinIdle</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">HostAndPort</span><span class="token punctuation">&gt;</span></span> jedisClusterNode <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">HostAndPort</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        jedisClusterNode<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">HostAndPort</span><span class="token punctuation">(</span><span class="token string">&quot;192.168.0.61&quot;</span><span class="token punctuation">,</span> <span class="token number">8001</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        jedisClusterNode<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">HostAndPort</span><span class="token punctuation">(</span><span class="token string">&quot;192.168.0.62&quot;</span><span class="token punctuation">,</span> <span class="token number">8002</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        jedisClusterNode<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">HostAndPort</span><span class="token punctuation">(</span><span class="token string">&quot;192.168.0.63&quot;</span><span class="token punctuation">,</span> <span class="token number">8003</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        jedisClusterNode<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">HostAndPort</span><span class="token punctuation">(</span><span class="token string">&quot;192.168.0.61&quot;</span><span class="token punctuation">,</span> <span class="token number">8004</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        jedisClusterNode<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">HostAndPort</span><span class="token punctuation">(</span><span class="token string">&quot;192.168.0.62&quot;</span><span class="token punctuation">,</span> <span class="token number">8005</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        jedisClusterNode<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">HostAndPort</span><span class="token punctuation">(</span><span class="token string">&quot;192.168.0.63&quot;</span><span class="token punctuation">,</span> <span class="token number">8006</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">JedisCluster</span> jedisCluster <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">// connectionTimeout: 指的是连接一个url的连接等待时间</span>
            <span class="token comment">// soTimeout: 指的是连接上一个url, 获取response的返回等待时间</span>
            jedisCluster <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JedisCluster</span><span class="token punctuation">(</span>jedisClusterNode<span class="token punctuation">,</span> <span class="token number">6000</span><span class="token punctuation">,</span> <span class="token number">5000</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token string">&quot;zhuge&quot;</span><span class="token punctuation">,</span> config<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>jedisCluster<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">&quot;cluster&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;zhuge&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>jedisCluster<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;cluster&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>jedisCluster <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
                jedisCluster<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br></div></div><p>Spring Boot 操作集群, 引入依赖:</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-data-redis<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.commons<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>commons-pool2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>项目配置:</p> <div class="language-YML line-numbers-mode"><pre class="language-yml"><code><span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8080</span>

<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">redis</span><span class="token punctuation">:</span>
    <span class="token key atrule">database</span><span class="token punctuation">:</span> <span class="token number">0</span>
    <span class="token key atrule">timeout</span><span class="token punctuation">:</span> <span class="token number">3000</span>
    <span class="token key atrule">password</span><span class="token punctuation">:</span> <span class="token number">123456</span>
    <span class="token key atrule">cluster</span><span class="token punctuation">:</span>
      <span class="token key atrule">nodes</span><span class="token punctuation">:</span> 192.168.0.61<span class="token punctuation">:</span><span class="token number">8001</span><span class="token punctuation">,</span>192.168.0.62<span class="token punctuation">:</span><span class="token number">8002</span><span class="token punctuation">,</span>192.168.0.63<span class="token punctuation">:</span><span class="token number">8003</span><span class="token punctuation">,</span>192.168.0.61<span class="token punctuation">:</span><span class="token number">8004</span><span class="token punctuation">,</span>192.168.0.62<span class="token punctuation">:</span><span class="token number">8005</span><span class="token punctuation">,</span>192.168.0.63<span class="token punctuation">:</span><span class="token number">8006</span>
   <span class="token key atrule">lettuce</span><span class="token punctuation">:</span>
      <span class="token key atrule">pool</span><span class="token punctuation">:</span>
        <span class="token key atrule">max-idle</span><span class="token punctuation">:</span> <span class="token number">50</span>
        <span class="token key atrule">min-idle</span><span class="token punctuation">:</span> <span class="token number">10</span>
        <span class="token key atrule">max-active</span><span class="token punctuation">:</span> <span class="token number">100</span>
        <span class="token key atrule">max-wait</span><span class="token punctuation">:</span> <span class="token number">1000</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>示例代码:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@RestController</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">IndexController</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Logger</span> logger <span class="token operator">=</span> <span class="token class-name">LoggerFactory</span><span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token class-name">IndexController</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">StringRedisTemplate</span> stringRedisTemplate<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/test-cluster&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testCluster</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
       stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">&quot;nano&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;666&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;nano&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><h4 id="结点通信与gossip协议🌟"><a href="#结点通信与gossip协议🌟" class="header-anchor">#</a> 结点通信与Gossip协议🌟</h4> <h5 id="_1-gossip协议与节点间通信"><a href="#_1-gossip协议与节点间通信" class="header-anchor">#</a> 1.Gossip协议与节点间通信</h5> <p>在分布式存储中需要提供维护<strong>节点元数据信息</strong>的机制, 所谓<strong>元数据</strong>是指: 节点负责哪些数据, 是否出现故障等状态信息. 常见的元数据维护方式分为: <strong>集中式和 P2P 方式</strong>.</p> <p>Redis 集群采用 P2P 的 <strong>Gossip(流言)协议</strong>, Gossip 协议工作原理就是<strong>节点彼此不断通信交换信息, 一段时间后所有的节点都会知道集群完整的信息, 这种方式类似流言传播</strong>.</p> <p><img src="https://nano-note.oss-cn-beijing.aliyuncs.com/images/image-20220523225023888.png" alt=""></p> <p>Gossip 通信过程示意图:</p> <p><img src="/img/image-20240106223814-j0jibue.png" alt="image"></p> <p>Gossip 协议的优点在于元数据的更新比较分散, 不是集中在一个地方, 更新请求会陆陆续续, 打到所有节点上去更新, 有一定的延时, 降低了压力; 缺点在于元数据更新有延时可能导致集群的一些操作会有一些滞后.</p> <p>通信过程说明:</p> <ul><li>集群中的<strong>每个节点</strong>都会单独开辟一个 <strong>TCP</strong> 通道, 用于节点之间彼此通信, 通信端口号在基础端口上加 <strong>10000</strong>.</li> <li>每个节点在<strong>固定周期</strong>内通过特定规则选择几个节点发送 <strong>ping 消息</strong>.</li> <li>接收到 ping 消息的节点用 <strong>pong 消息</strong>作为响应.</li></ul> <p>集群中每个节点通过一定规则挑选要通信的节点, 每个节点可能知道全部节点, 也可能仅知道部分节点, 只要这些节点彼此可以正常通信, <strong>最终它们会达到一致的状态. <strong>​<strong><strong>当节点出故障, 新节点加入, 主从角色变化, 槽信息变更等事件发生时, 通过</strong></strong>​</strong>不断的 ping/pong 消息通信</strong>, 经过一段时间后所有的节点都会知道<strong>整个集群全部节点的最新状态</strong>, 从而达到<strong>集群状态同步</strong>的目的.</p> <blockquote><p>网络抖动</p></blockquote> <p>真实世界的机房网络经常会发生各种各样的问题. 比如网络抖动就是常见的一种现象, 突然之间部分连接变得不可访问, 然后很快又恢复正常. 为解决这种问题, Redis Cluster 提供了一种选项 <strong>cluster-node-timeout</strong>, 表示当某个节点持续 timeout 的时间失联时, 才可以认定该节点出现故障, 需要进行主从切换. 如果没有这个选项, 网络抖动可能会导致主从频繁切换(数据的重新复制).</p> <blockquote><p>集群脑裂数据丢失问题</p></blockquote> <p>网络抖动可能导致脑裂问题. Redis 集群没有过半机制会有脑裂问题, 网络分区导致脑裂后多个主节点对外提供写服务, 一旦网络分区恢复, 会将其中一个主节点变为从节点, 这时会有大量数据丢失.</p> <p>规避方法可以在 Redis 配置里加上参数(这种方法不可能百分百避免数据丢失, 参考集群 leader 选举机制):</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>min<span class="token operator">-</span>replicas<span class="token operator">-</span><span class="token keyword">to</span><span class="token operator">-</span>write <span class="token number">1</span>  
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><strong>min-replicas-to-write</strong> 参数指的是写数据成功最少同步的 slave 数量, 这个数量可以模仿大于半数机制配置, 比如集群总共三个节点可以配置 1, 加上 leader 就是 2, 超过了半数. 这个配置在一定程度上会影响集群的可用性, 比如 slave 要是少于 1 个, 这个集群就算 leader 正常也不能提供服务了, 需要具体场景权衡选择.</p> <h5 id="_2-gossip消息"><a href="#_2-gossip消息" class="header-anchor">#</a> 2.Gossip消息</h5> <p>Gossip 协议的主要职责就是<strong>信息交换</strong>. 信息交换的载体就是节点彼此发送的 Gossip 消息. 常用的 Gossip 消息类型可分为: <strong>ping 消息, pong 消息, meet 消息, fail 消息</strong>等.</p> <p><img src="https://nano-note.oss-cn-beijing.aliyuncs.com/images/image-20220523225127890.png" alt=""></p> <ul><li><strong>meet 消息</strong>: 用于通知<strong>新节点</strong>加入. 某个节点发送 meet 给新加入的节点, 让新节点加入集群中, 然后新节点就会开始与其他节点进行通信.</li> <li><strong>ping 消息</strong>: 用于检测节点<strong>是否在线和交换彼此状态</strong>信息. ping 消息发送<strong>封装</strong>了自身节点和部分其他节点的状态数据.</li> <li><strong>pong 消息</strong>: 当接收到 ping, meet 消息时, 作为响应<strong>消息回复</strong>给发送方确认消息正常通信. 也可以用于信息广播和更新.</li> <li><strong>fail 消息</strong>: 当节点判定集群内另一个节点下线时, 会向集群内广播一个 fail 消息.</li></ul> <p>所有的消息格式划分为: <strong>消息头和消息体</strong>. 消息头包含发送节点自身状态数据, 接收节点根据消息头就可以获取到发送节点的相关数据.</p> <p>集群内所有的消息都<strong>采用相同的消息头结构</strong> clusterMsg, 是一个<strong>结构体</strong>.</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">union</span> clusterMsgData <span class="token punctuation">{</span>
    <span class="token comment">/** ping,meet,pong消息体 */</span>
    <span class="token keyword">struct</span> <span class="token punctuation">{</span>
        <span class="token comment">/** gossip消息结构数组 */</span>
        clusterMsgDataGossip gossip<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> ping<span class="token punctuation">;</span>
    
    <span class="token comment">/** FAIL消息体 */</span>
    <span class="token keyword">struct</span> <span class="token punctuation">{</span>
        clusterMsgDataFail about<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> fail<span class="token punctuation">;</span>
    <span class="token comment">// ...</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p><strong>消息体</strong> clusterMsgData 定义发送消息的<strong>数据</strong>. 通过消息头判断消息类型和状态, 通过消息体传送数据.</p> <h4 id="集群伸缩🌟"><a href="#集群伸缩🌟" class="header-anchor">#</a> 集群伸缩🌟</h4> <p>集群伸缩的原理可以抽象为<strong>槽和对应数据在不同节点之间的灵活移动</strong>.</p> <h5 id="_1-集群扩容"><a href="#_1-集群扩容" class="header-anchor">#</a> 1.集群扩容</h5> <p><strong>集群扩容</strong>即需要把当前的节点的<strong>槽和数据分一些给新的节点</strong>(进行移动). 过程如下:</p> <ul><li>准备新节点.</li> <li>加入集群.</li> <li>迁移槽和数据.</li> <li>添加从节点.</li></ul> <p>新节点的配置建议和集群内的节点配置保持一致, 配置后启动新节点即可. 新节点采用 <strong>cluster meet 命令</strong>加入到集群中. 一旦与集群任意一个建立联系, 各个节点最终都会感知.</p> <p><strong>新加入的节点没有分配槽也是无法进行读写的</strong>. 需要迁移槽和数据, 确定哪些槽需要迁移到新的节点, 保证迁移之后各个节点槽的数量<strong>均匀</strong>. 数据迁移是<strong>逐个槽</strong>进行的.</p> <p>迁移过程如下:</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>1. 对目标节点发送 cluster setslot {slot} importing {sourceNodeId} 命令, 让目标节点准备导入槽的数据. 
2. 对源节点发送 cluster setslot {slot} migrating {targetNodeId} 命令, 让源节点准备迁出槽的数据. 
3. 源节点循环执行 cluster getkeysinslot {slot} {count} 命令, 每次获取 count 个属于槽的键. 
4. 在源节点上执行 migrate {targetIp} {targetPort} key 0 {timeout} 命令把指定 key 迁移. 
5. 重复执行步骤 3-4 直到槽下所有的键数据迁移到目标节点. 
6. 向集群内所有主节点发送 cluster setslot {slot} node {targetNodeId} 命令, 通知槽分配给目标节点. 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>图示如下:</p> <p>​<img src="https://nano-note.oss-cn-beijing.aliyuncs.com/images/image-20220523230141253.png" alt=""></p> <p>可以使用 redis-trib 工具的 <strong>reshard</strong> 命令简化数据迁移的工作量. 由于槽用于 <strong>hash 运算</strong>本身顺序没有意义, 所以<strong>无需强制要求节点负责槽的顺序性</strong>, 也就是一个结点上槽不一定是连续的. 数据迁移完之后, 集群又多了一个主节点, 此时应该再给这个结点<strong>配备一个从节点</strong>. 此时扩容完成.</p> <h5 id="_2-集群收缩"><a href="#_2-集群收缩" class="header-anchor">#</a> 2.集群收缩</h5> <p>集群收缩即将集群中的节点<strong>安全下线</strong>. 如果下线的结点分配有槽, 需要<strong>将槽和数据迁移到其他节点</strong>, 保证下线后数据完整性. 需要将这个下线节点的<strong>槽均匀分配到其他节点</strong>. 也可以使用 <strong>reshard</strong> 命令进行迁移, reshard 迁移的目标节点只能有一个, 所以下图需要执行 3 次命令.</p> <p><img src="https://nano-note.oss-cn-beijing.aliyuncs.com/images/image-20220527223057254.png" alt=""></p> <p>如果下线的结点<strong>没有负责槽或本身是从节点</strong>, 则可以通过 <strong>cluster forget {downNodeId}</strong>  通知集群内其他节点<strong>忘记</strong>这个下线结点, 这样其他节点就不再与这个结点进行 Gossip 通信, 之后即可正常关闭.</p> <p>如果下线主节点但<strong>不下线从节点</strong>, 则需要把这个存留的从节点<strong>指向</strong>其他节点. 如果主从节点<strong>都下线</strong>, 建议先下线从节点再下线主节点, 防止不必要的<strong>全量复制</strong>.</p> <h4 id="请求路由🌟"><a href="#请求路由🌟" class="header-anchor">#</a> 请求路由🌟</h4> <p>与客户端通信时, Redis 集群为了追求性能最大化, <strong>没有采用代理</strong>的方式, 而是采用<strong>客户端直连节点</strong>的方式进行.</p> <h5 id="_1-请求重定向moved"><a href="#_1-请求重定向moved" class="header-anchor">#</a> 1.请求重定向MOVED</h5> <blockquote><p>跳转重定位</p></blockquote> <p>当客户端向一个错误的节点发出了指令, 该节点会发现指令的 key 所在的槽位并不归自己管理, 这时它会向客户端发送一个特殊的跳转指令并携带目标操作的节点地址, 告诉客户端去连这个节点去获取数据. 客户端收到指令后除了跳转到正确的节点上去操作, 还会同步更新纠正本地的槽位映射表缓存, 后续所有 key 将使用新的槽位映射表.</p> <p>在集群模式下, <strong>Redis 接收任何键相关命令时首先计算键对应的槽, 再根据槽找出所对应的节点, 如果节点是自身(槽命中), 则处理键命令; 否则回复 MOVED 重定向错误, 告诉客户端请求正确的节点. 这个过程就是 MOVED 重定向.</strong></p> <p><img src="https://nano-note.oss-cn-beijing.aliyuncs.com/images/image-20220527223213996.png" alt=""></p> <p>可以借助 <strong>cluster keyslot {key}</strong>  命令返回 key 对应的<strong>槽</strong>.</p> <p><img src="https://nano-note.oss-cn-beijing.aliyuncs.com/images/image-20220527223250869.png" alt=""></p> <p><strong>返回的重定向信息包含了键所对应的槽和负责该槽的节点地址. <strong>​<strong><strong>根据这些信息客户端可以</strong></strong>​</strong>重新发起请求</strong>. 注意: 集群中的节点对于不属于它的键操作<strong>只回复重定向响应, 不会进行命令转发</strong>.</p> <p>Redis 槽计算是根据键的有效部分使用 <strong>CRC16 函数计算出散列值</strong>, 然后对 16384 <strong>取模</strong>, 可以得到<strong>映射的槽</strong>. 计算出键对应的槽之后, 需要查找槽对应的节点. 集群内通过<strong>消息交换</strong>每个节点都会知道<strong>所有节点的槽信息</strong>, 内部<strong>保存</strong>在 <strong>clusterState</strong> 结构中.</p> <p>根据 MOVED 重定向机制, 客户端可以随机连接集群内<strong>任一节点</strong>获取键的信息.</p> <h5 id="_2-ask重定向"><a href="#_2-ask重定向" class="header-anchor">#</a> 2.ASK重定向</h5> <p>如果当键<strong>正在迁移</strong>的时候集群收到对键的操作命令, 如果数据<strong>都在</strong>原来的节点, 则直接执行并返回. 然而此时可能一部分键在旧的节点上, 而<strong>另一部分数据已经迁移到新的节点</strong>上, 这时候集群就会回复 <strong>ASK 重定向异常</strong>. 客户端解析这个异常信息并再次发起请求.</p> <p><img src="https://nano-note.oss-cn-beijing.aliyuncs.com/images/image-20220527223441500.png" alt=""></p> <p>执行流程如下:</p> <p><img src="https://nano-note.oss-cn-beijing.aliyuncs.com/images/image-20220527223519148.png" alt=""></p> <p>注意在集群下进行<strong>键迁移时</strong>如果使用 <strong>mget, mset 等批量操作</strong>时, slot 迁移数据期间由于键列表<strong>无法保证在同一结点</strong>, 可能导致<strong>大量错误</strong>. 虽然集群环境下优先使用 Pipeline 方式进行批量操作, 但是 Pipeline 依然无法解决上述问题. 所以迁移键的时候别进行批量操作!</p> <blockquote><p>ASK重定向和MOVED重定向的区别?</p></blockquote> <p>两者都是对客户端的重定向控制, 但是有本质区别.</p> <p><strong>ASK 重定向</strong>: 向说明集群<strong>正在进行 slot 数据迁移</strong>, 客户端无法知道什么时候迁移完成, 因此只能<strong>临时性的重定向</strong>, 客户端也<strong>不会更新 slots 缓存</strong>.</p> <p><strong>MOVED 重定向</strong>: 说明键对应的槽已经<strong>明确迁移到了</strong>新的节点, 类似于<strong>永久重定向</strong>, 客户端需要<strong>更新 slots 缓存</strong>.</p> <h4 id="故障转移🌟"><a href="#故障转移🌟" class="header-anchor">#</a> 故障转移🌟</h4> <p>对于实现故障转移来说, <strong>Redis 集群自身实现了高可用, 不需要 Sentinel</strong>, 但是机制类似于 Redis Sentinel.</p> <h5 id="_1-故障发现"><a href="#_1-故障发现" class="header-anchor">#</a> 1.故障发现</h5> <p>集群间通过 <strong>ping/pong</strong> 消息实现结点通信, 消息不但可以传播节点槽信息, 还能传播其他<strong>状态信息</strong>, 比如: 主从状态, 节点故障等. <strong>故障发现也是基于消息传播机制</strong>实现的, 也是分为<strong>主观下线和客观下线</strong>. 节点的状态使用 <strong>clusterState</strong> 结构体的 <strong>flags 属性</strong>进行定义.</p> <h6 id="_1-主观下线"><a href="#_1-主观下线" class="header-anchor">#</a> (1)主观下线</h6> <p>集群中每个节点都会定期给其他节点发送 ping 消息, 接收节点回复 pong 进行响应. 如果响应超时, 则发送节点认为对方存在故障, 标记为<strong>主观下线状态</strong>(pfail 状态). 主观下线是<strong>一个节点</strong>对于另一个节点不可用的判断, 仅代表这一个节点的意见, 可能存在<strong>误判</strong>.</p> <h6 id="_2-客观下线"><a href="#_2-客观下线" class="header-anchor">#</a> (2)客观下线</h6> <p>当某个节点认为一个节点不可用时, 会得到主观下线的结论, 然后相应的节点状态会随消息在集群内传播. 客观下线则是需要<strong>多个</strong>节点<strong>达成共识</strong>, 都认为一个节点不可用. <strong>当半数以上持有槽的主节点都标记某个结点是主观下线时, 触发客观下线流程</strong>. 注意只是主节点参与决策. 每个节点收到的其他节点发送的<strong>主观下线信息</strong>是具有<strong>有效期</strong>的, 如果时间过长, 主观下线信息会过期.</p> <p>集群中的节点<strong>每次</strong>收到其他节点的主观下线状态信息时, <strong>都会尝试触发客观下线</strong>. 首先会计算有效的主观下线报告数量, 如果数量大于槽节点的<strong>一半</strong>, 则更新为<strong>客观下线</strong>, 同时向集群广播下线节点的 fail 消息.</p> <p>广播下线节点的 fail 消息可以通知集群内所有的节点<strong>标记故障节点为客观下线状态</strong>并立即生效, 同时通知故障节点的<strong>从节点触发故障转移流程</strong>(如果故障的就是从节点就不需要了). 如果不可用的节点持有槽, 则需要进行<strong>故障转移</strong>.</p> <h5 id="_2-主节点选举与故障转移"><a href="#_2-主节点选举与故障转移" class="header-anchor">#</a> 2.主节点选举与故障转移</h5> <p>故障节点客观下线后, 如果<strong>是持有槽的主节点, 则需要在它的从节点中选出一个替换它</strong>, 实现集群的高可用.</p> <p>过程如下:</p> <p><strong>(1) 资格检查.</strong> <strong><strong>每个从节点</strong></strong>​<strong>都要</strong>检查最后与主节点直接的断线时间, 如果过长则不具有资格. 可能存在多个有资格成为主节点的从节点.</p> <p><strong>(2) 设置选举时间. <strong>​<strong><strong>每个从节点都会触发选举来选择</strong></strong>​</strong>自己作为主节点</strong>. 但是选谁? 当从节点符合故障转移资格后, <strong>更新</strong>触发故障选举的时间, 只有达到时间后才能触发选举. 每个<strong>从节点进行选举的时间是不一样</strong>的, 这个触发时间记录在 clusterState 结构体中. 这里采用<strong>延迟触发机制</strong>. <strong>复制偏移量越大的从节点的触发选举的时间越早, 因为它的数据完整性最高.</strong></p> <p><img src="https://nano-note.oss-cn-beijing.aliyuncs.com/images/image-20220527223721040.png" alt=""></p> <p>所以从节点中<strong>复制偏移量最大</strong>的节点将<strong>提前触发选举</strong>, 它成为主节点的几率也<strong>更大</strong>.</p> <p><strong>(3) 发起选举</strong>. 当从节点定时任务监测到达故障选举时间到达之后, 发起选举流程, 即更新配置纪元和广播选举消息.</p> <p><strong>(4) 选举投票</strong>. 持有槽的主节点才会处理选举消息, 每个节点具有<strong>一票</strong>.</p> <p><strong>(5) 替换主节点</strong>. 选举成功的从节点触发替换主节点操作. 当前从节点取消复制变成主节点. 之后自己接管原来主节点负责的槽. 然后向集群<strong>广播</strong>自己成为主节点的状态信息.</p> <p>整个故障转移过程也会产生大量的日志, 可以模拟一下故障场景, 好好看看日志.</p> <blockquote><p>Redis集群为什么至少需要三个master节点, 并且推荐节点数为奇数?</p></blockquote> <p>因为新 master 的选举需要大于半数的集群 master 节点同意才能选举成功, 如果只有两个 master 节点, 当其中一个挂了, 是达不到选举新 master 的条件的.</p> <p>奇数个 master 节点可以在满足选举该条件的基础上节省一个节点, 比如三个 master 节点和四个 master 节点的集群相比, 大家如果都挂了一个 master 节点都能选举新 master 节点, 如果都挂了两个 master 节点都没法选举新 master 节点了, 所以奇数的 master 节点更多的是从节省机器资源角度出发说的.</p> <p>‍</p> <p>‍</p> <h4 id="参考资料"><a href="#参考资料" class="header-anchor">#</a> 参考资料</h4> <ul><li>《Redis开发与运维》</li></ul></div></div>  <div class="page-edit"><div class="edit-link"><a href="https://github.com/xugaoyi/vuepress-theme-vdoing/edit/main/docs/30.系统/3000.系统/1200.中间件-缓存/34.Redis集群.md" target="_blank" rel="noopener noreferrer">编辑</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <!----> <!----></div> <div class="page-nav-wapper"><div class="page-nav-centre-wrap"><a href="/pages/50cae1/" class="page-nav-centre page-nav-centre-prev"><div class="tooltip">Redis哨兵</div></a> <a href="/pages/a32379/" class="page-nav-centre page-nav-centre-next"><div class="tooltip">Redis内存管理与运维</div></a></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/pages/50cae1/" class="prev">Redis哨兵</a></span> <span class="next"><a href="/pages/a32379/">Redis内存管理与运维</a>→
      </span></p></div></div></div> <!----></main></div> <div class="footer"><div class="icons"><a href="mailto:1174520425@qq.com" title="发邮件" target="_blank" class="iconfont icon-youjian"></a><a href="https://github.com/nanodaemony" title="GitHub" target="_blank" class="iconfont icon-github"></a></div> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="本站主题">Vdoing</a> 
    | Copyright © 2019-2025
    <span>达尔文的猹 | MIT License</span></div> <div class="buttons"><div title="返回顶部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去评论" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主题模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          跟随系统
        </li><li class="iconfont icon-rijianmoshi">
          浅色模式
        </li><li class="iconfont icon-yejianmoshi">
          深色模式
        </li><li class="iconfont icon-yuedu">
          阅读模式
        </li></ul></div></div> <!----> <!----> <!----></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.3f3e0e10.js" defer></script><script src="/assets/js/2.e9fcb30c.js" defer></script><script src="/assets/js/3.1998f389.js" defer></script><script src="/assets/js/160.0b806535.js" defer></script>
  </body>
</html>
