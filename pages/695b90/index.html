<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Spring IOCæºç åˆ†æ-createBean() | Pangolin Note</title>
    <meta name="generator" content="VuePress 1.9.5">
    <link rel="icon" href="/img/favicon.ico">
    <meta name="description" content="å¤§é“è‡³ç®€">
    <meta name="keywords" content="å‰ç«¯åšå®¢,ä¸ªäººæŠ€æœ¯åšå®¢,å‰ç«¯,å‰ç«¯å¼€å‘,å‰ç«¯æ¡†æ¶,webå‰ç«¯,å‰ç«¯é¢è¯•é¢˜,æŠ€æœ¯æ–‡æ¡£,å­¦ä¹ ,é¢è¯•,JavaScript,js,ES6,TypeScript,vue,python,css3,html5,Node,git,github,markdown">
    <meta name="baidu-site-verification" content="7F55weZDDc">
    <meta name="theme-color" content="#11a8cd">
    
    <link rel="preload" href="/assets/css/0.styles.56073ad3.css" as="style"><link rel="preload" href="/assets/js/app.3f3e0e10.js" as="script"><link rel="preload" href="/assets/js/2.e9fcb30c.js" as="script"><link rel="preload" href="/assets/js/3.1998f389.js" as="script"><link rel="preload" href="/assets/js/121.8e16df87.js" as="script"><link rel="prefetch" href="/assets/js/10.0b55747f.js"><link rel="prefetch" href="/assets/js/100.b8912a99.js"><link rel="prefetch" href="/assets/js/101.a6740c8a.js"><link rel="prefetch" href="/assets/js/102.e31e89b2.js"><link rel="prefetch" href="/assets/js/103.2c5dbdae.js"><link rel="prefetch" href="/assets/js/104.0e9c02f6.js"><link rel="prefetch" href="/assets/js/105.8288396c.js"><link rel="prefetch" href="/assets/js/106.62f43c11.js"><link rel="prefetch" href="/assets/js/107.70c90211.js"><link rel="prefetch" href="/assets/js/108.b488ce56.js"><link rel="prefetch" href="/assets/js/109.12942650.js"><link rel="prefetch" href="/assets/js/11.ac3fd1ca.js"><link rel="prefetch" href="/assets/js/110.1e57ecba.js"><link rel="prefetch" href="/assets/js/111.6e33b4ea.js"><link rel="prefetch" href="/assets/js/112.bd52831b.js"><link rel="prefetch" href="/assets/js/113.868c1ac9.js"><link rel="prefetch" href="/assets/js/114.090549d1.js"><link rel="prefetch" href="/assets/js/115.d97f6c2b.js"><link rel="prefetch" href="/assets/js/116.097c4b4e.js"><link rel="prefetch" href="/assets/js/117.4024cfe2.js"><link rel="prefetch" href="/assets/js/118.e3057cba.js"><link rel="prefetch" href="/assets/js/119.4ef1fa3b.js"><link rel="prefetch" href="/assets/js/12.863eaabe.js"><link rel="prefetch" href="/assets/js/120.78f9df50.js"><link rel="prefetch" href="/assets/js/122.f21c0107.js"><link rel="prefetch" href="/assets/js/123.ea1cb375.js"><link rel="prefetch" href="/assets/js/124.01c04c6e.js"><link rel="prefetch" href="/assets/js/125.d383e301.js"><link rel="prefetch" href="/assets/js/126.3162cb47.js"><link rel="prefetch" href="/assets/js/127.c6bebae6.js"><link rel="prefetch" href="/assets/js/128.d659db60.js"><link rel="prefetch" href="/assets/js/129.2afdcf48.js"><link rel="prefetch" href="/assets/js/13.4f59ce35.js"><link rel="prefetch" href="/assets/js/130.beb9ed9d.js"><link rel="prefetch" href="/assets/js/131.35b05f8a.js"><link rel="prefetch" href="/assets/js/132.d77f4f93.js"><link rel="prefetch" href="/assets/js/133.4ceda6e5.js"><link rel="prefetch" href="/assets/js/134.11390c5f.js"><link rel="prefetch" href="/assets/js/135.32f9e38f.js"><link rel="prefetch" href="/assets/js/136.6d8bb0f2.js"><link rel="prefetch" href="/assets/js/137.9c0ffeef.js"><link rel="prefetch" href="/assets/js/138.88d86e5f.js"><link rel="prefetch" href="/assets/js/139.8c2c3d6c.js"><link rel="prefetch" href="/assets/js/14.11c82d35.js"><link rel="prefetch" href="/assets/js/140.c5c375d3.js"><link rel="prefetch" href="/assets/js/141.d703f30b.js"><link rel="prefetch" href="/assets/js/142.6a005a44.js"><link rel="prefetch" href="/assets/js/143.9b2edf6f.js"><link rel="prefetch" href="/assets/js/144.3fd013c9.js"><link rel="prefetch" href="/assets/js/145.b05079c5.js"><link rel="prefetch" href="/assets/js/146.ed5360a6.js"><link rel="prefetch" href="/assets/js/147.7408d86f.js"><link rel="prefetch" href="/assets/js/148.f390b370.js"><link rel="prefetch" href="/assets/js/149.95017f0a.js"><link rel="prefetch" href="/assets/js/15.bd143bd5.js"><link rel="prefetch" href="/assets/js/150.f0ede764.js"><link rel="prefetch" href="/assets/js/151.b7093623.js"><link rel="prefetch" href="/assets/js/152.a82a6c83.js"><link rel="prefetch" href="/assets/js/153.965e3fb2.js"><link rel="prefetch" href="/assets/js/154.9e49311e.js"><link rel="prefetch" href="/assets/js/155.cef33ba5.js"><link rel="prefetch" href="/assets/js/156.bcc397ae.js"><link rel="prefetch" href="/assets/js/157.90824739.js"><link rel="prefetch" href="/assets/js/158.efd429b9.js"><link rel="prefetch" href="/assets/js/159.122ff5b7.js"><link rel="prefetch" href="/assets/js/16.2449162b.js"><link rel="prefetch" href="/assets/js/160.0b806535.js"><link rel="prefetch" href="/assets/js/161.835052c6.js"><link rel="prefetch" href="/assets/js/162.ca34e2d2.js"><link rel="prefetch" href="/assets/js/163.08000d04.js"><link rel="prefetch" href="/assets/js/164.a1cc0109.js"><link rel="prefetch" href="/assets/js/165.65444686.js"><link rel="prefetch" href="/assets/js/166.7d73c84f.js"><link rel="prefetch" href="/assets/js/167.009d47a3.js"><link rel="prefetch" href="/assets/js/168.0afeae2a.js"><link rel="prefetch" href="/assets/js/169.7654cb31.js"><link rel="prefetch" href="/assets/js/17.eb7f9def.js"><link rel="prefetch" href="/assets/js/170.58569530.js"><link rel="prefetch" href="/assets/js/171.7db9ed40.js"><link rel="prefetch" href="/assets/js/172.3cb50ed4.js"><link rel="prefetch" href="/assets/js/173.0846425f.js"><link rel="prefetch" href="/assets/js/174.9e95f111.js"><link rel="prefetch" href="/assets/js/175.ef2098f2.js"><link rel="prefetch" href="/assets/js/176.c2635fe9.js"><link rel="prefetch" href="/assets/js/177.4fa38e8e.js"><link rel="prefetch" href="/assets/js/178.2be7037f.js"><link rel="prefetch" href="/assets/js/179.bf3bba28.js"><link rel="prefetch" href="/assets/js/18.0455f4d1.js"><link rel="prefetch" href="/assets/js/180.72c5f597.js"><link rel="prefetch" href="/assets/js/181.42287bcc.js"><link rel="prefetch" href="/assets/js/182.6cd4bf1a.js"><link rel="prefetch" href="/assets/js/183.05dbbfd9.js"><link rel="prefetch" href="/assets/js/184.03de7e00.js"><link rel="prefetch" href="/assets/js/185.42dd210e.js"><link rel="prefetch" href="/assets/js/186.28ee0f8a.js"><link rel="prefetch" href="/assets/js/187.bb58697b.js"><link rel="prefetch" href="/assets/js/188.1bc8be96.js"><link rel="prefetch" href="/assets/js/189.fac747e3.js"><link rel="prefetch" href="/assets/js/19.ae9e35d6.js"><link rel="prefetch" href="/assets/js/190.ea533ac7.js"><link rel="prefetch" href="/assets/js/191.6dc6eb13.js"><link rel="prefetch" href="/assets/js/192.184d249f.js"><link rel="prefetch" href="/assets/js/193.4a06bc12.js"><link rel="prefetch" href="/assets/js/194.8cce60a9.js"><link rel="prefetch" href="/assets/js/195.93231a13.js"><link rel="prefetch" href="/assets/js/196.4a596bde.js"><link rel="prefetch" href="/assets/js/197.96c113cf.js"><link rel="prefetch" href="/assets/js/198.73ba3f67.js"><link rel="prefetch" href="/assets/js/199.74bab595.js"><link rel="prefetch" href="/assets/js/20.b542d0e7.js"><link rel="prefetch" href="/assets/js/200.69a6928a.js"><link rel="prefetch" href="/assets/js/201.9ffa7c5a.js"><link rel="prefetch" href="/assets/js/202.41edb652.js"><link rel="prefetch" href="/assets/js/203.7fabcef3.js"><link rel="prefetch" href="/assets/js/204.b0ae2f62.js"><link rel="prefetch" href="/assets/js/205.add8738b.js"><link rel="prefetch" href="/assets/js/206.f3a712ec.js"><link rel="prefetch" href="/assets/js/207.cd7dd729.js"><link rel="prefetch" href="/assets/js/208.78b33afa.js"><link rel="prefetch" href="/assets/js/209.9d3329ff.js"><link rel="prefetch" href="/assets/js/21.5a050318.js"><link rel="prefetch" href="/assets/js/210.d285d5ac.js"><link rel="prefetch" href="/assets/js/211.8791bb3f.js"><link rel="prefetch" href="/assets/js/212.84ed81a8.js"><link rel="prefetch" href="/assets/js/213.7b990580.js"><link rel="prefetch" href="/assets/js/214.da31f20c.js"><link rel="prefetch" href="/assets/js/215.9eeed659.js"><link rel="prefetch" href="/assets/js/216.9539f0ec.js"><link rel="prefetch" href="/assets/js/217.11b575be.js"><link rel="prefetch" href="/assets/js/218.a67f12f1.js"><link rel="prefetch" href="/assets/js/219.bfbb817a.js"><link rel="prefetch" href="/assets/js/22.2bc6f7e3.js"><link rel="prefetch" href="/assets/js/220.8b01342f.js"><link rel="prefetch" href="/assets/js/221.b450decd.js"><link rel="prefetch" href="/assets/js/222.97468507.js"><link rel="prefetch" href="/assets/js/223.b6dafd73.js"><link rel="prefetch" href="/assets/js/224.c86c18c6.js"><link rel="prefetch" href="/assets/js/225.b0dcf86e.js"><link rel="prefetch" href="/assets/js/226.02cc2999.js"><link rel="prefetch" href="/assets/js/227.8474ef5a.js"><link rel="prefetch" href="/assets/js/228.0298e421.js"><link rel="prefetch" href="/assets/js/229.6aeaf595.js"><link rel="prefetch" href="/assets/js/23.9995fce4.js"><link rel="prefetch" href="/assets/js/230.a5785286.js"><link rel="prefetch" href="/assets/js/231.d791daa4.js"><link rel="prefetch" href="/assets/js/232.97aeeb00.js"><link rel="prefetch" href="/assets/js/233.46e51e28.js"><link rel="prefetch" href="/assets/js/234.2cffe82f.js"><link rel="prefetch" href="/assets/js/235.14965da6.js"><link rel="prefetch" href="/assets/js/236.00a5afc0.js"><link rel="prefetch" href="/assets/js/237.3b73d52f.js"><link rel="prefetch" href="/assets/js/238.6e1db765.js"><link rel="prefetch" href="/assets/js/239.75866c5e.js"><link rel="prefetch" href="/assets/js/24.9141eeb2.js"><link rel="prefetch" href="/assets/js/240.af9c2cc9.js"><link rel="prefetch" href="/assets/js/241.388acab2.js"><link rel="prefetch" href="/assets/js/242.c60f2b48.js"><link rel="prefetch" href="/assets/js/243.d8e81b13.js"><link rel="prefetch" href="/assets/js/244.58b0b21d.js"><link rel="prefetch" href="/assets/js/245.c3768497.js"><link rel="prefetch" href="/assets/js/246.ac8bbe7a.js"><link rel="prefetch" href="/assets/js/247.d095f70a.js"><link rel="prefetch" href="/assets/js/248.e9f210b5.js"><link rel="prefetch" href="/assets/js/249.a9fad023.js"><link rel="prefetch" href="/assets/js/25.98e8593e.js"><link rel="prefetch" href="/assets/js/250.ae7f0ebb.js"><link rel="prefetch" href="/assets/js/251.9a617d55.js"><link rel="prefetch" href="/assets/js/252.ce082446.js"><link rel="prefetch" href="/assets/js/253.4575302d.js"><link rel="prefetch" href="/assets/js/254.5899a61b.js"><link rel="prefetch" href="/assets/js/255.66c69f31.js"><link rel="prefetch" href="/assets/js/256.8fd6c706.js"><link rel="prefetch" href="/assets/js/257.31b77e5e.js"><link rel="prefetch" href="/assets/js/258.eba48891.js"><link rel="prefetch" href="/assets/js/259.edf74b59.js"><link rel="prefetch" href="/assets/js/26.e69924ea.js"><link rel="prefetch" href="/assets/js/260.cf2ed36d.js"><link rel="prefetch" href="/assets/js/261.9e7792d8.js"><link rel="prefetch" href="/assets/js/262.e7b9433e.js"><link rel="prefetch" href="/assets/js/263.1185b25c.js"><link rel="prefetch" href="/assets/js/264.5e0f89cb.js"><link rel="prefetch" href="/assets/js/265.a38d3b94.js"><link rel="prefetch" href="/assets/js/266.2ef170b3.js"><link rel="prefetch" href="/assets/js/267.a7d14651.js"><link rel="prefetch" href="/assets/js/268.05b18748.js"><link rel="prefetch" href="/assets/js/269.dad48d6f.js"><link rel="prefetch" href="/assets/js/27.13612515.js"><link rel="prefetch" href="/assets/js/270.4f5a6b8d.js"><link rel="prefetch" href="/assets/js/271.7ebf6682.js"><link rel="prefetch" href="/assets/js/272.7c2fbfd1.js"><link rel="prefetch" href="/assets/js/273.8ee20732.js"><link rel="prefetch" href="/assets/js/274.d525242a.js"><link rel="prefetch" href="/assets/js/275.a8a19acb.js"><link rel="prefetch" href="/assets/js/276.df3a4eb4.js"><link rel="prefetch" href="/assets/js/277.336debda.js"><link rel="prefetch" href="/assets/js/278.c470625f.js"><link rel="prefetch" href="/assets/js/279.a91e1a64.js"><link rel="prefetch" href="/assets/js/28.ab7ae1df.js"><link rel="prefetch" href="/assets/js/280.87e25c9a.js"><link rel="prefetch" href="/assets/js/281.87c1ba25.js"><link rel="prefetch" href="/assets/js/282.dcd4dce0.js"><link rel="prefetch" href="/assets/js/283.abac2e00.js"><link rel="prefetch" href="/assets/js/284.f6079659.js"><link rel="prefetch" href="/assets/js/285.f1b39879.js"><link rel="prefetch" href="/assets/js/286.f6a79242.js"><link rel="prefetch" href="/assets/js/287.06bebe07.js"><link rel="prefetch" href="/assets/js/288.89e325df.js"><link rel="prefetch" href="/assets/js/289.3aa1bedd.js"><link rel="prefetch" href="/assets/js/29.ebe50f76.js"><link rel="prefetch" href="/assets/js/290.ee059c92.js"><link rel="prefetch" href="/assets/js/291.fa9a921a.js"><link rel="prefetch" href="/assets/js/292.2a8811cd.js"><link rel="prefetch" href="/assets/js/293.eec09cdf.js"><link rel="prefetch" href="/assets/js/294.dfac20dc.js"><link rel="prefetch" href="/assets/js/295.825d2070.js"><link rel="prefetch" href="/assets/js/296.f645861e.js"><link rel="prefetch" href="/assets/js/297.424fdb17.js"><link rel="prefetch" href="/assets/js/298.ebf87cdc.js"><link rel="prefetch" href="/assets/js/299.b8f19cbb.js"><link rel="prefetch" href="/assets/js/30.75237511.js"><link rel="prefetch" href="/assets/js/300.10fb6d4f.js"><link rel="prefetch" href="/assets/js/301.ef77c612.js"><link rel="prefetch" href="/assets/js/302.1b839763.js"><link rel="prefetch" href="/assets/js/303.609f7d98.js"><link rel="prefetch" href="/assets/js/304.1d255f19.js"><link rel="prefetch" href="/assets/js/305.b0234f2c.js"><link rel="prefetch" href="/assets/js/306.48677f64.js"><link rel="prefetch" href="/assets/js/307.14390d4b.js"><link rel="prefetch" href="/assets/js/308.fa730b28.js"><link rel="prefetch" href="/assets/js/309.0496b9e0.js"><link rel="prefetch" href="/assets/js/31.cf3f471a.js"><link rel="prefetch" href="/assets/js/310.a31676dc.js"><link rel="prefetch" href="/assets/js/311.ed53adc5.js"><link rel="prefetch" href="/assets/js/312.1b0ff2f1.js"><link rel="prefetch" href="/assets/js/313.bf123f32.js"><link rel="prefetch" href="/assets/js/314.4e6ce06b.js"><link rel="prefetch" href="/assets/js/315.8eb18560.js"><link rel="prefetch" href="/assets/js/32.74fef842.js"><link rel="prefetch" href="/assets/js/33.bc2d190b.js"><link rel="prefetch" href="/assets/js/34.d23438fc.js"><link rel="prefetch" href="/assets/js/35.7675c4d0.js"><link rel="prefetch" href="/assets/js/36.96a4161b.js"><link rel="prefetch" href="/assets/js/37.d1824f2f.js"><link rel="prefetch" href="/assets/js/38.4effff9e.js"><link rel="prefetch" href="/assets/js/39.6509914b.js"><link rel="prefetch" href="/assets/js/4.4d01750f.js"><link rel="prefetch" href="/assets/js/40.1509d08b.js"><link rel="prefetch" href="/assets/js/41.f2c1124f.js"><link rel="prefetch" href="/assets/js/42.e541d077.js"><link rel="prefetch" href="/assets/js/43.369de999.js"><link rel="prefetch" href="/assets/js/44.43959db0.js"><link rel="prefetch" href="/assets/js/45.282fbd31.js"><link rel="prefetch" href="/assets/js/46.1b83cfe9.js"><link rel="prefetch" href="/assets/js/47.c3a88e41.js"><link rel="prefetch" href="/assets/js/48.bc7c0a1b.js"><link rel="prefetch" href="/assets/js/49.92a4e5ba.js"><link rel="prefetch" href="/assets/js/5.c3991e24.js"><link rel="prefetch" href="/assets/js/50.9c488c6c.js"><link rel="prefetch" href="/assets/js/51.546ea632.js"><link rel="prefetch" href="/assets/js/52.0d2ccee1.js"><link rel="prefetch" href="/assets/js/53.6f52b5b1.js"><link rel="prefetch" href="/assets/js/54.c838b295.js"><link rel="prefetch" href="/assets/js/55.13af99ee.js"><link rel="prefetch" href="/assets/js/56.6be6d1ed.js"><link rel="prefetch" href="/assets/js/57.67c98b39.js"><link rel="prefetch" href="/assets/js/58.107e82ec.js"><link rel="prefetch" href="/assets/js/59.b3e5edc7.js"><link rel="prefetch" href="/assets/js/6.36a535f9.js"><link rel="prefetch" href="/assets/js/60.3b0b4ba5.js"><link rel="prefetch" href="/assets/js/61.3df843df.js"><link rel="prefetch" href="/assets/js/62.1213823d.js"><link rel="prefetch" href="/assets/js/63.e8f3f926.js"><link rel="prefetch" href="/assets/js/64.e1219050.js"><link rel="prefetch" href="/assets/js/65.5bf5bb0b.js"><link rel="prefetch" href="/assets/js/66.a2502afb.js"><link rel="prefetch" href="/assets/js/67.690dd59b.js"><link rel="prefetch" href="/assets/js/68.de7b0915.js"><link rel="prefetch" href="/assets/js/69.ac61dd61.js"><link rel="prefetch" href="/assets/js/7.5d254238.js"><link rel="prefetch" href="/assets/js/70.3edd41b1.js"><link rel="prefetch" href="/assets/js/71.d23407e9.js"><link rel="prefetch" href="/assets/js/72.a5bd01bc.js"><link rel="prefetch" href="/assets/js/73.c9f4dd57.js"><link rel="prefetch" href="/assets/js/74.66323fc1.js"><link rel="prefetch" href="/assets/js/75.e1a72e00.js"><link rel="prefetch" href="/assets/js/76.801268b4.js"><link rel="prefetch" href="/assets/js/77.3a5fda67.js"><link rel="prefetch" href="/assets/js/78.54d84cd4.js"><link rel="prefetch" href="/assets/js/79.fa10f4e3.js"><link rel="prefetch" href="/assets/js/8.e060e47d.js"><link rel="prefetch" href="/assets/js/80.d5b24fea.js"><link rel="prefetch" href="/assets/js/81.0e9da714.js"><link rel="prefetch" href="/assets/js/82.e96ff6d7.js"><link rel="prefetch" href="/assets/js/83.771cced1.js"><link rel="prefetch" href="/assets/js/84.220b69e7.js"><link rel="prefetch" href="/assets/js/85.7dcc5659.js"><link rel="prefetch" href="/assets/js/86.44ba2100.js"><link rel="prefetch" href="/assets/js/87.281da75d.js"><link rel="prefetch" href="/assets/js/88.12d88449.js"><link rel="prefetch" href="/assets/js/89.f28c86d3.js"><link rel="prefetch" href="/assets/js/9.8f9fef32.js"><link rel="prefetch" href="/assets/js/90.715cabb2.js"><link rel="prefetch" href="/assets/js/91.6ced7c82.js"><link rel="prefetch" href="/assets/js/92.c05b33ca.js"><link rel="prefetch" href="/assets/js/93.6bf5fb66.js"><link rel="prefetch" href="/assets/js/94.3561200e.js"><link rel="prefetch" href="/assets/js/95.0f2cf716.js"><link rel="prefetch" href="/assets/js/96.ac8487ea.js"><link rel="prefetch" href="/assets/js/97.48042b5a.js"><link rel="prefetch" href="/assets/js/98.441bb7f8.js"><link rel="prefetch" href="/assets/js/99.4b214d92.js">
    <link rel="stylesheet" href="/assets/css/0.styles.56073ad3.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu"><header class="navbar blur"><div title="ç›®å½•" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/img/magic.png" alt="Pangolin Note" class="logo"> <span class="site-name can-hide">Pangolin Note</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">ğŸ¡é¦–é¡µ</a></div><div class="nav-item"><a href="/basic/" class="nav-link">åŸºç¡€</a></div><div class="nav-item"><a href="/develop/" class="nav-link">å¼€å‘</a></div><div class="nav-item"><a href="/middleware/" class="nav-link">ç³»ç»Ÿ</a></div><div class="nav-item"><a href="/algorithm/" class="nav-link">ç®—æ³•</a></div><div class="nav-item"><a href="/books/" class="nav-link">ğŸ€è¯»ä¹¦ç¬”è®°</a></div><div class="nav-item"><a href="/work/" class="nav-link">å·¥ä½œ</a></div><div class="nav-item"><a href="/pangolin/" class="nav-link">ğŸŒ¸è¾¾å°”æ–‡çš„çŒ¹</a></div><div class="nav-item"><a href="/pages/beb6c0bd8a66cea6/" class="nav-link">æ”¶è—</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="ç´¢å¼•" class="dropdown-title"><a href="/archives/" class="link-title">ç´¢å¼•</a> <span class="title" style="display:none;">ç´¢å¼•</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">åˆ†ç±»</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">æ ‡ç­¾</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">å½’æ¡£</a></li></ul></div></div> <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><div class="blogger"><img src="/img/avatarnew.png"> <div class="blogger-info"><h3>è¾¾å°”æ–‡çš„çŒ¹</h3> <span>å¤§é“è‡³ç®€ æ‚Ÿåœ¨å¤©æˆ</span></div></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">ğŸ¡é¦–é¡µ</a></div><div class="nav-item"><a href="/basic/" class="nav-link">åŸºç¡€</a></div><div class="nav-item"><a href="/develop/" class="nav-link">å¼€å‘</a></div><div class="nav-item"><a href="/middleware/" class="nav-link">ç³»ç»Ÿ</a></div><div class="nav-item"><a href="/algorithm/" class="nav-link">ç®—æ³•</a></div><div class="nav-item"><a href="/books/" class="nav-link">ğŸ€è¯»ä¹¦ç¬”è®°</a></div><div class="nav-item"><a href="/work/" class="nav-link">å·¥ä½œ</a></div><div class="nav-item"><a href="/pangolin/" class="nav-link">ğŸŒ¸è¾¾å°”æ–‡çš„çŒ¹</a></div><div class="nav-item"><a href="/pages/beb6c0bd8a66cea6/" class="nav-link">æ”¶è—</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="ç´¢å¼•" class="dropdown-title"><a href="/archives/" class="link-title">ç´¢å¼•</a> <span class="title" style="display:none;">ç´¢å¼•</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">åˆ†ç±»</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">æ ‡ç­¾</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">å½’æ¡£</a></li></ul></div></div> <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Java</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading open"><span>åŸºç¡€</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/4f30b9/" class="sidebar-link">JavaåŸºç¡€</a></li><li><a href="/pages/795eca/" class="sidebar-link">ç±»ä¸ç»§æ‰¿</a></li><li><a href="/pages/c69152/" class="sidebar-link">æŠ½è±¡ç±»ä¸æ¥å£</a></li><li><a href="/pages/d71abb/" class="sidebar-link">å†…éƒ¨ç±»</a></li><li><a href="/pages/f06dca/" class="sidebar-link">æšä¸¾ç±»</a></li><li><a href="/pages/259f57/" class="sidebar-link">å¸¸ç”¨ç±»</a></li><li><a href="/pages/84b03b/" class="sidebar-link">å…³é”®å­—</a></li><li><a href="/pages/31b87b/" class="sidebar-link">æ³¨è§£</a></li><li><a href="/pages/f81c0d/" class="sidebar-link">å¼‚å¸¸</a></li><li><a href="/pages/ae7746/" class="sidebar-link">æ³›å‹</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading"><span>å®¹å™¨ç±»</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/0c88ac/" class="sidebar-link">é›†åˆå®¹å™¨ç±»åŸºç¡€</a></li><li><a href="/pages/f805ed/" class="sidebar-link">Listä¸Queueç±»</a></li><li><a href="/pages/d24b60/" class="sidebar-link">Mapä¸Setç±»</a></li><li><a href="/pages/54e5d3/" class="sidebar-link">å¹¶å‘å®¹å™¨ç±»</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading"><span>å¹¶å‘</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/67d70f/" class="sidebar-link">å¤šçº¿ç¨‹åŸºç¡€</a></li><li><a href="/pages/ffc8f7/" class="sidebar-link">Javaå†…ç½®é”</a></li><li><a href="/pages/c43494/" class="sidebar-link">AQS</a></li><li><a href="/pages/eb5b61/" class="sidebar-link">æ˜¾å¼é”ReentrantLock</a></li><li><a href="/pages/eb8cbc/" class="sidebar-link">çº¿ç¨‹åä½œä¸JUCç»„ä»¶</a></li><li><a href="/pages/23c79a/" class="sidebar-link">AtomicåŸå­å˜é‡ä¸Unsafeç±»ä¸CAS</a></li><li><a href="/pages/9d6ed4/" class="sidebar-link">çº¿ç¨‹æ± ä¸å®šæ—¶ä»»åŠ¡</a></li><li><a href="/pages/5b787a/" class="sidebar-link">ThreadLocal</a></li><li><a href="/pages/db53d1/" class="sidebar-link">Javaå¹¶å‘ç¼–ç¨‹å®æˆ˜(æå®¢æ—¶é—´)ğŸŒ¸</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading"><span>IO</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/b4d461/" class="sidebar-link">æ–‡ä»¶æ“ä½œ</a></li><li><a href="/pages/1b9d6c/" class="sidebar-link">IOæµæ“ä½œ</a></li><li><a href="/pages/076a47/" class="sidebar-link">Javaç½‘ç»œIOæ¨¡å‹</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading"><span>é«˜çº§ç‰¹æ€§</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/d76905/" class="sidebar-link">Lambdaè¡¨è¾¾å¼</a></li><li><a href="/pages/f7f0e6/" class="sidebar-link">æµStream</a></li><li><a href="/pages/7cc40a/" class="sidebar-link">åå°„</a></li><li><a href="/pages/945326/" class="sidebar-link">ä»£ç†</a></li><li><a href="/pages/7fd9b4/" class="sidebar-link">Javaagent</a></li><li><a href="/pages/a3cee0/" class="sidebar-link">Guava</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading"><span>JVM</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/d308f6/" class="sidebar-link">èµ°è¿›JVMğŸŒ¼</a></li><li><a href="/pages/be0269/" class="sidebar-link">JVMå†…å­˜åŒºåŸŸä¸å¯¹è±¡è§£æğŸŒ¼</a></li><li><a href="/pages/48d1be/" class="sidebar-link">åƒåœ¾æ”¶é›†å™¨ä¸å†…å­˜åˆ†é…ç­–ç•¥ğŸŒ¼</a></li><li><a href="/pages/3a4c8a/" class="sidebar-link">JVMæ€§èƒ½ç›‘æ§ä¸æ•…éšœå¤„ç†å·¥å…·ğŸŒ¼</a></li><li><a href="/pages/106680/" class="sidebar-link">è°ƒä¼˜æ¡ˆä¾‹åˆ†æä¸å®æˆ˜ğŸŒ¼</a></li><li><a href="/pages/16a914/" class="sidebar-link">ç±»æ–‡ä»¶ç»“æ„ğŸŒ¼</a></li><li><a href="/pages/ea287c/" class="sidebar-link">è™šæ‹Ÿæœºç±»åŠ è½½æœºåˆ¶ğŸŒ¼</a></li><li><a href="/pages/6367b0/" class="sidebar-link">è™šæ‹Ÿæœºå­—èŠ‚ç æ‰§è¡Œå¼•æ“ğŸŒ¼</a></li><li><a href="/pages/c6c210/" class="sidebar-link">ç±»åŠ è½½åŠæ‰§è¡Œå­ç³»ç»Ÿçš„æ¡ˆä¾‹ä¸å®æˆ˜ğŸŒ¼</a></li><li><a href="/pages/deb8b7/" class="sidebar-link">å‰ç«¯ç¼–è¯‘ä¸ä¼˜åŒ–ğŸŒ¼</a></li><li><a href="/pages/1f8f72/" class="sidebar-link">åç«¯ç¼–è¯‘ä¸ä¼˜åŒ–ğŸŒ¼</a></li><li><a href="/pages/3d72db/" class="sidebar-link">Javaå†…å­˜æ¨¡å‹ä¸çº¿ç¨‹å®ç°ğŸŒ¼</a></li><li><a href="/pages/ed086e/" class="sidebar-link">çº¿ç¨‹å®‰å…¨ä¸å†…ç½®é”ä¼˜åŒ–ğŸŒ¼</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading"><span>å…¶ä»–</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/56b9dd/" class="sidebar-link">Javaæ€§èƒ½é—®é¢˜å®šä½åˆ†æ</a></li><li><a href="/pages/939bf8/" class="sidebar-link">æ‚è®°</a></li></ul></section></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>å¼€å‘</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading"><span>è½¯ä»¶è®¾è®¡</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/a5f6fe/" class="sidebar-link">è®¾è®¡åŸºç¡€ç†è®º</a></li><li><a href="/pages/3b245c/" class="sidebar-link">è®¾è®¡æ¨¡å¼ä¹‹ç¾(æå®¢æ—¶é—´)ğŸŒŸ</a></li><li><a href="/pages/661fa4/" class="sidebar-link">é¢†åŸŸé©±åŠ¨è®¾è®¡(DDD)</a></li><li><a href="/pages/856368/" class="sidebar-link">DDDå®æˆ˜è¯¾(æå®¢æ—¶é—´)ğŸŒ¸</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading"><span>æ•°æ®åº“</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/d3fbd2/" class="sidebar-link">æ•°æ®åº“åŸºç¡€</a></li><li><a href="/pages/691fc3/" class="sidebar-link">æ•°æ®åº“ç³»ç»ŸåŸç†</a></li><li><a href="/pages/50f6b7/" class="sidebar-link">MySQLåŸºç¡€å¿…çŸ¥å¿…ä¼š</a></li><li><a href="/pages/fe297e/" class="sidebar-link">MySQLç‰¹æ€§</a></li><li><a href="/pages/07bdb6/" class="sidebar-link">MySQLç´¢å¼•ğŸŒŸ</a></li><li><a href="/pages/984715/" class="sidebar-link">MySQLé”ğŸŒŸ</a></li><li><a href="/pages/53b588/" class="sidebar-link">MySQLäº‹åŠ¡ğŸŒŸ</a></li><li><a href="/pages/becc59/" class="sidebar-link">MySQLé«˜çº§ç‰¹æ€§</a></li><li><a href="/pages/056463/" class="sidebar-link">MySQLåŸºç¡€æ¶æ„ä¸å­˜å‚¨å¼•æ“ğŸŒŸ</a></li><li><a href="/pages/63b46e/" class="sidebar-link">MySQLæ¶æ„ä¼˜åŒ–ä¸è¿ç»´</a></li><li><a href="/pages/9995e5/" class="sidebar-link">MySQLä¼˜åŒ–</a></li><li><a href="/pages/c1c2f6/" class="sidebar-link">MySQLæ¶æ„</a></li><li><a href="/pages/8e8e0a/" class="sidebar-link">MySQLè®¾è®¡è§„èŒƒ</a></li><li><a href="/pages/0219aa/" class="sidebar-link">MySQLè¿ç»´</a></li><li><a href="/pages/e288c0/" class="sidebar-link">MySQLä¸­é—´ä»¶</a></li><li><a href="/pages/c6cafa/" class="sidebar-link">MySQLå®æˆ˜45è®²(æå®¢æ—¶é—´)ğŸŒŸ</a></li><li><a href="/pages/4a6106/" class="sidebar-link">æ•°æ®åº“LeetCodeé¢˜ç›®</a></li><li><a href="/pages/2827f1/" class="sidebar-link">æ•°æ®åº“ç»¼åˆé—®é¢˜</a></li><li><a href="/pages/c616d5/" class="sidebar-link">MongoDB</a></li><li><a href="/pages/075e71/" class="sidebar-link">ClickHouse</a></li><li><a href="/pages/d74f6d/" class="sidebar-link">Doris</a></li><li><a href="/pages/b6bad9/" class="sidebar-link">HBase</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading open"><span>Spring</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/bd8eb8/" class="sidebar-link">Spring BootåŸºç¡€</a></li><li><a href="/pages/d0d797/" class="sidebar-link">Spring Bootåº”ç”¨æ•´åˆ</a></li><li><a href="/pages/314cdc/" class="sidebar-link">Spring MVCåŸºç¡€</a></li><li><a href="/pages/80de47/" class="sidebar-link">Spring AOPåŸºç¡€</a></li><li><a href="/pages/f0d4d6/" class="sidebar-link">Springäº‹åŠ¡åŸºç¡€</a></li><li><a href="/pages/db6afe/" class="sidebar-link">Spring IOCæºç åˆ†æ-æ¦‚è§ˆ</a></li><li><a href="/pages/672e98/" class="sidebar-link">Spring IOCæºç åˆ†æ-getBean()</a></li><li><a href="/pages/695b90/" aria-current="page" class="active sidebar-link">Spring IOCæºç åˆ†æ-createBean()</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/pages/f89bcf/" class="sidebar-link">Spring AOPæºç åˆ†æ</a></li><li><a href="/pages/3b52f4/" class="sidebar-link">Springäº‹åŠ¡æºç åˆ†æ</a></li><li><a href="/pages/186902/" class="sidebar-link">Spring Bootæºç åˆ†æ</a></li><li><a href="/pages/16bd1c/" class="sidebar-link">Spring MVCæºç åˆ†æ</a></li><li><a href="/pages/3d0c1f/" class="sidebar-link">Spring Cloud</a></li><li><a href="/pages/d56156/" class="sidebar-link">Springç¼–ç¨‹å¸¸è§é”™è¯¯50ä¾‹(æå®¢æ—¶é—´)ğŸŒ¸</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading"><span>MyBatis</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/bb032d/" class="sidebar-link">åŸºç¡€</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading"><span>å·¥å…·ä¸ç¯å¢ƒ</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/c9cb6e/" class="sidebar-link">Arthas</a></li><li><a href="/pages/3172bb/" class="sidebar-link">Maven</a></li><li><a href="/pages/37f79a/" class="sidebar-link">Git</a></li><li><a href="/pages/db9f99/" class="sidebar-link">ç¯å¢ƒæ­å»ºä¸éƒ¨ç½²</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading"><span>æµ‹è¯•</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/c725f5/" class="sidebar-link">æµ‹è¯•åŸºç¡€</a></li><li><a href="/pages/7893a4/" class="sidebar-link">å•å…ƒæµ‹è¯•</a></li><li><a href="/pages/af9f25/" class="sidebar-link">å‹åŠ›æµ‹è¯•</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading"><span>ä»£ç è´¨é‡</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/ec2b81/" class="sidebar-link">ä»£ç æ•´æ´ä¹‹é“</a></li><li><a href="/pages/474cdf/" class="sidebar-link">é˜¿é‡Œå·´å·´ç¼–ç¨‹è§„èŒƒ</a></li><li><a href="/pages/c47e15/" class="sidebar-link">ä»£ç ä¹‹ä¸‘(æå®¢æ—¶é—´)ğŸŒ¸</a></li><li><a href="/pages/4d4606/" class="sidebar-link">Javaä¸šåŠ¡å¼€å‘å¸¸è§é”™è¯¯100ä¾‹(æå®¢æ—¶é—´)ğŸŒ¸</a></li></ul></section></li></ul></section></li></ul> </aside> <div><main class="page"><div class="theme-vdoing-wrapper "><div class="articleInfo-wrap" data-v-06970110><div class="articleInfo" data-v-06970110><ul class="breadcrumbs" data-v-06970110><li data-v-06970110><a href="/" title="é¦–é¡µ" class="iconfont icon-home router-link-active" data-v-06970110></a></li> <li data-v-06970110><a href="/develop/#å¼€å‘" data-v-06970110>å¼€å‘</a></li><li data-v-06970110><a href="/develop/#å¼€å‘" data-v-06970110>å¼€å‘</a></li><li data-v-06970110><a href="/develop/#Spring" data-v-06970110>Spring</a></li></ul> <div class="info" data-v-06970110><div title="ä½œè€…" class="author iconfont icon-touxiang" data-v-06970110><a href="https://github.com/nanodaemony" target="_blank" title="ä½œè€…" class="beLink" data-v-06970110>NanoDaemony</a></div> <div title="åˆ›å»ºæ—¶é—´" class="date iconfont icon-riqi" data-v-06970110><a href="javascript:;" data-v-06970110>2025-02-26</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-title">æœ¬æ–‡ç›®å½•</div> <div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABH1JREFUSA3tVl1oHFUUPmdmd2ltklqbpJDiNnXFmgbFktho7YMPNiJSSZM0+CAYSkUELVhM6YuwIPpgoOKDqOBDC0XE2CQoNtQXBUFTTcCi+Wlh1V2TQExsUzcltd3M9Tt3ZjZzZ2fT+OJTL8yeM+eee757fmeJbq//KQL8X3DUSFOcfr7cRsRtxNQMWueeVzOkaITIGqQHNg5y8+jNW9ldM7A6nTpAjuolUikAwq7CE3WcM2RRDz+XGVgN3FptU/aUSlvq9Pa3iZ1+sgAqJyyAFqkipd9dqiwHF3P65YycLWc/6sqGrvoEoIp6DOFaX5h6+dnfjkWprwqsPk0dUGq5vySwDImC10KxFHgGL1SWoc92O3eVht09qdXNH11I2SsTsJYqMWzihqGMi+A+Garf3BAuuLI5oGlULyNfyB/HYNujwktOfRrMr5t77NmevqaUopx0grnKAyvVpmwUDB4x6FPXuGvYLTDwWsejwgtgkYKPqRJg8SV6xaiZ3ZTppGneS4yfH5/66fZSDHv+QZci/+h5c5UHtpy67JUqGppM0sh0Nc1dW6/N1W5Yoqat8/TU/VnadmdeW2PLLSyh0cvxBs3KbqTmwYPpxN4do/mzE8nEpvX/UMu2Wbp74zUAK5q6WkHns7V0eWkdPbPzd3rxkTGybadYySumVzhcaJFbs5UrEkQ/+CK8gF5dnh/6ciIZ73gwQ927L1IitoxKLXYP3SjYdOrHHfTZhRRlFyrorafPk20B3HPD1y2G3qKZME5Jcf3t/HUC13/8tSd++vqFveMUTwAUxSUFI1QekR1+bIze3D9MF2aq6cPvG72CgnldWCFqyRw3lwH8ZMerjTD9ElRO7Gv44wNpC90aASqGfVlz/Rx17srQ57/UU26hkhQqUB7dBR71WmzQhHUnblGmVOEw0jhbV1n9OlXUDCIRGaNV5Jp43N516fN7JmnTHdfp7Hgy0luO4aMhtkLL8Bi3bUWYvzh5Mn1dTxrL6QmGuRhGL/TiTTxRoEdTszSaq9GR0NGA3KdkOz3hqSV3MIDhQ5IVX/Ivx3umBti2es2h4eZby7x8br1rkf7Mo90AqC8aQ3sJeNzqFRu+vSANAQe3PL7l0HGOAdwDCeZYvNKeoZp1Qfs6Aipndh86HmFRi0LAnEO47wsqM6cdfjh3jBPUzhZy7nvlUfFsamED1VQt6aISHVymXZ/B2aCtIG8AI8xfobj2d3en1wWVhOeHELKmLQ1s211s88comkv4UCwWyF787mJdYXtNfhKAXVqnKTq8QZvGAGGOfaTo5pGZ/PwbUCr5+DPr/1J92JNHr9aOl/F3iI5+O1nfybsGxoimvZ3ViWSluDITw3P37mypheDIPY0tw7+O/5ApbkYw+zpfaUVu32Pi98+defdUhEpZkRFq0aqyNh9FuL9hpYbEm6iwi0z2REd09ZmyENEbuhjDWzKvZXTqKYaBIr3tt5kuPtQBZFvEUwHt60vfCNu41XsksH9Ij1BMMz1Y0OOunHNShFIP5868g5zeXmuLwL9T4b6Q2+KejgAAAABJRU5ErkJggg==">Spring IOCæºç åˆ†æ-createBean()<!----></h1>  <div class="theme-vdoing-content content__default"><h1 id="_12-spring-iocæºç åˆ†æ-createbean"><a href="#_12-spring-iocæºç åˆ†æ-createbean" class="header-anchor">#</a> 12.Spring IOCæºç åˆ†æ-createBean()</h1> <p>åœ¨ä¸Šé¢çš„ doGetBean() æ–¹æ³•ä¸­, æœ€é‡è¦çš„åˆ›å»º bean å®ä¾‹çš„ createBean() æ–¹æ³•åœ¨è¿™é‡Œå•ç‹¬åˆ†æ, doGetBean() æ–¹æ³•ä¸­, <strong>singleton å’Œ prototype ç±»å‹</strong>çš„ bean éƒ½ä¼šè°ƒç”¨è¿™ä¸ªæ–¹æ³•.</p> <p>æºç å¦‚ä¸‹.</p> <blockquote><p>AbstractAutowireCapableBeanFactory::createBean()</p></blockquote> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">protected</span> <span class="token class-name">Object</span> <span class="token function">createBean</span><span class="token punctuation">(</span><span class="token class-name">String</span> beanName<span class="token punctuation">,</span> <span class="token class-name">RootBeanDefinition</span> mbd<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">BeanCreationException</span> <span class="token punctuation">{</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isInfoEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;Creating instance of bean: '&quot;</span> <span class="token operator">+</span> beanName <span class="token operator">+</span> <span class="token string">&quot;'&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token class-name">RootBeanDefinition</span> mbdToUse <span class="token operator">=</span> mbd<span class="token punctuation">;</span>

    <span class="token comment">// 1.è§£æbeanNameå¯¹åº”çš„Beançš„ç±»å‹, ä¾‹å¦‚: com.nano.service.impl.UserServiceImpl</span>
    <span class="token comment">// é”å®šclass, æ ¹æ®è®¾ç½®çš„classå±æ€§æˆ–è€…æ ¹æ®classNameæ¥è§£æclass</span>
    <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> resolvedClass <span class="token operator">=</span> <span class="token function">resolveBeanClass</span><span class="token punctuation">(</span>mbd<span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>resolvedClass <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>mbd<span class="token punctuation">.</span><span class="token function">hasBeanClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> mbd<span class="token punctuation">.</span><span class="token function">getBeanClassName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// å¦‚æœresolvedClasså­˜åœ¨, å¹¶ä¸”mdbçš„beanClassç±»å‹ä¸æ˜¯Class, å¹¶ä¸”mdbçš„beanClass</span>
        <span class="token comment">// ä¸ä¸ºç©º(åˆ™ä»£è¡¨beanClasså­˜çš„æ˜¯Classçš„name),åˆ™ä½¿ç”¨mdbæ·±æ‹·è´ä¸€ä¸ªæ–°çš„RootBeanDefinitionå‰¯æœ¬, </span>
        <span class="token comment">// å¹¶ä¸”å°†è§£æçš„Classèµ‹å€¼ç»™æ‹·è´çš„RootBeanDefinitionå‰¯æœ¬çš„beanClasså±æ€§, è¯¥æ‹·è´å‰¯æœ¬å–ä»£mdbç”¨äºåç»­çš„æ“ä½œ</span>
        mbdToUse <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RootBeanDefinition</span><span class="token punctuation">(</span>mbd<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mbdToUse<span class="token punctuation">.</span><span class="token function">setBeanClass</span><span class="token punctuation">(</span>resolvedClass<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 2.éªŒè¯åŠå‡†å¤‡è¦†ç›–çš„æ–¹æ³•(å¯¹overrideå±æ€§è¿›è¡Œæ ‡è®°åŠéªŒè¯)</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        mbdToUse<span class="token punctuation">.</span><span class="token function">prepareMethodOverrides</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">BeanDefinitionValidationException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BeanDefinitionStoreException</span><span class="token punctuation">(</span>mbdToUse<span class="token punctuation">.</span><span class="token function">getResourceDescription</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                               beanName<span class="token punctuation">,</span> <span class="token string">&quot;Validation of method overrides failed&quot;</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment">// 3.(AOPç›¸å…³)å®ä¾‹åŒ–å‰çš„å¤„ç†, ç»™InstantiationAwareBeanPostProcessor</span>
        <span class="token comment">// ä¸€ä¸ªæœºä¼šè¿”å›ä»£ç†å¯¹è±¡æ¥æ›¿ä»£çœŸæ­£çš„beanå®ä¾‹, è¾¾åˆ°â€œçŸ­è·¯â€æ•ˆæœ</span>
        <span class="token class-name">Object</span> bean <span class="token operator">=</span> <span class="token function">resolveBeforeInstantiation</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> mbdToUse<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 4.å¦‚æœbeanä¸ä¸ºç©º, åˆ™ä¼šè·³è¿‡Springé»˜è®¤çš„å®ä¾‹åŒ–è¿‡ç¨‹, ç›´æ¥ä½¿ç”¨è¿”å›çš„bean</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>bean <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> bean<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BeanCreationException</span><span class="token punctuation">(</span>mbdToUse<span class="token punctuation">.</span><span class="token function">getResourceDescription</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> beanName<span class="token punctuation">,</span>
                                        <span class="token string">&quot;BeanPostProcessor before instantiation of bean failed&quot;</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment">// 5.çœŸæ­£åˆ›å»ºbean(å¹²æ´»çš„æ–¹æ³•)</span>
        <span class="token class-name">Object</span> beanInstance <span class="token operator">=</span> <span class="token function">doCreateBean</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> mbdToUse<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Finished creating instance of bean '&quot;</span> <span class="token operator">+</span> beanName <span class="token operator">+</span> <span class="token string">&quot;'&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> beanInstance<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">BeanCreationException</span> <span class="token operator">|</span> <span class="token class-name">ImplicitlyAppearedSingletonException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> ex<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BeanCreationException</span><span class="token punctuation">(</span>
            mbdToUse<span class="token punctuation">.</span><span class="token function">getResourceDescription</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> beanName<span class="token punctuation">,</span> <span class="token string">&quot;Unexpected exception during bean creation&quot;</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br></div></div><p>è¿™é‡Œæ³¨é‡Š 3 å¤„æ˜¯<strong>å®ä¾‹åŒ–å‰</strong>çš„å¤„ç†, ç»™ <strong>InstantiationAwareBeanPostProcessor</strong> (å®ç°äº† BeanPostProcessor æ¥å£)ä¸€ä¸ªæœºä¼š<strong>è¿”å›ä»£ç†å¯¹è±¡æ¥æ›¿ä»£çœŸæ­£çš„ bean å®ä¾‹</strong>, ä»è€Œè·³è¿‡ Spring é»˜è®¤çš„å®ä¾‹åŒ–è¿‡ç¨‹, è¾¾åˆ° &quot;çŸ­è·¯&quot; çš„æ•ˆæœ.</p> <p>æ•´ä½“æµç¨‹å¦‚ä¸‹å›¾æ‰€ç¤º. ç¼–è¾‘è¿æ¥: <a href="https://www.processon.com/diagraming/61f933af1e08530f015af3fb" target="_blank" rel="noopener noreferrer">https://www.processon.com/diagraming/61f933af1e08530f015af3fb<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><img src="https://nano-note.oss-cn-beijing.aliyuncs.com/images/Spring%20IOC-createBean()%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90.png" alt="Spring IOC-createBean()æºç åˆ†æ"></p> <h3 id="resolvebeforeinstantiation"><a href="#resolvebeforeinstantiation" class="header-anchor">#</a> resolveBeforeInstantiation()</h3> <p><strong>resolveBeforeInstantiation()</strong>  æ–¹æ³•å¦‚ä¸‹.</p> <blockquote><p>AbstractAutowireCapableBeanFactory::resolveBeforeInstantiation()</p></blockquote> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Nullable</span>
<span class="token keyword">protected</span> <span class="token class-name">Object</span> <span class="token function">resolveBeforeInstantiation</span><span class="token punctuation">(</span><span class="token class-name">String</span> beanName<span class="token punctuation">,</span> <span class="token class-name">RootBeanDefinition</span> mbd<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Object</span> bean <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token comment">// å¦‚æœå°šæœªè¢«è§£æ</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">Boolean</span><span class="token punctuation">.</span><span class="token constant">FALSE</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>mbd<span class="token punctuation">.</span>beforeInstantiationResolved<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 1.mbdä¸æ˜¯åˆæˆçš„, å¹¶ä¸”BeanFactoryä¸­å­˜åœ¨InstantiationAwareBeanPostProcessor</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mbd<span class="token punctuation">.</span><span class="token function">isSynthetic</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">hasInstantiationAwareBeanPostProcessors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 2.è§£æbeanNameå¯¹åº”çš„Beanå®ä¾‹çš„ç±»å‹</span>
            <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> targetType <span class="token operator">=</span> <span class="token function">determineTargetType</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> mbd<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>targetType <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

                <span class="token comment">// 3.å®ä¾‹åŒ–å‰çš„åç½®å¤„ç†å™¨åº”ç”¨(å¤„ç†InstantiationAwareBeanPostProcessor)</span>
                bean <span class="token operator">=</span> <span class="token function">applyBeanPostProcessorsBeforeInstantiation</span><span class="token punctuation">(</span>targetType<span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>bean <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">// 4.å¦‚æœè¿”å›çš„beanä¸ä¸ºç©º, ä¼šè·³è¿‡Springé»˜è®¤çš„å®ä¾‹åŒ–è¿‡ç¨‹, </span>
                    <span class="token comment">// æ‰€ä»¥åªèƒ½åœ¨è¿™é‡Œè°ƒç”¨BeanPostProcessorå®ç°ç±»çš„postProcessAfterInitialization()æ–¹æ³•</span>
                    bean <span class="token operator">=</span> <span class="token function">applyBeanPostProcessorsAfterInitialization</span><span class="token punctuation">(</span>bean<span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 5.å¦‚æœbeanä¸ä¸ºç©º, åˆ™å°†beforeInstantiationResolvedèµ‹å€¼ä¸ºtrue, ä»£è¡¨åœ¨å®ä¾‹åŒ–ä¹‹å‰å·²ç»è§£æ</span>
        mbd<span class="token punctuation">.</span>beforeInstantiationResolved <span class="token operator">=</span> <span class="token punctuation">(</span>bean <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> bean<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><h4 id="applybeanpostprocessorsbeforeinstantiation"><a href="#applybeanpostprocessorsbeforeinstantiation" class="header-anchor">#</a> applyBeanPostProcessorsBeforeInstantiation()</h4> <p><strong>applyBeanPostProcessorsBeforeInstantiation()</strong>  æ–¹æ³•å¦‚ä¸‹. åœ¨å®ä¾‹åŒ–ä¹‹å‰æ‰§è¡Œ <strong>InstantiationAwareBeanPostProcessor</strong> çš„ <strong>postProcessBeforeInstantiation()</strong>  æ–¹æ³•, è¯¥æ–¹æ³•å¯ä»¥<strong>è¿”å› bean å®ä¾‹çš„ä»£ç†</strong>, ä»è€Œè·³è¿‡ Spring é»˜è®¤çš„å®ä¾‹åŒ–è¿‡ç¨‹.</p> <blockquote><p>AbstractAutowireCapableBeanFactory::applyBeanPostProcessorsBeforeInstantiation()</p></blockquote> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Nullable</span>
<span class="token keyword">protected</span> <span class="token class-name">Object</span> <span class="token function">applyBeanPostProcessorsBeforeInstantiation</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> beanClass<span class="token punctuation">,</span> <span class="token class-name">String</span> beanName<span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token comment">// 1.éå†å½“å‰BeanFactoryä¸­çš„BeanPostProcessor</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">BeanPostProcessor</span> bp <span class="token operator">:</span> <span class="token function">getBeanPostProcessors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 2.åº”ç”¨InstantiationAwareBeanPostProcessoråç½®å¤„ç†å™¨, å…è®¸postProcessBeforeInstantiationæ–¹æ³•è¿”å›beanå¯¹è±¡çš„ä»£ç†</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>bp <span class="token keyword">instanceof</span> <span class="token class-name">InstantiationAwareBeanPostProcessor</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">InstantiationAwareBeanPostProcessor</span> ibp <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">InstantiationAwareBeanPostProcessor</span><span class="token punctuation">)</span> bp<span class="token punctuation">;</span>
            <span class="token comment">// 3.æ‰§è¡ŒpostProcessBeforeInstantiationæ–¹æ³•, åœ¨Beanå®ä¾‹åŒ–å‰æ“ä½œ, </span>
            <span class="token comment">// è¯¥æ–¹æ³•å¯ä»¥è¿”å›ä¸€ä¸ªæ„é€ å®Œæˆçš„Beanå®ä¾‹, ä»è€Œä¸ä¼šç»§ç»­æ‰§è¡Œåˆ›å»ºBeanå®ä¾‹çš„â€œæ­£è§„çš„æµç¨‹â€, è¾¾åˆ°â€œçŸ­è·¯â€çš„æ•ˆæœ. </span>
            <span class="token class-name">Object</span> result <span class="token operator">=</span> ibp<span class="token punctuation">.</span><span class="token function">postProcessBeforeInstantiation</span><span class="token punctuation">(</span>beanClass<span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// 4.å¦‚æœresultä¸ä¸ºç©º, ä¹Ÿå°±æ˜¯æœ‰åç½®å¤„ç†å™¨è¿”å›äº†beanå®ä¾‹å¯¹è±¡, åˆ™ä¼šè·³è¿‡Springé»˜è®¤çš„å®ä¾‹åŒ–è¿‡ç¨‹</span>
                <span class="token keyword">return</span> result<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><h4 id="applybeanpostprocessorsafterinitialization"><a href="#applybeanpostprocessorsafterinitialization" class="header-anchor">#</a> applyBeanPostProcessorsAfterInitialization()</h4> <p>applyBeanPostProcessorsAfterInitialization() æ–¹æ³•å¦‚ä¸‹.</p> <blockquote><p>AbstractAutowireCapableBeanFactory::applyBeanPostProcessorsAfterInitialization()</p></blockquote> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">applyBeanPostProcessorsAfterInitialization</span><span class="token punctuation">(</span><span class="token class-name">Object</span> existingBean<span class="token punctuation">,</span> <span class="token class-name">String</span> beanName<span class="token punctuation">)</span>
    <span class="token keyword">throws</span> <span class="token class-name">BeansException</span> <span class="token punctuation">{</span>

    <span class="token class-name">Object</span> result <span class="token operator">=</span> existingBean<span class="token punctuation">;</span>
    <span class="token comment">// 1.éå†æ‰€æœ‰æ³¨å†Œçš„BeanPostProcessorå®ç°ç±», è°ƒç”¨postProcessAfterInitializationæ–¹æ³•</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">BeanPostProcessor</span> processor <span class="token operator">:</span> <span class="token function">getBeanPostProcessors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 2.åœ¨beanåˆå§‹åŒ–å, è°ƒç”¨postProcessAfterInitializationæ–¹æ³•</span>
        <span class="token class-name">Object</span> current <span class="token operator">=</span> processor<span class="token punctuation">.</span><span class="token function">postProcessAfterInitialization</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>current <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 3.å¦‚æœè¿”å›null, åˆ™ä¸ä¼šè°ƒç”¨åç»­çš„BeanPostProcessors</span>
            <span class="token keyword">return</span> result<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        result <span class="token operator">=</span> current<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><h3 id="docreatebean"><a href="#docreatebean" class="header-anchor">#</a> doCreateBean()</h3> <p>è¿™é‡Œåˆ†æ createBean() æ–¹æ³•çœŸæ­£å¹²æ´»çš„æ–¹æ³• doCreateBean(). <strong>çœŸæ­£åˆ›å»º bean å®ä¾‹çš„æ–¹æ³•, æ˜¯æ ¸å¿ƒä¸­çš„æ ¸å¿ƒ, å¾ˆå¤šä»£ç æ˜¯å‰åç›¸å…³è”çš„, éœ€è¦åå¤é˜…è¯»æ‰èƒ½å¾ˆå¥½çš„ç†è§£</strong>.</p> <blockquote><p>AbstractAutowireCapableBeanFactory::doCreateBean()</p></blockquote> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">protected</span> <span class="token class-name">Object</span> <span class="token function">doCreateBean</span><span class="token punctuation">(</span><span class="token class-name">String</span> beanName<span class="token punctuation">,</span> <span class="token class-name">RootBeanDefinition</span> mbd<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">BeanCreationException</span> <span class="token punctuation">{</span>

    <span class="token comment">// 1.æ–°å»ºBeanåŒ…è£…ç±»</span>
    <span class="token class-name">BeanWrapper</span> instanceWrapper <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token comment">// 2.å¦‚æœæ˜¯å•ä¾‹, åˆ™éœ€è¦å…ˆç§»é™¤æœªå®Œæˆçš„FactoryBeanå®ä¾‹çš„ç¼“å­˜</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>mbd<span class="token punctuation">.</span><span class="token function">isSingleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        instanceWrapper <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>factoryBeanInstanceCache<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// å®ä¾‹åŒ–bean, å°†BeanDefinitionè½¬æ¢ä¸ºBeanWrapper</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>instanceWrapper <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 3.æ ¹æ®beanName, mbd, args, ä½¿ç”¨å¯¹åº”çš„ç­–ç•¥åˆ›å»ºBeanå®ä¾‹, å¹¶è¿”å›åŒ…è£…ç±»BeanWrapper</span>
        <span class="token comment">// åˆ°è¿™é‡Œè¯´æ˜ä¸æ˜¯ FactoryBean, è¿™é‡Œå®ä¾‹åŒ– Bean, è¿™é‡Œéå¸¸å…³é”®, ç»†èŠ‚ä¹‹åå†è¯´</span>
        <span class="token comment">// æ ¹æ®æŒ‡å®šbeanä½¿ç”¨å¯¹åº”çš„ç­–ç•¥æ¥åˆ›å»ºæ–°çš„å®ä¾‹, å¦‚å·¥å‚æ–¹æ³•, æ„é€ å‡½æ•°è‡ªåŠ¨æ³¨å…¥, ç®€å•åˆå§‹åŒ–</span>
        instanceWrapper <span class="token operator">=</span> <span class="token function">createBeanInstance</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> mbd<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 4.è·å–åˆ›å»ºå¥½çš„Beanå®ä¾‹</span>
    <span class="token class-name">Object</span> bean <span class="token operator">=</span> instanceWrapper<span class="token punctuation">.</span><span class="token function">getWrappedInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 5.è·å–Beanå®ä¾‹çš„ç±»å‹Class</span>
    <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> beanType <span class="token operator">=</span> instanceWrapper<span class="token punctuation">.</span><span class="token function">getWrappedClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>beanType <span class="token operator">!=</span> <span class="token class-name">NullBean</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        mbd<span class="token punctuation">.</span>resolvedTargetType <span class="token operator">=</span> beanType<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mbd<span class="token punctuation">.</span>postProcessingLock<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mbd<span class="token punctuation">.</span>postProcessed<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token comment">// 6.åº”ç”¨åç½®å¤„ç†å™¨MergedBeanDefinitionPostProcessor, å…è®¸ä¿®æ”¹MergedBeanDefinition, </span>
                <span class="token comment">// Autowiredæ³¨è§£æ­£æ˜¯é€šè¿‡æ­¤æ–¹æ³•å®ç°æ³¨å…¥ç±»å‹çš„é¢„è§£æ</span>
                <span class="token function">applyMergedBeanDefinitionPostProcessors</span><span class="token punctuation">(</span>mbd<span class="token punctuation">,</span> beanType<span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BeanCreationException</span><span class="token punctuation">(</span>mbd<span class="token punctuation">.</span><span class="token function">getResourceDescription</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> beanName<span class="token punctuation">,</span>
                                                <span class="token string">&quot;Post-processing of merged bean definition failed&quot;</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            mbd<span class="token punctuation">.</span>postProcessed <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 7.åˆ¤æ–­æ˜¯å¦éœ€è¦ææ—©æ›å…‰å®ä¾‹: (å•ä¾‹ &amp;&amp; å…è®¸å¾ªç¯ä¾èµ– &amp;&amp; å½“å‰beanæ­£åœ¨åˆ›å»ºä¸­)</span>
    <span class="token comment">// ä¸‹é¢è¿›è¡Œä¾èµ–å¤„ç†(è§£å†³å¾ªç¯ä¾èµ–é—®é¢˜)</span>
    <span class="token comment">// è¿™é‡Œåªå¯¹å•ä¾‹æœ‰æ•ˆ, å¯¹äºprototypeçš„bean, Springæ²¡æœ‰å¥½çš„è§£å†³æ–¹æ³•, åªèƒ½æŠ›å¼‚å¸¸</span>
    <span class="token keyword">boolean</span> earlySingletonExposure <span class="token operator">=</span> <span class="token punctuation">(</span>mbd<span class="token punctuation">.</span><span class="token function">isSingleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
                                      <span class="token keyword">this</span><span class="token punctuation">.</span>allowCircularReferences <span class="token operator">&amp;&amp;</span> <span class="token function">isSingletonCurrentlyInCreation</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// è¦ææ—©æ›å…‰å®ä¾‹</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>earlySingletonExposure<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Eagerly caching bean '&quot;</span> <span class="token operator">+</span> beanName <span class="token operator">+</span> <span class="token string">&quot;' to allow for resolving potential circular references&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 8.ç”¨äºè§£å†³å¾ªç¯ä¾èµ–. æå‰æš´éœ²ä¸€ä¸ªå•ä¾‹å·¥å‚æ–¹æ³• ä½¿å…¶ä»–çš„beanèƒ½å¼•ç”¨åˆ°è¯¥bean</span>
        <span class="token comment">// è¿™é‡Œæå‰æ›å…‰beanNameçš„ObjectFactory, å³åœ¨beanåˆå§‹åŒ–å®Œæˆå‰å°†åˆ›å»ºå®ä¾‹çš„ObjectFactoryåŠ å…¥å·¥å‚</span>
        <span class="token comment">// è¿™é‡Œå°†æ—©æœŸbeanå­˜å…¥åˆ°ä¸‰çº§ç¼“å­˜ä¸­singletonFactories</span>
        <span class="token function">addSingletonFactory</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span>
                            <span class="token comment">// 8.1.(AOPç›¸å…³)ä¸»è¦åº”ç”¨SmartInstantiationAwareBeanPostProcessor</span>
                            <span class="token comment">// å…è®¸è¿”å›æŒ‡å®šbeançš„æ—©æœŸå¼•ç”¨, AOPå°±æ˜¯åœ¨è¿™é‡Œå°†adviceåŠ¨æ€ç»‡å…¥beanä¸­, </span>
                            <span class="token comment">// è‹¥æ²¡æœ‰åˆ™ç›´æ¥è¿”å›bean, ä¸åšä»»ä½•å¤„ç†</span>
                            <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token function">getEarlyBeanReference</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> mbd<span class="token punctuation">,</span> bean<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// å±æ€§å¡«å……ä¸beançš„åˆå§‹åŒ–</span>
    <span class="token class-name">Object</span> exposedObject <span class="token operator">=</span> bean<span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment">// 9.å¯¹beanè¿›è¡Œå±æ€§å¡«å……, å°†å„ä¸ªå±æ€§å€¼æ³¨å…¥; å…¶ä¸­å¯èƒ½å­˜åœ¨ä¾èµ–äºå…¶ä»–beançš„å±æ€§, åˆ™ä¼šé€’å½’åˆå§‹åŒ–ä¾èµ–çš„beanå®ä¾‹</span>
        <span class="token comment">// è¿™ä¸€æ­¥è´Ÿè´£å±æ€§è£…é…, å› ä¸ºå‰é¢çš„å®ä¾‹åªæ˜¯å®ä¾‹åŒ–äº†, å¹¶æ²¡æœ‰èµ‹å€¼, è¿™é‡Œå°±æ˜¯èµ‹å€¼</span>
        <span class="token function">populateBean</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> mbd<span class="token punctuation">,</span> instanceWrapper<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 10.å¯¹beanè¿›è¡Œåˆå§‹åŒ–, è¿™é‡Œå°±æ˜¯å¤„ç†beanåˆå§‹åŒ–å®Œæˆåçš„å„ç§æ–¹æ³•å›è°ƒ</span>
        <span class="token comment">// init-methodå±æ€§, InitializingBeanæ¥å£, BeanPostProcessoræ¥å£ç­‰éƒ½ä¼šåœ¨è¿™é‡Œè§¦å‘</span>
        exposedObject <span class="token operator">=</span> <span class="token function">initializeBean</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> exposedObject<span class="token punctuation">,</span> mbd<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ex <span class="token keyword">instanceof</span> <span class="token class-name">BeanCreationException</span> <span class="token operator">&amp;&amp;</span> beanName<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">BeanCreationException</span><span class="token punctuation">)</span> ex<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBeanName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token punctuation">(</span><span class="token class-name">BeanCreationException</span><span class="token punctuation">)</span> ex<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BeanCreationException</span><span class="token punctuation">(</span>mbd<span class="token punctuation">.</span><span class="token function">getResourceDescription</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> beanName<span class="token punctuation">,</span> <span class="token string">&quot;Initialization of bean failed&quot;</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// å¦‚æœéœ€è¦æå‰æ›å…‰</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>earlySingletonExposure<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token comment">// 11.å¦‚æœå…è®¸æå‰æ›å…‰å®ä¾‹, åˆ™è¿›è¡Œå¾ªç¯ä¾èµ–æ£€æŸ¥</span>
        <span class="token comment">// ä»æ­£åœ¨åˆ›å»ºçš„ç¼“å­˜æ± ä¸­è·å–æŸ¥è¯¢å½“å‰bean, å¦‚æœæŸ¥åˆ°äº†è¯´æ˜å­˜åœ¨å¾ªç¯ä¾èµ–</span>
        <span class="token class-name">Object</span> earlySingletonReference <span class="token operator">=</span> <span class="token function">getSingleton</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 11.1 earlySingletonReferenceåªæœ‰åœ¨å½“å‰è§£æçš„beanæ£€æµ‹åˆ°å­˜åœ¨å¾ªç¯ä¾èµ–çš„æƒ…å†µä¸‹æ‰ä¼šä¸ä¸ºç©º</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>earlySingletonReference <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

            <span class="token comment">// 11.2 å¦‚æœexposedObjectæ²¡æœ‰åœ¨initializeBeanåˆå§‹åŒ–æ–¹æ³•ä¸­è¢«å¢å¼º, åˆ™ä¸å½±å“ä¹‹å‰çš„å¾ªç¯å¼•ç”¨</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>exposedObject <span class="token operator">==</span> bean<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                exposedObject <span class="token operator">=</span> earlySingletonReference<span class="token punctuation">;</span>

                <span class="token comment">// 11.3 å¦‚æœexposedObjectåœ¨initializeBeanæ–¹æ³•ä¸­è¢«å¢å¼º &amp;&amp; ä¸å…è®¸åœ¨å¾ªç¯å¼•ç”¨çš„æƒ…å†µä¸‹ä½¿ç”¨æ³¨å…¥åŸå§‹beanå®ä¾‹</span>
                <span class="token comment">// &amp;&amp; å½“å‰beanæœ‰è¢«å…¶ä»–beanä¾èµ–</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>allowRawInjectionDespiteWrapping <span class="token operator">&amp;&amp;</span> <span class="token function">hasDependentBean</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// 11.4 æ‹¿åˆ°ä¾èµ–å½“å‰beançš„æ‰€æœ‰beançš„beanNameæ•°ç»„</span>
                <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> dependentBeans <span class="token operator">=</span> <span class="token function">getDependentBeans</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> actualDependentBeans <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedHashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>dependentBeans<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> dependentBean <span class="token operator">:</span> dependentBeans<span class="token punctuation">)</span> <span class="token punctuation">{</span>

                    <span class="token comment">// 11.5 å°è¯•ç§»é™¤è¿™äº›beançš„å®ä¾‹, å› ä¸ºè¿™äº›beanä¾èµ–çš„beanå·²ç»è¢«å¢å¼ºäº†, ä»–ä»¬ä¾èµ–çš„beanç›¸å½“äºè„æ•°æ®</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">removeSingletonIfCreatedForTypeCheckOnly</span><span class="token punctuation">(</span>dependentBean<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment">// 11.6 ç§»é™¤å¤±è´¥çš„beanæ·»åŠ åˆ°actualDependentBeans</span>
                        actualDependentBeans<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>dependentBean<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>

                <span class="token comment">// 11.7 å¦‚æœå­˜åœ¨ç§»é™¤å¤±è´¥çš„, åˆ™æŠ›å‡ºå¼‚å¸¸, å› ä¸ºå­˜åœ¨beanä¾èµ–äº†â€œè„æ•°æ®â€</span>
                <span class="token comment">// å› ä¸ºbeanåˆ›å»ºåå…¶æ‰€ä¾èµ–çš„beanä¸€å®šæ˜¯å·²ç»åˆ›å»ºçš„, actualDependentBeansä¸ä¸ºç©º</span>
                <span class="token comment">// åˆ™è¡¨ç¤ºå½“å‰beanåˆ›å»ºåå…¶ä¾èµ–çš„beanå´æ²¡æœ‰å…¨éƒ¨åˆ›å»ºå®Œ, è¯´æ˜å­˜åœ¨å¾ªç¯ä¾èµ–</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>actualDependentBeans<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">// æŠ›å‡ºå¾ªç¯ä¾èµ–å¼‚å¸¸</span>
                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BeanCurrentlyInCreationException</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span>
                                                               <span class="token string">&quot;Bean with name '&quot;</span> <span class="token operator">+</span> beanName <span class="token operator">+</span> <span class="token string">&quot;' has been injected into other beans [&quot;</span> <span class="token operator">+</span>
                                                               <span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">collectionToCommaDelimitedString</span><span class="token punctuation">(</span>actualDependentBeans<span class="token punctuation">)</span> <span class="token operator">+</span>
                                                               <span class="token string">&quot;] in its raw version as part of a circular reference, but has eventually been &quot;</span> <span class="token operator">+</span>
                                                               <span class="token string">&quot;wrapped. This means that said other beans do not use the final version of the &quot;</span> <span class="token operator">+</span>
                                                               <span class="token string">&quot;bean. This is often the result of over-eager type matching - consider using &quot;</span> <span class="token operator">+</span>
                                                               <span class="token string">&quot;'getBeanNamesForType' with the 'allowEagerInit' flag turned off, for example.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment">// 12.æ³¨å†Œç”¨äºé”€æ¯çš„DisposableBean, æ‰§è¡Œé”€æ¯æ“ä½œçš„æœ‰ä¸‰ç§: </span>
        <span class="token comment">// è‡ªå®šä¹‰destroyæ–¹æ³•, DisposableBeanæ¥å£, DestructionAwareBeanPostProcessor</span>
        <span class="token function">registerDisposableBeanIfNecessary</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> bean<span class="token punctuation">,</span> mbd<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">BeanDefinitionValidationException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BeanCreationException</span><span class="token punctuation">(</span>mbd<span class="token punctuation">.</span><span class="token function">getResourceDescription</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> beanName<span class="token punctuation">,</span> <span class="token string">&quot;Invalid destruction signature&quot;</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// å®Œæˆåˆ›å»ºå¹¶è¿”å›</span>
    <span class="token keyword">return</span> exposedObject<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br></div></div><p>æ³¨é‡Š 11.1 å¤„, earlySingletonReference åªæœ‰åœ¨å½“å‰è§£æçš„ bean <strong>å­˜åœ¨å¾ªç¯ä¾èµ–</strong>çš„æƒ…å†µä¸‹æ‰ä¼šä¸ä¸ºç©º. å› ä¸ºå¦‚æœä¸æ˜¯å¾ªç¯ä¾èµ–, åªä¼šåœ¨å®Œå…¨åˆ›å»ºå®Œ bean å®ä¾‹æ‰ä¼šæ·»åŠ åˆ° singletonObjects ç¼“å­˜. æ­¤æ—¶æ­£åœ¨åˆ›å»º bean çš„è¿‡ç¨‹ä¸­, è¿˜æ²¡æœ‰å®Œå…¨åˆ›å»ºå®Œ, singletonObjects ç¼“å­˜æ˜¯è‚¯å®šæ²¡æœ‰å½“å‰ beanName çš„; è€Œå¦‚æœä¸å­˜åœ¨å¾ªç¯å¼•ç”¨, ä» doGetBean() æ–¹æ³•å¼€å§‹, getSingleton() æ–¹æ³•åªä¼šåœ¨<strong>æœ€åˆ doGetBean æ–¹æ³•é‡Œè°ƒç”¨ä¸€æ¬¡</strong>, ä¸å­˜åœ¨å¾ªç¯å¼•ç”¨, ä¹Ÿå°±ç”¨ä¸åˆ°æå‰æ›å…‰çš„ ObjectFactory æ¥åˆ›å»º bean å¯¹è±¡, ä»è€Œ earlySingletonObjects ç¼“å­˜è‚¯å®šä¹Ÿæ˜¯æ²¡æœ‰ beanName çš„ bean å®ä¾‹å¯¹è±¡çš„, æ‰€ä»¥å¿…ç„¶è¿”å›ç©º.</p> <h4 id="createbeaninstance"><a href="#createbeaninstance" class="header-anchor">#</a> createBeanInstance()</h4> <p><strong>æ³¨é‡Š 3 å¤„</strong> createBeanInstance() æ–¹æ³•æ ¹æ® beanName, mbd, args, ä½¿ç”¨å¯¹åº”çš„ç­–ç•¥<strong>åˆ›å»º bean å®ä¾‹</strong>, å¹¶è¿”å›åŒ…è£…ç±» BeanWrapper. è¿™é‡Œåˆ›å»ºä¸€ä¸ªæ–°çš„ bean å®ä¾‹.</p> <blockquote><p>AbstractAutowireCapableBeanFactory::createBeanInstance()</p></blockquote> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">protected</span> <span class="token class-name">BeanWrapper</span> <span class="token function">createBeanInstance</span><span class="token punctuation">(</span><span class="token class-name">String</span> beanName<span class="token punctuation">,</span> <span class="token class-name">RootBeanDefinition</span> mbd<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// è§£æbeançš„ç±»å‹ä¿¡æ¯</span>
    <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> beanClass <span class="token operator">=</span> <span class="token function">resolveBeanClass</span><span class="token punctuation">(</span>mbd<span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// beanClassä¸ä¸ºç©º &amp;&amp; beanClassä¸æ˜¯å…¬å¼€ç±»(ä¸æ˜¯publicä¿®é¥°) &amp;&amp; è¯¥beanä¸å…è®¸è®¿é—®éå…¬å…±æ„é€ å‡½æ•°å’Œæ–¹æ³•, åˆ™æŠ›å¼‚å¸¸</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>beanClass <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token class-name">Modifier</span><span class="token punctuation">.</span><span class="token function">isPublic</span><span class="token punctuation">(</span>beanClass<span class="token punctuation">.</span><span class="token function">getModifiers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>mbd<span class="token punctuation">.</span><span class="token function">isNonPublicAccessAllowed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BeanCreationException</span><span class="token punctuation">(</span>mbd<span class="token punctuation">.</span><span class="token function">getResourceDescription</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> beanName<span class="token punctuation">,</span>
                                        <span class="token string">&quot;Bean class isn't public, and non-public access not allowed: &quot;</span> <span class="token operator">+</span> beanClass<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token class-name">Supplier</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> instanceSupplier <span class="token operator">=</span> mbd<span class="token punctuation">.</span><span class="token function">getInstanceSupplier</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>instanceSupplier <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">obtainFromSupplier</span><span class="token punctuation">(</span>instanceSupplier<span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 1.å¦‚æœå­˜åœ¨å·¥å‚æ–¹æ³•åˆ™ä½¿ç”¨å·¥å‚æ–¹æ³•å®ä¾‹åŒ–beanå¯¹è±¡</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>mbd<span class="token punctuation">.</span><span class="token function">getFactoryMethodName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// æ ¹æ®Bean Definitionä¸­çš„é…ç½®ç”Ÿæˆbeançš„å®ä¾‹</span>
        <span class="token keyword">return</span> <span class="token function">instantiateUsingFactoryMethod</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> mbd<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// resolved: æ„é€ å‡½æ•°æˆ–å·¥å‚æ–¹æ³•æ˜¯å¦å·²ç»è§£æè¿‡</span>
    <span class="token comment">// å¦‚æœä¸æ˜¯ç¬¬ä¸€æ¬¡åˆ›å»º, æ¯”å¦‚ç¬¬äºŒæ¬¡åˆ›å»º prototype bean. </span>
    <span class="token comment">// è¿™ç§æƒ…å†µä¸‹, å¯ä»¥ä»ç¬¬ä¸€æ¬¡åˆ›å»ºçŸ¥é“, é‡‡ç”¨æ— å‚æ„é€ å‡½æ•°è¿˜æ˜¯æ„é€ å‡½æ•°ä¾èµ–æ³¨å…¥ æ¥å®Œæˆå®ä¾‹åŒ–</span>
    <span class="token keyword">boolean</span> resolved <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token comment">// autowireNecessary: æ˜¯å¦éœ€è¦è‡ªåŠ¨æ³¨å…¥(å³æ˜¯å¦éœ€è¦è§£ææ„é€ å‡½æ•°å‚æ•°)</span>
    <span class="token keyword">boolean</span> autowireNecessary <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>args <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 2.åŠ é”</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mbd<span class="token punctuation">.</span>constructorArgumentLock<span class="token punctuation">)</span> <span class="token punctuation">{</span>

            <span class="token comment">// ä¸€ä¸ªç±»æœ‰å¤šä¸ªæ„é€ æ–¹æ³•, æ¯ä¸ªæ„é€ æ–¹æ³•éƒ½æœ‰ä¸åŒçš„å‚æ•°, æ‰€ä»¥è°ƒç”¨å‰éœ€è¦å…ˆæ ¹æ®å‚æ•°é”å®šæ„é€ æ–¹æ³•æˆ–å¯¹åº”çš„å·¥å‚æ–¹æ³•</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>mbd<span class="token punctuation">.</span>resolvedConstructorOrFactoryMethod <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// 2.1 å¦‚æœresolvedConstructorOrFactoryMethodç¼“å­˜ä¸ä¸ºç©º, åˆ™å°†resolvedæ ‡è®°ä¸ºå·²è§£æ</span>
                resolved <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                <span class="token comment">// 2.2 æ ¹æ®constructorArgumentsResolvedåˆ¤æ–­æ˜¯å¦éœ€è¦è‡ªåŠ¨æ³¨å…¥</span>
                autowireNecessary <span class="token operator">=</span> mbd<span class="token punctuation">.</span>constructorArgumentsResolved<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 3.å¦‚æœå·²ç»è§£æè¿‡, åˆ™ä½¿ç”¨resolvedConstructorOrFactoryMethodç¼“å­˜é‡Œè§£æå¥½çš„æ„é€ å‡½æ•°æ–¹æ³•</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>resolved<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>autowireNecessary<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 3.1 éœ€è¦è‡ªåŠ¨æ³¨å…¥, åˆ™æ‰§è¡Œæ„é€ å‡½æ•°è‡ªåŠ¨æ³¨å…¥</span>
            <span class="token keyword">return</span> <span class="token function">autowireConstructor</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> mbd<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment">// 3.2 å¦åˆ™ä½¿ç”¨é»˜è®¤çš„æ„é€ å‡½æ•°è¿›è¡Œbeançš„å®ä¾‹åŒ–</span>
            <span class="token keyword">return</span> <span class="token function">instantiateBean</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> mbd<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 4.åº”ç”¨åç½®å¤„ç†å™¨SmartInstantiationAwareBeanPostProcessor, æ‹¿åˆ°beançš„å€™é€‰æ„é€ å‡½æ•°</span>
    <span class="token class-name">Constructor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> ctors <span class="token operator">=</span> <span class="token function">determineConstructorsFromBeanPostProcessors</span><span class="token punctuation">(</span>beanClass<span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ctors <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">||</span> mbd<span class="token punctuation">.</span><span class="token function">getResolvedAutowireMode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token constant">AUTOWIRE_CONSTRUCTOR</span> <span class="token operator">||</span>
        mbd<span class="token punctuation">.</span><span class="token function">hasConstructorArgumentValues</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token operator">!</span><span class="token class-name">ObjectUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token comment">// 5.å¦‚æœctorsä¸ä¸ºç©º || mbdçš„æ³¨å…¥æ–¹å¼ä¸ºAUTOWIRE_CONSTRUCTOR || mdbå®šä¹‰äº†æ„é€ å‡½æ•°çš„å‚æ•°å€¼ || argsä¸ä¸ºç©º, </span>
        <span class="token comment">// åˆ™æ‰§è¡Œæ„é€ å‡½æ•°è‡ªåŠ¨æ³¨å…¥</span>
        <span class="token comment">// åœ¨å¸¦æœ‰å‚æ•°çš„å®ä¾‹æ„é€ ä¸­, SpringæŠŠç²¾åŠ›æ”¾åœ¨äº†æ„é€ æ–¹æ³•ä»¥åŠå‚æ•°çš„åŒ¹é…ä¸Š</span>
        <span class="token keyword">return</span> <span class="token function">autowireConstructor</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> mbd<span class="token punctuation">,</span> ctors<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 6.æ²¡æœ‰ç‰¹æ®Šå¤„ç†, åˆ™ä½¿ç”¨é»˜è®¤çš„æ„é€ å‡½æ•°è¿›è¡Œbeançš„å®ä¾‹åŒ–</span>
    <span class="token comment">// ä½¿ç”¨é»˜è®¤æ— å‚æ„é€ æ–¹æ³•åˆå§‹åŒ–, æ²¡æœ‰å‚æ•°çš„å®ä¾‹åŒ–å¾ˆç®€å•, åªéœ€è¦ç›´æ¥è°ƒç”¨å®ä¾‹åŒ–ç­–ç•¥è¿›è¡Œå®ä¾‹åŒ–å³å¯</span>
    <span class="token keyword">return</span> <span class="token function">instantiateBean</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> mbd<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br></div></div><p>åˆ›å»ºå®ä¾‹çš„æ–¹æ³•é€šå¸¸æœ‰ä»¥ä¸‹å‡ ç§: <strong>å·¥å‚æ–¹æ³•, æ„é€ å‡½æ•°è‡ªåŠ¨è£…é…(é€šå¸¸æŒ‡å¸¦æœ‰å‚æ•°çš„æ„é€ å‡½æ•°), ç®€å•å®ä¾‹åŒ–(é»˜è®¤çš„æ„é€ å‡½æ•°)</strong> . å…¶ä¸­å·¥å‚æ–¹æ³•ç°åœ¨åŸºæœ¬ä¸ä½¿ç”¨äº†, ä¸å†è§£æ; ç®€å•å®ä¾‹åŒ–è¿‡ç¨‹æ¯”è¾ƒç®€å•, ä¹Ÿä¸è§£æ; è¿™é‡Œåªå¯¹æ„é€ å‡½æ•°è‡ªåŠ¨è£…é…è¿›è¡Œè§£æ, è¯¥æ–¹æ³•å¯¹åº”ä»£ç ä¸­çš„æ³¨é‡Š: 3.1 å’Œ 5.</p> <h5 id="_1-determineconstructorsfrombeanpostprocessors"><a href="#_1-determineconstructorsfrombeanpostprocessors" class="header-anchor">#</a> 1.determineConstructorsFromBeanPostProcessors()</h5> <p>æ³¨é‡Š 4 å¤„ determineConstructorsFromBeanPostProcessors() æ–¹æ³•åº”ç”¨åç½®å¤„ç†å™¨ <strong>SmartInstantiationAwareBeanPostProcessor</strong>, æ‹¿åˆ°ç»™å®š bean çš„å€™é€‰æ„é€ å‡½æ•°, æ–¹æ³•å¦‚ä¸‹.</p> <blockquote><p>AbstractAutowireCapableBeanFactory::determineConstructorsFromBeanPostProcessors()</p></blockquote> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Nullable</span>
<span class="token keyword">protected</span> <span class="token class-name">Constructor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">determineConstructorsFromBeanPostProcessors</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Nullable</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> beanClass<span class="token punctuation">,</span> <span class="token class-name">String</span> beanName<span class="token punctuation">)</span>
    <span class="token keyword">throws</span> <span class="token class-name">BeansException</span> <span class="token punctuation">{</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>beanClass <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token function">hasInstantiationAwareBeanPostProcessors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 1.éå†æ‰€æœ‰çš„BeanPostProcessor</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">BeanPostProcessor</span> bp <span class="token operator">:</span> <span class="token function">getBeanPostProcessors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>bp <span class="token keyword">instanceof</span> <span class="token class-name">SmartInstantiationAwareBeanPostProcessor</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// 2.è°ƒç”¨SmartInstantiationAwareBeanPostProcessorçš„determineCandidateConstructorsæ–¹æ³•, </span>
                <span class="token comment">// è¯¥æ–¹æ³•å¯ä»¥è¿”å›è¦ç”¨äºbeanClassçš„å€™é€‰æ„é€ å‡½æ•°</span>
                <span class="token comment">// ä¾‹å¦‚: ä½¿ç”¨@Autowireæ³¨è§£ä¿®é¥°æ„é€ å‡½æ•°, åˆ™è¯¥æ„é€ å‡½æ•°åœ¨è¿™è¾¹ä¼šè¢«AutowiredAnnotationBeanPostProcessoræ‰¾åˆ°</span>
                <span class="token class-name">SmartInstantiationAwareBeanPostProcessor</span> ibp <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">SmartInstantiationAwareBeanPostProcessor</span><span class="token punctuation">)</span> bp<span class="token punctuation">;</span>
                <span class="token class-name">Constructor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> ctors <span class="token operator">=</span> ibp<span class="token punctuation">.</span><span class="token function">determineCandidateConstructors</span><span class="token punctuation">(</span>beanClass<span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>ctors <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">// 3.å¦‚æœctorsä¸ä¸ºç©º, åˆ™ä¸å†ç»§ç»­æ‰§è¡Œå…¶ä»–çš„SmartInstantiationAwareBeanPostProcessor</span>
                    <span class="token keyword">return</span> ctors<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><p>è¿™é‡Œè°ƒç”¨ SmartInstantiationAwareBeanPostProcessor çš„ <strong>determineCandidateConstructors()</strong>  æ–¹æ³•, è¯¥æ–¹æ³•å¯ä»¥è¿”å›è¦ç”¨äº <strong>beanClass çš„å€™é€‰æ„é€ å‡½æ•°</strong>. ä½¿ç”¨ @Autowire æ³¨è§£ä¿®é¥°æ„é€ å‡½æ•°, åˆ™è¯¥æ„é€ å‡½æ•°åœ¨è¿™è¾¹ä¼šè¢« AutowiredAnnotationBeanPostProcessor æ‰¾åˆ°.</p> <h5 id="_2-autowireconstructor"><a href="#_2-autowireconstructor" class="header-anchor">#</a> 2.autowireConstructor()</h5> <p>ç»§ç»­çœ‹ createBeanInstance() æ–¹æ³•çš„ <strong>autowireConstructor()</strong>  æ–¹æ³•. ååˆ†ç¦»è°±çš„æ–¹æ³•, ä¸å»ºè®®çœ‹.</p> <blockquote><p>AbstractAutowireCapableBeanFactory::autowireConstructor()</p></blockquote> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">BeanWrapper</span> <span class="token function">autowireConstructor</span><span class="token punctuation">(</span><span class="token class-name">String</span> beanName<span class="token punctuation">,</span> <span class="token class-name">RootBeanDefinition</span> mbd<span class="token punctuation">,</span>
                                       <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">Constructor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> chosenCtors<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> explicitArgs<span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token comment">// å®šä¹‰beanåŒ…è£…ç±»</span>
    <span class="token class-name">BeanWrapperImpl</span> bw <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BeanWrapperImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>beanFactory<span class="token punctuation">.</span><span class="token function">initBeanWrapper</span><span class="token punctuation">(</span>bw<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// æœ€ç»ˆç”¨äºå®ä¾‹åŒ–çš„æ„é€ å‡½æ•°</span>
    <span class="token class-name">Constructor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> constructorToUse <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token comment">// æœ€ç»ˆç”¨äºå®ä¾‹åŒ–çš„å‚æ•°Holder</span>
    <span class="token class-name">ArgumentsHolder</span> argsHolderToUse <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token comment">// æœ€ç»ˆç”¨äºå®ä¾‹åŒ–çš„æ„é€ å‡½æ•°å‚æ•°</span>
    <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> argsToUse <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

    <span class="token comment">// 1.è§£æå‡ºè¦ç”¨äºå®ä¾‹åŒ–çš„æ„é€ å‡½æ•°å‚æ•°</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>explicitArgs <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 1.1 å¦‚æœexplicitArgsä¸ä¸ºç©º, åˆ™æ„é€ å‡½æ•°çš„å‚æ•°ç›´æ¥ä½¿ç”¨explicitArgs</span>
        <span class="token comment">// é€šè¿‡getBeanæ–¹æ³•è°ƒç”¨æ—¶, æ˜¾ç¤ºæŒ‡å®šäº†å‚æ•°, åˆ™explicitArgså°±ä¸ä¸ºnull</span>
        argsToUse <span class="token operator">=</span> explicitArgs<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// 1.2 å°è¯•ä»ç¼“å­˜ä¸­è·å–å·²ç»è§£æè¿‡çš„æ„é€ å‡½æ•°å‚æ•°</span>
        <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> argsToResolve <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mbd<span class="token punctuation">.</span>constructorArgumentLock<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 1.2.1 æ‹¿åˆ°ç¼“å­˜ä¸­å·²è§£æçš„æ„é€ å‡½æ•°æˆ–å·¥å‚æ–¹æ³•</span>
            constructorToUse <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Constructor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span> mbd<span class="token punctuation">.</span>resolvedConstructorOrFactoryMethod<span class="token punctuation">;</span>
            <span class="token comment">// 1.2.2 å¦‚æœconstructorToUseä¸ä¸ºç©º &amp;&amp; mbdæ ‡è®°äº†æ„é€ å‡½æ•°å‚æ•°å·²è§£æ</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>constructorToUse <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> mbd<span class="token punctuation">.</span>constructorArgumentsResolved<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// 1.2.3 ä»ç¼“å­˜ä¸­è·å–å·²è§£æçš„æ„é€ å‡½æ•°å‚æ•°</span>
                argsToUse <span class="token operator">=</span> mbd<span class="token punctuation">.</span>resolvedConstructorArguments<span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>argsToUse <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">// 1.2.4 å¦‚æœresolvedConstructorArgumentsä¸ºç©º, åˆ™ä»ç¼“å­˜ä¸­è·å–å‡†å¤‡ç”¨äºè§£æçš„æ„é€ å‡½æ•°å‚æ•°, </span>
                    <span class="token comment">// constructorArgumentsResolvedä¸ºtrueæ—¶, resolvedConstructorArgumentså’Œ</span>
                    <span class="token comment">// preparedConstructorArgumentså¿…ç„¶æœ‰ä¸€ä¸ªç¼“å­˜äº†æ„é€ å‡½æ•°çš„å‚æ•°</span>
                    argsToResolve <span class="token operator">=</span> mbd<span class="token punctuation">.</span>preparedConstructorArguments<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>argsToResolve <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 1.2.5 å¦‚æœargsToResolveä¸ä¸ºç©º, åˆ™å¯¹æ„é€ å‡½æ•°å‚æ•°è¿›è¡Œè§£æ, </span>
            <span class="token comment">// å¦‚ç»™å®šæ–¹æ³•çš„æ„é€ å‡½æ•° A(int,int)åˆ™é€šè¿‡æ­¤æ–¹æ³•åå°±ä¼šæŠŠé…ç½®ä¸­çš„(&quot;1&quot;,&quot;1&quot;)è½¬æ¢ä¸º(1,1)</span>
            argsToUse <span class="token operator">=</span> <span class="token function">resolvePreparedArguments</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> mbd<span class="token punctuation">,</span> bw<span class="token punctuation">,</span> constructorToUse<span class="token punctuation">,</span> argsToResolve<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 2.å¦‚æœæ„é€ å‡½æ•°æ²¡æœ‰è¢«ç¼“å­˜, åˆ™é€šè¿‡é…ç½®æ–‡ä»¶è·å–</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>constructorToUse <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 2.1 æ£€æŸ¥æ˜¯å¦éœ€è¦è‡ªåŠ¨è£…é…: chosenCtorsä¸ä¸ºç©º || autowireModeä¸ºAUTOWIRE_CONSTRUCTOR</span>
        <span class="token comment">// ä¾‹å­: å½“chosenCtorsä¸ä¸ºç©ºæ—¶, ä»£è¡¨æœ‰æ„é€ å‡½æ•°é€šè¿‡@Autowireä¿®é¥°, å› æ­¤éœ€è¦è‡ªåŠ¨è£…é…</span>
        <span class="token keyword">boolean</span> autowiring <span class="token operator">=</span> <span class="token punctuation">(</span>chosenCtors <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">||</span>
                              mbd<span class="token punctuation">.</span><span class="token function">getResolvedAutowireMode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">AutowireCapableBeanFactory</span><span class="token punctuation">.</span><span class="token constant">AUTOWIRE_CONSTRUCTOR</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ConstructorArgumentValues</span> resolvedValues <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

        <span class="token comment">// æ„é€ å‡½æ•°å‚æ•°ä¸ªæ•°</span>
        <span class="token keyword">int</span> minNrOfArgs<span class="token punctuation">;</span>
        <span class="token comment">// 2.2 explicitArgsä¸ä¸ºç©º, åˆ™ä½¿ç”¨explicitArgsçš„lengthä½œä¸ºminNrOfArgsçš„å€¼</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>explicitArgs <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            minNrOfArgs <span class="token operator">=</span> explicitArgs<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment">// 2.3 è·å¾—mbdçš„æ„é€ å‡½æ•°çš„å‚æ•°å€¼(indexedArgumentValues: å¸¦indexçš„å‚æ•°å€¼; genericArgumentValues: é€šç”¨çš„å‚æ•°å€¼)</span>
            <span class="token class-name">ConstructorArgumentValues</span> cargs <span class="token operator">=</span> mbd<span class="token punctuation">.</span><span class="token function">getConstructorArgumentValues</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 2.4 åˆ›å»ºConstructorArgumentValueså¯¹è±¡resolvedValues, ç”¨äºæ‰¿è½½è§£æåçš„æ„é€ å‡½æ•°å‚æ•°çš„å€¼</span>
            resolvedValues <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConstructorArgumentValues</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 2.5 è§£æmbdçš„æ„é€ å‡½æ•°çš„å‚æ•°, å¹¶è¿”å›å‚æ•°ä¸ªæ•°</span>
            minNrOfArgs <span class="token operator">=</span> <span class="token function">resolveConstructorArguments</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> mbd<span class="token punctuation">,</span> bw<span class="token punctuation">,</span> cargs<span class="token punctuation">,</span> resolvedValues<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// æ³¨: è¿™è¾¹è§£æmbdä¸­çš„æ„é€ å‡½æ•°å‚æ•°å€¼, ä¸»è¦æ˜¯å¤„ç†é€šè¿‡XMLæ–¹å¼å®šä¹‰çš„æ„é€ å‡½æ•°æ³¨å…¥çš„å‚æ•°, </span>
            <span class="token comment">// ä½†æ˜¯å¦‚æœæ˜¯é€šè¿‡@Autowireæ³¨è§£ç›´æ¥ä¿®é¥°æ„é€ å‡½æ•°, åˆ™mbdæ˜¯æ²¡æœ‰è¿™äº›å‚æ•°å€¼çš„</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 3.ç¡®è®¤æ„é€ å‡½æ•°çš„å€™é€‰è€…</span>
        <span class="token comment">// 3.1 å¦‚æœå…¥å‚chosenCtorsä¸ä¸ºç©º, åˆ™å°†chosenCtorsçš„æ„é€ å‡½æ•°ä½œä¸ºå€™é€‰è€…</span>
        <span class="token class-name">Constructor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> candidates <span class="token operator">=</span> chosenCtors<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>candidates <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> beanClass <span class="token operator">=</span> mbd<span class="token punctuation">.</span><span class="token function">getBeanClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token comment">// 3.2 å¦‚æœå…¥å‚chosenCtorsä¸ºç©º, åˆ™è·å–beanClassçš„æ„é€ å‡½æ•°</span>
                <span class="token comment">// (mbdæ˜¯å¦å…è®¸è®¿é—®éå…¬å…±æ„é€ å‡½æ•°å’Œæ–¹æ³• ? æ‰€æœ‰å£°æ˜çš„æ„é€ å‡½æ•°: å…¬å…±æ„é€ å‡½æ•°)</span>
                candidates <span class="token operator">=</span> <span class="token punctuation">(</span>mbd<span class="token punctuation">.</span><span class="token function">isNonPublicAccessAllowed</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span>
                              beanClass<span class="token punctuation">.</span><span class="token function">getDeclaredConstructors</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> beanClass<span class="token punctuation">.</span><span class="token function">getConstructors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BeanCreationException</span><span class="token punctuation">(</span>mbd<span class="token punctuation">.</span><span class="token function">getResourceDescription</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> beanName<span class="token punctuation">,</span>
                                                <span class="token string">&quot;Resolution of declared constructors on bean Class [&quot;</span> <span class="token operator">+</span> beanClass<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span>
                                                <span class="token string">&quot;] from ClassLoader [&quot;</span> <span class="token operator">+</span> beanClass<span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;] failed&quot;</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 3.3 å¯¹ç»™å®šçš„æ„é€ å‡½æ•°æ’åº: å…ˆæŒ‰æ–¹æ³•ä¿®é¥°ç¬¦æ’åº: publicæ’épublicå‰é¢, å†æŒ‰æ„é€ å‡½æ•°å‚æ•°ä¸ªæ•°æ’åº: å‚æ•°å¤šçš„æ’å‰é¢</span>
        <span class="token class-name">AutowireUtils</span><span class="token punctuation">.</span><span class="token function">sortConstructors</span><span class="token punctuation">(</span>candidates<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// æœ€å°åŒ¹é…æƒé‡, æƒé‡è¶Šå°, è¶Šæ¥è¿‘è¦æ‰¾çš„ç›®æ ‡æ„é€ å‡½æ•°</span>
        <span class="token keyword">int</span> minTypeDiffWeight <span class="token operator">=</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token constant">MAX_VALUE</span><span class="token punctuation">;</span>
        <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Constructor</span><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> ambiguousConstructors <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token class-name">LinkedList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">UnsatisfiedDependencyException</span><span class="token punctuation">&gt;</span></span> causes <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

        <span class="token comment">// 4.éå†æ‰€æœ‰æ„é€ å‡½æ•°å€™é€‰è€…, æ‰¾å‡ºç¬¦åˆæ¡ä»¶çš„æ„é€ å‡½æ•°</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Constructor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> candidate <span class="token operator">:</span> candidates<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 4.1 æ‹¿åˆ°å½“å‰éå†çš„æ„é€ å‡½æ•°çš„å‚æ•°ç±»å‹æ•°ç»„</span>
            <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> paramTypes <span class="token operator">=</span> candidate<span class="token punctuation">.</span><span class="token function">getParameterTypes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// 4.2 å¦‚æœå·²ç»æ‰¾åˆ°æ»¡è¶³çš„æ„é€ å‡½æ•° &amp;&amp; ç›®æ ‡æ„é€ å‡½æ•°éœ€è¦çš„å‚æ•°ä¸ªæ•°å¤§äºå½“å‰éå†çš„æ„é€ å‡½æ•°çš„å‚æ•°ä¸ªæ•°åˆ™ç»ˆæ­¢, </span>
            <span class="token comment">// å› ä¸ºéå†çš„æ„é€ å‡½æ•°å·²ç»æ’è¿‡åº, åé¢ä¸ä¼šæœ‰æ›´åˆé€‚çš„å€™é€‰è€…äº†</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>constructorToUse <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> argsToUse<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> paramTypes<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// 4.3 å¦‚æœå½“å‰éå†åˆ°çš„æ„é€ å‡½æ•°çš„å‚æ•°ä¸ªæ•°å°äºæˆ‘ä»¬æ‰€éœ€çš„å‚æ•°ä¸ªæ•°, åˆ™ç›´æ¥è·³è¿‡è¯¥æ„é€ å‡½æ•°</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>paramTypes<span class="token punctuation">.</span>length <span class="token operator">&lt;</span> minNrOfArgs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token class-name">ArgumentsHolder</span> argsHolder<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>resolvedValues <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// å­˜åœ¨å‚æ•°åˆ™æ ¹æ®å‚æ•°å€¼æ¥åŒ¹é…å‚æ•°ç±»å‹</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token comment">// 4.4 resolvedValuesä¸ä¸ºç©º, </span>
                    <span class="token comment">// 4.4.1 è·å–å½“å‰éå†çš„æ„é€ å‡½æ•°çš„å‚æ•°åç§°</span>
                    <span class="token comment">// 4.4.1.1 è§£æä½¿ç”¨ConstructorPropertiesæ³¨è§£çš„æ„é€ å‡½æ•°å‚æ•°</span>
                    <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> paramNames <span class="token operator">=</span> <span class="token class-name">ConstructorPropertiesChecker</span><span class="token punctuation">.</span><span class="token function">evaluate</span><span class="token punctuation">(</span>candidate<span class="token punctuation">,</span> paramTypes<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>paramNames <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment">// 4.4.1.2 è·å–å‚æ•°åç§°è§£æå™¨</span>
                        <span class="token class-name">ParameterNameDiscoverer</span> pnd <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>beanFactory<span class="token punctuation">.</span><span class="token function">getParameterNameDiscoverer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>pnd <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token comment">// 4.4.1.3 ä½¿ç”¨å‚æ•°åç§°è§£æå™¨è·å–å½“å‰éå†çš„æ„é€ å‡½æ•°çš„å‚æ•°åç§°</span>
                            paramNames <span class="token operator">=</span> pnd<span class="token punctuation">.</span><span class="token function">getParameterNames</span><span class="token punctuation">(</span>candidate<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment">// 4.4.2 åˆ›å»ºä¸€ä¸ªå‚æ•°æ•°ç»„ä»¥è°ƒç”¨æ„é€ å‡½æ•°æˆ–å·¥å‚æ–¹æ³•, </span>
                    <span class="token comment">// ä¸»è¦æ˜¯é€šè¿‡å‚æ•°ç±»å‹å’Œå‚æ•°åè§£ææ„é€ å‡½æ•°æˆ–å·¥å‚æ–¹æ³•æ‰€éœ€çš„å‚æ•°(å¦‚æœå‚æ•°æ˜¯å…¶ä»–bean, åˆ™ä¼šè§£æä¾èµ–çš„bean)</span>
                    argsHolder <span class="token operator">=</span> <span class="token function">createArgumentArray</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> mbd<span class="token punctuation">,</span> resolvedValues<span class="token punctuation">,</span> bw<span class="token punctuation">,</span> paramTypes<span class="token punctuation">,</span> paramNames<span class="token punctuation">,</span>
                                                     <span class="token function">getUserDeclaredConstructor</span><span class="token punctuation">(</span>candidate<span class="token punctuation">)</span><span class="token punctuation">,</span> autowiring<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">UnsatisfiedDependencyException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">// 4.4.3 å‚æ•°åŒ¹é…å¤±è´¥, åˆ™æŠ›å‡ºå¼‚å¸¸</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isTraceEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        logger<span class="token punctuation">.</span><span class="token function">trace</span><span class="token punctuation">(</span><span class="token string">&quot;Ignoring constructor [&quot;</span> <span class="token operator">+</span> candidate <span class="token operator">+</span> <span class="token string">&quot;] of bean '&quot;</span> <span class="token operator">+</span> beanName <span class="token operator">+</span> <span class="token string">&quot;': &quot;</span> <span class="token operator">+</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment">// Swallow and try next constructor.</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>causes <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        causes <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    causes<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">continue</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment">// 4.5 resolvedValuesä¸ºç©º, åˆ™explicitArgsä¸ä¸ºç©º, å³ç»™å‡ºäº†æ˜¾å¼å‚æ•°</span>
                <span class="token comment">// 4.5.1 å¦‚æœå½“å‰éå†çš„æ„é€ å‡½æ•°å‚æ•°ä¸ªæ•°ä¸explicitArgsé•¿åº¦ä¸ç›¸åŒ, åˆ™è·³è¿‡è¯¥æ„é€ å‡½æ•°</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>paramTypes<span class="token punctuation">.</span>length <span class="token operator">!=</span> explicitArgs<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">continue</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment">// 4.5.2 ä½¿ç”¨æ˜¾å¼ç»™å‡ºçš„å‚æ•°æ„é€ ArgumentsHolder</span>
                argsHolder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArgumentsHolder</span><span class="token punctuation">(</span>explicitArgs<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment">// 4.6 æ ¹æ®mbdçš„è§£ææ„é€ å‡½æ•°æ¨¡å¼(true: å®½æ¾æ¨¡å¼(é»˜è®¤), false: ä¸¥æ ¼æ¨¡å¼), </span>
            <span class="token comment">// å°†argsHolderçš„å‚æ•°å’ŒparamTypesè¿›è¡Œæ¯”è¾ƒ, è®¡ç®—paramTypesçš„ç±»å‹å·®å¼‚æƒé‡å€¼</span>
            <span class="token keyword">int</span> typeDiffWeight <span class="token operator">=</span> <span class="token punctuation">(</span>mbd<span class="token punctuation">.</span><span class="token function">isLenientConstructorResolution</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span>
                                  argsHolder<span class="token punctuation">.</span><span class="token function">getTypeDifferenceWeight</span><span class="token punctuation">(</span>paramTypes<span class="token punctuation">)</span> <span class="token operator">:</span> argsHolder<span class="token punctuation">.</span><span class="token function">getAssignabilityWeight</span><span class="token punctuation">(</span>paramTypes<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 4.7 ç±»å‹å·®å¼‚æƒé‡å€¼è¶Šå°,åˆ™è¯´æ˜æ„é€ å‡½æ•°è¶ŠåŒ¹é…, åˆ™é€‰æ‹©æ­¤æ„é€ å‡½æ•°</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>typeDiffWeight <span class="token operator">&lt;</span> minTypeDiffWeight<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// å°†è¦ä½¿ç”¨çš„å‚æ•°éƒ½æ›¿æ¢æˆå·®å¼‚æƒé‡å€¼æ›´å°çš„</span>
                constructorToUse <span class="token operator">=</span> candidate<span class="token punctuation">;</span>
                argsHolderToUse <span class="token operator">=</span> argsHolder<span class="token punctuation">;</span>
                argsToUse <span class="token operator">=</span> argsHolder<span class="token punctuation">.</span>arguments<span class="token punctuation">;</span>
                minTypeDiffWeight <span class="token operator">=</span> typeDiffWeight<span class="token punctuation">;</span>
                <span class="token comment">// å¦‚æœå‡ºç°æƒé‡å€¼æ›´å°çš„å€™é€‰è€…, åˆ™å°†ambiguousConstructorsæ¸…ç©º, å…è®¸ä¹‹å‰å­˜åœ¨æƒé‡å€¼ç›¸åŒçš„å€™é€‰è€…</span>
                ambiguousConstructors <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// 4.8 å¦‚æœå­˜åœ¨ä¸¤ä¸ªå€™é€‰è€…çš„æƒé‡å€¼ç›¸åŒ, å¹¶ä¸”æ˜¯å½“å‰éå†è¿‡æƒé‡å€¼æœ€å°çš„</span>
            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>constructorToUse <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> typeDiffWeight <span class="token generics"><span class="token punctuation">&lt;</span>mark<span class="token punctuation">&gt;</span></span> minTypeDiffWeight<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// å°†è¿™ä¸¤ä¸ªå€™é€‰è€…éƒ½æ·»åŠ åˆ°ambiguousConstructors</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>ambiguousConstructors <span class="token operator">&lt;</span><span class="token operator">/</span>mark<span class="token operator">&gt;</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    ambiguousConstructors <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedHashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    ambiguousConstructors<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>constructorToUse<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                ambiguousConstructors<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>candidate<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>constructorToUse <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 5.å¦‚æœæœ€ç»ˆæ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„æ„é€ å‡½æ•°, åˆ™è¿›è¡Œå¼‚å¸¸å¤„ç†</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>causes <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">UnsatisfiedDependencyException</span> ex <span class="token operator">=</span> causes<span class="token punctuation">.</span><span class="token function">removeLast</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> cause <span class="token operator">:</span> causes<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">this</span><span class="token punctuation">.</span>beanFactory<span class="token punctuation">.</span><span class="token function">onSuppressedException</span><span class="token punctuation">(</span>cause<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">throw</span> ex<span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BeanCreationException</span><span class="token punctuation">(</span>mbd<span class="token punctuation">.</span><span class="token function">getResourceDescription</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> beanName<span class="token punctuation">,</span>
                                             <span class="token string">&quot;Could not resolve matching constructor &quot;</span> <span class="token operator">+</span>
                                             <span class="token string">&quot;(hint: specify index/type/name arguments for simple parameters to avoid type ambiguities)&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 6.å¦‚æœæ‰¾åˆ°äº†åŒ¹é…çš„æ„é€ å‡½æ•°, ä½†æ˜¯å­˜åœ¨å¤šä¸ª(ambiguousConstructorsä¸ä¸ºç©º) &amp;&amp; è§£ææ„é€ å‡½æ•°çš„æ¨¡å¼ä¸ºä¸¥æ ¼æ¨¡å¼, åˆ™æŠ›å‡ºå¼‚å¸¸</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>ambiguousConstructors <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>mbd<span class="token punctuation">.</span><span class="token function">isLenientConstructorResolution</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BeanCreationException</span><span class="token punctuation">(</span>mbd<span class="token punctuation">.</span><span class="token function">getResourceDescription</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> beanName<span class="token punctuation">,</span>
                                            <span class="token string">&quot;Ambiguous constructor matches found in bean '&quot;</span> <span class="token operator">+</span> beanName <span class="token operator">+</span> <span class="token string">&quot;' &quot;</span> <span class="token operator">+</span>
                                            <span class="token string">&quot;(hint: specify index/type/name arguments for simple parameters to avoid type ambiguities): &quot;</span> <span class="token operator">+</span>
                                            ambiguousConstructors<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>explicitArgs <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 7.å°†è§£æçš„æ„é€ å‡½æ•°å’Œå‚æ•°æ”¾åˆ°ç¼“å­˜</span>
            argsHolderToUse<span class="token punctuation">.</span><span class="token function">storeCache</span><span class="token punctuation">(</span>mbd<span class="token punctuation">,</span> constructorToUse<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token keyword">final</span> <span class="token class-name">InstantiationStrategy</span> strategy <span class="token operator">=</span> beanFactory<span class="token punctuation">.</span><span class="token function">getInstantiationStrategy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Object</span> beanInstance<span class="token punctuation">;</span>

        <span class="token comment">// 8.æ ¹æ®å®ä¾‹åŒ–ç­–ç•¥ä»¥åŠå¾—åˆ°çš„æ„é€ å‡½æ•°åŠæ„é€ å‡½æ•°å‚æ•°å®ä¾‹åŒ–bean</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">getSecurityManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">final</span> <span class="token class-name">Constructor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> ctorToUse <span class="token operator">=</span> constructorToUse<span class="token punctuation">;</span>
            <span class="token keyword">final</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> argumentsToUse <span class="token operator">=</span> argsToUse<span class="token punctuation">;</span>
            beanInstance <span class="token operator">=</span> <span class="token class-name">AccessController</span><span class="token punctuation">.</span><span class="token function">doPrivileged</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">PrivilegedAction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span>
                                                         strategy<span class="token punctuation">.</span><span class="token function">instantiate</span><span class="token punctuation">(</span>mbd<span class="token punctuation">,</span> beanName<span class="token punctuation">,</span> beanFactory<span class="token punctuation">,</span> ctorToUse<span class="token punctuation">,</span> argumentsToUse<span class="token punctuation">)</span><span class="token punctuation">,</span>
                                                         beanFactory<span class="token punctuation">.</span><span class="token function">getAccessControlContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span> <span class="token punctuation">{</span>
            beanInstance <span class="token operator">=</span> strategy<span class="token punctuation">.</span><span class="token function">instantiate</span><span class="token punctuation">(</span>mbd<span class="token punctuation">,</span> beanName<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>beanFactory<span class="token punctuation">,</span> constructorToUse<span class="token punctuation">,</span> argsToUse<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 9.å°†æ„é€ çš„å®ä¾‹åŠ å…¥BeanWrapperä¸­, å¹¶è¿”å›</span>
        bw<span class="token punctuation">.</span><span class="token function">setBeanInstance</span><span class="token punctuation">(</span>beanInstance<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> bw<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BeanCreationException</span><span class="token punctuation">(</span>mbd<span class="token punctuation">.</span><span class="token function">getResourceDescription</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> beanName<span class="token punctuation">,</span>
                                        <span class="token string">&quot;Bean instantiation via constructor failed&quot;</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br><span class="line-number">165</span><br><span class="line-number">166</span><br><span class="line-number">167</span><br><span class="line-number">168</span><br><span class="line-number">169</span><br><span class="line-number">170</span><br><span class="line-number">171</span><br><span class="line-number">172</span><br><span class="line-number">173</span><br><span class="line-number">174</span><br><span class="line-number">175</span><br><span class="line-number">176</span><br><span class="line-number">177</span><br><span class="line-number">178</span><br><span class="line-number">179</span><br><span class="line-number">180</span><br><span class="line-number">181</span><br><span class="line-number">182</span><br><span class="line-number">183</span><br><span class="line-number">184</span><br><span class="line-number">185</span><br><span class="line-number">186</span><br><span class="line-number">187</span><br><span class="line-number">188</span><br><span class="line-number">189</span><br><span class="line-number">190</span><br><span class="line-number">191</span><br><span class="line-number">192</span><br><span class="line-number">193</span><br><span class="line-number">194</span><br><span class="line-number">195</span><br><span class="line-number">196</span><br><span class="line-number">197</span><br><span class="line-number">198</span><br><span class="line-number">199</span><br><span class="line-number">200</span><br><span class="line-number">201</span><br><span class="line-number">202</span><br><span class="line-number">203</span><br><span class="line-number">204</span><br><span class="line-number">205</span><br><span class="line-number">206</span><br><span class="line-number">207</span><br><span class="line-number">208</span><br><span class="line-number">209</span><br><span class="line-number">210</span><br><span class="line-number">211</span><br><span class="line-number">212</span><br><span class="line-number">213</span><br><span class="line-number">214</span><br><span class="line-number">215</span><br><span class="line-number">216</span><br><span class="line-number">217</span><br><span class="line-number">218</span><br><span class="line-number">219</span><br><span class="line-number">220</span><br><span class="line-number">221</span><br><span class="line-number">222</span><br><span class="line-number">223</span><br></div></div><p>è¿™ä¸ªæ–¹æ³•è¦æ·±æŒ–çš„è¯è¿˜æœ‰å¾ˆå¤š, å…·ä½“å¯ä»¥å‚è€ƒ:</p> <ul><li><a href="https://blog.csdn.net/v123411739/article/details/87994934" target="_blank" rel="noopener noreferrer">https://blog.csdn.net/v123411739/article/details/87994934<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul> <h4 id="applymergedbeandefinitionpostprocessors"><a href="#applymergedbeandefinitionpostprocessors" class="header-anchor">#</a> applyMergedBeanDefinitionPostProcessors()</h4> <p>ä¸Šé¢çš„æ–¹æ³•åˆ›å»ºä¸€ä¸ª<strong>æ–°çš„ bean å®ä¾‹</strong>. æ¥ç€åˆ†æåˆ›å»º bean å®ä¾‹ä¸­å‰©ä¸‹çš„: <strong>å¡«å……å±æ€§, bean å®ä¾‹åˆå§‹åŒ–</strong>ç­‰å†…å®¹.</p> <p>ä¸‹é¢çœ‹çœ‹ applyMergedBeanDefinitionPostProcessors() æ–¹æ³•. åº”ç”¨åç½®å¤„ç†å™¨ MergedBeanDefinitionPostProcessor, å…è®¸ä¿®æ”¹ MergedBeanDefinition,  <strong>@Autowired æ³¨è§£</strong>æ­£æ˜¯é€šè¿‡æ­¤æ–¹æ³•å®ç°æ³¨å…¥ç±»å‹çš„é¢„è§£æ.</p> <blockquote><p>AbstractAutowireCapableBeanFactory::applyMergedBeanDefinitionPostProcessors()</p></blockquote> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">applyMergedBeanDefinitionPostProcessors</span><span class="token punctuation">(</span><span class="token class-name">RootBeanDefinition</span> mbd<span class="token punctuation">,</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> beanType<span class="token punctuation">,</span> <span class="token class-name">String</span> beanName<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 1.è·å–BeanFactoryä¸­å·²æ³¨å†Œçš„BeanPostProcessor</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">BeanPostProcessor</span> bp <span class="token operator">:</span> <span class="token function">getBeanPostProcessors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>bp <span class="token keyword">instanceof</span> <span class="token class-name">MergedBeanDefinitionPostProcessor</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 2.è°ƒç”¨MergedBeanDefinitionPostProcessorçš„postProcessMergedBeanDefinitionæ–¹æ³•, </span>
            <span class="token comment">// å¯¹æŒ‡å®šbeançš„ç»™å®šMergedBeanDefinitionè¿›è¡Œåç½®å¤„ç†, @Autowireæ³¨è§£åœ¨è¿™è¾¹å¯¹å…ƒæ•°æ®è¿›è¡Œé¢„è§£æ</span>
            <span class="token class-name">MergedBeanDefinitionPostProcessor</span> bdp <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">MergedBeanDefinitionPostProcessor</span><span class="token punctuation">)</span> bp<span class="token punctuation">;</span>
            bdp<span class="token punctuation">.</span><span class="token function">postProcessMergedBeanDefinition</span><span class="token punctuation">(</span>mbd<span class="token punctuation">,</span> beanType<span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h4 id="getearlybeanreference"><a href="#getearlybeanreference" class="header-anchor">#</a> getEarlyBeanReference()</h4> <p>è¿™é‡Œåº”ç”¨åç½®å¤„ç†å™¨ <strong>SmartInstantiationAwareBeanPostProcessor</strong>, å…è®¸è¿”å›æŒ‡å®š bean çš„æ—©æœŸå¼•ç”¨. è¿™ä¸€æ­¥å°±æ˜¯è¿”å›å°† Bean åŒ…è£…èµ·æ¥çš„ <strong>ObjectFactory</strong>. é€šè¿‡è¿™ä¸ª ObjectFactory çš„ <strong>getObject() æ–¹æ³•</strong>å¯ä»¥è·å–åˆ°è¯¥ bean çš„ä¸€ä¸ªæ—©æœŸå®ä¾‹.</p> <blockquote><p>AbstractAutowireCapableBeanFactory::getEarlyBeanReference()</p></blockquote> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">protected</span> <span class="token class-name">Object</span> <span class="token function">getEarlyBeanReference</span><span class="token punctuation">(</span><span class="token class-name">String</span> beanName<span class="token punctuation">,</span> <span class="token class-name">RootBeanDefinition</span> mbd<span class="token punctuation">,</span> <span class="token class-name">Object</span> bean<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Object</span> exposedObject <span class="token operator">=</span> bean<span class="token punctuation">;</span>

    <span class="token comment">// 1.å¦‚æœmbdä¸æ˜¯åˆæˆ &amp;&amp; å­˜åœ¨InstantiationAwareBeanPostProcessors</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mbd<span class="token punctuation">.</span><span class="token function">isSynthetic</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">hasInstantiationAwareBeanPostProcessors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">BeanPostProcessor</span> bp <span class="token operator">:</span> <span class="token function">getBeanPostProcessors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 2.åº”ç”¨æ‰€æœ‰SmartInstantiationAwareBeanPostProcessor, è°ƒç”¨getEarlyBeanReferenceæ–¹æ³•</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>bp <span class="token keyword">instanceof</span> <span class="token class-name">SmartInstantiationAwareBeanPostProcessor</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">SmartInstantiationAwareBeanPostProcessor</span> ibp <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">SmartInstantiationAwareBeanPostProcessor</span><span class="token punctuation">)</span> bp<span class="token punctuation">;</span>
                <span class="token comment">// 3.å…è®¸SmartInstantiationAwareBeanPostProcessorè¿”å›æŒ‡å®šbeançš„æ—©æœŸå¼•ç”¨</span>
                exposedObject <span class="token operator">=</span> ibp<span class="token punctuation">.</span><span class="token function">getEarlyBeanReference</span><span class="token punctuation">(</span>exposedObject<span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 4.è¿”å›è¦ä½œä¸ºbeanå¼•ç”¨å…¬å¼€çš„å¯¹è±¡, å¦‚æœæ²¡æœ‰SmartInstantiationAwareBeanPostProcessorä¿®æ”¹, </span>
    <span class="token comment">// åˆ™è¿”å›çš„æ˜¯å…¥å‚çš„beanå¯¹è±¡æœ¬èº«</span>
    <span class="token keyword">return</span> exposedObject<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><h4 id="addsingletonfactory"><a href="#addsingletonfactory" class="header-anchor">#</a> addSingletonFactory()</h4> <p><strong>addSingletonFactory()</strong>  æ–¹æ³•<strong>æå‰æ›å…‰ beanName çš„ ObjectFactory</strong>, ç”¨äº<strong>è§£å†³å¾ªç¯ä¾èµ–</strong>. è¿™é‡Œæ˜¯å°† bean çš„ ObjectFactory æ”¾åˆ°<strong>ç¬¬ä¸‰çº§ç¼“å­˜</strong> <strong>singletonFactories</strong> ä¸­, åé¢å°±å¯ä»¥ç”¨ ObjectFactory çš„ <strong>getObject() æ–¹æ³•</strong> ç”Ÿæˆæ—©æœŸå¯¹è±¡äº†.</p> <blockquote><p>DefaultSingletonBeanRegistry::addSingletonFactory()</p></blockquote> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">addSingletonFactory</span><span class="token punctuation">(</span><span class="token class-name">String</span> beanName<span class="token punctuation">,</span> <span class="token class-name">ObjectFactory</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> singletonFactory<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">notNull</span><span class="token punctuation">(</span>singletonFactory<span class="token punctuation">,</span> <span class="token string">&quot;Singleton factory must not be null&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>singletonObjects<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 1.å¦‚æœbeanNameä¸å­˜åœ¨äºsingletonObjectsç¼“å­˜ä¸­</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>singletonObjects<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 2.å°†beanNameå’ŒsingletonFactoryæ³¨å†Œåˆ°singletonFactoriesç¼“å­˜</span>
            <span class="token comment">// (beanName -&gt; è¯¥beanNameçš„å•ä¾‹å·¥å‚)</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>singletonFactories<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> singletonFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 3.ç§»é™¤earlySingletonObjectsç¼“å­˜ä¸­çš„beanName(beanName -&gt; beanNameçš„æ—©æœŸå•ä¾‹å¯¹è±¡)</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>earlySingletonObjects<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 4.å°†beanNameæ³¨å†Œåˆ°registeredSingletonsç¼“å­˜(å·²ç»æ³¨å†Œçš„å•ä¾‹é›†åˆ)</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>registeredSingletons<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>è§£å†³å¾ªç¯ä¾èµ–çš„é—®é¢˜æ˜¯è¿‡æå‰æ›å…‰çš„ <strong>ObjectFactory è·å¾— &quot;ä¸å®Œæ•´&quot; çš„ bean å®ä¾‹</strong>è€Œå®ç°çš„, ObjectFactory å°±æ˜¯é€šè¿‡è¿™è¾¹çš„ <strong>singletonObjects ç¼“å­˜</strong>æ¥è¿›è¡Œæ›å…‰çš„.</p> <h4 id="populatebean"><a href="#populatebean" class="header-anchor">#</a> populateBean()</h4> <p>populateBean() æ–¹æ³•å¯¹ bean è¿›è¡Œ<strong>å±æ€§å¡«å……</strong>. å¦‚æœå­˜åœ¨ä¾èµ–äºå…¶ä»– bean çš„å±æ€§, åˆ™ä¼š<strong>é€’å½’åˆå§‹åŒ–ä¾èµ–çš„ bean å®ä¾‹</strong>.</p> <blockquote><p>AbstractAutowireCapableBeanFactory::populateBean()</p></blockquote> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">populateBean</span><span class="token punctuation">(</span><span class="token class-name">String</span> beanName<span class="token punctuation">,</span> <span class="token class-name">RootBeanDefinition</span> mbd<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">BeanWrapper</span> bw<span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token comment">// 1.bwä¸ºç©ºæ—¶çš„å¤„ç†</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>bw <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mbd<span class="token punctuation">.</span><span class="token function">hasPropertyValues</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 1.1 å¦‚æœbwä¸ºç©º, å±æ€§ä¸ä¸ºç©º, æŠ›å¼‚å¸¸, æ— æ³•å°†å±æ€§å€¼åº”ç”¨äºnullå®ä¾‹</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BeanCreationException</span><span class="token punctuation">(</span>
                mbd<span class="token punctuation">.</span><span class="token function">getResourceDescription</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> beanName<span class="token punctuation">,</span> <span class="token string">&quot;Cannot apply property values to null instance&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment">// 2 å¦‚æœbwä¸ºç©º, å±æ€§ä¹Ÿä¸ºç©º, åˆ™è·³è¿‡(æ²¡æœ‰å¯å¡«å……çš„å±æ€§)</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 3.1 å¦‚æœmbdä¸æ˜¯åˆæˆçš„ &amp;&amp; å­˜åœ¨InstantiationAwareBeanPostProcessor, </span>
    <span class="token comment">// åˆ™éå†å¤„ç†InstantiationAwareBeanPostProcessor</span>
    <span class="token comment">// ç»™InstantiationAwareBeanPostProcessoræœ€åä¸€æ¬¡æœºä¼šåœ¨å±æ€§è®¾ç½®å‰æ”¹å˜bean</span>
    <span class="token comment">// åˆ°è¿™æ­¥çš„æ—¶å€™, beanå®ä¾‹åŒ–å®Œæˆ(é€šè¿‡å·¥å‚æ–¹æ³•æˆ–æ„é€ æ–¹æ³•), ä½†æ˜¯è¿˜æ²¡å¼€å§‹å±æ€§è®¾å€¼, </span>
    <span class="token comment">// InstantiationAwareBeanPostProcessorçš„å®ç°ç±»å¯ä»¥åœ¨è¿™é‡Œå¯¹beanè¿›è¡ŒçŠ¶æ€ä¿®æ”¹</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mbd<span class="token punctuation">.</span><span class="token function">isSynthetic</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">hasInstantiationAwareBeanPostProcessors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">BeanPostProcessor</span> bp <span class="token operator">:</span> <span class="token function">getBeanPostProcessors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>bp <span class="token keyword">instanceof</span> <span class="token class-name">InstantiationAwareBeanPostProcessor</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">InstantiationAwareBeanPostProcessor</span> ibp <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">InstantiationAwareBeanPostProcessor</span><span class="token punctuation">)</span> bp<span class="token punctuation">;</span>
                <span class="token comment">// 3.2 åœ¨beanå®ä¾‹åŒ–å, å±æ€§å¡«å……ä¹‹å‰è¢«è°ƒç”¨, å…è®¸ä¿®æ”¹beançš„å±æ€§, å¦‚æœè¿”å›false, åˆ™è·³è¿‡ä¹‹åçš„å±æ€§å¡«å……</span>
                <span class="token comment">// ä¹Ÿä¸éœ€è¦å†ç»è¿‡å…¶ä»–çš„ BeanPostProcessor çš„å¤„ç†</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ibp<span class="token punctuation">.</span><span class="token function">postProcessAfterInstantiation</span><span class="token punctuation">(</span>bw<span class="token punctuation">.</span><span class="token function">getWrappedInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// beanå®ä¾‹çš„æ‰€æœ‰å±æ€§éƒ½åœ¨è¿™é‡Œäº†</span>
    <span class="token class-name">PropertyValues</span> pvs <span class="token operator">=</span> <span class="token punctuation">(</span>mbd<span class="token punctuation">.</span><span class="token function">hasPropertyValues</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span> mbd<span class="token punctuation">.</span><span class="token function">getPropertyValues</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 4.è§£æè‡ªåŠ¨è£…é…æ¨¡å¼ä¸ºAUTOWIRE_BY_NAMEå’ŒAUTOWIRE_BY_TYPE(ç°åœ¨å‡ ä¹ä¸ç”¨)</span>
    <span class="token keyword">int</span> resolvedAutowireMode <span class="token operator">=</span> mbd<span class="token punctuation">.</span><span class="token function">getResolvedAutowireMode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>resolvedAutowireMode <span class="token generics"><span class="token punctuation">&lt;</span>mark<span class="token punctuation">&gt;</span></span> <span class="token constant">AUTOWIRE_BY_NAME</span> <span class="token operator">||</span> resolvedAutowireMode <span class="token operator">&lt;</span><span class="token operator">/</span>mark<span class="token operator">&gt;</span> <span class="token constant">AUTOWIRE_BY_TYPE</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">MutablePropertyValues</span> newPvs <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MutablePropertyValues</span><span class="token punctuation">(</span>pvs<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// æ ¹æ®åç§°è‡ªåŠ¨æ³¨å…¥,é€šè¿‡åå­—æ‰¾åˆ°æ‰€æœ‰å±æ€§å€¼, å¦‚æœæ˜¯beanä¾èµ–, å…ˆåˆå§‹åŒ–ä¾èµ–çš„bean</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>resolvedAutowireMode <span class="token generics"><span class="token punctuation">&lt;</span>mark<span class="token punctuation">&gt;</span></span> <span class="token constant">AUTOWIRE_BY_NAME</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">autowireByName</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> mbd<span class="token punctuation">,</span> bw<span class="token punctuation">,</span> newPvs<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">// 4.1 è§£æautowireByNameçš„æ³¨å…¥</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// æ ¹æ®ç±»å‹è‡ªåŠ¨æ³¨å…¥,å¤æ‚ä¸€äº›</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>resolvedAutowireMode <span class="token operator">&lt;</span><span class="token operator">/</span>mark<span class="token operator">&gt;</span> <span class="token constant">AUTOWIRE_BY_TYPE</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">autowireByType</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> mbd<span class="token punctuation">,</span> bw<span class="token punctuation">,</span> newPvs<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">// 4.2 è§£æautowireByTypeçš„æ³¨å…¥</span>
        <span class="token punctuation">}</span>
        pvs <span class="token operator">=</span> newPvs<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 5.BeanFactoryæ˜¯å¦æ³¨å†Œè¿‡InstantiationAwareBeanPostProcessors</span>
    <span class="token keyword">boolean</span> hasInstAwareBpps <span class="token operator">=</span> <span class="token function">hasInstantiationAwareBeanPostProcessors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 6.æ˜¯å¦éœ€è¦ä¾èµ–æ£€æŸ¥</span>
    <span class="token keyword">boolean</span> needsDepCheck <span class="token operator">=</span> <span class="token punctuation">(</span>mbd<span class="token punctuation">.</span><span class="token function">getDependencyCheck</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token class-name">AbstractBeanDefinition</span><span class="token punctuation">.</span><span class="token constant">DEPENDENCY_CHECK_NONE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 7.æ³¨å†Œè¿‡InstantiationAwareBeanPostProcessors æˆ–è€… éœ€è¦ä¾èµ–æ£€æŸ¥</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>hasInstAwareBpps <span class="token operator">||</span> needsDepCheck<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>pvs <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            pvs <span class="token operator">=</span> mbd<span class="token punctuation">.</span><span class="token function">getPropertyValues</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">PropertyDescriptor</span><span class="token punctuation">[</span><span class="token punctuation">]</span> filteredPds <span class="token operator">=</span> <span class="token function">filterPropertyDescriptorsForDependencyCheck</span><span class="token punctuation">(</span>bw<span class="token punctuation">,</span> mbd<span class="token punctuation">.</span>allowCaching<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>hasInstAwareBpps<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 7.1 åº”ç”¨åç½®å¤„ç†å™¨InstantiationAwareBeanPostProcessor</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">BeanPostProcessor</span> bp <span class="token operator">:</span> <span class="token function">getBeanPostProcessors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>bp <span class="token keyword">instanceof</span> <span class="token class-name">InstantiationAwareBeanPostProcessor</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token class-name">InstantiationAwareBeanPostProcessor</span> ibp <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">InstantiationAwareBeanPostProcessor</span><span class="token punctuation">)</span> bp<span class="token punctuation">;</span>
                    <span class="token comment">// 7.1.1 åº”ç”¨åç½®å¤„ç†å™¨InstantiationAwareBeanPostProcessorçš„æ–¹æ³•postProcessPropertyValues, </span>
                    <span class="token comment">// è¿›è¡Œå±æ€§å¡«å……å‰çš„å†æ¬¡å¤„ç†. ä¾‹å­: ç°åœ¨æœ€å¸¸ç”¨çš„@Autowireå±æ€§æ³¨å…¥å°±æ˜¯è¿™è¾¹æ³¨å…¥ä¾èµ–çš„beanå®ä¾‹å¯¹è±¡</span>
                    <span class="token comment">// å¯¹æ‰€æœ‰éœ€è¦ä¾èµ–æ£€æŸ¥çš„å±æ€§è¿›è¡Œåå¤„ç†</span>
                    <span class="token comment">// è¿™é‡Œæœ‰ä¸ªéå¸¸æœ‰ç”¨çš„ BeanPostProcessor è¿›åˆ°è¿™é‡Œ: AutowiredAnnotationBeanPostProcessor</span>
                    <span class="token comment">// å¯¹é‡‡ç”¨ @Autowired, @Value æ³¨è§£çš„ä¾èµ–è¿›è¡Œè®¾å€¼, è¿™é‡Œçš„å†…å®¹ä¹Ÿæ˜¯éå¸¸ä¸°å¯Œçš„, ä¸å±•å¼€äº†</span>
                    pvs <span class="token operator">=</span> ibp<span class="token punctuation">.</span><span class="token function">postProcessPropertyValues</span><span class="token punctuation">(</span>pvs<span class="token punctuation">,</span> filteredPds<span class="token punctuation">,</span> bw<span class="token punctuation">.</span><span class="token function">getWrappedInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>pvs <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">return</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 7.2 ä¾èµ–æ£€æŸ¥, å¯¹åº”depends-onå±æ€§</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>needsDepCheck<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">checkDependencies</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> mbd<span class="token punctuation">,</span> filteredPds<span class="token punctuation">,</span> pvs<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 8.å°†æ‰€æœ‰PropertyValuesä¸­çš„å±æ€§å¡«å……åˆ°beanä¸­</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>pvs <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">applyPropertyValues</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> mbd<span class="token punctuation">,</span> bw<span class="token punctuation">,</span> pvs<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br></div></div><p>æ³¨é‡Š 4 å¤„, æ ¹æ®æ³¨å…¥ç±»å‹è®¾ç½®å±æ€§. å¦‚æœæ˜¯ AUTOWIRE_BY_NAME å³æ ¹æ®åç§°å¯»æ‰¾, æ­¤æ—¶æ²¡åšä»€ä¹ˆæ“ä½œ, ç›´æ¥é€šè¿‡åç§°æŸ¥æ‰¾. å¦‚æœæ˜¯ AUTOWIRE_BY_TYPE åŠæ ¹æ®ç±»å‹å¯»æ‰¾, æ­¤æ—¶ä¼šå»æ¨æ–­åŒ¹é… @Primary å’Œ @Priority ç­‰æ³¨è§£çš„å®ä¾‹.</p> <p>è¿™é‡Œæ³¨é‡Š 7.1.1 åº”ç”¨åç½®å¤„ç†å™¨ <strong>InstantiationAwareBeanPostProcessor</strong> çš„æ–¹æ³• postProcessPropertyValues(), è¿›è¡Œ<strong>å±æ€§å¡«å……å‰çš„å†æ¬¡å¤„ç†</strong>. ç°åœ¨æœ€å¸¸ç”¨çš„  <strong>@Autowire å±æ€§æ³¨å…¥å°±æ˜¯è¿™è¾¹æ³¨å…¥ä¾èµ–çš„ bean å®ä¾‹å¯¹è±¡</strong>, å…·ä½“å®ç°åœ¨ <strong>AutowiredAnnotationBeanPostProcessor</strong>, è¯¥å†…å®¹ä¼šåœ¨ä¹‹åä»‹ç» @Autowire çš„éƒ¨åˆ†ä¸­å•ç‹¬ä»‹ç».</p> <p>æœ€åæ³¨é‡Š 8 å¤„å°†æ‰€æœ‰ PropertyValues ä¸­çš„å±æ€§å¡«å……åˆ° bean ä¸­.</p> <p>è¿™ä¸ªæ–¹æ³•æ¶‰åŠåˆ°å¾ªç¯ä¾èµ–çš„è§£å†³, å…·ä½“å°†åœ¨åé¢å•ç‹¬åˆ†æ.</p> <h4 id="initializebean"><a href="#initializebean" class="header-anchor">#</a> initializeBean()</h4> <p>æ­¤æ–¹æ³•å¯¹ bean è¿›è¡Œ<strong>åˆå§‹åŒ–</strong>. è¿˜è®°å¾— init-method å—? è¿˜æœ‰ InitializingBean æ¥å£? è¿˜æœ‰ BeanPostProcessor æ¥å£? è¿™é‡Œä¼šå¯¹è¿™äº›å›è°ƒæ–¹æ³•è¿›è¡Œè°ƒç”¨, å°±æ˜¯å¤„ç† bean åˆå§‹åŒ–å®Œæˆåçš„å„ç§å›è°ƒ.</p> <blockquote><p>AbstractAutowireCapableBeanFactory::initializeBean()</p></blockquote> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">protected</span> <span class="token class-name">Object</span> <span class="token function">initializeBean</span><span class="token punctuation">(</span><span class="token class-name">String</span> beanName<span class="token punctuation">,</span> <span class="token class-name">Object</span> bean<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">RootBeanDefinition</span> mbd<span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token comment">// 1.æ¿€æ´»Awareæ–¹æ³•</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">getSecurityManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">AccessController</span><span class="token punctuation">.</span><span class="token function">doPrivileged</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">PrivilegedAction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token function">invokeAwareMethods</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> bean<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token function">getAccessControlContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// å¦‚æœbeanå®ç°äº†BeanNameAware, BeanClassLoaderAwareæˆ–BeanFactoryAwareæ¥å£, è¿›è¡Œå›è°ƒ</span>
        <span class="token function">invokeAwareMethods</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> bean<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token class-name">Object</span> wrappedBean <span class="token operator">=</span> bean<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>mbd <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> <span class="token operator">!</span>mbd<span class="token punctuation">.</span><span class="token function">isSynthetic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 2.åœ¨åˆå§‹åŒ–å‰å›è°ƒBeanPostProcessoræ¥å£çš„postProcessBeforeInitializationæ–¹æ³•</span>
        <span class="token comment">// å…è®¸å¯¹beanå®ä¾‹è¿›è¡ŒåŒ…è£…</span>
        wrappedBean <span class="token operator">=</span> <span class="token function">applyBeanPostProcessorsBeforeInitialization</span><span class="token punctuation">(</span>wrappedBean<span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment">// 3.è°ƒç”¨ç”¨æˆ·è‡ªå®šä¹‰çš„initåˆå§‹åŒ–æ–¹æ³•</span>
        <span class="token comment">// 3.1.å¤„ç†beanä¸­å®šä¹‰çš„init-method</span>
        <span class="token comment">// 3.2.æˆ–è€…å¦‚æœè‡ªå®šä¹‰çš„beanå®ç°äº†InitializingBeanæ¥å£, è°ƒç”¨afterPropertiesSet()æ–¹æ³•</span>
        <span class="token function">invokeInitMethods</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> wrappedBean<span class="token punctuation">,</span> mbd<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BeanCreationException</span><span class="token punctuation">(</span><span class="token punctuation">(</span>mbd <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> mbd<span class="token punctuation">.</span><span class="token function">getResourceDescription</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                        beanName<span class="token punctuation">,</span> <span class="token string">&quot;Invocation of init method failed&quot;</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>mbd <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> <span class="token operator">!</span>mbd<span class="token punctuation">.</span><span class="token function">isSynthetic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 4.åœ¨åˆå§‹åŒ–åå›è°ƒBeanPostProcessoræ¥å£çš„postProcessAfterInitializationæ–¹æ³•</span>
        <span class="token comment">// å…è®¸å¯¹beanå®ä¾‹è¿›è¡ŒåŒ…è£…</span>
        wrappedBean <span class="token operator">=</span> <span class="token function">applyBeanPostProcessorsAfterInitialization</span><span class="token punctuation">(</span>wrappedBean<span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> wrappedBean<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br></div></div><p>ä¸‹é¢è¯¦ç»†åˆ†æè¿™ä¸ªæ–¹æ³•. æ€»å…±åˆ†æˆäº†å››å¤§æ­¥.</p> <h5 id="_1-invokeawaremethods"><a href="#_1-invokeawaremethods" class="header-anchor">#</a> 1.invokeAwareMethods()</h5> <p>ç¬¬ä¸€æ­¥: <strong>invokeAwareMethods()</strong> .é¦–å…ˆæ˜¯è°ƒç”¨å®ç°äº† Aware æ¥å£çš„æ–¹æ³•, çœ‹çœ‹æºç .</p> <blockquote><p>AbstractAutowireCapableBeanFactory::invokeAwareMethods()</p></blockquote> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">invokeAwareMethods</span><span class="token punctuation">(</span><span class="token class-name">String</span> beanName<span class="token punctuation">,</span> <span class="token class-name">Object</span> bean<span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token comment">// æ˜¯å¦å®ç°äº†Awareæ¥å£</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>bean <span class="token keyword">instanceof</span> <span class="token class-name">Aware</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// BeanNameAware: å®ç°æ­¤æ¥å£çš„ç±»æƒ³è¦æ‹¿åˆ°beanName, å› æ­¤åœ¨è¿™è¾¹èµ‹å€¼ç»™å®ƒ</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>bean <span class="token keyword">instanceof</span> <span class="token class-name">BeanNameAware</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">BeanNameAware</span><span class="token punctuation">)</span> bean<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setBeanName</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// BeanClassLoaderAware: å®ç°æ­¤æ¥å£çš„ç±»æƒ³è¦æ‹¿åˆ°beanClassLoader, å› æ­¤åœ¨è¿™è¾¹èµ‹å€¼ç»™å®ƒ</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>bean <span class="token keyword">instanceof</span> <span class="token class-name">BeanClassLoaderAware</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">ClassLoader</span> bcl <span class="token operator">=</span> <span class="token function">getBeanClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>bcl <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">BeanClassLoaderAware</span><span class="token punctuation">)</span> bean<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setBeanClassLoader</span><span class="token punctuation">(</span>bcl<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// BeanFactoryAware: å®ç°æ­¤æ¥å£çš„ç±»æƒ³è¦æ‹¿åˆ° BeanFactory, å› æ­¤åœ¨è¿™è¾¹èµ‹å€¼ç»™å®ƒ</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>bean <span class="token keyword">instanceof</span> <span class="token class-name">BeanFactoryAware</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">BeanFactoryAware</span><span class="token punctuation">)</span> bean<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setBeanFactory</span><span class="token punctuation">(</span><span class="token class-name">AbstractAutowireCapableBeanFactory</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><p>ä»¥ Aware ä¸ºç»“å°¾çš„ç±»éƒ½æ˜¯ä¸€äº›<strong>æ‰©å±•æ¥å£</strong>, ç”¨äºæä¾›ç»™å¼€å‘è€…è·å–åˆ° <strong>BeanFactory ä¸­çš„ä¸€äº›å±æ€§æˆ–å¯¹è±¡</strong>. è¿™é‡Œå°±æ˜¯å¯¹å„ä¸ª Aware æ¥å£å®ç°ç±»çš„ç›¸å…³æ–¹æ³•è¿›è¡Œå›è°ƒ.</p> <h5 id="_2-applybeanpostprocessorsbeforeinitialization"><a href="#_2-applybeanpostprocessorsbeforeinitialization" class="header-anchor">#</a> 2.applyBeanPostProcessorsBeforeInitialization()</h5> <p>ç¬¬äºŒæ­¥: <strong>applyBeanPostProcessorsBeforeInitialization()</strong></p> <p>æ­¤æ–¹æ³•åœ¨è¿›è¡Œåˆå§‹åŒ–ä¹‹å‰çœŸæ­£å›è°ƒ <strong>BeanPostProcessor</strong> æ¥å£çš„ <strong>postProcessBeforeInitialization()</strong>  æ–¹æ³•.</p> <blockquote><p>AbstractAutowireCapableBeanFactory::applyBeanPostProcessorsBeforeInitialization()</p></blockquote> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">applyBeanPostProcessorsBeforeInitialization</span><span class="token punctuation">(</span><span class="token class-name">Object</span> existingBean<span class="token punctuation">,</span> <span class="token class-name">String</span> beanName<span class="token punctuation">)</span>
    <span class="token keyword">throws</span> <span class="token class-name">BeansException</span> <span class="token punctuation">{</span>

    <span class="token class-name">Object</span> result <span class="token operator">=</span> existingBean<span class="token punctuation">;</span>
    <span class="token comment">// 1.éå†æ‰€æœ‰æ³¨å†Œçš„BeanPostProcessorå®ç°ç±»</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">BeanPostProcessor</span> processor <span class="token operator">:</span> <span class="token function">getBeanPostProcessors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 2.åœ¨beanåˆå§‹åŒ–æ–¹æ³•æ‰§è¡Œå‰, è°ƒç”¨postProcessBeforeInitializationæ–¹æ³•</span>
        <span class="token class-name">Object</span> current <span class="token operator">=</span> processor<span class="token punctuation">.</span><span class="token function">postProcessBeforeInitialization</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>current <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> result<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        result <span class="token operator">=</span> current<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>è¿™è¾¹æä¸€ä¸ªæ¯”è¾ƒé‡è¦çš„å®ç°ç±»: <strong>ApplicationContextAwareProcessor</strong>, å…¶å®ç°å¦‚ä¸‹.</p> <blockquote><p>ApplicationContextAwareProcessor::postProcessBeforeInitialization()</p></blockquote> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token annotation punctuation">@Nullable</span>
<span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">postProcessBeforeInitialization</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">Object</span> bean<span class="token punctuation">,</span> <span class="token class-name">String</span> beanName<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">BeansException</span> <span class="token punctuation">{</span>
    <span class="token class-name">AccessControlContext</span> acc <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">getSecurityManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span>
        <span class="token punctuation">(</span>bean <span class="token keyword">instanceof</span> <span class="token class-name">EnvironmentAware</span> <span class="token operator">||</span> bean <span class="token keyword">instanceof</span> <span class="token class-name">EmbeddedValueResolverAware</span> <span class="token operator">||</span>
         bean <span class="token keyword">instanceof</span> <span class="token class-name">ResourceLoaderAware</span> <span class="token operator">||</span> bean <span class="token keyword">instanceof</span> <span class="token class-name">ApplicationEventPublisherAware</span> <span class="token operator">||</span>
         bean <span class="token keyword">instanceof</span> <span class="token class-name">MessageSourceAware</span> <span class="token operator">||</span> bean <span class="token keyword">instanceof</span> <span class="token class-name">ApplicationContextAware</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        acc <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>applicationContext<span class="token punctuation">.</span><span class="token function">getBeanFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAccessControlContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>acc <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">AccessController</span><span class="token punctuation">.</span><span class="token function">doPrivileged</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">PrivilegedAction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token function">invokeAwareInterfaces</span><span class="token punctuation">(</span>bean<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> acc<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// è°ƒç”¨Awareæ¥å£</span>
        <span class="token function">invokeAwareInterfaces</span><span class="token punctuation">(</span>bean<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> bean<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">invokeAwareInterfaces</span><span class="token punctuation">(</span><span class="token class-name">Object</span> bean<span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token comment">// æ ¹æ®å®ç°çš„æ¥å£è€Œè®¾ç½®ä¸åŒå†…å®¹</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>bean <span class="token keyword">instanceof</span> <span class="token class-name">Aware</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>bean <span class="token keyword">instanceof</span> <span class="token class-name">EnvironmentAware</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">EnvironmentAware</span><span class="token punctuation">)</span> bean<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setEnvironment</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>applicationContext<span class="token punctuation">.</span><span class="token function">getEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>bean <span class="token keyword">instanceof</span> <span class="token class-name">EmbeddedValueResolverAware</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">EmbeddedValueResolverAware</span><span class="token punctuation">)</span> bean<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setEmbeddedValueResolver</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>embeddedValueResolver<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>bean <span class="token keyword">instanceof</span> <span class="token class-name">ResourceLoaderAware</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">ResourceLoaderAware</span><span class="token punctuation">)</span> bean<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setResourceLoader</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>applicationContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>bean <span class="token keyword">instanceof</span> <span class="token class-name">ApplicationEventPublisherAware</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">ApplicationEventPublisherAware</span><span class="token punctuation">)</span> bean<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setApplicationEventPublisher</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>applicationContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>bean <span class="token keyword">instanceof</span> <span class="token class-name">MessageSourceAware</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">MessageSourceAware</span><span class="token punctuation">)</span> bean<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setMessageSource</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>applicationContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// !!!!è¿™ä¸ªå°±æ˜¯ä¸ºå®ç°äº†ApplicationContextAwareæ¥å£çš„ç±»æ³¨å…¥ApplicationContext</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>bean <span class="token keyword">instanceof</span> <span class="token class-name">ApplicationContextAware</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">ApplicationContextAware</span><span class="token punctuation">)</span> bean<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setApplicationContext</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>applicationContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br></div></div><p>ä»£ç ä¸­ç»å¸¸é€šè¿‡å®ç° ApplicationContextAware æ¥å£æ¥æ‹¿åˆ° <strong>ApplicationContext</strong>, ä¹‹æ‰€ä»¥èƒ½æ‹¿åˆ° ApplicationContext, å°±æ˜¯åœ¨è¿™è¾¹è¢«èµ‹å€¼çš„.</p> <h5 id="_3-invokeinitmethods"><a href="#_3-invokeinitmethods" class="header-anchor">#</a> 3.invokeInitMethods()</h5> <p>ç¬¬ä¸‰æ­¥: <strong>invokeInitMethods()</strong> . è°ƒç”¨äº†è®¾ç½®çš„åˆå§‹åŒ–æ–¹æ³•.</p> <blockquote><p>AbstractAutowireCapableBeanFactory::invokeInitMethods()</p></blockquote> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">invokeInitMethods</span><span class="token punctuation">(</span><span class="token class-name">String</span> beanName<span class="token punctuation">,</span> <span class="token class-name">Object</span> bean<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">RootBeanDefinition</span> mbd<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">{</span>

    <span class="token comment">// 1.é¦–å…ˆæ£€æŸ¥æ˜¯å¦å®ç°äº†InitializingBeanæ¥å£, å¦‚æœæ˜¯åˆ™éœ€è¦è°ƒç”¨ afterPropertiesSet æ–¹æ³•</span>
    <span class="token keyword">boolean</span> isInitializingBean <span class="token operator">=</span> <span class="token punctuation">(</span>bean <span class="token keyword">instanceof</span> <span class="token class-name">InitializingBean</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>isInitializingBean <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>mbd <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> <span class="token operator">!</span>mbd<span class="token punctuation">.</span><span class="token function">isExternallyManagedInitMethod</span><span class="token punctuation">(</span><span class="token string">&quot;afterPropertiesSet&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Invoking afterPropertiesSet() on bean with name '&quot;</span> <span class="token operator">+</span> beanName <span class="token operator">+</span> <span class="token string">&quot;'&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 2.è°ƒç”¨afterPropertiesSetæ–¹æ³•</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">getSecurityManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token class-name">AccessController</span><span class="token punctuation">.</span><span class="token function">doPrivileged</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">PrivilegedExceptionAction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
                    <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">InitializingBean</span><span class="token punctuation">)</span> bean<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">afterPropertiesSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token function">getAccessControlContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">PrivilegedActionException</span> pae<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">throw</span> pae<span class="token punctuation">.</span><span class="token function">getException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">InitializingBean</span><span class="token punctuation">)</span> bean<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">afterPropertiesSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 3.è°ƒç”¨è‡ªå®šä¹‰åˆå§‹åŒ–æ–¹æ³•</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>mbd <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> bean<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token class-name">NullBean</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> initMethodName <span class="token operator">=</span> mbd<span class="token punctuation">.</span><span class="token function">getInitMethodName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">hasLength</span><span class="token punctuation">(</span>initMethodName<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
            <span class="token operator">!</span><span class="token punctuation">(</span>isInitializingBean <span class="token operator">&amp;&amp;</span> <span class="token string">&quot;afterPropertiesSet&quot;</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>initMethodName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
            <span class="token operator">!</span>mbd<span class="token punctuation">.</span><span class="token function">isExternallyManagedInitMethod</span><span class="token punctuation">(</span>initMethodName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

            <span class="token function">invokeCustomInitMethod</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> bean<span class="token punctuation">,</span> mbd<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br></div></div><p>è°ƒç”¨è‡ªå®šä¹‰åˆå§‹åŒ–æ–¹æ³•å¦‚ä¸‹.</p> <blockquote><p>AbstractAutowireCapableBeanFactory::invokeCustomInitMethod()</p></blockquote> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">invokeCustomInitMethod</span><span class="token punctuation">(</span><span class="token class-name">String</span> beanName<span class="token punctuation">,</span> <span class="token class-name">Object</span> bean<span class="token punctuation">,</span> <span class="token class-name">RootBeanDefinition</span> mbd<span class="token punctuation">)</span>
    <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">{</span>

    <span class="token comment">// 1.æ‹¿åˆ°åˆå§‹åŒ–æ–¹æ³•çš„æ–¹æ³•å</span>
    <span class="token class-name">String</span> initMethodName <span class="token operator">=</span> mbd<span class="token punctuation">.</span><span class="token function">getInitMethodName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">state</span><span class="token punctuation">(</span>initMethodName <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string">&quot;No init method set&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 2.æ ¹æ®æ–¹æ³•åæ‹¿åˆ°æ–¹æ³•</span>
    <span class="token class-name">Method</span> initMethod <span class="token operator">=</span> <span class="token punctuation">(</span>mbd<span class="token punctuation">.</span><span class="token function">isNonPublicAccessAllowed</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span>
                         <span class="token class-name">BeanUtils</span><span class="token punctuation">.</span><span class="token function">findMethod</span><span class="token punctuation">(</span>bean<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> initMethodName<span class="token punctuation">)</span> <span class="token operator">:</span>
                         <span class="token class-name">ClassUtils</span><span class="token punctuation">.</span><span class="token function">getMethodIfAvailable</span><span class="token punctuation">(</span>bean<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> initMethodName<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>initMethod <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 3.å¦‚æœä¸å­˜åœ¨initMethodNameå¯¹åº”çš„æ–¹æ³•, å¹¶ä¸”æ˜¯å¼ºåˆ¶æ‰§è¡Œåˆå§‹åŒ–æ–¹æ³•(é»˜è®¤ä¸ºå¼ºåˆ¶), åˆ™æŠ›å‡ºå¼‚å¸¸</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mbd<span class="token punctuation">.</span><span class="token function">isEnforceInitMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BeanDefinitionValidationException</span><span class="token punctuation">(</span><span class="token string">&quot;Could not find an init method named '&quot;</span> <span class="token operator">+</span>
                                                        initMethodName <span class="token operator">+</span> <span class="token string">&quot;' on bean with name '&quot;</span> <span class="token operator">+</span> beanName <span class="token operator">+</span> <span class="token string">&quot;'&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span> <span class="token comment">// å¦‚æœè®¾ç½®äº†éå¼ºåˆ¶, æ‰¾ä¸åˆ°åˆ™ç›´æ¥è¿”å›</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;No default init method named '&quot;</span> <span class="token operator">+</span> initMethodName <span class="token operator">+</span>
                             <span class="token string">&quot;' found on bean with name '&quot;</span> <span class="token operator">+</span> beanName <span class="token operator">+</span> <span class="token string">&quot;'&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// Ignore non-existent default lifecycle methods.</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Invoking init method  '&quot;</span> <span class="token operator">+</span> initMethodName <span class="token operator">+</span> <span class="token string">&quot;' on bean with name '&quot;</span> <span class="token operator">+</span> beanName <span class="token operator">+</span> <span class="token string">&quot;'&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 4.åå°„è°ƒç”¨åˆå§‹åŒ–æ–¹æ³•</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">getSecurityManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">AccessController</span><span class="token punctuation">.</span><span class="token function">doPrivileged</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">PrivilegedAction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token class-name">ReflectionUtils</span><span class="token punctuation">.</span><span class="token function">makeAccessible</span><span class="token punctuation">(</span>initMethod<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">AccessController</span><span class="token punctuation">.</span><span class="token function">doPrivileged</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">PrivilegedExceptionAction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span>
                                          <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> initMethod<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>bean<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">getAccessControlContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">PrivilegedActionException</span> pae<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">InvocationTargetException</span> ex <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">InvocationTargetException</span><span class="token punctuation">)</span> pae<span class="token punctuation">.</span><span class="token function">getException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">throw</span> ex<span class="token punctuation">.</span><span class="token function">getTargetException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">ReflectionUtils</span><span class="token punctuation">.</span><span class="token function">makeAccessible</span><span class="token punctuation">(</span>initMethod<span class="token punctuation">)</span><span class="token punctuation">;</span>
            initMethod<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>bean<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InvocationTargetException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> ex<span class="token punctuation">.</span><span class="token function">getTargetException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br></div></div><p>è¿™é‡Œä¼šç”¨<strong>åå°„</strong>çš„æ–¹å¼è°ƒç”¨<strong>åˆå§‹åŒ–æ–¹æ³•</strong>.</p> <h5 id="_4-applybeanpostprocessorsafterinitialization"><a href="#_4-applybeanpostprocessorsafterinitialization" class="header-anchor">#</a> 4.applyBeanPostProcessorsAfterInitialization()</h5> <p>ç¬¬å››æ­¥: <strong>applyBeanPostProcessorsAfterInitialization()</strong> . ä¹Ÿå°±æ˜¯å›è°ƒæ‰€æœ‰å®ç°äº† <strong>BeanPostProcessor</strong> æ¥å£çš„ç±»çš„ postProcessAfterInitialization() æ–¹æ³•å®ç°å¯¹ç‰¹å®š bean çš„æ‹“å±•.</p> <blockquote><p>AbstractAutowireCapableBeanFactory::applyBeanPostProcessorsAfterInitialization()</p></blockquote> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">applyBeanPostProcessorsAfterInitialization</span><span class="token punctuation">(</span><span class="token class-name">Object</span> existingBean<span class="token punctuation">,</span> <span class="token class-name">String</span> beanName<span class="token punctuation">)</span>
    <span class="token keyword">throws</span> <span class="token class-name">BeansException</span> <span class="token punctuation">{</span>

    <span class="token class-name">Object</span> result <span class="token operator">=</span> existingBean<span class="token punctuation">;</span>
    <span class="token comment">// 1.éå†æ‰€æœ‰æ³¨å†Œçš„BeanPostProcessorå®ç°ç±»</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">BeanPostProcessor</span> processor <span class="token operator">:</span> <span class="token function">getBeanPostProcessors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 2.åœ¨beanåˆå§‹åŒ–æ–¹æ³•æ‰§è¡Œå, è°ƒç”¨postProcessAfterInitializationæ–¹æ³•</span>
        <span class="token class-name">Object</span> current <span class="token operator">=</span> processor<span class="token punctuation">.</span><span class="token function">postProcessAfterInitialization</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>current <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 3.å¦‚æœè¿”å›null, åˆ™ä¸ä¼šè°ƒç”¨åç»­çš„BeanPostProcessors</span>
            <span class="token keyword">return</span> result<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        result <span class="token operator">=</span> current<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><h4 id="registerdisposablebeanifnecessary"><a href="#registerdisposablebeanifnecessary" class="header-anchor">#</a> registerDisposableBeanIfNecessary()</h4> <p>æ­¤æ–¹æ³•æ³¨å†Œç”¨äºé”€æ¯çš„ bean, æ‰§è¡Œé”€æ¯æ“ä½œçš„æœ‰ä¸‰ç§: è‡ªå®šä¹‰ destroy æ–¹æ³•, DisposableBean æ¥å£, DestructionAwareBeanPostProcessor.</p> <blockquote><p>AbstractBeanFactory::registerDisposableBeanIfNecessary()</p></blockquote> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">registerDisposableBeanIfNecessary</span><span class="token punctuation">(</span><span class="token class-name">String</span> beanName<span class="token punctuation">,</span> <span class="token class-name">Object</span> bean<span class="token punctuation">,</span> <span class="token class-name">RootBeanDefinition</span> mbd<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">AccessControlContext</span> acc <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">getSecurityManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token function">getAccessControlContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 1.mbdçš„scopeä¸æ˜¯prototype &amp;&amp; ç»™å®šçš„beanéœ€è¦åœ¨å…³é—­æ—¶é”€æ¯</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mbd<span class="token punctuation">.</span><span class="token function">isPrototype</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">requiresDestruction</span><span class="token punctuation">(</span>bean<span class="token punctuation">,</span> mbd<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// å•ä¾‹æ¨¡å¼</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mbd<span class="token punctuation">.</span><span class="token function">isSingleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 2.å•ä¾‹æ¨¡å¼ä¸‹æ³¨å†Œç”¨äºé”€æ¯çš„beanåˆ°disposableBeansç¼“å­˜, æ‰§è¡Œç»™å®šbeançš„æ‰€æœ‰é”€æ¯å·¥ä½œ: </span>
            <span class="token comment">// DestructionAwareBeanPostProcessors, DisposableBeanæ¥å£, è‡ªå®šä¹‰é”€æ¯æ–¹æ³•</span>
            <span class="token comment">// 2.1 DisposableBeanAdapter: ä½¿ç”¨DisposableBeanAdapteræ¥å°è£…ç”¨äºé”€æ¯çš„bean</span>
            <span class="token function">registerDisposableBean</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span>
                                   <span class="token keyword">new</span> <span class="token class-name">DisposableBeanAdapter</span><span class="token punctuation">(</span>bean<span class="token punctuation">,</span> beanName<span class="token punctuation">,</span> mbd<span class="token punctuation">,</span> <span class="token function">getBeanPostProcessors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> acc<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment">// 3.å…¶ä»–scopeå¤„ç†</span>
            <span class="token class-name">Scope</span> scope <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>scopes<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>mbd<span class="token punctuation">.</span><span class="token function">getScope</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>scope <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">&quot;No Scope registered for scope name '&quot;</span> <span class="token operator">+</span> mbd<span class="token punctuation">.</span><span class="token function">getScope</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;'&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            scope<span class="token punctuation">.</span><span class="token function">registerDestructionCallback</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span>
                                              <span class="token keyword">new</span> <span class="token class-name">DisposableBeanAdapter</span><span class="token punctuation">(</span>bean<span class="token punctuation">,</span> beanName<span class="token punctuation">,</span> mbd<span class="token punctuation">,</span> <span class="token function">getBeanPostProcessors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> acc<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><p>è¿™é‡Œ requiresDestruction(bean, mbd) ç”¨äºåˆ¤æ–­ç»™å®šçš„ bean æ˜¯å¦éœ€è¦åœ¨å…³é—­æ—¶é”€æ¯.</p> <blockquote><p>AbstractBeanFactory::requiresDestruction()</p></blockquote> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">protected</span> <span class="token keyword">boolean</span> <span class="token function">requiresDestruction</span><span class="token punctuation">(</span><span class="token class-name">Object</span> bean<span class="token punctuation">,</span> <span class="token class-name">RootBeanDefinition</span> mbd<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 1.DisposableBeanAdapter.hasDestroyMethod(bean, mbd): åˆ¤æ–­beanæ˜¯å¦æœ‰destroyæ–¹æ³•</span>
    <span class="token comment">// 2.hasDestructionAwareBeanPostProcessors(): åˆ¤æ–­å½“å‰BeanFactoryæ˜¯å¦æ³¨å†Œè¿‡DestructionAwareBeanPostProcessor</span>
    <span class="token comment">// 3.DisposableBeanAdapter.hasApplicableProcessors: æ˜¯å¦å­˜åœ¨é€‚ç”¨äºbeançš„DestructionAwareBeanPostProcessor</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>bean<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token class-name">NullBean</span><span class="token punctuation">.</span><span class="token keyword">class</span> <span class="token operator">&amp;&amp;</span>
            <span class="token punctuation">(</span><span class="token class-name">DisposableBeanAdapter</span><span class="token punctuation">.</span><span class="token function">hasDestroyMethod</span><span class="token punctuation">(</span>bean<span class="token punctuation">,</span> mbd<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span><span class="token function">hasDestructionAwareBeanPostProcessors</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
                                                                   <span class="token class-name">DisposableBeanAdapter</span><span class="token punctuation">.</span><span class="token function">hasApplicableProcessors</span><span class="token punctuation">(</span>bean<span class="token punctuation">,</span> <span class="token function">getBeanPostProcessors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h3 id="å¾ªç¯ä¾èµ–ä¸ä¸‰çº§ç¼“å­˜"><a href="#å¾ªç¯ä¾èµ–ä¸ä¸‰çº§ç¼“å­˜" class="header-anchor">#</a> å¾ªç¯ä¾èµ–ä¸ä¸‰çº§ç¼“å­˜</h3> <h4 id="åŸºç¡€"><a href="#åŸºç¡€" class="header-anchor">#</a> åŸºç¡€</h4> <h5 id="_1-æ¦‚è¿°"><a href="#_1-æ¦‚è¿°" class="header-anchor">#</a> 1.æ¦‚è¿°</h5> <p><strong>å¾ªç¯ä¾èµ–: å°±æ˜¯ N ä¸ªç±»å¾ªç¯(åµŒå¥—)ä¾èµ–, é€ æˆå¤šä¸ª bean äº’ç›¸å¼•ç”¨å¯¹æ–¹, æœ€ç»ˆå½¢æˆé—­ç¯</strong>.</p> <p><img src="https://nano-note.oss-cn-beijing.aliyuncs.com/images/image-20200803144915470-0101394.png" alt=""></p> <p>è¿™é‡Œå¾ªç¯ä¾èµ–ä¸æ˜¯æ–¹æ³•ä¹‹é—´çš„å¾ªç¯è°ƒç”¨, <strong>è€Œæ˜¯å¯¹è±¡çš„ç›¸äº’ä¾èµ–å…³ç³»</strong>. æ¯”å¦‚ä¸‹é¢çš„ä»£ç :</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">AService</span> <span class="token punctuation">{</span>
    <span class="token comment">// Aä¾èµ–B</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">BService</span> bService<span class="token punctuation">;</span>
    <span class="token comment">//...</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">BServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">BService</span> <span class="token punctuation">{</span>
    <span class="token comment">// Bä¾èµ–A</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">AService</span> aService<span class="token punctuation">;</span>
    <span class="token comment">//...</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><h5 id="_2-ä¸‰å¤§å¾ªç¯ä¾èµ–åœºæ™¯"><a href="#_2-ä¸‰å¤§å¾ªç¯ä¾èµ–åœºæ™¯" class="header-anchor">#</a> 2.ä¸‰å¤§å¾ªç¯ä¾èµ–åœºæ™¯</h5> <h6 id="_1-æ„é€ å™¨æ³¨å…¥å¾ªç¯ä¾èµ–"><a href="#_1-æ„é€ å™¨æ³¨å…¥å¾ªç¯ä¾èµ–" class="header-anchor">#</a> (1)æ„é€ å™¨æ³¨å…¥å¾ªç¯ä¾èµ–</h6> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">A</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token class-name">A</span><span class="token punctuation">(</span><span class="token class-name">B</span> b<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">B</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token class-name">B</span><span class="token punctuation">(</span><span class="token class-name">A</span> a<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p><strong>æ„é€ å™¨æ³¨å…¥é€ æˆçš„å¾ªç¯ä¾èµ–é—®é¢˜æ˜¯æ— æ³•è§£å†³çš„</strong>, åªèƒ½æŠ›å‡º BeanCurrentlyInCreationException <strong>å¼‚å¸¸</strong>è¡¨ç¤ºå¾ªç¯ä¾èµ–.</p> <h6 id="_2-prototypeæ³¨å…¥å¾ªç¯ä¾èµ–"><a href="#_2-prototypeæ³¨å…¥å¾ªç¯ä¾èµ–" class="header-anchor">#</a> (2)prototypeæ³¨å…¥å¾ªç¯ä¾èµ–</h6> <p>ä½œç”¨åŸŸä¸º prototype çš„ bean çš„å¾ªç¯ä¾èµ–.</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Scope</span><span class="token punctuation">(</span><span class="token class-name">ConfigurableBeanFactory</span><span class="token punctuation">.</span><span class="token constant">SCOPE_PROTOTYPE</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">A</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">B</span> b<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@Scope</span><span class="token punctuation">(</span><span class="token class-name">ConfigurableBeanFactory</span><span class="token punctuation">.</span><span class="token constant">SCOPE_PROTOTYPE</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">B</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">A</span> a<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>prototype å­—æ®µå±æ€§æ³¨å…¥å¾ªç¯ä¾èµ–é—®é¢˜ä¹Ÿæ˜¯<strong>æ— æ³•è§£å†³</strong>çš„.</p> <h6 id="_3-setteræ³¨å…¥å¾ªç¯ä¾èµ–"><a href="#_3-setteræ³¨å…¥å¾ªç¯ä¾èµ–" class="header-anchor">#</a> (3)setteræ³¨å…¥å¾ªç¯ä¾èµ–</h6> <p>è¿™ç§æ–¹å¼æ˜¯æœ€ä¸ºå¸¸ç”¨çš„ä¾èµ–æ³¨å…¥æ–¹å¼:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">A</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">B</span> b<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">B</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">A</span> a<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p><mark><strong>å•ä¾‹ bean</strong></mark> çš„ setter æ³¨å…¥çš„å¾ªç¯ä¾èµ–<strong>å¯ä»¥è§£å†³</strong>.</p> <h4 id="ä¸‰çº§ç¼“å­˜"><a href="#ä¸‰çº§ç¼“å­˜" class="header-anchor">#</a> ä¸‰çº§ç¼“å­˜</h4> <h5 id="å„çº§ç¼“å­˜æ¦‚è¿°"><a href="#å„çº§ç¼“å­˜æ¦‚è¿°" class="header-anchor">#</a> å„çº§ç¼“å­˜æ¦‚è¿°</h5> <p>åœ¨ Spring å®¹å™¨çš„æ•´ä¸ªç”Ÿå‘½å‘¨æœŸä¸­, <strong>å•ä¾‹ Bean æœ‰ä¸”ä»…æœ‰ä¸€ä¸ªå¯¹è±¡</strong>, è¿™å¾ˆå®¹æ˜“è®©äººæƒ³åˆ°å¯ä»¥ç”¨ç¼“å­˜æ¥åŠ é€Ÿè®¿é—®. Spring å¤§é‡è¿ç”¨äº†ç¼“å­˜æ‰‹æ®µ, åœ¨å¾ªç¯ä¾èµ–é—®é¢˜çš„è§£å†³è¿‡ç¨‹ä¸­ä½¿ç”¨äº† &quot;<strong>ä¸‰çº§ç¼“å­˜</strong>&quot;.</p> <p>ä¸‰çº§ç¼“å­˜å…¶å®æ›´åƒæ˜¯ Spring å®¹å™¨å·¥å‚å†…çš„æœ¯è¯­, <strong>é‡‡ç”¨ä¸‰çº§ç¼“å­˜æ¨¡å¼æ¥è§£å†³å¾ªç¯ä¾èµ–é—®é¢˜</strong>, è¿™ä¸‰çº§ç¼“å­˜æºç å¦‚ä¸‹:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/** ä¸€çº§ç¼“å­˜ ç¼“å­˜å®Œæ•´çš„å•ä¾‹å¯¹è±¡: beanName --&gt; beanå®ä¾‹ */</span>
<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> singletonObjects <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/** äºŒçº§ç¼“å­˜ ç¼“å­˜æ—©æœŸçš„å•ä¾‹å¯¹è±¡: beanName --&gt; æ—©æœŸbeanå®ä¾‹ */</span>
<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> earlySingletonObjects <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/** ä¸‰çº§ç¼“å­˜ ç¼“å­˜å•ä¾‹å¯¹è±¡å·¥å‚: beanName --&gt; ObjectFactory */</span>
<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">ObjectFactory</span><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> singletonFactories <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>ä¸ºå•¥è¿™æ ·å«? <strong>getSingleton()</strong>  æ–¹æ³•ä»<strong>ç¼“å­˜</strong>ä¸­è·å¾—å¯¹è±¡çš„é¡ºåºå¦‚ä¸‹, ç”±æ­¤å‘½åä¸‰çº§ç¼“å­˜. <strong>è·å–å•ä¾‹ Bean çš„æºç å¦‚ä¸‹</strong>:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Nullable</span>
<span class="token keyword">protected</span> <span class="token class-name">Object</span> <span class="token function">getSingleton</span><span class="token punctuation">(</span><span class="token class-name">String</span> beanName<span class="token punctuation">,</span> <span class="token keyword">boolean</span> allowEarlyReference<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// æŸ¥è¯¢ä¸€çº§ç¼“å­˜(æŸ¥è¯¢éœ€è¦çš„ç›®æ ‡å¯¹è±¡)</span>
    <span class="token class-name">Object</span> singletonObject <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>singletonObjects<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// ä¸€çº§ç¼“å­˜ä¸å­˜åœ¨ä¸”å½“å‰å¯¹è±¡å¹¶æ²¡æœ‰åœ¨åˆ›å»ºçš„è¿‡ç¨‹ä¸­</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>singletonObject <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isSingletonCurrentlyInCreation</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// åŠ ä¸ªé”</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>singletonObjects<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// æŸ¥è¯¢äºŒçº§ç¼“å­˜</span>
            singletonObject <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>earlySingletonObjects<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// äºŒçº§ç¼“å­˜ä¸å­˜åœ¨ä¸”å…è®¸æ—©æœŸå¼•ç”¨</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>singletonObject <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> allowEarlyReference<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// æŸ¥è¯¢ä¸‰çº§ç¼“å­˜</span>
                <span class="token class-name">ObjectFactory</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> singletonFactory <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>singletonFactories<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// ä¸‰çº§ç¼“å­˜æŸ¥è¯¢åˆ°äº†, ä¸‹é¢å°±å¯ä»¥åˆ›å»ºå¯¹è±¡äº†</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>singletonFactory <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">// é€šè¿‡ä¸‰çº§ç¼“å­˜ä¸­çš„ObjectFactoryç”Ÿæˆä¸€ä¸ªæ—©æœŸbean</span>
                    singletonObject <span class="token operator">=</span> singletonFactory<span class="token punctuation">.</span><span class="token function">getObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">// å°†æ—©æœŸbeanæ”¾åˆ°äºŒçº§ç¼“å­˜ä¸­, åé¢å°±èƒ½æŸ¥è¯¢åˆ°äº†</span>
                    <span class="token keyword">this</span><span class="token punctuation">.</span>earlySingletonObjects<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> singletonObject<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">// åˆ é™¤ä¸‰çº§ç¼“å­˜ä¸­çš„objectFactory</span>
                    <span class="token keyword">this</span><span class="token punctuation">.</span>singletonFactories<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// ç›´æ¥è¿”å›å¯¹è±¡ æ²¡æ‰¾åˆ°å°±è¿”å›nulläº†</span>
    <span class="token keyword">return</span> singletonObject<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br></div></div><p>è¿™é‡ŒåŸºæœ¬å°±æ˜¯ä»ç¼“å­˜ä¸­è·å–å•ä¾‹å¯¹è±¡. è¿™é‡Œå°±ç”¨åˆ°äº†<strong>ä¸‰çº§ç¼“å­˜</strong>.</p> <ol><li>é¦–å…ˆä»ä¸€çº§ç¼“å­˜ <strong>singletonObjects</strong> ä¸­å–<strong>å·²ç»å®Œå…¨å®ä¾‹åŒ–å¥½å¯ä»¥ç”¨</strong>çš„å¯¹è±¡, å¦‚æœèƒ½è·å–åˆ°åˆ™è¯´æ˜ç›®æ ‡å¯¹è±¡å·²ç»å®Œæˆåˆ›å»ºäº†, å¯ä»¥ç›´æ¥è¿”å›, å–ä¸åˆ°åˆ™ç»§ç»­.</li> <li>å¦‚æœ<strong>è·å–ä¸åˆ°</strong>æˆ–è€…å¯¹è±¡æ­£åœ¨åˆ›å»ºä¸­, é‚£å°±å†ä»<strong>äºŒçº§ç¼“å­˜</strong> earlySingletonObjects ä¸­è·å–æå‰æ›å…‰çš„æ—©æœŸå¯¹è±¡, å¦‚æœè·å–åˆ°å°±ç›´æ¥è¿”å›, å–ä¸åˆ°åˆ™ç»§ç»­. <strong>è™½ç„¶è¿™äº›æ—©æœŸå¯¹è±¡è¿˜æ²¡æœ‰å®Œå…¨åˆ›å»ºå¥½, ä½†æ˜¯å…¶å†…å­˜åœ°å€å·²ç»æœ‰äº†, æ‰€ä»¥å¯ä»¥æ‹¿æ¥ä½œä¸ºä¾èµ–äº†, ç­‰åç»­å®Œå…¨åˆå§‹åŒ–å„ä¸ªå±æ€§ä¹‹å, å°±æ˜¯ä¸€ä¸ªå®Œæ•´çš„æ­£å¸¸å¯¹è±¡äº†</strong>.</li> <li>æœ€åä»ä¸‰çº§ç¼“å­˜ <strong>singletonFactory</strong> ä¸­å–è¯¥ <strong>bean çš„å¯¹è±¡å·¥å‚</strong>, å¹¶é€šè¿‡ <strong>singletonFactory.getObject()</strong>  æ–¹æ³•æ„é€ ä¸€ä¸ª<strong>æ—©æœŸçš„ bean</strong>. ä¸‰çº§ç¼“å­˜ç¼“å­˜çš„æ˜¯ bean çš„ objectFactory, é€šè¿‡ <strong>getObject()</strong>  æ–¹æ³•æ„é€ <strong>æ—©æœŸ bean</strong> åå°†å…¶æš´éœ²æ³¨å†Œåˆ°äºŒçº§ç¼“å­˜ earlySingletonObjects ä¸­, ç”±äºäºŒçº§ç¼“å­˜å·²ç»æœ‰è¯¥ bean çš„ä¿¡æ¯, å› æ­¤æœ€ååˆ æ‰ä¸‰çº§ç¼“å­˜ä¸­è¯¥ bean å¯¹åº”çš„ objectFactory. å…¶å®å°±æ˜¯<strong>ä»ä¸‰çº§ç¼“å­˜ç§»åŠ¨åˆ°äº†äºŒçº§ç¼“å­˜</strong>.</li></ol> <p>æ•´ä½“æµç¨‹å¦‚ä¸‹å›¾æ‰€ç¤º. ç¼–è¾‘è¿æ¥: <a href="https://www.processon.com/diagraming/61fa43481e08530f015b2491" target="_blank" rel="noopener noreferrer">https://www.processon.com/diagraming/61fa43481e08530f015b2491<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><img src="https://nano-note.oss-cn-beijing.aliyuncs.com/images/Spring%20IOC-getSingleton%E6%96%B9%E6%B3%95%E5%88%86%E6%9E%90.png" alt=""></p> <h5 id="åŠ å…¥å„çº§ç¼“å­˜çš„æ—¶æœº"><a href="#åŠ å…¥å„çº§ç¼“å­˜çš„æ—¶æœº" class="header-anchor">#</a> åŠ å…¥å„çº§ç¼“å­˜çš„æ—¶æœº</h5> <p><strong>æ·»åŠ åˆ°ä¸€çº§ç¼“å­˜</strong>. åœ¨è°ƒç”¨ getBean() æ–¹æ³•æ—¶ä¼šè¿›è¡Œ bean çš„åˆ›å»º, <strong>è¯¥æ–¹æ³•æœ€åä¸€æ­¥ä¼šæŠŠåˆ›å»ºå¥½çš„ bean æ”¾åˆ°ä¸€çº§ç¼“å­˜ singletonObjects ä¸­, è¡¨ç¤ºè¿™ä¸ªå¯¹è±¡å·²ç»å®Œæˆåˆ›å»ºå¥½å¯ä»¥ç”¨äº†</strong>, å› æ­¤ä¼šåŒæ—¶ç§»é™¤äºŒä¸‰çº§ç¼“å­˜ä¸­ä¸éœ€è¦çš„å¯¹è±¡.</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">addSingleton</span><span class="token punctuation">(</span><span class="token class-name">String</span> beanName<span class="token punctuation">,</span> <span class="token class-name">Object</span> singletonObject<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// å°†æ–°åˆå§‹åŒ–çš„beanåŠ å…¥ç¼“å­˜æ± ä¸­ä¾¿äºå¤ç”¨,åŒæ—¶åˆ é™¤åŠ è½½beanè¿‡ç¨‹ä¸­æ‰€è®°å½•çš„å„ç§è¾…åŠ©çŠ¶æ€</span>
    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>singletonObjects<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 1.æ·»åŠ åˆ°å•ä¾‹å¯¹è±¡ç¼“å­˜(ä¸€çº§ç¼“å­˜)</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>singletonObjects<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> singletonObject<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 2.å°†å•ä¾‹å·¥å‚ç¼“å­˜ç§»é™¤(å·²ç»ä¸éœ€è¦)</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>singletonFactories<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 3.å°†æ—©æœŸå•ä¾‹å¯¹è±¡ç¼“å­˜ç§»é™¤(å·²ç»ä¸éœ€è¦)</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>earlySingletonObjects<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 4.æ·»åŠ åˆ°å·²ç»æ³¨å†Œçš„å•ä¾‹å¯¹è±¡ç¼“å­˜</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>registeredSingletons<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p><strong>æ·»åŠ åˆ°ä¸‰çº§ç¼“å­˜</strong>. åœ¨ createBean() æ–¹æ³•è¿›è¡Œ bean åˆ›å»ºæ—¶, ä¼š<strong>æŠŠåˆ›å»ºçš„ ObjectFactory æ”¾åˆ°ç¬¬ä¸‰çº§ç¼“å­˜ä¸­</strong>, åŒæ—¶æŠŠäºŒçº§ç¼“å­˜ä¸­çš„ bean ç§»é™¤.</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">addSingletonFactory</span><span class="token punctuation">(</span><span class="token class-name">String</span> beanName<span class="token punctuation">,</span> <span class="token class-name">ObjectFactory</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> singletonFactory<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">notNull</span><span class="token punctuation">(</span>singletonFactory<span class="token punctuation">,</span> <span class="token string">&quot;Singleton factory must not be null&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>singletonObjects<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 1.å¦‚æœbeanNameä¸å­˜åœ¨äºsingletonObjectsç¼“å­˜ä¸­</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>singletonObjects<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 2.å°†beanNameå’ŒsingletonFactoryæ³¨å†Œåˆ°singletonFactories(ä¸‰çº§)ç¼“å­˜</span>
            <span class="token comment">// (beanName -&gt; è¯¥beanNameçš„å•ä¾‹å·¥å‚)</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>singletonFactories<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> singletonFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 3.ç§»é™¤earlySingletonObjects(äºŒçº§)ç¼“å­˜ä¸­çš„beanName(beanName -&gt; beanNameçš„æ—©æœŸå•ä¾‹å¯¹è±¡)</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>earlySingletonObjects<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 4.å°†beanNameæ³¨å†Œåˆ°registeredSingletonsç¼“å­˜(å·²ç»æ³¨å†Œçš„å•ä¾‹é›†åˆ)</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>registeredSingletons<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><h5 id="ç¬¬ä¸‰çº§ç¼“å­˜çš„ä½œç”¨"><a href="#ç¬¬ä¸‰çº§ç¼“å­˜çš„ä½œç”¨" class="header-anchor">#</a> ç¬¬ä¸‰çº§ç¼“å­˜çš„ä½œç”¨</h5> <p>æ”¾å…¥åˆ°ä¸‰çº§ç¼“å­˜ä¸­çš„æ˜¯å°† Bean åŒ…è£…èµ·æ¥çš„ <strong>ObjectFactory</strong>, è€Œ<strong>äºŒçº§ç¼“å­˜åˆ™æ˜¯æ ¹æ® ObjectFactory æ¥åˆ›å»ºä¸€ä¸ªæ—©æœŸ bean è¿›è¡Œç¼“å­˜</strong>.</p> <p><strong>ä¸ºä»€ä¹ˆè¦è¿™ä¹ˆåšå‘¢?</strong></p> <p>è¿™å®é™…ä¸Šæ¶‰åŠåˆ° <strong>AOP</strong>, å¦‚æœåˆ›å»ºçš„ Bean æ˜¯æœ‰ä»£ç†çš„, é‚£ä¹ˆ<strong>æ³¨å…¥çš„å°±åº”è¯¥æ˜¯ä»£ç† Bean</strong>, è€Œ<strong>ä¸æ˜¯åŸå§‹çš„ Bea</strong>n. ä½†æ˜¯ Spring ä¸€å¼€å§‹å¹¶ä¸çŸ¥é“ Bean æ˜¯å¦ä¼šæœ‰å¾ªç¯ä¾èµ–, é€šå¸¸æƒ…å†µä¸‹(æ²¡æœ‰å¾ªç¯ä¾èµ–çš„æƒ…å†µä¸‹), Spring éƒ½ä¼šåœ¨å®Œæˆå¡«å……å±æ€§, å¹¶ä¸”æ‰§è¡Œå®Œåˆå§‹åŒ–æ–¹æ³•ä¹‹åå†ä¸ºå…¶åˆ›å»ºä»£ç†. ä½†æ˜¯å¦‚æœå‡ºç°äº†å¾ªç¯ä¾èµ–çš„è¯, Spring å°±<strong>ä¸å¾—ä¸ä¸ºå…¶æå‰åˆ›å»ºä»£ç†å¯¹è±¡</strong>, å¦åˆ™æ³¨å…¥çš„å°±æ˜¯ä¸€ä¸ªåŸå§‹å¯¹è±¡, è€Œä¸æ˜¯ä»£ç†å¯¹è±¡. å› æ­¤, è¿™é‡Œå°±æ¶‰åŠåˆ°åº”è¯¥åœ¨å“ªé‡Œæå‰åˆ›å»ºä»£ç†å¯¹è±¡.</p> <p>Spring çš„åšæ³•å°±æ˜¯åœ¨ <mark><strong>ObjectFactory ä¸­å»æå‰åˆ›å»ºä»£ç†å¯¹è±¡</strong></mark>. å®ƒä¼šæ‰§è¡Œ <strong>getObject() æ–¹æ³•æ¥è·å–åˆ° Bean</strong>.</p> <p>è¿™é‡Œæš´éœ²æ—©æœŸ bean åˆ°ç¬¬ä¸‰çº§ç¼“å­˜çš„æ–¹æ³•å¦‚ä¸‹:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token function">addSingletonFactory</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token function">getEarlyBeanReference</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> mbd<span class="token punctuation">,</span> bean<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>è¿™é‡Œ getEarlyBeanReference() æ–¹æ³•å°±æ˜¯è¿”å›ä¸€ä¸ª <strong>ObjectFactory</strong>. æºç å¦‚ä¸‹:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">protected</span> <span class="token class-name">Object</span> <span class="token function">getEarlyBeanReference</span><span class="token punctuation">(</span><span class="token class-name">String</span> beanName<span class="token punctuation">,</span> <span class="token class-name">RootBeanDefinition</span> mbd<span class="token punctuation">,</span> <span class="token class-name">Object</span> bean<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Object</span> exposedObject <span class="token operator">=</span> bean<span class="token punctuation">;</span>

    <span class="token comment">// 1.å¦‚æœmbdä¸æ˜¯åˆæˆ &amp;&amp; å­˜åœ¨InstantiationAwareBeanPostProcessors</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mbd<span class="token punctuation">.</span><span class="token function">isSynthetic</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">hasInstantiationAwareBeanPostProcessors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">BeanPostProcessor</span> bp <span class="token operator">:</span> <span class="token function">getBeanPostProcessors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 2.åº”ç”¨æ‰€æœ‰SmartInstantiationAwareBeanPostProcessor, è°ƒç”¨getEarlyBeanReferenceæ–¹æ³•</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>bp <span class="token keyword">instanceof</span> <span class="token class-name">SmartInstantiationAwareBeanPostProcessor</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">SmartInstantiationAwareBeanPostProcessor</span> ibp <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">SmartInstantiationAwareBeanPostProcessor</span><span class="token punctuation">)</span> bp<span class="token punctuation">;</span>
                <span class="token comment">// 3.å…è®¸SmartInstantiationAwareBeanPostProcessorè¿”å›æŒ‡å®šbeançš„æ—©æœŸå¼•ç”¨</span>
                <span class="token comment">// // å¦‚æœéœ€è¦ä»£ç†, è¿™é‡Œä¼šè¿”å›ä»£ç†å¯¹è±¡; å¦åˆ™è¿”å›åŸå§‹å¯¹è±¡</span>
                exposedObject <span class="token operator">=</span> ibp<span class="token punctuation">.</span><span class="token function">getEarlyBeanReference</span><span class="token punctuation">(</span>exposedObject<span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 4.è¿”å›è¦ä½œä¸ºbeanå¼•ç”¨å…¬å¼€çš„å¯¹è±¡, å¦‚æœæ²¡æœ‰SmartInstantiationAwareBeanPostProcessorä¿®æ”¹, </span>
    <span class="token comment">// åˆ™è¿”å›çš„æ˜¯å…¥å‚çš„beanå¯¹è±¡æœ¬èº«</span>
    <span class="token keyword">return</span> exposedObject<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><p>å› ä¸ºæå‰è¿›è¡Œäº†<strong>ä»£ç†</strong>, é¿å…å¯¹åé¢é‡å¤åˆ›å»ºä»£ç†å¯¹è±¡, ä¼šåœ¨ <strong>earlyProxyReferences ä¸­è®°å½•å·²è¢«ä»£ç†çš„å¯¹è±¡</strong>.</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">AbstractAutoProxyCreator</span> <span class="token keyword">extends</span> <span class="token class-name">ProxyProcessorSupport</span>
    <span class="token keyword">implements</span> <span class="token class-name">SmartInstantiationAwareBeanPostProcessor</span><span class="token punctuation">,</span> <span class="token class-name">BeanFactoryAware</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">getEarlyBeanReference</span><span class="token punctuation">(</span><span class="token class-name">Object</span> bean<span class="token punctuation">,</span> <span class="token class-name">String</span> beanName<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Object</span> cacheKey <span class="token operator">=</span> <span class="token function">getCacheKey</span><span class="token punctuation">(</span>bean<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// è®°å½•å·²è¢«ä»£ç†çš„å¯¹è±¡</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>earlyProxyReferences<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>cacheKey<span class="token punctuation">,</span> bean<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token function">wrapIfNecessary</span><span class="token punctuation">(</span>bean<span class="token punctuation">,</span> beanName<span class="token punctuation">,</span> cacheKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h4 id="ä¸‰çº§ç¼“å­˜å¾ªç¯ä¾èµ–è§£å†³æµç¨‹"><a href="#ä¸‰çº§ç¼“å­˜å¾ªç¯ä¾èµ–è§£å†³æµç¨‹" class="header-anchor">#</a> ä¸‰çº§ç¼“å­˜å¾ªç¯ä¾èµ–è§£å†³æµç¨‹</h4> <p>Spring åˆ›å»º Bean çš„æµç¨‹å¤§è‡´ä¸­å¯¹ Bean çš„åˆ›å»ºæœ€ä¸ºæ ¸å¿ƒçš„<strong>ä¸‰ä¸ªæ–¹æ³•</strong>å¦‚ä¸‹:</p> <ul><li><strong>createBeanInstance()</strong> : <strong>å¯¹è±¡å®ä¾‹åŒ–</strong>, å…¶å®ä¹Ÿå°±æ˜¯è°ƒç”¨å¯¹è±¡çš„æ„é€ æ–¹æ³•<strong>å®ä¾‹åŒ–å¯¹è±¡</strong>.</li> <li><strong>populateBean()</strong> : <strong>å¡«å……å±æ€§</strong>, è¿™ä¸€æ­¥ä¸»è¦æ˜¯å¯¹ bean çš„<strong>ä¾èµ–å±æ€§è¿›è¡Œæ³¨å…¥</strong>(@Autowired).</li> <li><strong>initializeBean()</strong> : å›è°ƒä¸€äº›å½¢å¦‚ initMethod(), InitializingBean() ç­‰æ–¹æ³•.</li></ul> <p><strong>å¾ªç¯ä¾èµ–ä¸»è¦å‘ç”Ÿåœ¨ populateBean()</strong>  è¿™ä¸€æ­¥, ä¹Ÿå°±æ˜¯è¿›è¡Œ<strong>å±æ€§å¡«å……</strong>çš„æ—¶å€™.</p> <p>å‡è®¾ A ä¸ B ä¹‹é—´äº’ç›¸ä¾èµ–å½¢æˆå¾ªç¯ä¾èµ–, è¿™é‡Œæ€»ç»“ä¸€ä¸‹å¦‚ä½•åˆ©ç”¨ä¸‰çº§ç¼“å­˜è§£å†³å¾ªç¯ä¾èµ–, ç¼–è¾‘åœ°å€: <a href="https://www.processon.com/diagraming/61f9ef831efad479c0797b42" target="_blank" rel="noopener noreferrer">https://www.processon.com/diagraming/61f9ef831efad479c0797b42<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><img src="https://nano-note.oss-cn-beijing.aliyuncs.com/images/Spring%20IOC-%E5%BE%AA%E7%8E%AF%E4%BE%9D%E8%B5%96%E8%A7%A3%E5%86%B3%E6%B5%81%E7%A8%8B-9058086.png" alt="Spring IOC-å¾ªç¯ä¾èµ–è§£å†³æµç¨‹"></p> <p>è¿™é‡Œæµç¨‹å¦‚ä¸‹:</p> <ul><li>é¦–å…ˆæŒ‰ç…§æ­£å¸¸æµç¨‹å¯¹ A è¿›è¡Œåˆå§‹åŒ–, åˆå§‹åŒ–è¿‡ç¨‹ä¸­ <strong>getSingleton()</strong>  æ—¶, ä¼šå‘ç° <strong>sharedInstance</strong> ä¸ºç©º, æ­¤æ—¶ç»§ç»­åˆ›å»º A.</li> <li>å½“åˆ›å»ºå®Œ A çš„ ObjectFactory å¯¹è±¡å, å°†å…¶<strong>æå‰åŠ å…¥åˆ°ä¸‰çº§ç¼“å­˜ singletonFactories ä¸­</strong>.</li> <li>å½“ A æ‰§è¡Œåˆ° <strong>populatedBean()</strong>  æ–¹æ³•ä¸º bean å¡«å……å±æ€§æ—¶, å‘ç°ä¾èµ–äº†å®ä¾‹ B. æ­¤æ—¶å»<strong>å®ä¾‹åŒ– B</strong>.</li> <li>B ä¹Ÿä¼šæŒ‰ç…§åˆå§‹åŒ– bean çš„æµç¨‹èµ°ä¸€é. åˆ›å»ºå®Œ B çš„ ObjectFactory åä¹Ÿä¼šå°†å…¶<strong>æå‰åŠ å…¥åˆ°ä¸‰çº§ç¼“å­˜ singletonFactories ä¸­</strong>.</li> <li>å½“ B æ‰§è¡Œåˆ° <strong>populatedBean()</strong>  æ–¹æ³•ä¸º bean å¡«å……å±æ€§æ—¶, å‘ç°ä¾èµ–äº†å®ä¾‹ A. æ­¤æ—¶å»<strong>å®ä¾‹åŒ– A</strong>.</li> <li>æ­¤æ—¶åˆä¼šæ‰§è¡Œä¸€æ¬¡åˆ›å»º bean çš„æµç¨‹, ä½†æ˜¯å½“æ‰§è¡Œåˆ° <strong>getSingleton()</strong>  æ–¹æ³•æ—¶, ä»ä¸€çº§ç¼“å­˜ singletonObjects å’ŒäºŒçº§ç¼“å­˜ earlySingletonObjects ä¸­<strong>æœªå‘ç° A</strong>, ä½†æ˜¯åœ¨<strong>ä¸‰çº§ç¼“å­˜ singletonFactories ä¸­å‘ç° A</strong> çš„ ObjectFactory å¯¹è±¡. æ­¤æ—¶é€šè¿‡è°ƒç”¨ <strong>ObjectFactory#getObject()</strong>  æ–¹æ³•ç”Ÿæˆä¸€ä¸ª A çš„æ—©æœŸå¯¹è±¡æ”¾å…¥äºŒçº§ç¼“å­˜ earlySingletonObjects ä¸­è¿›è¡Œ<strong>æå‰æ›å…‰</strong>, åŒæ—¶ä»ä¸‰çº§ç¼“å­˜åˆ é™¤. æ­¤æ—¶ç›´æ¥å°† A çš„æ—©æœŸå¯¹è±¡çš„å¼•ç”¨è¿”å›ç»™ B å³å¯.</li> <li>B è¿›è¡Œ<strong>å±æ€§å¡«å……</strong>ä¹‹åçš„åç»­å¤„ç†, å¦‚åˆå§‹åŒ–, è¿›è¡Œæ–¹æ³•å›è°ƒç­‰. B ä¼šæ‰§è¡Œåˆå§‹åŒ–æ–¹æ³•, æœ€åå°†è‡ªå·±æ”¾å…¥ç¬¬ä¸€çº§ç¼“å­˜ä¸­(æ­¤æ—¶ B æ˜¯ä¸€ä¸ª<strong>å®Œæ•´</strong>çš„å¯¹è±¡).</li> <li>è¿™é‡Œå®ä¾‹ B åˆ›å»ºå®Œæˆ, è¿”å›çš„æ˜¯<strong>å®Œæ•´çš„ B çš„å®ä¾‹</strong>. è¿™é‡Œä¸å¿…æ‹…å¿ƒ B ä¾èµ–çš„ A è¿˜æ˜¯ä¸å®Œæ•´çš„, å› ä¸ºè¿™é‡Œ B é‡Œé¢æœ‰äº† A çš„å¼•ç”¨åå°±ä¸ä¼šå˜äº†, åˆ°åé¢ A å®Œæˆå®ä¾‹åŒ–ä¹‹åå°±å¥½äº†.</li> <li>A æ‹¿åˆ° B çš„å®Œæ•´å®ä¾‹ä¹‹å, å®Œæˆè‡ªå·±çš„å±æ€§å¡«å……, å¹¶å®Œæˆè‡ªå·±çš„åç»­å¤„ç†, ç„¶åè¿”å›å®ä¾‹åŒ–å¥½çš„å®ä¾‹ A. A åˆ›å»ºå®Œæˆåä¼šæ‰§è¡Œåˆå§‹åŒ–æ–¹æ³•, å°†è‡ªå·±æ”¾å…¥<strong>ç¬¬ä¸€çº§ç¼“å­˜ä¸­</strong>(æ­¤æ—¶ A æ˜¯ä¸€ä¸ªå®Œæ•´çš„å¯¹è±¡). æ­¤æ—¶ A å’Œ B éƒ½æ˜¯å®Œæ•´çš„å®ä¾‹, ä¸”åŒ…å«å¯¹å½¼æ­¤çš„ä¾èµ–.</li></ul> <p>åœ¨åˆ›å»ºè¿‡ç¨‹ä¸­, <strong>éƒ½æ˜¯ä»ä¸‰çº§ç¼“å­˜(å¯¹è±¡å·¥å‚åˆ›å»ºä¸å®Œæ•´å¯¹è±¡), å°†æå‰æš´éœ²çš„å¯¹è±¡æ”¾å…¥åˆ°äºŒçº§ç¼“å­˜, ä»äºŒçº§ç¼“å­˜æ‹¿åˆ°å, å®Œæˆåˆå§‹åŒ–æœ€ç»ˆæˆä¸ºä¸€ä¸ªå®Œæ•´å®ä¾‹åæ”¾å…¥ä¸€çº§ç¼“å­˜</strong>.</p> <p>getSingleton() ä»ç¼“å­˜é‡Œè·å–å•ä¾‹å¯¹è±¡æ­¥éª¤åˆ†æå¯çŸ¥, Spring è§£å†³å¾ªç¯ä¾èµ–çš„è¯€çªå°±åœ¨äº <strong>singletonFactories è¿™ä¸ªä¸‰çº§ç¼“å­˜</strong>. è¿™ä¸ª Cache é‡Œé¢éƒ½æ˜¯ <strong>ObjectFactory</strong>, å®ƒæ˜¯è§£å†³é—®é¢˜çš„å…³é”®.</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// å®ƒå¯ä»¥å°†åˆ›å»ºå¯¹è±¡çš„æ­¥éª¤å°è£…åˆ°ObjectFactoryä¸­ äº¤ç»™è‡ªå®šä¹‰çš„Scopeæ¥é€‰æ‹©æ˜¯å¦éœ€è¦åˆ›å»ºå¯¹è±¡æ¥çµæ´»çš„å®ç°scope. å…·ä½“å‚è§Scopeæ¥å£</span>
<span class="token annotation punctuation">@FunctionalInterface</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">ObjectFactory</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
    <span class="token class-name">T</span> <span class="token function">getObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">BeansException</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>ç»è¿‡ <strong>ObjectFactory.getObject()</strong>  å, æ­¤æ—¶æ”¾è¿›äº†<strong>äºŒçº§ç¼“å­˜ earlySingletonObjects å†…</strong>. è¿™ä¸ªæ—¶å€™å¯¹è±¡å·²ç»<strong>å®ä¾‹åŒ–</strong>äº†, è™½ç„¶è¿˜ä¸å®Œç¾, ä½†æ˜¯<strong>å¯¹è±¡å·²ç»å¯ä»¥è¢«å…¶å®ƒå¼•ç”¨</strong>äº†.</p> <h4 id="ä¸èƒ½è§£å†³å¾ªç¯ä¾èµ–çš„åœºæ™¯"><a href="#ä¸èƒ½è§£å†³å¾ªç¯ä¾èµ–çš„åœºæ™¯" class="header-anchor">#</a> ä¸èƒ½è§£å†³å¾ªç¯ä¾èµ–çš„åœºæ™¯</h4> <ol><li><strong>prototype ç±»å‹çš„å¾ªç¯ä¾èµ–ä¸èƒ½è§£å†³å¾ªç¯ä¾èµ–</strong>, å› ä¸ºè¿™ç§ bean éƒ½æ˜¯ç›´æ¥åˆ›å»ºçš„, æ ¹æœ¬æ²¡æœ‰ç¼“å­˜.</li> <li>é€šè¿‡<strong>æ„é€ å™¨æ–¹å¼</strong>æ³¨å…¥å±æ€§é€ æˆçš„å¾ªç¯ä¾èµ–ä¹Ÿä¸èƒ½è§£å†³. è¿™æ˜¯å› ä¸ºåœ¨ doCreateBean() æ–¹æ³•ä¸­, æ³¨é‡Š 3 å¤„è°ƒç”¨äº†å¦‚ä¸‹æ–¹æ³•:</li></ol> <div class="language-java line-numbers-mode"><pre class="language-java"><code>instanceWrapper <span class="token operator">=</span> <span class="token function">createBeanInstance</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> mbd<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>è¿™ä¸ªæ–¹æ³•é‡Œé¢æœ‰ä¸€éƒ¨åˆ†å°±æ˜¯é€šè¿‡æ„é€ å™¨æ–¹å¼å®ä¾‹åŒ– bean.</p> <p>ç„¶è€Œ doCreateBean() æ–¹æ³•ä¸­, å°†åˆ›å»ºå¥½çš„æ—©æœŸå•ä¾‹ bean <strong>æš´éœ²åˆ°ç¬¬ä¸‰çº§ç¼“å­˜</strong>æ˜¯åœ¨åé¢çš„æ–¹æ³•.</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// è¦ææ—©æ›å…‰å®ä¾‹</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>earlySingletonExposure<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Eagerly caching bean '&quot;</span> <span class="token operator">+</span> beanName <span class="token operator">+</span> <span class="token string">&quot;' to allow for resolving potential circular references&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 8.ç”¨äºè§£å†³å¾ªç¯ä¾èµ–. æå‰æš´éœ²ä¸€ä¸ªå•ä¾‹å·¥å‚æ–¹æ³• ä½¿å…¶ä»–çš„beanèƒ½å¼•ç”¨åˆ°è¯¥bean</span>
    <span class="token comment">// è¿™é‡Œæå‰æ›å…‰beanNameçš„ObjectFactory, å³åœ¨beanåˆå§‹åŒ–å®Œæˆå‰å°†åˆ›å»ºå®ä¾‹çš„ObjectFactoryåŠ å…¥å·¥å‚</span>
    <span class="token function">addSingletonFactory</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span>
                        <span class="token comment">// 8.1.(AOPç›¸å…³)ä¸»è¦åº”ç”¨SmartInstantiationAwareBeanPostProcessor</span>
                        <span class="token comment">// å…è®¸è¿”å›æŒ‡å®šbeançš„æ—©æœŸå¼•ç”¨, AOPå°±æ˜¯åœ¨è¿™é‡Œå°†adviceåŠ¨æ€ç»‡å…¥beanä¸­, </span>
                        <span class="token comment">// è‹¥æ²¡æœ‰åˆ™ç›´æ¥è¿”å›bean, ä¸åšä»»ä½•å¤„ç†</span>
                        <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token function">getEarlyBeanReference</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> mbd<span class="token punctuation">,</span> bean<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p><strong>æ„é€ å™¨æ–¹æ³•æ¯”å°†æ—©æœŸ bean æš´éœ²åˆ°ç¼“å­˜çš„æ–¹æ³•æµç¨‹å…ˆæ‰§è¡Œ</strong>, è°ƒç”¨æ„é€ å™¨æ–¹æ³•æ—¶, <strong>ä¸‰çº§ç¼“å­˜ä¸­è¿˜æ²¡æœ‰æ‰€ä¾èµ– bean çš„æ—©æœŸå¯¹è±¡</strong>, å› æ­¤è¿™ç§åœºæ™¯ä¸‹æ— æ³•è§£å†³å¾ªç¯ä¾èµ–é—®é¢˜.</p> <p>â€</p> <p>â€</p> <h3 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="header-anchor">#</a> å‚è€ƒèµ„æ–™</h3> <ul><li><a href="https://www.jianshu.com/p/6cbbb6a9b3fd" target="_blank" rel="noopener noreferrer">https://www.jianshu.com/p/6cbbb6a9b3fd<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://blog.csdn.net/f641385712/article/details/92801300" target="_blank" rel="noopener noreferrer">Springå¦‚ä½•è§£å†³å¾ªç¯ä¾èµ–<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div>  <div class="page-edit"><div class="edit-link"><a href="https://github.com/xugaoyi/vuepress-theme-vdoing/edit/main/docs/20.å¼€å‘/2100.å¼€å‘/300.Spring/12.Spring IOCæºç åˆ†æ-createBean().md" target="_blank" rel="noopener noreferrer">ç¼–è¾‘</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <!----> <!----></div> <div class="page-nav-wapper"><div class="page-nav-centre-wrap"><a href="/pages/672e98/" class="page-nav-centre page-nav-centre-prev"><div class="tooltip">Spring IOCæºç åˆ†æ-getBean()</div></a> <a href="/pages/f89bcf/" class="page-nav-centre page-nav-centre-next"><div class="tooltip">Spring AOPæºç åˆ†æ</div></a></div> <div class="page-nav"><p class="inner"><span class="prev">
        â†
        <a href="/pages/672e98/" class="prev">Spring IOCæºç åˆ†æ-getBean()</a></span> <span class="next"><a href="/pages/f89bcf/">Spring AOPæºç åˆ†æ</a>â†’
      </span></p></div></div></div> <!----></main></div> <div class="footer"><div class="icons"><a href="mailto:1174520425@qq.com" title="å‘é‚®ä»¶" target="_blank" class="iconfont icon-youjian"></a><a href="https://github.com/nanodaemony" title="GitHub" target="_blank" class="iconfont icon-github"></a></div> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="æœ¬ç«™ä¸»é¢˜">Vdoing</a> 
    | Copyright Â© 2019-2025
    <span>è¾¾å°”æ–‡çš„çŒ¹ | MIT License</span></div> <div class="buttons"><div title="è¿”å›é¡¶éƒ¨" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="å»è¯„è®º" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="ä¸»é¢˜æ¨¡å¼" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          è·Ÿéšç³»ç»Ÿ
        </li><li class="iconfont icon-rijianmoshi">
          æµ…è‰²æ¨¡å¼
        </li><li class="iconfont icon-yejianmoshi">
          æ·±è‰²æ¨¡å¼
        </li><li class="iconfont icon-yuedu">
          é˜…è¯»æ¨¡å¼
        </li></ul></div></div> <!----> <!----> <!----></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.3f3e0e10.js" defer></script><script src="/assets/js/2.e9fcb30c.js" defer></script><script src="/assets/js/3.1998f389.js" defer></script><script src="/assets/js/121.8e16df87.js" defer></script>
  </body>
</html>
