<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>口算-全流程复盘-限流原因分析优化与全链路数据传输研究🌟 | Pangolin Note</title>
    <meta name="generator" content="VuePress 1.9.5">
    <link rel="icon" href="/img/favicon.ico">
    <meta name="description" content="大道至简">
    <meta name="keywords" content="前端博客,个人技术博客,前端,前端开发,前端框架,web前端,前端面试题,技术文档,学习,面试,JavaScript,js,ES6,TypeScript,vue,python,css3,html5,Node,git,github,markdown">
    <meta name="baidu-site-verification" content="7F55weZDDc">
    <meta name="theme-color" content="#11a8cd">
    
    <link rel="preload" href="/assets/css/0.styles.56073ad3.css" as="style"><link rel="preload" href="/assets/js/app.3f3e0e10.js" as="script"><link rel="preload" href="/assets/js/2.e9fcb30c.js" as="script"><link rel="preload" href="/assets/js/3.1998f389.js" as="script"><link rel="preload" href="/assets/js/244.58b0b21d.js" as="script"><link rel="prefetch" href="/assets/js/10.0b55747f.js"><link rel="prefetch" href="/assets/js/100.b8912a99.js"><link rel="prefetch" href="/assets/js/101.a6740c8a.js"><link rel="prefetch" href="/assets/js/102.e31e89b2.js"><link rel="prefetch" href="/assets/js/103.2c5dbdae.js"><link rel="prefetch" href="/assets/js/104.0e9c02f6.js"><link rel="prefetch" href="/assets/js/105.8288396c.js"><link rel="prefetch" href="/assets/js/106.62f43c11.js"><link rel="prefetch" href="/assets/js/107.70c90211.js"><link rel="prefetch" href="/assets/js/108.b488ce56.js"><link rel="prefetch" href="/assets/js/109.12942650.js"><link rel="prefetch" href="/assets/js/11.ac3fd1ca.js"><link rel="prefetch" href="/assets/js/110.1e57ecba.js"><link rel="prefetch" href="/assets/js/111.6e33b4ea.js"><link rel="prefetch" href="/assets/js/112.bd52831b.js"><link rel="prefetch" href="/assets/js/113.868c1ac9.js"><link rel="prefetch" href="/assets/js/114.090549d1.js"><link rel="prefetch" href="/assets/js/115.d97f6c2b.js"><link rel="prefetch" href="/assets/js/116.097c4b4e.js"><link rel="prefetch" href="/assets/js/117.4024cfe2.js"><link rel="prefetch" href="/assets/js/118.e3057cba.js"><link rel="prefetch" href="/assets/js/119.4ef1fa3b.js"><link rel="prefetch" href="/assets/js/12.863eaabe.js"><link rel="prefetch" href="/assets/js/120.78f9df50.js"><link rel="prefetch" href="/assets/js/121.8e16df87.js"><link rel="prefetch" href="/assets/js/122.f21c0107.js"><link rel="prefetch" href="/assets/js/123.ea1cb375.js"><link rel="prefetch" href="/assets/js/124.01c04c6e.js"><link rel="prefetch" href="/assets/js/125.d383e301.js"><link rel="prefetch" href="/assets/js/126.3162cb47.js"><link rel="prefetch" href="/assets/js/127.c6bebae6.js"><link rel="prefetch" href="/assets/js/128.d659db60.js"><link rel="prefetch" href="/assets/js/129.2afdcf48.js"><link rel="prefetch" href="/assets/js/13.4f59ce35.js"><link rel="prefetch" href="/assets/js/130.beb9ed9d.js"><link rel="prefetch" href="/assets/js/131.35b05f8a.js"><link rel="prefetch" href="/assets/js/132.d77f4f93.js"><link rel="prefetch" href="/assets/js/133.4ceda6e5.js"><link rel="prefetch" href="/assets/js/134.11390c5f.js"><link rel="prefetch" href="/assets/js/135.32f9e38f.js"><link rel="prefetch" href="/assets/js/136.6d8bb0f2.js"><link rel="prefetch" href="/assets/js/137.9c0ffeef.js"><link rel="prefetch" href="/assets/js/138.88d86e5f.js"><link rel="prefetch" href="/assets/js/139.8c2c3d6c.js"><link rel="prefetch" href="/assets/js/14.11c82d35.js"><link rel="prefetch" href="/assets/js/140.c5c375d3.js"><link rel="prefetch" href="/assets/js/141.d703f30b.js"><link rel="prefetch" href="/assets/js/142.6a005a44.js"><link rel="prefetch" href="/assets/js/143.9b2edf6f.js"><link rel="prefetch" href="/assets/js/144.3fd013c9.js"><link rel="prefetch" href="/assets/js/145.b05079c5.js"><link rel="prefetch" href="/assets/js/146.ed5360a6.js"><link rel="prefetch" href="/assets/js/147.7408d86f.js"><link rel="prefetch" href="/assets/js/148.f390b370.js"><link rel="prefetch" href="/assets/js/149.95017f0a.js"><link rel="prefetch" href="/assets/js/15.bd143bd5.js"><link rel="prefetch" href="/assets/js/150.f0ede764.js"><link rel="prefetch" href="/assets/js/151.b7093623.js"><link rel="prefetch" href="/assets/js/152.a82a6c83.js"><link rel="prefetch" href="/assets/js/153.965e3fb2.js"><link rel="prefetch" href="/assets/js/154.9e49311e.js"><link rel="prefetch" href="/assets/js/155.cef33ba5.js"><link rel="prefetch" href="/assets/js/156.bcc397ae.js"><link rel="prefetch" href="/assets/js/157.90824739.js"><link rel="prefetch" href="/assets/js/158.efd429b9.js"><link rel="prefetch" href="/assets/js/159.122ff5b7.js"><link rel="prefetch" href="/assets/js/16.2449162b.js"><link rel="prefetch" href="/assets/js/160.0b806535.js"><link rel="prefetch" href="/assets/js/161.835052c6.js"><link rel="prefetch" href="/assets/js/162.ca34e2d2.js"><link rel="prefetch" href="/assets/js/163.08000d04.js"><link rel="prefetch" href="/assets/js/164.a1cc0109.js"><link rel="prefetch" href="/assets/js/165.65444686.js"><link rel="prefetch" href="/assets/js/166.7d73c84f.js"><link rel="prefetch" href="/assets/js/167.009d47a3.js"><link rel="prefetch" href="/assets/js/168.0afeae2a.js"><link rel="prefetch" href="/assets/js/169.7654cb31.js"><link rel="prefetch" href="/assets/js/17.eb7f9def.js"><link rel="prefetch" href="/assets/js/170.58569530.js"><link rel="prefetch" href="/assets/js/171.7db9ed40.js"><link rel="prefetch" href="/assets/js/172.3cb50ed4.js"><link rel="prefetch" href="/assets/js/173.0846425f.js"><link rel="prefetch" href="/assets/js/174.9e95f111.js"><link rel="prefetch" href="/assets/js/175.ef2098f2.js"><link rel="prefetch" href="/assets/js/176.c2635fe9.js"><link rel="prefetch" href="/assets/js/177.4fa38e8e.js"><link rel="prefetch" href="/assets/js/178.2be7037f.js"><link rel="prefetch" href="/assets/js/179.bf3bba28.js"><link rel="prefetch" href="/assets/js/18.0455f4d1.js"><link rel="prefetch" href="/assets/js/180.72c5f597.js"><link rel="prefetch" href="/assets/js/181.42287bcc.js"><link rel="prefetch" href="/assets/js/182.6cd4bf1a.js"><link rel="prefetch" href="/assets/js/183.05dbbfd9.js"><link rel="prefetch" href="/assets/js/184.03de7e00.js"><link rel="prefetch" href="/assets/js/185.42dd210e.js"><link rel="prefetch" href="/assets/js/186.28ee0f8a.js"><link rel="prefetch" href="/assets/js/187.bb58697b.js"><link rel="prefetch" href="/assets/js/188.1bc8be96.js"><link rel="prefetch" href="/assets/js/189.fac747e3.js"><link rel="prefetch" href="/assets/js/19.ae9e35d6.js"><link rel="prefetch" href="/assets/js/190.ea533ac7.js"><link rel="prefetch" href="/assets/js/191.6dc6eb13.js"><link rel="prefetch" href="/assets/js/192.184d249f.js"><link rel="prefetch" href="/assets/js/193.4a06bc12.js"><link rel="prefetch" href="/assets/js/194.8cce60a9.js"><link rel="prefetch" href="/assets/js/195.93231a13.js"><link rel="prefetch" href="/assets/js/196.4a596bde.js"><link rel="prefetch" href="/assets/js/197.96c113cf.js"><link rel="prefetch" href="/assets/js/198.73ba3f67.js"><link rel="prefetch" href="/assets/js/199.74bab595.js"><link rel="prefetch" href="/assets/js/20.b542d0e7.js"><link rel="prefetch" href="/assets/js/200.69a6928a.js"><link rel="prefetch" href="/assets/js/201.9ffa7c5a.js"><link rel="prefetch" href="/assets/js/202.41edb652.js"><link rel="prefetch" href="/assets/js/203.7fabcef3.js"><link rel="prefetch" href="/assets/js/204.b0ae2f62.js"><link rel="prefetch" href="/assets/js/205.add8738b.js"><link rel="prefetch" href="/assets/js/206.f3a712ec.js"><link rel="prefetch" href="/assets/js/207.cd7dd729.js"><link rel="prefetch" href="/assets/js/208.78b33afa.js"><link rel="prefetch" href="/assets/js/209.9d3329ff.js"><link rel="prefetch" href="/assets/js/21.5a050318.js"><link rel="prefetch" href="/assets/js/210.d285d5ac.js"><link rel="prefetch" href="/assets/js/211.8791bb3f.js"><link rel="prefetch" href="/assets/js/212.84ed81a8.js"><link rel="prefetch" href="/assets/js/213.7b990580.js"><link rel="prefetch" href="/assets/js/214.da31f20c.js"><link rel="prefetch" href="/assets/js/215.9eeed659.js"><link rel="prefetch" href="/assets/js/216.9539f0ec.js"><link rel="prefetch" href="/assets/js/217.11b575be.js"><link rel="prefetch" href="/assets/js/218.a67f12f1.js"><link rel="prefetch" href="/assets/js/219.bfbb817a.js"><link rel="prefetch" href="/assets/js/22.2bc6f7e3.js"><link rel="prefetch" href="/assets/js/220.8b01342f.js"><link rel="prefetch" href="/assets/js/221.b450decd.js"><link rel="prefetch" href="/assets/js/222.97468507.js"><link rel="prefetch" href="/assets/js/223.b6dafd73.js"><link rel="prefetch" href="/assets/js/224.c86c18c6.js"><link rel="prefetch" href="/assets/js/225.b0dcf86e.js"><link rel="prefetch" href="/assets/js/226.02cc2999.js"><link rel="prefetch" href="/assets/js/227.8474ef5a.js"><link rel="prefetch" href="/assets/js/228.0298e421.js"><link rel="prefetch" href="/assets/js/229.6aeaf595.js"><link rel="prefetch" href="/assets/js/23.9995fce4.js"><link rel="prefetch" href="/assets/js/230.a5785286.js"><link rel="prefetch" href="/assets/js/231.d791daa4.js"><link rel="prefetch" href="/assets/js/232.97aeeb00.js"><link rel="prefetch" href="/assets/js/233.46e51e28.js"><link rel="prefetch" href="/assets/js/234.2cffe82f.js"><link rel="prefetch" href="/assets/js/235.14965da6.js"><link rel="prefetch" href="/assets/js/236.00a5afc0.js"><link rel="prefetch" href="/assets/js/237.3b73d52f.js"><link rel="prefetch" href="/assets/js/238.6e1db765.js"><link rel="prefetch" href="/assets/js/239.75866c5e.js"><link rel="prefetch" href="/assets/js/24.9141eeb2.js"><link rel="prefetch" href="/assets/js/240.af9c2cc9.js"><link rel="prefetch" href="/assets/js/241.388acab2.js"><link rel="prefetch" href="/assets/js/242.c60f2b48.js"><link rel="prefetch" href="/assets/js/243.d8e81b13.js"><link rel="prefetch" href="/assets/js/245.c3768497.js"><link rel="prefetch" href="/assets/js/246.ac8bbe7a.js"><link rel="prefetch" href="/assets/js/247.d095f70a.js"><link rel="prefetch" href="/assets/js/248.e9f210b5.js"><link rel="prefetch" href="/assets/js/249.a9fad023.js"><link rel="prefetch" href="/assets/js/25.98e8593e.js"><link rel="prefetch" href="/assets/js/250.ae7f0ebb.js"><link rel="prefetch" href="/assets/js/251.9a617d55.js"><link rel="prefetch" href="/assets/js/252.ce082446.js"><link rel="prefetch" href="/assets/js/253.4575302d.js"><link rel="prefetch" href="/assets/js/254.5899a61b.js"><link rel="prefetch" href="/assets/js/255.66c69f31.js"><link rel="prefetch" href="/assets/js/256.8fd6c706.js"><link rel="prefetch" href="/assets/js/257.31b77e5e.js"><link rel="prefetch" href="/assets/js/258.eba48891.js"><link rel="prefetch" href="/assets/js/259.edf74b59.js"><link rel="prefetch" href="/assets/js/26.e69924ea.js"><link rel="prefetch" href="/assets/js/260.cf2ed36d.js"><link rel="prefetch" href="/assets/js/261.9e7792d8.js"><link rel="prefetch" href="/assets/js/262.e7b9433e.js"><link rel="prefetch" href="/assets/js/263.1185b25c.js"><link rel="prefetch" href="/assets/js/264.5e0f89cb.js"><link rel="prefetch" href="/assets/js/265.a38d3b94.js"><link rel="prefetch" href="/assets/js/266.2ef170b3.js"><link rel="prefetch" href="/assets/js/267.a7d14651.js"><link rel="prefetch" href="/assets/js/268.05b18748.js"><link rel="prefetch" href="/assets/js/269.dad48d6f.js"><link rel="prefetch" href="/assets/js/27.13612515.js"><link rel="prefetch" href="/assets/js/270.4f5a6b8d.js"><link rel="prefetch" href="/assets/js/271.7ebf6682.js"><link rel="prefetch" href="/assets/js/272.7c2fbfd1.js"><link rel="prefetch" href="/assets/js/273.8ee20732.js"><link rel="prefetch" href="/assets/js/274.d525242a.js"><link rel="prefetch" href="/assets/js/275.a8a19acb.js"><link rel="prefetch" href="/assets/js/276.df3a4eb4.js"><link rel="prefetch" href="/assets/js/277.336debda.js"><link rel="prefetch" href="/assets/js/278.c470625f.js"><link rel="prefetch" href="/assets/js/279.a91e1a64.js"><link rel="prefetch" href="/assets/js/28.ab7ae1df.js"><link rel="prefetch" href="/assets/js/280.87e25c9a.js"><link rel="prefetch" href="/assets/js/281.87c1ba25.js"><link rel="prefetch" href="/assets/js/282.dcd4dce0.js"><link rel="prefetch" href="/assets/js/283.abac2e00.js"><link rel="prefetch" href="/assets/js/284.f6079659.js"><link rel="prefetch" href="/assets/js/285.f1b39879.js"><link rel="prefetch" href="/assets/js/286.f6a79242.js"><link rel="prefetch" href="/assets/js/287.06bebe07.js"><link rel="prefetch" href="/assets/js/288.89e325df.js"><link rel="prefetch" href="/assets/js/289.3aa1bedd.js"><link rel="prefetch" href="/assets/js/29.ebe50f76.js"><link rel="prefetch" href="/assets/js/290.ee059c92.js"><link rel="prefetch" href="/assets/js/291.fa9a921a.js"><link rel="prefetch" href="/assets/js/292.2a8811cd.js"><link rel="prefetch" href="/assets/js/293.eec09cdf.js"><link rel="prefetch" href="/assets/js/294.dfac20dc.js"><link rel="prefetch" href="/assets/js/295.825d2070.js"><link rel="prefetch" href="/assets/js/296.f645861e.js"><link rel="prefetch" href="/assets/js/297.424fdb17.js"><link rel="prefetch" href="/assets/js/298.ebf87cdc.js"><link rel="prefetch" href="/assets/js/299.b8f19cbb.js"><link rel="prefetch" href="/assets/js/30.75237511.js"><link rel="prefetch" href="/assets/js/300.10fb6d4f.js"><link rel="prefetch" href="/assets/js/301.ef77c612.js"><link rel="prefetch" href="/assets/js/302.1b839763.js"><link rel="prefetch" href="/assets/js/303.609f7d98.js"><link rel="prefetch" href="/assets/js/304.1d255f19.js"><link rel="prefetch" href="/assets/js/305.b0234f2c.js"><link rel="prefetch" href="/assets/js/306.48677f64.js"><link rel="prefetch" href="/assets/js/307.14390d4b.js"><link rel="prefetch" href="/assets/js/308.fa730b28.js"><link rel="prefetch" href="/assets/js/309.0496b9e0.js"><link rel="prefetch" href="/assets/js/31.cf3f471a.js"><link rel="prefetch" href="/assets/js/310.a31676dc.js"><link rel="prefetch" href="/assets/js/311.ed53adc5.js"><link rel="prefetch" href="/assets/js/312.1b0ff2f1.js"><link rel="prefetch" href="/assets/js/313.bf123f32.js"><link rel="prefetch" href="/assets/js/314.4e6ce06b.js"><link rel="prefetch" href="/assets/js/315.8eb18560.js"><link rel="prefetch" href="/assets/js/32.74fef842.js"><link rel="prefetch" href="/assets/js/33.bc2d190b.js"><link rel="prefetch" href="/assets/js/34.d23438fc.js"><link rel="prefetch" href="/assets/js/35.7675c4d0.js"><link rel="prefetch" href="/assets/js/36.96a4161b.js"><link rel="prefetch" href="/assets/js/37.d1824f2f.js"><link rel="prefetch" href="/assets/js/38.4effff9e.js"><link rel="prefetch" href="/assets/js/39.6509914b.js"><link rel="prefetch" href="/assets/js/4.4d01750f.js"><link rel="prefetch" href="/assets/js/40.1509d08b.js"><link rel="prefetch" href="/assets/js/41.f2c1124f.js"><link rel="prefetch" href="/assets/js/42.e541d077.js"><link rel="prefetch" href="/assets/js/43.369de999.js"><link rel="prefetch" href="/assets/js/44.43959db0.js"><link rel="prefetch" href="/assets/js/45.282fbd31.js"><link rel="prefetch" href="/assets/js/46.1b83cfe9.js"><link rel="prefetch" href="/assets/js/47.c3a88e41.js"><link rel="prefetch" href="/assets/js/48.bc7c0a1b.js"><link rel="prefetch" href="/assets/js/49.92a4e5ba.js"><link rel="prefetch" href="/assets/js/5.c3991e24.js"><link rel="prefetch" href="/assets/js/50.9c488c6c.js"><link rel="prefetch" href="/assets/js/51.546ea632.js"><link rel="prefetch" href="/assets/js/52.0d2ccee1.js"><link rel="prefetch" href="/assets/js/53.6f52b5b1.js"><link rel="prefetch" href="/assets/js/54.c838b295.js"><link rel="prefetch" href="/assets/js/55.13af99ee.js"><link rel="prefetch" href="/assets/js/56.6be6d1ed.js"><link rel="prefetch" href="/assets/js/57.67c98b39.js"><link rel="prefetch" href="/assets/js/58.107e82ec.js"><link rel="prefetch" href="/assets/js/59.b3e5edc7.js"><link rel="prefetch" href="/assets/js/6.36a535f9.js"><link rel="prefetch" href="/assets/js/60.3b0b4ba5.js"><link rel="prefetch" href="/assets/js/61.3df843df.js"><link rel="prefetch" href="/assets/js/62.1213823d.js"><link rel="prefetch" href="/assets/js/63.e8f3f926.js"><link rel="prefetch" href="/assets/js/64.e1219050.js"><link rel="prefetch" href="/assets/js/65.5bf5bb0b.js"><link rel="prefetch" href="/assets/js/66.a2502afb.js"><link rel="prefetch" href="/assets/js/67.690dd59b.js"><link rel="prefetch" href="/assets/js/68.de7b0915.js"><link rel="prefetch" href="/assets/js/69.ac61dd61.js"><link rel="prefetch" href="/assets/js/7.5d254238.js"><link rel="prefetch" href="/assets/js/70.3edd41b1.js"><link rel="prefetch" href="/assets/js/71.d23407e9.js"><link rel="prefetch" href="/assets/js/72.a5bd01bc.js"><link rel="prefetch" href="/assets/js/73.c9f4dd57.js"><link rel="prefetch" href="/assets/js/74.66323fc1.js"><link rel="prefetch" href="/assets/js/75.e1a72e00.js"><link rel="prefetch" href="/assets/js/76.801268b4.js"><link rel="prefetch" href="/assets/js/77.3a5fda67.js"><link rel="prefetch" href="/assets/js/78.54d84cd4.js"><link rel="prefetch" href="/assets/js/79.fa10f4e3.js"><link rel="prefetch" href="/assets/js/8.e060e47d.js"><link rel="prefetch" href="/assets/js/80.d5b24fea.js"><link rel="prefetch" href="/assets/js/81.0e9da714.js"><link rel="prefetch" href="/assets/js/82.e96ff6d7.js"><link rel="prefetch" href="/assets/js/83.771cced1.js"><link rel="prefetch" href="/assets/js/84.220b69e7.js"><link rel="prefetch" href="/assets/js/85.7dcc5659.js"><link rel="prefetch" href="/assets/js/86.44ba2100.js"><link rel="prefetch" href="/assets/js/87.281da75d.js"><link rel="prefetch" href="/assets/js/88.12d88449.js"><link rel="prefetch" href="/assets/js/89.f28c86d3.js"><link rel="prefetch" href="/assets/js/9.8f9fef32.js"><link rel="prefetch" href="/assets/js/90.715cabb2.js"><link rel="prefetch" href="/assets/js/91.6ced7c82.js"><link rel="prefetch" href="/assets/js/92.c05b33ca.js"><link rel="prefetch" href="/assets/js/93.6bf5fb66.js"><link rel="prefetch" href="/assets/js/94.3561200e.js"><link rel="prefetch" href="/assets/js/95.0f2cf716.js"><link rel="prefetch" href="/assets/js/96.ac8487ea.js"><link rel="prefetch" href="/assets/js/97.48042b5a.js"><link rel="prefetch" href="/assets/js/98.441bb7f8.js"><link rel="prefetch" href="/assets/js/99.4b214d92.js">
    <link rel="stylesheet" href="/assets/css/0.styles.56073ad3.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu"><header class="navbar blur"><div title="目录" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/img/magic.png" alt="Pangolin Note" class="logo"> <span class="site-name can-hide">Pangolin Note</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">🏡首页</a></div><div class="nav-item"><a href="/basic/" class="nav-link">基础</a></div><div class="nav-item"><a href="/develop/" class="nav-link">开发</a></div><div class="nav-item"><a href="/middleware/" class="nav-link">系统</a></div><div class="nav-item"><a href="/algorithm/" class="nav-link">算法</a></div><div class="nav-item"><a href="/books/" class="nav-link">🍀读书笔记</a></div><div class="nav-item"><a href="/work/" class="nav-link">工作</a></div><div class="nav-item"><a href="/pangolin/" class="nav-link">🌸达尔文的猹</a></div><div class="nav-item"><a href="/pages/beb6c0bd8a66cea6/" class="nav-link">收藏</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/archives/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">归档</a></li></ul></div></div> <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><div class="blogger"><img src="/img/avatarnew.png"> <div class="blogger-info"><h3>达尔文的猹</h3> <span>大道至简 悟在天成</span></div></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">🏡首页</a></div><div class="nav-item"><a href="/basic/" class="nav-link">基础</a></div><div class="nav-item"><a href="/develop/" class="nav-link">开发</a></div><div class="nav-item"><a href="/middleware/" class="nav-link">系统</a></div><div class="nav-item"><a href="/algorithm/" class="nav-link">算法</a></div><div class="nav-item"><a href="/books/" class="nav-link">🍀读书笔记</a></div><div class="nav-item"><a href="/work/" class="nav-link">工作</a></div><div class="nav-item"><a href="/pangolin/" class="nav-link">🌸达尔文的猹</a></div><div class="nav-item"><a href="/pages/beb6c0bd8a66cea6/" class="nav-link">收藏</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/archives/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">归档</a></li></ul></div></div> <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>工作</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading"><span>口算</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/07dbf0/" class="sidebar-link">总结</a></li><li><a href="/pages/a5b5f3/" class="sidebar-link">拍照检查接口流程</a></li><li><a href="/pages/482658/" class="sidebar-link">口算C端服务权限校验</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading"><span>CheckMath</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/72c339/" class="sidebar-link">总结</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading"><span>墨水屏</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/5a2c80/" class="sidebar-link">总结</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading"><span>软实力</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/6aad1f/" class="sidebar-link">开发经验</a></li><li><a href="/pages/41aa0a/" class="sidebar-link">软实力</a></li><li><a href="/pages/a2bcb1/" class="sidebar-link">如何做一个技术主R</a></li><li><a href="/pages/95b842/" class="sidebar-link">大厂晋升指南(极客时间)🌸</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading open"><span>问题记录</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/1b74b9/" class="sidebar-link">口算-OOM案例分析-开发过程中的死循环导致的内存OOM🌸</a></li><li><a href="/pages/0eb085/" aria-current="page" class="active sidebar-link">口算-全流程复盘-限流原因分析优化与全链路数据传输研究🌟</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/pages/c15cbc/" class="sidebar-link">口算-拍试卷轮询接口报错🌟</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading"><span>面试</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/0ec1f4/" class="sidebar-link">找工作准备</a></li><li><a href="/pages/6df9e2/" class="sidebar-link">简历基础</a></li><li><a href="/pages/476e3b/" class="sidebar-link">Java程序员简历模板</a></li><li><a href="/pages/6a9de2/" class="sidebar-link">面经帖子</a></li><li><a href="/pages/acdd42/" class="sidebar-link">反问面试官的问题</a></li></ul></section></li><li><a href="/pages/d6dc9c/" class="sidebar-link">面试问答整理</a></li></ul></section></li></ul> </aside> <div><main class="page"><div class="theme-vdoing-wrapper "><div class="articleInfo-wrap" data-v-06970110><div class="articleInfo" data-v-06970110><ul class="breadcrumbs" data-v-06970110><li data-v-06970110><a href="/" title="首页" class="iconfont icon-home router-link-active" data-v-06970110></a></li> <li data-v-06970110><a href="/work/#工作" data-v-06970110>工作</a></li><li data-v-06970110><a href="/work/#工作" data-v-06970110>工作</a></li><li data-v-06970110><a href="/work/#问题记录" data-v-06970110>问题记录</a></li></ul> <div class="info" data-v-06970110><div title="作者" class="author iconfont icon-touxiang" data-v-06970110><a href="https://github.com/nanodaemony" target="_blank" title="作者" class="beLink" data-v-06970110>NanoDaemony</a></div> <div title="创建时间" class="date iconfont icon-riqi" data-v-06970110><a href="javascript:;" data-v-06970110>2025-02-26</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-title">本文目录</div> <div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABGpJREFUSA3tVVtoXFUU3fvOI53UlmCaKIFmwEhsE7QK0ipFEdHEKpXaZGrp15SINsXUWvBDpBgQRKi0+KKoFeJHfZA+ED9KKoIU2gYD9UejTW4rVIzm0VSTziPzuNu1z507dibTTjL4U/DAzLn3nL3X2o91ziX6f9wMFdh6Jvbm9nNSV0msViVO6tN1Rm7NMu2OpeJ9lWBUTDxrJbYTS0hInuwciu9eLHlFxCLCZEk3MegsJmZ5K/JD6t7FkFdEvGUo1g7qJoG3MHImqRIn8/nzY1K9UPKKiJmtnUqHVE3Gbuay6vJE/N2FEmuxFjW2nUuE0yQXRRxLiTUAzs36zhZvOXJPdX850EVnnLZkB8prodQoM5JGj7Xk2mvC7JB8tG04Ef5PiXtG0UtxupRQSfTnBoCy554x18yJHI6I+G5Eru4LHmPJZEQsrvPUbMiA8G/WgMK7w7I+ez7++o2ANfbrjvaOl1tFMs+htG3IrZH9/hDX1Pr8Tc0UvH8tcX29KzAgIGcEkINyW5BF9x891hw6VYqgJHEk0huccS7vh3C6gTiODL+26huuBtbct8eZnqLML8PkxGYpuPZBqtqwkSjgc4mB5gbgig5i+y0UDK35LMxXisn9xQtK+nd26gTIHsHe/oblK/b29fUmN/8Y+9jAQrnBp56m1LcDlDp9irKTExSKduXJVWSqdBMA08pEJnEIOB3FPPMybu/oeV8zFeYN3xx576Q6RH+VmplE4ncQV5v+5rzSoyOU7PuEAg8g803PwBJ0CExno/jcMbN8tONYeOmHiuUNryvm3fRUy4tMPVLdAGkUhNWuggGrJcXPv+ouCjz0MKUHz1J2/E8IC9nqTabcxgaBYM0hPhD5Y65FsbxRQKxCQrDjDctW7PUM3HuZunFyifSAqEfuzCp48Il24luWUWZoyJCaPR82jE0+kFA643wRFVni4RYSq3ohJO2pZ7B5dO4xkDWbEpossJPLSrPjYID8rS2UHTlvyNxqIGsg674XJJ7vnh5L7PNwC4hh2sjCI96mzszOTpxLF0T7l88Yz7lAuK6OnL8gXLOnTvpzSb22YG8W7us3jSebFHeeqnXRG1vt+MoUM84LQIBmMsCTAcOauTh0T0l0neQK7m2bLMt2mGxU3HYssS0J2cdv5wljlPsrIuZLAG/2DOZIXgCYT8uMGZN+e2kSirfxZOPCsC0f24nTZzspnVn9VePS1Z5vubmAGGXG8ZFno9Hel0yfA5ZPhF7Dh972BQJ2qCpgH67lmWtBYbvk6sz02wjky2vXyz0XErP/kFB619js1BtwfOV4OPRqOQBjy3Qbk18vigUPPSD5ceHnwck7W9bhAqZdd7SuG7w4/P2F/GaJh8c7e9qgow+Q7cGBo+98WsLkuktFqiZabtXuQTu/Y5ETbR0v7tNSFnvrmu6pjdoan2KjMu8q/Hmj1EfCO2ZGfEIbIXKUlw8qaX9/b2oeSJmFksSeT/Fn0V3nSypChh4Gjh74ybO9aeZ/AN2dwciu2/MhAAAAAElFTkSuQmCC">口算-全流程复盘-限流原因分析优化与全链路数据传输研究🌟<!----></h1>  <div class="theme-vdoing-content content__default"><h1 id="_2-口算-全流程复盘-限流原因分析优化与全链路数据传输研究🌟"><a href="#_2-口算-全流程复盘-限流原因分析优化与全链路数据传输研究🌟" class="header-anchor">#</a> 2.口算-全流程复盘-限流原因分析优化与全链路数据传输研究🌟</h1> <p>本文链接: https://confluence.zhenguanyu.com/pages/viewpage.action?pageId=452900480#id-%E5%85%A8%E6%B5%81%E7%A8%8B%E5%A4%8D%E7%9B%98%E9%99%90%E6%B5%81%E5%8E%9F%E5%9B%A0%E5%88%86%E6%9E%90%E4%B8%8E%E4%BC%98%E5%8C%96&amp;%E5%85%A8%E9%93%BE%E8%B7%AF%E6%95%B0%E6%8D%AE%E4%BC%A0%E8%BE%93%E7%A0%94%E7%A9%B6-%E5%81%87%E6%83%B3%E7%9A%84%E5%A4%84%E7%90%86%E8%A7%A3%E9%87%8A%E6%A8%A1%E5%9E%8B</p> <h4 id="原故障信息"><a href="#原故障信息" class="header-anchor">#</a> 原故障信息</h4> <p>口算组记录: <a href="https://confluence.zhenguanyu.com/pages/viewpage.action?pageId=311513772" target="_blank" rel="noopener noreferrer">04. [2022-06-07] solar-thor拍照检查等接口响应时间慢及限流故障复盘. - 2022年06月07日<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>内容组记录: <a href="https://confluence.zhenguanyu.com/pages/viewpage.action?pageId=311246151" target="_blank" rel="noopener noreferrer">2022-06-06-[P0] 视频接口超时<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h4 id="原故障复盘"><a href="#原故障复盘" class="header-anchor">#</a> 原故障复盘</h4> <p>19:49 内容的 RPC 接口故障. 相关的接口都变慢. 如下图, 结束时间约在 21:30 左右.</p> <p><img src="/img/image2022-6-8_0-22-7-20231119112306-4ttrl69.png" alt=""></p> <p>在此期间, 大量的接口都变慢. 这里贴几个重要的,首先看一下这个依赖列表, 因此依赖这个 RPC 的接口都会变慢. 从监控图上也可以看出来.</p> <p><img src="/img/image2022-6-8_0-26-39-20231119112306-4g116te.png" alt=""></p> <p>其中最大的流量接口为: question-multi-video. 这个接口从性能上看. P99 从一开始故障到结束. 其基本处于一个稳定的亚健康状态. 即: P99 为 2.35 秒左右.</p> <p><img src="/img/image2022-6-8_0-47-3-20231119112307-r3y11nz.png" alt=""></p> <p>但是其中的拍照检查的接口, 包括口算, 搜题 , 辅导. 这三个接口的响应时间: <strong>变坏分为了两个阶段</strong>.</p> <ul><li>分别是故障开始的 19:49 ~ 20:00 这段时间的响应时间 P99 大概在 3.75 秒左右.</li> <li>20:00 后接口性能进一步恶化 , 大概来到了 4.5 秒.</li></ul> <blockquote><p>注意: 此时在拍照检查的监控大盘里面看到了一个与之同步的异常情况. 那就是此时产生了限流.</p></blockquote> <p><img src="/img/image2022-6-8_0-46-20-20231119112306-4r07xsz.png" alt=""></p> <p><img src="/img/image2022-6-8_0-46-41-20231119112307-tak13ws.png" alt=""></p> <p>在 20:00 拍照检查的接口发生限流(HTTP 响应码 429), 限流的值特别大.</p> <p><img src="/img/image2022-6-8_1-52-0-20231119112306-38tp6bb.png" alt=""></p> <h4 id="表现与原因分析"><a href="#表现与原因分析" class="header-anchor">#</a> 表现与原因分析</h4> <p>以下是代码中的配置, 这个时候我们有一个比较模糊的认识, 大概知道 Tomcat 的线程池大小为 500. 连接数由于没有配置. 这里的值是默认配置 1 万连接.</p> <p><img src="/img/image2023-3-19_22-12-8-20231119112306-na6q5bd.png" alt=""></p> <p><strong>Tomcat 的 HTTP 线程池为 500, 由于前面 RPC 变慢,导致了大量的 HTTP 请求的 RT 变长.</strong></p> <p><img src="/img/image-20231126161916-u8g7csk.png" alt="image"></p> <p>同时, 拍照检查的接口在 20:00 时, 进一步的变慢. 就产生了并发处理拍照检查的线程数超过了预留的阈值. (值是多少, 实际不重要了.) 此时就会发生限流. 这个也是监控图上读出来的一些数据, 也符合我们的预期.</p> <p>我们的限流的阈值就是大概设定的处理 RT 在 2 秒左右并发 100 个处理线程. 这个是最初始的设定. 现在 P99 已经来到了 4.5 秒以上. 那有理由相信 RT 平均值此时已经超过了 2 秒. 实际不管相不相信,结果都是如此. 否则不会出现预期之外的限流请求.</p> <h4 id="假想的处理解释模型"><a href="#假想的处理解释模型" class="header-anchor">#</a> 假想的处理解释模型</h4> <p><strong>不符合预期的是</strong>, 明明我们已经做了限流. 在第二天, 在微博上有用户反馈我们的 APP 特别的慢. 并且, 从 PIPE 采集的 C 端监控来看. 用户的平均响应时间都来到了 20 秒到 30 秒左右. 而我们的拍照检查大盘的 RT P99 才 4.5 秒左右. 虽然比较糟糕, 但是也不至于到 C 端监控采集的数据值(20-30秒).</p> <blockquote><p>当时的复盘时, 有大量的请求被限流了. 限流的用户进一步的又发起了新的请求. 导致流量爆涨. 而爆涨的流量又会进一步的加强服务的压力. 最终导致服务进一步的变坏.<br>
从而使用户的响应时间看起来是达到了 20-30 秒.</p></blockquote> <p>这个解释看起来非常的完美. 也比较符合逻辑. 但是这个解释不了为何监控的 P99 在 4.5 秒左右. 而不是 20-30 秒. 监控图不会说谎(但是的确是有可能出错的). 因此针对这个情况我们  <strong>&quot;假想&quot;</strong>  了一种可能的解释模型.</p> <blockquote><ol><li>因为我们看到了服务变慢, 看起来响应时间变高了嘛.</li> <li>同时我们还看到了流量变高. 整体的网卡的流量超级高. 故障的时候流量大概在 150Mbps 到 200 Mbps 左右. 因此, 有可能接收请求很慢. 因为图片数据比较大. 平均 200k 到 250k 左右.</li> <li>而且我们还知道. 使用了 SpringBoot 的 multipart 接收图片的方式. 在进入 controller 前, 图片已经接收完成, 已经 ready了. 换言之: 接收图片的工作由框架层帮我们做了.</li> <li>而之前, 我们有过经验, 在我们的处理代码进入业务代码之前. 有可能会有阻塞点.或者有其它的工作变长也变成了变相的阻塞. 就像这里的框架层帮我们接收图片,而由于超级大的带宽和较差的性能, 我们有理由相信是由于 Spring 在我们的服务性能低下和带宽挤占的情况下(这个后来可以证伪, 因为我们与运维确认了我们的网卡至少是千兆网卡. 后面我们的压测也充分证实了我们的网卡实际是一个万兆网卡). 我们的服务(Tomcat&amp;SpringBoot)在接收图片的时候存在性能瓶颈.导致接收图片变慢.</li> <li>这样我们的代码实际上看起来很快. 实际上很慢. 导致有的请求在处理的时候. 已经积压了很久.</li></ol></blockquote> <p>上面的图片接收积压大概  <strong>&quot;想象&quot;</strong>  的处理模型如下, 只要在这个 Tomcat 中的图片接收处理很慢的话. <strong>那就有可能出现我们说的请求处理前的阻塞</strong>.</p> <p><img src="/img/image-20231126161941-mbj1suk.png" alt="image"></p> <p>这个解释模型, 能够</p> <ol><li><p>解释为什么用户的请求在 C 端看起来很慢, 而在我们 Server 端看起来很快.</p></li> <li><p>因此在用户的请求返回的时候, 有可能用户已经放弃了. 因此又重新发起了请求. 导致请求量往上翻.</p></li> <li><p>而新的请求进来又进一步的加剧了服务的压力. 导致服务的性能进一步的下降.</p> <ol><li>这个可能的猜想原因是图片在接收的中间过程. 也有可能需要资源. 因为我们想象的接收图片过程会很慢. 那内存中可能就会存在大量的接收过程中的图片. 比如半张图片.</li> <li>这样就会导致对内存的挤兑. 反过来就会加剧 GC. 让 CPU 进一步的往上涨. (实际 CPU 并没有涨多少, 内存应该也还好.)</li></ol></li> <li><p>以上会在服务端造成大量的 499. 实际已经正常完成的请求. 我们看来是正常处理了. 但是其实并没有满足用户的需求. 所以用户才疯狂重试.</p></li> <li><p>同时, 在 20:00 的时候, 由于业务处理的时间进一步的恶化. 此时在 RateLimiterAOP 处进行并发限流的计数就会进一步的上升, 从而触发了限流. 也就是在监控图中看到的限流请求.</p></li></ol> <p>以上的解释模型能够比较好的解释整个流程. 这个是因为实际原因导致的最终结果与上面猜测的模型一致. 基本上能对上, 只有部分对不上. 所以这个解释<strong>在接下来的半年时间内被认为是正确</strong>的.</p> <p>**在这个认识下, 我们就认为: **</p> <ol><li><p>**由于在限流的切面处前有一段不可控的图片上传接收操作, 且这个接收时间有可能变得特别的长. 导致限流操作没有有合理的时间节点被执行. 导致请求没有及时的把多余的请求过滤掉. **</p></li> <li><p>**结果有两: **</p> <ol><li>**一个是请求没有及时的被终止掉, 服务器上存在过多的接收图片中间状态的请求. 这个会积压大量的请求, 但是又没有办法进行处理. 这个会变相的加大服务的压力. **</li> <li><strong>另外一个是前面的图片接收时间不可控, 而且有可能变得特别长, 那后面的限流逻辑以及业务处理代码在执行的时候已经有过大的前期延时, 这样我们的请求处理可能是徒劳的, 也就是我们实际看到的处理时间是 4.5 秒, 但是 C 端用户有可能已经过期了(即已经取消, 请求在返回的时候会返回 499).</strong></li></ol></li></ol> <p>基于以上的认识, 才有了去<strong>分析清楚这一段图片上传处理的逻辑</strong>是怎样的. 为什么会花这么多的时候. 是 multipart/form-data 的表单解析有性能瓶颈吗? 我们对于这个认识去做了很多的测试和源代码的阅读,</p> <p>直到后面我们阅读了 Tomcat 的源代码. 以及后面的全链路压测这个误会才完全消除. <strong>找到了真正的性能问题.</strong></p> <h4 id="带着错误的认识继续去优化"><a href="#带着错误的认识继续去优化" class="header-anchor">#</a> 带着错误的认识继续去优化</h4> <blockquote><p>注: 这里的错误认识不是因为我们的知识有问题, 而是整个链路的数据接收确实有其独特之处.</p></blockquote> <h5 id="spring-multipart-form-data的数据接收与处理方式"><a href="#spring-multipart-form-data的数据接收与处理方式" class="header-anchor">#</a> spring multipart/form-data的数据接收与处理方式.</h5> <p>为了搞清楚这个 tomcat/springBoot 是如何接收图片表单的. 我决定去翻阅 Tomcat 的源代码.</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// 代码位置: org.apache.catalina.connector.RequestFacade implements HttpServletRequest </span>

<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getParameter</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>request <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span>sm<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">&quot;requestFacade.nullRequest&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Globals</span><span class="token punctuation">.</span><span class="token constant">IS_SECURITY_ENABLED</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">AccessController</span><span class="token punctuation">.</span><span class="token function">doPrivileged</span><span class="token punctuation">(</span>
            <span class="token keyword">new</span> <span class="token class-name">GetParameterPrivilegedAction</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> request<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getParameter</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>parametersParsed<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">parseParameters</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> coyoteRequest<span class="token punctuation">.</span><span class="token function">getParameters</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><p>​<code>以下是: parseParameters 函数中间的一部分.</code>​</p> <p><img src="/img/image-20231126162037-97uawfp.png" alt="image"></p> <p>以上部分我们找到了表单: <code>multipart/form-data</code>​ 的解析方式. 往里面的 <code>parseParts</code>​ 里面有如下一段代码, 大概知道这个在解析 multipart 的内容时会用到临时文件. 因为这里在查找临时目录.</p> <p><img src="/img/image2023-3-18_0-34-6-20231119112306-dyzl1fs.png" alt=""></p> <p>接着往下, 这个 upload.parseRequest 这里把表单解析成 <code>List&lt;FileItem&gt;</code>​, 然后最终转换成了 part, 存储到了 parts 中.</p> <p><img src="/img/image2023-3-18_0-41-36-20231119112306-yul0rws.png" alt=""></p> <p>这里的核心代码是: <strong>parseRequest</strong>, 我们打开这个函数, 这个函数里面有一个核心代码是在做 stream 的拷贝.</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>Streams.copy(item.openStream(), fileItem.getOutputStream(), true, buffer);
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><img src="/img/image2023-3-18_0-43-31-20231119112306-d2jryy0.png" alt=""></p> <p>这个是从 item.openStream 中拷贝到 fileItem 的 outputStream 中. 再打开这个 fileItem 的输出流的生成:</p> <p><img src="/img/image2023-3-18_0-47-53-20231119112306-8ay0dib.png" alt=""></p> <p><img src="/img/image2023-3-18_0-46-44-20231119112306-tbm8bb0.png" alt=""></p> <p><img src="/img/image2023-3-18_0-47-28-20231119112306-w1mv3rh.png" alt=""></p> <p>到此, 我们看到了. <mark><strong>multipart/form-data 在解析表单的时候, 会用到临时文件</strong></mark>. 格式为: upload_%x_%s.tmp 而且还会在超过了 sizeThreshold 后才会写到磁盘的临时文件上.</p> <p>总结以上:</p> <ol><li>如果参数传递表单的时候, 只要有<strong>主动的获取参数的行为</strong>. 此时就会触发表单类型的参数解析. 这样就会提前把输入的请求解析为临时文件;</li> <li>而且临时文件的大小还有一个阈值, 如果当前的 part 的大小足够小的时候是不会写入到临时文件的.</li> <li>multipart/form-data 的解析是<strong>顺序串行</strong>的, 也就是说如果你要 getPart 得到一个位于中间部分的 part. 那他一定会先把整个输入表单解析完成后才会拿到这个内容. 换言之: 参数的解析一定是有预解析的.</li></ol> <p>以上的 getParam 我们并没有触发. 但是这个 parseParts 是怎么触发的呢.</p> <p>通过实际调试发现, SpringBoot 在启动的时候会执行如下一个 filter: <strong>HiddenHttpMethodFilter</strong>. 这是一个把通用的 POST 请求转换为特定的 method 方式的过滤器.</p> <blockquote><p>就像是为我们中国程序员量身定制的一样. 就像大家所了解的一样. 我们有一种编程模式叫一切都用 POST 的哲学. 具体原因大家也可能有所了解.</p> <ol><li>GET 请求可能被运营商拦截.</li> <li>GET 请求可能被中间设备记录内容.</li> <li>POST 请求更方便处理参数. 比如 @RequestBody 这样的统一解析模式.</li></ol></blockquote> <p>在这个过滤器里面有一个代码:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// 代码位置:  org.springframework.web.filter.HiddenHttpMethodFilter</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">doFilterInternal</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">FilterChain</span> filterChain<span class="token punctuation">)</span>
      <span class="token keyword">throws</span> <span class="token class-name">ServletException</span><span class="token punctuation">,</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>   <span class="token class-name">HttpServletRequest</span> requestToUse <span class="token operator">=</span> request<span class="token punctuation">;</span>

   <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">&quot;POST&quot;</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> request<span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token class-name">WebUtils</span><span class="token punctuation">.</span><span class="token constant">ERROR_EXCEPTION_ATTRIBUTE</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token class-name">String</span> paramValue <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>methodParam<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">hasLength</span><span class="token punctuation">(</span>paramValue<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         requestToUse <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HttpMethodRequestWrapper</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> paramValue<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>  
   filterChain<span class="token punctuation">.</span><span class="token function">doFilter</span><span class="token punctuation">(</span>requestToUse<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>这样就<strong>被动的触发了参数解析的的流程</strong>. 这样就可以在实际执行我们的代码的时候<strong>就是已经解析好的参数与文件</strong>了. 在我们的 Controller 层代码开始运行的时候. 所有的参数解析已经完成了. 而且<strong>整个过程还用到了文件 IO 以及临时文件</strong>. <strong>这个就有可能存在性能问题</strong>. 于是我真的就去测试了下这个 IO 之间的差异.</p> <blockquote><p>注: 实际上除了以上的 Filter 会触发参数解析外, 还有其它的点有可能触发参数解析, 最常见的就是你的 Controller 层代码有做参数绑定. 比如 @RequestParam 此类的注解. 我们的场景没有因为它而触发,只是因为这一类的参数解析绑定的时间更晚而已. 那个时候 HttpServletRequest已经完成参数解析了.</p></blockquote> <h4 id="multipart-form-data的文件传输与httpservletinputstream之间的性能差异"><a href="#multipart-form-data的文件传输与httpservletinputstream之间的性能差异" class="header-anchor">#</a> Multipart/form-data的文件传输与HttpServletInputStream之间的性能差异</h4> <p>在有了以上的知识后, 我们意识到可能的确是我们 ** &quot;猜想解释模型&quot;**  所猜测的那样, 由于是这个前置的参数解析需要文件 IO. 而且整个过程是顺序流式处理的, 如果真的有网络速度过慢的情况那就会出现前置接收文件时间变长的问题. 而正是因为这样就有可能出现 Controller 在处理请求的时候已经有了很大的接收时长. <strong>当返回数据的时候, 自然就已经过期了</strong>.</p> <p>由于这个可能存在的性能问题, 而且这个解析过程用到了文件 IO.</p> <blockquote><p>注: 实际文件IO的这一部分曾经做过调优实验. 分别是两个方向.</p> <ol><li>更优的性能, 我们让临时文件尽量的存储在内存中. 减少内存占用. 提升处理性能.</li> <li>更小的内存占用, 这个是因为上面我所说的解析与接收文件的过程可能需要过多的内存与过慢的处理过程.有内存阻塞嫌疑. 因此尽可以多的使用临时文件,少用内存空间.</li></ol> <p>具体参考: <a href="https://confluence.zhenguanyu.com/pages/viewpage.action?pageId=410732320" target="_blank" rel="noopener noreferrer">16. 2022年12月22日 - solar-thor 上传文件调整缓存到临时文件的阈值<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 实际影响甚微, 这里只作文档完整性引用.</p></blockquote> <p>考虑到后面的文件内容主要用于两个作用:</p> <ul><li>一个是透传给 RPC, 主要是给 Venom 进行图像识别和检查结果.</li> <li>另外是保存到 OSS, 这个目前是后置的异步处理. 即等拍照检查结果出来后才保存到阿里云 OSS.</li></ul> <p>因此, 如果能够及时的把文件透传给两者. 就像这个文章中所说的一样. 如果<strong>直接把 HTTP 输入流能够转到 OSS 存储和 RPC调用, ** 那就可以提升传输效率. 这样也</strong>就能够在前面的图片接收未完成的过程中, 可以进行图片提前处理. 同时也可以减少内存占用**(注: 实际上 multipart 也会使用文件缓存. 实际并不会占用太多的内存), 减少磁盘 IO.</p> <blockquote><p><a href="https://stackoverflow.com/questions/64988683/tomcat-performance-with-spring-boot-api-for-file-upload" target="_blank" rel="noopener noreferrer">https://stackoverflow.com/questions/64988683/tomcat-performance-with-spring-boot-api-for-file-upload<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>There is no other way to do it with multipart. The problem with multipart that to properly segement parts from the requst they need sometimes skipped or be repeatable. That is impossible within memory w/o having memory to explode. Therefore, Commons FileUpload caches them on disk after a certain threshold is reached. Multipart requests are the worst way for that. I highly recommend to use either <code>PUT</code>​​ or <code>POST</code>​​ with content type <code>application/octet-stream</code>​​. You can take the bare request input stream and pass to HttpClient to stream to your backend server. I did this already 5 years ago and it works for gigabytes. I have posted the solution in the Apache HttpClient mailing list.</p> <p>There is one possibility how this could work under specific conditions:</p> <ul><li>All parts are in the correct physical order you want to read</li> <li>Your write to a backend is fast enough to sustain the read from the front</li></ul> <p>Consume the root part and then go over to the next physical one, process the request body lazily. JAX-WS RI (Metro) has a very nice handling of multipart requests for XOP/MTOM. Learn from that because you won't be able to make it any better.</p></blockquote> <p>我们也真实的去<strong>测试了 multipart/form-data 文件上传方式与 HttpServletInputStream 之间的性能差异</strong>. 如下图, 可以看到文件直传的方式大概会比表单方式传输会减少一半的 CPU 占用. 响应时间也会有一定的提升. 在基准测试中大概能提升 20%-50% 的响应时间. 更详细的测试可以在这个测试报告中看到: <a href="https://confluence.zhenguanyu.com/pages/viewpage.action?pageId=434430203" target="_blank" rel="noopener noreferrer">8. 2023年02月17日 - [基准测试] 空图片上传基准测试对比(同步Multipart/同步/异步)<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> , 实际效果比较小. 从上面的实际测试来看, 我们大概能减少一些 CPU 占用. 大概有 10% 左右. 虽然在实际场景测试中: <a href="https://confluence.zhenguanyu.com/pages/viewpage.action?pageId=434424538" target="_blank" rel="noopener noreferrer">7. 2023年02月15日 - [ 场景测试 ]图片上传方式 HttpInputStream 与 Multipart 实际环境上传时间对比.<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><img src="/img/image2023-3-19_11-51-6-20231119112306-myreuww.png" alt=""></p> <p>注意, 以上工作是在我们之前  **&quot;假想的接收模式&quot; ** 的工作方式的前提下, 我们需要这样去改动.</p> <p>但是实际在做全链路的响应时序的时候我们发现并不是这样的. 核心的原因是 <strong>Nginx</strong> 这一个变量的加入.</p> <h4 id="对multipart-form-data及httpservletinputstream进行压测"><a href="#对multipart-form-data及httpservletinputstream进行压测" class="header-anchor">#</a> 对multipart/form-data及HttpServletInputStream进行压测</h4> <p>上面我们对 multipart 的代码从原理到代码以及到基准测试. 进行了全方位的测试, 我们信心满满的认为这个优化一定能起到较大的作用. 并且我们的整个分析过程与结论都是正确的. <strong>但是实际 Nginx 的工作原理与实际效果并不是我们想象的那样</strong>.</p> <p>以下是两者的对比图, 我们想象的是 Nginx 就像是一个水管一样, 源源不断的把输入数据流 &quot;实时&quot; 转发给到我们 Tomcat. 这样才能实时的处理数据. 但是实际上并不是这样的.</p> <p>以下是我们以为的基于流的数据传输的方式. 数据报文的 TCP 报文块 nginx 会实时的把报文转发给我们. 这样就会在传输一个大的请求的时候, 就会出现 Nginx 实时转发.</p> <p>用户的数据给我们, 并且最重要的我们认为是事实的特点是: 数据会实时转发给后端的 upstream, 不管是收到了 1 个字节, 还是收到了 10k 字节. 都会实时的给到我们后端.</p> <p>这样后端的系统才能实时的, 第一时间的接收并解析处理数据. 我们是这么想的, 也是按这个思路去优化的. (如上面的 inputstream 的实时转发).</p> <p><img src="/img/image-20231126163113-oikedk0.png" alt="image"></p> <p>**实际的请求处理方式是这样的: **​<mark><strong>即在没有完整接收到 C 端数据之前是不会转发给到 upstream_server 的. 当 Nginx 把所有的数据接收完成后, 才会把数据转发给后端服务(SpringBoot)</strong></mark> .</p> <p><img src="/img/image-20231126163230-c3hofe7.png" alt="image"></p> <p>下面简述一下这个结果发现的步骤.</p> <h5 id="压测方式"><a href="#压测方式" class="header-anchor">#</a> 压测方式</h5> <p>我们的测试分为了两个步骤, 先进行了基准测试. 然后才进行的全链路压测.</p> <h6 id="基准测试"><a href="#基准测试" class="header-anchor">#</a> 基准测试</h6> <p>因为全链路压测的变量过多, 我们无法准确的测试出系统的性能以及可能的瓶颈所在地方. 因此, 需要先控制变量, 让被测试的系统足够的简单. 这样可以更好的衡量出系统的基准性能.</p> <h6 id="全链路测试"><a href="#全链路测试" class="header-anchor">#</a> 全链路测试</h6> <p>虽然我们基准测试后, 能够得到准确的节点的基准系统, 但是实际链路特别复杂. 最终任何一个环节出现性能瓶颈都会影响系统在用户使用时候的实际性能.</p> <p>因此需要把节点放到<strong>全链路中进行压测</strong>. 最终得到系统的实际响应性能. 以便找出性能瓶颈,进行有针对性的优化.</p> <p><img src="/img/image2023-3-19_20-19-17-20231119112307-nkw53nk.png" alt=""></p> <blockquote><p>注: 整体的性能测试与结果与我们此文的主题不甚相关, 这里只展开介绍其中的对于使用 Jmeter 进行限速与不限速测试之间的差异. 从而说明我们上面的假想的错误.</p></blockquote> <h5 id="对multipart-form-data和httpservletinputstream使用jmeter进行发压测试-无限速"><a href="#对multipart-form-data和httpservletinputstream使用jmeter进行发压测试-无限速" class="header-anchor">#</a> 对multipart/form-data和HttpServletInputStream使用Jmeter进行发压测试.无限速</h5> <p>此时没有什么特别的. 整个过程测试不出什么异常情况. 整体的响应时间比 基准测试会差很多. 基准测试的图片上传不管是 multipart/form-data, 还是 HttpServletInputStream 方式都在 10ms 以内.</p> <p>但是在全链路的测试过程中, 整体时间会来到 40-100ms 左右. 在此不展开.</p> <h5 id="对multipart-form-data和httpservletinputstream使用jmeter进行发压测试-限速"><a href="#对multipart-form-data和httpservletinputstream使用jmeter进行发压测试-限速" class="header-anchor">#</a> 对multipart/form-data和HttpServletInputStream使用Jmeter进行发压测试.限速</h5> <p>当我们使用<strong>限速方式</strong>对上传接口进行压测的时候, 我们发现: 整体的上传时间或者是请求时间会来到 10 秒以上, 但是不管是 Nginx 的 upstream_response_time 还是再下一级的 Ingress 的 upstream_response_time, 时间都在<strong>毫秒响应级</strong>. 这里我们可以直接使用 curl 进行验证.</p> <blockquote><p>测试文件: <a href="https://pic.3gbizhi.com/2020/0826/20200826123917742.jpg" target="_blank" rel="noopener noreferrer">https://pic.3gbizhi.com/2020/0826/20200826123917742.jpg<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></blockquote> <div class="language-java line-numbers-mode"><pre class="language-java"><code>curl <span class="token operator">-</span><span class="token class-name">O</span>  <span class="token operator">--</span>limit<span class="token operator">-</span>rate <span class="token number">100</span>k <span class="token operator">-</span><span class="token class-name">X</span> <span class="token constant">POST</span> <span class="token operator">-</span><span class="token class-name">T</span> <span class="token punctuation">.</span>/<span class="token number">20200826123917742.</span>jpg https<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>xyks<span class="token punctuation">.</span>yuanfudao<span class="token punctuation">.</span>com<span class="token operator">/</span>solar<span class="token operator">-</span>thor<span class="token operator">/</span>api<span class="token operator">/</span>benchmark<span class="token operator">/</span>syncUploadFile
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>请求端的 curl 日志. 花费了 22 秒</p> <p><img src="/img/image2023-3-19_21-24-3-20231119112306-68ub6ng.png" alt=""></p> <p>如下是 <a href="https://sls.console.aliyun.com/lognext/project/op-nginx/logsearch/leo-nginx?encode=base64" target="_blank" rel="noopener noreferrer">nginx<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 的日志, 整体 Nginx 的响应时间是 21.86 秒. 但是 Ingress 的整体响应时间只有 87ms.</p> <p><img src="/img/image2023-3-19_21-29-5-20231119112306-tdfgc4x.png" alt=""></p> <p>下面是在 Ingress 的视角记录下的日志. 在 Ingress 下的 upstream_response_time 是 50ms.</p> <p><img src="/img/image2023-3-19_21-23-36-20231119112307-3yeub8j.png" alt=""></p> <p>不管是 ingress 还是 nginx 都表现出了后端服务的整体处理时间都特别的短. 并不是我们想像的那样的 Nginx&amp;Ingress 会对我们的 HttpRequest 数据进行实时转发.</p> <h4 id="nginx的实际收发数据模型"><a href="#nginx的实际收发数据模型" class="header-anchor">#</a> Nginx的实际收发数据模型</h4> <p>下面是 Nginx 的实际的接收时序图, 图中除了对上面的 request 包的收发规则进行了表示外, 还对相应的<strong>连接与响应时间</strong>进行了详细的标注.</p> <ol><li>request data 拆分为了 Header 与 Body 两个部分的表示.</li> <li>nginx 首先接收到请求的 Header</li> <li>Header 接收完成后接收到的是请求的 Body (也就是这里的图片)</li> <li>Header 在接收完成后, 并不会立即发送给后端服务. 会接着接收 RequestBody;</li> <li><strong>RequestData 在完全接收完成后, 才会向后端发起连接</strong>.</li> <li><strong>连接建立(连接建立时间: upstream_connect_time)后再把数据转发给后端服务 (upstream_server)</strong></li> <li>从发送第一个字节, 到接收到服务端的第一个字节(Header) 的时间记为了: <strong>upstream_head_time</strong></li> <li>从向后端服务 发送第一个字节 到 完全接收到后端发送的最后一个字节. 这个时间记为: <strong>upstream_response_time</strong>;</li> <li>当完全接收到后端服务的 response 后, 才开始向 client 返回 响应数据.</li> <li>从接收到用户的第一个字节到, 完全发送完返回给用户的最后一个字节. 记为: <strong>request_time</strong>;</li></ol> <blockquote><p>具体的日志格式与时序说明可以参考: <a href="https://confluence.zhenguanyu.com/pages/viewpage.action?pageId=449797085" target="_blank" rel="noopener noreferrer">19. Nginx日志格式详细说明<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></blockquote> <p><img src="/img/image-20231126163812-0jbhstf.png" alt="image"></p> <p>这里有了这个 Nginx 的传输特性, 那就说明了<strong>在 tomcat 侧的图片接收的性能是不差的, 而且是特别快</strong>的; 如果有较慢的请求, 这个请求接收的时候实际浪费(阻塞)在了 Nginx 侧的请求接收上, 并没有对我们的 Tomcat 的图片接收有影响, 唯一的影响那就是在 Tomcat 处理图片接收的时候, 已经有一个固定的很大的 delay 了. 这个似乎好像就是我们找的那个固定时延呢? 不管怎样, 它推翻了前面的 Tomcat 的线程假设模型. 下面具体的再回过头来分析一下这个请求过程.</p> <h4 id="真实的限流模型"><a href="#真实的限流模型" class="header-anchor">#</a> 真实的限流模型</h4> <p>我们之前的 Tomcat 的线程模型, 我们大概的给出了一个非常粗糙的线程模型. 再来看一下它是怎样的:</p> <p><img src="/img/Tomcat%E7%BA%BF%E7%A8%8B%E6%B6%88%E8%B4%B9%E6%A8%A1%E5%9E%8B-20231119112307-rfadjbh.png" alt=""></p> <p>在上图中, 我们之前想象的是<strong>在 http 线程中的处理中有一个前置的图片接收</strong>, 由于这个图片接收在高负载下可能变得异常的慢, 这样导致了请求变得特别的长. 最重要的是, 这里引入了一个<strong>固定的时延</strong>. 导致用户的请求在<strong>开始处理的时候可能已经过期</strong>了. 也就是这个图:</p> <p><img src="/img/%E6%83%B3%E8%B1%A1%E7%9A%84%E6%8B%8D%E7%85%A7%E6%A3%80%E6%9F%A5%E7%9A%84%E6%B5%81%E7%A8%8B-20231119112306-cg0y14g.png" alt=""></p> <p>而上面的 nginx 的响应时序告诉我们实际并没有这一个想象的  <strong>&quot;过慢的 接收图片&quot;</strong>  过程. 而在用户的真实的慢请求中, nginx 会有一个过长的图片接收时间. 那上面的 tomcat 的接收图片这个过慢的过程不存在后, 那这个过慢的固定时延是否是 nginx 本身的图片接收这个时间呢?</p> <p>实际并不是的, 我们的<strong>请求在高峰期的确有用户弱网环境下的过长的上传图片时间的请求</strong>. 这个可在 nginx 的访问日志中过滤出来. 这个不管是否是在故障的时候都会有这样的请求. 而不是因为我们故障了, 导致 nginx 的负载变高了, 从而使 nginx的负载在高时的接收图片的时间变长. 这看似乎是一个合理的推理, 但是实际我们查阅了 nginx 相关的日志与监控后发现这个并没有特殊的变化. 最重要的一个论据是, <strong>nginx 的负载远远没有过载</strong>.</p> <p>因此不太可能在故障的时候造成太大的波动.</p> <h5 id="真实的tomcat的线程模型"><a href="#真实的tomcat的线程模型" class="header-anchor">#</a> 真实的tomcat的线程模型.</h5> <p>为了搞清这个 tomcat 的处理过程, 我再次翻阅了 tomcat 的源代码. 之前的只是粗略的看 Request.getParam(xxx) 的方式的研究 multipart/form-data 方式的请求接收, 并没有彻底解决我们的疑问. 上面只是大概解释了图片在我们 &quot;主动的获取&quot; 时才会从一个 ctx 中进行解析, 并生成临时文件给我们用. 那实际上这个 ctx 是在更上一层的 tomcat 的协议处理代码已经在完全接收到整个 requestbody 后已经预解析处理放到了内存(或者硬盘)中了, 还是说这个 request 的处理就是最原始的请求解析的地方呢? 如果 Request.getparam 不是, 那前面的 &quot;假想的协议解析和body存储&quot; 的地方是在哪呢. 他有独立的线程吗, 是处理 <strong>IO线程</strong> 还是处于 <strong>worker 线程</strong>呢.</p> <p>核心的 tomcat 的源码可以看 NIO 的 connector 相关的代码: <a href="https://github.com/apache/tomcat/blob/8.5.x/java/org/apache/tomcat/util/net/NioEndpoint.java" target="_blank" rel="noopener noreferrer">https://github.com/apache/tomcat/blob/8.5.x/java/org/apache/tomcat/util/net/NioEndpoint.java<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>这里不对相关的代码进行展开. 如果要调试相关的代码可以参考: <a href="https://zhuanlan.zhihu.com/p/597375198" target="_blank" rel="noopener noreferrer">Tomcat 源码阅读与调试环境搭建 - 基于Idea和Tomcat 8.5<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>, 这里直接给出真实的 Tomcat 的线程模型与处理流程. 并且这里只解释 NIO 模型相关的流程, 其它的暂时不作介绍.</p> <p><img src="/img/image-20231126164429-3ggtmmr.png" alt="image"></p> <p>整个请求从 Client 端过来, 其流程如下 (<strong>描述不是十分准确, 仅作理解性参考, 实际以 tomcat 源代码为准</strong>):</p> <ul><li><p>一个 HTTP 请求通过 <strong>acceptor</strong> 被接收.</p></li> <li><p>接收后建立的连接, 会放到 Poller 中进行统一的&quot;轮循&quot;, 这里的轮循实际是使用了 selector 的 阻塞的 IO 多路复用的轮循. 效率较高.</p></li> <li><p>在 Poller 读取到真实的 Http 请求数据后, 建立一个 SockerProcessor, 用这个 <strong>SocketProcessor</strong> 进行处理.</p></li> <li><p>而这个处理器(SocketProcessor) 最后包装成一个 HTTP 任务. 最终提交到 HTTP 线程池中进行执行. 在执行前, 会进入到Http Task Queue.</p></li> <li><p>当任务从 HttpTaskQueue 中取出后, 最终才<strong>有机会执行</strong>. 被放入到 Http11NioThreadPool 中进行执行. 而在执行的过程中. 这个过程又可以细分为:</p> <ul><li>HTTP 协议解析. 如 HTTP2 协议升级. HTTPS 协议认证. 或者 websocket 相关的协议升级等.</li> <li>协议处理完成后, 是 Header 相关的接收和处理.</li> <li>然后才是<strong>真实的请求数据解析与包装</strong>. (注: 这里实际很薄, 说薄是说的其数据处理, 协议本身和 tomcat 的结构设计还是很复杂的)</li> <li>最终到达我们的 Servlet.</li></ul></li></ul> <p>这里先说一些简单的结论:</p> <ol><li><strong>协议的解析相关的处理都是在 http 的业务处理线程池中进行的. 我们的 servelt 运行时用到的线程池就是自始至终的线程池. 前面并没有其它的线程池处理.</strong></li> <li>所有的协议解析与处理都是<strong>流式</strong>的, 前面并没有太多的缓冲以及数据的预存储和预处理.</li> <li>上面提到的 ctx 实际也是对 httprequest 中的 inputstream 的相关的简单封装, 而这个 inputstream 也是对 socket inputstream 的数据的简单缓存. 并没有复杂的大缓存.</li></ol> <h4 id="真实的限流模型-2"><a href="#真实的限流模型-2" class="header-anchor">#</a> 真实的限流模型</h4> <p>如上面的分析, 这里出现了一个队列. <strong>这个队列的大小就基本等价于连接数</strong>. 也就是我们上面所说的<strong>默认一万个连接</strong>. 而我们的公司的<strong>默认的配置的 HTTP 线程池的大小为 500</strong>. 再看一下上面的那个粗糙的线程模型:</p> <p><img src="/img/Tomcat%E7%BA%BF%E7%A8%8B%E6%B6%88%E8%B4%B9%E6%A8%A1%E5%9E%8B-20231119112307-1rooyo9.png" alt=""></p> <p>如果和上面的更完整的 TOMCAT 的线程模型相比的话, 这个模型就可以更进一步的进行描述和推测.</p> <p>上面我们说的是由于 &quot;假想的图片接收&quot; 占用了大量的前置时间导致了线程的处理时长变长, 导致了线程挤占. 由于这个前置的图片接收慢理由不成立后, <strong>这个挤占的原因就只剩下了后面的业务代码处理慢导致的 http 线程挤兑</strong>.</p> <p>但是这个 <strong>线程挤兑</strong> 并不能造成 拍照检查相关的线程 产生限流.</p> <blockquote><p>实际产生 &quot;拍照检查线程限流&quot; 的原因还是因为自身的拍照检查相关的线程的处理时长变长的原因. 导致了并发变高, 然后产生了限流.</p></blockquote> <p>但是<strong>请求处理时的固定时延</strong>还有没有找到原因. 从整体的链路来看, 把整个请求过程的请求图再画出来看看:</p> <p><img src="/img/image2023-3-19_23-31-7-20231119112307-d6d1uho.png" alt=""></p> <p>我们已经排除了 nginx 和 ingress 相关的性能问题. 同时也没有了假想中的 tomcat 接收图片慢的问题. 那<strong>唯一有可能产生固定的请求时延的地方</strong>就是上面的: <mark><strong>HTTP TASK QUEUE</strong></mark>.</p> <p><strong>如果请求被放到了请求队列, 没有被及时的限出处理. 那就有可能在处理这个请求的时候已经过期了. (用户已经关闭,或者是超过了一分钟.)</strong></p> <p><strong>而要让这个队列中的任务没有及时的被调度, 那只需要一个原因. 就是 http 线程池已经被占满了. 这个 http 线程池被点满有两个诱因</strong>:</p> <ol><li>请求变多了.</li> <li>请求变慢了.</li></ol> <p>如果以上的任意一个原因出现都有可能把连接池占满. 而这们这里实际上两个因素都出现了. 准确的说, 是<strong>先出现了请求变慢</strong>了. 然后再由于<strong>用户的反复重试导致请求又变多了</strong>. 因此, 我们这里给出的固定时延的解释如下:</p> <blockquote><p>由于请求变慢. 不管是拍照检查的请求变慢, 还是其它的请求变慢. 综合看就是请求变慢导致了整体的请求线程占用变多. 最终把所有的 HTTP 线程池占满. 导致某些任务得不到调度, 其中就包含拍照检查线程.</p></blockquote> <p>综合分析就是:</p> <ol><li>由于<strong>内容接口变慢, 导致了整体的处理时间变长</strong>.</li> <li>整体时间变长后, 其中在 20:00 后拍照检查的接口进一步的变慢. 导致了拍照检查接口的并发超过了设定的 100 并发的阈值. 从而触发了限流.</li> <li>同时, 上面的进一步的恶化变慢后, <strong>HTTP 线程池的线程已经完全被使用完</strong>. 导致后序的拍照检查请求(也有可能有其它的请求) 被<strong>阻塞在 HTTP 请求队列中</strong>. 导致请求的处理时间被延迟了. 而且这个延迟时间可能还不小. 平均达到了 20-30 秒左右.</li></ol> <h4 id="我们能得到什么"><a href="#我们能得到什么" class="header-anchor">#</a> 我们能得到什么</h4> <ol><li>nginx 并没有像我们想象的那样传输我们的数据. 而是<strong>基于完全缓存的策略</strong>进行了. 这是默认的, 可以修改. 但是我们没有. 并且也不推荐.</li> <li><strong>Tomcat 并没有像我们想象的那样. 流式的直接接收 C 端的图片. 而是被 Nginx 缓存完成后, 再转发给我们. 同时我们返回给 Nginx 的响应也没有及时的返回给 C 端. 而是在接收到完整的 response 后再返回给 C 端.</strong></li> <li>tomcat 的默认的线程池大小设置不合理. 这里的 500 在出现问题的时候特别容易阻塞.</li> <li>同时 tomcat 的<strong>线程数与连接数的配比关系</strong>需要重新审视.</li></ol> <h4 id="其它可能的疑问"><a href="#其它可能的疑问" class="header-anchor">#</a> 其它可能的疑问</h4> <blockquote><p>nginx可以修改为实时转发么?</p></blockquote> <ol><li>可以, 但是不建议. 对于那些 websocket 这类的连接, 是面向流的数据传输. 这个时候可能改为实时的转发可以提升系统的响应及时性与性能.</li> <li>我们实测过在限速的基准测试中. 由于数据传输的低速导致 Tocmat 在接收图片的时候由于速率低会接收大量的小包. 导致 CPU 的占用率特别高. 不是高一点点, 是 10 倍量级的增加.</li></ol> <p>当然, 实际我们在基准测试中发现. Nginx 在有缓存的情况下, 收发性能比直接传给 server 要慢得多. 至少也要慢 10 倍的量级. 我们在基准测试中发现. 直接连接 server 上传的响应在 10ms 以内. 而经过了 nginx 后至少是 40ms 到 100ms 左右.</p> <p>这个其中有一个原因是 nginx 本身的缓存的原因带来的延时. 另外一个原因是 nginx 中实际还附带了其它的逻辑. 比如 WAF 的安全检测等.</p> <blockquote><p>拍照检查接口的限流导致用户的加倍的重试, 这个不限流让用户完成请求是不是可以缓减或者避免这个情况.</p></blockquote> <p>当时, 有一个疑问, 如果限流导致了用户反复的重试, 导致流量比平时的多. 那如果不限流. 这个糟糕的情况是否可以避免?</p> <p><strong>实际是不可以的</strong>. 原因是当时的线程挤占已经十分明显了. 那就会使堆积的请求越来越多. 如果拍照检查的相关的请求被处理的更多, 虽然只是在一瞬间. 那后面其它的请求的堆积就会更多.</p> <p><strong>特别是那些快请求</strong>.(当时还没有做快慢请求隔离). 而这些请求由于快, 那往往也意味着很多. 如果过多的请求积压的话. 后面积压的请求会越来越多.</p> <p>此时, <strong>限流恰好是用来快速的让阻塞队列中的请求快速的失败</strong>. 如果没有这个丢弃. 那阻塞的会越来越多, 最后达到 1 万连接. 最终服务拒绝服务.</p> <blockquote><p>既然有限流逻辑在快速的扔请求. 那为什么拍照检查相关的请求的积压没有完全解决掉呢?</p></blockquote> <p>这个还是要再回到那个粗糙的线程图:</p> <p><img src="/img/Tomcat%E7%BA%BF%E7%A8%8B%E6%B6%88%E8%B4%B9%E6%A8%A1%E5%9E%8B-20231119112307-1rooyo9.png" alt=""></p> <p>由于当时限流只扔掉了 check 相关的数据. 但是其它的接口的数据并没有做处理. 或者当时做了处理并没有处理完全和正确. 因为我们没有去管其它的限流值. 我们认为系统是正常的. qps 并没有超. 只是慢了一点对不?</p> <p>那这样的话. <strong>还是会由其它的业务挤占执行线程</strong>. 我们的拍照检查相关的线程就无法进行执行.</p> <p>也就是说: <strong>我们的限流操作相关的 check 处理. 都是被间歇性的阻塞在了 http线程池的任务队列中. 并没有被最大速度的执行去扔掉阻塞的任务</strong>.</p> <blockquote><p>既然不存在假想的 Tomcat 前置过慢的图片上传过程. 那修改 multipart 为 HttpServletInputStream 是否还有意义?</p></blockquote> <p>有的, 一个是这个修改的确有响应时间提升还 CPU 的降低. 这个虽然很小. 但是更实际的意义在于, 我们可以能更可控的去控制输入流. 同时也可以更好的使用接收图片用的缓冲区. 比如<strong>可以使用池化的对象来减少内存的压力和可能的内存吞吐量提升</strong>.</p> <h4 id="可以做哪些改进"><a href="#可以做哪些改进" class="header-anchor">#</a> 可以做哪些改进</h4> <blockquote><p>调整 tomcat 的线程数与连接数.</p></blockquote> <p>建议调整大 tomcat 的线程数. 比较保守的经验值是: <mark><strong>1c 对应到 200 线程. 相应的 4 核的 POD 至少可以调整到 800 线程. 8 核的POD 至少可以调整到 1600 线程</strong></mark>.</p> <blockquote><p>在服务有异常的时候. 可以对服务进行一次流量清理. 让服务快速的恢复到健康状态. (前提是你能识别出在故障后服务处理亚健康的状态)</p></blockquote> <p>类似这里, 我们如果知道原因. 可以对服务进行一些限流清理. 比如直接把所有的请求都限流到 0qps 5秒. 只要一个很短暂的时间. 就可以把服务的阻塞流量清理干净.</p> <blockquote><p>监控 tomcat 的线程池使用率</p></blockquote> <p>监控这一个指标, 在故障的时候可以提供一个参考. 如果可以的话. 可以<strong>监控阻塞队列的大小</strong>. 或者说是<strong>活跃连接数量</strong>. 这个可以知道 tomcat 的实时负载阻塞情况.</p> <p>目前已经有了一个基本的监控指标, 可以参考大盘: <a href="https://grafana.zhenguanyu.com/d/ZFggH8K4k/ye-wu-tomcat-leo-dan-ge?orgId=1&amp;from=1679023677609&amp;to=1679026989107&amp;var-ds=prometheus-online&amp;var-region=All&amp;var-service=solar-thor&amp;var-canary=All&amp;var-instance=10.65.50.120:26666&amp;var-instance=10.64.100.201:26666&amp;var-pod=All" target="_blank" rel="noopener noreferrer">https://grafana.zhenguanyu.com/d/ZFggH8K4k/ye-wu-tomcat-leo-dan-ge?orgId=1&amp;from=1679023677609&amp;to=1679026989107&amp;var-ds=prometheus-online&amp;var-region=All&amp;var-service=solar-thor&amp;var-canary=All&amp;var-instance=10.65.50.120:26666&amp;var-instance=10.64.100.201:26666&amp;var-pod=All<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><img src="/img/image2023-3-20_0-15-43-20231119112306-iikejlr.png" alt=""></p> <h4 id="优化措施"><a href="#优化措施" class="header-anchor">#</a> 优化措施</h4> <h5 id="solar-thor服务快慢请求隔离"><a href="#solar-thor服务快慢请求隔离" class="header-anchor">#</a> solar-thor服务快慢请求隔离</h5> <p>由于 tomcat 的请求处理线程池. 没有单独的线程池为每一个请求进行配置这样就会<strong>使慢的请求与快的请求相互影响</strong>. 比如慢请求占用了线程池. <strong>快的请求有可能会等待特别长的时间</strong>.</p> <blockquote><p>创建新服务</p></blockquote> <p>使用 solar-thor 的服务代码重新创建一个服务.名称建为 solar-thor-api.</p> <blockquote><p>转发规则变更</p></blockquote> <p><img src="/img/image-20231126173720-rq75vb5.png" alt="image"></p> <blockquote><p>快请求接口梳理</p></blockquote> <p>进一步清理 solar-thor 服务上的快请求. 让 solar-thor 的拍照检查慢请求更稳定. 需要进一步的减少 solar-thor 上的快请求.</p> <p>solar-thor 和 solar-thor-api CPU占用:</p> <p><img src="/img/image-20231126173824-31a8iap.png" alt="image"></p> <p><img src="/img/image-20231126173838-fvyukv9.png" alt="image"></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code> <span class="token punctuation">[</span>app<span class="token annotation punctuation">@solar</span><span class="token operator">-</span>thor<span class="token operator">-</span><span class="token number">77f</span><span class="token number">76f</span>bbb4<span class="token operator">-</span><span class="token number">6</span>xfv8 log<span class="token punctuation">]</span>$  cat  solar<span class="token operator">-</span>thor<span class="token punctuation">.</span>log <span class="token operator">|</span> grep restAPI <span class="token operator">|</span> grep 'evaluations<span class="token operator">/</span>questions' <span class="token operator">|</span> grep <span class="token operator">-</span><span class="token class-name">P</span> 'http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>\<span class="token class-name">S</span><span class="token operator">+</span>' <span class="token operator">-</span>o <span class="token operator">|</span> sort <span class="token operator">|</span> uniq <span class="token operator">-</span>c  <span class="token operator">|</span> sort <span class="token operator">-</span>n
      <span class="token number">3</span> http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>solar<span class="token operator">-</span>api<span class="token punctuation">.</span>yuanfudao<span class="token punctuation">.</span>com<span class="token operator">/</span>solar<span class="token operator">-</span>thor<span class="token operator">/</span>iphone<span class="token operator">/</span>evaluations<span class="token operator">/</span>questions<span class="token punctuation">]</span>
      <span class="token number">5</span> http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>xyst<span class="token punctuation">.</span>yuanfudao<span class="token punctuation">.</span>com<span class="token operator">/</span>solar<span class="token operator">-</span>thor<span class="token operator">/</span>iphone<span class="token operator">/</span>tutor<span class="token operator">/</span>evaluations<span class="token operator">/</span>questions<span class="token punctuation">]</span>
      <span class="token number">8</span> http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>xyst<span class="token punctuation">.</span>yuanfudao<span class="token punctuation">.</span>com<span class="token operator">/</span>solar<span class="token operator">-</span>thor<span class="token operator">/</span>android<span class="token operator">/</span>tutor<span class="token operator">/</span>evaluations<span class="token operator">/</span>questions<span class="token punctuation">]</span>
      <span class="token number">9</span> http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>solar<span class="token operator">-</span>api<span class="token punctuation">.</span>yuanfudao<span class="token punctuation">.</span>com<span class="token operator">/</span>solar<span class="token operator">-</span>thor<span class="token operator">/</span>android<span class="token operator">/</span>evaluations<span class="token operator">/</span>questions<span class="token punctuation">]</span>
     <span class="token number">35</span> http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>xyst<span class="token punctuation">.</span>yuanfudao<span class="token punctuation">.</span>com<span class="token operator">/</span>solar<span class="token operator">-</span>thor<span class="token operator">/</span>android<span class="token operator">/</span>evaluations<span class="token operator">/</span>questions<span class="token punctuation">]</span>
    <span class="token number">311</span> http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>xyks<span class="token punctuation">.</span>yuanfudao<span class="token punctuation">.</span>com<span class="token operator">/</span>solar<span class="token operator">-</span>thor<span class="token operator">/</span>iphone<span class="token operator">/</span>evaluations<span class="token operator">/</span>questions<span class="token punctuation">]</span>
   <span class="token number">1390</span> http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>xyks<span class="token punctuation">.</span>yuanfudao<span class="token punctuation">.</span>com<span class="token operator">/</span>solar<span class="token operator">-</span>thor<span class="token operator">/</span>android<span class="token operator">/</span>evaluations<span class="token operator">/</span>questions<span class="token punctuation">]</span>
 
 
<span class="token punctuation">[</span>app<span class="token annotation punctuation">@solar</span><span class="token operator">-</span>thor<span class="token operator">-</span><span class="token number">77f</span><span class="token number">76f</span>bbb4<span class="token operator">-</span><span class="token number">6</span>xfv8 log<span class="token punctuation">]</span>$  cat  solar<span class="token operator">-</span>thor<span class="token punctuation">.</span>log <span class="token operator">|</span> grep restAPI <span class="token operator">|</span> grep 'search<span class="token operator">/</span>chinese' <span class="token operator">|</span> grep <span class="token operator">-</span><span class="token class-name">P</span> 'http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>\<span class="token class-name">S</span><span class="token operator">+</span>' <span class="token operator">-</span>o <span class="token operator">|</span> sort <span class="token operator">|</span> uniq <span class="token operator">-</span>c  <span class="token operator">|</span> sort <span class="token operator">-</span>n
   <span class="token number">2940</span> http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>xyst<span class="token punctuation">.</span>yuanfudao<span class="token punctuation">.</span>com<span class="token operator">/</span>solar<span class="token operator">-</span>thor<span class="token operator">/</span>api<span class="token operator">/</span>search<span class="token operator">/</span>chinese<span class="token punctuation">]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>隔离后效果:</p> <ul><li>P99 比原来的请求稳定多了. 不再会有毛刺到 10 秒的情况.</li></ul> <p><img src="/img/image-20231126173627-1r4g3vd.png" alt="image"></p> <h5 id="_2-增加机器-增加内存大小-优化tomcat线程配置"><a href="#_2-增加机器-增加内存大小-优化tomcat线程配置" class="header-anchor">#</a> 2.增加机器&amp;增加内存大小&amp;优化TOMCAT线程配置</h5> <p>优化点:</p> <ul><li>整体内存大小从 12G 调整为 16G</li> <li>堆内存大小从 9G 调整为 12G</li> <li>限流值从 单机并发 100 → 调整为 120</li> <li>升级 infra-monorepo 版本: 从 <strong>2021.03.0 → 2021.05.0</strong></li></ul> <p><img src="/img/image-20231126174138-4lebel5.png" alt="image"></p> <p>效果对比:</p> <p><img src="/img/image-20231126174201-h43cbre.png" alt="image"></p> <p><img src="/img/image-20231126174215-deyjd4f.png" alt="image"></p> <p><img src="/img/image-20231126174229-n56rnlb.png" alt="image"></p> <p><img src="/img/image-20231126174238-dhhzgmb.png" alt="image"></p> <p><img src="/img/image-20231126174249-fcltip2.png" alt="image"></p> <h5 id="_3-限流并发数计算与优化"><a href="#_3-限流并发数计算与优化" class="header-anchor">#</a> 3.限流并发数计算与优化</h5> <p>**限流开关 - 拍照检查所有接口限流 - 这里配置的是单机的并发数: v = qps * 2 / 20 ; 按响应时间 2s 算. 则 qps = (并发*机器数) / 2; 并发值 = 总QPS * 2 / 机器数 ; 备注: 目前机器数为 20. **</p> <p>最开始的配置为: 100.</p> <p>QPS: 100 并发 *  20 / 2</p> <p>解释: 标称的 qps 为 1000qps.</p> <p>如果 QPS 到 1.4K, 则并发值计算为: 并发值 = 1400*2 / 20 = 140.</p> <p>更精确的计算方法需要根据 TP9X 值进行换算等价替换.</p> <p>然后更统计意义的计算如下:</p> <p>这个平均响应时间为 1.2 秒左右. 则响应时间进行加倍. 或者说是可以承担的并发为 2 倍时. 等价的响应时间为 2.4 秒. 则并发计算为 1400 * 2.4  / 20 = 168.</p> <p>**注: 下图的时间是以 6.14 号的次高峰的日期进行采样的. **</p> <p>​<img src="/img/image-20231126174746-ihzl33n.png" alt="image">按昨天的监控看. 昨晚刚好是在限流值填到 170 的时候. (注: 最开始为130 , 中间调整为 150. 最后调整为 170). 限流消失. 服务变得稳定下来.</p> <p>​<img src="/img/image-20231126174815-ykg70lp.png" alt="image">​</p> <p>如果是 1500QPS , 而响应时间为 1.5 秒的话. 并发限制为: **1500*3/20 = 225. **</p> <p>‍</p> <p>‍</p> <p>‍</p> <p>‍</p> <p>‍</p></div></div>  <div class="page-edit"><div class="edit-link"><a href="https://github.com/xugaoyi/vuepress-theme-vdoing/edit/main/docs/60.工作/7000.工作/5.问题记录/2.口算-全流程复盘-限流原因分析优化与全链路数据传输研究🌟.md" target="_blank" rel="noopener noreferrer">编辑</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <!----> <!----></div> <div class="page-nav-wapper"><div class="page-nav-centre-wrap"><a href="/pages/1b74b9/" class="page-nav-centre page-nav-centre-prev"><div class="tooltip">口算-OOM案例分析-开发过程中的死循环导致的内存OOM🌸</div></a> <a href="/pages/c15cbc/" class="page-nav-centre page-nav-centre-next"><div class="tooltip">口算-拍试卷轮询接口报错🌟</div></a></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/pages/1b74b9/" class="prev">口算-OOM案例分析-开发过程中的死循环导致的内存OOM🌸</a></span> <span class="next"><a href="/pages/c15cbc/">口算-拍试卷轮询接口报错🌟</a>→
      </span></p></div></div></div> <!----></main></div> <div class="footer"><div class="icons"><a href="mailto:1174520425@qq.com" title="发邮件" target="_blank" class="iconfont icon-youjian"></a><a href="https://github.com/nanodaemony" title="GitHub" target="_blank" class="iconfont icon-github"></a></div> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="本站主题">Vdoing</a> 
    | Copyright © 2019-2025
    <span>达尔文的猹 | MIT License</span></div> <div class="buttons"><div title="返回顶部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去评论" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主题模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          跟随系统
        </li><li class="iconfont icon-rijianmoshi">
          浅色模式
        </li><li class="iconfont icon-yejianmoshi">
          深色模式
        </li><li class="iconfont icon-yuedu">
          阅读模式
        </li></ul></div></div> <!----> <!----> <!----></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.3f3e0e10.js" defer></script><script src="/assets/js/2.e9fcb30c.js" defer></script><script src="/assets/js/3.1998f389.js" defer></script><script src="/assets/js/244.58b0b21d.js" defer></script>
  </body>
</html>
