<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>类文件结构与类加载机制 | Pangolin</title>
    <meta name="generator" content="VuePress 1.9.5">
    <link rel="icon" href="/img/favicon.ico">
    <meta name="description" content="大道至简">
    <meta name="keywords" content="前端博客,个人技术博客,前端,前端开发,前端框架,web前端,前端面试题,技术文档,学习,面试,JavaScript,js,ES6,TypeScript,vue,python,css3,html5,Node,git,github,markdown">
    <meta name="baidu-site-verification" content="7F55weZDDc">
    <meta name="theme-color" content="#11a8cd">
    
    <link rel="preload" href="/assets/css/0.styles.76d9f797.css" as="style"><link rel="preload" href="/assets/js/app.5bc2c979.js" as="script"><link rel="preload" href="/assets/js/2.eccd4273.js" as="script"><link rel="preload" href="/assets/js/168.e388905a.js" as="script"><link rel="prefetch" href="/assets/js/10.8a8038d8.js"><link rel="prefetch" href="/assets/js/100.db890b43.js"><link rel="prefetch" href="/assets/js/101.9b9a913e.js"><link rel="prefetch" href="/assets/js/102.b98098b4.js"><link rel="prefetch" href="/assets/js/103.20eafae5.js"><link rel="prefetch" href="/assets/js/104.5f942f86.js"><link rel="prefetch" href="/assets/js/105.a443c173.js"><link rel="prefetch" href="/assets/js/106.6530e112.js"><link rel="prefetch" href="/assets/js/107.7b05a1d1.js"><link rel="prefetch" href="/assets/js/108.8c45adc4.js"><link rel="prefetch" href="/assets/js/109.ea29e43c.js"><link rel="prefetch" href="/assets/js/11.8d2b228f.js"><link rel="prefetch" href="/assets/js/110.0765054b.js"><link rel="prefetch" href="/assets/js/111.ae06b85d.js"><link rel="prefetch" href="/assets/js/112.b27bb80e.js"><link rel="prefetch" href="/assets/js/113.592e5b3f.js"><link rel="prefetch" href="/assets/js/114.677c3c60.js"><link rel="prefetch" href="/assets/js/115.fb35062d.js"><link rel="prefetch" href="/assets/js/116.19de2d57.js"><link rel="prefetch" href="/assets/js/117.ac783334.js"><link rel="prefetch" href="/assets/js/118.06b27dd3.js"><link rel="prefetch" href="/assets/js/119.cf6bb932.js"><link rel="prefetch" href="/assets/js/12.8764d408.js"><link rel="prefetch" href="/assets/js/120.ba8e09a5.js"><link rel="prefetch" href="/assets/js/121.bc501a72.js"><link rel="prefetch" href="/assets/js/122.c9a3dd47.js"><link rel="prefetch" href="/assets/js/123.b474c20b.js"><link rel="prefetch" href="/assets/js/124.f405a8c5.js"><link rel="prefetch" href="/assets/js/125.24083f67.js"><link rel="prefetch" href="/assets/js/126.3c5c6c33.js"><link rel="prefetch" href="/assets/js/127.b561056f.js"><link rel="prefetch" href="/assets/js/128.58891fb1.js"><link rel="prefetch" href="/assets/js/129.5073fbfd.js"><link rel="prefetch" href="/assets/js/13.1034e1a1.js"><link rel="prefetch" href="/assets/js/130.ca12ca1d.js"><link rel="prefetch" href="/assets/js/131.8e520e7f.js"><link rel="prefetch" href="/assets/js/132.0f186ee2.js"><link rel="prefetch" href="/assets/js/133.1d8479f7.js"><link rel="prefetch" href="/assets/js/134.9c30d69b.js"><link rel="prefetch" href="/assets/js/135.91463dab.js"><link rel="prefetch" href="/assets/js/136.5e57454a.js"><link rel="prefetch" href="/assets/js/137.1d4e51f0.js"><link rel="prefetch" href="/assets/js/138.6cd3ac7f.js"><link rel="prefetch" href="/assets/js/139.7bd789a6.js"><link rel="prefetch" href="/assets/js/14.ead46968.js"><link rel="prefetch" href="/assets/js/140.e1d92390.js"><link rel="prefetch" href="/assets/js/141.23e11057.js"><link rel="prefetch" href="/assets/js/142.c8cc0f38.js"><link rel="prefetch" href="/assets/js/143.fc738cb7.js"><link rel="prefetch" href="/assets/js/144.67c64203.js"><link rel="prefetch" href="/assets/js/145.cc73ed45.js"><link rel="prefetch" href="/assets/js/146.adaac4c0.js"><link rel="prefetch" href="/assets/js/147.0e83b5c1.js"><link rel="prefetch" href="/assets/js/148.1f253a46.js"><link rel="prefetch" href="/assets/js/149.ab428593.js"><link rel="prefetch" href="/assets/js/15.198f32e1.js"><link rel="prefetch" href="/assets/js/150.64cd514e.js"><link rel="prefetch" href="/assets/js/151.ca1ae55a.js"><link rel="prefetch" href="/assets/js/152.4119b23d.js"><link rel="prefetch" href="/assets/js/153.ed663263.js"><link rel="prefetch" href="/assets/js/154.71b836f6.js"><link rel="prefetch" href="/assets/js/155.c47e2e88.js"><link rel="prefetch" href="/assets/js/156.3e91e0f4.js"><link rel="prefetch" href="/assets/js/157.811b1421.js"><link rel="prefetch" href="/assets/js/158.71193c19.js"><link rel="prefetch" href="/assets/js/159.f09778fd.js"><link rel="prefetch" href="/assets/js/16.03096de2.js"><link rel="prefetch" href="/assets/js/160.15d99de4.js"><link rel="prefetch" href="/assets/js/161.813166a0.js"><link rel="prefetch" href="/assets/js/162.c52bbf77.js"><link rel="prefetch" href="/assets/js/163.ada6991a.js"><link rel="prefetch" href="/assets/js/164.d8ceba57.js"><link rel="prefetch" href="/assets/js/165.a645ef3a.js"><link rel="prefetch" href="/assets/js/166.995d24ad.js"><link rel="prefetch" href="/assets/js/167.d7278e80.js"><link rel="prefetch" href="/assets/js/169.52edabbb.js"><link rel="prefetch" href="/assets/js/17.a49f9c19.js"><link rel="prefetch" href="/assets/js/170.0b62c5b4.js"><link rel="prefetch" href="/assets/js/171.017c8997.js"><link rel="prefetch" href="/assets/js/172.f0763c39.js"><link rel="prefetch" href="/assets/js/173.c961bf43.js"><link rel="prefetch" href="/assets/js/174.395224c0.js"><link rel="prefetch" href="/assets/js/175.52fbdc96.js"><link rel="prefetch" href="/assets/js/176.14e0a3b2.js"><link rel="prefetch" href="/assets/js/177.78f7d89f.js"><link rel="prefetch" href="/assets/js/178.c08bdd65.js"><link rel="prefetch" href="/assets/js/179.b634397c.js"><link rel="prefetch" href="/assets/js/18.9786a034.js"><link rel="prefetch" href="/assets/js/180.284b6c99.js"><link rel="prefetch" href="/assets/js/181.b4744ee7.js"><link rel="prefetch" href="/assets/js/182.8bfd08cd.js"><link rel="prefetch" href="/assets/js/183.59b0b92b.js"><link rel="prefetch" href="/assets/js/184.a5fae95c.js"><link rel="prefetch" href="/assets/js/185.dcf55c72.js"><link rel="prefetch" href="/assets/js/186.6b1cf319.js"><link rel="prefetch" href="/assets/js/187.312708d0.js"><link rel="prefetch" href="/assets/js/188.71de21d0.js"><link rel="prefetch" href="/assets/js/189.7d72c108.js"><link rel="prefetch" href="/assets/js/19.089d6618.js"><link rel="prefetch" href="/assets/js/190.85dce0bd.js"><link rel="prefetch" href="/assets/js/191.08f7136b.js"><link rel="prefetch" href="/assets/js/192.6a155217.js"><link rel="prefetch" href="/assets/js/193.64f71670.js"><link rel="prefetch" href="/assets/js/194.c4d60c72.js"><link rel="prefetch" href="/assets/js/195.748850e9.js"><link rel="prefetch" href="/assets/js/196.887ef31c.js"><link rel="prefetch" href="/assets/js/197.4473c177.js"><link rel="prefetch" href="/assets/js/198.ea53a990.js"><link rel="prefetch" href="/assets/js/199.886f6490.js"><link rel="prefetch" href="/assets/js/20.a52783e8.js"><link rel="prefetch" href="/assets/js/200.7619a798.js"><link rel="prefetch" href="/assets/js/201.d3f5de5f.js"><link rel="prefetch" href="/assets/js/202.ed4c18cc.js"><link rel="prefetch" href="/assets/js/203.7937068e.js"><link rel="prefetch" href="/assets/js/204.3dbdd61c.js"><link rel="prefetch" href="/assets/js/205.52bc6fdf.js"><link rel="prefetch" href="/assets/js/206.4393998f.js"><link rel="prefetch" href="/assets/js/207.ec8e121d.js"><link rel="prefetch" href="/assets/js/208.f54d4e42.js"><link rel="prefetch" href="/assets/js/209.1bc5d06d.js"><link rel="prefetch" href="/assets/js/21.2e3bed21.js"><link rel="prefetch" href="/assets/js/210.2a3dc088.js"><link rel="prefetch" href="/assets/js/211.7084c526.js"><link rel="prefetch" href="/assets/js/212.de742850.js"><link rel="prefetch" href="/assets/js/213.fc775028.js"><link rel="prefetch" href="/assets/js/214.e338168c.js"><link rel="prefetch" href="/assets/js/215.3e89c57e.js"><link rel="prefetch" href="/assets/js/216.ecfe7587.js"><link rel="prefetch" href="/assets/js/217.14dcd4a2.js"><link rel="prefetch" href="/assets/js/218.ee7d57f7.js"><link rel="prefetch" href="/assets/js/219.c263c1e8.js"><link rel="prefetch" href="/assets/js/22.3d09766f.js"><link rel="prefetch" href="/assets/js/220.33f2bfd2.js"><link rel="prefetch" href="/assets/js/221.cd55e739.js"><link rel="prefetch" href="/assets/js/222.63107647.js"><link rel="prefetch" href="/assets/js/223.768ef403.js"><link rel="prefetch" href="/assets/js/224.54357078.js"><link rel="prefetch" href="/assets/js/225.b8e46582.js"><link rel="prefetch" href="/assets/js/226.1d0dcae9.js"><link rel="prefetch" href="/assets/js/227.a351c0a1.js"><link rel="prefetch" href="/assets/js/228.f7b8c278.js"><link rel="prefetch" href="/assets/js/229.8e4aba4d.js"><link rel="prefetch" href="/assets/js/23.b87e3933.js"><link rel="prefetch" href="/assets/js/230.186bd7a5.js"><link rel="prefetch" href="/assets/js/231.dad483e1.js"><link rel="prefetch" href="/assets/js/232.26555358.js"><link rel="prefetch" href="/assets/js/233.658ba0e4.js"><link rel="prefetch" href="/assets/js/234.7994cee0.js"><link rel="prefetch" href="/assets/js/235.3934d057.js"><link rel="prefetch" href="/assets/js/236.59cb6eac.js"><link rel="prefetch" href="/assets/js/237.baa1c655.js"><link rel="prefetch" href="/assets/js/238.8ee9f8ae.js"><link rel="prefetch" href="/assets/js/239.b0fe3966.js"><link rel="prefetch" href="/assets/js/24.afe2a3c4.js"><link rel="prefetch" href="/assets/js/240.d06483fa.js"><link rel="prefetch" href="/assets/js/241.81a2223e.js"><link rel="prefetch" href="/assets/js/242.8f6eee74.js"><link rel="prefetch" href="/assets/js/243.874461fa.js"><link rel="prefetch" href="/assets/js/244.ec0bb622.js"><link rel="prefetch" href="/assets/js/245.2ecf61f8.js"><link rel="prefetch" href="/assets/js/246.e7f6e55c.js"><link rel="prefetch" href="/assets/js/247.f32a1a4b.js"><link rel="prefetch" href="/assets/js/248.4302c4d8.js"><link rel="prefetch" href="/assets/js/249.9b0a4d9f.js"><link rel="prefetch" href="/assets/js/25.a22777b8.js"><link rel="prefetch" href="/assets/js/250.1295326c.js"><link rel="prefetch" href="/assets/js/251.d1cdb160.js"><link rel="prefetch" href="/assets/js/252.4e9d56fe.js"><link rel="prefetch" href="/assets/js/253.5a23b42d.js"><link rel="prefetch" href="/assets/js/254.8777547c.js"><link rel="prefetch" href="/assets/js/255.b8825033.js"><link rel="prefetch" href="/assets/js/256.0ee3689d.js"><link rel="prefetch" href="/assets/js/257.4a684795.js"><link rel="prefetch" href="/assets/js/258.ca696e72.js"><link rel="prefetch" href="/assets/js/259.fdf867d0.js"><link rel="prefetch" href="/assets/js/26.c84357e5.js"><link rel="prefetch" href="/assets/js/260.d35d60d5.js"><link rel="prefetch" href="/assets/js/261.c162cef5.js"><link rel="prefetch" href="/assets/js/262.8cbc5289.js"><link rel="prefetch" href="/assets/js/263.c05bbe4c.js"><link rel="prefetch" href="/assets/js/264.2e7c8f69.js"><link rel="prefetch" href="/assets/js/265.372a0632.js"><link rel="prefetch" href="/assets/js/266.49c38b9d.js"><link rel="prefetch" href="/assets/js/267.f7406d35.js"><link rel="prefetch" href="/assets/js/268.c7846c3e.js"><link rel="prefetch" href="/assets/js/269.e30bdc7f.js"><link rel="prefetch" href="/assets/js/27.0b3da7b9.js"><link rel="prefetch" href="/assets/js/270.8a3786ce.js"><link rel="prefetch" href="/assets/js/271.4b771c95.js"><link rel="prefetch" href="/assets/js/272.c710d2d6.js"><link rel="prefetch" href="/assets/js/273.43fb2872.js"><link rel="prefetch" href="/assets/js/274.d8a9dff2.js"><link rel="prefetch" href="/assets/js/275.c2812b68.js"><link rel="prefetch" href="/assets/js/276.406503c4.js"><link rel="prefetch" href="/assets/js/277.10c29e54.js"><link rel="prefetch" href="/assets/js/278.5f4b657a.js"><link rel="prefetch" href="/assets/js/279.84b86ae8.js"><link rel="prefetch" href="/assets/js/28.1c1fd5a6.js"><link rel="prefetch" href="/assets/js/280.8a2ba3b2.js"><link rel="prefetch" href="/assets/js/281.4a7f2b91.js"><link rel="prefetch" href="/assets/js/282.7b2f2668.js"><link rel="prefetch" href="/assets/js/283.455f93df.js"><link rel="prefetch" href="/assets/js/284.1a448478.js"><link rel="prefetch" href="/assets/js/285.19eebc05.js"><link rel="prefetch" href="/assets/js/286.5423cfc6.js"><link rel="prefetch" href="/assets/js/287.afbe115e.js"><link rel="prefetch" href="/assets/js/288.d4f4f247.js"><link rel="prefetch" href="/assets/js/289.da477465.js"><link rel="prefetch" href="/assets/js/29.103209e9.js"><link rel="prefetch" href="/assets/js/290.abf99800.js"><link rel="prefetch" href="/assets/js/291.71fe3ae6.js"><link rel="prefetch" href="/assets/js/292.455169ca.js"><link rel="prefetch" href="/assets/js/293.d23ffed4.js"><link rel="prefetch" href="/assets/js/294.1a753204.js"><link rel="prefetch" href="/assets/js/295.badfa110.js"><link rel="prefetch" href="/assets/js/296.344206a1.js"><link rel="prefetch" href="/assets/js/297.29e4f914.js"><link rel="prefetch" href="/assets/js/298.f9db8940.js"><link rel="prefetch" href="/assets/js/299.2253c1e7.js"><link rel="prefetch" href="/assets/js/3.e5ca1c51.js"><link rel="prefetch" href="/assets/js/30.e76a827e.js"><link rel="prefetch" href="/assets/js/300.e5bfd607.js"><link rel="prefetch" href="/assets/js/301.cc3e786e.js"><link rel="prefetch" href="/assets/js/302.7fdc62b6.js"><link rel="prefetch" href="/assets/js/303.b1db491f.js"><link rel="prefetch" href="/assets/js/304.18917b0f.js"><link rel="prefetch" href="/assets/js/305.d352aeb5.js"><link rel="prefetch" href="/assets/js/306.8bc72324.js"><link rel="prefetch" href="/assets/js/307.854b4037.js"><link rel="prefetch" href="/assets/js/308.6a0e4a18.js"><link rel="prefetch" href="/assets/js/309.d184df6f.js"><link rel="prefetch" href="/assets/js/31.7e4b200d.js"><link rel="prefetch" href="/assets/js/310.8e0af1ab.js"><link rel="prefetch" href="/assets/js/311.00bae85e.js"><link rel="prefetch" href="/assets/js/312.bc92cba9.js"><link rel="prefetch" href="/assets/js/313.8f70a987.js"><link rel="prefetch" href="/assets/js/314.8f190f1f.js"><link rel="prefetch" href="/assets/js/315.4b8506c7.js"><link rel="prefetch" href="/assets/js/316.5911c1f9.js"><link rel="prefetch" href="/assets/js/317.58cca547.js"><link rel="prefetch" href="/assets/js/318.4f23c053.js"><link rel="prefetch" href="/assets/js/319.941f5d3e.js"><link rel="prefetch" href="/assets/js/32.9c188bac.js"><link rel="prefetch" href="/assets/js/320.a3f15adc.js"><link rel="prefetch" href="/assets/js/321.14c74686.js"><link rel="prefetch" href="/assets/js/322.5f7b1b87.js"><link rel="prefetch" href="/assets/js/323.ab05eccb.js"><link rel="prefetch" href="/assets/js/324.292806ba.js"><link rel="prefetch" href="/assets/js/325.b96314dd.js"><link rel="prefetch" href="/assets/js/326.3d8f6329.js"><link rel="prefetch" href="/assets/js/327.49cf9268.js"><link rel="prefetch" href="/assets/js/328.be56ec05.js"><link rel="prefetch" href="/assets/js/329.8c390111.js"><link rel="prefetch" href="/assets/js/33.2435d797.js"><link rel="prefetch" href="/assets/js/330.b961e5fd.js"><link rel="prefetch" href="/assets/js/331.24ce8c0b.js"><link rel="prefetch" href="/assets/js/332.115b7546.js"><link rel="prefetch" href="/assets/js/333.957e0728.js"><link rel="prefetch" href="/assets/js/334.68825ff7.js"><link rel="prefetch" href="/assets/js/335.b662f33d.js"><link rel="prefetch" href="/assets/js/336.d8818747.js"><link rel="prefetch" href="/assets/js/337.9d24e096.js"><link rel="prefetch" href="/assets/js/338.3b669645.js"><link rel="prefetch" href="/assets/js/339.51cc2773.js"><link rel="prefetch" href="/assets/js/34.d57f3bb9.js"><link rel="prefetch" href="/assets/js/340.28cfadfb.js"><link rel="prefetch" href="/assets/js/341.4e6b0bdd.js"><link rel="prefetch" href="/assets/js/342.310c1a3e.js"><link rel="prefetch" href="/assets/js/343.0e61677a.js"><link rel="prefetch" href="/assets/js/344.340a39bd.js"><link rel="prefetch" href="/assets/js/345.fff51053.js"><link rel="prefetch" href="/assets/js/346.93c709db.js"><link rel="prefetch" href="/assets/js/347.dc863ac9.js"><link rel="prefetch" href="/assets/js/348.13c191d7.js"><link rel="prefetch" href="/assets/js/349.8aea43f7.js"><link rel="prefetch" href="/assets/js/35.e20cb4ac.js"><link rel="prefetch" href="/assets/js/350.49b72b87.js"><link rel="prefetch" href="/assets/js/351.3e6e6379.js"><link rel="prefetch" href="/assets/js/352.e2524a53.js"><link rel="prefetch" href="/assets/js/353.b71b2a33.js"><link rel="prefetch" href="/assets/js/354.a4720902.js"><link rel="prefetch" href="/assets/js/355.5a8970e1.js"><link rel="prefetch" href="/assets/js/356.353f0a9c.js"><link rel="prefetch" href="/assets/js/357.648060ca.js"><link rel="prefetch" href="/assets/js/358.643b787c.js"><link rel="prefetch" href="/assets/js/359.b1bc0c81.js"><link rel="prefetch" href="/assets/js/36.6a79f8ad.js"><link rel="prefetch" href="/assets/js/360.748faf07.js"><link rel="prefetch" href="/assets/js/361.cddfbfab.js"><link rel="prefetch" href="/assets/js/362.46990756.js"><link rel="prefetch" href="/assets/js/363.f4846a88.js"><link rel="prefetch" href="/assets/js/364.e7fd6af2.js"><link rel="prefetch" href="/assets/js/365.41693194.js"><link rel="prefetch" href="/assets/js/366.60931b9e.js"><link rel="prefetch" href="/assets/js/367.c7a310db.js"><link rel="prefetch" href="/assets/js/368.cae4028a.js"><link rel="prefetch" href="/assets/js/369.e3bcd2c2.js"><link rel="prefetch" href="/assets/js/37.4ccc31d6.js"><link rel="prefetch" href="/assets/js/370.2ea3b181.js"><link rel="prefetch" href="/assets/js/371.978056e5.js"><link rel="prefetch" href="/assets/js/372.aa13db83.js"><link rel="prefetch" href="/assets/js/373.f3791afe.js"><link rel="prefetch" href="/assets/js/374.b108af2d.js"><link rel="prefetch" href="/assets/js/375.dc75d5b1.js"><link rel="prefetch" href="/assets/js/376.8a663da6.js"><link rel="prefetch" href="/assets/js/38.9816dff1.js"><link rel="prefetch" href="/assets/js/39.03d551c0.js"><link rel="prefetch" href="/assets/js/4.611d42c4.js"><link rel="prefetch" href="/assets/js/40.ce442bf2.js"><link rel="prefetch" href="/assets/js/41.d596832c.js"><link rel="prefetch" href="/assets/js/42.29309c56.js"><link rel="prefetch" href="/assets/js/43.d47b7a06.js"><link rel="prefetch" href="/assets/js/44.87716237.js"><link rel="prefetch" href="/assets/js/45.d5ef3d2b.js"><link rel="prefetch" href="/assets/js/46.21cef7ff.js"><link rel="prefetch" href="/assets/js/47.75c67941.js"><link rel="prefetch" href="/assets/js/48.b94040d3.js"><link rel="prefetch" href="/assets/js/49.507fb28d.js"><link rel="prefetch" href="/assets/js/5.e6d623f8.js"><link rel="prefetch" href="/assets/js/50.4013f17e.js"><link rel="prefetch" href="/assets/js/51.6e81cba9.js"><link rel="prefetch" href="/assets/js/52.07e4aadf.js"><link rel="prefetch" href="/assets/js/53.1d325b49.js"><link rel="prefetch" href="/assets/js/54.79ff5e8c.js"><link rel="prefetch" href="/assets/js/55.77160bdd.js"><link rel="prefetch" href="/assets/js/56.a3041056.js"><link rel="prefetch" href="/assets/js/57.b7c0602c.js"><link rel="prefetch" href="/assets/js/58.a4af9a23.js"><link rel="prefetch" href="/assets/js/59.61a80d59.js"><link rel="prefetch" href="/assets/js/6.dc644b59.js"><link rel="prefetch" href="/assets/js/60.4ae1e1f0.js"><link rel="prefetch" href="/assets/js/61.b733273a.js"><link rel="prefetch" href="/assets/js/62.63b8d77d.js"><link rel="prefetch" href="/assets/js/63.46a84bd8.js"><link rel="prefetch" href="/assets/js/64.ce8c5891.js"><link rel="prefetch" href="/assets/js/65.8abe6836.js"><link rel="prefetch" href="/assets/js/66.6f9a9cf9.js"><link rel="prefetch" href="/assets/js/67.6bc415b9.js"><link rel="prefetch" href="/assets/js/68.b100ab24.js"><link rel="prefetch" href="/assets/js/69.5d9ed0d7.js"><link rel="prefetch" href="/assets/js/7.7da3e776.js"><link rel="prefetch" href="/assets/js/70.f213eb63.js"><link rel="prefetch" href="/assets/js/71.9dbed333.js"><link rel="prefetch" href="/assets/js/72.1129fb4b.js"><link rel="prefetch" href="/assets/js/73.7459f6b0.js"><link rel="prefetch" href="/assets/js/74.2364da14.js"><link rel="prefetch" href="/assets/js/75.72e5d347.js"><link rel="prefetch" href="/assets/js/76.7f1bc93d.js"><link rel="prefetch" href="/assets/js/77.7f9bb46a.js"><link rel="prefetch" href="/assets/js/78.16497536.js"><link rel="prefetch" href="/assets/js/79.1598ba88.js"><link rel="prefetch" href="/assets/js/8.91ce867e.js"><link rel="prefetch" href="/assets/js/80.d7595902.js"><link rel="prefetch" href="/assets/js/81.c808c887.js"><link rel="prefetch" href="/assets/js/82.49dc6011.js"><link rel="prefetch" href="/assets/js/83.6e151bae.js"><link rel="prefetch" href="/assets/js/84.9d3d5086.js"><link rel="prefetch" href="/assets/js/85.2c4d111e.js"><link rel="prefetch" href="/assets/js/86.cff98baa.js"><link rel="prefetch" href="/assets/js/87.655584a0.js"><link rel="prefetch" href="/assets/js/88.109ad4f1.js"><link rel="prefetch" href="/assets/js/89.46f7ed5c.js"><link rel="prefetch" href="/assets/js/9.8a2e5f54.js"><link rel="prefetch" href="/assets/js/90.1a91e9ca.js"><link rel="prefetch" href="/assets/js/91.26a98055.js"><link rel="prefetch" href="/assets/js/92.6ed9cb6e.js"><link rel="prefetch" href="/assets/js/93.14253412.js"><link rel="prefetch" href="/assets/js/94.54415bcf.js"><link rel="prefetch" href="/assets/js/95.0e1c9d0a.js"><link rel="prefetch" href="/assets/js/96.8654188f.js"><link rel="prefetch" href="/assets/js/97.d338a1d8.js"><link rel="prefetch" href="/assets/js/98.efa1e5c5.js"><link rel="prefetch" href="/assets/js/99.83fa6575.js">
    <link rel="stylesheet" href="/assets/css/0.styles.76d9f797.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu"><header class="navbar blur"><div title="目录" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/img/magic.png" alt="Pangolin" class="logo"> <span class="site-name can-hide">Pangolin</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">🏡首页</a></div><div class="nav-item"><a href="/basic/" class="nav-link">基础</a></div><div class="nav-item"><a href="/develop/" class="nav-link">开发</a></div><div class="nav-item"><a href="/middleware/" class="nav-link">中间件</a></div><div class="nav-item"><a href="/algorithm/" class="nav-link">算法</a></div><div class="nav-item"><a href="/books/" class="nav-link">读书笔记</a></div><div class="nav-item"><a href="/pangolin/" class="nav-link">个人</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="前端" class="dropdown-title"><a href="/web/" class="link-title">前端</a> <span class="title" style="display:none;">前端</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>前端文章</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/pages/8143cc480faf9a11/" class="nav-link">JavaScript</a></li><li class="dropdown-subitem"><a href="/operating_system/" class="nav-link">JavaScript</a></li></ul></li><li class="dropdown-item"><h4>学习笔记</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/note/javascript/" class="nav-link">《JavaScript教程》</a></li><li class="dropdown-subitem"><a href="/note/js/" class="nav-link">《JavaScript高级程序设计》</a></li><li class="dropdown-subitem"><a href="/note/es6/" class="nav-link">《ES6 教程》</a></li><li class="dropdown-subitem"><a href="/note/vue/" class="nav-link">《Vue》</a></li><li class="dropdown-subitem"><a href="/note/react/" class="nav-link">《React》</a></li><li class="dropdown-subitem"><a href="/note/typescript-axios/" class="nav-link">《TypeScript 从零实现 axios》</a></li><li class="dropdown-subitem"><a href="/note/git/" class="nav-link">《Git》</a></li><li class="dropdown-subitem"><a href="/pages/51afd6/" class="nav-link">TypeScript</a></li><li class="dropdown-subitem"><a href="/pages/4643cd/" class="nav-link">JS设计模式总结</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="基础" class="dropdown-title"><a href="/basic/" class="link-title">基础</a> <span class="title" style="display:none;">基础</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>前端文章</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/pages/8143cc480faf9a11/" class="nav-link">JavaScript</a></li></ul></li><li class="dropdown-item"><h4>学习笔记</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/note/javascript/" class="nav-link">《JavaScript教程》</a></li><li class="dropdown-subitem"><a href="/note/js/" class="nav-link">《JavaScript高级程序设计》</a></li><li class="dropdown-subitem"><a href="/note/es6/" class="nav-link">《ES6 教程》</a></li><li class="dropdown-subitem"><a href="/note/vue/" class="nav-link">《Vue》</a></li><li class="dropdown-subitem"><a href="/note/react/" class="nav-link">《React》</a></li><li class="dropdown-subitem"><a href="/note/typescript-axios/" class="nav-link">《TypeScript 从零实现 axios》</a></li><li class="dropdown-subitem"><a href="/note/git/" class="nav-link">《Git》</a></li><li class="dropdown-subitem"><a href="/pages/51afd6/" class="nav-link">TypeScript</a></li><li class="dropdown-subitem"><a href="/pages/4643cd/" class="nav-link">JS设计模式总结</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="页面" class="dropdown-title"><a href="/ui/" class="link-title">页面</a> <span class="title" style="display:none;">页面</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/8309a5b876fc95e3/" class="nav-link">HTML</a></li><li class="dropdown-item"><!----> <a href="/pages/0a83b083bdf257cb/" class="nav-link">CSS</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="技术" class="dropdown-title"><a href="/technology/" class="link-title">技术</a> <span class="title" style="display:none;">技术</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/9a7ee40fc232253e/" class="nav-link">技术文档</a></li><li class="dropdown-item"><!----> <a href="/pages/4c778760be26d8b3/" class="nav-link">GitHub技巧</a></li><li class="dropdown-item"><!----> <a href="/pages/117708e0af7f0bd9/" class="nav-link">Nodejs</a></li><li class="dropdown-item"><!----> <a href="/pages/41f87d890d0a02af/" class="nav-link">博客搭建</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="更多" class="dropdown-title"><a href="/more/" class="link-title">更多</a> <span class="title" style="display:none;">更多</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/f2a556/" class="nav-link">学习</a></li><li class="dropdown-item"><!----> <a href="/pages/aea6571b7a8bae86/" class="nav-link">面试</a></li><li class="dropdown-item"><!----> <a href="/pages/2d615df9a36a98ed/" class="nav-link">心情杂货</a></li><li class="dropdown-item"><!----> <a href="/pages/baaa02/" class="nav-link">实用技巧</a></li><li class="dropdown-item"><!----> <a href="/friends/" class="nav-link">友情链接</a></li></ul></div></div><div class="nav-item"><a href="/about/" class="nav-link">关于</a></div><div class="nav-item"><a href="/pages/beb6c0bd8a66cea6/" class="nav-link">收藏</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/archives/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">归档</a></li></ul></div></div> <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><div class="blogger"><img src="/img/avatar.jpeg"> <div class="blogger-info"><h3>达尔文的猹</h3> <span>大道至简 悟在天成</span></div></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">🏡首页</a></div><div class="nav-item"><a href="/basic/" class="nav-link">基础</a></div><div class="nav-item"><a href="/develop/" class="nav-link">开发</a></div><div class="nav-item"><a href="/middleware/" class="nav-link">中间件</a></div><div class="nav-item"><a href="/algorithm/" class="nav-link">算法</a></div><div class="nav-item"><a href="/books/" class="nav-link">读书笔记</a></div><div class="nav-item"><a href="/pangolin/" class="nav-link">个人</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="前端" class="dropdown-title"><a href="/web/" class="link-title">前端</a> <span class="title" style="display:none;">前端</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>前端文章</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/pages/8143cc480faf9a11/" class="nav-link">JavaScript</a></li><li class="dropdown-subitem"><a href="/operating_system/" class="nav-link">JavaScript</a></li></ul></li><li class="dropdown-item"><h4>学习笔记</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/note/javascript/" class="nav-link">《JavaScript教程》</a></li><li class="dropdown-subitem"><a href="/note/js/" class="nav-link">《JavaScript高级程序设计》</a></li><li class="dropdown-subitem"><a href="/note/es6/" class="nav-link">《ES6 教程》</a></li><li class="dropdown-subitem"><a href="/note/vue/" class="nav-link">《Vue》</a></li><li class="dropdown-subitem"><a href="/note/react/" class="nav-link">《React》</a></li><li class="dropdown-subitem"><a href="/note/typescript-axios/" class="nav-link">《TypeScript 从零实现 axios》</a></li><li class="dropdown-subitem"><a href="/note/git/" class="nav-link">《Git》</a></li><li class="dropdown-subitem"><a href="/pages/51afd6/" class="nav-link">TypeScript</a></li><li class="dropdown-subitem"><a href="/pages/4643cd/" class="nav-link">JS设计模式总结</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="基础" class="dropdown-title"><a href="/basic/" class="link-title">基础</a> <span class="title" style="display:none;">基础</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>前端文章</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/pages/8143cc480faf9a11/" class="nav-link">JavaScript</a></li></ul></li><li class="dropdown-item"><h4>学习笔记</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/note/javascript/" class="nav-link">《JavaScript教程》</a></li><li class="dropdown-subitem"><a href="/note/js/" class="nav-link">《JavaScript高级程序设计》</a></li><li class="dropdown-subitem"><a href="/note/es6/" class="nav-link">《ES6 教程》</a></li><li class="dropdown-subitem"><a href="/note/vue/" class="nav-link">《Vue》</a></li><li class="dropdown-subitem"><a href="/note/react/" class="nav-link">《React》</a></li><li class="dropdown-subitem"><a href="/note/typescript-axios/" class="nav-link">《TypeScript 从零实现 axios》</a></li><li class="dropdown-subitem"><a href="/note/git/" class="nav-link">《Git》</a></li><li class="dropdown-subitem"><a href="/pages/51afd6/" class="nav-link">TypeScript</a></li><li class="dropdown-subitem"><a href="/pages/4643cd/" class="nav-link">JS设计模式总结</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="页面" class="dropdown-title"><a href="/ui/" class="link-title">页面</a> <span class="title" style="display:none;">页面</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/8309a5b876fc95e3/" class="nav-link">HTML</a></li><li class="dropdown-item"><!----> <a href="/pages/0a83b083bdf257cb/" class="nav-link">CSS</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="技术" class="dropdown-title"><a href="/technology/" class="link-title">技术</a> <span class="title" style="display:none;">技术</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/9a7ee40fc232253e/" class="nav-link">技术文档</a></li><li class="dropdown-item"><!----> <a href="/pages/4c778760be26d8b3/" class="nav-link">GitHub技巧</a></li><li class="dropdown-item"><!----> <a href="/pages/117708e0af7f0bd9/" class="nav-link">Nodejs</a></li><li class="dropdown-item"><!----> <a href="/pages/41f87d890d0a02af/" class="nav-link">博客搭建</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="更多" class="dropdown-title"><a href="/more/" class="link-title">更多</a> <span class="title" style="display:none;">更多</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/f2a556/" class="nav-link">学习</a></li><li class="dropdown-item"><!----> <a href="/pages/aea6571b7a8bae86/" class="nav-link">面试</a></li><li class="dropdown-item"><!----> <a href="/pages/2d615df9a36a98ed/" class="nav-link">心情杂货</a></li><li class="dropdown-item"><!----> <a href="/pages/baaa02/" class="nav-link">实用技巧</a></li><li class="dropdown-item"><!----> <a href="/friends/" class="nav-link">友情链接</a></li></ul></div></div><div class="nav-item"><a href="/about/" class="nav-link">关于</a></div><div class="nav-item"><a href="/pages/beb6c0bd8a66cea6/" class="nav-link">收藏</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/archives/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">归档</a></li></ul></div></div> <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>ORM框架</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/4553db/" class="sidebar-link">MyBatis</a></li><li><a href="/pages/d426ff/" class="sidebar-link">Spring集成MyBatis</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Java</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading open"><span>基础</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/45687a/" class="sidebar-link">基础</a></li><li><a href="/pages/669da3/" class="sidebar-link">Java基础</a></li><li><a href="/pages/06424b/" class="sidebar-link">类与继承</a></li><li><a href="/pages/a29a57/" class="sidebar-link">抽象类与接口</a></li><li><a href="/pages/575ca7/" class="sidebar-link">内部类</a></li><li><a href="/pages/1d42f5/" class="sidebar-link">枚举类</a></li><li><a href="/pages/68df7d/" class="sidebar-link">常用类</a></li><li><a href="/pages/208d9a/" class="sidebar-link">关键字</a></li><li><a href="/pages/19431a/" class="sidebar-link">注解</a></li><li><a href="/pages/98c0c9/" class="sidebar-link">异常</a></li><li><a href="/pages/a08fb2/" class="sidebar-link">泛型</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading"><span>集合类</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/e52b1c/" class="sidebar-link">集合类</a></li><li><a href="/pages/20a058/" class="sidebar-link">集合容器类概述</a></li><li><a href="/pages/71ab62/" class="sidebar-link">ArrayList与LinkedList</a></li><li><a href="/pages/dd747b/" class="sidebar-link">ArrayDeque</a></li><li><a href="/pages/f0ecf7/" class="sidebar-link">PriorityQueue</a></li><li><a href="/pages/a577c4/" class="sidebar-link">HashMap与HashSet</a></li><li><a href="/pages/b65f71/" class="sidebar-link">LinkedHashMap</a></li><li><a href="/pages/02deb8/" class="sidebar-link">TreeMap与TreeSet</a></li><li><a href="/pages/8b70b6/" class="sidebar-link">WeakHashMap</a></li><li><a href="/pages/098b2b/" class="sidebar-link">CopyOnWriteArrayList</a></li><li><a href="/pages/380128/" class="sidebar-link">ConcurrentHashMap</a></li><li><a href="/pages/b23642/" class="sidebar-link">BlockingQueue</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading"><span>并发</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/5d5b55/" class="sidebar-link">并发</a></li><li><a href="/pages/ef591d/" class="sidebar-link">多线程基础</a></li><li><a href="/pages/870f46/" class="sidebar-link">JMM与Volatile</a></li><li><a href="/pages/70bfda/" class="sidebar-link">JUC与AQS</a></li><li><a href="/pages/60c2c3/" class="sidebar-link">锁与互斥同步</a></li><li><a href="/pages/6e4dfa/" class="sidebar-link">显式锁与ReetrantLock</a></li><li><a href="/pages/a0d56d/" class="sidebar-link">线程安全总结</a></li><li><a href="/pages/b92a49/" class="sidebar-link">JUC组件与线程协作</a></li><li><a href="/pages/103bb5/" class="sidebar-link">Atomic原子变量与Unsafe类与CAS</a></li><li><a href="/pages/065f55/" class="sidebar-link">线程池与定时任务</a></li><li><a href="/pages/dd3660/" class="sidebar-link">ThreadLocal</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading"><span>IO</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/7db050/" class="sidebar-link">IO</a></li><li><a href="/pages/ccb0a7/" class="sidebar-link">文件操作</a></li><li><a href="/pages/45bc73/" class="sidebar-link">IO流操作</a></li><li><a href="/pages/404e82/" class="sidebar-link">网络IO操作</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading"><span>Java高级特性</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/396bd1/" class="sidebar-link">Java高级特性</a></li><li><a href="/pages/eaa98b/" class="sidebar-link">Lambda表达式</a></li><li><a href="/pages/40af88/" class="sidebar-link">流Stream</a></li><li><a href="/pages/402b10/" class="sidebar-link">反射</a></li><li><a href="/pages/a5ebcd/" class="sidebar-link">代理</a></li><li><a href="/pages/b48bfe/" class="sidebar-link">Java性能问题定位分析</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading"><span>其他</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/20204f/" class="sidebar-link">其他</a></li><li><a href="/pages/e4cde0/" class="sidebar-link">杂记</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading"><span>规范&amp;amp;风格</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/ee7259/" class="sidebar-link">规范&amp;amp;风格</a></li><li><a href="/pages/139e3f/" class="sidebar-link">代码整洁之道</a></li></ul></section></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Spring</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/ed8d11/" class="sidebar-link">Web基础</a></li><li><a href="/pages/a228d7/" class="sidebar-link">Spring(Boot)基础</a></li><li><a href="/pages/ecd8b6/" class="sidebar-link">Spring Boot应用整合</a></li><li><a href="/pages/76dc08/" class="sidebar-link">Spring MVC</a></li><li><a href="/pages/b9aa73/" class="sidebar-link">Spring AOP</a></li><li><a href="/pages/dc74be/" class="sidebar-link">Spring事务</a></li><li><a href="/pages/b43c8c/" class="sidebar-link">Spring IOC源码分析-概览</a></li><li><a href="/pages/d9b4a5/" class="sidebar-link">Spring IOC源码分析-getBean()</a></li><li><a href="/pages/59dd3e/" class="sidebar-link">Spring IOC源码分析-createBean()</a></li><li><a href="/pages/691b21/" class="sidebar-link">Spring AOP源码分析</a></li><li><a href="/pages/d31e18/" class="sidebar-link">Spring事务源码分析</a></li><li><a href="/pages/f16cdb/" class="sidebar-link">Spring Boot源码分析</a></li><li><a href="/pages/b13a90/" class="sidebar-link">Spring MVC源码分析</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>JVM</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/943c23/" class="sidebar-link">JVM内存区域与对象解析</a></li><li><a href="/pages/05acae/" class="sidebar-link">内存分配与垃圾收集</a></li><li><a href="/pages/d09a16/" class="sidebar-link">JVM监控与故障处理工具</a></li><li><a href="/pages/06e4ad/" aria-current="page" class="active sidebar-link">类文件结构与类加载机制</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/pages/3d00d5/" class="sidebar-link">虚拟机方法调用与指令执行引擎</a></li><li><a href="/pages/eba070/" class="sidebar-link">程序编译与代码优化</a></li><li><a href="/pages/83896f/" class="sidebar-link">虚拟机调优及参数总结</a></li><li><a href="/pages/8a0034/" class="sidebar-link">GraalVM</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>数据库</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/f6cd57/" class="sidebar-link">数据库系统原理</a></li><li><a href="/pages/410bf5/" class="sidebar-link">MySQL必知必会</a></li><li><a href="/pages/495264/" class="sidebar-link">MySQL开发与优化</a></li><li><a href="/pages/ec7e76/" class="sidebar-link">MySQL架构与日志</a></li><li><a href="/pages/4dbe1f/" class="sidebar-link">MySQL索引</a></li><li><a href="/pages/cbc7ab/" class="sidebar-link">MySQL优化</a></li><li><a href="/pages/4afd3a/" class="sidebar-link">MySQL锁机制与事务并发控制</a></li><li><a href="/pages/412461/" class="sidebar-link">MySQL高级特性</a></li><li><a href="/pages/41888c/" class="sidebar-link">MySQL设计规范</a></li><li><a href="/pages/087de5/" class="sidebar-link">MySQL架构篇</a></li><li><a href="/pages/b0952c/" class="sidebar-link">MySQL复制</a></li><li><a href="/pages/ee884d/" class="sidebar-link">MySQL高可用</a></li><li><a href="/pages/6d4f47/" class="sidebar-link">MySQL运维篇</a></li><li><a href="/pages/b8bad7/" class="sidebar-link">MySQL常用工具</a></li><li><a href="/pages/8bd691/" class="sidebar-link">MySQL日志</a></li><li><a href="/pages/5db7ef/" class="sidebar-link">MySQL备份与恢复</a></li><li><a href="/pages/3e3d3a/" class="sidebar-link">MySQL权限与安全</a></li><li><a href="/pages/5f2a5c/" class="sidebar-link">MySQL监控</a></li><li><a href="/pages/bf28eb/" class="sidebar-link">数据库LeetCode题目</a></li><li><a href="/pages/d4f878/" class="sidebar-link">数据库面试题</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>工具</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/2bed26/" class="sidebar-link">Arthas</a></li><li><a href="/pages/84ff17/" class="sidebar-link">CICD</a></li><li><a href="/pages/a7e6ff/" class="sidebar-link">Maven</a></li><li><a href="/pages/2a3f45/" class="sidebar-link">Typora主题</a></li><li><a href="/pages/f28f56/" class="sidebar-link">VuePress</a></li><li><a href="/pages/9d673a/" class="sidebar-link">思源笔记</a></li><li><a href="/pages/538b8a/" class="sidebar-link">环境搭建</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>ORM</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/c83270/" class="sidebar-link">MyBatis</a></li><li><a href="/pages/29ba44/" class="sidebar-link">Spring集成MyBatis</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>测试</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/e55b6f/" class="sidebar-link">测试基础</a></li></ul></section></li></ul> </aside> <div><main class="page"><div class="theme-vdoing-wrapper "><div class="articleInfo-wrap" data-v-06225672><div class="articleInfo" data-v-06225672><ul class="breadcrumbs" data-v-06225672><li data-v-06225672><a href="/" title="首页" class="iconfont icon-home router-link-active" data-v-06225672></a></li> <li data-v-06225672><a href="/develop/#开发" data-v-06225672>开发</a></li><li data-v-06225672><a href="/develop/#JVM" data-v-06225672>JVM</a></li></ul> <div class="info" data-v-06225672><div title="作者" class="author iconfont icon-touxiang" data-v-06225672><a href="https://github.com/nanodaemony" target="_blank" title="作者" class="beLink" data-v-06225672>NanoDaemony</a></div> <div title="创建时间" class="date iconfont icon-riqi" data-v-06225672><a href="javascript:;" data-v-06225672>2023-06-08</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-title">目录</div> <div class="right-menu-content"></div></div></div> <h1><!---->类文件结构与类加载机制<!----></h1>  <div class="theme-vdoing-content content__default"><h1 id="_4-类文件结构与类加载机制"><a href="#_4-类文件结构与类加载机制" class="header-anchor">#</a> 4.类文件结构与类加载机制</h1> <h4 id="平台无关性"><a href="#平台无关性" class="header-anchor">#</a> 平台无关性</h4> <p>各种不同平台的虚拟机与所有平台都使用统一的程序存储格式: <strong>字节码</strong>, 这是构成<strong>平台无关性的基石</strong>. 实现语言无关性的基础仍然是<strong>虚拟机和字节码的存储格式</strong>. 把代码编译成 Class 文件, 虚拟机并不关心 Class 的来源是何种语言.</p> <p><img src="https://nano-note.oss-cn-beijing.aliyuncs.com/images/image-20220521185338069.png" alt=""></p> <h4 id="class类文件结构"><a href="#class类文件结构" class="header-anchor">#</a> Class类文件结构</h4> <p><strong>Class 文件</strong>是一组以 <strong>8 位</strong>字节数为基础单位的<strong>二进制流</strong>, 各个数据项目严格按照顺序紧凑排列在 Class 文件中, 没有添加任何分隔符, 整个 Class 文件的内容几乎全部是程序的必要数据. Class 文件类似于 C 语言<strong>结构体</strong>的伪结构的存储数据, 这种结构中只有两种数据类型: <strong>无符号数</strong>和<strong>表</strong>.</p> <p><strong>无符号数</strong>属于基本的<strong>数据类型</strong>, 下表是对应的类型:</p> <table><thead><tr><th style="text-align:center;">数据类型</th> <th style="text-align:center;">字节数</th></tr></thead> <tbody><tr><td style="text-align:center;">u1</td> <td style="text-align:center;">1</td></tr> <tr><td style="text-align:center;">u2</td> <td style="text-align:center;">2</td></tr> <tr><td style="text-align:center;">u4</td> <td style="text-align:center;">4</td></tr> <tr><td style="text-align:center;">u8</td> <td style="text-align:center;">8</td></tr></tbody></table> <p><strong>无符号数</strong>可以用来描述<strong>数字, 索引引用, 数量值</strong>或者按照 UTF8 编码构成的<strong>字符串值</strong>.</p> <p><strong>表</strong>是由<strong>多个无符号数</strong>或者其他表作为数据项构成的复合数据类型, 所有表习惯性以 &quot;<strong>info</strong>&quot; 结尾, 表用于描述有层次结构的复合结构数据. 整个 Class 文件本质上就是一张<strong>表</strong>.</p> <p>无论是<strong>无符号数还是表</strong>, 当需要描述同一类型但是数量不定的多个数据的时候, 经常会使用一个前置容量计数器加若干个连续的数据项的形式, 这时候称之为某一类型的<strong>集合</strong>.</p> <p>根据 Java 虚拟机规范, 类文件由单个 <strong>ClassFile 结构</strong>组成:</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code>ClassFile <span class="token punctuation">{</span>
    u4             magic<span class="token punctuation">;</span> <span class="token comment">// Class 文件的标志</span>
    u2             minor_version<span class="token punctuation">;</span><span class="token comment">// Class 的小版本号</span>
    u2             major_version<span class="token punctuation">;</span><span class="token comment">// Class 的大版本号</span>
    u2             constant_pool_count<span class="token punctuation">;</span><span class="token comment">// 常量池的数量</span>
    cp_info        constant_pool<span class="token punctuation">[</span>constant_pool_count<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">// 常量池</span>
    u2             access_flags<span class="token punctuation">;</span><span class="token comment">// Class 的访问标记</span>
    u2             this_class<span class="token punctuation">;</span><span class="token comment">// 当前类</span>
    u2             super_class<span class="token punctuation">;</span><span class="token comment">// 父类</span>
    u2             interfaces_count<span class="token punctuation">;</span><span class="token comment">// 接口</span>
    u2             interfaces<span class="token punctuation">[</span>interfaces_count<span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">// 一个类可以实现多个接口</span>
    u2             fields_count<span class="token punctuation">;</span><span class="token comment">// Class 文件的字段属性</span>
    field_info     fields<span class="token punctuation">[</span>fields_count<span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">// 一个类会可以有个字段</span>
    u2             methods_count<span class="token punctuation">;</span><span class="token comment">// Class 文件的方法数量</span>
    method_info    methods<span class="token punctuation">[</span>methods_count<span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">// 一个类可以有个多个方法</span>
    u2             attributes_count<span class="token punctuation">;</span><span class="token comment">// 此类的属性表中的属性数</span>
    attribute_info attributes<span class="token punctuation">[</span>attributes_count<span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">// 属性表集合</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>这里将下面 Java 文件通过 javac 编译为 <strong>.class</strong> 文件:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Test</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">int</span> num <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> finalnum <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> check<span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token class-name">Test</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        check <span class="token operator">=</span> <span class="token number">23</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p><strong>class 文件</strong>对应的<strong>字节流码</strong>:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>cafe babe <span class="token number">0000</span> <span class="token number">0034</span> <span class="token number">0018</span> <span class="token number">0</span>a00 <span class="token number">0500</span> <span class="token number">1309</span>
<span class="token number">0004</span> <span class="token number">0014</span> <span class="token number">0900</span> <span class="token number">0400</span> <span class="token number">1507</span> <span class="token number">0016</span> <span class="token number">0700</span> <span class="token number">1701</span>
<span class="token number">0003</span> <span class="token number">6e75</span> <span class="token number">6d</span><span class="token number">01</span> <span class="token number">0001</span> <span class="token number">4901</span> <span class="token number">0008</span> <span class="token number">6669</span> <span class="token number">6e61</span>
<span class="token number">6</span>c6e <span class="token number">756d</span> <span class="token number">0100</span> <span class="token number">0d</span><span class="token number">43</span> <span class="token number">6f</span><span class="token number">6</span>e <span class="token number">7374</span> <span class="token number">616</span>e <span class="token number">7456</span>
<span class="token number">616</span>c <span class="token number">7565</span> <span class="token number">0300</span> <span class="token number">0000</span> <span class="token number">0301</span> <span class="token number">0005</span> <span class="token number">6368</span> <span class="token number">6563</span>
<span class="token number">6</span>b01 <span class="token number">0006</span> <span class="token number">3</span>c69 <span class="token number">6e69</span> <span class="token number">743</span>e <span class="token number">0100</span> <span class="token number">0328</span> <span class="token number">2956</span>
<span class="token number">0100</span> <span class="token number">0443</span> <span class="token number">6f</span><span class="token number">64</span> <span class="token number">6501</span> <span class="token number">000f</span> <span class="token number">4</span>c69 <span class="token number">6e65</span> <span class="token number">4e75</span>
<span class="token number">6d</span><span class="token number">62</span> <span class="token number">6572</span> <span class="token number">5461</span> <span class="token number">626</span>c <span class="token number">6501</span> <span class="token number">0008</span> <span class="token number">3</span>c63 <span class="token number">6</span>c69
<span class="token number">6e69</span> <span class="token number">743</span>e <span class="token number">0100</span> <span class="token number">0</span>a53 <span class="token number">6f</span><span class="token number">75</span> <span class="token number">7263</span> <span class="token number">6546</span> <span class="token number">696</span>c
<span class="token number">6501</span> <span class="token number">0009</span> <span class="token number">5465</span> <span class="token number">7374</span> <span class="token number">2e6</span>a <span class="token number">6176</span> <span class="token number">610</span>c <span class="token number">000</span>c
<span class="token number">000d</span> <span class="token number">0</span>c00 <span class="token number">0b00</span> <span class="token number">070</span>c <span class="token number">0006</span> <span class="token number">0007</span> <span class="token number">0100</span> <span class="token number">0454</span>
<span class="token number">6573</span> <span class="token number">7401</span> <span class="token number">0010</span> <span class="token number">6</span>a61 <span class="token number">7661</span> <span class="token number">2f</span><span class="token number">6</span>c <span class="token number">616</span>e <span class="token number">672f</span>
<span class="token number">4f</span><span class="token number">62</span> <span class="token number">6</span>a65 <span class="token number">6374</span> <span class="token number">0021</span> <span class="token number">0004</span> <span class="token number">0005</span> <span class="token number">0000</span> <span class="token number">0003</span>
<span class="token number">000</span>a <span class="token number">0006</span> <span class="token number">0007</span> <span class="token number">0000</span> <span class="token number">001</span>a <span class="token number">0008</span> <span class="token number">0007</span> <span class="token number">0001</span>
<span class="token number">0009</span> <span class="token number">0000</span> <span class="token number">0002</span> <span class="token number">000</span>a <span class="token number">0002</span> <span class="token number">000</span>b <span class="token number">0007</span> <span class="token number">0000</span>
<span class="token number">0002</span> <span class="token number">0001</span> <span class="token number">000</span>c <span class="token number">000d</span> <span class="token number">0001</span> <span class="token number">000</span>e <span class="token number">0000</span> <span class="token number">002</span>b
<span class="token number">0002</span> <span class="token number">0001</span> <span class="token number">0000</span> <span class="token number">000</span>b <span class="token number">2</span>ab7 <span class="token number">0001</span> <span class="token number">2</span>a10 <span class="token number">17</span>b5
<span class="token number">0002</span> b100 <span class="token number">0000</span> <span class="token number">0100</span> <span class="token number">0f</span><span class="token number">00</span> <span class="token number">0000</span> <span class="token number">0e00</span> <span class="token number">0300</span>
<span class="token number">0000</span> <span class="token number">0500</span> <span class="token number">0400</span> <span class="token number">0600</span> <span class="token number">0</span>a00 <span class="token number">0700</span> <span class="token number">0800</span> <span class="token number">1000</span>
<span class="token number">0d</span><span class="token number">00</span> <span class="token number">0100</span> <span class="token number">0e00</span> <span class="token number">0000</span> <span class="token number">1d</span><span class="token number">00</span> <span class="token number">0100</span> <span class="token number">0000</span> <span class="token number">0000</span>
<span class="token number">0506</span> b300 <span class="token number">03</span>b1 <span class="token number">0000</span> <span class="token number">0001</span> <span class="token number">000f</span> <span class="token number">0000</span> <span class="token number">0006</span>
<span class="token number">0001</span> <span class="token number">0000</span> <span class="token number">0002</span> <span class="token number">0001</span> <span class="token number">0011</span> <span class="token number">0000</span> <span class="token number">0002</span> <span class="token number">0012</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><p><strong>Class 文件字节码结构组织示意图</strong>:</p> <p><img src="https://nano-note.oss-cn-beijing.aliyuncs.com/images/image-20200329201337586.png" alt="image-20200329201337586"></p> <h5 id="_1-魔数"><a href="#_1-魔数" class="header-anchor">#</a> 1.魔数</h5> <p>可以看到第一个字符为 u4 类型的 <strong>magic</strong> 变量, 称之为<strong>魔数</strong>, 该变量来表明是否是一个虚拟机能接受的 <strong>Class 文件</strong>. 上面的 Class 字节流显示 4 个字节 magic 是 <strong>0xcafe babe</strong>.</p> <h5 id="_2-主次版本号"><a href="#_2-主次版本号" class="header-anchor">#</a> 2.主次版本号</h5> <p>minor_version 代表 Java 的<strong>次版本号</strong>占<strong>两个字节</strong>, major_version 代表<strong>主版本号</strong>也占两个字节. 在上述 Class 文件中:</p> <ul><li>minor_version: <strong>0x0000</strong></li> <li>major_version: <strong>0x0034</strong></li></ul> <p>34 代表十进制的 52, 说明 Java 版本为 1.8.</p> <h5 id="_3-常量池"><a href="#_3-常量池" class="header-anchor">#</a> 3.常量池</h5> <div class="language-c line-numbers-mode"><pre class="language-c"><code>u2             constant_pool_count<span class="token punctuation">;</span>		      <span class="token comment">// 常量池的数量</span>
cp_info        constant_pool<span class="token punctuation">[</span>constant_pool_count<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token comment">// 常量池</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>接着是常量池的<strong>入口</strong>, 常量池可以理解为 Class 文件中的<strong>资源仓库</strong>. 由于常量池的数量是<strong>不固定</strong>的, 所以需要放置 u2 类型的数据来表示常量池容量的<strong>计数值</strong> constant_pool_count, 即上述 Class 文件中的 0x0018, 转换为十进制为 24, 表明当前常量池中有 23 项常量, 索引范围为 1-24.</p> <p>常量池中主要存放着两大类常量: <strong>字面量(Literal)<strong>​<strong><strong>以及</strong></strong>​</strong>符号引用</strong>(Symbolic References).</p> <p><strong>字面量</strong>接近于 Java 代码中的<strong>常量</strong>的概念, 如文本字符串, 声明为 final 的常量值等.</p> <p><strong>符号引用</strong>则属于<strong>编译原理</strong>方面的概念, 主要包括下面三类:</p> <ul><li>类和接口的全限定名</li> <li>字段的名称和描述符</li> <li>方法的名称和描述符</li></ul> <p>Java 在执行 javac 编译的时候, 不像 C/C++ 一样有链接的步骤, 而是在<strong>虚拟机加载 Class 文件时候</strong>进行<strong>动态</strong>的链接. <strong>也就说在 Class 文件中不会保存各个方法, 字段的最终内存信息, 这些字段, 方法的符号引用不经过运行期转化的话是无法获得真正的内存入口的. ​</strong>​<strong><strong>当虚拟机运行的时候, 需要从 Class 文件的</strong></strong>​<strong>常量池获得对应的符号引用</strong>, 然后在<strong>类创建或者运行时解析</strong>, 映射到具体的内存地址当中.</p> <p><strong>常量池</strong>中每一项常量都是一个<strong>表</strong>, 这 14 种表有一个共同的特点: <strong>开始的第一位是一个 u1 类型的标志位 -tag 来标识常量的类型, 代表当前这个常量属于哪种常量类型.</strong></p> <table><thead><tr><th style="text-align:center;">类型</th> <th style="text-align:center;">标志(tag)</th> <th style="text-align:center;">描述</th></tr></thead> <tbody><tr><td style="text-align:center;">CONSTANT_utf8_info</td> <td style="text-align:center;">1</td> <td style="text-align:center;">UTF-8 编码的字符串</td></tr> <tr><td style="text-align:center;">CONSTANT_Integer_info</td> <td style="text-align:center;">3</td> <td style="text-align:center;">整形字面量</td></tr> <tr><td style="text-align:center;">CONSTANT_Float_info</td> <td style="text-align:center;">4</td> <td style="text-align:center;">浮点型字面量</td></tr> <tr><td style="text-align:center;">CONSTANT_Long_info</td> <td style="text-align:center;">５</td> <td style="text-align:center;">长整型字面量</td></tr> <tr><td style="text-align:center;">CONSTANT_Double_info</td> <td style="text-align:center;">６</td> <td style="text-align:center;">双精度浮点型字面量</td></tr> <tr><td style="text-align:center;">CONSTANT_Class_info</td> <td style="text-align:center;">７</td> <td style="text-align:center;">类或接口的符号引用</td></tr> <tr><td style="text-align:center;">CONSTANT_String_info</td> <td style="text-align:center;">８</td> <td style="text-align:center;">字符串类型字面量</td></tr> <tr><td style="text-align:center;">CONSTANT_Fieldref_info</td> <td style="text-align:center;">９</td> <td style="text-align:center;">字段的符号引用</td></tr> <tr><td style="text-align:center;">CONSTANT_Methodref_info</td> <td style="text-align:center;">10</td> <td style="text-align:center;"><strong>类中方法的符号引用</strong></td></tr> <tr><td style="text-align:center;">CONSTANT_InterfaceMethodref_info</td> <td style="text-align:center;">11</td> <td style="text-align:center;">接口中方法的符号引用</td></tr> <tr><td style="text-align:center;">CONSTANT_NameAndType_info</td> <td style="text-align:center;">12</td> <td style="text-align:center;">字段或方法的符号引用</td></tr> <tr><td style="text-align:center;">CONSTANT_MothodType_info</td> <td style="text-align:center;">16</td> <td style="text-align:center;">标志方法类型</td></tr> <tr><td style="text-align:center;">CONSTANT_MethodHandle_info</td> <td style="text-align:center;">15</td> <td style="text-align:center;">表示方法句柄</td></tr> <tr><td style="text-align:center;">CONSTANT_InvokeDynamic_info</td> <td style="text-align:center;">18</td> <td style="text-align:center;">表示一个动态方法调用点</td></tr></tbody></table> <p><strong>.class 文件</strong>可以通过 javap -v class 类名指令来看一下其常量池中的信息.</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>$ javap <span class="token parameter variable">-v</span>  class类名 -<span class="token operator">&gt;</span> temp.txt <span class="token comment"># 将结果输出到 temp.txt 文件</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>上述都是字面量和符号引用.</p> <p>下面 CONSTANT_Methodref_info 这个<strong>符号引用</strong>包括两部分, 一部分是该方法所在的<strong>类</strong>, 另一部分是该方法的方法名和描述符. 这就是所谓 &quot;类中方法的符号引用&quot;.</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code>CONSTANT_Methodref_info <span class="token punctuation">{</span>
    u1 tag<span class="token punctuation">;</span>
    u2 class_index<span class="token punctuation">;</span>             <span class="token comment">// CONSTANT_Class_info</span>
    u2 name_and_type_index<span class="token punctuation">;</span>     <span class="token comment">// CONSTANT_NameAndType_info</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>可以 javap 来反编译字节码来用得常量池的信息.</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>$ javap <span class="token parameter variable">-p</span> Test
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>结果如下:</p> <p><img src="https://nano-note.oss-cn-beijing.aliyuncs.com/images/image-20191209194006969.png" alt=""></p> <p>上图中 Constant pool 表示 <strong>Class 文件中的常量池</strong>, 图中<strong>总共 23 个常量值</strong>, 跟上面通过字节码计算的方式得出的结果一致. 可以看到第一个 <strong>CONSTANT_Methodref_info</strong> 对应的是 <strong>init</strong> 方法, 来自于 Obejct 类, 返回值为 void, 参数为空.</p> <h5 id="_4-访问标志"><a href="#_4-访问标志" class="header-anchor">#</a> 4.访问标志</h5> <p>在常量池结束之后, 紧接着的两个字节表示访问标志, 这个标志用于<strong>识别类或者接口层次的访问信息</strong>, 包括:</p> <ul><li>这个 Class 是<strong>类还是接口</strong>.</li> <li>是否定义为 <strong>public</strong> 类型.</li> <li>是否定义为 <strong>abstract</strong> 类型.</li> <li>如果是类, 是否被声明为 <strong>final</strong> 类型.</li> <li>...</li></ul> <p>这个也可以通过反编译查看对应的标志:</p> <p><img src="https://nano-note.oss-cn-beijing.aliyuncs.com/images/image-20191209194207744.png" alt=""></p> <p>可以看到 Test 类的 flag 为 <strong>ACC_PUBLIC 和 ACC_SUPER</strong>.</p> <h5 id="_5-类索引-父索引-接口索引集合"><a href="#_5-类索引-父索引-接口索引集合" class="header-anchor">#</a> 5.类索引/父索引/接口索引集合</h5> <p>类索引(this_class) 以及父类索引(super_class) 都是一个 u2 类型的数据, 接口索引集合(interfaces) 是一组 u2 类型的数据集合, 在 Class 文件中, 通过上述三个数据来<strong>确定这个类的继承关系</strong>.</p> <p><strong>类索引</strong>确定这个类的<strong>全限定名</strong>, <strong>父类索引</strong>确定这个类的<strong>父类的全限定名</strong>, 除了 Object 类之外, 其他的所有类的父类索引都不为 0, <strong>接口索引</strong>集合用来描述该类实现了<strong>哪些接口</strong>.</p> <h5 id="_6-字段表集合"><a href="#_6-字段表集合" class="header-anchor">#</a> 6.字段表集合</h5> <div class="language-c line-numbers-mode"><pre class="language-c"><code>u2             fields_count<span class="token punctuation">;</span>        <span class="token comment">// Class 文件的字段的个数</span>
field_info     fields<span class="token punctuation">[</span>fields_count<span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">// 一个类会可以有个字段</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>字段表用于描述接口或者类中<strong>声明的变量</strong>. 字段包括<strong>静态</strong>变量以及<strong>实例</strong>变量, 但<strong>不包括</strong>在方法内部声明的<strong>局部变量</strong>.</p> <p>一个字段可以包含的信息如下:</p> <ul><li>字段的作用域(public, private, protected)</li> <li>实例变量还是类变量(有无 static 修饰符)</li> <li>可变性(final)</li> <li>并发可见性(volatile, 强制从主内存中读写)</li> <li>是否可序列化(transient)</li> <li>字段数据类型(基本类型, 对象, 数组)</li> <li>字段名称</li></ul> <p>各个修饰符都可以用布尔值来设定是否存在, 对于字段的数据类型以及名称, 则只能引用常量池中的常量来描述了.</p> <h5 id="_7-方法表集合"><a href="#_7-方法表集合" class="header-anchor">#</a> 7.方法表集合</h5> <div class="language-c line-numbers-mode"><pre class="language-c"><code>u2             methods_count<span class="token punctuation">;</span>			 <span class="token comment">// Class 文件的方法的数量</span>
method_info    methods<span class="token punctuation">[</span>methods_count<span class="token punctuation">]</span><span class="token punctuation">;</span>	         <span class="token comment">// 一个类可以有个多个方法</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>Class 文件存储格式中对<strong>方法的描述</strong>与对字段的描述几乎是一样的.</p> <p>因为 <strong>volatile</strong> 以及 <strong>transient</strong> 关键字<strong>不能修饰方法</strong>, 所以方法表的访问标志中<strong>没有</strong> ACC_VOLATILE 和ACC_TRANSIENT 标志. 但是可以使用 <strong>synchronized, native, strictfp 和 abstract</strong> 关键字修饰方法, 则对应增加了访问标志.</p> <p>如果父类方法在子类中<strong>没有被重写</strong>, 那么方法表集合中就不会出现父类的方法信息, 但是有可能出现由<strong>编译器自动添加</strong>的方法, 比如 <init> 和 <clinit> 方法.</clinit></init></p> <h5 id="_8-属性表集合"><a href="#_8-属性表集合" class="header-anchor">#</a> 8.属性表集合</h5> <p>在 Class 文件中, 字段表, 方法表中都可以携带自己的属性表集合, 以用于描述某些场景专有的信息. 与 Class 文件中其它的数据项目要求的顺序, 长度和内容不同, 属性表集合的限制稍微宽松一些, 不再要求各个属性表具有严格的顺序, 并且只要不与已有的属性名重复, 任何人实现的编译器都可以向属性表中写入自己定义的属性信息, Java 虚拟机运行时会忽略掉它不认识的属性.</p> <h4 id="类的生命周期"><a href="#类的生命周期" class="header-anchor">#</a> 类的生命周期</h4> <p>注意对比之前 <strong>new 一个关键字会发生什么</strong>部分的内容, 之前只是讲了对象<strong>创建过程</strong>.</p> <p>类的<strong>生命周期</strong>如下图所示.</p> <p><img src="https://nano-note.oss-cn-beijing.aliyuncs.com/images/image-20220521194824543.png" alt=""></p> <p>具体包括以下几个阶段: <strong>加载 , 连接(包含验证 , 准备, 解析), 初始化, 使用, 卸载</strong>.</p> <p><strong>加载, 验证, 准备, 初始化, 卸载</strong>这几个阶段的顺序是<strong>确定</strong>的, 而<strong>解析阶段</strong>则不一定: 它在某些情况下<strong>可以</strong>在<strong>初始化阶段之后</strong>再开始, 这是为了支持 Java 语言的运行时绑定, 也称为<strong>动态绑定</strong>. 所以通常上述的过程都是相互<strong>交叉混合</strong>进行的, 通常会在一个阶段执行时调用, 激活另一个阶段.</p> <h5 id="_1-加载"><a href="#_1-加载" class="header-anchor">#</a> 1.加载</h5> <p>加载是类加载的一个阶段, 注意不要混淆. 类是在<strong>运行期</strong>间第一次使用时<strong>动态加载</strong>的, 而不是一次性加载所有类. 如果一次性加载会占用很多的内存.</p> <p>加载过程完成以下三件事:</p> <ul><li>将 class 文件加载到<strong>内存</strong>.</li> <li>将静态数据结构转化成<strong>方法区</strong>中运行时的数据结构.</li> <li>在堆中生成一个代表这个类的 java.lang.Class 对象作为<strong>数据访问的入口</strong>.</li></ul> <p>其中<strong>类的二进制字节流</strong>可以从以下方式中获取:</p> <ul><li><strong>文件</strong>: 从 ZIP 包读取, 最终成为之后 Jar, War 格式的基础.</li> <li><strong>网络</strong>: 从<strong>网络</strong>中获取, 典型的应用是 Applet.</li> <li><strong>运行时计算生成</strong>: 这种场景使用得最多得就是<strong>动态代理技术</strong>, 在 java.lang.reflect.Proxy 中, 就是用了 ProxyGenerator.generateProxyClass 的代理类的二进制字节流.</li> <li><strong>由其他文件生成</strong>: 由其他文件生成, 典型场景是 <strong>JSP 应用</strong>, 即由 JSP 文件生成对应的 Class 类.</li></ul> <blockquote><p>数组类与非数组类的加载</p></blockquote> <p><strong>注意</strong>: <strong>非数组类</strong>加载阶段既可以使用系统提供的类加载器来完成, 也可以由<strong>用户自定义的类加载器</strong>去完成. 即覆写一个类加载器的 <strong>loadClass</strong>() 方法.</p> <p>对于<strong>数组类</strong>有些不同, <strong>数组类本身不通过类加载器创建</strong>, 它是由<strong>虚拟机直接创建</strong>的. 但是数组类的<strong>元素类型</strong>最终是要靠<strong>类加载器</strong>去创建.</p> <h5 id="_2-验证"><a href="#_2-验证" class="header-anchor">#</a> 2.验证</h5> <p><strong>验证</strong>是连接阶段的第一步, 这一阶段的<strong>目的是为了确保 Class 文件的字节流中包含的信息符合当前虚拟机的要求</strong>, 并且不会危害虚拟机自身的安全. 虚拟机如果不检查输入的字节流, 并对其完全信任的话, 很可能会因为载入了有害的字节流而导致系统崩溃, 所以验证是虚拟机对<strong>自身保护</strong>的一项重要工作.</p> <p>大致上会完成 4 个阶段的校验工作: <strong>文件格式, 元数据, 字节码, 符号引用</strong>.</p> <p><strong>(1) 文件格式验证</strong>: 验证字节流是否符合 <strong>Class 文件格式的规范</strong>, 并且能被当前版本的虚拟机处理. 该验证阶段的主要目的是保证输入的字节流能正确地解析并存储于方法区之内. 如<strong>魔数以及版本号</strong>是否合理等.</p> <p><strong>(2) 元数据验证</strong>: 该阶段对字节码描述的信息进行<strong>语义分析</strong>, 保证不存在不符合 Java 语言规范的元数据信息. 比如是否有父类? 继承了 final 类? 非抽象类实现了所有的抽象方法?</p> <p><strong>(3) 字节码验证</strong>: 通过数据流和控制流分析, 确保程序语义是合法, 符合逻辑的. 会进行运行检查, 栈数据类型和操作码数据参数吻合与否, 跳转指令指定到合理的位置.</p> <p><strong>(4) 符号引用验证</strong>: 最后一个阶段的校验发生在<strong>虚拟机将符号</strong>引用转化为<strong>直接引用</strong>的时候, 这个转化动作将在连接的解析阶段中发生. 符号引用验证的目的是确保解析动作能正常执行. 验证的内容主要有: 符号引用中通过字符串描述的<strong>全限定名</strong>是否能找到对应的<strong>类</strong>; 在指定类中是否存在符号方法的<strong>字段描述</strong>及简单名称所描述的<strong>方法和字段</strong>; 符号引用中的类, 字段和方法的<strong>访问性</strong>(private, protected, public, default) 是否可被当前类访问.</p> <h5 id="_3-准备"><a href="#_3-准备" class="header-anchor">#</a> 3.准备</h5> <p><strong>准备阶段</strong>是正式为<strong>类变量分配内存</strong>并设置类变量<strong>初始值</strong>的阶段, 这些变量所使用的<strong>内存</strong>都将在<strong>方法区中进行分配</strong>. 备注: 这时候进行内存分配的==<strong>仅包括类变量</strong>==(被 static 修饰的变量), 而<strong>不包括实例变量</strong>, 实例变量将会在对象实例化时随着对象一起分配在<strong>堆中</strong>. 实例化不是类加载的一个过程, 类加载发生在所有实例化操作之前, 并且<strong>类加载只进行一次, 实例化可以进行多次</strong>.</p> <p><strong>初始值</strong>通常是数据类型的<strong>默认零值</strong>. 基本数据类型的零值表:</p> <table><thead><tr><th style="text-align:center;">数据类型</th> <th style="text-align:center;">零值</th> <th style="text-align:center;">数据类型</th> <th style="text-align:center;">零值</th></tr></thead> <tbody><tr><td style="text-align:center;">int</td> <td style="text-align:center;">0</td> <td style="text-align:center;">boolean</td> <td style="text-align:center;"><strong>false</strong></td></tr> <tr><td style="text-align:center;">long</td> <td style="text-align:center;">0L</td> <td style="text-align:center;">float</td> <td style="text-align:center;"><strong>0.0f</strong></td></tr> <tr><td style="text-align:center;">short</td> <td style="text-align:center;">(short) 0</td> <td style="text-align:center;">double</td> <td style="text-align:center;">0.0d</td></tr> <tr><td style="text-align:center;">char</td> <td style="text-align:center;"><strong>'\u0000'</strong></td> <td style="text-align:center;">reference</td> <td style="text-align:center;"><strong>null</strong></td></tr> <tr><td style="text-align:center;">byte</td> <td style="text-align:center;">(byte) 0</td> <td style="text-align:center;"></td> <td style="text-align:center;"></td></tr></tbody></table> <p>例如下面的静态变量 value 在准备阶段后被初始化为 0 而不是 123, 因为这时候<strong>尚未</strong>开始执行任何方法, 在后面初始化阶段的 <strong>&lt;clinit&gt;()</strong> 方法中才会将 value 设置为代码中的 123.</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">int</span> value <span class="token operator">=</span> <span class="token number">123</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>一些特殊情况(加了 <strong>final 修饰符</strong>): 如果类变量是<strong>常量</strong>, 那么它<strong>将初始化为代码表达式所定义的值</strong>而不是 0.</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> value <span class="token operator">=</span> <span class="token number">123</span><span class="token punctuation">;</span> 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>编译时 Javac 将会为 value 生成 <strong>ConstantValue 属性</strong>, 在<strong>准备阶段</strong>虚拟机就会根据 ConstantValue 的设置将 value 赋值为 123.</p> <p><strong>注意</strong>: 方法内部的<strong>局部变量</strong>不像静态变量具有 &quot;准备阶段&quot;, 所以在<strong>程序中必须初始化</strong>才能使用, 因此<strong>局部变量</strong>没有赋初始值是不能使用的.</p> <h5 id="_4-解析"><a href="#_4-解析" class="header-anchor">#</a> 4.解析</h5> <p>解析过程将符号引用替换为<strong>直接引用</strong>, 该阶段会把一些静态方法(符号引用, 比如 main() 方法)替换为指向数据所在内存的指针或句柄等(直接引用), 这是所谓的静态链接过程(类加载期间完成), 动态链接是在程序运行期间完成的将符号引用替换为直接引用.</p> <p>解析即将常量池的<strong>符号引用</strong>替换为<strong>直接引用</strong>的过程. 分为: 类或接口的解析, 字段解析, 类方法解析, 接口方法解析等.</p> <p>其中<strong>解析过程</strong>在某些情况下可以在<strong>初始化阶段之后</strong>再开始, 这就是<strong>动态绑定</strong>.</p> <blockquote><p>符号引用与直接引用的关联?</p></blockquote> <ul><li><strong>符号引用</strong>(Symbolic References): 符号引用以一组<strong>符号</strong>来描述所引用的目标, 符号可以是符合约定的任何形式的<strong>字面量</strong>, 符号引用与虚拟机实现的内存布局无关, 引用的目标并<strong>不一定</strong>已经加载到<strong>内存</strong>中.</li> <li><strong>直接引用</strong>(Direct References): 直接引用可以是<strong>直接指向目标</strong>的指针, 相对偏移量或是一个能间接定位到目标的句柄. 直接引用与虚拟机实现的内存布局相关, 引用的<strong>目标必定已经在内存</strong>中存在. 可以通俗的理解为一个代码片段的<strong>入口地址</strong>.</li></ul> <p>虚拟机规范没有规定解析阶段发生的具体时间, 虚拟机实现可以根据需要来判断到底是在类被加载时解析还是等到一个符号引用将要被使用前才去解析.</p> <p>解析动作主要针对类或接口, 字段, 类方法, 接口方法, 方法类型, 方法句柄和调用点限定符 <strong>7 类符号引用</strong>进行.</p> <p>对一个符号引用进行<strong>多次解析</strong>请求是很常见的, 为了避免这个问题, 虚拟机实现可以在第一个解析成功后<strong>缓存结果</strong>, 后续使用这个结果即可.</p> <p>综上, <strong>解析阶段是虚拟机将常量池内的符号引用替换为直接引用的过程, 也就是得到类或者字段, 方法在内存中的指针或者偏移量.</strong></p> <h5 id="_5-初始化"><a href="#_5-初始化" class="header-anchor">#</a> 5.初始化</h5> <p>在准备阶段, 类变量已经赋过一次系统规定的<strong>默认初始值</strong>(零值), 而在<strong>初始化</strong>阶段才<strong>真正开始执行在类中定义的程序</strong>代码来<strong>初始化类变量和其它资源</strong>.</p> <p>初始化阶段是虚拟机执行**==类构造器 &lt;clinit&gt;() 方法==<strong>的过程. <clinit>() 是由编译器</clinit></strong>自动收集<strong>类中所有</strong>类变量<strong>的</strong>赋值动作<strong>和</strong>静态语句块中的语句<strong>合并产生的, 编译器收集的顺序由代码语句在</strong>源文件中出现的顺序决定**. 特别注意的是, <strong>静态语句块只能访问到定义在它之前的类变量, 定义在它之后的类变量只能赋值, 不能访问</strong>. 例如以下代码:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Test</span> <span class="token punctuation">{</span>
    <span class="token keyword">static</span> <span class="token punctuation">{</span>
        i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>                <span class="token comment">// 给变量赋值可以正常编译通过</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 这句编译器会提示&quot;非法向前引用&quot;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">static</span> <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><ul><li>虚拟机中第一个被执行的  &lt;clinit&gt;() 方法的<strong>类</strong>肯定是 java.lang.<strong>Object</strong>.</li> <li>由于<strong>父类的 &lt;clinit&gt;() 方法先执行</strong>, 也就意味着<strong>父类中定义的静态语句块的执行要优先于子类</strong>. 例如以下代码:</li></ul> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Parent</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token class-name">A</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">static</span> <span class="token punctuation">{</span>
        <span class="token class-name">A</span> <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Sub</span> <span class="token keyword">extends</span> <span class="token class-name">Parent</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token class-name">B</span> <span class="token operator">=</span> <span class="token class-name">A</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
     <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Sub<span class="token punctuation">.</span>B</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
     <span class="token comment">// 2</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><ul><li>接口中<strong>不可以</strong>使用静态语句块, 但仍然有<strong>类变量初始化的赋值操作</strong>, 因此<strong>接口与类一样都会生成 ​</strong>​**&lt;<strong>​</strong>clinit&gt;()** 方法. 但接口与类不同的是, 执行接口的 &lt;clinit&gt;() 方法不需要先执行父接口的 &lt;clinit&gt;() 方法. 只有当父接口中定义的变量使用时, 父接口才会初始化. 另外, 接口的<strong>实现类</strong>在初始化时也一样不会执行接口的 &lt;clinit&gt;() 方法.</li> <li><strong>虚拟机会保证一个类的 &lt;clinit&gt;() 方法在多线程环境下被正确的加锁和同步, 如果多个线程同时初始化一个类, 只会有一个线程执行这个类的 &lt;clinit&gt;() 方法, 其它线程都会阻塞等待</strong>, 直到当前活动线程执行 <clinit>() 方法完毕. 如果在一个类的 <clinit>() 方法中有耗时的操作, 就可能造成多个线程阻塞, 在实际过程中此种阻塞很隐蔽.</clinit></clinit></li></ul> <h5 id="_6-卸载"><a href="#_6-卸载" class="header-anchor">#</a> 6.卸载</h5> <p><strong>卸载类</strong>即该类的 Class 对象被 GC. 卸载类需要满足 3 个比较难以达到的要求, 即类被 GC 的条件:</p> <ol><li>该类的所有实例对象都已被回收, 堆不存在该类的实例对象.</li> <li>该类没有在其他任何地方被引用.</li> <li>该类的类加载器的实例已被 GC.</li></ol> <p>这些条件很难达到, 所有 GC 还是一般发生在<strong>堆</strong>中. JDK 自带的 BootstrapClassLoader, ExtensionClassLoader, ApplicationClassLoader 负责加载 JDK 提供的<strong>类</strong>, 所以<strong>它们(类加载器的实例)肯定不会被回收</strong>. 而<strong>自定义</strong>的类加载器的实例是可以被回收的, 所以使用<strong>自定义加载器加载的类是可以被卸载掉</strong>的.</p> <h4 id="类初始化的时机"><a href="#类初始化的时机" class="header-anchor">#</a> 类初始化的时机</h4> <h5 id="_1-主动引用"><a href="#_1-主动引用" class="header-anchor">#</a> 1.主动引用</h5> <p>虚拟机规范中并没有强制约束何时进行<strong>加载</strong>, 但是规范严格规定了有且只有下列<strong>五种</strong>情况<strong>必须对类进行初始化</strong>(加载, 验证, 准备都会随之发生):</p> <ul><li>遇到 <strong>new, getstatic, putstatic, invokestatic</strong> 这四条字节码指令时, 如果类没有进行过初始化, 则必须先触发其初始化. 最常见的生成这 4 条指令的场景是: 使用 <strong>new 关键字实例化对象</strong>的时候; 读取或设置一个<strong>类的静态字段</strong>的时候(被 final 修饰, 已在编译期把结果放入常量池的静态字段除外); 以及调用一个类的静态方法的时候.</li> <li>使用 java.lang.<strong>reflect 包</strong>的方法对类进行<strong>反射调用</strong>的时候, 如果类没有进行初始化, 则需要先将其初始化.</li> <li>当初始化<strong>一个类</strong>的时候, 如果发现其<strong>父类还没有进行过初始化</strong>, 则需要先<strong>触发其父类的初始化</strong>.</li> <li>当虚拟机启动时, 用户需要指定一个要执行的<strong>主类</strong>(包含 main() 方法的那个类), 虚拟机会先初始化这个主类.</li> <li>当使用<strong>动态语言支持</strong>时, 如果一个 java.lang.invoke.<strong>MethodHandle</strong> 实例最后的解析结果为 REF_getStatic, REF_putStatic, REF_invokeStatic 的方法句柄, 并且这个方法句柄所对应的类没有进行过初始化, 则需要先触发其初始化.</li></ul> <p>而对于接口, 当一个接口在初始化时, 并不要求其父接口全部都完成了初始化, 只有在<strong>真正使用到父接口</strong>时(如引用父接口中定义的常量) 才会初始化.</p> <h5 id="_2-被动引用"><a href="#_2-被动引用" class="header-anchor">#</a> 2.被动引用</h5> <p><strong>所有引用类的方式都不会触发初始化称为被动引用, 下面是 3 个被动引用例子:</strong></p> <p><strong>(1) 通过子类引用父类静态字段, 不会导致子类初始化.</strong></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SuperClass</span> <span class="token punctuation">{</span>
    <span class="token keyword">static</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;SuperClass(父类)被初始化了. . . &quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">int</span> value <span class="token operator">=</span> <span class="token number">66</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Subclass</span> <span class="token keyword">extends</span> <span class="token class-name">SuperClass</span> <span class="token punctuation">{</span>
    <span class="token keyword">static</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Subclass(子类)被初始化了. . . &quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Test1</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token comment">// 1:通过子类调用父类的静态字段不会导致子类初始化</span>
        <span class="token comment">// System.out.println(Subclass.value); // SuperClass(父类)被初始化了</span>
        <span class="token comment">// 2:通过数组定义引用类, 不会触发此类的初始化</span>
        <span class="token class-name">SuperClass</span><span class="token punctuation">[</span><span class="token punctuation">]</span> superClasses <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SuperClass</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token comment">// 3:通过new 创建对象,可以实现类初始化, 必须把1下面的代码注释掉才有效果不然经过1的时候类已经初始化了, 下面这条语句也就没用了. </span>
        <span class="token comment">// SuperClass superClass = new SuperClass();</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p><strong>(2) 通过数组定义引用类, 不会触发此类的初始化; 该过程会对数组类进行初始化, 数组类是一个由虚拟机自动生成的, 直接继承自 Object 的子类, 其中包含了数组的属性和方法.</strong></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">SuperClass</span><span class="token punctuation">[</span><span class="token punctuation">]</span> sca <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SuperClass</span><span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><strong>(3) 常量在编译阶段会存入调用类的常量池中, 本质上并没有直接引用定义常量的类, 因此不会触发定义常量的类的初始化.</strong></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ConstClass</span> <span class="token punctuation">{</span>
    <span class="token keyword">static</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;ConstClass被初始化了. . . &quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">HELLO</span> <span class="token operator">=</span> <span class="token string">&quot;hello world&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Test2</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 输出结果: hello world</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">ConstClass</span><span class="token punctuation">.</span><span class="token constant">HELLO</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h4 id="类加载器"><a href="#类加载器" class="header-anchor">#</a> 类加载器</h4> <h5 id="_1-类加载运行全过程"><a href="#_1-类加载运行全过程" class="header-anchor">#</a> 1.类加载运行全过程</h5> <p>类加载器是负责加载 <strong>.class 文件</strong>的, 它们在文件开头会有特定的文件标示, 将 class 文件字节码内容加载到内存中, 并将这些内容<strong>转换成方法区中的运行时数据结构</strong>, 并且 ClassLoader 只负责 class 的加载, 而是否能够运行则由 Execution Engine 来决定.</p> <p>虚拟机将加载二进制字节流的动作放在虚拟机外实现, 让程序自己决定<strong>如何获取所需要的实现类</strong>, 实现这个动作的代码模块称为 &quot;<strong>类加载器</strong>&quot;. <strong>类加载器</strong>在<strong>类层次划分, OSGI, 热部署和代码加密</strong>等领域有重要作用. 注意: <strong>系统类一启动就会全部加载到虚拟机中, 自己写的类只在用到的时候才进行加载</strong>.</p> <h5 id="_2-类加载器分类"><a href="#_2-类加载器分类" class="header-anchor">#</a> 2.类加载器分类</h5> <p>从<strong>虚拟机</strong>角度看, 只存在以下两种不同的类加载器:</p> <ul><li><strong>启动类加载器(Bootstrap ClassLoader)</strong>, 使用 C++ 实现, 是虚拟机自身的一部分;</li> <li><strong>所有其它</strong>类的加载器, 使用 Java 实现, 独立于虚拟机, <strong>继承</strong>自抽象类 java.lang.<strong>ClassLoader</strong>.</li></ul> <p>从功能上来看, 类加载器可以划分得更细致一些:</p> <ul><li><strong>启动类加载器(Bootstrap ClassLoader)</strong>. 负责加载支撑 JVM 运行的位于 JRE 的 lib 目录下的<strong>核心类库</strong>, 比如 rt.jar, charsets.jar 等. 启动类加载器无法被 Java 程序直接引用, 在自定义类加载器时, 如果需要把加载请求委派给启动类加载器, 直接使用 <strong>null</strong> 代替即可.</li> <li><strong>扩展类加载器(Extension ClassLoader)</strong>. 这个类加载器由 sun.misc.Launcher$<strong>ExtClassLoader</strong> 实现. 它负责加载支撑 JVM 运行的位于 JRE 的 lib 目录下的 ext 扩展目录中的 JAR 类包.</li> <li><strong>系统类加载器(Application ClassLoader)</strong>. 这个类加载器由 sun.misc.Launcher$<strong>AppClassLoader</strong> 实现. 由于这个类加载器是 ClassLoader 中的 <strong>getSystemClassLoader</strong>() 方法的返回值, 因此一般称为<strong>系统类加载器</strong>. 它负责<strong>加载用户类路径(ClassPath) 上所指定</strong>的类库, 开发者可以直接使用这个类加载器, 如果应用程序中没有自定义过自己的类加载器, 一般情况下这个就是程序中<strong>默认</strong>的类加载器.</li> <li><strong>自定义类加载器</strong>: 负责加载用户自定义路径下的类.</li></ul> <p>下面是 jre/lib 包下面的一些类库, 可以看看 <strong>Bootstrap ClassLoader ​</strong>都加载了什么内容.</p> <p><img src="assets/202303212337895-20230327230316-s4ce3pj.png" alt="202303212337895"></p> <p>每一个<strong>类</strong>都有一个对应它的<strong>类加载器</strong>. 系统中的 ClassLoder 在协同工作的时候会默认使用 <strong>双亲委派模型</strong>. 即在类加载的时候, 系统会首先判断当前类是否被加载过. 已经被加载的类会直接返回, 否则才会<strong>尝试加载</strong>.</p> <p>加载的时候, 首先会把该请求<strong>委派该父类加载器</strong>的 <strong>loadClass() 处理</strong>, 因此所有的类加载请求最终都从顶层的启动类加载器 <strong>BootstrapClassLoader</strong> 开始进行. 当父类加载器无法处理时, <strong>子加载器才会尝试自己去加载</strong>. 当父类加载器参数传入为 null 时, 会使用启动类加载器 BootstrapClassLoader 作为父类加载器.</p> <p>每个类加载都有一个父类加载器, 测试一下.</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ClassLoaderTest</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Current ClassLoader is: &quot;</span> <span class="token operator">+</span> <span class="token class-name">ClassLoaderTest</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;The Parent ClassLoader is: &quot;</span> <span class="token operator">+</span> <span class="token class-name">ClassLoaderTest</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getParent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;The GrandParent ClassLoader is: &quot;</span> <span class="token operator">+</span> <span class="token class-name">ClassLoaderTest</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getParent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getParent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">Current</span> <span class="token class-name">ClassLoader</span> is<span class="token operator">:</span> <span class="token class-name"><span class="token namespace">jdk<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>loader<span class="token punctuation">.</span></span>ClassLoaders</span>$<span class="token class-name">AppClassLoader</span><span class="token annotation punctuation">@1f89ab83</span>
<span class="token class-name">The</span> <span class="token class-name">Parent</span> <span class="token class-name">ClassLoader</span> is<span class="token operator">:</span> <span class="token class-name"><span class="token namespace">jdk<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>loader<span class="token punctuation">.</span></span>ClassLoaders</span>$<span class="token class-name">PlatformClassLoader</span><span class="token annotation punctuation">@340f438e</span>
<span class="token class-name">The</span> <span class="token class-name">GrandParent</span> <span class="token class-name">ClassLoader</span> is<span class="token operator">:</span> <span class="token keyword">null</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p><strong>AppClassLoader 的父类加载器为 ExtClassLoader, ExtClassLoader 的父类加载器为 null, null 并不代表 ExtClassLoader 没有父类加载器, 而是 BootstrapClassLoader, 由于是 C++ 实现, 所以是 null. ​</strong></p> <p>应用程序是由三种类加载器互相配合从而实现类加载, 除此之外还可以加入<strong>自己定义的类加载器</strong>.</p> <h5 id="_3-类加载器的初始化过程"><a href="#_3-类加载器的初始化过程" class="header-anchor">#</a> 3.类加载器的初始化过程</h5> <p><strong>Bootstrap ClassLoader 类加载器是由 JVM 创建的一个 C++ 对象, ExtClassLoader 和 AppClassLoader 类加载器则是 sun.misc.Launcher 类中的对象, 在 JVM 启动时由 Launcher 进行实例化.  ​</strong></p> <p>类加载过程中会创建 JVM 启动器实例 sun.misc.<strong>Launcher 类</strong>. sun.misc.Launcher 初始化使用了<strong>单例模式</strong>设计, 保证一个 JVM 虚拟机内只有一个该实例. 在 Launcher 构造方法内部, 其创建了<strong>两个类加载器</strong>, 分别是 sun.misc.Launcher.<strong>ExtClassLoader</strong>(扩展类加载器)和 sun.misc.Launcher.<strong>AppClassLoader</strong>(应用类加载器).</p> <p>JVM 默认使用 <strong>Launcher</strong> 的 <strong>getClassLoader()</strong> 方法返回的类加载器 AppClassLoader 的实例加载应用程序.</p> <blockquote><p>Launcher类的构造方法</p></blockquote> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">Launcher</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Launcher<span class="token punctuation">.</span>ExtClassLoader</span> var1<span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment">// 构造扩展类加载器, 在构造的过程中将其父加载器设置为null</span>
        var1 <span class="token operator">=</span> <span class="token class-name">Launcher<span class="token punctuation">.</span>ExtClassLoader</span><span class="token punctuation">.</span><span class="token function">getExtClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> var10<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">InternalError</span><span class="token punctuation">(</span><span class="token string">&quot;Could not create extension class loader&quot;</span><span class="token punctuation">,</span> var10<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment">// 构造应用类加载器, 在构造时中将其父加载器设置为ExtClassLoader(var1)!!!</span>
        <span class="token comment">// Launcher的loader属性值是AppClassLoader, 一般都是用这个类加载器来加载自己写的应用程序</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>loader <span class="token operator">=</span> <span class="token class-name">Launcher<span class="token punctuation">.</span>AppClassLoader</span><span class="token punctuation">.</span><span class="token function">getAppClassLoader</span><span class="token punctuation">(</span>var1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> var9<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">InternalError</span><span class="token punctuation">(</span><span class="token string">&quot;Could not create application class loader&quot;</span><span class="token punctuation">,</span> var9<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setContextClassLoader</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>loader<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> var2 <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token string">&quot;java.security.manager&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 省略....</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><h5 id="_4-双亲委派模型"><a href="#_4-双亲委派模型" class="header-anchor">#</a> 4.双亲委派模型</h5> <h6 id="_1-概述"><a href="#_1-概述" class="header-anchor">#</a> (1)概述</h6> <p>下图展示了<strong>类加载器之间的层次关系</strong>, 称为<strong>双亲委派模型</strong>(Parents Delegation Model).</p> <p><strong>双亲委派机制即加载某个类时会先委托父加载器寻找目标类, 找不到再委托上层父加载器加载, 如果所有父加载器在自己的加载类路径下都找不到目标类, 则在自己的类加载路径中查找并载入目标类</strong>.</p> <p>比如自定义的 Math 类, 最先会找应用程序类加载器加载, 应用程序类加载器会先委托扩展类加载器加载, 扩展类加载器再委托引导类加载器, 顶层引导类加载器在自己的类加载路径里没有找到 Math 类, 则向下退回加载 Math 类的请求, 扩展类加载器收到回复就自己加载, 在自己的类加载路径里也没找到 Math 类, 又向下退回 Math 类的加载请求给应用程序类加载器, 应用程序类加载器于是在自己的类加载路径里找 Math 类, 结果找到了就自己加载了.</p> <p><img src="https://nano-note.oss-cn-beijing.aliyuncs.com/images/image-20220522130632761.png" alt=""></p> <p>注意, 虽然是双亲委派, 但是这些类加载器<strong>不是继承关系</strong>! 比如 AppClassLoader 并不是继承自 ExtClassLoader 类, 只是 AppClassLoader 类中的 <strong>parent 属性</strong>指向的是 ExtClassLoader. 各种类加载器都是继承自抽象类 <code>ClassLoader</code>​.</p> <blockquote><p>为什么要有双亲委派模型?</p></blockquote> <p>使用双亲委派模型来组织类加载器之间的关系, 有一个显而易见的<strong>好处</strong>就是 Java 类随着它的类加载器一起具备了一种<strong>带有优先级的层次关系</strong>, 从而使得<strong>基础类得到统一</strong>. 双亲委派模型可以<strong>避免类的重复加载</strong>, 也保证了 Java 的<strong>核心 API 优先加载不被篡改</strong>. 如果没有双亲委派模型, 而是每个类加载器加载自己的话就会出现问题, 比如编写一个称为 <strong>java.lang.Object 类</strong>的话, 那么程序运行的时候, 系统就会出现<strong>多个不同的 Object 类</strong>.</p> <p><strong>总结为什么要设计双亲委派机制? 为了核心类安全与防止类的重复加载</strong>.</p> <ul><li><strong>沙箱安全机制</strong>: 自己写的 java.lang.String.class 类不会被加载, 这样便可以防止核心 API 库被随意篡改.</li> <li><strong>避免类的重复加载</strong>: 当父亲已经加载了该类时, 就没有必要被子 ClassLoader 再加载一次, 保证<strong>被加载类的唯一性</strong>.</li></ul> <p>看一个类加载示例:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// 这里包名与JDK的String类一样</span>
<span class="token keyword">package</span> <span class="token namespace">java<span class="token punctuation">.</span>lang</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">String</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;My String Class.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>运行结果:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>错误<span class="token operator">:</span> 在类 <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>String</span> 中找不到 main 方法<span class="token punctuation">,</span> 请将 main 方法定义为<span class="token operator">:</span>
   <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span>
否则 <span class="token class-name">JavaFX</span> 应用程序类必须扩展<span class="token class-name"><span class="token namespace">javafx<span class="token punctuation">.</span>application<span class="token punctuation">.</span></span>Application</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>注意这里需要加载的是 java.lang.String.class, 由于这个类已经被父加载器加载了, 所以直接就认为已经加载过这个类了, 也就是 JDK 中的 String 类, 也就不会再加载自己写的这个 String 类了; 但是 JDK 的 String 类中没有 main 方法, 因此会报错. 这样就保证了核心类库无法被修改.</p> <blockquote><p>全盘负责委托机制</p></blockquote> <p>&quot;<strong>全盘负责</strong>&quot; 是指当一个 ClassLoder 装载一个<strong>类</strong>时, 除非显示的使用另外一个 ClassLoder, 否则<strong>该类所依赖及引用的类也由这个 ClassLoder 载入</strong>.</p> <p>注: 双亲委派模型是 Java 设计者们推荐给开发者们的一种类加载器实现方式, 并不是一个强制性的约束模型. 在 Java 的世界中大部分的类加载器都遵循这个模型, 但也有例外.</p> <h6 id="_2-双亲委派机制原理分析"><a href="#_2-双亲委派机制原理分析" class="header-anchor">#</a> (2)双亲委派机制原理分析</h6> <p>AppClassLoader 也是 <code>ClassLoader</code>​ 的子类. 看下应用程序类加载器 AppClassLoader 加载类的双亲委派机制源码, AppClassLoader 的 loadClass() 方法最终会调用其父类 <strong>ClassLoader</strong> 的 <strong>loadClass()</strong> 方法, 该方法的大体逻辑如下, 这段逻辑就解释了双亲委派模型的整体实现:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ClassLoader</span> parent<span class="token punctuation">;</span>

<span class="token comment">// ClassLoader类的loadClass()方法, 里面实现了双亲委派机制</span>
<span class="token keyword">protected</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> <span class="token function">loadClass</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">,</span> <span class="token keyword">boolean</span> resolve<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ClassNotFoundException</span> <span class="token punctuation">{</span>
    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token function">getClassLoadingLock</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 检查当前类加载器是否已经加载了该类</span>
        <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> c <span class="token operator">=</span> <span class="token function">findLoadedClass</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>c <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">long</span> t0 <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">nanoTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token comment">// 如果当前加载器的父加载器不为空则委托父加载器进行类加载</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>parent <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  
                    c <span class="token operator">=</span> parent<span class="token punctuation">.</span><span class="token function">loadClass</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">// 如果当前加载器的父加载器为空则委托Bootstrap类加载器进行类加载</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>  
                    c <span class="token operator">=</span> <span class="token function">findBootstrapClassOrNull</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ClassNotFoundException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// ClassNotFoundException thrown if class not found</span>
                <span class="token comment">// from the non-null parent class loader</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>c <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">long</span> t1 <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">nanoTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 都会调用URLClassLoader的findClass方法在加载器的类路径里查找并加载该类</span>
                c <span class="token operator">=</span> <span class="token function">findClass</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
 
                <span class="token comment">// this is the defining class loader; record the stats</span>
                <span class="token class-name"><span class="token namespace">sun<span class="token punctuation">.</span>misc<span class="token punctuation">.</span></span>PerfCounter</span><span class="token punctuation">.</span><span class="token function">getParentDelegationTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addTime</span><span class="token punctuation">(</span>t1 <span class="token operator">-</span> t0<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name"><span class="token namespace">sun<span class="token punctuation">.</span>misc<span class="token punctuation">.</span></span>PerfCounter</span><span class="token punctuation">.</span><span class="token function">getFindClassTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addElapsedTimeFrom</span><span class="token punctuation">(</span>t1<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name"><span class="token namespace">sun<span class="token punctuation">.</span>misc<span class="token punctuation">.</span></span>PerfCounter</span><span class="token punctuation">.</span><span class="token function">getFindClasses</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">increment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>resolve<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment">// 不会执行</span>
            <span class="token function">resolveClass</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> c<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br></div></div><p>大体逻辑如下:</p> <ul><li>首先检查一下指定名称的类是否已经加载过, 如果加载过了, 就不需要再加载, 直接返回.</li> <li>如果此类没有加载过, 那么再判断一下<strong>是否有父加载器</strong>; 如果有父加载器, 则由父加载器加载, 即调用 <strong>parent.loadClass</strong>(name, false), 或者调用 bootstrap 类加载器来加载.</li> <li>如果父加载器及 bootstrap 类加载器都没有找到指定的类, 那么调用<strong>当前</strong>类加载器的 <strong>findClass()</strong> 方法来完成类加载.</li></ul> <blockquote><p>loadClass(), findClass(), defineClass() 的区别?</p></blockquote> <ul><li><strong>loadclass()</strong>: 判断是否已加载, 使用双亲委派模型, 请求父加载器, 都为空则使用 findclass() .</li> <li><strong>findclass()</strong>: 根据名称或位置加载 .class 字节码, 然后使用 defineClass().</li> <li><strong>defineclass()</strong>: 解析定义 .class 字节流, 返回 class 对象.</li></ul> <h5 id="_5-自定义类加载器"><a href="#_5-自定义类加载器" class="header-anchor">#</a> 5.自定义类加载器</h5> <p>自定义类加载器的优势: 高度的灵活性, 通过自定义类加载器可以实现热部署, 代码加密等. 自定义类加载器应用实例: Tomcat, OSGi 等.</p> <p><strong>自定义类加载器</strong>只需要<strong>继承</strong> java.lang.<strong>ClassLoader</strong> 抽象类, 该类有两个核心方法, 一个是 <strong>loadClass</strong>(String,  boolean), 用于实现双亲委派机制. 还有一个方法是 <strong>findClass()</strong>, 默认实现是抛异常, 因此<strong>自定义类加载器主要是覆写 findClass() 方法. ​</strong>在 <strong>ClassLoader 类</strong>的 loadClass() 方法中就会使用到 findClass() 方法, 如果覆写了就可以走自己的逻辑.</p> <blockquote><p>自定义类加载器示例1: MyClassLoader</p></blockquote> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyClassLoader</span> <span class="token keyword">extends</span> <span class="token class-name">ClassLoader</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token class-name">String</span> classPath<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">MyClassLoader</span><span class="token punctuation">(</span><span class="token class-name">String</span> classPath<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>classPath <span class="token operator">=</span> classPath<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/** 覆写方法 */</span>
    <span class="token keyword">protected</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> <span class="token function">findClass</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ClassNotFoundException</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> data <span class="token operator">=</span> <span class="token function">loadByte</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// defineClass()方法将一个字节数组转为Class对象, 这个字节数组是class文件读取后最终的字节数组</span>
            <span class="token keyword">return</span> <span class="token function">defineClass</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> data<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> data<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ClassNotFoundException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">loadByte</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        name <span class="token operator">=</span> name<span class="token punctuation">.</span><span class="token function">replaceAll</span><span class="token punctuation">(</span><span class="token string">&quot;\\.&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;/&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">FileInputStream</span> fis <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileInputStream</span><span class="token punctuation">(</span>classPath <span class="token operator">+</span> <span class="token string">&quot;/&quot;</span> <span class="token operator">+</span> name <span class="token operator">+</span> <span class="token string">&quot;.class&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> len <span class="token operator">=</span> fis<span class="token punctuation">.</span><span class="token function">available</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> data <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span>len<span class="token punctuation">]</span><span class="token punctuation">;</span>
        fis<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
        fis<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> data<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br></div></div><p>以下代码中的 FileSystemClassLoader 是<strong>自定义</strong>类加载器, 用于加载<strong>文件系统</strong>上的类. 它首先根据类的全名在文件系统上查找类的字节代码文件(.class 文件), 然后<strong>读取</strong>该文件内容, 最后通过 <strong>defineClass()</strong> 方法来把这些字节代码转换成 <strong>java.lang.Class 类</strong>的实例.</p> <blockquote><p>自定义类加载器示例2: FileSystemClassLoader</p></blockquote> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// 自定义文件系统类加载器</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FileSystemClassLoader</span> <span class="token keyword">extends</span> <span class="token class-name">ClassLoader</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token class-name">String</span> rootDir<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">FileSystemClassLoader</span><span class="token punctuation">(</span><span class="token class-name">String</span> rootDir<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>rootDir <span class="token operator">=</span> rootDir<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
	
    <span class="token comment">// 这里覆写findClass方法</span>
    <span class="token keyword">protected</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> <span class="token function">findClass</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ClassNotFoundException</span> <span class="token punctuation">{</span>
        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> classData <span class="token operator">=</span> <span class="token function">getClassData</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>classData <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ClassNotFoundException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token function">defineClass</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> classData<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> classData<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">getClassData</span><span class="token punctuation">(</span><span class="token class-name">String</span> className<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> path <span class="token operator">=</span> <span class="token function">classNameToPath</span><span class="token punctuation">(</span>className<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">InputStream</span> ins <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileInputStream</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">ByteArrayOutputStream</span> baos <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ByteArrayOutputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> bufferSize <span class="token operator">=</span> <span class="token number">4096</span><span class="token punctuation">;</span>
            <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> buffer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span>bufferSize<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> bytesNumRead<span class="token punctuation">;</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>bytesNumRead <span class="token operator">=</span> ins<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                baos<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>buffer<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> bytesNumRead<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> baos<span class="token punctuation">.</span><span class="token function">toByteArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token class-name">String</span> <span class="token function">classNameToPath</span><span class="token punctuation">(</span><span class="token class-name">String</span> className<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> rootDir <span class="token operator">+</span> <span class="token class-name">File</span><span class="token punctuation">.</span>separatorChar
                <span class="token operator">+</span> className<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token char">'.'</span><span class="token punctuation">,</span> <span class="token class-name">File</span><span class="token punctuation">.</span>separatorChar<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;.class&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br></div></div><p>由于 AppClassLoader 在初始化的时候会初始化 ClassLoader 类, 然后其构造方法会通过 getSystemClassLoader() 获取到 AppClassLoader, 并将其幅值给自定义类加载器的 parent 属性, 因此<strong>自定义的类加载器的父加载器默认是 AppClassLoader, 这也与上图中自定义类加载器指向 AppClassLoader 是一致的</strong>.</p> <blockquote><p>ClassLoader构造器源码</p></blockquote> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">protected</span> <span class="token class-name">ClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">(</span><span class="token function">checkCreateClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">getSystemClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token class-name">ClassLoader</span><span class="token punctuation">(</span><span class="token class-name">Void</span> unused<span class="token punctuation">,</span> <span class="token class-name">ClassLoader</span> parent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// getSystemClassLoader()获取的AppClassLoader幅值给自定义类加载器的parent属性</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>parent <span class="token operator">=</span> parent<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">ParallelLoaders</span><span class="token punctuation">.</span><span class="token function">isRegistered</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        parallelLockMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        package2certs <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        domains <span class="token operator">=</span>
            <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">synchronizedSet</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">HashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ProtectionDomain</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        assertionLock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// no finer-grained lock; lock on the classloader instance</span>
        parallelLockMap <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        package2certs <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Hashtable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        domains <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        assertionLock <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><h5 id="_6-破坏双亲委派模型"><a href="#_6-破坏双亲委派模型" class="header-anchor">#</a> 6.破坏双亲委派模型</h5> <p><strong>双亲委派机制是在 loadClass() 方法中实现的, 要打破这个机制就可以从修改这个方法入手. 确实就是直接覆写 loadClass() 方法, 使得 loadClass() 方法不再委托父加载器加载类, 而是</strong>实现自己的<strong>加载逻辑</strong>, 不委派给双亲加载, <strong>由此打破了双亲委派机制</strong>.</p> <p><strong>由于存在安全沙箱机制, 系统核心的类一般是不让自定义类加载器进行加载的, 因此下面的自定义类加载器是对需要加载的类进行了判断, 如果是自己的业务包则直接用自定义类加载器加载, 否则依然走双亲委派机制加载</strong>.</p> <blockquote><p>使用自定义类加载器打破双亲委派机制实例</p></blockquote> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyClassLoaderV2</span> <span class="token keyword">extends</span> <span class="token class-name">ClassLoader</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token class-name">String</span> classPath<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">MyClassLoaderV2</span><span class="token punctuation">(</span><span class="token class-name">String</span> classPath<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>classPath <span class="token operator">=</span> classPath<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 重写类加载方法, 实现自己的加载逻辑, 不委派给双亲加载
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> <span class="token function">loadClass</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">,</span> <span class="token keyword">boolean</span> resolve<span class="token punctuation">)</span>
        <span class="token keyword">throws</span> <span class="token class-name">ClassNotFoundException</span> <span class="token punctuation">{</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token function">getClassLoadingLock</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// First, check if the class has already been loaded</span>
            <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> c <span class="token operator">=</span> <span class="token function">findLoadedClass</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>c <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// If still not found, then invoke findClass in order</span>
                <span class="token comment">// to find the class.</span>
                <span class="token keyword">long</span> t1 <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">nanoTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      
                <span class="token comment">// 自己的业务包直接用本加载器加载</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>name<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">&quot;com.nano&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    c <span class="token operator">=</span> <span class="token function">findClass</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
          
                    <span class="token comment">// 其余类依然走双亲委派机制加载</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    c <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getParent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">loadClass</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
      
                <span class="token comment">// this is the defining class loader; record the stats</span>
                <span class="token class-name"><span class="token namespace">sun<span class="token punctuation">.</span>misc<span class="token punctuation">.</span></span>PerfCounter</span><span class="token punctuation">.</span><span class="token function">getFindClassTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addElapsedTimeFrom</span><span class="token punctuation">(</span>t1<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name"><span class="token namespace">sun<span class="token punctuation">.</span>misc<span class="token punctuation">.</span></span>PerfCounter</span><span class="token punctuation">.</span><span class="token function">getFindClasses</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">increment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>resolve<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">resolveClass</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> c<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/** 覆写方法 */</span>
    <span class="token keyword">protected</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> <span class="token function">findClass</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ClassNotFoundException</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> data <span class="token operator">=</span> <span class="token function">loadByte</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// defineClass()方法将一个字节数组转为Class对象, 这个字节数组是class文件读取后最终的字节数组</span>
            <span class="token keyword">return</span> <span class="token function">defineClass</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> data<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> data<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ClassNotFoundException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">loadByte</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        name <span class="token operator">=</span> name<span class="token punctuation">.</span><span class="token function">replaceAll</span><span class="token punctuation">(</span><span class="token string">&quot;\\.&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;/&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">FileInputStream</span> fis <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileInputStream</span><span class="token punctuation">(</span>classPath <span class="token operator">+</span> <span class="token string">&quot;/&quot;</span> <span class="token operator">+</span> name <span class="token operator">+</span> <span class="token string">&quot;.class&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> len <span class="token operator">=</span> fis<span class="token punctuation">.</span><span class="token function">available</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> data <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span>len<span class="token punctuation">]</span><span class="token punctuation">;</span>
        fis<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
        fis<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> data<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br></div></div><blockquote><p>双亲委派模型&quot;被破坏&quot;实例</p></blockquote> <p>由于对<strong>程序动态性</strong>的追求导致双亲委派模型被破坏. 这里的动态性是指 &quot;代码热替换&quot;, &quot;模块热部署&quot;等. OSGI 实现<strong>模块化热部署的关键是它自定义的类加载器机制的实现</strong>. 每一个程序模块(OSGI 中称为 Bundle)都有一个自己的<strong>类加载器</strong>, 当需要更换一个 Bundle 时, 就把 <strong>Bundle 连同类加载器一起换掉</strong>以实现代码的热替换. 在 OSGI 环境下, 类加载器<strong>不再是双亲委派模型中的树状结构</strong>, 而是进一步发展为更加复杂的网状结构.</p> <h5 id="_7-tomcat打破双亲委派机制"><a href="#_7-tomcat打破双亲委派机制" class="header-anchor">#</a> 7.Tomcat打破双亲委派机制</h5> <p>Tomcat 是个 web 容器, 需要解决的问题有:</p> <ul><li>一个 Web 容器可能需要<strong>部署两个应用程序</strong>, 不同的应用程序可能会<strong>依赖同一个第三方类库的不同版本</strong>, 不能要求同一个类库在同一个服务器只有一份, 因此要保证每个应用程序的类库都是独立的, 保证<strong>相互隔离</strong>.</li> <li>部署在同一个 Web 容器中<strong>相同的类库相同的版本可以共享</strong>. 否则, 如果服务器有 10 个应用程序, 那么要有 10 份相同的类库加载进虚拟机.</li> <li><strong>Web 容器也有自己依赖的类库, 不能与应用程序的类库混淆</strong>. 基于安全考虑, 应该让容器的类库和程序的<strong>类库隔离</strong>开来.</li></ul> <p><strong>Tomcat 如果使用默认的双亲委派类加载机制行不行? ​</strong>答案是不行的.</p> <ul><li>第一个问题, 如果使用默认的类加载器机制, 那么是无法加载两个相同类库的不同版本的, 默认的类加器是不管是什么版本的, 只在乎全限定类名, 并且只有一份.</li> <li>第二个问题, 默认的类加载器是能够实现的, 因为他的职责就是保证<strong>唯一性</strong>.</li> <li>第三个问题和第一个问题一样.</li></ul> <p>Tomcat 的几个<strong>主要类加载器</strong>:</p> <ul><li><strong>CommonClassLoader</strong>: Tomcat 最基本的类加载器, 加载路径中的 class 可以被 Tomcat 容器本身以及各个 Webapp 访问.</li> <li><strong>CatalinaClassLoader</strong>: Tomcat 容器私有的类加载器, 加载路径中的 class 对于 Webapp 不可见.</li> <li><strong>SharedClassLoader</strong>: 各个 Webapp 共享的类加载器, 加载路径中的 class 对于所有 Webapp 可见, 但是对于 Tomcat 容器不可见.</li> <li><strong>WebappClassLoader</strong>: 各<strong>个 Webapp 私有的类加载器</strong>, 加载路径中的 class 只<strong>对当前 Webapp 可见</strong>, 比如加载 war 包里相关的类, 每个 war 包应用都有自己的 WebappClassLoader, 实现<strong>相互隔离</strong>, 比如不同 war 包应用引入了不同的 spring 版本, 这样实现就能加载各自的 spring 版本; 每个 war 包都有一个 WebappClassLoader 来加载自己的东西, 不再进行双亲委派, 打破了双亲委派机制.</li></ul> <p>几个类加载器的关系如下:</p> <p><img src="assets/4.%E7%B1%BB%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E4%B8%8E%E7%B1%BB%E5%8A%A0%E8%BD%BD%E6%9C%BA%E5%88%B6-Tomcat%E7%B1%BB%E5%8A%A0%E8%BD%BD%E5%99%A8%E6%A8%A1%E5%9E%8B-20230329223827-jn5ynbg.png" alt="4.类文件结构与类加载机制-Tomcat类加载器模型"></p> <p>从图中可以看出, <strong>CommonClassLoader</strong> 能加载的类都可以被 CatalinaClassLoader 和 SharedClassLoader 使用, 从而实现了<strong>公有类库</strong>的共用, 而 CatalinaClassLoader 和 SharedClassLoader 自己<strong>能加载的类则与对方相互隔离</strong>. <strong>WebAppClassLoader</strong> 可以使用 SharedClassLoader 加载到的类, 但各个 WebAppClassLoader 实例之间<strong>相互隔离</strong>. 而 JasperLoader 的加载范围仅仅是这个 JSP 文件所编译出来的那一个 .Class 文件, 它出现的目的就是为了被丢弃: 当 Web 容器检测到 JSP 文件被修改时, 会替换掉目前的 JasperLoader 的实例, 并通过再建立一个新的 Jsp 类加载器来实现 JSP 文件的热加载功能.</p> <p>Tomcat 这种类加载机制违背了 Java 推荐的双亲委派模型. Tomcat 为了实现隔离性, <strong>每个 webappClassLoader 加载自己的目录下的 class 文件, 不会传递给父类加载器, 打破了双亲委派机制</strong>.</p> <p><strong>模拟实现 Tomcat 的 webappClassLoader 加载自己 war 包应用内不同版本类实现相互共存与隔离</strong>.</p> <p>注意: 同一个 JVM 内, <strong>两个相同包名和类名的类对象可以共存</strong>, 因为他们的<strong>类加载器可以不一样</strong>, 所以看两个类对象是否是同一个, 除了看类的包名和类名是否都相同之外, 还需要他们的<strong>类加载器也是同一个才能认为他们是同一个</strong>.</p> <blockquote><p>同一个类的不同版本如何加载到 JVM 中?</p></blockquote> <p><strong>自定义类加载器</strong>就行了. 类似于 Tomcat.</p> <h5 id="_1-类的相等"><a href="#_1-类的相等" class="header-anchor">#</a> 1.类的相等</h5> <p><strong>两个类相等</strong>, 需要类本身相等, 并且使用<strong>同一个类加载器</strong>进行加载. 这是因为<strong>每一个类加载器</strong>都拥有一个<strong>独立的类名称空间</strong>. <strong>相同的字节码被不同的类加载器加载后类不相等</strong>.</p> <p>这里的<strong>相等</strong>, 包括类的 Class 对象的 <strong>equals</strong>() 方法, <strong>isAssignableFrom</strong>() 方法, <strong>isInstance</strong>() 方法的返回结果为 true, 也包括使用 instanceof 关键字做对象所属关系判定结果为 true.</p> <h4 id="综合实例"><a href="#综合实例" class="header-anchor">#</a> 综合实例</h4> <p>一个简单的类:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Student</span> <span class="token punctuation">{</span>
    
    <span class="token keyword">private</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span>
      
    <span class="token keyword">public</span> <span class="token class-name">Student</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">hello</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>Main 方法:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Test</span> <span class="token punctuation">{</span>
    
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Student</span> stu <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Student</span><span class="token punctuation">(</span><span class="token string">&quot;Jack&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        stu<span class="token punctuation">.</span><span class="token function">hello</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> 
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>执行 main 方法的步骤如下:</p> <ol><li>编译好 Test.java 后得到 Test.class 后, 执行 Test.class, 系统会启动一个 JVM 进程, 从 <strong>classpath</strong> 路径中找到一个名为 <strong>Test.class 的二进制文件</strong>, 将 <strong>Test 的类信息加载到运行时数据区的方法区内, 这个过程即 Test 类的加载</strong>.</li> <li>JVM 找到 Test 的主程序入口, 执行 main 方法.</li> <li>这个 main 中的第一条语句就是让 JVM <strong>创建一个 Student 对象</strong>, 但是这个时候<strong>方法区</strong>中是没有 Student 类的信息的, 所以 JVM 马上<strong>加载 Student 类</strong>, 把 Student 类的信息放到方法区中.</li> <li>加载完 Student 类后, JVM 在<strong>堆中</strong>为一个新的 Student <strong>实例分配内存</strong>, 然后调用构造函数初始化 Student 实例, 这个 Student 实例持有<strong>指向方法区中的 Student 类的类型信息</strong> 的引用.</li> <li>执行 stu.hello() 时, JVM 根据 <strong>stu 的引用找到 stu 对象</strong>, 然后根据 stu 对象<strong>持有的引用定位到方法区中 stu 类的类型信息的方法表</strong>, 获得 hello() 的<strong>字节码地址</strong>.</li> <li>执行 hello() 方法.</li></ol> <p><strong>总结一下就是对象实例初始化时会去方法区中找类信息, 完成后再到栈那里去运行方法. 找方法就在方法表中找.</strong></p> <p>‍</p> <h4 id="参考资料"><a href="#参考资料" class="header-anchor">#</a> 参考资料</h4> <ul><li><a href="https://docs.oracle.com/javase/specs/jvms/se7/html/jvms-4.html" target="_blank" rel="noopener noreferrer">https://docs.oracle.com/javase/specs/jvms/se7/html/jvms-4.html<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://coolshell.cn/articles/9229.html" target="_blank" rel="noopener noreferrer">https://coolshell.cn/articles/9229.html<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://blog.csdn.net/luanlouis/article/details/39960815" target="_blank" rel="noopener noreferrer">https://blog.csdn.net/luanlouis/article/details/39960815<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li>《实战 Java 虚拟机》</li> <li><a href="https://blog.csdn.net/xiaobao5214/article/details/81674215" target="_blank" rel="noopener noreferrer">https://blog.csdn.net/xiaobao5214/article/details/81674215<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://blog.csdn.net/xyang81/article/details/7292380" target="_blank" rel="noopener noreferrer">https://blog.csdn.net/xyang81/article/details/7292380<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://juejin.im/post/5c04892351882516e70dcc9b" target="_blank" rel="noopener noreferrer">https://juejin.im/post/5c04892351882516e70dcc9b<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="http://gityuan.com/2016/01/24/java-classloader/" target="_blank" rel="noopener noreferrer">http://gityuan.com/2016/01/24/java-classloader/<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://blog.csdn.net/qq_31777123/article/details/80036682" target="_blank" rel="noopener noreferrer">https://blog.csdn.net/qq_31777123/article/details/80036682<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div>  <div class="page-edit"><div class="edit-link"><a href="https://github.com/xugaoyi/vuepress-theme-vdoing/edit/main/docs/20.开发/2200.JVM/4.类文件结构与类加载机制.md" target="_blank" rel="noopener noreferrer">编辑</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <!----> <!----></div> <div class="page-nav-wapper"><!----> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/pages/d09a16/" class="prev">JVM监控与故障处理工具</a></span> <span class="next"><a href="/pages/3d00d5/">虚拟机方法调用与指令执行引擎</a>→
      </span></p></div></div></div> <div class="article-list"><div class="article-title"><a href="/archives/" class="iconfont icon-bi">最近更新</a></div> <div class="article-wrapper"><dl><dd>01</dd> <dt><a href="/pages/f90282/"><div>
            基础
            <!----></div></a> <span class="date">06-08</span></dt></dl><dl><dd>02</dd> <dt><a href="/pages/0f75ac/"><div>
            搜索二叉树BST
            <!----></div></a> <span class="date">06-08</span></dt></dl><dl><dd>03</dd> <dt><a href="/pages/39721f/"><div>
            平衡二叉树AVL
            <!----></div></a> <span class="date">06-08</span></dt></dl> <dl><dd></dd> <dt><a href="/archives/" class="more">更多文章&gt;</a></dt></dl></div></div></main></div> <div class="footer"><div class="icons"><a href="mailto:1174520425@qq.com" title="发邮件" target="_blank" class="iconfont icon-youjian"></a><a href="https://github.com/nanodaemony" title="GitHub" target="_blank" class="iconfont icon-github"></a></div> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="本站主题">Vdoing</a> 
    | Copyright © 2019-2023
    <span>达尔文的猹 | MIT License</span></div> <div class="buttons"><div title="返回顶部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去评论" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主题模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          跟随系统
        </li><li class="iconfont icon-rijianmoshi">
          浅色模式
        </li><li class="iconfont icon-yejianmoshi">
          深色模式
        </li><li class="iconfont icon-yuedu">
          阅读模式
        </li></ul></div></div> <!----> <!----> <!----></div><div class="global-ui"><div></div></div></div>
    <script src="/assets/js/app.5bc2c979.js" defer></script><script src="/assets/js/2.eccd4273.js" defer></script><script src="/assets/js/168.e388905a.js" defer></script>
  </body>
</html>
