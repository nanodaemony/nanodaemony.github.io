<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>JVM内存区域与对象解析🌼 | Pangolin Note</title>
    <meta name="generator" content="VuePress 1.9.5">
    <link rel="icon" href="/img/favicon.ico">
    <meta name="description" content="大道至简">
    <meta name="keywords" content="前端博客,个人技术博客,前端,前端开发,前端框架,web前端,前端面试题,技术文档,学习,面试,JavaScript,js,ES6,TypeScript,vue,python,css3,html5,Node,git,github,markdown">
    <meta name="baidu-site-verification" content="7F55weZDDc">
    <meta name="theme-color" content="#11a8cd">
    
    <link rel="preload" href="/assets/css/0.styles.56073ad3.css" as="style"><link rel="preload" href="/assets/js/app.3f3e0e10.js" as="script"><link rel="preload" href="/assets/js/2.e9fcb30c.js" as="script"><link rel="preload" href="/assets/js/3.1998f389.js" as="script"><link rel="preload" href="/assets/js/78.54d84cd4.js" as="script"><link rel="prefetch" href="/assets/js/10.0b55747f.js"><link rel="prefetch" href="/assets/js/100.b8912a99.js"><link rel="prefetch" href="/assets/js/101.a6740c8a.js"><link rel="prefetch" href="/assets/js/102.e31e89b2.js"><link rel="prefetch" href="/assets/js/103.2c5dbdae.js"><link rel="prefetch" href="/assets/js/104.0e9c02f6.js"><link rel="prefetch" href="/assets/js/105.8288396c.js"><link rel="prefetch" href="/assets/js/106.62f43c11.js"><link rel="prefetch" href="/assets/js/107.70c90211.js"><link rel="prefetch" href="/assets/js/108.b488ce56.js"><link rel="prefetch" href="/assets/js/109.12942650.js"><link rel="prefetch" href="/assets/js/11.ac3fd1ca.js"><link rel="prefetch" href="/assets/js/110.1e57ecba.js"><link rel="prefetch" href="/assets/js/111.6e33b4ea.js"><link rel="prefetch" href="/assets/js/112.bd52831b.js"><link rel="prefetch" href="/assets/js/113.868c1ac9.js"><link rel="prefetch" href="/assets/js/114.090549d1.js"><link rel="prefetch" href="/assets/js/115.d97f6c2b.js"><link rel="prefetch" href="/assets/js/116.097c4b4e.js"><link rel="prefetch" href="/assets/js/117.4024cfe2.js"><link rel="prefetch" href="/assets/js/118.e3057cba.js"><link rel="prefetch" href="/assets/js/119.4ef1fa3b.js"><link rel="prefetch" href="/assets/js/12.863eaabe.js"><link rel="prefetch" href="/assets/js/120.78f9df50.js"><link rel="prefetch" href="/assets/js/121.8e16df87.js"><link rel="prefetch" href="/assets/js/122.f21c0107.js"><link rel="prefetch" href="/assets/js/123.ea1cb375.js"><link rel="prefetch" href="/assets/js/124.01c04c6e.js"><link rel="prefetch" href="/assets/js/125.d383e301.js"><link rel="prefetch" href="/assets/js/126.3162cb47.js"><link rel="prefetch" href="/assets/js/127.c6bebae6.js"><link rel="prefetch" href="/assets/js/128.d659db60.js"><link rel="prefetch" href="/assets/js/129.2afdcf48.js"><link rel="prefetch" href="/assets/js/13.4f59ce35.js"><link rel="prefetch" href="/assets/js/130.beb9ed9d.js"><link rel="prefetch" href="/assets/js/131.35b05f8a.js"><link rel="prefetch" href="/assets/js/132.d77f4f93.js"><link rel="prefetch" href="/assets/js/133.4ceda6e5.js"><link rel="prefetch" href="/assets/js/134.11390c5f.js"><link rel="prefetch" href="/assets/js/135.32f9e38f.js"><link rel="prefetch" href="/assets/js/136.6d8bb0f2.js"><link rel="prefetch" href="/assets/js/137.9c0ffeef.js"><link rel="prefetch" href="/assets/js/138.88d86e5f.js"><link rel="prefetch" href="/assets/js/139.8c2c3d6c.js"><link rel="prefetch" href="/assets/js/14.11c82d35.js"><link rel="prefetch" href="/assets/js/140.c5c375d3.js"><link rel="prefetch" href="/assets/js/141.d703f30b.js"><link rel="prefetch" href="/assets/js/142.6a005a44.js"><link rel="prefetch" href="/assets/js/143.9b2edf6f.js"><link rel="prefetch" href="/assets/js/144.3fd013c9.js"><link rel="prefetch" href="/assets/js/145.b05079c5.js"><link rel="prefetch" href="/assets/js/146.ed5360a6.js"><link rel="prefetch" href="/assets/js/147.7408d86f.js"><link rel="prefetch" href="/assets/js/148.f390b370.js"><link rel="prefetch" href="/assets/js/149.95017f0a.js"><link rel="prefetch" href="/assets/js/15.bd143bd5.js"><link rel="prefetch" href="/assets/js/150.f0ede764.js"><link rel="prefetch" href="/assets/js/151.b7093623.js"><link rel="prefetch" href="/assets/js/152.a82a6c83.js"><link rel="prefetch" href="/assets/js/153.965e3fb2.js"><link rel="prefetch" href="/assets/js/154.9e49311e.js"><link rel="prefetch" href="/assets/js/155.cef33ba5.js"><link rel="prefetch" href="/assets/js/156.bcc397ae.js"><link rel="prefetch" href="/assets/js/157.90824739.js"><link rel="prefetch" href="/assets/js/158.efd429b9.js"><link rel="prefetch" href="/assets/js/159.122ff5b7.js"><link rel="prefetch" href="/assets/js/16.2449162b.js"><link rel="prefetch" href="/assets/js/160.0b806535.js"><link rel="prefetch" href="/assets/js/161.835052c6.js"><link rel="prefetch" href="/assets/js/162.ca34e2d2.js"><link rel="prefetch" href="/assets/js/163.08000d04.js"><link rel="prefetch" href="/assets/js/164.a1cc0109.js"><link rel="prefetch" href="/assets/js/165.65444686.js"><link rel="prefetch" href="/assets/js/166.7d73c84f.js"><link rel="prefetch" href="/assets/js/167.009d47a3.js"><link rel="prefetch" href="/assets/js/168.0afeae2a.js"><link rel="prefetch" href="/assets/js/169.7654cb31.js"><link rel="prefetch" href="/assets/js/17.eb7f9def.js"><link rel="prefetch" href="/assets/js/170.58569530.js"><link rel="prefetch" href="/assets/js/171.7db9ed40.js"><link rel="prefetch" href="/assets/js/172.3cb50ed4.js"><link rel="prefetch" href="/assets/js/173.0846425f.js"><link rel="prefetch" href="/assets/js/174.9e95f111.js"><link rel="prefetch" href="/assets/js/175.ef2098f2.js"><link rel="prefetch" href="/assets/js/176.c2635fe9.js"><link rel="prefetch" href="/assets/js/177.4fa38e8e.js"><link rel="prefetch" href="/assets/js/178.2be7037f.js"><link rel="prefetch" href="/assets/js/179.bf3bba28.js"><link rel="prefetch" href="/assets/js/18.0455f4d1.js"><link rel="prefetch" href="/assets/js/180.72c5f597.js"><link rel="prefetch" href="/assets/js/181.42287bcc.js"><link rel="prefetch" href="/assets/js/182.6cd4bf1a.js"><link rel="prefetch" href="/assets/js/183.05dbbfd9.js"><link rel="prefetch" href="/assets/js/184.03de7e00.js"><link rel="prefetch" href="/assets/js/185.42dd210e.js"><link rel="prefetch" href="/assets/js/186.28ee0f8a.js"><link rel="prefetch" href="/assets/js/187.bb58697b.js"><link rel="prefetch" href="/assets/js/188.1bc8be96.js"><link rel="prefetch" href="/assets/js/189.fac747e3.js"><link rel="prefetch" href="/assets/js/19.ae9e35d6.js"><link rel="prefetch" href="/assets/js/190.ea533ac7.js"><link rel="prefetch" href="/assets/js/191.6dc6eb13.js"><link rel="prefetch" href="/assets/js/192.184d249f.js"><link rel="prefetch" href="/assets/js/193.4a06bc12.js"><link rel="prefetch" href="/assets/js/194.8cce60a9.js"><link rel="prefetch" href="/assets/js/195.93231a13.js"><link rel="prefetch" href="/assets/js/196.4a596bde.js"><link rel="prefetch" href="/assets/js/197.96c113cf.js"><link rel="prefetch" href="/assets/js/198.73ba3f67.js"><link rel="prefetch" href="/assets/js/199.74bab595.js"><link rel="prefetch" href="/assets/js/20.b542d0e7.js"><link rel="prefetch" href="/assets/js/200.69a6928a.js"><link rel="prefetch" href="/assets/js/201.9ffa7c5a.js"><link rel="prefetch" href="/assets/js/202.41edb652.js"><link rel="prefetch" href="/assets/js/203.7fabcef3.js"><link rel="prefetch" href="/assets/js/204.b0ae2f62.js"><link rel="prefetch" href="/assets/js/205.add8738b.js"><link rel="prefetch" href="/assets/js/206.f3a712ec.js"><link rel="prefetch" href="/assets/js/207.cd7dd729.js"><link rel="prefetch" href="/assets/js/208.78b33afa.js"><link rel="prefetch" href="/assets/js/209.9d3329ff.js"><link rel="prefetch" href="/assets/js/21.5a050318.js"><link rel="prefetch" href="/assets/js/210.d285d5ac.js"><link rel="prefetch" href="/assets/js/211.8791bb3f.js"><link rel="prefetch" href="/assets/js/212.84ed81a8.js"><link rel="prefetch" href="/assets/js/213.7b990580.js"><link rel="prefetch" href="/assets/js/214.da31f20c.js"><link rel="prefetch" href="/assets/js/215.9eeed659.js"><link rel="prefetch" href="/assets/js/216.9539f0ec.js"><link rel="prefetch" href="/assets/js/217.11b575be.js"><link rel="prefetch" href="/assets/js/218.a67f12f1.js"><link rel="prefetch" href="/assets/js/219.bfbb817a.js"><link rel="prefetch" href="/assets/js/22.2bc6f7e3.js"><link rel="prefetch" href="/assets/js/220.8b01342f.js"><link rel="prefetch" href="/assets/js/221.b450decd.js"><link rel="prefetch" href="/assets/js/222.97468507.js"><link rel="prefetch" href="/assets/js/223.b6dafd73.js"><link rel="prefetch" href="/assets/js/224.c86c18c6.js"><link rel="prefetch" href="/assets/js/225.b0dcf86e.js"><link rel="prefetch" href="/assets/js/226.02cc2999.js"><link rel="prefetch" href="/assets/js/227.8474ef5a.js"><link rel="prefetch" href="/assets/js/228.0298e421.js"><link rel="prefetch" href="/assets/js/229.6aeaf595.js"><link rel="prefetch" href="/assets/js/23.9995fce4.js"><link rel="prefetch" href="/assets/js/230.a5785286.js"><link rel="prefetch" href="/assets/js/231.d791daa4.js"><link rel="prefetch" href="/assets/js/232.97aeeb00.js"><link rel="prefetch" href="/assets/js/233.46e51e28.js"><link rel="prefetch" href="/assets/js/234.2cffe82f.js"><link rel="prefetch" href="/assets/js/235.14965da6.js"><link rel="prefetch" href="/assets/js/236.00a5afc0.js"><link rel="prefetch" href="/assets/js/237.3b73d52f.js"><link rel="prefetch" href="/assets/js/238.6e1db765.js"><link rel="prefetch" href="/assets/js/239.75866c5e.js"><link rel="prefetch" href="/assets/js/24.9141eeb2.js"><link rel="prefetch" href="/assets/js/240.af9c2cc9.js"><link rel="prefetch" href="/assets/js/241.388acab2.js"><link rel="prefetch" href="/assets/js/242.c60f2b48.js"><link rel="prefetch" href="/assets/js/243.d8e81b13.js"><link rel="prefetch" href="/assets/js/244.58b0b21d.js"><link rel="prefetch" href="/assets/js/245.c3768497.js"><link rel="prefetch" href="/assets/js/246.ac8bbe7a.js"><link rel="prefetch" href="/assets/js/247.d095f70a.js"><link rel="prefetch" href="/assets/js/248.e9f210b5.js"><link rel="prefetch" href="/assets/js/249.a9fad023.js"><link rel="prefetch" href="/assets/js/25.98e8593e.js"><link rel="prefetch" href="/assets/js/250.ae7f0ebb.js"><link rel="prefetch" href="/assets/js/251.9a617d55.js"><link rel="prefetch" href="/assets/js/252.ce082446.js"><link rel="prefetch" href="/assets/js/253.4575302d.js"><link rel="prefetch" href="/assets/js/254.5899a61b.js"><link rel="prefetch" href="/assets/js/255.66c69f31.js"><link rel="prefetch" href="/assets/js/256.8fd6c706.js"><link rel="prefetch" href="/assets/js/257.31b77e5e.js"><link rel="prefetch" href="/assets/js/258.eba48891.js"><link rel="prefetch" href="/assets/js/259.edf74b59.js"><link rel="prefetch" href="/assets/js/26.e69924ea.js"><link rel="prefetch" href="/assets/js/260.cf2ed36d.js"><link rel="prefetch" href="/assets/js/261.9e7792d8.js"><link rel="prefetch" href="/assets/js/262.e7b9433e.js"><link rel="prefetch" href="/assets/js/263.1185b25c.js"><link rel="prefetch" href="/assets/js/264.5e0f89cb.js"><link rel="prefetch" href="/assets/js/265.a38d3b94.js"><link rel="prefetch" href="/assets/js/266.2ef170b3.js"><link rel="prefetch" href="/assets/js/267.a7d14651.js"><link rel="prefetch" href="/assets/js/268.05b18748.js"><link rel="prefetch" href="/assets/js/269.dad48d6f.js"><link rel="prefetch" href="/assets/js/27.13612515.js"><link rel="prefetch" href="/assets/js/270.4f5a6b8d.js"><link rel="prefetch" href="/assets/js/271.7ebf6682.js"><link rel="prefetch" href="/assets/js/272.7c2fbfd1.js"><link rel="prefetch" href="/assets/js/273.8ee20732.js"><link rel="prefetch" href="/assets/js/274.d525242a.js"><link rel="prefetch" href="/assets/js/275.a8a19acb.js"><link rel="prefetch" href="/assets/js/276.df3a4eb4.js"><link rel="prefetch" href="/assets/js/277.336debda.js"><link rel="prefetch" href="/assets/js/278.c470625f.js"><link rel="prefetch" href="/assets/js/279.a91e1a64.js"><link rel="prefetch" href="/assets/js/28.ab7ae1df.js"><link rel="prefetch" href="/assets/js/280.87e25c9a.js"><link rel="prefetch" href="/assets/js/281.87c1ba25.js"><link rel="prefetch" href="/assets/js/282.dcd4dce0.js"><link rel="prefetch" href="/assets/js/283.abac2e00.js"><link rel="prefetch" href="/assets/js/284.f6079659.js"><link rel="prefetch" href="/assets/js/285.f1b39879.js"><link rel="prefetch" href="/assets/js/286.f6a79242.js"><link rel="prefetch" href="/assets/js/287.06bebe07.js"><link rel="prefetch" href="/assets/js/288.89e325df.js"><link rel="prefetch" href="/assets/js/289.3aa1bedd.js"><link rel="prefetch" href="/assets/js/29.ebe50f76.js"><link rel="prefetch" href="/assets/js/290.ee059c92.js"><link rel="prefetch" href="/assets/js/291.fa9a921a.js"><link rel="prefetch" href="/assets/js/292.2a8811cd.js"><link rel="prefetch" href="/assets/js/293.eec09cdf.js"><link rel="prefetch" href="/assets/js/294.dfac20dc.js"><link rel="prefetch" href="/assets/js/295.825d2070.js"><link rel="prefetch" href="/assets/js/296.f645861e.js"><link rel="prefetch" href="/assets/js/297.424fdb17.js"><link rel="prefetch" href="/assets/js/298.ebf87cdc.js"><link rel="prefetch" href="/assets/js/299.b8f19cbb.js"><link rel="prefetch" href="/assets/js/30.75237511.js"><link rel="prefetch" href="/assets/js/300.10fb6d4f.js"><link rel="prefetch" href="/assets/js/301.ef77c612.js"><link rel="prefetch" href="/assets/js/302.1b839763.js"><link rel="prefetch" href="/assets/js/303.609f7d98.js"><link rel="prefetch" href="/assets/js/304.1d255f19.js"><link rel="prefetch" href="/assets/js/305.b0234f2c.js"><link rel="prefetch" href="/assets/js/306.48677f64.js"><link rel="prefetch" href="/assets/js/307.14390d4b.js"><link rel="prefetch" href="/assets/js/308.fa730b28.js"><link rel="prefetch" href="/assets/js/309.0496b9e0.js"><link rel="prefetch" href="/assets/js/31.cf3f471a.js"><link rel="prefetch" href="/assets/js/310.a31676dc.js"><link rel="prefetch" href="/assets/js/311.ed53adc5.js"><link rel="prefetch" href="/assets/js/312.1b0ff2f1.js"><link rel="prefetch" href="/assets/js/313.bf123f32.js"><link rel="prefetch" href="/assets/js/314.4e6ce06b.js"><link rel="prefetch" href="/assets/js/315.8eb18560.js"><link rel="prefetch" href="/assets/js/32.74fef842.js"><link rel="prefetch" href="/assets/js/33.bc2d190b.js"><link rel="prefetch" href="/assets/js/34.d23438fc.js"><link rel="prefetch" href="/assets/js/35.7675c4d0.js"><link rel="prefetch" href="/assets/js/36.96a4161b.js"><link rel="prefetch" href="/assets/js/37.d1824f2f.js"><link rel="prefetch" href="/assets/js/38.4effff9e.js"><link rel="prefetch" href="/assets/js/39.6509914b.js"><link rel="prefetch" href="/assets/js/4.4d01750f.js"><link rel="prefetch" href="/assets/js/40.1509d08b.js"><link rel="prefetch" href="/assets/js/41.f2c1124f.js"><link rel="prefetch" href="/assets/js/42.e541d077.js"><link rel="prefetch" href="/assets/js/43.369de999.js"><link rel="prefetch" href="/assets/js/44.43959db0.js"><link rel="prefetch" href="/assets/js/45.282fbd31.js"><link rel="prefetch" href="/assets/js/46.1b83cfe9.js"><link rel="prefetch" href="/assets/js/47.c3a88e41.js"><link rel="prefetch" href="/assets/js/48.bc7c0a1b.js"><link rel="prefetch" href="/assets/js/49.92a4e5ba.js"><link rel="prefetch" href="/assets/js/5.c3991e24.js"><link rel="prefetch" href="/assets/js/50.9c488c6c.js"><link rel="prefetch" href="/assets/js/51.546ea632.js"><link rel="prefetch" href="/assets/js/52.0d2ccee1.js"><link rel="prefetch" href="/assets/js/53.6f52b5b1.js"><link rel="prefetch" href="/assets/js/54.c838b295.js"><link rel="prefetch" href="/assets/js/55.13af99ee.js"><link rel="prefetch" href="/assets/js/56.6be6d1ed.js"><link rel="prefetch" href="/assets/js/57.67c98b39.js"><link rel="prefetch" href="/assets/js/58.107e82ec.js"><link rel="prefetch" href="/assets/js/59.b3e5edc7.js"><link rel="prefetch" href="/assets/js/6.36a535f9.js"><link rel="prefetch" href="/assets/js/60.3b0b4ba5.js"><link rel="prefetch" href="/assets/js/61.3df843df.js"><link rel="prefetch" href="/assets/js/62.1213823d.js"><link rel="prefetch" href="/assets/js/63.e8f3f926.js"><link rel="prefetch" href="/assets/js/64.e1219050.js"><link rel="prefetch" href="/assets/js/65.5bf5bb0b.js"><link rel="prefetch" href="/assets/js/66.a2502afb.js"><link rel="prefetch" href="/assets/js/67.690dd59b.js"><link rel="prefetch" href="/assets/js/68.de7b0915.js"><link rel="prefetch" href="/assets/js/69.ac61dd61.js"><link rel="prefetch" href="/assets/js/7.5d254238.js"><link rel="prefetch" href="/assets/js/70.3edd41b1.js"><link rel="prefetch" href="/assets/js/71.d23407e9.js"><link rel="prefetch" href="/assets/js/72.a5bd01bc.js"><link rel="prefetch" href="/assets/js/73.c9f4dd57.js"><link rel="prefetch" href="/assets/js/74.66323fc1.js"><link rel="prefetch" href="/assets/js/75.e1a72e00.js"><link rel="prefetch" href="/assets/js/76.801268b4.js"><link rel="prefetch" href="/assets/js/77.3a5fda67.js"><link rel="prefetch" href="/assets/js/79.fa10f4e3.js"><link rel="prefetch" href="/assets/js/8.e060e47d.js"><link rel="prefetch" href="/assets/js/80.d5b24fea.js"><link rel="prefetch" href="/assets/js/81.0e9da714.js"><link rel="prefetch" href="/assets/js/82.e96ff6d7.js"><link rel="prefetch" href="/assets/js/83.771cced1.js"><link rel="prefetch" href="/assets/js/84.220b69e7.js"><link rel="prefetch" href="/assets/js/85.7dcc5659.js"><link rel="prefetch" href="/assets/js/86.44ba2100.js"><link rel="prefetch" href="/assets/js/87.281da75d.js"><link rel="prefetch" href="/assets/js/88.12d88449.js"><link rel="prefetch" href="/assets/js/89.f28c86d3.js"><link rel="prefetch" href="/assets/js/9.8f9fef32.js"><link rel="prefetch" href="/assets/js/90.715cabb2.js"><link rel="prefetch" href="/assets/js/91.6ced7c82.js"><link rel="prefetch" href="/assets/js/92.c05b33ca.js"><link rel="prefetch" href="/assets/js/93.6bf5fb66.js"><link rel="prefetch" href="/assets/js/94.3561200e.js"><link rel="prefetch" href="/assets/js/95.0f2cf716.js"><link rel="prefetch" href="/assets/js/96.ac8487ea.js"><link rel="prefetch" href="/assets/js/97.48042b5a.js"><link rel="prefetch" href="/assets/js/98.441bb7f8.js"><link rel="prefetch" href="/assets/js/99.4b214d92.js">
    <link rel="stylesheet" href="/assets/css/0.styles.56073ad3.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu"><header class="navbar blur"><div title="目录" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/img/magic.png" alt="Pangolin Note" class="logo"> <span class="site-name can-hide">Pangolin Note</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">🏡首页</a></div><div class="nav-item"><a href="/basic/" class="nav-link">基础</a></div><div class="nav-item"><a href="/develop/" class="nav-link">开发</a></div><div class="nav-item"><a href="/middleware/" class="nav-link">系统</a></div><div class="nav-item"><a href="/algorithm/" class="nav-link">算法</a></div><div class="nav-item"><a href="/books/" class="nav-link">🍀读书笔记</a></div><div class="nav-item"><a href="/work/" class="nav-link">工作</a></div><div class="nav-item"><a href="/pangolin/" class="nav-link">🌸达尔文的猹</a></div><div class="nav-item"><a href="/pages/beb6c0bd8a66cea6/" class="nav-link">收藏</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/archives/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">归档</a></li></ul></div></div> <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><div class="blogger"><img src="/img/avatarnew.png"> <div class="blogger-info"><h3>达尔文的猹</h3> <span>大道至简 悟在天成</span></div></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">🏡首页</a></div><div class="nav-item"><a href="/basic/" class="nav-link">基础</a></div><div class="nav-item"><a href="/develop/" class="nav-link">开发</a></div><div class="nav-item"><a href="/middleware/" class="nav-link">系统</a></div><div class="nav-item"><a href="/algorithm/" class="nav-link">算法</a></div><div class="nav-item"><a href="/books/" class="nav-link">🍀读书笔记</a></div><div class="nav-item"><a href="/work/" class="nav-link">工作</a></div><div class="nav-item"><a href="/pangolin/" class="nav-link">🌸达尔文的猹</a></div><div class="nav-item"><a href="/pages/beb6c0bd8a66cea6/" class="nav-link">收藏</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/archives/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">归档</a></li></ul></div></div> <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Java</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading"><span>基础</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/4f30b9/" class="sidebar-link">Java基础</a></li><li><a href="/pages/795eca/" class="sidebar-link">类与继承</a></li><li><a href="/pages/c69152/" class="sidebar-link">抽象类与接口</a></li><li><a href="/pages/d71abb/" class="sidebar-link">内部类</a></li><li><a href="/pages/f06dca/" class="sidebar-link">枚举类</a></li><li><a href="/pages/259f57/" class="sidebar-link">常用类</a></li><li><a href="/pages/84b03b/" class="sidebar-link">关键字</a></li><li><a href="/pages/31b87b/" class="sidebar-link">注解</a></li><li><a href="/pages/f81c0d/" class="sidebar-link">异常</a></li><li><a href="/pages/ae7746/" class="sidebar-link">泛型</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading"><span>容器类</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/0c88ac/" class="sidebar-link">集合容器类基础</a></li><li><a href="/pages/f805ed/" class="sidebar-link">List与Queue类</a></li><li><a href="/pages/d24b60/" class="sidebar-link">Map与Set类</a></li><li><a href="/pages/54e5d3/" class="sidebar-link">并发容器类</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading"><span>并发</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/67d70f/" class="sidebar-link">多线程基础</a></li><li><a href="/pages/ffc8f7/" class="sidebar-link">Java内置锁</a></li><li><a href="/pages/c43494/" class="sidebar-link">AQS</a></li><li><a href="/pages/eb5b61/" class="sidebar-link">显式锁ReentrantLock</a></li><li><a href="/pages/eb8cbc/" class="sidebar-link">线程协作与JUC组件</a></li><li><a href="/pages/23c79a/" class="sidebar-link">Atomic原子变量与Unsafe类与CAS</a></li><li><a href="/pages/9d6ed4/" class="sidebar-link">线程池与定时任务</a></li><li><a href="/pages/5b787a/" class="sidebar-link">ThreadLocal</a></li><li><a href="/pages/db53d1/" class="sidebar-link">Java并发编程实战(极客时间)🌸</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading"><span>IO</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/b4d461/" class="sidebar-link">文件操作</a></li><li><a href="/pages/1b9d6c/" class="sidebar-link">IO流操作</a></li><li><a href="/pages/076a47/" class="sidebar-link">Java网络IO模型</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading"><span>高级特性</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/d76905/" class="sidebar-link">Lambda表达式</a></li><li><a href="/pages/f7f0e6/" class="sidebar-link">流Stream</a></li><li><a href="/pages/7cc40a/" class="sidebar-link">反射</a></li><li><a href="/pages/945326/" class="sidebar-link">代理</a></li><li><a href="/pages/7fd9b4/" class="sidebar-link">Javaagent</a></li><li><a href="/pages/a3cee0/" class="sidebar-link">Guava</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading open"><span>JVM</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/d308f6/" class="sidebar-link">走进JVM🌼</a></li><li><a href="/pages/be0269/" aria-current="page" class="active sidebar-link">JVM内存区域与对象解析🌼</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/pages/48d1be/" class="sidebar-link">垃圾收集器与内存分配策略🌼</a></li><li><a href="/pages/3a4c8a/" class="sidebar-link">JVM性能监控与故障处理工具🌼</a></li><li><a href="/pages/106680/" class="sidebar-link">调优案例分析与实战🌼</a></li><li><a href="/pages/16a914/" class="sidebar-link">类文件结构🌼</a></li><li><a href="/pages/ea287c/" class="sidebar-link">虚拟机类加载机制🌼</a></li><li><a href="/pages/6367b0/" class="sidebar-link">虚拟机字节码执行引擎🌼</a></li><li><a href="/pages/c6c210/" class="sidebar-link">类加载及执行子系统的案例与实战🌼</a></li><li><a href="/pages/deb8b7/" class="sidebar-link">前端编译与优化🌼</a></li><li><a href="/pages/1f8f72/" class="sidebar-link">后端编译与优化🌼</a></li><li><a href="/pages/3d72db/" class="sidebar-link">Java内存模型与线程实现🌼</a></li><li><a href="/pages/ed086e/" class="sidebar-link">线程安全与内置锁优化🌼</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading"><span>其他</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/56b9dd/" class="sidebar-link">Java性能问题定位分析</a></li><li><a href="/pages/939bf8/" class="sidebar-link">杂记</a></li></ul></section></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>开发</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading open"><span>软件设计</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/a5f6fe/" class="sidebar-link">设计基础理论</a></li><li><a href="/pages/3b245c/" class="sidebar-link">设计模式之美(极客时间)🌟</a></li><li><a href="/pages/661fa4/" class="sidebar-link">领域驱动设计(DDD)</a></li><li><a href="/pages/856368/" class="sidebar-link">DDD实战课(极客时间)🌸</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading"><span>数据库</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/d3fbd2/" class="sidebar-link">数据库基础</a></li><li><a href="/pages/691fc3/" class="sidebar-link">数据库系统原理</a></li><li><a href="/pages/50f6b7/" class="sidebar-link">MySQL基础必知必会</a></li><li><a href="/pages/fe297e/" class="sidebar-link">MySQL特性</a></li><li><a href="/pages/07bdb6/" class="sidebar-link">MySQL索引🌟</a></li><li><a href="/pages/984715/" class="sidebar-link">MySQL锁🌟</a></li><li><a href="/pages/53b588/" class="sidebar-link">MySQL事务🌟</a></li><li><a href="/pages/becc59/" class="sidebar-link">MySQL高级特性</a></li><li><a href="/pages/056463/" class="sidebar-link">MySQL基础架构与存储引擎🌟</a></li><li><a href="/pages/63b46e/" class="sidebar-link">MySQL架构优化与运维</a></li><li><a href="/pages/9995e5/" class="sidebar-link">MySQL优化</a></li><li><a href="/pages/c1c2f6/" class="sidebar-link">MySQL架构</a></li><li><a href="/pages/8e8e0a/" class="sidebar-link">MySQL设计规范</a></li><li><a href="/pages/0219aa/" class="sidebar-link">MySQL运维</a></li><li><a href="/pages/e288c0/" class="sidebar-link">MySQL中间件</a></li><li><a href="/pages/c6cafa/" class="sidebar-link">MySQL实战45讲(极客时间)🌟</a></li><li><a href="/pages/4a6106/" class="sidebar-link">数据库LeetCode题目</a></li><li><a href="/pages/2827f1/" class="sidebar-link">数据库综合问题</a></li><li><a href="/pages/c616d5/" class="sidebar-link">MongoDB</a></li><li><a href="/pages/075e71/" class="sidebar-link">ClickHouse</a></li><li><a href="/pages/d74f6d/" class="sidebar-link">Doris</a></li><li><a href="/pages/b6bad9/" class="sidebar-link">HBase</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading"><span>Spring</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/bd8eb8/" class="sidebar-link">Spring Boot基础</a></li><li><a href="/pages/d0d797/" class="sidebar-link">Spring Boot应用整合</a></li><li><a href="/pages/314cdc/" class="sidebar-link">Spring MVC基础</a></li><li><a href="/pages/80de47/" class="sidebar-link">Spring AOP基础</a></li><li><a href="/pages/f0d4d6/" class="sidebar-link">Spring事务基础</a></li><li><a href="/pages/db6afe/" class="sidebar-link">Spring IOC源码分析-概览</a></li><li><a href="/pages/672e98/" class="sidebar-link">Spring IOC源码分析-getBean()</a></li><li><a href="/pages/695b90/" class="sidebar-link">Spring IOC源码分析-createBean()</a></li><li><a href="/pages/f89bcf/" class="sidebar-link">Spring AOP源码分析</a></li><li><a href="/pages/3b52f4/" class="sidebar-link">Spring事务源码分析</a></li><li><a href="/pages/186902/" class="sidebar-link">Spring Boot源码分析</a></li><li><a href="/pages/16bd1c/" class="sidebar-link">Spring MVC源码分析</a></li><li><a href="/pages/3d0c1f/" class="sidebar-link">Spring Cloud</a></li><li><a href="/pages/d56156/" class="sidebar-link">Spring编程常见错误50例(极客时间)🌸</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading"><span>MyBatis</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/bb032d/" class="sidebar-link">基础</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading"><span>工具与环境</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/c9cb6e/" class="sidebar-link">Arthas</a></li><li><a href="/pages/3172bb/" class="sidebar-link">Maven</a></li><li><a href="/pages/37f79a/" class="sidebar-link">Git</a></li><li><a href="/pages/db9f99/" class="sidebar-link">环境搭建与部署</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading"><span>测试</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/c725f5/" class="sidebar-link">测试基础</a></li><li><a href="/pages/7893a4/" class="sidebar-link">单元测试</a></li><li><a href="/pages/af9f25/" class="sidebar-link">压力测试</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading"><span>代码质量</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/ec2b81/" class="sidebar-link">代码整洁之道</a></li><li><a href="/pages/474cdf/" class="sidebar-link">阿里巴巴编程规范</a></li><li><a href="/pages/c47e15/" class="sidebar-link">代码之丑(极客时间)🌸</a></li><li><a href="/pages/4d4606/" class="sidebar-link">Java业务开发常见错误100例(极客时间)🌸</a></li></ul></section></li></ul></section></li></ul> </aside> <div><main class="page"><div class="theme-vdoing-wrapper "><div class="articleInfo-wrap" data-v-06970110><div class="articleInfo" data-v-06970110><ul class="breadcrumbs" data-v-06970110><li data-v-06970110><a href="/" title="首页" class="iconfont icon-home router-link-active" data-v-06970110></a></li> <li data-v-06970110><a href="/develop/#开发" data-v-06970110>开发</a></li><li data-v-06970110><a href="/develop/#Java" data-v-06970110>Java</a></li><li data-v-06970110><a href="/develop/#JVM" data-v-06970110>JVM</a></li></ul> <div class="info" data-v-06970110><div title="作者" class="author iconfont icon-touxiang" data-v-06970110><a href="https://github.com/nanodaemony" target="_blank" title="作者" class="beLink" data-v-06970110>NanoDaemony</a></div> <div title="创建时间" class="date iconfont icon-riqi" data-v-06970110><a href="javascript:;" data-v-06970110>2025-02-26</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-title">本文目录</div> <div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABGpJREFUSA3tVVtoXFUU3fvOI53UlmCaKIFmwEhsE7QK0ipFEdHEKpXaZGrp15SINsXUWvBDpBgQRKi0+KKoFeJHfZA+ED9KKoIU2gYD9UejTW4rVIzm0VSTziPzuNu1z507dibTTjL4U/DAzLn3nL3X2o91ziX6f9wMFdh6Jvbm9nNSV0msViVO6tN1Rm7NMu2OpeJ9lWBUTDxrJbYTS0hInuwciu9eLHlFxCLCZEk3MegsJmZ5K/JD6t7FkFdEvGUo1g7qJoG3MHImqRIn8/nzY1K9UPKKiJmtnUqHVE3Gbuay6vJE/N2FEmuxFjW2nUuE0yQXRRxLiTUAzs36zhZvOXJPdX850EVnnLZkB8prodQoM5JGj7Xk2mvC7JB8tG04Ef5PiXtG0UtxupRQSfTnBoCy554x18yJHI6I+G5Eru4LHmPJZEQsrvPUbMiA8G/WgMK7w7I+ez7++o2ANfbrjvaOl1tFMs+htG3IrZH9/hDX1Pr8Tc0UvH8tcX29KzAgIGcEkINyW5BF9x891hw6VYqgJHEk0huccS7vh3C6gTiODL+26huuBtbct8eZnqLML8PkxGYpuPZBqtqwkSjgc4mB5gbgig5i+y0UDK35LMxXisn9xQtK+nd26gTIHsHe/oblK/b29fUmN/8Y+9jAQrnBp56m1LcDlDp9irKTExSKduXJVWSqdBMA08pEJnEIOB3FPPMybu/oeV8zFeYN3xx576Q6RH+VmplE4ncQV5v+5rzSoyOU7PuEAg8g803PwBJ0CExno/jcMbN8tONYeOmHiuUNryvm3fRUy4tMPVLdAGkUhNWuggGrJcXPv+ouCjz0MKUHz1J2/E8IC9nqTabcxgaBYM0hPhD5Y65FsbxRQKxCQrDjDctW7PUM3HuZunFyifSAqEfuzCp48Il24luWUWZoyJCaPR82jE0+kFA643wRFVni4RYSq3ohJO2pZ7B5dO4xkDWbEpossJPLSrPjYID8rS2UHTlvyNxqIGsg674XJJ7vnh5L7PNwC4hh2sjCI96mzszOTpxLF0T7l88Yz7lAuK6OnL8gXLOnTvpzSb22YG8W7us3jSebFHeeqnXRG1vt+MoUM84LQIBmMsCTAcOauTh0T0l0neQK7m2bLMt2mGxU3HYssS0J2cdv5wljlPsrIuZLAG/2DOZIXgCYT8uMGZN+e2kSirfxZOPCsC0f24nTZzspnVn9VePS1Z5vubmAGGXG8ZFno9Hel0yfA5ZPhF7Dh972BQJ2qCpgH67lmWtBYbvk6sz02wjky2vXyz0XErP/kFB619js1BtwfOV4OPRqOQBjy3Qbk18vigUPPSD5ceHnwck7W9bhAqZdd7SuG7w4/P2F/GaJh8c7e9qgow+Q7cGBo+98WsLkuktFqiZabtXuQTu/Y5ETbR0v7tNSFnvrmu6pjdoan2KjMu8q/Hmj1EfCO2ZGfEIbIXKUlw8qaX9/b2oeSJmFksSeT/Fn0V3nSypChh4Gjh74ybO9aeZ/AN2dwciu2/MhAAAAAElFTkSuQmCC">JVM内存区域与对象解析🌼<!----></h1>  <div class="theme-vdoing-content content__default"><h1 id="_20-jvm内存区域与对象解析🌼"><a href="#_20-jvm内存区域与对象解析🌼" class="header-anchor">#</a> 20.JVM内存区域与对象解析🌼</h1> <p>本节是《深入理解 Java 虚拟机》的第二章</p> <p>Java 与 C++ 之间有一堵由内存动态分配和垃圾收集技术所围成的高墙, 墙外面的人想进去, 墙里面的人却想出来.</p> <h4 id="基础"><a href="#基础" class="header-anchor">#</a> 基础</h4> <p>对于从事 C, C++ 程序开发的开发人员来说, 在内存管理领域, 他们既是拥有最高权力的 &quot;皇帝&quot;, 又是从事最基础工作的劳动人民---既拥有每一个对象的 &quot;所有权&quot;, 又担负着每一个对象生命从开始到终结的维护责任.</p> <p>对于 Java 程序员来说, 在虚拟机自动内存管理机制的帮助下, 不再需要为每一个 new 操作去写配对的 delete/free 代码, 不容易出现内存泄漏和内存溢出问题, 看起来由虚拟机管理内存一切都很美好. 不过, 也正是因为 Java 程序员把控制内存的权力交给了 Java 虚拟机, 一旦出现内存泄漏和溢出方面的问题, 如果不了解虚拟机是怎样使用内存的, 那排查错误, 修正问题将会成为一项异常艰难的工作.</p> <p>本章将从概念上<strong>介绍 Java 虚拟机内存的各个区域</strong>, 讲解这些区域的作用, 服务对象以及其中可能产生的问题, 这也是翻越虚拟机内存管理这堵围墙的第一步.</p> <h4 id="jvm体系概览"><a href="#jvm体系概览" class="header-anchor">#</a> JVM体系概览</h4> <p>先看看虚拟机整体架构及所包含的内容. 如下面的体系结构图所示(Java8 之前), JVM 分为三个主要的<strong>子系统</strong>:</p> <ol><li><strong>类加载器子系统</strong>.</li> <li><strong>运行时数据区.</strong></li> <li><strong>字节码执行引擎</strong>.</li></ol> <p><img src="https://nano-note.oss-cn-beijing.aliyuncs.com/images/image-20220514160240249.png" alt=""></p> <h5 id="_1-类加载器子系统"><a href="#_1-类加载器子系统" class="header-anchor">#</a> 1.类加载器子系统</h5> <p>Java 的动态类加载功能是由类加载器子系统处理的. 它负责加载, 链接, 并且在<strong>运行时</strong>首次引用类的时候初始化类, 而不是在编译期间, 这部分参考: 虚拟机类加载机制.</p> <blockquote><p>(1)加载</p></blockquote> <p>这个组件负责加载类. BootStrap 类加载器, Extension 类加载器和 Application 类加载器是实现类加载的三大<strong>类加载器</strong>.</p> <ol><li><strong>BootStrap 类加载器</strong>: 负责从 classpath 加载类, 如果没有类存在, 将只加载 <strong>rt.jar</strong>. 这个加载器的优先级最高.</li> <li><strong>Extension 类加载器</strong>: 负责加载<strong>扩展文件夹(jre\lib)</strong>  中的类.</li> <li><strong>Application 类加载器</strong>: 负责加载<strong>应用级 classpath</strong> 和环境变量指向的路径下的类.</li></ol> <p>上述<strong>类加载器</strong>在加载类文件时遵循<strong>双亲委派算法</strong>.</p> <blockquote><p>(2)链接</p></blockquote> <ol><li><strong>校验</strong>: 字节码验证器将校验生成的字节码是否正确, 如果校验失败则将获得<strong>校验错误信息</strong>.</li> <li><strong>准备</strong>: 对于所有的<strong>静态变量</strong>, 内存将被申请并分配<strong>默认值</strong>.</li> <li><strong>解析</strong>: 所有<strong>标记的内存引用</strong>从<strong>方法区域</strong>被替换成的<strong>原始引用</strong>.</li></ol> <blockquote><p>(3)初始化</p></blockquote> <p>这是类加载的最后阶段, 所有的静态变量都将被分配原值, <strong>静态代码块将被执行</strong>.</p> <h5 id="_2-运行时数据区"><a href="#_2-运行时数据区" class="header-anchor">#</a> 2.运行时数据区</h5> <p>运行时数据区被划分为五个主要部分(参考: 运行时数据区域):</p> <ul><li><strong>方法区</strong>: 所有<strong>类级数据</strong>都存储在这里, 包括<strong>静态变量</strong>. 所有线程共享方法区.</li> <li><strong>堆区</strong>: <strong>对象</strong>及其对应的<strong>实例变量</strong>和<strong>数组</strong>等存储在此, 所有线程共享堆区. 由于<strong>方法区</strong>和<strong>堆区</strong>内存是多线程共享, 因此存储的数据是非线程安全的.</li> <li><strong>栈区</strong>: <strong>每个线程</strong>都会创建一个单独的<strong>运行时栈</strong>. 在每一次<strong>方法调用</strong>, 都会在栈内存中创建一个<strong>栈帧(Stack Frame)</strong> . 所有<strong>局部变量</strong>将在栈内存中创建. 栈区是线程安全的, 因为它是线程私有资源. 栈帧中包含多个实体: (1)<strong>局部变量数组</strong>: 与方法中有多少局部变量有关, 相应的值将存储在此处. (2)<strong>操作数栈</strong>: 如果任何的中间操作需要被执行, <strong>操作数栈</strong>将作为运行时工作区来执行操作. (3)<strong>帧数据</strong>: 与方法相对应的所有符号存储在此. 在异常情况下, catch 块的信息被保留在帧数据中.</li> <li><strong>程序计数器</strong>: 每一个线程都有独立的 <strong>PC 寄存器</strong>, 一旦执行指令, PC 寄存器将被下一条指令<strong>更新</strong>, 保存当前<strong>执行指令</strong>的地址.</li> <li><strong>本地方法栈</strong>: 本地方法栈保存本地方法信息, 每一个线程都会创建一个单独的本地方栈.</li></ul> <h5 id="_3-字节码执行引擎"><a href="#_3-字节码执行引擎" class="header-anchor">#</a> 3.字节码执行引擎</h5> <blockquote><p>执行引擎</p></blockquote> <p>分配到运行时数据区的<strong>字节码</strong>将被<strong>执行引擎执行</strong>. 执行引擎读取字节码并逐一执行. 参考: 虚拟机字节码执行引擎.</p> <ul><li><strong>解释器</strong>: 解释器能更加快速地解释字节码, 但是执行缓慢. 解释器的缺点是当多次调用一个方法时, 每次都要重新解释.</li> <li><strong>JIT 编译器(即时编译器)</strong> : JIT 编译器弥补了解释器的不足. 执行引擎使用解释器来转换字节码, 当它发现重复的代码时, 它将使用 JIT 编译器来编译整个字节码并转换为本地代码. 本地代码将直接被重复的方法所调用, 从而提高系统性能.</li> <li><strong>中间代码生成器</strong>: 生成中间代码.</li> <li><strong>代码优化器</strong>: 负责优化上述生成的中间代码.</li> <li><strong>目标代码生成器</strong>: 负责生成机器码或者本地代码.</li> <li><strong>分析器</strong>: 一个特殊的组件, 负责查找<strong>热点代码,</strong>  比如一个方法是否被调用多次.</li> <li><strong>垃圾回收器</strong>: 回收并删除未引用的对象. 可以通过调用 <strong>System.gc()</strong>  来触发垃圾回收, 但不能保证它执行. JVM 的垃圾回收是回收被创建的对象.</li></ul> <blockquote><p>Java本地接口(JNI)</p></blockquote> <p><strong>JNI</strong>与<strong>本地方法库</strong>交互, 并为执行引擎提供<strong>本地方法库</strong>.</p> <blockquote><p>本地方法库(Native Method Libraries)</p></blockquote> <p>它是执行引擎所需的本地库集合.</p> <h4 id="运行时数据区域"><a href="#运行时数据区域" class="header-anchor">#</a> 运行时数据区域</h4> <p>Java 虚拟机在执行 Java 程序的过程中会把它所<strong>管理的内存划分为若干个不同的数据区域, 这个内存区域就是运行时数据区</strong>. 这些区域有各自的用途, 以及创建和销毁的时间, 有的区域随着虚拟机进程的启动而一直存在, 有些区域则是依赖用户线程的启动和结束而建立和销毁. 根据《Java 虚拟机规范》的规定, Java 虚拟机所管理的内存将会包括以下几个运行时数据区域, 如下图所示.</p> <p><img src="https://nano-note.oss-cn-beijing.aliyuncs.com/images/image-20220514163218416.png" alt=""></p> <p>美团的图:</p> <p><img src="https://nano-note.oss-cn-beijing.aliyuncs.com/images/132ba6ba720f2bfc6c69b1ce490f7c87693987.jpg" alt="img"></p> <p><strong>程序计数器, Java 虚拟机栈和本地方法栈</strong>是线程<strong>私有</strong>的, 每个线程都有分配这些内存, 其余的是线程共享部分. 线程私有即随着线程的创建而创建, 随着线程的死亡而死亡.</p> <h5 id="_1-程序计数器"><a href="#_1-程序计数器" class="header-anchor">#</a> 1.程序计数器</h5> <p><strong>程序计数器(Program Counter Register)是一块较小的内存空间, 它可以看作是当前线程所执行的字节码的行号指示器, 每执行一句代码都会改变程序计数器</strong>. 在 Java 虚拟机的概念模型里, 字节码解释器工作时就是通过改变这个计数器的值来选取下一条需要执行的字节码指令, 它是程序控制流的指示器, 分支, 循环, 跳转, 异常处理, 线程恢复等基础功能都需要依赖这个计数器来完成.</p> <p>由于 Java 虚拟机的多线程是通过线程轮流切换, 分配处理器执行时间的方式来实现的, 在任何一个确定的时刻, 一个处理器(对于多核处理器来说是一个内核)都只会执行一条线程中的指令. 因此, <strong>为了线程切换后能恢复到正确的执行位置, 每条线程都需要有一个独立的程序计数器, 各条线程之间计数器互不影响, 独立存储, 因此称这类内存区域为 &quot;线程私有&quot; 的内存</strong>.</p> <p>如果线程正在执行的是一个 <strong>Java 方法</strong>, 程序计数器记录的是正在执行的<strong>虚拟机字节码指令的地址</strong>; 如果正在执行的是<strong>本地(Native)方法</strong>, 这个计数器值则应为<strong>空</strong>(Undefined). 此内存区域是唯一一个在《Java 虚拟机规范》中<strong>没有规定任何 OutOfMemoryError 情况的区域</strong>.</p> <h5 id="_2-java虚拟机栈"><a href="#_2-java虚拟机栈" class="header-anchor">#</a> 2.Java虚拟机栈</h5> <p>与程序计数器一样, Java 虚拟机栈(Java Virtual Machine Stack)也是<strong>线程私有</strong>的, 它的生命周期与线程相同.</p> <p>虚拟机栈描述的是 Java 方法执行的线程内存模型: <mark><strong>每个方法被执行的时候, Java 虚拟机都会同步创建一个栈帧  (Stack Frame)用于存储局部变量表, 操作数栈, 动态连接, 方法出口等信息. 每一个方法被调用直至执行完毕的过程, 就对应着一个栈帧在虚拟机栈中从入栈到出栈的过程</strong></mark>.</p> <p><strong>栈内存</strong>一般说的就是<strong>虚拟机栈</strong>, 这里的栈也就是基于平时的普通 <strong>LIFO</strong> 栈实现的, 里面存放的就是一个个的<strong>栈帧</strong>. 程序中每执行一个<strong>方法</strong>都会分配一个<strong>栈帧</strong>来保存方法内的<strong>各种数据</strong>. 栈及栈帧结构如下.</p> <p><img src="https://nano-note.oss-cn-beijing.aliyuncs.com/images/image-20220514163834398.png" alt=""></p> <p>进行数值计算的时候, 会把<strong>变量值加载到操作数栈</strong>进行操作. 比如求 a + b 的值, 就会把 a 和 b 都加载到操作数栈并进行计算.</p> <p>经常有人把 Java 内存区域笼统地划分为<strong>堆内存</strong>(Heap)和<strong>栈内存</strong>(Stack), 这种划分方式直接继承自传统的 C, C++ 程序的内存布局结构, 在 Java 语言里就显得有些粗糙了, 实际的内存区域划分要比这更复杂. 不过这种划分方式的流行也间接说明了程序员最关注的, 与对象内存分配关系最密切的区域是 &quot;堆&quot; 和 &quot;栈&quot; 两块. 其中, &quot;堆&quot; 在稍后笔者会专门讲述, 而 &quot;栈&quot; 通常就是指这里讲的虚拟机栈, 或者更多的情况下只是指虚拟机栈中局部变量表部分.</p> <p>程序中的<strong>局部变量</strong>就是存放在<strong>栈帧</strong>上的. <strong>局部变量表存放了编译期可知的各种 Java 虚拟机基本数据类型(boolean, byte, char, short, int, float, long, double), 对象引用(reference 类型, 它并不等同于对象本身, 可能是一个指向对象起始地址的引用指针, 也可能是指向一个代表对象的句柄或者其他与此对象相关的位置)和 returnAddress 类型(指向了一条字节码指令的地址)</strong> .</p> <p>这些<strong>数据类型在局部变量表中的存储空间以局部变量槽(Slot)来表示</strong>, 其中 64 位长度的 long 和 double 类型的数据会占用两个变量槽, 其余的数据类型只占用一个. 局部变量表所需的内存空间在编译期间完成分配, 当进入一个方法时, 这个方法需要在栈帧中分配多大的局部变量空间是完全确定的, 在方法运行期间不会改变局部变量表的大小. 请读者注意, 这里说的&quot;大小&quot;是指变量槽的数量, 虚拟机真正使用多大的内存空间(譬如按照 1 个变量槽占用 32 个比特, 64 个比特, 或者更多)来实现一个变量槽, 这是完全由具体的虚拟机实现自行决定的事情.</p> <blockquote><p>虚拟机栈内存溢出</p></blockquote> <p>在《Java 虚拟机规范》中, 对这个内存区域规定了两类异常状况:</p> <ul><li><strong>如果线程请求的栈深度大于虚拟机所允许的深度, 将抛出 StackOverflowError 异常</strong></li> <li><strong>如果 Java 虚拟机栈容量可以动态扩展, 当栈扩展时无法申请到足够的内存会抛出 OutOfMemoryError 异常</strong>.</li></ul> <blockquote><p>参数配置</p></blockquote> <p>可以通过  <strong>-Xss</strong> 这个虚拟机参数来指定<strong>每个线程</strong>的 Java 虚拟机<strong>栈内存</strong>大小. 记忆: <strong>ss = stack size</strong>.</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code><span class="token function">java</span> <span class="token parameter variable">-Xss512M</span> TestJava
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>-Xss 设置越小, 栈深值越小, 说明一个线程栈里能分配的<strong>栈帧就越少</strong>, 但是对 JVM 整体来说能开启的<strong>线程数</strong>会更多.</p> <blockquote><p>扩展: 方法如何调用?</p></blockquote> <p>虚拟机栈可以类比数据结构中<strong>栈</strong>, 虚拟机栈中保存的主要内容是<strong>栈帧</strong>, 每一次函数调用都会有一个对应的<strong>栈帧被压入虚拟机栈</strong>, 每一个函数调用结束后, 都会有一个栈帧被弹出. Java 方法有两种返回方式:</p> <ol><li>return 语句.</li> <li>抛出异常.</li></ol> <p>不管哪种返回方式都会<strong>导致栈帧被弹出</strong>.</p> <h5 id="_3-本地方法栈"><a href="#_3-本地方法栈" class="header-anchor">#</a> 3.本地方法栈</h5> <p>本地方法栈(Native Method Stacks)与虚拟机栈所发挥的作用是非常相似的, 其区别只是<strong>虚拟机栈为虚拟机执行 Java 方法(也就是字节码)服务, 而本地方法栈则是为虚拟机使用到的本地(Native)方法服务</strong>. 本地方法栈也是线程<strong>私有</strong>的.</p> <p>本地方法一般是用其它语言(C, C++ 或汇编语言等)编写的, 并且被编译为基于本机硬件和操作系统的程序, 对待这些方法需要特别处理. 本地方法被执行的时候, 在本地方法栈也会创建一个<strong>栈帧</strong>, 用于存放该本地方法的局部变量表, 操作数栈, 动态链接, 出口信息. 方法执行完毕后相应的栈帧也会出栈并释放内存空间, 也可能会出现 <strong>StackOverFlowError 和 OutOfMemoryError</strong> 两种异常.</p> <p><img src="/img/image-20230325134658-5l0q7fx.png" alt="image"></p> <p>总结: 为了<strong>保证线程中的局部变量不被别的线程访问到</strong>, 虚拟机栈和本地方法栈<strong>都是线程私有</strong>的.</p> <h5 id="_4-java堆"><a href="#_4-java堆" class="header-anchor">#</a> 4.Java堆</h5> <p>对于 Java 应用程序来说, Java 堆(Java Heap)是虚拟机所管理的内存中最大的一块. <strong>Java 堆是被所有线程共享的一块内存区域, 在虚拟机启动时创建</strong>. 此内存区域的<strong>唯一目的就是存放对象实例</strong>, Java 世界里 &quot;几乎&quot; 所有的对象实例都在这里分配内存. 在《Java 虚拟机规范》中对 Java 堆的描述是: &quot;所有的对象实例以及数组都应当在堆上分配&quot;, 而这里的 &quot;几乎&quot; 是指从实现角度来看, 随着 Java 语言的发展, 现在已经能看到些许迹象表明日后可能出现值类型的支持, 即使只考虑现在, 由于即时编译技术的进步, 尤其是<strong>逃逸分析技术的日渐强大, 栈上分配, 标量替换优化手段已经导致一些微妙的变化悄然发生, 所以说 Java 对象实例都分配在堆上也渐渐变得不是那么绝对</strong>了, .</p> <p><strong>Java 堆是垃圾收集器管理的内存区域</strong>, 因此一些资料中它也被称作 &quot;GC 堆&quot;(Garbage Collected Heap). 从回收内存的角度看, 由于现代垃圾收集器大部分都是基于分代收集理论设计的, 所以 Java 堆中经常会出现  <strong>&quot;新生代&quot;, &quot;老年代&quot;, &quot;永久代&quot;, &quot;Eden 空间&quot;, &quot;From Survivor 空间&quot;, &quot;To Survivor 空间&quot;</strong>  等名词, 这些区域划分仅仅是一部分垃圾收集器的<strong>共同特性或者说设计风格</strong>而已, 而非某个 Java 虚拟机具体实现的固有内存布局, 更不是《Java 虚拟机规范》里对 Java 堆的进一步细致划分.</p> <p><strong>如果从分配内存的角度看, 所有线程共享的 Java 堆中可以划分出多个线程私有的分配缓冲区(Thread Local Allocation Buffer, TLAB), 以提升对象分配时的效率</strong>. 不过无论从什么角度, 无论如何划分, 都不会改变 Java 堆中存储内容的共性, 无论是哪个区域, 存储的都只能是对象的实例, <strong>将 Java 堆细分的目的只是为了更好地回收内存, 或者更快地分配内存</strong>. 在本章中, 仅仅针对内存区域的作用进行讨论, Java 堆中的上述各个区域的分配, 回收等细节将会是下一章的主题.</p> <p>根据《Java 虚拟机规范》的规定, Java 堆可以处于物理上不连续的内存空间中, 但在逻辑上它应该被视为连续的, 这点就像用磁盘空间去存储文件一样, 并不要求每个文件都连续存放. 但对于大对象(典型的如数组对象), 多数虚拟机实现出于实现简单, 存储高效的考虑, 很可能会要求连续的内存空间.</p> <blockquote><p>堆区内存溢出</p></blockquote> <p><strong>如果在 Java 堆中没有内存完成实例分配, 并且堆也无法再扩展时, Java 虚拟机将会抛出 OutOfMemoryError 异常</strong>. 并且出现这种错误之后有不同的表现形式:</p> <ul><li><strong>OutOfMemoryError: GC Overhead Limit Exceeded</strong>: 当 JVM 花太多时间执行垃圾回收并且只能回收很少的堆空间时, 就会发生此错误.</li> <li><strong>java.lang.OutOfMemoryError: Java heap space</strong>: 假如在创建新的对象时, 堆内存中的空间不足以存放新创建的对象, 就会引发 java.lang.OutOfMemoryError: Java heap space 错误. 这和本机物理内存无关, 和配置的内存大小有关.</li></ul> <blockquote><p>参数配置</p></blockquote> <p>可以通过  <strong>-Xms 和 -Xmx</strong> 这两个虚拟机参数来指定一个程序的<strong>堆内存</strong>大小, 第一个参数设置<strong>初始值</strong>, 第二个参数设置<strong>最大值</strong>.</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code><span class="token function">java</span> <span class="token parameter variable">-Xms1M</span> <span class="token parameter variable">-Xmx2M</span> HackTheJava
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><blockquote><p>实例对象在内存中存储在哪?</p></blockquote> <p><strong>如果实例对象存储在堆区时</strong>: 实例对象内存存在<strong>堆区</strong>, 实例的<strong>引用</strong>存在<strong>栈上</strong>, 实例的<strong>元数据 Class 存在方法区或者元空间</strong>.</p> <p><strong>实例对象</strong>也<strong>不一定存在堆区</strong>的. 如果实例对象<strong>没有线程逃逸行为</strong>, 那么是<strong>有可能</strong>在线程的<strong>栈上创建实例</strong>的, 也就是存在栈上.</p> <h5 id="_5-方法区"><a href="#_5-方法区" class="header-anchor">#</a> 5.方法区</h5> <p><strong>方法区(Method Area)与 Java 堆一样, 是各个</strong>​<mark><strong>线程共享</strong></mark>​<strong>的内存区域, 它用于存储已被虚拟机加载的类型信息, 常量, 静态变量, 即时编译器编译后的代码缓存等数据.</strong></p> <p><strong>方法区与堆的联系: 类的元信息在方法区(永久代或者元空间中), 但是其实际引用的对象是在堆中.</strong></p> <blockquote><p>永久代</p></blockquote> <p>说到方法区, 不得不提一下 &quot;<strong>永久代</strong>&quot; 这个概念, 尤其是在 JDK8 以前, 许多 Java 程序员都习惯在 HotSpot 虚拟机上开发, 部署程序, 很多人都更愿意把方法区称呼为 &quot;永久代&quot;(Permanent Generation), 或将两者混为一谈. 本质上这两者并不是等价的, 因为仅仅是当时的 HotSpot 虚拟机设计团队选择把收集器的分代设计扩展至方法区, 或者说<strong>使用永久代来实现方法区</strong>而已, 这样使得 HotSpot 的垃圾收集器能够像管理 Java 堆一样管理这部分内存, 省去专门为方法区编写内存管理代码的工作. 但是对于其他虚拟机实现, 是不存在永久代的概念的. 原则上<strong>如何实现方法区属于虚拟机实现细节</strong>, 不受《Java 虚拟机规范》管束, 并不要求统一. 但现在回头来看, 当年使用永久代来实现方法区的决定并不是一个好主意, 这种设计导致了 Java 应用更容易遇到内存溢出的问题(永久代有 -XX: MaxPermSize 的上限, 即使不设置也有默认大小, 而 J9 和 JRockit 只要没有触碰到进程可用内存的上限, 例如 32 位系统中的 4GB 限制, 就不会出问题), 而且有极少数方法(例如 <code>String::intern()</code>​)会因永久代的原因而导致不同虚拟机下有不同的表现.</p> <blockquote><p>元空间</p></blockquote> <p>到了 JDK 7 的 HotSpot, 已经把原本放在永久代的字符串常量池, 静态变量等移出, 而到了 JDK 8, <strong>终于完全废弃了永久代的概念, 改用</strong>​<mark><strong>在本地内存中实现的元空间(Meta-space)来实现方法区</strong></mark>​ <strong>, 把 JDK 7 中永久代还剩余的内容(主要是类型信息)全部移到元空间中</strong>.</p> <blockquote><p>为什么要将永久代(PermGen)替换为元空间(MetaSpace)?</p></blockquote> <p>整个永久代有一个 JVM 本身<strong>设置固定大小上限</strong>, 无法进行调整, 而<strong>元空间使用的是直接内存</strong>, 受本机可用内存的限制, 虽然元空间依然可能溢出, 但几率会更小. 元空间里面存放的是<strong>类的元数据</strong>, 这样加载多少类的元数据就不由 MaxPermSize 控制了, 而由系统的实际可用空间来控制, 这样能加载的类就更多了.</p> <blockquote><p>方法区与永久代和元空间的关系</p></blockquote> <p>《Java 虚拟机规范》只是规定了有<strong>方法区</strong>这么个概念和它的作用, 并没有规定如何去实现它. 所以不同的 JVM 上方法区的实现就可能是不同的. <strong>方法区和永久代的关系很像 Java 中接口和类的关系, 类实现了接口. 方法区就是定义的标准定义的接口, 而永久代就是 HotSpot 虚拟机对虚拟机规范中方法区的一种实现方式, 元空间则是另一种实现方式.</strong>  也就是说, <strong>永久代和元空间是 HotSpot 的概念</strong>, <strong>方法区是 Java 虚拟机规范</strong>中的定义, 方法区是一种规范, 而永久代与元空间是实现, 其他的虚拟机实现并没有永久代这一说法.</p> <blockquote><p>方法区的垃圾回收</p></blockquote> <p>《Java 虚拟机规范》对方法区的约束是非常宽松的, 除了和 Java 堆一样不需要连续的内存和可以选择固定大小或者可扩展外, 甚至还可以选择不实现垃圾收集. 相对而言, 垃圾收集行为在这个区域的确是比较少出现的, 但并非数据进入了方法区就如永久代的名字一样 &quot;永久&quot; 存在了. 针对方法区的内存回收目标主要是<strong>针对常量池的回收和对类型的卸载</strong>, 一般来说这个区域的<strong>回收效果比较难令人满意</strong>, 尤其是类型的卸载, 条件相当苛刻, 但是这部分区域的回收有时又确实是必要的.</p> <blockquote><p>方法区内存溢出</p></blockquote> <p>根据《Java 虚拟机规范》的规定, 如果方法区无法满足新的内存分配需求时, 将抛出 OutOfMemoryError 异常.</p> <blockquote><p>参数配置</p></blockquote> <p>Java7 及之前, 设置永久代的参数:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token operator">-</span><span class="token constant">XX</span><span class="token operator">:</span><span class="token class-name">PermSize</span>  	<span class="token comment">// 设置永久代最小空间大小</span>
<span class="token operator">-</span><span class="token constant">XX</span><span class="token operator">:</span><span class="token class-name">MaxPermSize</span> <span class="token comment">// 设置永久代最大空间大小</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>Java8 元空间使用的是<strong>直接内存</strong>, 设置参数为:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token operator">-</span><span class="token constant">XX</span><span class="token operator">:</span><span class="token class-name">MetaspaceSize</span> <span class="token operator">=</span> <span class="token class-name">N</span> 		<span class="token comment">// 设置Metaspace初始大小</span>
<span class="token operator">-</span><span class="token constant">XX</span><span class="token operator">:</span><span class="token class-name">MaxMetaspaceSize</span> <span class="token operator">=</span> <span class="token class-name">N</span> 	<span class="token comment">// 设置Metaspace最大大小</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h5 id="_6-运行时常量池"><a href="#_6-运行时常量池" class="header-anchor">#</a> 6.运行时常量池</h5> <p><mark><strong>运行时常量池(Runtime Constant Pool)是方法区的一部分</strong></mark>. Class 文件中除了有类的版本, 字段, 方法, 接口等描述信息外, 还有一项信息是<strong>常量池表(Constant Pool Table), 用于存放编译期生成的各种</strong>​<mark><strong>字面量与符号引用</strong></mark>​ <strong>, 这部分内容将在类加载后存放到方法区的运行时常量池中</strong>(参考: Class类文件的结构).</p> <p>运行时常量池包含内容:</p> <ul><li><strong>字面量</strong>: 文本字符串, 声明为 final 的常量值, 基本数据类型值等.</li> <li><strong>符号引用</strong>: 类和结构的全限定名, 字段名称与描述符, 方法名称与描述符.</li></ul> <p>Java 虚拟机对于 Class 文件每一部分(自然也包括常量池)的格式都有严格规定, 如每一个字节用于存储哪种数据都必须符合规范上的要求才会被虚拟机认可, 加载和执行, 但对于运行时常量池, 《Java 虚拟机规范》并没有做任何细节的要求, <strong>不同提供商实现的虚拟机可以按照自己的需要来实现这个内存区域</strong>, 不过一般来说, 除了保存 Class 文件中描述的符号引用外, 还会把由符号引用翻译出来的直接引用也存储在运行时常量池中.</p> <p>运行时常量池相对于 Class 文件常量池的另外一个重要特征是<strong>具备动态性</strong>, Java 语言并不要求常量一定只有编译期才能产生, 也就是说, 并非预置入 Class 文件中常量池的内容才能进入方法区运行时常量池, <strong>运行期间也可以将新的常量放入池中</strong>, 这种特性被开发人员利用得比较多的便是 String 类的 <code>intern()</code>​ 方法.</p> <blockquote><p>运行时常量池内存溢出</p></blockquote> <p>既然运行时常量池是方法区的一部分, 自然受到方法区内存的限制, 当常量池无法再申请到内存时会抛出 OutOfMemoryError 异常.</p> <h5 id="_7-直接内存"><a href="#_7-直接内存" class="header-anchor">#</a> 7.直接内存</h5> <p><strong>直接内存(Direct Memory)并不是虚拟机运行时数据区的一部分</strong>, 也不是《Java 虚拟机规范》中定义的内存区域. 但是这部分内存也被频繁地使用(<strong>元空间</strong>就是在直接内存中), 而且也可能导致 OutOfMemoryError 异常出现, 所以放到这里一起讲解.</p> <blockquote><p>直接内存与NIO</p></blockquote> <p>Java NIO(参考: NIO) 引入了一种基于<strong>通道(Channel)与缓冲区</strong>(Buffer)的 I/O 方式, 它可以<strong>使用 Native 函数库直接分配堆外内存</strong>, 然后通过一个<strong>存储在 Java 堆里面的 DirectByteBuffer 对象作为这块内存的引用</strong>进行操作. 这样能在一些场景中显著提高性能, 因为避免了在 Java 堆和 Native 堆中来回复制数据.</p> <blockquote><p>直接内存溢出</p></blockquote> <p>显然, <strong>本机直接内存的分配不会受到 Java 堆大小的限制, 但既然是内存, 则肯定还是会受到本机总内存</strong>(包括物理内存, SWAP 分区或者分页文件)大小以及处理器寻址空间的限制, 一般服务器管理员配置虚拟机参数时, 会根据实际内存去设置 -Xmx 等参数信息, 但经常忽略掉直接内存, 使得各个内存区域总和大于物理内存限制(包括物理的和操作系统级的限制), 从而导致动态扩展时出现 OutOfMemoryError 异常. 因此, 大量 NIO 操作可能会导致直接内存溢出.</p> <h4 id="outofmemoryerror异常示例"><a href="#outofmemoryerror异常示例" class="header-anchor">#</a> OutOfMemoryError异常示例</h4> <p>在《Java 虚拟机规范》的规定里, 除了程序计数器外, 虚拟机内存的其他几个运行时区域都有发生 OutOfMemoryError(下文称 OOM) 异常的可能, 本节将通过若干实例来验证异常实际发生的代码场景, 并且将初步介绍若干最基本的与自动内存管理子系统相关的 HotSpot 虚拟机参数.</p> <p>本节实战的目的有两个: <strong>第一, 通过代码验证《Java 虚拟机规范》中描述的各个运行时区域储存的内容; 第二, 希望读者在遇到实际的内存溢出异常时, 能根据异常的提示信息迅速得知是哪个区域的内存溢出, 知道怎样的代码可能会导致这些区域内存溢出, 以及出现这些异常后该如何处理</strong>.</p> <p>本节代码清单开头都注释了执行时需要设置的<strong>虚拟机启动参数</strong>(注释中 &quot;VM Args&quot; 后面跟着的参数), 这些参数对实验的结果有直接影响, 请调试代码的时候不要忽略掉. 如果使用控制台命令来执行程序, 那直接跟在 Java 命令之后书写就可以.</p> <p>本节所列的代码均由在<strong>基于 OpenJDK 7 中的 HotSpot 虚拟机</strong>上进行过实际测试, 如无特殊说明, 对其他 OpenJDK 版本也应当适用. 不过读者需意识到内存溢出异常与虚拟机本身的实现细节密切相关, 并非全是 Java 语言中约定的公共行为. 因此, 不同发行商, 不同版本的 Java 虚拟机, 其需要的参数和程序运行的结果都很可能会有所差别.</p> <h5 id="_1-java堆溢出示例"><a href="#_1-java堆溢出示例" class="header-anchor">#</a> 1.Java堆溢出示例</h5> <p>Java 堆用于储存对象实例, 只要<strong>不断地创建对象</strong>, 并且保证 GC Roots 到对象之间有可达路径来避免垃圾回收机制清除这些对象, 那么随着对象数量的增加, <strong>总容量触及最大堆的容量</strong>限制后就会产生内存溢出异常.</p> <p>下面代码清单中限制 Java 堆的大小为 20MB, 不可扩展(<strong>将堆的最小值 -Xms 参数与最大值 -Xmx 参数设置为一样即可避免堆自动扩展</strong>), 通过参数 <code>-XX: +HeapDumpOnOutOf-MemoryError</code>​ 可以让虚拟机在出现内存溢出异常的时候 Dump 出当前的内存堆转储快照以便进行事后分析.</p> <blockquote><p>代码清单 Java堆内存溢出异常测试</p></blockquote> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
 * VM Args: -Xms20m -Xmx20m -XX:+HeapDumpOnOutOfMemoryError
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HeapOOM</span> <span class="token punctuation">{</span>

    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">OOMObject</span> <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">OOMObject</span><span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">OOMObject</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 持续创建对象</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">OOMObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>运行结果:</p> <div class="language-ziti1 line-numbers-mode"><pre class="language-text"><code>java.lang.OutOfMemoryError: Java heap space
Dumping heap to java_pid3404.hprof ...
Heap dump file created [22045981 bytes in 0.663 secs]
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>Java 堆内存的 OutOfMemoryError 异常是实际应用中最常见的内存溢出异常情况. 出现 Java 堆内存溢出时, 异常堆栈信息 &quot;java.lang.OutOfMemoryError&quot; 会跟随进一步提示 &quot;<mark><strong>Java heap space</strong></mark>&quot;.</p> <p>要解决这个内存区域的异常, 常规的处理方法是首先<strong>通过内存映像分析工具(如 Eclipse Memory Analyzer)对 Dump 出来的堆转储快照进行分析</strong>. 第一步首先应确认内存中导致 OOM 的对象是否是必要的, 也就是要先分清楚到底是出现了<mark><strong>内存泄漏(Memory Leak)还是内存溢出(Memory Overflow)</strong></mark> . 下图显示了使用 Eclipse Memory Analyzer 打开的堆转储快照文件.</p> <p>如果是内存泄漏, 可进一步通过工具查看<strong>泄漏对象到 GC Roots 的引用链</strong>, 找到泄漏对象是通过怎样的引用路径, 与哪些 GC Roots 相关联, 才导致垃圾收集器无法回收它们, 根据泄漏对象的类型信息以及它到 GC Roots 引用链的信息, 一般可以比较准确地定位到这些对象创建的位置, 进而找出产生内存泄漏的代码的具体位置.</p> <p><img src="/img/Image00019-20240302133505-kbzlwya.jpg" alt="" title="使用 Eclipse Memory Analyzer 打开的堆转储快照文件"></p> <p>如果不是内存泄漏, 换句话说就是内存中的对象确实都是<strong>必须存活</strong>的, 那就应当检查 Java 虚拟机的堆参数(-Xmx  与 -Xms)设置, 与机器的内存对比, 看看是否还有<strong>向上调整的空间</strong>. 再从代码上检查是否存在某些对象生命周期过长, 持有状态时间过长, 存储结构设计不合理等情况, 尽量减少程序运行期的内存消耗.</p> <h5 id="_2-虚拟机栈和本地方法栈溢出示例"><a href="#_2-虚拟机栈和本地方法栈溢出示例" class="header-anchor">#</a> 2.虚拟机栈和本地方法栈溢出示例</h5> <p>由于 HotSpot 虚拟机中并<strong>不区分虚拟机栈和本地方法栈</strong>, 因此对于 HotSpot 来说, -Xoss 参数(设置本地方法栈大小)虽然存在, 但实际上是没有任何效果的, <strong>栈容量只能由 -Xss 参数来设定</strong>. 关于虚拟机栈和本地方法栈, 在《Java 虚拟机规范》中描述了可能抛出的两种异常 <strong>StackOverflowError 和</strong> <strong>OutOfMemoryError</strong>.</p> <p>《Java 虚拟机规范》明确允许 Java 虚拟机实现<strong>自行选择是否支持栈的动态扩展</strong>, 而 HotSpot 虚拟机的选择是不支持扩展, 所以除非在创建线程申请内存时就因无法获得足够内存而出现 OutOfMemoryError 异常, 否则在线程运行时是不会因为扩展而导致内存溢出的, 只会因为栈容量无法容纳新的栈帧而导致 StackOverflowError 异常.</p> <p>为了验证这点, 可以做两个实验, 先将实验范围限制在单线程中操作, 尝试下面两种行为是否能让 HotSpot 虚拟机产生 OutOfMemoryError 异常:</p> <ul><li>使用 -Xss 参数<strong>减少栈内存容量</strong>. 结果: 抛出 StackOverflowError 异常, 异常出现时输出的堆栈深度相应缩小.</li> <li>定义了大量的本地变量, 增大此方法帧中本地变量表的长度. 结果: 抛出 StackOverflowError 异常, 异常出现时输出的堆栈深度相应缩小.</li></ul> <p>首先, 对第一种情况进行测试, 具体如下所示.</p> <blockquote><p>代码清单 虚拟机栈和本地方法栈测试(作为第1点测试程序)</p></blockquote> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
 * VM Args: -Xss128k
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">JavaVMStackSOF</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">int</span> stackLength <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">stackLeak</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        stackLength<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token comment">// 一直调用自己</span>
        <span class="token function">stackLeak</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">{</span>
        <span class="token class-name">JavaVMStackSOF</span> oom <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JavaVMStackSOF</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            oom<span class="token punctuation">.</span><span class="token function">stackLeak</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;stack length:&quot;</span> <span class="token operator">+</span> oom<span class="token punctuation">.</span>stackLength<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">throw</span> e<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><p>运行结果:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>stack length<span class="token operator">:</span><span class="token number">2402</span>
<span class="token class-name">Exception</span> in thread <span class="token string">&quot;main&quot;</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>StackOverflowError</span>
    at <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>fenixsoft<span class="token punctuation">.</span>oom<span class="token punctuation">.</span></span> JavaVMStackSOF</span><span class="token punctuation">.</span><span class="token function">leak</span><span class="token punctuation">(</span><span class="token class-name">JavaVMStackSOF</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">20</span><span class="token punctuation">)</span>
    at <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>fenixsoft<span class="token punctuation">.</span>oom<span class="token punctuation">.</span></span> JavaVMStackSOF</span><span class="token punctuation">.</span><span class="token function">leak</span><span class="token punctuation">(</span><span class="token class-name">JavaVMStackSOF</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">21</span><span class="token punctuation">)</span>
    at <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>fenixsoft<span class="token punctuation">.</span>oom<span class="token punctuation">.</span></span> JavaVMStackSOF</span><span class="token punctuation">.</span><span class="token function">leak</span><span class="token punctuation">(</span><span class="token class-name">JavaVMStackSOF</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">21</span><span class="token punctuation">)</span>
<span class="token comment">// 后续异常堆栈信息省略</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>继续验证第二种情况, 这次代码就显得有些 &quot;丑陋&quot; 了, 为了多占局部变量表空间, 就不得不定义一长串变量, 具体如下所示.</p> <blockquote><p>代码清单 虚拟机栈和本地方法栈测试(作为第2点测试程序)</p></blockquote> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">JavaVMStackSOF</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">int</span> stackLength <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">long</span> unused1<span class="token punctuation">,</span> unused2<span class="token punctuation">,</span> unused3<span class="token punctuation">,</span> unused4<span class="token punctuation">,</span> unused5<span class="token punctuation">,</span>
             unused6<span class="token punctuation">,</span> unused7<span class="token punctuation">,</span> unused8<span class="token punctuation">,</span> unused9<span class="token punctuation">,</span> unused10<span class="token punctuation">,</span>
             unused11<span class="token punctuation">,</span> unused12<span class="token punctuation">,</span> unused13<span class="token punctuation">,</span> unused14<span class="token punctuation">,</span> unused15<span class="token punctuation">,</span>
             unused16<span class="token punctuation">,</span> unused17<span class="token punctuation">,</span> unused18<span class="token punctuation">,</span> unused19<span class="token punctuation">,</span> unused20<span class="token punctuation">,</span>
             unused21<span class="token punctuation">,</span> unused22<span class="token punctuation">,</span> unused23<span class="token punctuation">,</span> unused24<span class="token punctuation">,</span> unused25<span class="token punctuation">,</span>
             unused26<span class="token punctuation">,</span> unused27<span class="token punctuation">,</span> unused28<span class="token punctuation">,</span> unused29<span class="token punctuation">,</span> unused30<span class="token punctuation">,</span>
             unused31<span class="token punctuation">,</span> unused32<span class="token punctuation">,</span> unused33<span class="token punctuation">,</span> unused34<span class="token punctuation">,</span> unused35<span class="token punctuation">,</span>
             unused36<span class="token punctuation">,</span> unused37<span class="token punctuation">,</span> unused38<span class="token punctuation">,</span> unused39<span class="token punctuation">,</span> unused40<span class="token punctuation">,</span>
             unused41<span class="token punctuation">,</span> unused42<span class="token punctuation">,</span> unused43<span class="token punctuation">,</span> unused44<span class="token punctuation">,</span> unused45<span class="token punctuation">,</span>
             unused46<span class="token punctuation">,</span> unused47<span class="token punctuation">,</span> unused48<span class="token punctuation">,</span> unused49<span class="token punctuation">,</span> unused50<span class="token punctuation">,</span>
             unused51<span class="token punctuation">,</span> unused52<span class="token punctuation">,</span> unused53<span class="token punctuation">,</span> unused54<span class="token punctuation">,</span> unused55<span class="token punctuation">,</span>
             unused56<span class="token punctuation">,</span> unused57<span class="token punctuation">,</span> unused58<span class="token punctuation">,</span> unused59<span class="token punctuation">,</span> unused60<span class="token punctuation">,</span>
             unused61<span class="token punctuation">,</span> unused62<span class="token punctuation">,</span> unused63<span class="token punctuation">,</span> unused64<span class="token punctuation">,</span> unused65<span class="token punctuation">,</span>
             unused66<span class="token punctuation">,</span> unused67<span class="token punctuation">,</span> unused68<span class="token punctuation">,</span> unused69<span class="token punctuation">,</span> unused70<span class="token punctuation">,</span>
             unused71<span class="token punctuation">,</span> unused72<span class="token punctuation">,</span> unused73<span class="token punctuation">,</span> unused74<span class="token punctuation">,</span> unused75<span class="token punctuation">,</span>
             unused76<span class="token punctuation">,</span> unused77<span class="token punctuation">,</span> unused78<span class="token punctuation">,</span> unused79<span class="token punctuation">,</span> unused80<span class="token punctuation">,</span>
             unused81<span class="token punctuation">,</span> unused82<span class="token punctuation">,</span> unused83<span class="token punctuation">,</span> unused84<span class="token punctuation">,</span> unused85<span class="token punctuation">,</span>
             unused86<span class="token punctuation">,</span> unused87<span class="token punctuation">,</span> unused88<span class="token punctuation">,</span> unused89<span class="token punctuation">,</span> unused90<span class="token punctuation">,</span>
             unused91<span class="token punctuation">,</span> unused92<span class="token punctuation">,</span> unused93<span class="token punctuation">,</span> unused94<span class="token punctuation">,</span> unused95<span class="token punctuation">,</span>
             unused96<span class="token punctuation">,</span> unused97<span class="token punctuation">,</span> unused98<span class="token punctuation">,</span> unused99<span class="token punctuation">,</span> unused100<span class="token punctuation">;</span>

        stackLength <span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        unused1 <span class="token operator">=</span> unused2 <span class="token operator">=</span> unused3 <span class="token operator">=</span> unused4 <span class="token operator">=</span> unused5 <span class="token operator">=</span>
        unused6 <span class="token operator">=</span> unused7 <span class="token operator">=</span> unused8 <span class="token operator">=</span> unused9 <span class="token operator">=</span> unused10 <span class="token operator">=</span>
        unused11 <span class="token operator">=</span> unused12 <span class="token operator">=</span> unused13 <span class="token operator">=</span> unused14 <span class="token operator">=</span> unused15 <span class="token operator">=</span>
        unused16 <span class="token operator">=</span> unused17 <span class="token operator">=</span> unused18 <span class="token operator">=</span> unused19 <span class="token operator">=</span> unused20 <span class="token operator">=</span>
        unused21 <span class="token operator">=</span> unused22 <span class="token operator">=</span> unused23 <span class="token operator">=</span> unused24 <span class="token operator">=</span> unused25 <span class="token operator">=</span>
        unused26 <span class="token operator">=</span> unused27 <span class="token operator">=</span> unused28 <span class="token operator">=</span> unused29 <span class="token operator">=</span> unused30 <span class="token operator">=</span>
        unused31 <span class="token operator">=</span> unused32 <span class="token operator">=</span> unused33 <span class="token operator">=</span> unused34 <span class="token operator">=</span> unused35 <span class="token operator">=</span>
        unused36 <span class="token operator">=</span> unused37 <span class="token operator">=</span> unused38 <span class="token operator">=</span> unused39 <span class="token operator">=</span> unused40 <span class="token operator">=</span>
        unused41 <span class="token operator">=</span> unused42 <span class="token operator">=</span> unused43 <span class="token operator">=</span> unused44 <span class="token operator">=</span> unused45 <span class="token operator">=</span>
        unused46 <span class="token operator">=</span> unused47 <span class="token operator">=</span> unused48 <span class="token operator">=</span> unused49 <span class="token operator">=</span> unused50 <span class="token operator">=</span>
        unused51 <span class="token operator">=</span> unused52 <span class="token operator">=</span> unused53 <span class="token operator">=</span> unused54 <span class="token operator">=</span> unused55 <span class="token operator">=</span>
        unused56 <span class="token operator">=</span> unused57 <span class="token operator">=</span> unused58 <span class="token operator">=</span> unused59 <span class="token operator">=</span> unused60 <span class="token operator">=</span>
        unused61 <span class="token operator">=</span> unused62 <span class="token operator">=</span> unused63 <span class="token operator">=</span> unused64 <span class="token operator">=</span> unused65 <span class="token operator">=</span>
        unused66 <span class="token operator">=</span> unused67 <span class="token operator">=</span> unused68 <span class="token operator">=</span> unused69 <span class="token operator">=</span> unused70 <span class="token operator">=</span>
        unused71 <span class="token operator">=</span> unused72 <span class="token operator">=</span> unused73 <span class="token operator">=</span> unused74 <span class="token operator">=</span> unused75 <span class="token operator">=</span>
        unused76 <span class="token operator">=</span> unused77 <span class="token operator">=</span> unused78 <span class="token operator">=</span> unused79 <span class="token operator">=</span> unused80 <span class="token operator">=</span>
        unused81 <span class="token operator">=</span> unused82 <span class="token operator">=</span> unused83 <span class="token operator">=</span> unused84 <span class="token operator">=</span> unused85 <span class="token operator">=</span>
        unused86 <span class="token operator">=</span> unused87 <span class="token operator">=</span> unused88 <span class="token operator">=</span> unused89 <span class="token operator">=</span> unused90 <span class="token operator">=</span>
        unused91 <span class="token operator">=</span> unused92 <span class="token operator">=</span> unused93 <span class="token operator">=</span> unused94 <span class="token operator">=</span> unused95 <span class="token operator">=</span>
        unused96 <span class="token operator">=</span> unused97 <span class="token operator">=</span> unused98 <span class="token operator">=</span> unused99 <span class="token operator">=</span> unused100 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Error</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;stack length:&quot;</span> <span class="token operator">+</span> stackLength<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">throw</span> e<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br></div></div><p>运行结果:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>stack length<span class="token operator">:</span><span class="token number">5675</span>
<span class="token class-name">Exception</span> in thread <span class="token string">&quot;main&quot;</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>StackOverflowError</span>
    at <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>fenixsoft<span class="token punctuation">.</span>oom<span class="token punctuation">.</span></span> JavaVMStackSOF</span><span class="token punctuation">.</span><span class="token function">leak</span><span class="token punctuation">(</span><span class="token class-name">JavaVMStackSOF</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">27</span><span class="token punctuation">)</span>
    at <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>fenixsoft<span class="token punctuation">.</span>oom<span class="token punctuation">.</span></span> JavaVMStackSOF</span><span class="token punctuation">.</span><span class="token function">leak</span><span class="token punctuation">(</span><span class="token class-name">JavaVMStackSOF</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">28</span><span class="token punctuation">)</span>
    at <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>fenixsoft<span class="token punctuation">.</span>oom<span class="token punctuation">.</span></span> JavaVMStackSOF</span><span class="token punctuation">.</span><span class="token function">leak</span><span class="token punctuation">(</span><span class="token class-name">JavaVMStackSOF</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">28</span><span class="token punctuation">)</span>
<span class="token comment">// 后续异常堆栈信息省略</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>实验结果表明: 无论是由于栈帧太大还是虚拟机栈容量太小, <strong>当新的栈帧内存无法分配的时候, HotSpot 虚拟机抛出的都是 StackOverflowError 异常</strong>.</p> <p>如果测试时不限于单线程, 通过<strong>不断建立线程</strong>的方式, 在 HotSpot 上也是可以产生<strong>内存溢出异常</strong>的, 具体如代码清单 2-6 所示. 但是这样产生的内存溢出异常和栈空间是否足够并不存在任何直接的关系, <strong>主要取决于操作系统本身的内存使用状态</strong>. 甚至可以说, 在这种情况下, 给每个线程的栈分配的内存越大, 反而越容易产生内存溢出异常.</p> <p>原因其实不难理解, 操作系统分配给每个进程的内存是有限制的, 譬如 32 位 Windows 的单个进程最大内存限制为2GB. HotSpot 虚拟机提供了参数可以控制 Java 堆和方法区这两部分的内存的最大值, 那剩余的内存即为 2GB(操作系统限制)减去最大堆容量, 再减去最大方法区容量, 由于程序计数器消耗内存很小, 可以忽略掉, 如果把直接内存和虚拟机进程本身耗费的内存也去掉的话, <strong>剩下的内存就由虚拟机栈和本地方法栈来分配了</strong>. 因此为每个线程分配到的栈内存越大, 可以建立的线程数量自然就越少, 建立线程时就越容易把剩下的内存耗尽, 代码清单 2-6 演示了这种情况.</p> <blockquote><p>代码清单2-6 创建线程导致内存溢出异常</p></blockquote> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
 * VM Args: -Xss2M (这时候不妨设大些, 请在32位系统下运行)
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">JavaVMStackOOM</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">dontStop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">stackLeakByThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">Thread</span> thread <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token annotation punctuation">@Override</span>
                <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token function">dontStop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            thread<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">{</span>
        <span class="token class-name">JavaVMStackOOM</span> oom <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JavaVMStackOOM</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        oom<span class="token punctuation">.</span><span class="token function">stackLeakByThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><p>提示一下, 上述代码执行时有很高的风险, 可能会由于创建线程数量过多而导致操作系统假死.</p> <p>在 32 位操作系统下的运行结果:</p> <div class="language-ziti1 line-numbers-mode"><pre class="language-text"><code>Exception in thread &quot;main&quot; java.lang.OutOfMemoryError: unable to create native thread
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>出现 StackOverflowError 异常时, 会有明确错误堆栈可供分析, 相对而言比较容易定位到问题所在. 如果使用 HotSpot 虚拟机默认参数, 栈深度在大多数情况下(因为每个方法压入栈的帧大小并不是一样的, 所以只能说大多数情况下)到达 1000 ~ 2000 是完全没有问题, 对于正常的方法调用(包括不能做尾递归优化的递归调用), 这个深度应该完全够用了. 但如果是建立过多线程导致的内存溢出, 在不能减少线程数量或者更换 64 位虚拟机的情况下, 就只能通过减少最大堆和减少栈容量来换取更多的线程. 这种通过 &quot;减少内存&quot; 的手段来解决内存溢出的方式, 如果没有这方面处理经验, 一般比较难以想到, 这一点读者需要在开发 32 位系统的多线程应用时注意.</p> <h5 id="_3-方法区和运行时常量池溢出示例"><a href="#_3-方法区和运行时常量池溢出示例" class="header-anchor">#</a> 3.方法区和运行时常量池溢出示例</h5> <p>由于<strong>运行时常量池是方法区的一部分</strong>, 所以这两个区域的溢出测试可以放到一起进行. 前面曾经提到 HotSpot 从 JDK 7 开始逐步 &quot;去永久代&quot; 的计划, 并在 JDK 8 中完全使用元空间来代替永久代, 在此就以测试代码来<strong>观察一下, 使用 &quot;永久代&quot; 还是 &quot;元空间&quot; 来实现方法区, 对程序有什么实际的影响</strong>.</p> <p>​<code>String::intern()</code>​ 是一个本地方法, 它的作用是如果字符串常量池中已经包含一个等于此 String 对象的字符串, 则返回代表池中这个字符串的 String 对象的引用; 否则会将此 String 对象包含的字符串添加到常量池中, 并且返回此 String 对象的引用. 在 JDK 6 或更早之前的 HotSpot 虚拟机中, 常量池都是分配在<strong>永久代</strong>中, 可以通过 <code>-XX: PermSize</code>​ 和 <code>-XX: MaxPermSize</code>​ 限制永久代的大小, 即可间接限制其中常量池的容量, 具体实现如代码清单 2-7 所示, 请测试时首先以 JDK 6 来运行代码.</p> <blockquote><p>代码清单2-7 运行时常量池导致的内存溢出异常</p></blockquote> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
 * VM Args: -XX:PermSize=6M -XX:MaxPermSize=6M
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RuntimeConstantPoolOOM</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 使用 Set 保持着常量池引用, 避免 Full GC回收常量池行为</span>
        <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> set <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 在 short 范围内足以让6MB 的 PermSize 产生 OOM 了</span>
        <span class="token keyword">short</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            set<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">intern</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>运行结果:</p> <div class="language-ziti1 line-numbers-mode"><pre class="language-text"><code>Exception in thread &quot;main&quot; java.lang.OutOfMemoryError: PermGen space
    at java.lang.String.intern(Native Method)
    at org.fenixsoft.oom.RuntimeConstantPoolOOM.main(RuntimeConstantPoolOOM.java: 18)
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>从运行结果中可以看到, 运行时常量池溢出时, 在 OutOfMemoryError 异常后面跟随的提示信息是 &quot;<strong>PermGen space</strong>&quot;, 说明运行时常量池的确是属于<strong>方法区</strong>(即 JDK 6 的 HotSpot 虚拟机中的永久代)的一部分.</p> <p>而使用 JDK 7 或更高版本的 JDK 来运行这段程序并不会得到相同的结果, 无论是在 JDK 7 中继续使用 <code>-XX: MaxPermSize</code>​ 参数或者在 JDK 8 及以上版本使用 <code>-XX: MaxMeta-spaceSize</code>​ 参数把方法区容量同样限制在6MB, 也都不会重现 JDK 6 中的溢出异常, <strong>循环将一直进行下去, 永不停歇</strong>. 出现这种变化, 是因为自 JDK 7 起, <mark><strong>原本存放在永久代的字符串常量池被移至 Java 堆之中, 所以在 JDK 7 及以上版本, 限制方法区的容量对该测试用例来说是毫无意义的</strong></mark>. 这时候使用 -Xmx 参数限制最大堆到 6MB 就能够看到以下两种运行结果之一, 具体取决于哪里的对象分配时产生了溢出:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// OOM 异常一: </span>
<span class="token class-name">Exception</span> in thread <span class="token string">&quot;main&quot;</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>OutOfMemoryError</span><span class="token operator">:</span> <span class="token class-name">Java</span> heap space
    at java<span class="token punctuation">.</span>base<span class="token operator">/</span><span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>Integer</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token class-name">Integer</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">440</span><span class="token punctuation">)</span>
    at java<span class="token punctuation">.</span>base<span class="token operator">/</span><span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">3058</span><span class="token punctuation">)</span>
    at <span class="token class-name">RuntimeConstantPoolOOM</span><span class="token punctuation">.</span><span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">RuntimeConstantPoolOOM</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">12</span><span class="token punctuation">)</span>

<span class="token comment">// OOM 异常二: </span>
<span class="token class-name">Exception</span> in thread <span class="token string">&quot;main&quot;</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>OutOfMemoryError</span><span class="token operator">:</span> <span class="token class-name">Java</span> heap space
    at java<span class="token punctuation">.</span>base<span class="token operator">/</span><span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span>HashMap</span><span class="token punctuation">.</span><span class="token function">resize</span><span class="token punctuation">(</span><span class="token class-name">HashMap</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">699</span><span class="token punctuation">)</span>
    at java<span class="token punctuation">.</span>base<span class="token operator">/</span><span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span>HashMap</span><span class="token punctuation">.</span><span class="token function">putVal</span><span class="token punctuation">(</span><span class="token class-name">HashMap</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">658</span><span class="token punctuation">)</span>
    at java<span class="token punctuation">.</span>base<span class="token operator">/</span><span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span>HashMap</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">HashMap</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">607</span><span class="token punctuation">)</span>
    at java<span class="token punctuation">.</span>base<span class="token operator">/</span><span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span>HashSet</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">HashSet</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">220</span><span class="token punctuation">)</span>
    at <span class="token class-name">RuntimeConstantPoolOOM</span><span class="token punctuation">.</span><span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">RuntimeConstantPoolOOM</span><span class="token punctuation">.</span>java from <span class="token class-name">InputFile</span><span class="token operator">-</span><span class="token class-name">Object</span><span class="token operator">:</span><span class="token number">14</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>关于这个字符串常量池的实现在哪里出现问题, 还可以引申出一些更有意思的影响, 具体见代码清单 2-8 所示.</p> <blockquote><p>代码清单2-8 String.intern()返回引用的测试</p></blockquote> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RuntimeConstantPoolOOM</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> str1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token string">&quot;计算机&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;软件&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>str1<span class="token punctuation">.</span><span class="token function">intern</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> str1<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">String</span> str2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token string">&quot;ja&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;va&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>str2<span class="token punctuation">.</span><span class="token function">intern</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> str2<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>这段代码在 JDK 6 中运行, 会得到两个 false, 而在 JDK 7 中运行, 会得到一个 true 和一个 false. 产生差异的原因是, 在 JDK 6 中, intern() 方法会把首次遇到的字符串实例复制到永久代的字符串常量池中存储, 返回的也是永久代里面这个字符串实例的引用, 而由 StringBuilder 创建的字符串对象实例在 Java 堆上, 所以必然不可能是同一个引用, 结果将返回 false.</p> <p>而 JDK 7(以及部分其他虚拟机, 例如 JRockit)的 intern() 方法实现就不需要再拷贝字符串的实例到永久代了, 既然字符串常量池已经移到 Java 堆中, 那只需要在常量池里<strong>记录一下首次出现的实例引用</strong>即可, 因此 intern() 返回的引用和由 StringBuilder 创建的那个字符串实例就是同一个. 而对 str2 比较返回 false, 这是因为 &quot;java&quot; 这个字符串在执行 <code>StringBuilder.toString()</code>​ 之前就已经出现过了, 字符串常量池中已经有它的引用, 不符合 intern() 方法要求 &quot;首次遇到&quot; 的原则, &quot;计算机软件&quot; 这个字符串则是首次出现的, 因此结果返回 true.</p> <p>再来看看方法区的其他部分的内容, <strong>方法区的主要职责是用于存放类型的相关信息, 如类名, 访问修饰符, 常量池, 字段描述, 方法描述等</strong>. 对于这部分区域的测试, 基本的思路是运行时产生大量的类去填满方法区, 直到溢出为止. 虽然直接使用 Java SE API 也可以<strong>动态产生类</strong>(如反射时的 GeneratedConstructorAccessor 和动态代理等), 但在本次实验中操作起来比较麻烦. 在代码清单 2-8 里笔者借助了 CGLib 直接操作字节码运行时<strong>生成了大量的动态类</strong>.</p> <p>值得特别注意的是, 在这个例子中模拟的场景并非纯粹是一个实验, 类似这样的代码确实可能会出现在实际应用中: 当前的很多主流框架, <strong>如 Spring, Hibernate 对类进行增强时, 都会使用到 CGLib 这类字节码技术, 当增强的类越多, 就需要越大的方法区以保证动态生成的新类型可以载入内存</strong>. 另外, 很多运行于 Java 虚拟机上的动态语言(例如 Groovy 等)通常都会持续创建新类型来支撑语言的动态性, 随着这类动态语言的流行, 与代码清单 2-9 相似的溢出场景也越来越容易遇到.</p> <blockquote><p>代码清单2-9 借助 CGLib 使得方法区出现内存溢出异常</p></blockquote> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
 * VM Args: -XX:PermSize=10M -XX:MaxPermSize=10M
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">JavaMethodAreaOOM</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">Enhancer</span> enhancer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Enhancer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            enhancer<span class="token punctuation">.</span><span class="token function">setSuperclass</span><span class="token punctuation">(</span><span class="token class-name">OOMObject</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            enhancer<span class="token punctuation">.</span><span class="token function">setUseCache</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            enhancer<span class="token punctuation">.</span><span class="token function">setCallback</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MethodInterceptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">intercept</span><span class="token punctuation">(</span><span class="token class-name">Object</span> obj<span class="token punctuation">,</span> <span class="token class-name">Method</span> method<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">,</span> <span class="token class-name">MethodProxy</span> proxy<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span> proxy<span class="token punctuation">.</span><span class="token function">invokeSuper</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            enhancer<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">OOMObject</span> <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><p>在 JDK 7 中的运行结果:</p> <div class="language-ziti1 line-numbers-mode"><pre class="language-text"><code>Caused by: java.lang.OutOfMemoryError: PermGen space
    at java.lang.ClassLoader.defineClass1(Native Method)
    at java.lang.ClassLoader.defineClassCond(ClassLoader.java:632)
    at java.lang.ClassLoader.defineClass(ClassLoader.java:616)
    ... 8 more
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>方法区溢出也是一种常见的内存溢出异常, 一个类如果要被垃圾收集器回收, 要达成的条件是比较苛刻的. 在经常运行时生成大量动态类的应用场景里, 就应该特别关注这些类的回收状况. 这类场景除了之前提到的程序使用了 CGLib 字节码增强和动态语言外, 常见的还有: 大量 JSP 或动态产生 JSP 文件的应用(JSP 第一次运行时需要编译为 Java 类), 基于 OSGi 的应用(即使是同一个类文件, 被不同的加载器加载也会视为不同的类)等.</p> <p>在 JDK 8 以后, 永久代便完全退出了历史舞台, 元空间作为其替代者登场. 在默认设置下, 前面列举的那些正常的动态创建新类型的测试用例已经很难再迫使虚拟机产生方法区的溢出异常了. 不过为了让使用者有预防实际应用里出现类似于代码清单 2-9 那样的破坏性的操作, HotSpot 还是提供了一些参数作为<strong>元空间的防御措施</strong>, 主要包括:</p> <ul><li>​<code>-XX: MaxMetaspaceSize</code>​: 设置元空间最大值, 默认是 -1, 即不限制, 或者说只受限于本地内存大小.</li> <li>​<code>-XX: MetaspaceSize</code>​: 指定元空间的初始空间大小, 以字节为单位, 达到该值就会触发垃圾收集进行类型卸载, 同时收集器会对该值进行调整: 如果释放了大量的空间, 就适当降低该值; 如果释放了很少的空间, 那么在不超过 <code>-XX: MaxMetaspaceSize</code>​(如果设置了的话)的情况下, 适当提高该值.</li> <li>​<code>-XX: MinMetaspaceFreeRatio</code>​: 作用是在垃圾收集之后控制最小的元空间剩余容量的百分比, 可减少因为元空间不足导致的垃圾收集的频率. 类似的还有 -XX: Max-MetaspaceFreeRatio, 用于控制最大的元空间剩余容量的百分比.</li></ul> <h5 id="_4-本机直接内存溢出示例"><a href="#_4-本机直接内存溢出示例" class="header-anchor">#</a> 4.本机直接内存溢出示例</h5> <p>直接内存(Direct Memory)的容量大小可通过 <code>-XX: MaxDirectMemorySize</code>​ 参数来指定, 如果不去指定, 则默认与 Java 堆最大值(由 -Xmx 指定)一致, 代码清单 2-10 越过了 DirectByteBuffer 类直接通过反射获取 Unsafe 实例进行内存分配(Unsafe 类的 getUnsafe() 方法指定只有引导类加载器才会返回实例, 体现了设计者希望只有虚拟机标准类库里面的类才能使用 Unsafe 的功能, 在 JDK 10 时才将 Unsafe 的部分功能通过 VarHandle 开放给外部使用), 因为虽然使用 DirectByteBuffer 分配内存也会抛出内存溢出异常, 但它抛出异常时并没有真正向操作系统申请分配内存, 而是通过计算得知内存无法分配就会在代码里手动抛出溢出异常, 真正申请分配内存的方法是 <code>Unsafe::allocateMemory()</code>​.</p> <blockquote><p>代码清单2-10 使用unsafe分配本机内存</p></blockquote> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
 * VM Args: -Xmx20M -XX:MaxDirectMemorySize=10M
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DirectMemoryOOM</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> _1MB <span class="token operator">=</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">Field</span> unsafeField <span class="token operator">=</span> <span class="token class-name">Unsafe</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getDeclaredFields</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        unsafeField<span class="token punctuation">.</span><span class="token function">setAccessible</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Unsafe</span> unsafe <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Unsafe</span><span class="token punctuation">)</span> unsafeField<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 分配直接内存</span>
            unsafe<span class="token punctuation">.</span><span class="token function">allocateMemory</span><span class="token punctuation">(</span>_1MB<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>运行结果:</p> <div class="language-ziti1 line-numbers-mode"><pre class="language-text"><code>Exception in thread &quot;main&quot; java.lang.OutOfMemoryError
    at sun.misc.Unsafe.allocateMemory(Native Method)
    at org.fenixsoft.oom.DMOOM.main(DMOOM.java:20)
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>由直接内存导致的内存溢出, <strong>一个明显的特征是在 Heap Dump 文件中不会看见有什么明显的异常情况, 如果读者发现内存溢出之后产生的 Dump 文件很小, 而程序中又直接或间接使用了 DirectMemory(典型的间接使用就是 NIO)</strong> , 那就可以考虑重点检查一下直接内存方面的原因了.</p> <h4 id="对象创建过程"><a href="#对象创建过程" class="header-anchor">#</a> 对象创建过程</h4> <h5 id="_1-基础"><a href="#_1-基础" class="header-anchor">#</a> 1.基础</h5> <p>介绍完 Java 虚拟机的运行时数据区域之后, 就明白了 Java 虚拟机内存模型的概况, 相信读者了解过内存中放了什么, 也许就会更进一步想了解这些虚拟机内存中数据的其他细节, 譬如<mark><strong>它们是如何创建, 如何布局以及如何访问的</strong></mark>. 对于这样涉及细节的问题, 必须把讨论范围限定在具体的虚拟机和集中在某一个内存区域上才有意义. 基于实用优先的原则, 下面以最常用的虚拟机 HotSpot 和最常用的内存区域 Java 堆为例, 深入<strong>探讨一下 HotSpot 虚拟机在 Java 堆中对象分配, 布局和访问的全过程</strong>.</p> <p>在语言层面上, Java 创建对象通常(例外: 复制, 反序列化)仅仅是一个 new 关键字而已, 而在虚拟机中, 对象(文中讨论的对象限于普通 Java 对象, 不包括数组和 Class 对象等)的创建是一个非常复杂的过程. <strong>只要使用 new 方法, 便需要创建新的对象.</strong></p> <blockquote><p>new一个对象发生了什么?</p></blockquote> <p><img src="/img/image-20230325144646-ymyx4vi.png" alt="https://www.processon.com/diagraming/641e9844b13bd654f0293ee0" title="对象创建过程"></p> <h5 id="_2-对象创建完整过程"><a href="#_2-对象创建完整过程" class="header-anchor">#</a> 2.对象创建完整过程</h5> <p>下面分为五个步骤分别详细介绍.</p> <h6 id="_1-类加载检查"><a href="#_1-类加载检查" class="header-anchor">#</a> (1)类加载检查</h6> <p>第一步: 类加载检查. 首先检查这个类是否已被加载, 解析和初始化过. 如果没有, 则必须先执行相应的类加载过程.</p> <p>当 Java 虚拟机遇到一条字节码 new 指令时, 首先将去检查这个指令的参数是否能在常量池中定位到一个类的符号引用, 并且检查这个符号引用代表的类是否已被加载, 解析和初始化过. 如果没有就必须先执行相应的类加载过程.</p> <p>详细参考: 类加载的过程</p> <h6 id="_2-内存分配"><a href="#_2-内存分配" class="header-anchor">#</a> (2)内存分配</h6> <p>第二步: 为对象分配内存.</p> <p>在类加载检查通过后, 接下来<strong>虚拟机将为新生对象分配内存</strong>. 对象所需内存的大小在类加载完成后便可完全确定, 为对象分配空间的任务实际上便等同于把一块确定大小的内存块从 Java 堆中划分出来.</p> <p>为对象分配内存这个步骤有两个问题:</p> <ol><li>如何划分内存.</li> <li>内存分配的并发问题.</li></ol> <p>下面逐一说明.</p> <blockquote><p>内存分配方式</p></blockquote> <p><strong>内存分配方式</strong>有  <strong>&quot;指针碰撞&quot;</strong>  和  <strong>&quot;空闲列表&quot;</strong>  两种, <strong>选择那种分配方式根据堆是否规整决定, 而堆是否规整又由所采用的垃圾收集器是否带有压缩整理功能决定</strong>.</p> <ul><li>如果堆中<strong>内存是绝对规整</strong>的, 所有用过的内存都放在一边, 空闲的内存放在另一边, 中间放着一个指针作为分界点的指示器, 那所分配内存就仅仅是把那个指针向空闲空间那边挪动一段与对象大小相等的距离. 这种分配方式称为 &quot;<strong>指针碰撞</strong>&quot;.</li> <li>如果堆中<strong>内存并不是规整</strong>的, 已使用的内存和空闲的<strong>内存相互交错</strong>, 虚拟机就必须维护一个列表, 记录哪些内存块是可用的, 在分配的时候从列表中找到一块足够大的空间划分给对象实例, 并更新列表上的记录. 这种分配方式称为  <strong>&quot;空闲列表&quot;</strong> .</li></ul> <p>不同垃圾收集器的对内存的管理方式不同而会采用不同的内存分配方式. 在使用 Serial, ParNew 等带 Compact(紧凑) 过程的收集器时, 系统采用的分配算法是<strong>指针碰撞</strong>, 而使用 CMS 这种基于 Mark-Sweep 算法的收集器时, 通常采用<strong>空闲列表</strong>.</p> <blockquote><p>内存分配并发问题</p></blockquote> <p>除如何划分可用空间之外, 还有另外一个需要考虑的问题: <strong>对象创建在虚拟机中是非常频繁的行为, 即使仅仅修改一个指针所指向的位置, 在并发情况下也并不是线程安全的, 可能出现正在给对象 A 分配内存, 指针还没来得及修改, 对象 B 又同时使用了原来的指针来分配内存的情况</strong>.</p> <p>创建对象的时候有一个很重要的问题就是<strong>线程安全</strong>. 创建对象是很频繁的事情, 作为虚拟机来说, 必须要保证线程是安全的, 一般有如下两种解决内存分配并发问题的方法:</p> <ol><li><strong>CAS + 失败重试:</strong>  CAS 是乐观锁的一种实现方式. 即每次不加锁而是假设没有冲突而去完成某项操作, 如果因为冲突失败就重试, 直到成功为止. <strong>虚拟机采用 CAS 配上失败重试的方式保证更新操作的原子性.</strong></li> <li><strong>本地线程分配缓冲(Thread Local Allocation Buffer,TLAB)</strong> : <strong>把内存分配的动作按照线程划分在不同的空间之中进行, 即每个线程在 Java 堆中预先分配一小块内存, 称为</strong>​<mark><strong>本地线程分配缓冲(Thread Local Allocation Buffer, TLAB</strong></mark>​ <strong>), 哪个线程要分配内存, 就在哪个线程的本地缓冲区中分配, 只有本地缓冲区用完了, 分配新的缓存区时才需要同步锁定</strong>. 虚拟机是否使用 TLAB, 可以通过 <code>-XX: +/-UseTLAB</code>​ 参数来设定.</li></ol> <h6 id="_3-初始化零值"><a href="#_3-初始化零值" class="header-anchor">#</a> (3)初始化零值</h6> <p>第三步: 给对象的属性设置默认零值.</p> <p>内存分配完成之后, 虚拟机必须将分配到的内存空间都<strong>初始化为零值</strong>(但不包括对象头), 如果使用了 TLAB 的话, 这一项工作也可以提前至 TLAB 分配时顺便进行. 这步操作保证了对象的实例字段在 Java 代码中可以不赋初始值就直接使用, 使程序能访问到这些字段的数据类型所对应的零值. 默认零值就是各种数据类型的默认值, 比如 int 默认值为 0.</p> <h6 id="_4-设置对象头"><a href="#_4-设置对象头" class="header-anchor">#</a> (4)设置对象头</h6> <p>第四步: 对对象头进行必要的设置.</p> <p>接下来, Java 虚拟机还要<strong>对对象进行必要的设置</strong>. 例如这个对象是哪个类的实例, 如何才能找到类的元数据信息, 对象的哈希码(实际上对象的哈希码会延后到真正调用 <code>Object::hashCode()</code>​ 方法时才计算), 对象的 GC 分代年龄等信息. 这些信息存放在对象的<strong>对象头</strong>(Object Header)之中. 根据虚拟机当前运行状态的不同, 如是否启用偏向锁等, 对象头会有不同的设置方式.</p> <h6 id="_5-执行init方法"><a href="#_5-执行init方法" class="header-anchor">#</a> (5)执行init方法</h6> <p>在上面工作都完成之后, 从虚拟机的视角来看, 一个<strong>新的对象</strong>已经产生了. 但是从 Java <strong>程序的视角</strong>看来, 对象创建才刚刚开始. 因为构造函数, 即 Class 文件中的 <code>&lt;init&gt;()</code>​ 方法还没有执行, 此时<strong>所有的字段都为默认的零值</strong>, 对象需要的其他资源和状态信息也还没有按照预定的意图构造好. 一般来说, new 指令之后会接着执行 <code>&lt;init&gt;()</code>​ 方法, 此时会按照程序员的意愿<strong>对对象进行初始化</strong>, 这样一个真正可用的对象才算完全被构造出来.</p> <h5 id="_3-创建对象流程源码分析"><a href="#_3-创建对象流程源码分析" class="header-anchor">#</a> 3.创建对象流程源码分析</h5> <p>下面代码清单 2-1 是 HotSpot 虚拟机字节码解释器(bytecodeInterpreter.cpp)中的代码片段. 这个解释器实现很少有机会实际使用, 大部分平台上都使用模板解释器; 当代码通过即时编译器执行时差异就更大了. 不过这段代码(以及笔者添加的注释)用于了解 HotSpot 的运作过程是没有什么问题的.</p> <p><strong>代码清单2-1　HotSpot 解释器代码片段</strong></p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">// 确保常量池中存放的是已解释的类</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>constants<span class="token operator">-&gt;</span><span class="token function">tag_at</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">is_unresolved_klass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 断言确保是 klassOop 和 instanceKlassOop(这部分下一节介绍)</span>
    oop entry <span class="token operator">=</span> <span class="token punctuation">(</span>klassOop<span class="token punctuation">)</span> <span class="token operator">*</span>constants<span class="token operator">-&gt;</span><span class="token function">obj_at_addr</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">assert</span><span class="token punctuation">(</span>entry<span class="token operator">-&gt;</span><span class="token function">is_klass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;Should be resolved klass&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    klassOop k_entry <span class="token operator">=</span> <span class="token punctuation">(</span>klassOop<span class="token punctuation">)</span> entry<span class="token punctuation">;</span>
    <span class="token function">assert</span><span class="token punctuation">(</span>k_entry<span class="token operator">-&gt;</span><span class="token function">klass_part</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">oop_is_instance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;Should be instanceKlass&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    instanceKlass<span class="token operator">*</span> ik <span class="token operator">=</span> <span class="token punctuation">(</span>instanceKlass<span class="token operator">*</span><span class="token punctuation">)</span> k_entry<span class="token operator">-&gt;</span><span class="token function">klass_part</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 确保对象所属类型已经经过初始化阶段</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span> ik<span class="token operator">-&gt;</span><span class="token function">is_initialized</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> ik<span class="token operator">-&gt;</span><span class="token function">can_be_fastpath_allocated</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 取对象长度</span>
        <span class="token class-name">size_t</span> obj_size <span class="token operator">=</span> ik<span class="token operator">-&gt;</span><span class="token function">size_helper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        oop result <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
        <span class="token comment">// 记录是否需要将对象所有字段置零值</span>
        bool need_zero <span class="token operator">=</span> <span class="token operator">!</span>ZeroTLAB<span class="token punctuation">;</span>
        <span class="token comment">// 是否在 TLAB 中分配对象</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>UseTLAB<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            result <span class="token operator">=</span> <span class="token punctuation">(</span>oop<span class="token punctuation">)</span> THREAD<span class="token operator">-&gt;</span><span class="token function">tlab</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">allocate</span><span class="token punctuation">(</span>obj_size<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            need_zero <span class="token operator">=</span> true<span class="token punctuation">;</span>
            <span class="token comment">// 直接在 eden 中分配对象</span>
retry<span class="token operator">:</span>
            HeapWord<span class="token operator">*</span> compare_to <span class="token operator">=</span> <span class="token operator">*</span>Universe<span class="token operator">::</span><span class="token function">heap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">top_addr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            HeapWord<span class="token operator">*</span> new_top <span class="token operator">=</span> compare_to <span class="token operator">+</span> obj_size<span class="token punctuation">;</span>
            <span class="token comment">// cmpxchg 是 x86中的 CAS 指令, 这里是一个 C++方法, 通过 CAS 方式分配空间, 并发失败的</span>
               话<span class="token punctuation">,</span> 转到 retry 中重试直至成功分配为止
            <span class="token keyword">if</span> <span class="token punctuation">(</span>new_top <span class="token operator">&lt;=</span> <span class="token operator">*</span>Universe<span class="token operator">::</span><span class="token function">heap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">end_addr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>Atomic<span class="token operator">::</span><span class="token function">cmpxchg_ptr</span><span class="token punctuation">(</span>new_top<span class="token punctuation">,</span> Universe<span class="token operator">::</span><span class="token function">heap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">top_addr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> compare_to<span class="token punctuation">)</span> <span class="token operator">!=</span> compare_to<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">goto</span> retry<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                result <span class="token operator">=</span> <span class="token punctuation">(</span>oop<span class="token punctuation">)</span> compare_to<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 如果需要, 为对象初始化零值</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>need_zero <span class="token punctuation">)</span> <span class="token punctuation">{</span>
                HeapWord<span class="token operator">*</span> to_zero <span class="token operator">=</span> <span class="token punctuation">(</span>HeapWord<span class="token operator">*</span><span class="token punctuation">)</span> result <span class="token operator">+</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>oopDesc<span class="token punctuation">)</span> <span class="token operator">/</span> oopSize<span class="token punctuation">;</span>
                obj_size <span class="token operator">-=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>oopDesc<span class="token punctuation">)</span> <span class="token operator">/</span> oopSize<span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>obj_size <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token function">memset</span><span class="token punctuation">(</span>to_zero<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> obj_size <span class="token operator">*</span> HeapWordSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// 根据是否启用偏向锁, 设置对象头信息</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>UseBiasedLocking<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                result<span class="token operator">-&gt;</span><span class="token function">set_mark</span><span class="token punctuation">(</span>ik<span class="token operator">-&gt;</span><span class="token function">prototype_header</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                result<span class="token operator">-&gt;</span><span class="token function">set_mark</span><span class="token punctuation">(</span>markOopDesc<span class="token operator">::</span><span class="token function">prototype</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            result<span class="token operator">-&gt;</span><span class="token function">set_klass_gap</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            result<span class="token operator">-&gt;</span><span class="token function">set_klass</span><span class="token punctuation">(</span>k_entry<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 将对象引用入栈, 继续执行下一条指令</span>
            <span class="token function">SET_STACK_OBJECT</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">UPDATE_PC_AND_TOS_AND_CONTINUE</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br></div></div><h4 id="对象的内存布局"><a href="#对象的内存布局" class="header-anchor">#</a> 对象的内存布局</h4> <h5 id="_1-对象的内存布局"><a href="#_1-对象的内存布局" class="header-anchor">#</a> 1.对象的内存布局</h5> <p>内存中 Java 是如何保存对象的? 在 HotSpot 虚拟机里, 对象在堆内存中的<strong>存储布局</strong>可以划分为三个部分: <mark><strong>对象头(Header), 实例数据(Instance Data)和对齐填充(Padding)</strong></mark> . 下面详细讲解各部分内容.</p> <p><img src="https://nano-note.oss-cn-beijing.aliyuncs.com/images/image-20220601230845563.png" alt=""></p> <h6 id="_1-对象头"><a href="#_1-对象头" class="header-anchor">#</a> (1)对象头</h6> <p>HotSpot 虚拟机对象的<strong>对象头</strong>部分包括两部分信息.</p> <blockquote><p>第一部分: 存储对象自身的运行时数据</p></blockquote> <p><strong>第一类是用于存储</strong>​<mark><strong>对象自身的运行时数据</strong></mark>​ **, 如哈希码(HashCode), GC 分代年龄, 锁状态标志, 线程持有的锁, 偏向线程 ID, 偏向时间戳等, 这部分数据的长度在 32 位和 64 位的虚拟机(未开启压缩指针)中分别为 32 个比特和 64 个比特, 官方称它为 &quot;**​<mark><strong>Mark Word</strong></mark>​ <strong>&quot;</strong> . 对象需要存储的运行时数据很多, 考虑到虚拟机的空间效率, Mark Word 被设计成一个有着动态定义的数据结构, 以便在极小的空间内存储尽量多的数据, 它会根据对象的状态复用自己的存储空间.</p> <p><strong>Mark Word</strong> 在<strong>不同的锁状态</strong>下存储的内容不同. 例如在 32 位的 HotSpot 虚拟机中, 如对象未被同步锁锁定的状态下, Mark Word 的 32 个比特存储空间中的 25 个比特用于存储对象哈希码, 4 个比特用于存储对象分代年龄, 2 个比特用于存储锁标志位, 1 个比特固定为 0.</p> <p><img src="https://nano-note.oss-cn-beijing.aliyuncs.com/images/1568943231089-2797133.png" alt=""></p> <p>64 位 JVM 是这样的.</p> <p><img src="/img/image-20230325150955-119s4vt.png" alt="image"></p> <blockquote><p>第二部分: 类型指针</p></blockquote> <p>对象头的第二部分是<mark><strong>类型指针</strong></mark>, 即对象指向它的<strong>类型元数据的指针</strong>, Java 虚拟机通过这个指针来<strong>确定该对象是哪个类的实例</strong>. 并不是所有的虚拟机实现都必须在对象数据上保留类型指针, 换句话说, 查找对象的元数据信息并不一定要经过对象本身, 这点会在下一节具体讨论.</p> <p>此外, 如果对象是一个 Java <strong>数组</strong>, 那在对象头中还必须有一块用于记录数组长度的数据, 因为虚拟机可以通过普通对象的元数据信息确定对象的大小, 但是从数组的元数据中无法确定数组的大小.</p> <p>下面是 HotSpot 虚拟机代表 Mark Word 中的<strong>代码(markOop.cpp)注释片段</strong>, 它描述了 32 位虚拟机 Mark Word 的存储布局:</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">// Bit-format of an object header (most significant first, big endian layout below):</span>
<span class="token comment">//</span>
<span class="token comment">//  32 bits:</span>
<span class="token comment">//  --------</span>
<span class="token comment">//             hash:25 ------------&gt;| age:4    biased_lock:1 lock:2 (normal object)</span>
<span class="token comment">//             JavaThread*:23 epoch:2 age:4    biased_lock:1 lock:2 (biased object)</span>
<span class="token comment">//             size:32 ------------------------------------------&gt;| (CMS free block)</span>
<span class="token comment">//             PromotedObject*:29 ----------&gt;| promo_bits:3 -----&gt;| (CMS promoted object)</span>
<span class="token comment">//</span>
<span class="token comment">//  64 bits:</span>
<span class="token comment">//  --------</span>
<span class="token comment">//  unused:25 hash:31 --&gt;| unused:1   age:4    biased_lock:1 lock:2 (normal object)</span>
<span class="token comment">//  JavaThread*:54 epoch:2 unused:1   age:4    biased_lock:1 lock:2 (biased object)</span>
<span class="token comment">//  PromotedObject*:61 ---------------------&gt;| promo_bits:3 -----&gt;| (CMS promoted object)</span>
<span class="token comment">//  size:64 -----------------------------------------------------&gt;| (CMS free block)</span>
<span class="token comment">//</span>
<span class="token comment">//  unused:25 hash:31 --&gt;| cms_free:1 age:4    biased_lock:1 lock:2 (COOPs &amp;&amp; normal object)</span>
<span class="token comment">//  JavaThread*:54 epoch:2 cms_free:1 age:4    biased_lock:1 lock:2 (COOPs &amp;&amp; biased object)</span>
<span class="token comment">//  narrowOop:32 unused:24 cms_free:1 unused:4 promo_bits:3 -----&gt;| (COOPs &amp;&amp; CMS promoted object)</span>
<span class="token comment">//  unused:21 size:35 --&gt;| cms_free:1 unused:7 ------------------&gt;| (COOPs &amp;&amp; CMS free block)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><h6 id="_2-实例数据"><a href="#_2-实例数据" class="header-anchor">#</a> (2)实例数据</h6> <p>接下来实例数据部分是<mark><strong>对象真正存储的有效信息</strong></mark>, 即在程序代码里面所定义的各种类型的<strong>字段内容</strong>, 无论是从父类继承下来的, 还是在子类中定义的字段都必须记录起来.</p> <h6 id="_3-对齐填充"><a href="#_3-对齐填充" class="header-anchor">#</a> (3)对齐填充</h6> <p>对齐填充不是必然存在的, 它仅起到<strong>占位符</strong>的作用. 由于 HotSpot 的自动内存管理系统要求对象起始地址必须是 <strong>8 字节</strong>的整数倍, 所以对象的大小必须是 8 字节的整数倍, 当对象实例数据部分所占长度不够没有对齐时, 就需要通过对齐填充来补全.</p> <p>对于大部分处理器, 对象以 8 字节整数倍来对齐填充都是最高效的存取方式.</p> <h5 id="_2-估算对象大小"><a href="#_2-估算对象大小" class="header-anchor">#</a> 2.估算对象大小</h5> <blockquote><p>如何估算对象大小?</p></blockquote> <p>32 位系统下, 当使用 <strong>new Object()</strong>  时, JVM 将会分配 <strong>8</strong>(Mark Word + 类型指针) 字节的空间, 128 个 Object 对象将占用 1KB 的空间.</p> <p>如果是 <strong>new Integer()</strong> , 那么对象里还有一个 <strong>int 值</strong>, 其占用 <strong>4 字节</strong>, 这个对象也就是 8 + 4 = 12 字节, 对齐后, 该对象就是 16 字节.</p> <p>以上只是一些简单的对象, 那么常规对象的内部属性是怎么排布的?</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">Class</span> <span class="token class-name">A</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> i<span class="token punctuation">;</span>
    <span class="token keyword">byte</span> b<span class="token punctuation">;</span>
    <span class="token class-name">String</span> str<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>其中对象头部占用 &quot;Mark Word&quot;(4) + &quot;类型指针&quot;(4) = 8 字节; byte 8 位, 占用 1 字节; int 32 位, 占用 4 字节; String 只有引用, 占用 4 字节. 那么对象 A 一共占用了 8+1+4+4 = 17 字节, 按照 8 字节对齐原则, 对象大小也就是 24 字节.</p> <p>这个计算看起来是没有问题的, 对象的大小也确实是 24 字节, 只是实际<strong>对齐</strong>的位置并不对: 在 HotSpot 中, 对象排布时, 间隙是在 4 字节基础上的(在 32 位和 64 位压缩模式下). 上述例子中, int 后面的 byte, 空隙只剩下 3 字节, 接下来的 String 对象引用需要 4 字节来存放, 因此 byte 和对象引用之间就会有 3 字节对齐, 对象引用排布后, 最后会有 4 字节对齐, 因此结果上依然是 7 字节对齐.</p> <p>对象大小也可以用 jol-core 包查看, 依赖.</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.openjdk.jol<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>jol-core<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>0.9<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h4 id="对象的访问定位"><a href="#对象的访问定位" class="header-anchor">#</a> 对象的访问定位</h4> <p>为了表示对象的属性, 方法等信息, 不得不需要<strong>结构描述</strong>. 每一个类在被 JVM 加载的时候, JVM 会给这个类创建一个 <strong>instanceKlass</strong> 类型数据, 保存在<strong>方法区</strong>, 用来在 JVM 层表示该类. Hotspot VM 使用<strong>对象头部的一个元数据指针指向 Class 区域</strong>的方式来找到对象的 Class 描述, 以及内部的方法, 属性入口. 如下图所示:</p> <p><img src="/img/image-20230325151334-9riqp7w.png" alt="image"></p> <p>创建对象自然是为了后续使用该对象, <strong>Java 程序会通过栈上的 reference 数据来操作堆上的具体对象</strong>. 由于 reference 类型在虚拟机规范中只规定了它是<strong>一个指向对象的引用</strong>, 并没有定义这个引用应该通过什么方式去定位, 访问到堆中对象的具体位置, 所以<strong>对象访问方式也是由虚拟机实现而定</strong>的. 主流的访问方式主要有<strong>使用句柄和直接指针</strong>两种.</p> <blockquote><p>使用句柄</p></blockquote> <p><strong>使用句柄(类似间接指针):</strong> <strong><strong>在</strong></strong>​<strong>堆</strong>中划分出一块<strong>内存</strong>来作为<strong>句柄池</strong>, reference 中存储的就是<strong>对象的句柄地址</strong>, 句柄中包含对象实例数据与类型各自具体地址信息. 如下图所示.</p> <p><img src="https://nano-note.oss-cn-beijing.aliyuncs.com/images/image-20220517225207613.png" alt=""></p> <blockquote><p>直接指针</p></blockquote> <p><strong>直接指针访问:</strong> <strong><strong>Java 堆中的对象布要考虑如何放置访问类型数据相关的信息, 而</strong></strong> <strong><strong><strong>reference</strong></strong></strong> <strong><strong>中存储的</strong></strong>​<strong>直接就是对象地址</strong>. 如果只是访问对象本身的话, 就不需要多一次间接访问的开销. 如下图所示. <strong>Hotspot 虚拟机采用此种方式</strong>.</p> <p><img src="https://nano-note.oss-cn-beijing.aliyuncs.com/images/image-20220517225228895.png" alt=""></p> <blockquote><p>两种方式对比</p></blockquote> <p>这两种对象访问方式各有优势, 使用句柄来访问的最大好处就是 reference 中存储的是稳定句柄地址, 在对象被移动(垃圾收集时移动对象是非常普遍的行为)时只会改变句柄中的实例数据指针, 而 reference 本身不需要被修改.</p> <p>使用直接指针来访问最大的好处就是<strong>速度更快</strong>, 它节省了一次指针定位的时间开销, 由于对象访问在 Java 中非常频繁, 因此这类开销积少成多也是一项极为可观的执行成本, 就本书讨论的<strong>主要虚拟机 HotSpot 而言, 它主要使用第二种方式(直接指针访问)进行对象访问</strong>(有例外情况, 如果使用了 Shenandoah 收集器的话也会有一次额外的转发), 但从整个软件开发的范围来看, 在各种语言, 框架中使用句柄来访问的情况也十分常见.</p> <h4 id="运行时数据区综合示例"><a href="#运行时数据区综合示例" class="header-anchor">#</a> 运行时数据区综合示例</h4> <p>看一个 Math 类:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>nano<span class="token punctuation">.</span>jvm</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Math</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token class-name">Math</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">compute</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> a <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> b <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> c <span class="token operator">=</span> <span class="token punctuation">(</span>a <span class="token operator">+</span> b<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">10</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> c<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Math</span> math <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Math</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> res <span class="token operator">=</span> math<span class="token punctuation">.</span><span class="token function">compute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p><strong>编译后</strong>生成的 Math.class 的文件用记事本打开如下.</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>cafe babe <span class="token number">0000</span> <span class="token number">0033</span> <span class="token number">001f</span> <span class="token number">0</span>a00 <span class="token number">0500</span> <span class="token number">1</span>b07
<span class="token number">001</span>c <span class="token number">0</span>a00 <span class="token number">0200</span> <span class="token number">1</span>b0a <span class="token number">0002</span> <span class="token number">001d</span> <span class="token number">0700</span> <span class="token number">1e01</span>
<span class="token number">0006</span> <span class="token number">3</span>c69 <span class="token number">6e69</span> <span class="token number">743</span>e <span class="token number">0100</span> <span class="token number">0328</span> <span class="token number">2956</span> <span class="token number">0100</span>
<span class="token number">0443</span> <span class="token number">6f</span><span class="token number">64</span> <span class="token number">6501</span> <span class="token number">000f</span> <span class="token number">4</span>c69 <span class="token number">6e65</span> <span class="token number">4e75</span> <span class="token number">6d</span><span class="token number">62</span>
<span class="token number">6572</span> <span class="token number">5461</span> <span class="token number">626</span>c <span class="token number">6501</span> <span class="token number">0012</span> <span class="token number">4</span>c6f <span class="token number">6361</span> <span class="token number">6</span>c56
<span class="token number">6172</span> <span class="token number">6961</span> <span class="token number">626</span>c <span class="token number">6554</span> <span class="token number">6162</span> <span class="token number">6</span>c65 <span class="token number">0100</span> <span class="token number">0474</span>
<span class="token number">6869</span> <span class="token number">7301</span> <span class="token number">000f</span> <span class="token number">4</span>c63 <span class="token number">6f</span><span class="token number">6d</span> <span class="token number">2f</span><span class="token number">6</span>e <span class="token number">616</span>e <span class="token number">6f</span><span class="token number">2f</span>
<span class="token number">4d</span><span class="token number">61</span> <span class="token number">7468</span> <span class="token number">3</span>b01 <span class="token number">0007</span> <span class="token number">636f</span> <span class="token number">6d</span><span class="token number">70</span> <span class="token number">7574</span> <span class="token number">6501</span>
<span class="token number">0003</span> <span class="token number">2829</span> <span class="token number">4901</span> <span class="token number">0001</span> <span class="token number">6101</span> <span class="token number">0001</span> <span class="token number">4901</span> <span class="token number">0001</span>
<span class="token number">6201</span> <span class="token number">0001</span> <span class="token number">6301</span> <span class="token number">0004</span> <span class="token number">6d</span><span class="token number">61</span> <span class="token number">696</span>e <span class="token number">0100</span> <span class="token number">1628</span>
<span class="token number">5</span>b4c <span class="token number">6</span>a61 <span class="token number">7661</span> <span class="token number">2f</span><span class="token number">6</span>c <span class="token number">616</span>e <span class="token number">672f</span> <span class="token number">5374</span> <span class="token number">7269</span>
<span class="token number">6e67</span> <span class="token number">3</span>b29 <span class="token number">5601</span> <span class="token number">0004</span> <span class="token number">6172</span> <span class="token number">6773</span> <span class="token number">0100</span> <span class="token number">135</span>b
<span class="token number">4</span>c6a <span class="token number">6176</span> <span class="token number">612f</span> <span class="token number">6</span>c61 <span class="token number">6e67</span> <span class="token number">2f</span><span class="token number">53</span> <span class="token number">7472</span> <span class="token number">696</span>e
<span class="token number">673</span>b <span class="token number">0100</span> <span class="token number">046d</span> <span class="token number">6174</span> <span class="token number">6801</span> <span class="token number">0003</span> <span class="token number">7265</span> <span class="token number">7301</span>
<span class="token number">000</span>a <span class="token number">536f</span> <span class="token number">7572</span> <span class="token number">6365</span> <span class="token number">4669</span> <span class="token number">6</span>c65 <span class="token number">0100</span> <span class="token number">094d</span>
<span class="token number">6174</span> <span class="token number">682</span>e <span class="token number">6</span>a61 <span class="token number">7661</span> <span class="token number">0</span>c00 <span class="token number">0600</span> <span class="token number">0701</span> <span class="token number">000d</span>
<span class="token number">636f</span> <span class="token number">6d</span><span class="token number">2f</span> <span class="token number">6e61</span> <span class="token number">6e6f</span> <span class="token number">2f</span><span class="token number">4d</span> <span class="token number">6174</span> <span class="token number">680</span>c <span class="token number">000d</span>
<span class="token number">000</span>e <span class="token number">0100</span> <span class="token number">106</span>a <span class="token number">6176</span> <span class="token number">612f</span> <span class="token number">6</span>c61 <span class="token number">6e67</span> <span class="token number">2f</span><span class="token number">4f</span>
<span class="token number">626</span>a <span class="token number">6563</span> <span class="token number">7400</span> <span class="token number">2100</span> <span class="token number">0200</span> <span class="token number">0500</span> <span class="token number">0000</span> <span class="token number">0000</span>
<span class="token number">0300</span> <span class="token number">0100</span> <span class="token number">0600</span> <span class="token number">0700</span> <span class="token number">0100</span> <span class="token number">0800</span> <span class="token number">0000</span> <span class="token number">3300</span>
<span class="token number">0100</span> <span class="token number">0100</span> <span class="token number">0000</span> <span class="token number">052</span>a b700 <span class="token number">01</span>b1 <span class="token number">0000</span> <span class="token number">0002</span>
<span class="token number">0009</span> <span class="token number">0000</span> <span class="token number">000</span>a <span class="token number">0002</span> <span class="token number">0000</span> <span class="token number">0009</span> <span class="token number">0004</span> <span class="token number">000</span>a
<span class="token number">000</span>a <span class="token number">0000</span> <span class="token number">000</span>c <span class="token number">0001</span> <span class="token number">0000</span> <span class="token number">0005</span> <span class="token number">000</span>b <span class="token number">000</span>c
<span class="token number">0000</span> <span class="token number">0001</span> <span class="token number">000d</span> <span class="token number">000</span>e <span class="token number">0001</span> <span class="token number">0008</span> <span class="token number">0000</span> <span class="token number">0061</span>
<span class="token number">0002</span> <span class="token number">0004</span> <span class="token number">0000</span> <span class="token number">000d</span> <span class="token number">043</span>c <span class="token number">053d</span> <span class="token number">1</span>b1c <span class="token number">6010</span>
<span class="token number">0</span>a68 <span class="token number">3e1d</span> ac00 <span class="token number">0000</span> <span class="token number">0200</span> <span class="token number">0900</span> <span class="token number">0000</span> <span class="token number">1200</span>
<span class="token number">0400</span> <span class="token number">0000</span> <span class="token number">0d</span><span class="token number">00</span> <span class="token number">0200</span> <span class="token number">0e00</span> <span class="token number">0400</span> <span class="token number">0f</span><span class="token number">00</span> <span class="token number">0b00</span>
<span class="token number">1000</span> <span class="token number">0</span>a00 <span class="token number">0000</span> <span class="token number">2</span>a00 <span class="token number">0400</span> <span class="token number">0000</span> <span class="token number">0d</span><span class="token number">00</span> <span class="token number">0b00</span>
<span class="token number">0</span>c00 <span class="token number">0000</span> <span class="token number">0200</span> <span class="token number">0b00</span> <span class="token number">0f</span><span class="token number">00</span> <span class="token number">1000</span> <span class="token number">0100</span> <span class="token number">0400</span>
<span class="token number">0900</span> <span class="token number">1100</span> <span class="token number">1000</span> <span class="token number">0200</span> <span class="token number">0b00</span> <span class="token number">0200</span> <span class="token number">1200</span> <span class="token number">1000</span>
<span class="token number">0300</span> <span class="token number">0900</span> <span class="token number">1300</span> <span class="token number">1400</span> <span class="token number">0100</span> <span class="token number">0800</span> <span class="token number">0000</span> <span class="token number">5400</span>
<span class="token number">0200</span> <span class="token number">0300</span> <span class="token number">0000</span> <span class="token number">0</span>ebb <span class="token number">0002</span> <span class="token number">59</span>b7 <span class="token number">0003</span> <span class="token number">4</span>c2b
b600 <span class="token number">043d</span> b100 <span class="token number">0000</span> <span class="token number">0200</span> <span class="token number">0900</span> <span class="token number">0000</span> <span class="token number">0e00</span>
<span class="token number">0300</span> <span class="token number">0000</span> <span class="token number">1400</span> <span class="token number">0800</span> <span class="token number">1500</span> <span class="token number">0d</span><span class="token number">00</span> <span class="token number">1600</span> <span class="token number">0</span>a00
<span class="token number">0000</span> <span class="token number">2000</span> <span class="token number">0300</span> <span class="token number">0000</span> <span class="token number">0e00</span> <span class="token number">1500</span> <span class="token number">1600</span> <span class="token number">0000</span>
<span class="token number">0800</span> <span class="token number">0600</span> <span class="token number">1700</span> <span class="token number">0</span>c00 <span class="token number">0100</span> <span class="token number">0d</span><span class="token number">00</span> <span class="token number">0100</span> <span class="token number">1800</span>
<span class="token number">1000</span> <span class="token number">0200</span> <span class="token number">0100</span> <span class="token number">1900</span> <span class="token number">0000</span> <span class="token number">0200</span> <span class="token number">1</span>a
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br></div></div><p>一般不会去人工解析这种 16 进制的<strong>字节码文件</strong>, 可以通过 <strong>javap 命令反编译 class 文件生成更可读的 JVM 字节码指令文件</strong>:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>javap <span class="token operator">-</span>v <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token keyword">class</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>使用 <strong>javap -c</strong> 对 Math.class 类进行<strong>反编译</strong>得到如下<strong>字节码指令</strong>.</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>$ javap <span class="token operator">-</span>c <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token keyword">class</span>
<span class="token class-name">Compiled</span> from <span class="token string">&quot;Math.java&quot;</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>nano<span class="token punctuation">.</span>jvm<span class="token punctuation">.</span></span>Math</span> <span class="token punctuation">{</span>
  <span class="token keyword">public</span> <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>nano<span class="token punctuation">.</span>jvm<span class="token punctuation">.</span></span>Math</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Code</span><span class="token operator">:</span>
       <span class="token number">0</span><span class="token operator">:</span> aload_0
       <span class="token number">1</span><span class="token operator">:</span> invokespecial #<span class="token number">1</span>     <span class="token comment">// Method java/lang/Object.&quot;&lt;init&gt;&quot;:()V</span>
       <span class="token number">4</span><span class="token operator">:</span> <span class="token keyword">return</span>
  <span class="token comment">// 计算方法</span>
  <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">compute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Code</span><span class="token operator">:</span>
       <span class="token number">0</span><span class="token operator">:</span> iconst_1
       <span class="token number">1</span><span class="token operator">:</span> istore_1
       <span class="token number">2</span><span class="token operator">:</span> iconst_2
       <span class="token number">3</span><span class="token operator">:</span> istore_2
       <span class="token number">4</span><span class="token operator">:</span> iload_1
       <span class="token number">5</span><span class="token operator">:</span> iload_2
       <span class="token number">6</span><span class="token operator">:</span> iadd
       <span class="token number">7</span><span class="token operator">:</span> bipush        <span class="token number">10</span>
       <span class="token number">9</span><span class="token operator">:</span> imul
      <span class="token number">10</span><span class="token operator">:</span> istore_3
      <span class="token number">11</span><span class="token operator">:</span> iload_3
      <span class="token number">12</span><span class="token operator">:</span> ireturn

  <span class="token comment">// main方法  </span>
  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Code</span><span class="token operator">:</span>
       <span class="token number">0</span><span class="token operator">:</span> <span class="token keyword">new</span>           #<span class="token number">2</span>                  <span class="token comment">// class com/nano/jvm/Math</span>
       <span class="token number">3</span><span class="token operator">:</span> dup
       <span class="token number">4</span><span class="token operator">:</span> invokespecial #<span class="token number">3</span>                  <span class="token comment">// Method &quot;&lt;init&gt;&quot;:()V</span>
       <span class="token number">7</span><span class="token operator">:</span> astore_1
       <span class="token number">8</span><span class="token operator">:</span> aload_1
       <span class="token number">9</span><span class="token operator">:</span> invokevirtual #<span class="token number">4</span>                  <span class="token comment">// Method compute:()I</span>
      <span class="token number">12</span><span class="token operator">:</span> pop
      <span class="token number">13</span><span class="token operator">:</span> <span class="token keyword">return</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br></div></div><p>可以看到两个方法都被反编译出来. <strong>Code</strong> 下面各个字节码指令之前的号码就可以看成是<strong>行号</strong>, <strong>程序计数器</strong>就是记录执行时的这些行号. 上面的计算过程在运行时数据区中的体现如下. 这里的信息量很多, 仔细看图.</p> <p><img src="/img/image-20230325134224-4lojnst.png" alt="image"></p> <p>可以看到这个 main 线程中<strong>分配了两个栈帧(每个方法都会分配一个栈帧)</strong> , 一个是 <strong>main() 方法的栈帧</strong>, 一个是 <strong>compute() 方法的栈帧</strong>, <strong>局部变量 a b c 都在局部变量表中, 计算 a + b 的时候需要把它们加载到操作数栈进行加法操作</strong>, 具体可以看字节码的指令就是这个过程.</p> <p>在 main() 方法对应的栈帧中, <strong>math 变量</strong>是一个<strong>普通对象</strong>, 它指向<strong>堆中</strong>的实例.</p> <p>再使用 <strong>javap -v</strong> 参数<strong>反编译</strong> Math.class, 可以看到反编译出<strong>更多的信息</strong>.</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>$ javap <span class="token parameter variable">-v</span> Math.class

Classfile /Users/nano/NanoNoteCode/jvm/target/classes/com/nano/Math.class
  Last modified <span class="token number">2023</span>-3-23<span class="token punctuation">;</span> size <span class="token number">589</span> bytes
  MD5 checksum 20a52ab32d258c5fb970c324580aee76
  Compiled from <span class="token string">&quot;Math.java&quot;</span>
public class com.nano.Math
  minor version: <span class="token number">0</span>
  major version: <span class="token number">51</span>
  flags: ACC_PUBLIC, ACC_SUPER
<span class="token comment"># 常量池信息</span>
Constant pool:
   <span class="token comment">#1 = Methodref          #5.#27         // java/lang/Object.&quot;&lt;init&gt;&quot;:()V</span>
   <span class="token comment">#2 = Class              #28            // com/nano/Math</span>
   <span class="token comment">#3 = Methodref          #2.#27         // com/nano/Math.&quot;&lt;init&gt;&quot;:()V</span>
   <span class="token comment">#4 = Methodref          #2.#29         // com/nano/Math.compute:()I</span>
   <span class="token comment">#5 = Class              #30            // java/lang/Object</span>
   <span class="token comment">#6 = Utf8               &lt;init&gt;</span>
   <span class="token comment">#7 = Utf8               ()V</span>
   <span class="token comment">#8 = Utf8               Code</span>
   <span class="token comment">#9 = Utf8               LineNumberTable</span>
  <span class="token comment">#10 = Utf8               LocalVariableTable</span>
  <span class="token comment">#11 = Utf8               this</span>
  <span class="token comment">#12 = Utf8               Lcom/nano/Math;</span>
  <span class="token comment">#13 = Utf8               compute</span>
  <span class="token comment">#14 = Utf8               ()I</span>
  <span class="token comment">#15 = Utf8               a</span>
  <span class="token comment">#16 = Utf8               I</span>
  <span class="token comment">#17 = Utf8               b</span>
  <span class="token comment">#18 = Utf8               c</span>
  <span class="token comment">#19 = Utf8               main</span>
  <span class="token comment">#20 = Utf8               ([Ljava/lang/String;)V</span>
  <span class="token comment">#21 = Utf8               args</span>
  <span class="token comment">#22 = Utf8               [Ljava/lang/String;</span>
  <span class="token comment">#23 = Utf8               math</span>
  <span class="token comment">#24 = Utf8               res</span>
  <span class="token comment">#25 = Utf8               SourceFile</span>
  <span class="token comment">#26 = Utf8               Math.java</span>
  <span class="token comment">#27 = NameAndType        #6:#7          // &quot;&lt;init&gt;&quot;:()V</span>
  <span class="token comment">#28 = Utf8               com/nano/Math</span>
  <span class="token comment">#29 = NameAndType        #13:#14        // compute:()I</span>
  <span class="token comment">#30 = Utf8               java/lang/Object</span>
<span class="token punctuation">{</span>
  public com.nano.Math<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    descriptor: <span class="token punctuation">(</span><span class="token punctuation">)</span>V
    flags: ACC_PUBLIC
    Code:
      <span class="token assign-left variable">stack</span><span class="token operator">=</span><span class="token number">1</span>, <span class="token assign-left variable">locals</span><span class="token operator">=</span><span class="token number">1</span>, <span class="token assign-left variable">args_size</span><span class="token operator">=</span><span class="token number">1</span>
         <span class="token number">0</span>: aload_0
         <span class="token number">1</span>: invokespecial <span class="token comment">#1                  // Method java/lang/Object.&quot;&lt;init&gt;&quot;:()V</span>
         <span class="token number">4</span>: <span class="token builtin class-name">return</span>
      LineNumberTable:
        line <span class="token number">9</span>: <span class="token number">0</span>
        line <span class="token number">10</span>: <span class="token number">4</span>
      LocalVariableTable:
        Start  Length  Slot  Name   Signature
            <span class="token number">0</span>       <span class="token number">5</span>     <span class="token number">0</span>  this   Lcom/nano/Math<span class="token punctuation">;</span>

  public int compute<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    descriptor: <span class="token punctuation">(</span><span class="token punctuation">)</span>I
    flags: ACC_PUBLIC
    Code:
      <span class="token assign-left variable">stack</span><span class="token operator">=</span><span class="token number">2</span>, <span class="token assign-left variable">locals</span><span class="token operator">=</span><span class="token number">4</span>, <span class="token assign-left variable">args_size</span><span class="token operator">=</span><span class="token number">1</span>
         <span class="token number">0</span>: iconst_1
         <span class="token number">1</span>: istore_1
         <span class="token number">2</span>: iconst_2
         <span class="token number">3</span>: istore_2
         <span class="token number">4</span>: iload_1
         <span class="token number">5</span>: iload_2
         <span class="token number">6</span>: iadd
         <span class="token number">7</span>: bipush        <span class="token number">10</span>
         <span class="token number">9</span>: imul
        <span class="token number">10</span>: istore_3
        <span class="token number">11</span>: iload_3
        <span class="token number">12</span>: ireturn
      LineNumberTable:
        line <span class="token number">13</span>: <span class="token number">0</span>
        line <span class="token number">14</span>: <span class="token number">2</span>
        line <span class="token number">15</span>: <span class="token number">4</span>
        line <span class="token number">16</span>: <span class="token number">11</span>
      LocalVariableTable:
        Start  Length  Slot  Name   Signature
            <span class="token number">0</span>      <span class="token number">13</span>     <span class="token number">0</span>  this   Lcom/nano/Math<span class="token punctuation">;</span>
            <span class="token number">2</span>      <span class="token number">11</span>     <span class="token number">1</span>     a   I
            <span class="token number">4</span>       <span class="token number">9</span>     <span class="token number">2</span>     b   I
           <span class="token number">11</span>       <span class="token number">2</span>     <span class="token number">3</span>     c   I

  public static void main<span class="token punctuation">(</span>java.lang.String<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    descriptor: <span class="token punctuation">(</span><span class="token punctuation">[</span>Ljava/lang/String<span class="token punctuation">;</span><span class="token punctuation">)</span>V
    flags: ACC_PUBLIC, ACC_STATIC
    Code:
      <span class="token assign-left variable">stack</span><span class="token operator">=</span><span class="token number">2</span>, <span class="token assign-left variable">locals</span><span class="token operator">=</span><span class="token number">3</span>, <span class="token assign-left variable">args_size</span><span class="token operator">=</span><span class="token number">1</span>
         <span class="token number">0</span>: new           <span class="token comment">#2                  // class com/nano/Math</span>
         <span class="token number">3</span>: dup
         <span class="token number">4</span>: invokespecial <span class="token comment">#3                  // Method &quot;&lt;init&gt;&quot;:()V</span>
         <span class="token number">7</span>: astore_1
         <span class="token number">8</span>: aload_1
         <span class="token number">9</span>: invokevirtual <span class="token comment">#4                  // Method compute:()I</span>
        <span class="token number">12</span>: istore_2
        <span class="token number">13</span>: <span class="token builtin class-name">return</span>
      LineNumberTable:
        line <span class="token number">20</span>: <span class="token number">0</span>
        line <span class="token number">21</span>: <span class="token number">8</span>
        line <span class="token number">22</span>: <span class="token number">13</span>
      LocalVariableTable:
        Start  Length  Slot  Name   Signature
            <span class="token number">0</span>      <span class="token number">14</span>     <span class="token number">0</span>  args   <span class="token punctuation">[</span>Ljava/lang/String<span class="token punctuation">;</span>
            <span class="token number">8</span>       <span class="token number">6</span>     <span class="token number">1</span>  math   Lcom/nano/Math<span class="token punctuation">;</span>
           <span class="token number">13</span>       <span class="token number">1</span>     <span class="token number">2</span>   res   I
<span class="token punctuation">}</span>
SourceFile: <span class="token string">&quot;Math.java&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br></div></div><p>个人理解: 一个程序的执行也就是<strong>执行的 JVM 的字节码指令</strong>, 这些指令是被<strong>存放到方法区</strong>中的, 它们都有<strong>各自的入口地址</strong>. 当一个栈上的<strong>方法需要执行</strong>时, 就需要将方法中的符号(<strong>符号引用</strong>) 对应到<strong>方法区中的入口地址(直接引用)</strong> , 这样字节码执行引擎<strong>才能获取到字节码并执行方法</strong>. 符号引用转换为直接应用的过程就是解析中的<strong>链接</strong>, 这里就有<strong>静态链接和动态链接</strong>.</p> <p><strong>常量池</strong>里面就有很多东西, 其中就有一系列的<strong>符号</strong>, 代表着<strong>类名称, 方法名称</strong>等. 对象头里面的指针找到方法区中对应方法所对应的<strong>字节码</strong>的<strong>入口地址</strong>, 并放到栈帧的<strong>动态链接</strong>部分中. 这也就是符号引用转换为 JVM 指令码地址的<strong>直接引用</strong>. 其实解析阶段的静态链接和动态链接做的事情其实都差不多, 其实也就是将方法符号引用转换为对应的<strong>字节码</strong>的<strong>入口地址</strong>(也就是<strong>直接引用</strong>) 的过程, 只是静态方法等在<strong>类加载</strong>的时候就完成了, 所以是静态链接, 而普通方法是在<strong>运行的时候完成</strong>, 所以是动态链接. 如果是运行时再去寻找<strong>符号引用</strong>所对应的 <strong>JVM 字节码的入口地址</strong>, 那就比较灵活了, 就可以得到<strong>不同</strong>的入口地址, 进而实现<strong>多态</strong>.</p> <p>‍</p> <h4 id="本章小结"><a href="#本章小结" class="header-anchor">#</a> 本章小结</h4> <p>到此为止, 已经明白了虚拟机里面的内存是如何划分的, 哪部分区域, 什么样的代码和操作可能导致内存溢出异常. 虽然 Java 有垃圾收集机制, 但内存溢出异常并不遥远, 本章只是讲解了各个区域出现内存溢出异常的原因, 下一章将详细讲解 Java 垃圾收集机制为了避免出现内存溢出异常都做了哪些努力.</p> <p>‍</p> <p>‍</p> <h4 id="参考资料"><a href="#参考资料" class="header-anchor">#</a> 参考资料</h4> <ul><li>《深入理解 Java 虚拟机: JVM 高级特性与最佳实践(第二版》</li> <li>《实战 java 虚拟机》</li> <li><a href="https://docs.oracle.com/javase/specs/index.html" target="_blank" rel="noopener noreferrer">https://docs.oracle.com/javase/specs/index.html<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="http://www.pointsoftware.ch/en/under-the-hood-runtime-data-areas-javas-memory-model/" target="_blank" rel="noopener noreferrer">http://www.pointsoftware.ch/en/under-the-hood-runtime-data-areas-javas-memory-model/<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://dzone.com/articles/jvm-permgen-%E2%80%93-where-art-thou" target="_blank" rel="noopener noreferrer">https://dzone.com/articles/jvm-permgen-%E2%80%93-where-art-thou<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://stackoverflow.com/questions/9095748/method-area-and-permgen" target="_blank" rel="noopener noreferrer">https://stackoverflow.com/questions/9095748/method-area-and-permgen<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li>深入解析String#intern<a href="https://tech.meituan.com/2014/03/06/in-depth-understanding-string-intern.html" target="_blank" rel="noopener noreferrer">https://tech.meituan.com/2014/03/06/in-depth-understanding-string-intern.html<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://blog.csdn.net/wangbiao007/article/details/78545189" target="_blank" rel="noopener noreferrer">https://blog.csdn.net/wangbiao007/article/details/78545189<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div>  <div class="page-edit"><div class="edit-link"><a href="https://github.com/xugaoyi/vuepress-theme-vdoing/edit/main/docs/20.开发/2000.Java/600.JVM/20.JVM内存区域与对象解析🌼.md" target="_blank" rel="noopener noreferrer">编辑</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <!----> <!----></div> <div class="page-nav-wapper"><div class="page-nav-centre-wrap"><a href="/pages/d308f6/" class="page-nav-centre page-nav-centre-prev"><div class="tooltip">走进JVM🌼</div></a> <a href="/pages/48d1be/" class="page-nav-centre page-nav-centre-next"><div class="tooltip">垃圾收集器与内存分配策略🌼</div></a></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/pages/d308f6/" class="prev">走进JVM🌼</a></span> <span class="next"><a href="/pages/48d1be/">垃圾收集器与内存分配策略🌼</a>→
      </span></p></div></div></div> <!----></main></div> <div class="footer"><div class="icons"><a href="mailto:1174520425@qq.com" title="发邮件" target="_blank" class="iconfont icon-youjian"></a><a href="https://github.com/nanodaemony" title="GitHub" target="_blank" class="iconfont icon-github"></a></div> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="本站主题">Vdoing</a> 
    | Copyright © 2019-2025
    <span>达尔文的猹 | MIT License</span></div> <div class="buttons"><div title="返回顶部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去评论" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主题模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          跟随系统
        </li><li class="iconfont icon-rijianmoshi">
          浅色模式
        </li><li class="iconfont icon-yejianmoshi">
          深色模式
        </li><li class="iconfont icon-yuedu">
          阅读模式
        </li></ul></div></div> <!----> <!----> <!----></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.3f3e0e10.js" defer></script><script src="/assets/js/2.e9fcb30c.js" defer></script><script src="/assets/js/3.1998f389.js" defer></script><script src="/assets/js/78.54d84cd4.js" defer></script>
  </body>
</html>
