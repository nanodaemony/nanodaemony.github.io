<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>JVM性能监控与故障处理工具🌼 | Pangolin Note</title>
    <meta name="generator" content="VuePress 1.9.5">
    <link rel="icon" href="/img/favicon.ico">
    <meta name="description" content="大道至简">
    <meta name="keywords" content="前端博客,个人技术博客,前端,前端开发,前端框架,web前端,前端面试题,技术文档,学习,面试,JavaScript,js,ES6,TypeScript,vue,python,css3,html5,Node,git,github,markdown">
    <meta name="baidu-site-verification" content="7F55weZDDc">
    <meta name="theme-color" content="#11a8cd">
    
    <link rel="preload" href="/assets/css/0.styles.56073ad3.css" as="style"><link rel="preload" href="/assets/js/app.3f3e0e10.js" as="script"><link rel="preload" href="/assets/js/2.e9fcb30c.js" as="script"><link rel="preload" href="/assets/js/3.1998f389.js" as="script"><link rel="preload" href="/assets/js/80.d5b24fea.js" as="script"><link rel="prefetch" href="/assets/js/10.0b55747f.js"><link rel="prefetch" href="/assets/js/100.b8912a99.js"><link rel="prefetch" href="/assets/js/101.a6740c8a.js"><link rel="prefetch" href="/assets/js/102.e31e89b2.js"><link rel="prefetch" href="/assets/js/103.2c5dbdae.js"><link rel="prefetch" href="/assets/js/104.0e9c02f6.js"><link rel="prefetch" href="/assets/js/105.8288396c.js"><link rel="prefetch" href="/assets/js/106.62f43c11.js"><link rel="prefetch" href="/assets/js/107.70c90211.js"><link rel="prefetch" href="/assets/js/108.b488ce56.js"><link rel="prefetch" href="/assets/js/109.12942650.js"><link rel="prefetch" href="/assets/js/11.ac3fd1ca.js"><link rel="prefetch" href="/assets/js/110.1e57ecba.js"><link rel="prefetch" href="/assets/js/111.6e33b4ea.js"><link rel="prefetch" href="/assets/js/112.bd52831b.js"><link rel="prefetch" href="/assets/js/113.868c1ac9.js"><link rel="prefetch" href="/assets/js/114.090549d1.js"><link rel="prefetch" href="/assets/js/115.d97f6c2b.js"><link rel="prefetch" href="/assets/js/116.097c4b4e.js"><link rel="prefetch" href="/assets/js/117.4024cfe2.js"><link rel="prefetch" href="/assets/js/118.e3057cba.js"><link rel="prefetch" href="/assets/js/119.4ef1fa3b.js"><link rel="prefetch" href="/assets/js/12.863eaabe.js"><link rel="prefetch" href="/assets/js/120.78f9df50.js"><link rel="prefetch" href="/assets/js/121.8e16df87.js"><link rel="prefetch" href="/assets/js/122.f21c0107.js"><link rel="prefetch" href="/assets/js/123.ea1cb375.js"><link rel="prefetch" href="/assets/js/124.01c04c6e.js"><link rel="prefetch" href="/assets/js/125.d383e301.js"><link rel="prefetch" href="/assets/js/126.3162cb47.js"><link rel="prefetch" href="/assets/js/127.c6bebae6.js"><link rel="prefetch" href="/assets/js/128.d659db60.js"><link rel="prefetch" href="/assets/js/129.2afdcf48.js"><link rel="prefetch" href="/assets/js/13.4f59ce35.js"><link rel="prefetch" href="/assets/js/130.beb9ed9d.js"><link rel="prefetch" href="/assets/js/131.35b05f8a.js"><link rel="prefetch" href="/assets/js/132.d77f4f93.js"><link rel="prefetch" href="/assets/js/133.4ceda6e5.js"><link rel="prefetch" href="/assets/js/134.11390c5f.js"><link rel="prefetch" href="/assets/js/135.32f9e38f.js"><link rel="prefetch" href="/assets/js/136.6d8bb0f2.js"><link rel="prefetch" href="/assets/js/137.9c0ffeef.js"><link rel="prefetch" href="/assets/js/138.88d86e5f.js"><link rel="prefetch" href="/assets/js/139.8c2c3d6c.js"><link rel="prefetch" href="/assets/js/14.11c82d35.js"><link rel="prefetch" href="/assets/js/140.c5c375d3.js"><link rel="prefetch" href="/assets/js/141.d703f30b.js"><link rel="prefetch" href="/assets/js/142.6a005a44.js"><link rel="prefetch" href="/assets/js/143.9b2edf6f.js"><link rel="prefetch" href="/assets/js/144.3fd013c9.js"><link rel="prefetch" href="/assets/js/145.b05079c5.js"><link rel="prefetch" href="/assets/js/146.ed5360a6.js"><link rel="prefetch" href="/assets/js/147.7408d86f.js"><link rel="prefetch" href="/assets/js/148.f390b370.js"><link rel="prefetch" href="/assets/js/149.95017f0a.js"><link rel="prefetch" href="/assets/js/15.bd143bd5.js"><link rel="prefetch" href="/assets/js/150.f0ede764.js"><link rel="prefetch" href="/assets/js/151.b7093623.js"><link rel="prefetch" href="/assets/js/152.a82a6c83.js"><link rel="prefetch" href="/assets/js/153.965e3fb2.js"><link rel="prefetch" href="/assets/js/154.9e49311e.js"><link rel="prefetch" href="/assets/js/155.cef33ba5.js"><link rel="prefetch" href="/assets/js/156.bcc397ae.js"><link rel="prefetch" href="/assets/js/157.90824739.js"><link rel="prefetch" href="/assets/js/158.efd429b9.js"><link rel="prefetch" href="/assets/js/159.122ff5b7.js"><link rel="prefetch" href="/assets/js/16.2449162b.js"><link rel="prefetch" href="/assets/js/160.0b806535.js"><link rel="prefetch" href="/assets/js/161.835052c6.js"><link rel="prefetch" href="/assets/js/162.ca34e2d2.js"><link rel="prefetch" href="/assets/js/163.08000d04.js"><link rel="prefetch" href="/assets/js/164.a1cc0109.js"><link rel="prefetch" href="/assets/js/165.65444686.js"><link rel="prefetch" href="/assets/js/166.7d73c84f.js"><link rel="prefetch" href="/assets/js/167.009d47a3.js"><link rel="prefetch" href="/assets/js/168.0afeae2a.js"><link rel="prefetch" href="/assets/js/169.7654cb31.js"><link rel="prefetch" href="/assets/js/17.eb7f9def.js"><link rel="prefetch" href="/assets/js/170.58569530.js"><link rel="prefetch" href="/assets/js/171.7db9ed40.js"><link rel="prefetch" href="/assets/js/172.3cb50ed4.js"><link rel="prefetch" href="/assets/js/173.0846425f.js"><link rel="prefetch" href="/assets/js/174.9e95f111.js"><link rel="prefetch" href="/assets/js/175.ef2098f2.js"><link rel="prefetch" href="/assets/js/176.c2635fe9.js"><link rel="prefetch" href="/assets/js/177.4fa38e8e.js"><link rel="prefetch" href="/assets/js/178.2be7037f.js"><link rel="prefetch" href="/assets/js/179.bf3bba28.js"><link rel="prefetch" href="/assets/js/18.0455f4d1.js"><link rel="prefetch" href="/assets/js/180.72c5f597.js"><link rel="prefetch" href="/assets/js/181.42287bcc.js"><link rel="prefetch" href="/assets/js/182.6cd4bf1a.js"><link rel="prefetch" href="/assets/js/183.05dbbfd9.js"><link rel="prefetch" href="/assets/js/184.03de7e00.js"><link rel="prefetch" href="/assets/js/185.42dd210e.js"><link rel="prefetch" href="/assets/js/186.28ee0f8a.js"><link rel="prefetch" href="/assets/js/187.bb58697b.js"><link rel="prefetch" href="/assets/js/188.1bc8be96.js"><link rel="prefetch" href="/assets/js/189.fac747e3.js"><link rel="prefetch" href="/assets/js/19.ae9e35d6.js"><link rel="prefetch" href="/assets/js/190.ea533ac7.js"><link rel="prefetch" href="/assets/js/191.6dc6eb13.js"><link rel="prefetch" href="/assets/js/192.184d249f.js"><link rel="prefetch" href="/assets/js/193.4a06bc12.js"><link rel="prefetch" href="/assets/js/194.8cce60a9.js"><link rel="prefetch" href="/assets/js/195.93231a13.js"><link rel="prefetch" href="/assets/js/196.4a596bde.js"><link rel="prefetch" href="/assets/js/197.96c113cf.js"><link rel="prefetch" href="/assets/js/198.73ba3f67.js"><link rel="prefetch" href="/assets/js/199.74bab595.js"><link rel="prefetch" href="/assets/js/20.b542d0e7.js"><link rel="prefetch" href="/assets/js/200.69a6928a.js"><link rel="prefetch" href="/assets/js/201.9ffa7c5a.js"><link rel="prefetch" href="/assets/js/202.41edb652.js"><link rel="prefetch" href="/assets/js/203.7fabcef3.js"><link rel="prefetch" href="/assets/js/204.b0ae2f62.js"><link rel="prefetch" href="/assets/js/205.add8738b.js"><link rel="prefetch" href="/assets/js/206.f3a712ec.js"><link rel="prefetch" href="/assets/js/207.cd7dd729.js"><link rel="prefetch" href="/assets/js/208.78b33afa.js"><link rel="prefetch" href="/assets/js/209.9d3329ff.js"><link rel="prefetch" href="/assets/js/21.5a050318.js"><link rel="prefetch" href="/assets/js/210.d285d5ac.js"><link rel="prefetch" href="/assets/js/211.8791bb3f.js"><link rel="prefetch" href="/assets/js/212.84ed81a8.js"><link rel="prefetch" href="/assets/js/213.7b990580.js"><link rel="prefetch" href="/assets/js/214.da31f20c.js"><link rel="prefetch" href="/assets/js/215.9eeed659.js"><link rel="prefetch" href="/assets/js/216.9539f0ec.js"><link rel="prefetch" href="/assets/js/217.11b575be.js"><link rel="prefetch" href="/assets/js/218.a67f12f1.js"><link rel="prefetch" href="/assets/js/219.bfbb817a.js"><link rel="prefetch" href="/assets/js/22.2bc6f7e3.js"><link rel="prefetch" href="/assets/js/220.8b01342f.js"><link rel="prefetch" href="/assets/js/221.b450decd.js"><link rel="prefetch" href="/assets/js/222.97468507.js"><link rel="prefetch" href="/assets/js/223.b6dafd73.js"><link rel="prefetch" href="/assets/js/224.c86c18c6.js"><link rel="prefetch" href="/assets/js/225.b0dcf86e.js"><link rel="prefetch" href="/assets/js/226.02cc2999.js"><link rel="prefetch" href="/assets/js/227.8474ef5a.js"><link rel="prefetch" href="/assets/js/228.0298e421.js"><link rel="prefetch" href="/assets/js/229.6aeaf595.js"><link rel="prefetch" href="/assets/js/23.9995fce4.js"><link rel="prefetch" href="/assets/js/230.a5785286.js"><link rel="prefetch" href="/assets/js/231.d791daa4.js"><link rel="prefetch" href="/assets/js/232.97aeeb00.js"><link rel="prefetch" href="/assets/js/233.46e51e28.js"><link rel="prefetch" href="/assets/js/234.2cffe82f.js"><link rel="prefetch" href="/assets/js/235.14965da6.js"><link rel="prefetch" href="/assets/js/236.00a5afc0.js"><link rel="prefetch" href="/assets/js/237.3b73d52f.js"><link rel="prefetch" href="/assets/js/238.6e1db765.js"><link rel="prefetch" href="/assets/js/239.75866c5e.js"><link rel="prefetch" href="/assets/js/24.9141eeb2.js"><link rel="prefetch" href="/assets/js/240.af9c2cc9.js"><link rel="prefetch" href="/assets/js/241.388acab2.js"><link rel="prefetch" href="/assets/js/242.c60f2b48.js"><link rel="prefetch" href="/assets/js/243.d8e81b13.js"><link rel="prefetch" href="/assets/js/244.58b0b21d.js"><link rel="prefetch" href="/assets/js/245.c3768497.js"><link rel="prefetch" href="/assets/js/246.ac8bbe7a.js"><link rel="prefetch" href="/assets/js/247.d095f70a.js"><link rel="prefetch" href="/assets/js/248.e9f210b5.js"><link rel="prefetch" href="/assets/js/249.a9fad023.js"><link rel="prefetch" href="/assets/js/25.98e8593e.js"><link rel="prefetch" href="/assets/js/250.ae7f0ebb.js"><link rel="prefetch" href="/assets/js/251.9a617d55.js"><link rel="prefetch" href="/assets/js/252.ce082446.js"><link rel="prefetch" href="/assets/js/253.4575302d.js"><link rel="prefetch" href="/assets/js/254.5899a61b.js"><link rel="prefetch" href="/assets/js/255.66c69f31.js"><link rel="prefetch" href="/assets/js/256.8fd6c706.js"><link rel="prefetch" href="/assets/js/257.31b77e5e.js"><link rel="prefetch" href="/assets/js/258.eba48891.js"><link rel="prefetch" href="/assets/js/259.edf74b59.js"><link rel="prefetch" href="/assets/js/26.e69924ea.js"><link rel="prefetch" href="/assets/js/260.cf2ed36d.js"><link rel="prefetch" href="/assets/js/261.9e7792d8.js"><link rel="prefetch" href="/assets/js/262.e7b9433e.js"><link rel="prefetch" href="/assets/js/263.1185b25c.js"><link rel="prefetch" href="/assets/js/264.5e0f89cb.js"><link rel="prefetch" href="/assets/js/265.a38d3b94.js"><link rel="prefetch" href="/assets/js/266.2ef170b3.js"><link rel="prefetch" href="/assets/js/267.a7d14651.js"><link rel="prefetch" href="/assets/js/268.05b18748.js"><link rel="prefetch" href="/assets/js/269.dad48d6f.js"><link rel="prefetch" href="/assets/js/27.13612515.js"><link rel="prefetch" href="/assets/js/270.4f5a6b8d.js"><link rel="prefetch" href="/assets/js/271.7ebf6682.js"><link rel="prefetch" href="/assets/js/272.7c2fbfd1.js"><link rel="prefetch" href="/assets/js/273.8ee20732.js"><link rel="prefetch" href="/assets/js/274.d525242a.js"><link rel="prefetch" href="/assets/js/275.a8a19acb.js"><link rel="prefetch" href="/assets/js/276.df3a4eb4.js"><link rel="prefetch" href="/assets/js/277.336debda.js"><link rel="prefetch" href="/assets/js/278.c470625f.js"><link rel="prefetch" href="/assets/js/279.a91e1a64.js"><link rel="prefetch" href="/assets/js/28.ab7ae1df.js"><link rel="prefetch" href="/assets/js/280.87e25c9a.js"><link rel="prefetch" href="/assets/js/281.87c1ba25.js"><link rel="prefetch" href="/assets/js/282.dcd4dce0.js"><link rel="prefetch" href="/assets/js/283.abac2e00.js"><link rel="prefetch" href="/assets/js/284.f6079659.js"><link rel="prefetch" href="/assets/js/285.f1b39879.js"><link rel="prefetch" href="/assets/js/286.f6a79242.js"><link rel="prefetch" href="/assets/js/287.06bebe07.js"><link rel="prefetch" href="/assets/js/288.89e325df.js"><link rel="prefetch" href="/assets/js/289.3aa1bedd.js"><link rel="prefetch" href="/assets/js/29.ebe50f76.js"><link rel="prefetch" href="/assets/js/290.ee059c92.js"><link rel="prefetch" href="/assets/js/291.fa9a921a.js"><link rel="prefetch" href="/assets/js/292.2a8811cd.js"><link rel="prefetch" href="/assets/js/293.eec09cdf.js"><link rel="prefetch" href="/assets/js/294.dfac20dc.js"><link rel="prefetch" href="/assets/js/295.825d2070.js"><link rel="prefetch" href="/assets/js/296.f645861e.js"><link rel="prefetch" href="/assets/js/297.424fdb17.js"><link rel="prefetch" href="/assets/js/298.ebf87cdc.js"><link rel="prefetch" href="/assets/js/299.b8f19cbb.js"><link rel="prefetch" href="/assets/js/30.75237511.js"><link rel="prefetch" href="/assets/js/300.10fb6d4f.js"><link rel="prefetch" href="/assets/js/301.ef77c612.js"><link rel="prefetch" href="/assets/js/302.1b839763.js"><link rel="prefetch" href="/assets/js/303.609f7d98.js"><link rel="prefetch" href="/assets/js/304.1d255f19.js"><link rel="prefetch" href="/assets/js/305.b0234f2c.js"><link rel="prefetch" href="/assets/js/306.48677f64.js"><link rel="prefetch" href="/assets/js/307.14390d4b.js"><link rel="prefetch" href="/assets/js/308.fa730b28.js"><link rel="prefetch" href="/assets/js/309.0496b9e0.js"><link rel="prefetch" href="/assets/js/31.cf3f471a.js"><link rel="prefetch" href="/assets/js/310.a31676dc.js"><link rel="prefetch" href="/assets/js/311.ed53adc5.js"><link rel="prefetch" href="/assets/js/312.1b0ff2f1.js"><link rel="prefetch" href="/assets/js/313.bf123f32.js"><link rel="prefetch" href="/assets/js/314.4e6ce06b.js"><link rel="prefetch" href="/assets/js/315.8eb18560.js"><link rel="prefetch" href="/assets/js/32.74fef842.js"><link rel="prefetch" href="/assets/js/33.bc2d190b.js"><link rel="prefetch" href="/assets/js/34.d23438fc.js"><link rel="prefetch" href="/assets/js/35.7675c4d0.js"><link rel="prefetch" href="/assets/js/36.96a4161b.js"><link rel="prefetch" href="/assets/js/37.d1824f2f.js"><link rel="prefetch" href="/assets/js/38.4effff9e.js"><link rel="prefetch" href="/assets/js/39.6509914b.js"><link rel="prefetch" href="/assets/js/4.4d01750f.js"><link rel="prefetch" href="/assets/js/40.1509d08b.js"><link rel="prefetch" href="/assets/js/41.f2c1124f.js"><link rel="prefetch" href="/assets/js/42.e541d077.js"><link rel="prefetch" href="/assets/js/43.369de999.js"><link rel="prefetch" href="/assets/js/44.43959db0.js"><link rel="prefetch" href="/assets/js/45.282fbd31.js"><link rel="prefetch" href="/assets/js/46.1b83cfe9.js"><link rel="prefetch" href="/assets/js/47.c3a88e41.js"><link rel="prefetch" href="/assets/js/48.bc7c0a1b.js"><link rel="prefetch" href="/assets/js/49.92a4e5ba.js"><link rel="prefetch" href="/assets/js/5.c3991e24.js"><link rel="prefetch" href="/assets/js/50.9c488c6c.js"><link rel="prefetch" href="/assets/js/51.546ea632.js"><link rel="prefetch" href="/assets/js/52.0d2ccee1.js"><link rel="prefetch" href="/assets/js/53.6f52b5b1.js"><link rel="prefetch" href="/assets/js/54.c838b295.js"><link rel="prefetch" href="/assets/js/55.13af99ee.js"><link rel="prefetch" href="/assets/js/56.6be6d1ed.js"><link rel="prefetch" href="/assets/js/57.67c98b39.js"><link rel="prefetch" href="/assets/js/58.107e82ec.js"><link rel="prefetch" href="/assets/js/59.b3e5edc7.js"><link rel="prefetch" href="/assets/js/6.36a535f9.js"><link rel="prefetch" href="/assets/js/60.3b0b4ba5.js"><link rel="prefetch" href="/assets/js/61.3df843df.js"><link rel="prefetch" href="/assets/js/62.1213823d.js"><link rel="prefetch" href="/assets/js/63.e8f3f926.js"><link rel="prefetch" href="/assets/js/64.e1219050.js"><link rel="prefetch" href="/assets/js/65.5bf5bb0b.js"><link rel="prefetch" href="/assets/js/66.a2502afb.js"><link rel="prefetch" href="/assets/js/67.690dd59b.js"><link rel="prefetch" href="/assets/js/68.de7b0915.js"><link rel="prefetch" href="/assets/js/69.ac61dd61.js"><link rel="prefetch" href="/assets/js/7.5d254238.js"><link rel="prefetch" href="/assets/js/70.3edd41b1.js"><link rel="prefetch" href="/assets/js/71.d23407e9.js"><link rel="prefetch" href="/assets/js/72.a5bd01bc.js"><link rel="prefetch" href="/assets/js/73.c9f4dd57.js"><link rel="prefetch" href="/assets/js/74.66323fc1.js"><link rel="prefetch" href="/assets/js/75.e1a72e00.js"><link rel="prefetch" href="/assets/js/76.801268b4.js"><link rel="prefetch" href="/assets/js/77.3a5fda67.js"><link rel="prefetch" href="/assets/js/78.54d84cd4.js"><link rel="prefetch" href="/assets/js/79.fa10f4e3.js"><link rel="prefetch" href="/assets/js/8.e060e47d.js"><link rel="prefetch" href="/assets/js/81.0e9da714.js"><link rel="prefetch" href="/assets/js/82.e96ff6d7.js"><link rel="prefetch" href="/assets/js/83.771cced1.js"><link rel="prefetch" href="/assets/js/84.220b69e7.js"><link rel="prefetch" href="/assets/js/85.7dcc5659.js"><link rel="prefetch" href="/assets/js/86.44ba2100.js"><link rel="prefetch" href="/assets/js/87.281da75d.js"><link rel="prefetch" href="/assets/js/88.12d88449.js"><link rel="prefetch" href="/assets/js/89.f28c86d3.js"><link rel="prefetch" href="/assets/js/9.8f9fef32.js"><link rel="prefetch" href="/assets/js/90.715cabb2.js"><link rel="prefetch" href="/assets/js/91.6ced7c82.js"><link rel="prefetch" href="/assets/js/92.c05b33ca.js"><link rel="prefetch" href="/assets/js/93.6bf5fb66.js"><link rel="prefetch" href="/assets/js/94.3561200e.js"><link rel="prefetch" href="/assets/js/95.0f2cf716.js"><link rel="prefetch" href="/assets/js/96.ac8487ea.js"><link rel="prefetch" href="/assets/js/97.48042b5a.js"><link rel="prefetch" href="/assets/js/98.441bb7f8.js"><link rel="prefetch" href="/assets/js/99.4b214d92.js">
    <link rel="stylesheet" href="/assets/css/0.styles.56073ad3.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu"><header class="navbar blur"><div title="目录" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/img/magic.png" alt="Pangolin Note" class="logo"> <span class="site-name can-hide">Pangolin Note</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">🏡首页</a></div><div class="nav-item"><a href="/basic/" class="nav-link">基础</a></div><div class="nav-item"><a href="/develop/" class="nav-link">开发</a></div><div class="nav-item"><a href="/middleware/" class="nav-link">系统</a></div><div class="nav-item"><a href="/algorithm/" class="nav-link">算法</a></div><div class="nav-item"><a href="/books/" class="nav-link">🍀读书笔记</a></div><div class="nav-item"><a href="/work/" class="nav-link">工作</a></div><div class="nav-item"><a href="/pangolin/" class="nav-link">🌸达尔文的猹</a></div><div class="nav-item"><a href="/pages/beb6c0bd8a66cea6/" class="nav-link">收藏</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/archives/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">归档</a></li></ul></div></div> <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><div class="blogger"><img src="/img/avatarnew.png"> <div class="blogger-info"><h3>达尔文的猹</h3> <span>大道至简 悟在天成</span></div></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">🏡首页</a></div><div class="nav-item"><a href="/basic/" class="nav-link">基础</a></div><div class="nav-item"><a href="/develop/" class="nav-link">开发</a></div><div class="nav-item"><a href="/middleware/" class="nav-link">系统</a></div><div class="nav-item"><a href="/algorithm/" class="nav-link">算法</a></div><div class="nav-item"><a href="/books/" class="nav-link">🍀读书笔记</a></div><div class="nav-item"><a href="/work/" class="nav-link">工作</a></div><div class="nav-item"><a href="/pangolin/" class="nav-link">🌸达尔文的猹</a></div><div class="nav-item"><a href="/pages/beb6c0bd8a66cea6/" class="nav-link">收藏</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/archives/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">归档</a></li></ul></div></div> <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Java</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading"><span>基础</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/4f30b9/" class="sidebar-link">Java基础</a></li><li><a href="/pages/795eca/" class="sidebar-link">类与继承</a></li><li><a href="/pages/c69152/" class="sidebar-link">抽象类与接口</a></li><li><a href="/pages/d71abb/" class="sidebar-link">内部类</a></li><li><a href="/pages/f06dca/" class="sidebar-link">枚举类</a></li><li><a href="/pages/259f57/" class="sidebar-link">常用类</a></li><li><a href="/pages/84b03b/" class="sidebar-link">关键字</a></li><li><a href="/pages/31b87b/" class="sidebar-link">注解</a></li><li><a href="/pages/f81c0d/" class="sidebar-link">异常</a></li><li><a href="/pages/ae7746/" class="sidebar-link">泛型</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading"><span>容器类</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/0c88ac/" class="sidebar-link">集合容器类基础</a></li><li><a href="/pages/f805ed/" class="sidebar-link">List与Queue类</a></li><li><a href="/pages/d24b60/" class="sidebar-link">Map与Set类</a></li><li><a href="/pages/54e5d3/" class="sidebar-link">并发容器类</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading"><span>并发</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/67d70f/" class="sidebar-link">多线程基础</a></li><li><a href="/pages/ffc8f7/" class="sidebar-link">Java内置锁</a></li><li><a href="/pages/c43494/" class="sidebar-link">AQS</a></li><li><a href="/pages/eb5b61/" class="sidebar-link">显式锁ReentrantLock</a></li><li><a href="/pages/eb8cbc/" class="sidebar-link">线程协作与JUC组件</a></li><li><a href="/pages/23c79a/" class="sidebar-link">Atomic原子变量与Unsafe类与CAS</a></li><li><a href="/pages/9d6ed4/" class="sidebar-link">线程池与定时任务</a></li><li><a href="/pages/5b787a/" class="sidebar-link">ThreadLocal</a></li><li><a href="/pages/db53d1/" class="sidebar-link">Java并发编程实战(极客时间)🌸</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading"><span>IO</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/b4d461/" class="sidebar-link">文件操作</a></li><li><a href="/pages/1b9d6c/" class="sidebar-link">IO流操作</a></li><li><a href="/pages/076a47/" class="sidebar-link">Java网络IO模型</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading"><span>高级特性</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/d76905/" class="sidebar-link">Lambda表达式</a></li><li><a href="/pages/f7f0e6/" class="sidebar-link">流Stream</a></li><li><a href="/pages/7cc40a/" class="sidebar-link">反射</a></li><li><a href="/pages/945326/" class="sidebar-link">代理</a></li><li><a href="/pages/7fd9b4/" class="sidebar-link">Javaagent</a></li><li><a href="/pages/a3cee0/" class="sidebar-link">Guava</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading open"><span>JVM</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/d308f6/" class="sidebar-link">走进JVM🌼</a></li><li><a href="/pages/be0269/" class="sidebar-link">JVM内存区域与对象解析🌼</a></li><li><a href="/pages/48d1be/" class="sidebar-link">垃圾收集器与内存分配策略🌼</a></li><li><a href="/pages/3a4c8a/" aria-current="page" class="active sidebar-link">JVM性能监控与故障处理工具🌼</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/pages/106680/" class="sidebar-link">调优案例分析与实战🌼</a></li><li><a href="/pages/16a914/" class="sidebar-link">类文件结构🌼</a></li><li><a href="/pages/ea287c/" class="sidebar-link">虚拟机类加载机制🌼</a></li><li><a href="/pages/6367b0/" class="sidebar-link">虚拟机字节码执行引擎🌼</a></li><li><a href="/pages/c6c210/" class="sidebar-link">类加载及执行子系统的案例与实战🌼</a></li><li><a href="/pages/deb8b7/" class="sidebar-link">前端编译与优化🌼</a></li><li><a href="/pages/1f8f72/" class="sidebar-link">后端编译与优化🌼</a></li><li><a href="/pages/3d72db/" class="sidebar-link">Java内存模型与线程实现🌼</a></li><li><a href="/pages/ed086e/" class="sidebar-link">线程安全与内置锁优化🌼</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading"><span>其他</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/56b9dd/" class="sidebar-link">Java性能问题定位分析</a></li><li><a href="/pages/939bf8/" class="sidebar-link">杂记</a></li></ul></section></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>开发</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading open"><span>软件设计</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/a5f6fe/" class="sidebar-link">设计基础理论</a></li><li><a href="/pages/3b245c/" class="sidebar-link">设计模式之美(极客时间)🌟</a></li><li><a href="/pages/661fa4/" class="sidebar-link">领域驱动设计(DDD)</a></li><li><a href="/pages/856368/" class="sidebar-link">DDD实战课(极客时间)🌸</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading"><span>数据库</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/d3fbd2/" class="sidebar-link">数据库基础</a></li><li><a href="/pages/691fc3/" class="sidebar-link">数据库系统原理</a></li><li><a href="/pages/50f6b7/" class="sidebar-link">MySQL基础必知必会</a></li><li><a href="/pages/fe297e/" class="sidebar-link">MySQL特性</a></li><li><a href="/pages/07bdb6/" class="sidebar-link">MySQL索引🌟</a></li><li><a href="/pages/984715/" class="sidebar-link">MySQL锁🌟</a></li><li><a href="/pages/53b588/" class="sidebar-link">MySQL事务🌟</a></li><li><a href="/pages/becc59/" class="sidebar-link">MySQL高级特性</a></li><li><a href="/pages/056463/" class="sidebar-link">MySQL基础架构与存储引擎🌟</a></li><li><a href="/pages/63b46e/" class="sidebar-link">MySQL架构优化与运维</a></li><li><a href="/pages/9995e5/" class="sidebar-link">MySQL优化</a></li><li><a href="/pages/c1c2f6/" class="sidebar-link">MySQL架构</a></li><li><a href="/pages/8e8e0a/" class="sidebar-link">MySQL设计规范</a></li><li><a href="/pages/0219aa/" class="sidebar-link">MySQL运维</a></li><li><a href="/pages/e288c0/" class="sidebar-link">MySQL中间件</a></li><li><a href="/pages/c6cafa/" class="sidebar-link">MySQL实战45讲(极客时间)🌟</a></li><li><a href="/pages/4a6106/" class="sidebar-link">数据库LeetCode题目</a></li><li><a href="/pages/2827f1/" class="sidebar-link">数据库综合问题</a></li><li><a href="/pages/c616d5/" class="sidebar-link">MongoDB</a></li><li><a href="/pages/075e71/" class="sidebar-link">ClickHouse</a></li><li><a href="/pages/d74f6d/" class="sidebar-link">Doris</a></li><li><a href="/pages/b6bad9/" class="sidebar-link">HBase</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading"><span>Spring</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/bd8eb8/" class="sidebar-link">Spring Boot基础</a></li><li><a href="/pages/d0d797/" class="sidebar-link">Spring Boot应用整合</a></li><li><a href="/pages/314cdc/" class="sidebar-link">Spring MVC基础</a></li><li><a href="/pages/80de47/" class="sidebar-link">Spring AOP基础</a></li><li><a href="/pages/f0d4d6/" class="sidebar-link">Spring事务基础</a></li><li><a href="/pages/db6afe/" class="sidebar-link">Spring IOC源码分析-概览</a></li><li><a href="/pages/672e98/" class="sidebar-link">Spring IOC源码分析-getBean()</a></li><li><a href="/pages/695b90/" class="sidebar-link">Spring IOC源码分析-createBean()</a></li><li><a href="/pages/f89bcf/" class="sidebar-link">Spring AOP源码分析</a></li><li><a href="/pages/3b52f4/" class="sidebar-link">Spring事务源码分析</a></li><li><a href="/pages/186902/" class="sidebar-link">Spring Boot源码分析</a></li><li><a href="/pages/16bd1c/" class="sidebar-link">Spring MVC源码分析</a></li><li><a href="/pages/3d0c1f/" class="sidebar-link">Spring Cloud</a></li><li><a href="/pages/d56156/" class="sidebar-link">Spring编程常见错误50例(极客时间)🌸</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading"><span>MyBatis</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/bb032d/" class="sidebar-link">基础</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading"><span>工具与环境</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/c9cb6e/" class="sidebar-link">Arthas</a></li><li><a href="/pages/3172bb/" class="sidebar-link">Maven</a></li><li><a href="/pages/37f79a/" class="sidebar-link">Git</a></li><li><a href="/pages/db9f99/" class="sidebar-link">环境搭建与部署</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading"><span>测试</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/c725f5/" class="sidebar-link">测试基础</a></li><li><a href="/pages/7893a4/" class="sidebar-link">单元测试</a></li><li><a href="/pages/af9f25/" class="sidebar-link">压力测试</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading"><span>代码质量</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/ec2b81/" class="sidebar-link">代码整洁之道</a></li><li><a href="/pages/474cdf/" class="sidebar-link">阿里巴巴编程规范</a></li><li><a href="/pages/c47e15/" class="sidebar-link">代码之丑(极客时间)🌸</a></li><li><a href="/pages/4d4606/" class="sidebar-link">Java业务开发常见错误100例(极客时间)🌸</a></li></ul></section></li></ul></section></li></ul> </aside> <div><main class="page"><div class="theme-vdoing-wrapper "><div class="articleInfo-wrap" data-v-06970110><div class="articleInfo" data-v-06970110><ul class="breadcrumbs" data-v-06970110><li data-v-06970110><a href="/" title="首页" class="iconfont icon-home router-link-active" data-v-06970110></a></li> <li data-v-06970110><a href="/develop/#开发" data-v-06970110>开发</a></li><li data-v-06970110><a href="/develop/#Java" data-v-06970110>Java</a></li><li data-v-06970110><a href="/develop/#JVM" data-v-06970110>JVM</a></li></ul> <div class="info" data-v-06970110><div title="作者" class="author iconfont icon-touxiang" data-v-06970110><a href="https://github.com/nanodaemony" target="_blank" title="作者" class="beLink" data-v-06970110>NanoDaemony</a></div> <div title="创建时间" class="date iconfont icon-riqi" data-v-06970110><a href="javascript:;" data-v-06970110>2025-02-26</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-title">本文目录</div> <div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABKFJREFUSA3tVl1oFVcQnrMbrak3QUgkya1akpJYcrUtIqW1JvFBE9LiQ5v6JmJpolbMg32rVrhgoYK0QiMY6i9Y6EMaW5D+xFJaTYItIuK2Kr3+BJNwkxBj05sQY3b3nM6cs2dv9t7NT/vQJw/sndk5M/PNzJkzewGerP+pAmy+ON8lLzUJgA8ZYxYIYZmGYRnctDaWvJJAmTtfP1pvXsBCCPP8QFcCaRkZYACgDZFO4stNIcBCajEOlmmC9XpJ9bAGCaPaPmzPl32dvLSVu3BWCTQs0XQQ6g0DYgwLIoAZbBCdW/i+781o1VVlm/410mw4h06Y7bIPHNyWDyL4FHkX03Q8SrzNhZTZriieckWt7cL6MM85YcLpsi/7O9/iXFT6MswI0DmmpkSaJ0qLxFIm3+i1THHB3zmBH3PYx9CcykcLOeQVVa7QtdxTgQgEleX2AjHYfwA+2ddV77ruGoJUbhGDI09YSNXyMpUt5ylOzxgbUmtOp7NmbNt8v3arjTBfYELmLUV+M+nSawNNAUqpT3ClJWg5I3BLT+cGW/DXNGCa6tx1aakCGEigArTn4TDIPdrXXYKCZNrHLMCOEPvHBlLQ99s9eHB7EB6NTki73CVPQ2F5MSx/uRQixfmq7rK0wYD8w8E905bnPDfwoWs/rfv93NWN/ZfvwsLIU7A09gxECyISeGJkHAau98L97tuw7NXnoPyNF8FcYGLGKsOs0mN3OEyec9esGW/ZEl945dTP34wlR2FZVQWU1q0Cw8Tr7p+hgLLNL0FPxx/Q35mA8aEUrH6nCgwEl0tn7wUiZYJnNRh6DK4UH/k0lfyrsBKdPVv/AriGIQcEDQZ65LBAGe2Rzui9Ybjz7XUppz1/uKBbyVPGkN3ZAeC6hr0x7Nr38N5+EqkoOm17xpoqR9ohQF55ERSvr4Dkr3chNfC3DMzGJlNBElW8w9nsGQvhNGIzDkXzCg8cLK951xHsFBlTJspJNi3ZFIMF2AeDV3q8DNOB+YHi6QTrChDIWDBRi5U5f+ZMfJLu3ccrqxtdxk4SKH336LFxSmkqefwU5T8fhdSdQf9IVKD6aNiwI/hnmcAZ91isYMJIaCUCx9W098+LgruikeTqzqqxKPUwqJyCPJiyemVVZBOijDGjD38Os0jOiSPL1z3SPjXNANbiNPXAdzTfukjjuknNBbyz3nwgTd3AVFqUJ5hpHlq9MveLnWwttUfoygBmvVjuikxND3znrhsELnZk7k+OjIGxeNEkomyLVta0xxn+HZhjBc4YZ/AFjHjz9u3xRZl2BN4aq9nFwWh16IrQ1aHHEd3j1+4/dB9OtH4e29A2H1DyHQRmOSfQZ1Fy7MHBTGB6J/Djq6p3OxyO2cB+4Car7v/o3GXgfAkj23+x9ID1Teoamo/SXcbvSf2PX7Vc8DdCmE1vN9di+32P9/5YR3vLnhCVGUWBjEkr3yh4H8v9CzmsbdhzOKzsJKM90iFdaTMjRPhGVsakRvOaRidljo6H6G7j+ctrJpsP+4COhDIl0La2+FS4+5mlocBaXY5QnGZysIBYoeSsl5qQzrSj/cgNrfuEzlWBfwA+EjrZyWUvpAAAAABJRU5ErkJggg==">JVM性能监控与故障处理工具🌼<!----></h1>  <div class="theme-vdoing-content content__default"><h1 id="_22-jvm性能监控与故障处理工具🌼"><a href="#_22-jvm性能监控与故障处理工具🌼" class="header-anchor">#</a> 22.JVM性能监控与故障处理工具🌼</h1> <p>本节是《深入理解 Java 虚拟机》的第四章</p> <h4 id="概述"><a href="#概述" class="header-anchor">#</a> 概述</h4> <p>经过前面两章对于虚拟机内存分配与回收技术各方面的介绍, 相信读者已经建立了一个比较系统, 完整的理论基础. 理论总是作为指导实践的工具, 把这些知识应用到实际工作中才是最终目的. 接下来的两章, 将从实践的角度去认识虚拟机内存管理的世界.</p> <p>给一个系统定位问题的时候, 知识, 经验是关键基础, 数据是依据, 工具是运用知识处理数据的手段. 这里说的数据包括但不限于<mark><strong>异常堆栈, 虚拟机运行日志, 垃圾收集器日志, 线程快照(threaddump/javacore 文件), 堆转储快照(heapdump/hprof 文件)</strong></mark> 等. 恰当地使用虚拟机故障处理, 分析的工具可以提升分析数据, 定位并解决问题的效率, 但在学习工具前, 也应当意识到工具永远都是知识技能的一层包装, 没有什么工具是 &quot;秘密武器&quot;, 拥有了就能 &quot;包治百病&quot;.</p> <h4 id="基础故障处理工具"><a href="#基础故障处理工具" class="header-anchor">#</a> 基础故障处理工具</h4> <h5 id="_1-基础工具总结"><a href="#_1-基础工具总结" class="header-anchor">#</a> 1.基础工具总结</h5> <p>Java 开发人员肯定都知道 JDK 的 bin 目录中有 java.exe, javac.exe 这两个命令行工具, 但并非所有程序员都了解过 JDK 的 bin 目录下其他各种小工具的作用. 随着 JDK 版本的更迭, 这些小工具的数量和功能也在不知不觉地增加与增强. 除了编译和运行 Java 程序外, <strong>打包, 部署, 签名, 调试, 监控, 运维</strong>等各种场景都可能会用到它们, 这些工具如下图所示.</p> <p><img src="/img/Image00052-20240302133505-8pjx35q.jpg" alt="" title="JDK 自带工具"></p> <p>本章将介绍这些工具中的一部分, 主要是用于监视虚拟机运行状态和进行故障处理的工具.</p> <p>这些工具程序大多数体积都异常小, 不妨看看上图中的最后一列 &quot;大小&quot;, 各个工具的体积基本上都稳定在 21KB 左右. 因为这些命令行工具<strong>大多仅是一层薄包装</strong>而已, 真正的功能代码是实现在 JDK 的工具类库中的.</p> <p>JDK 开发团队选择采用 Java 语言本身来实现这些故障处理工具是有特别用意的: 当应用程序部署到生产环境后, 无论是人工物理接触到服务器还是远程 Telnet 到服务器上都可能会受到限制. <strong>借助这些工具类库里面的接口和实现代码, 开发者可以选择直接在应用程序中提供功能强大的监控分析功能</strong>.</p> <p>本章所讲解的工具大多基于 Windows 平台下的 JDK 进行演示, 如果选用的 JDK 版本, 操作系统不同, 那么工具不仅可能数量上有所差别, 同一个工具所支持的功能范围和效果都可能会不一样. 建议使用更高版本的 JDK 来验证本章介绍的内容. 通常高版本 JDK 的工具有可能向下兼容运行于低版本 JDK 的虚拟机上的程序, 反之则一般不行.</p> <p>下面<strong>罗列了 JDK 附带的全部(包括曾经存在但已经在最新版本中被移除的)工具及其简要用途</strong>.</p> <blockquote><p>基础工具: 用于支持基本的程序创建和运行</p></blockquote> <p><img src="/img/Image00059-20240302133505-u9sj4ys.jpg" alt=""></p> <blockquote><p>安全工具: 用于程序签名, 设置安全测试等</p></blockquote> <p><img src="/img/Image00060-20240302133505-ieylij0.jpg" alt=""></p> <blockquote><p>性能监控和故障处理工具: 用于监控分析 Java 虚拟机运行信息, 排查问题</p></blockquote> <p><img src="/img/Image00066-20240302133505-nzdwkzl.jpg" alt=""></p> <p>下面挑选常用的 性能监控和故障处理工具 进行介绍.</p> <h5 id="_2-jps-虚拟机进程状况工具"><a href="#_2-jps-虚拟机进程状况工具" class="header-anchor">#</a> 2.jps:虚拟机进程状况工具</h5> <blockquote><p>工具介绍</p></blockquote> <p>JDK 的很多小工具的名字都参考了 UNIX 命令的命名方式, <mark><strong>jps</strong></mark>(JVM Process Status Tool)是其中的典型. 除了名字像 UNIX 的 ps 命令之外, 它的功能也和 ps 命令类似: <mark><strong>可以列出正在运行的虚拟机进程, 并显示虚拟机执行主类(Main Class, main() 函数所在的类)名称以及这些进程的本地虚拟机唯一 ID(LVMID, Local Virtual Machine Identifier)</strong></mark> . 虽然功能比较单一, 但它绝对是使用频率最高的 JDK 命令行工具, 因为其他的 JDK 工具大多需要输入它查询到的 LVMID 来确定要监控的是哪一个虚拟机进程.</p> <p>jps 命令格式:</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>jps <span class="token punctuation">[</span>可选参数<span class="token punctuation">]</span> <span class="token punctuation">[</span>hostid<span class="token punctuation">]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>可选参数选项:</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token parameter variable">-q</span> <span class="token comment"># 不输出类名, Jar名和传入main方法的参数</span>
<span class="token parameter variable">-m</span> <span class="token comment"># 输出传入main方法的参数</span>
<span class="token parameter variable">-l</span> <span class="token comment"># 输出main类或Jar的全限名</span>
<span class="token parameter variable">-v</span> <span class="token comment"># 输出传入JVM的参数</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><blockquote><p>jps执行样例</p></blockquote> <ul><li>不加参数:</li></ul> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>$ jps
<span class="token number">6</span> leo-homework-server.jar
<span class="token number">11336</span> Jps
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><ul><li><strong>jps -l</strong>: 输出<strong>主类的全名</strong>, 如果进程执行的是 <strong>Jar 包</strong>, 输出 Jar 路径.</li></ul> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>$ jps <span class="token parameter variable">-l</span>
<span class="token number">6</span> leo-homework-server/target/leo-homework-server.jar
<span class="token number">11358</span> sun.tools.jps.Jps
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><ul><li><strong>jps -v</strong>: 输出虚拟机进程启动时 <strong>JVM 参数</strong>.</li></ul> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>$ jps <span class="token parameter variable">-v</span>
<span class="token number">6</span> leo-homework-server.jar <span class="token parameter variable">-Xms6g</span> <span class="token parameter variable">-Xmx6g</span> -Xloggc:/home/shared/log/gc.log <span class="token parameter variable">-XX:+PrintGCDateStamps</span> <span class="token parameter variable">-XX:+UseG1GC</span> <span class="token parameter variable">-XX:MaxGCPauseMillis</span><span class="token operator">=</span><span class="token number">200</span> <span class="token parameter variable">-XX:MetaspaceSize</span><span class="token operator">=</span>256m <span class="token parameter variable">-XX:-OmitStackTraceInFastThrow</span> <span class="token parameter variable">-XX:-PrintGCDetails</span> <span class="token parameter variable">-verbose:gc</span> <span class="token parameter variable">-Dcom.sun.management.jmxremote.port</span><span class="token operator">=</span><span class="token number">9999</span> <span class="token parameter variable">-Dcom.sun.management.jmxremote.login.config</span><span class="token operator">=</span>FenbiConfig <span class="token parameter variable">-Djava.security.auth.login.config</span><span class="token operator">=</span>/etc/jmx_ldap.config <span class="token parameter variable">-Dcom.sun.management.jmxremote.ssl</span><span class="token operator">=</span>false -javaagent:/lib/skywalking-BETA/agent/skywalking-agent.jar -javaagent:/home/shared/files/agent.jar <span class="token parameter variable">-Dxmiast.projectname</span><span class="token operator">=</span>leo-homework <span class="token parameter variable">-Dxmiast.nodename</span><span class="token operator">=</span>leo-homework <span class="token parameter variable">-Dxmiast.ip</span><span class="token operator">=</span><span class="token number">10.130</span>.8.20 <span class="token parameter variable">-Dxmiast.port</span><span class="token operator">=</span><span class="token number">9090</span> <span class="token parameter variable">-Dxmiast.region</span><span class="token operator">=</span> <span class="token parameter variable">-Dxmiast.token</span><span class="token operator">=</span>puzWfJyx9qVZxk19Xb5b5LQ <span class="token parameter variable">-Dxmiast.delayhooktime.ms</span><span class="token operator">=</span><span class="token number">300000</span>
<span class="token number">11382</span> Jps <span class="token parameter variable">-Dapplication.home</span><span class="token operator">=</span>/usr/java/jdk1.8.0_202 <span class="token parameter variable">-Xms8m</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h5 id="_3-jstat-虚拟机统计信息监视工具"><a href="#_3-jstat-虚拟机统计信息监视工具" class="header-anchor">#</a> 3.jstat:虚拟机统计信息监视工具</h5> <blockquote><p>工具介绍</p></blockquote> <p><mark><strong>jstat(JVM Statistics Monitoring Tool)是用于监视虚拟机各种运行状态信息的命令行工具. 它可以显示本地或者远程虚拟机进程中的类加载, 内存, 垃圾收集, 即时编译等运行时数据</strong></mark>, 在没有 GUI 图形界面, 只提供了纯文本控制台环境的服务器上, 它将是<strong>运行期</strong>定位虚拟机性能问题的常用工具.</p> <p>jstat 命令格式为:</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>jstat <span class="token punctuation">[</span>-命令选项<span class="token punctuation">]</span> <span class="token punctuation">[</span>pid<span class="token punctuation">]</span> <span class="token punctuation">[</span>间隔时间<span class="token punctuation">(</span>毫秒<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>查询次数<span class="token punctuation">]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>选项 option 代表用户希望查询的虚拟机信息, 主要分为三类: <strong>类加载, 垃圾收集, 运行期编译状况</strong>. 常见的 <strong>命令选项</strong> 如下, 这里每个参数输出属性不一样.</p> <p>​<img src="/img/Image00055-20240302133505-2laezfi.jpg" alt="">​</p> <blockquote><p>垃圾回收统计</p></blockquote> <p><strong>jstat -gc pid 最常用</strong>, 可以评估程序内存使用及 <strong>GC 压力整体情况</strong>, 需记住!</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>$ jstat <span class="token parameter variable">-gc</span> <span class="token number">6</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>结果如下:</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>$ jstat <span class="token parameter variable">-gc</span> <span class="token number">6</span>
 S0C    S1C    S0U    S1U      EC       EU        OC         OU       MC     MU    CCSC   CCSU   YGC     YGCT    FGC    FGCT     GCT   
 <span class="token number">0.0</span>   <span class="token number">2048.0</span>  <span class="token number">0.0</span>   <span class="token number">2048.0</span> <span class="token number">3962880.0</span> <span class="token number">12288.0</span>  <span class="token number">2326528.0</span>   <span class="token number">472219.0</span>  <span class="token number">205568.0</span> <span class="token number">198645.4</span> <span class="token number">23296.0</span> <span class="token number">21984.9</span>   <span class="token number">1847</span>   <span class="token number">51.344</span>   <span class="token number">1</span>      <span class="token number">1.371</span>   <span class="token number">52.716</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><ul><li>S0C: 第一个幸存区的大小, 单位 KB.</li> <li>S1C: 第二个幸存区的大小.</li> <li>S0U: 第一个幸存区的使用大小.</li> <li>S1U: 第二个幸存区的使用大小.</li> <li>EC: 伊甸园区的大小.</li> <li>EU: 伊甸园区的使用大小.</li> <li>OC: 老年代大小.</li> <li>OU: 老年代使用大小.</li> <li>MC: 方法区大小(元空间).</li> <li>MU: 方法区使用大小.</li> <li>CCSC: 压缩类空间大小.</li> <li>CCSU: 压缩类空间使用大小.</li> <li>YGC: 年轻代垃圾回收<strong>次数</strong>, 启动以来总共的次数.</li> <li>YGCT: 年轻代垃圾回收消耗时间, 单位 s, YGC 的<strong>总时间</strong>.</li> <li>FGC: 老年代垃圾回收总次数.</li> <li>FGCT: 老年代垃圾回收消耗时间, 单位 s, FGC <strong>总时间</strong>.</li> <li>GCT: 垃圾回收消耗总时间, 单位 s, 全部 GC 的<strong>总时间</strong>.</li></ul> <p>根据这些参数就可以看 JVM 的状态, 并评估当前系统的压力, 用于<strong>调优</strong>!</p> <blockquote><p>使用示例</p></blockquote> <p><strong>例子 1</strong>:</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>$ jstat <span class="token parameter variable">-gc</span> <span class="token parameter variable">-h3</span> <span class="token number">6</span> <span class="token number">1000</span> <span class="token number">10</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><div class="language-shell line-numbers-mode"><pre class="language-shell"><code>$ jstat <span class="token parameter variable">-gc</span> <span class="token parameter variable">-h3</span> <span class="token number">6</span> <span class="token number">1000</span> <span class="token number">10</span>
 S0C    S1C    S0U    S1U      EC       EU        OC         OU       MC     MU    CCSC   CCSU   YGC     YGCT    FGC    FGCT     GCT   
 <span class="token number">0.0</span>   <span class="token number">4096.0</span>  <span class="token number">0.0</span>   <span class="token number">4096.0</span> <span class="token number">3960832.0</span> <span class="token number">2467840.0</span> <span class="token number">2326528.0</span>   <span class="token number">470878.4</span>  <span class="token number">205568.0</span> <span class="token number">198644.7</span> <span class="token number">23296.0</span> <span class="token number">21984.4</span>   <span class="token number">1845</span>   <span class="token number">51.301</span>   <span class="token number">1</span>      <span class="token number">1.371</span>   <span class="token number">52.673</span>
 <span class="token number">0.0</span>   <span class="token number">4096.0</span>  <span class="token number">0.0</span>   <span class="token number">4096.0</span> <span class="token number">3960832.0</span> <span class="token number">2473984.0</span> <span class="token number">2326528.0</span>   <span class="token number">470878.4</span>  <span class="token number">205568.0</span> <span class="token number">198644.7</span> <span class="token number">23296.0</span> <span class="token number">21984.4</span>   <span class="token number">1845</span>   <span class="token number">51.301</span>   <span class="token number">1</span>      <span class="token number">1.371</span>   <span class="token number">52.673</span>
 <span class="token number">0.0</span>   <span class="token number">4096.0</span>  <span class="token number">0.0</span>   <span class="token number">4096.0</span> <span class="token number">3960832.0</span> <span class="token number">2480128.0</span> <span class="token number">2326528.0</span>   <span class="token number">470878.4</span>  <span class="token number">205568.0</span> <span class="token number">198644.7</span> <span class="token number">23296.0</span> <span class="token number">21984.4</span>   <span class="token number">1845</span>   <span class="token number">51.301</span>   <span class="token number">1</span>      <span class="token number">1.371</span>   <span class="token number">52.673</span>
 S0C    S1C    S0U    S1U      EC       EU        OC         OU       MC     MU    CCSC   CCSU   YGC     YGCT    FGC    FGCT     GCT   
 <span class="token number">0.0</span>   <span class="token number">4096.0</span>  <span class="token number">0.0</span>   <span class="token number">4096.0</span> <span class="token number">3960832.0</span> <span class="token number">2482176.0</span> <span class="token number">2326528.0</span>   <span class="token number">470878.4</span>  <span class="token number">205568.0</span> <span class="token number">198644.7</span> <span class="token number">23296.0</span> <span class="token number">21984.4</span>   <span class="token number">1845</span>   <span class="token number">51.301</span>   <span class="token number">1</span>      <span class="token number">1.371</span>   <span class="token number">52.673</span>
 <span class="token number">0.0</span>   <span class="token number">4096.0</span>  <span class="token number">0.0</span>   <span class="token number">4096.0</span> <span class="token number">3960832.0</span> <span class="token number">2486272.0</span> <span class="token number">2326528.0</span>   <span class="token number">470878.4</span>  <span class="token number">205568.0</span> <span class="token number">198644.7</span> <span class="token number">23296.0</span> <span class="token number">21984.4</span>   <span class="token number">1845</span>   <span class="token number">51.301</span>   <span class="token number">1</span>      <span class="token number">1.371</span>   <span class="token number">52.673</span>
 <span class="token number">0.0</span>   <span class="token number">4096.0</span>  <span class="token number">0.0</span>   <span class="token number">4096.0</span> <span class="token number">3960832.0</span> <span class="token number">2488320.0</span> <span class="token number">2326528.0</span>   <span class="token number">470878.4</span>  <span class="token number">205568.0</span> <span class="token number">198644.7</span> <span class="token number">23296.0</span> <span class="token number">21984.4</span>   <span class="token number">1845</span>   <span class="token number">51.301</span>   <span class="token number">1</span>      <span class="token number">1.371</span>   <span class="token number">52.673</span>
 S0C    S1C    S0U    S1U      EC       EU        OC         OU       MC     MU    CCSC   CCSU   YGC     YGCT    FGC    FGCT     GCT   
 <span class="token number">0.0</span>   <span class="token number">4096.0</span>  <span class="token number">0.0</span>   <span class="token number">4096.0</span> <span class="token number">3960832.0</span> <span class="token number">2492416.0</span> <span class="token number">2326528.0</span>   <span class="token number">470878.4</span>  <span class="token number">205568.0</span> <span class="token number">198644.7</span> <span class="token number">23296.0</span> <span class="token number">21984.4</span>   <span class="token number">1845</span>   <span class="token number">51.301</span>   <span class="token number">1</span>      <span class="token number">1.371</span>   <span class="token number">52.673</span>
 <span class="token number">0.0</span>   <span class="token number">4096.0</span>  <span class="token number">0.0</span>   <span class="token number">4096.0</span> <span class="token number">3960832.0</span> <span class="token number">2498560.0</span> <span class="token number">2326528.0</span>   <span class="token number">470878.4</span>  <span class="token number">205568.0</span> <span class="token number">198644.7</span> <span class="token number">23296.0</span> <span class="token number">21984.4</span>   <span class="token number">1845</span>   <span class="token number">51.301</span>   <span class="token number">1</span>      <span class="token number">1.371</span>   <span class="token number">52.673</span>
 <span class="token number">0.0</span>   <span class="token number">4096.0</span>  <span class="token number">0.0</span>   <span class="token number">4096.0</span> <span class="token number">3960832.0</span> <span class="token number">2500608.0</span> <span class="token number">2326528.0</span>   <span class="token number">470878.4</span>  <span class="token number">205568.0</span> <span class="token number">198644.7</span> <span class="token number">23296.0</span> <span class="token number">21984.4</span>   <span class="token number">1845</span>   <span class="token number">51.301</span>   <span class="token number">1</span>      <span class="token number">1.371</span>   <span class="token number">52.673</span>
 S0C    S1C    S0U    S1U      EC       EU        OC         OU       MC     MU    CCSC   CCSU   YGC     YGCT    FGC    FGCT     GCT   
 <span class="token number">0.0</span>   <span class="token number">4096.0</span>  <span class="token number">0.0</span>   <span class="token number">4096.0</span> <span class="token number">3960832.0</span> <span class="token number">2729984.0</span> <span class="token number">2326528.0</span>   <span class="token number">470878.4</span>  <span class="token number">205568.0</span> <span class="token number">198644.7</span> <span class="token number">23296.0</span> <span class="token number">21984.4</span>   <span class="token number">1845</span>   <span class="token number">51.301</span>   <span class="token number">1</span>      <span class="token number">1.371</span>   <span class="token number">52.673</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>表示分析<strong>进程 id 为 6</strong> 的 <strong>GC</strong> 情况, 每隔 1000ms 打印一次记录, 打印 10 次停止, 每 3 行后打印指标头部.</p> <p><strong>例子 2</strong>: 需要每 1000 毫秒查询一次进程 6 垃圾收集状况, 一共查询 10 次, 命令如下.</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>$ jstat <span class="token parameter variable">-gcutil</span> <span class="token number">6</span> <span class="token number">1000</span> <span class="token number">10</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><div class="language-shell line-numbers-mode"><pre class="language-shell"><code>$ jstat <span class="token parameter variable">-gcutil</span> <span class="token number">6</span> <span class="token number">1000</span> <span class="token number">10</span>
  S0     S1     E      O      M     CCS    YGC     YGCT    FGC    FGCT     GCT   
  <span class="token number">0.00</span> <span class="token number">100.00</span>  <span class="token number">31.02</span>  <span class="token number">20.24</span>  <span class="token number">96.63</span>  <span class="token number">94.37</span>   <span class="token number">1846</span>   <span class="token number">51.323</span>     <span class="token number">1</span>    <span class="token number">1.371</span>   <span class="token number">52.694</span>
  <span class="token number">0.00</span> <span class="token number">100.00</span>  <span class="token number">31.13</span>  <span class="token number">20.24</span>  <span class="token number">96.63</span>  <span class="token number">94.37</span>   <span class="token number">1846</span>   <span class="token number">51.323</span>     <span class="token number">1</span>    <span class="token number">1.371</span>   <span class="token number">52.694</span>
  <span class="token number">0.00</span> <span class="token number">100.00</span>  <span class="token number">31.18</span>  <span class="token number">20.24</span>  <span class="token number">96.63</span>  <span class="token number">94.37</span>   <span class="token number">1846</span>   <span class="token number">51.323</span>     <span class="token number">1</span>    <span class="token number">1.371</span>   <span class="token number">52.694</span>
  <span class="token number">0.00</span> <span class="token number">100.00</span>  <span class="token number">31.18</span>  <span class="token number">20.24</span>  <span class="token number">96.63</span>  <span class="token number">94.37</span>   <span class="token number">1846</span>   <span class="token number">51.323</span>     <span class="token number">1</span>    <span class="token number">1.371</span>   <span class="token number">52.694</span>
  <span class="token number">0.00</span> <span class="token number">100.00</span>  <span class="token number">31.39</span>  <span class="token number">20.24</span>  <span class="token number">96.63</span>  <span class="token number">94.37</span>   <span class="token number">1846</span>   <span class="token number">51.323</span>     <span class="token number">1</span>    <span class="token number">1.371</span>   <span class="token number">52.694</span>
  <span class="token number">0.00</span> <span class="token number">100.00</span>  <span class="token number">31.49</span>  <span class="token number">20.24</span>  <span class="token number">96.63</span>  <span class="token number">94.37</span>   <span class="token number">1846</span>   <span class="token number">51.323</span>     <span class="token number">1</span>    <span class="token number">1.371</span>   <span class="token number">52.694</span>
  <span class="token number">0.00</span> <span class="token number">100.00</span>  <span class="token number">31.49</span>  <span class="token number">20.24</span>  <span class="token number">96.63</span>  <span class="token number">94.37</span>   <span class="token number">1846</span>   <span class="token number">51.323</span>     <span class="token number">1</span>    <span class="token number">1.371</span>   <span class="token number">52.694</span>
  <span class="token number">0.00</span> <span class="token number">100.00</span>  <span class="token number">31.64</span>  <span class="token number">20.24</span>  <span class="token number">96.63</span>  <span class="token number">94.37</span>   <span class="token number">1846</span>   <span class="token number">51.323</span>     <span class="token number">1</span>    <span class="token number">1.371</span>   <span class="token number">52.694</span>
  <span class="token number">0.00</span> <span class="token number">100.00</span>  <span class="token number">31.64</span>  <span class="token number">20.24</span>  <span class="token number">96.63</span>  <span class="token number">94.37</span>   <span class="token number">1846</span>   <span class="token number">51.323</span>     <span class="token number">1</span>    <span class="token number">1.371</span>   <span class="token number">52.694</span>
  <span class="token number">0.00</span> <span class="token number">100.00</span>  <span class="token number">31.75</span>  <span class="token number">20.24</span>  <span class="token number">96.63</span>  <span class="token number">94.37</span>   <span class="token number">1846</span>   <span class="token number">51.323</span>     <span class="token number">1</span>    <span class="token number">1.371</span>   <span class="token number">52.694</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p><strong>例子 3</strong>: jstat 监视选项众多, 无法逐一演示, 这里举一个在命令行下监视一台刚刚启动的 GlassFish v3 服务器的内存状况的例子, 用以演示如何查看监视结果. 监视参数与输出结果如代码下所示.</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>$ jstat <span class="token operator">-</span>gcutil <span class="token number">2764</span>
<span class="token constant">S0</span>      <span class="token constant">S1</span>      <span class="token constant">E</span>       <span class="token constant">O</span>        <span class="token constant">P</span>        <span class="token constant">YGC</span>    <span class="token constant">YGCT</span>     <span class="token constant">FGC</span>    <span class="token constant">FGCT</span>     <span class="token constant">GCT</span>
<span class="token number">0.00</span>    <span class="token number">0.00</span>    <span class="token number">6.20</span>    <span class="token number">41.42</span>    <span class="token number">47.20</span>    <span class="token number">16</span>     <span class="token number">0.105</span>    <span class="token number">3</span>      <span class="token number">0.472</span>    <span class="token number">0.577</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>查询结果表明: 这台服务器的新生代 Eden 区(E, 表示 Eden)使用了 6.2% 的空间, 2 个 Survivor 区(S0, S1, 表示 Survivor0, Survivor1) 里面都是空的, 老年代(O, 表示 Old)和永久代(P, 表示 Permanent)则分别使用了 41.42% 和 47.20% 的空间. 程序运行以来共发生 Minor GC(YGC, 表示 Young GC)16 次, 总耗时 0.105 秒; 发生 Full GC(FGC, 表示 Full GC)3 次, 总耗时(FGCT, 表示 Full GC Time)为 0.472 秒; 所有 GC 总耗时(GCT, 表示 GC Time)为 0.577 秒.</p> <p>使用 jstat 工具在纯文本状态下监视虚拟机状态的变化, 在用户体验上也许不如后文将会提到的 JMC, VisualVM 等可视化的监视工具直接以图表展现那样直观, 但在实际生产环境中不一定可以使用图形界面, 而且多数服务器管理员也都已经习惯了在文本控制台工作, 直接在控制台中使用 jstat 命令依然是一种常用的监控方式.</p> <h5 id="_4-jinfo-java配置信息工具"><a href="#_4-jinfo-java配置信息工具" class="header-anchor">#</a> 4.jinfo:Java配置信息工具</h5> <blockquote><p>工具介绍</p></blockquote> <p><mark><strong>jinfo 的作用是实时查看和调整虚拟机各项参数</strong></mark>.</p> <p>使用 jps 命令的 -v 参数可以<strong>查看虚拟机启动时显式指定的参数列表</strong>, 但如果想知道未被显式指定的参数的系统默认值, 除了去找资料外, 就只能使用 jinfo 的 -flag 选项进行查询了. jinfo 还可以使用 -sysprops 选项把虚拟机进程的 <code>System.getProperties()</code>​ 的内容打印出来.</p> <p>jinfo 命令格式:</p> <div class="language-ziti1 line-numbers-mode"><pre class="language-text"><code>jinfo [ option ] pid
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><blockquote><p>使用示例</p></blockquote> <ul><li><strong>jinfo pid</strong>: 输出当前 JVM 进程的<strong>全部参数和系统属性</strong>. 第一部分是系统属性, 第二部分是 JVM 参数.</li></ul> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>$ jinfo <span class="token number">6</span>
Attaching to process ID <span class="token number">6</span>, please wait<span class="token punctuation">..</span>.
Debugger attached successfully.
  
<span class="token comment"># Java参数  </span>
Java System Properties:

java.vendor <span class="token operator">=</span> Oracle Corporation
os.name <span class="token operator">=</span> Linux
sun.boot.class.path <span class="token operator">=</span> /usr/java/jdk1.8.0_202/jre/lib/resources.jar:/usr/java/jdk1.8.0_202/jre/lib/rt.jar:/usr/java/jdk1.8.0_202/jre/lib/sunrsasign.jar:/usr/java/jdk1.8.0_202/jre/lib/jsse.jar:/usr/java/jdk1.8.0_202/jre/lib/jce.jar:/usr/java/jdk1.8.0_202/jre/lib/charsets.jar:/usr/java/jdk1.8.0_202/jre/lib/jfr.jar:/usr/java/jdk1.8.0_202/jre/classes
<span class="token comment"># 省略....</span>

<span class="token comment"># 虚拟机参数 </span>
VM Flags:
Non-default VM flags: <span class="token parameter variable">-XX:CICompilerCount</span><span class="token operator">=</span><span class="token number">4</span> <span class="token parameter variable">-XX:ConcGCThreads</span><span class="token operator">=</span><span class="token number">2</span> <span class="token parameter variable">-XX:G1HeapRegionSize</span><span class="token operator">=</span><span class="token number">4194304</span> <span class="token parameter variable">-XX:+HeapDumpOnOutOfMemoryError</span> <span class="token parameter variable">-XX:HeapDumpPath</span><span class="token operator">=</span>null <span class="token parameter variable">-XX:InitialHeapSize</span><span class="token operator">=</span><span class="token number">9663676416</span> <span class="token parameter variable">-XX:+ManagementServer</span> <span class="token parameter variable">-XX:MarkStackSize</span><span class="token operator">=</span><span class="token number">4194304</span> <span class="token parameter variable">-XX:MaxGCPauseMillis</span><span class="token operator">=</span><span class="token number">200</span> <span class="token parameter variable">-XX:MaxHeapSize</span><span class="token operator">=</span><span class="token number">9663676416</span> <span class="token parameter variable">-XX:MaxNewSize</span><span class="token operator">=</span><span class="token number">5796528128</span> <span class="token parameter variable">-XX:MetaspaceSize</span><span class="token operator">=</span><span class="token number">268435456</span> <span class="token parameter variable">-XX:MinHeapDeltaBytes</span><span class="token operator">=</span><span class="token number">4194304</span> <span class="token parameter variable">-XX:-OmitStackTraceInFastThrow</span> <span class="token parameter variable">-XX:+PrintGC</span> <span class="token parameter variable">-XX:+PrintGCDateStamps</span> <span class="token parameter variable">-XX:+PrintGCDetails</span> <span class="token parameter variable">-XX:+PrintGCTimeStamps</span> <span class="token parameter variable">-XX:+UseCompressedClassPointers</span> <span class="token parameter variable">-XX:+UseCompressedOops</span> <span class="token parameter variable">-XX:+UseFastUnorderedTimeStamps</span> <span class="token parameter variable">-XX:+UseG1GC</span> 
Command line:  <span class="token parameter variable">-Xmx9g</span> <span class="token parameter variable">-Xms9g</span> -Xloggc:/home/shared/log/gc.log <span class="token parameter variable">-XX:+PrintGCDateStamps</span> <span class="token parameter variable">-XX:+UseG1GC</span> <span class="token parameter variable">-XX:MaxGCPauseMillis</span><span class="token operator">=</span><span class="token number">200</span> <span class="token parameter variable">-XX:MetaspaceSize</span><span class="token operator">=</span>256m <span class="token parameter variable">-XX:-OmitStackTraceInFastThrow</span> <span class="token parameter variable">-XX:+PrintGCDetails</span> <span class="token parameter variable">-verbose:gc</span> <span class="token parameter variable">-XX:+HeapDumpOnOutOfMemoryError</span> <span class="token parameter variable">-XX:HeapDumpPath</span><span class="token operator">=</span>/home/oom-dump/leo-cm-ocr <span class="token parameter variable">-Dcom.sun.management.jmxremote.port</span><span class="token operator">=</span><span class="token number">9999</span> <span class="token parameter variable">-Dcom.sun.management.jmxremote.login.config</span><span class="token operator">=</span>FenbiConfig <span class="token parameter variable">-Djava.security.auth.login.config</span><span class="token operator">=</span>/etc/jmx_ldap.config <span class="token parameter variable">-Dcom.sun.management.jmxremote.ssl</span><span class="token operator">=</span>false -javaagent:/lib/skywalking-BETA/agent/skywalking-agent.jar
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><ul><li><strong>jinfo -flags pid</strong>: 单独查看 <strong>JVM 参数</strong>.</li></ul> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>$ jinfo <span class="token parameter variable">-flags</span> <span class="token number">6</span>
Attaching to process ID <span class="token number">6</span>, please wait<span class="token punctuation">..</span>.
Debugger attached successfully.
Server compiler detected.
JVM version is <span class="token number">25.202</span>-b08
Non-default VM flags: <span class="token parameter variable">-XX:CICompilerCount</span><span class="token operator">=</span><span class="token number">4</span> <span class="token parameter variable">-XX:ConcGCThreads</span><span class="token operator">=</span><span class="token number">2</span> <span class="token parameter variable">-XX:G1HeapRegionSize</span><span class="token operator">=</span><span class="token number">4194304</span> <span class="token parameter variable">-XX:+HeapDumpOnOutOfMemoryError</span> <span class="token parameter variable">-XX:HeapDumpPath</span><span class="token operator">=</span>null <span class="token parameter variable">-XX:InitialHeapSize</span><span class="token operator">=</span><span class="token number">9663676416</span> <span class="token parameter variable">-XX:+ManagementServer</span> <span class="token parameter variable">-XX:MarkStackSize</span><span class="token operator">=</span><span class="token number">4194304</span> <span class="token parameter variable">-XX:MaxGCPauseMillis</span><span class="token operator">=</span><span class="token number">200</span> <span class="token parameter variable">-XX:MaxHeapSize</span><span class="token operator">=</span><span class="token number">9663676416</span> <span class="token parameter variable">-XX:MaxNewSize</span><span class="token operator">=</span><span class="token number">5796528128</span> <span class="token parameter variable">-XX:MetaspaceSize</span><span class="token operator">=</span><span class="token number">268435456</span> <span class="token parameter variable">-XX:MinHeapDeltaBytes</span><span class="token operator">=</span><span class="token number">4194304</span> <span class="token parameter variable">-XX:-OmitStackTraceInFastThrow</span> <span class="token parameter variable">-XX:+PrintGC</span> <span class="token parameter variable">-XX:+PrintGCDateStamps</span> <span class="token parameter variable">-XX:+PrintGCDetails</span> <span class="token parameter variable">-XX:+PrintGCTimeStamps</span> <span class="token parameter variable">-XX:+UseCompressedClassPointers</span> <span class="token parameter variable">-XX:+UseCompressedOops</span> <span class="token parameter variable">-XX:+UseFastUnorderedTimeStamps</span> <span class="token parameter variable">-XX:+UseG1GC</span> 
Command line:  <span class="token parameter variable">-Xmx9g</span> <span class="token parameter variable">-Xms9g</span> -Xloggc:/home/shared/log/gc.log <span class="token parameter variable">-XX:+PrintGCDateStamps</span> <span class="token parameter variable">-XX:+UseG1GC</span> <span class="token parameter variable">-XX:MaxGCPauseMillis</span><span class="token operator">=</span><span class="token number">200</span> <span class="token parameter variable">-XX:MetaspaceSize</span><span class="token operator">=</span>256m <span class="token parameter variable">-XX:-OmitStackTraceInFastThrow</span> <span class="token parameter variable">-XX:+PrintGCDetails</span> <span class="token parameter variable">-verbose:gc</span> <span class="token parameter variable">-XX:+HeapDumpOnOutOfMemoryError</span> <span class="token parameter variable">-XX:HeapDumpPath</span><span class="token operator">=</span>/home/oom-dump/leo-cm-ocr <span class="token parameter variable">-Dcom.sun.management.jmxremote.port</span><span class="token operator">=</span><span class="token number">9999</span> <span class="token parameter variable">-Dcom.sun.management.jmxremote.login.config</span><span class="token operator">=</span>FenbiConfig <span class="token parameter variable">-Djava.security.auth.login.config</span><span class="token operator">=</span>/etc/jmx_ldap.config <span class="token parameter variable">-Dcom.sun.management.jmxremote.ssl</span><span class="token operator">=</span>false -javaagent:/lib/skywalking-BETA/agent/skywalking-agent.jar
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><ul><li><strong>jinfo -flag name vmid</strong>: 输出<strong>对应名称的参数</strong>的具体值. 比如输出 MaxHeapSize, 查看当前 JVM 进程是否开启打印 GC 日志, 查询参数 CMSInitiatingOccupancyFraction 的值.</li></ul> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>$ jinfo  <span class="token parameter variable">-flag</span> MaxHeapSize <span class="token number">6</span>
<span class="token parameter variable">-XX:MaxHeapSize</span><span class="token operator">=</span><span class="token number">9663676416</span>
$ jinfo  <span class="token parameter variable">-flag</span> PrintGC <span class="token number">6</span>
<span class="token parameter variable">-XX:+PrintGC</span>
$ jinfo <span class="token parameter variable">-flag</span> CMSInitiatingOccupancyFraction <span class="token number">1444</span>
<span class="token parameter variable">-XX:CMSInitiatingOccupancyFraction</span><span class="token operator">=</span><span class="token number">85</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><ul><li><strong>info -sysprops pid</strong>: 单独查看系统属性.</li></ul> <h5 id="_5-jmap-java内存映像工具"><a href="#_5-jmap-java内存映像工具" class="header-anchor">#</a> 5.jmap:Java内存映像工具</h5> <blockquote><p>工具介绍</p></blockquote> <p><mark><strong>jmap(Memory Map for Java)命令用于生成堆转储快照(一般称为 heapdump 或 dump 文件)</strong></mark> .</p> <p>jmap 的作用并不仅仅是为了获取堆转储快照, 它还可以查询 finalize 执行队列, <strong>Java 堆和方法区的详细信息, 如空间使用率, 当前用的是哪种收集器</strong>等.</p> <p>主要用处:</p> <ul><li><strong>堆信息</strong>.</li> <li><strong>查看实例个数与占用内存大小</strong></li> <li><strong>堆内存 dump 文件</strong>.</li></ul> <p>jmap 命令格式:</p> <div class="language-ziti1 line-numbers-mode"><pre class="language-text"><code>$ jmap [可选项] pid(进程号)
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>option 选项的合法值与具体含义如下所示.</p> <p><strong>表4-3　jmap 工具主要选项</strong></p> <p><img src="/img/Image00056-20240302133505-awqi2hk.jpg" alt=""></p> <blockquote><p>使用示例:查看堆信息</p></blockquote> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>$ jmap <span class="token parameter variable">-heap</span> pid
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>执行结果:</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>$ jmap <span class="token parameter variable">-heap</span> <span class="token number">6</span>
Attaching to process ID <span class="token number">6</span>, please wait<span class="token punctuation">..</span>.
Debugger attached successfully.
Server compiler detected.
JVM version is <span class="token number">25.202</span>-b08

using thread-local object allocation.
Garbage-First <span class="token punctuation">(</span>G1<span class="token punctuation">)</span> GC with <span class="token number">2</span> thread<span class="token punctuation">(</span>s<span class="token punctuation">)</span>

Heap Configuration:
   MinHeapFreeRatio         <span class="token operator">=</span> <span class="token number">40</span>
   MaxHeapFreeRatio         <span class="token operator">=</span> <span class="token number">70</span>
   MaxHeapSize              <span class="token operator">=</span> <span class="token number">6442450944</span> <span class="token punctuation">(</span><span class="token number">6144</span>.0MB<span class="token punctuation">)</span>
   NewSize                  <span class="token operator">=</span> <span class="token number">1363144</span> <span class="token punctuation">(</span><span class="token number">1</span>.2999954223632812MB<span class="token punctuation">)</span>
   MaxNewSize               <span class="token operator">=</span> <span class="token number">3865051136</span> <span class="token punctuation">(</span><span class="token number">3686</span>.0MB<span class="token punctuation">)</span>
   OldSize                  <span class="token operator">=</span> <span class="token number">5452592</span> <span class="token punctuation">(</span><span class="token number">5</span>.1999969482421875MB<span class="token punctuation">)</span>
   NewRatio                 <span class="token operator">=</span> <span class="token number">2</span>
   SurvivorRatio            <span class="token operator">=</span> <span class="token number">8</span>
   MetaspaceSize            <span class="token operator">=</span> <span class="token number">268435456</span> <span class="token punctuation">(</span><span class="token number">256</span>.0MB<span class="token punctuation">)</span>
   CompressedClassSpaceSize <span class="token operator">=</span> <span class="token number">1073741824</span> <span class="token punctuation">(</span><span class="token number">1024</span>.0MB<span class="token punctuation">)</span>
   MaxMetaspaceSize         <span class="token operator">=</span> <span class="token number">17592186044415</span> MB
   G1HeapRegionSize         <span class="token operator">=</span> <span class="token number">2097152</span> <span class="token punctuation">(</span><span class="token number">2</span>.0MB<span class="token punctuation">)</span>

Heap Usage:
G1 Heap:
   regions  <span class="token operator">=</span> <span class="token number">3072</span>
   capacity <span class="token operator">=</span> <span class="token number">6442450944</span> <span class="token punctuation">(</span><span class="token number">6144</span>.0MB<span class="token punctuation">)</span>
   used     <span class="token operator">=</span> <span class="token number">1620983032</span> <span class="token punctuation">(</span><span class="token number">1545</span>.8898849487305MB<span class="token punctuation">)</span>
   <span class="token function">free</span>     <span class="token operator">=</span> <span class="token number">4821467912</span> <span class="token punctuation">(</span><span class="token number">4598</span>.1101150512695MB<span class="token punctuation">)</span>
   <span class="token number">25.160968179504078</span>% used
G1 Young Generation:
Eden Space:
   regions  <span class="token operator">=</span> <span class="token number">548</span>
   capacity <span class="token operator">=</span> <span class="token number">4057989120</span> <span class="token punctuation">(</span><span class="token number">3870</span>.0MB<span class="token punctuation">)</span>
   used     <span class="token operator">=</span> <span class="token number">1149239296</span> <span class="token punctuation">(</span><span class="token number">1096</span>.0MB<span class="token punctuation">)</span>
   <span class="token function">free</span>     <span class="token operator">=</span> <span class="token number">2908749824</span> <span class="token punctuation">(</span><span class="token number">2774</span>.0MB<span class="token punctuation">)</span>
   <span class="token number">28.320413436692508</span>% used
Survivor Space:
   regions  <span class="token operator">=</span> <span class="token number">1</span>
   capacity <span class="token operator">=</span> <span class="token number">2097152</span> <span class="token punctuation">(</span><span class="token number">2</span>.0MB<span class="token punctuation">)</span>
   used     <span class="token operator">=</span> <span class="token number">2097152</span> <span class="token punctuation">(</span><span class="token number">2</span>.0MB<span class="token punctuation">)</span>
   <span class="token function">free</span>     <span class="token operator">=</span> <span class="token number">0</span> <span class="token punctuation">(</span><span class="token number">0</span>.0MB<span class="token punctuation">)</span>
   <span class="token number">100.0</span>% used
G1 Old Generation:
   regions  <span class="token operator">=</span> <span class="token number">229</span>
   capacity <span class="token operator">=</span> <span class="token number">2382364672</span> <span class="token punctuation">(</span><span class="token number">2272</span>.0MB<span class="token punctuation">)</span>
   used     <span class="token operator">=</span> <span class="token number">469646584</span> <span class="token punctuation">(</span><span class="token number">447</span>.88988494873047MB<span class="token punctuation">)</span>
   <span class="token function">free</span>     <span class="token operator">=</span> <span class="token number">1912718088</span> <span class="token punctuation">(</span><span class="token number">1824</span>.1101150512695MB<span class="token punctuation">)</span>
   <span class="token number">19.713463245982854</span>% used
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br></div></div><blockquote><p>使用示例:查看实例个数与占用内存大小</p></blockquote> <p>使用 -<strong>histo</strong> 参数<strong>查看实例个数与占用内存大小</strong>.</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ jmap <span class="token parameter variable">-histo</span> <span class="token number">6</span>

 num     <span class="token comment">#instances         #bytes  class name</span>
----------------------------------------------
   <span class="token number">1</span>:           <span class="token number">658</span>        <span class="token number">4189056</span>  <span class="token punctuation">[</span>I
   <span class="token number">2</span>:          <span class="token number">1197</span>        <span class="token number">1177576</span>  <span class="token punctuation">[</span>B
   <span class="token number">3</span>:          <span class="token number">7504</span>         <span class="token number">816120</span>  <span class="token punctuation">[</span>C
   <span class="token number">4</span>:          <span class="token number">5779</span>         <span class="token number">138696</span>  java.lang.String
   <span class="token number">5</span>:           <span class="token number">691</span>          <span class="token number">78976</span>  java.lang.Class
   <span class="token number">6</span>:          <span class="token number">1298</span>          <span class="token number">61136</span>  <span class="token punctuation">[</span>Ljava.lang.Object<span class="token punctuation">;</span>
   <span class="token number">7</span>:           <span class="token number">791</span>          <span class="token number">31640</span>  java.util.TreeMap<span class="token variable">$Entry</span>
   <span class="token number">8</span>:           <span class="token number">634</span>          <span class="token number">25360</span>  java.util.LinkedHashMap<span class="token variable">$Entry</span>
   <span class="token number">9</span>:           <span class="token number">456</span>          <span class="token number">22144</span>  <span class="token punctuation">[</span>Ljava.lang.String<span class="token punctuation">;</span>
  <span class="token number">10</span>:           <span class="token number">368</span>          <span class="token number">11776</span>  java.util.HashMap<span class="token variable">$Node</span>
  <span class="token number">11</span>:            <span class="token number">38</span>          <span class="token number">11584</span>  <span class="token punctuation">[</span>Ljava.util.HashMap<span class="token variable">$Node</span><span class="token punctuation">;</span>
  <span class="token number">12</span>:           <span class="token number">152</span>          <span class="token number">10944</span>  java.lang.reflect.Field
  <span class="token number">13</span>:           <span class="token number">388</span>           <span class="token number">9312</span>  java.lang.StringBuilder
  <span class="token number">14</span>:           <span class="token number">251</span>           <span class="token number">8032</span>  java.io.File
  <span class="token number">15</span>:           <span class="token number">242</span>           <span class="token number">7744</span>  java.util.Hashtable<span class="token variable">$Entry</span>
  <span class="token number">16</span>:           <span class="token number">107</span>           <span class="token number">6848</span>  java.net.URL
  <span class="token number">17</span>:           <span class="token number">253</span>           <span class="token number">6072</span>  java.lang.StringBuffer
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><ul><li>num: 序号.</li> <li>instances: 实例<strong>数量</strong>.</li> <li>bytes: 占用空间大小.</li> <li>class name: 类名称, 这里  <strong>[C -&gt; char[], [S -&gt; short[], [I -&gt; int[], [B -&gt; byte[], [[I -&gt; int[][]</strong> .</li></ul> <blockquote><p>使用示例:获取堆转储文件</p></blockquote> <p><strong>示例</strong>: 生成指定应用程序的<strong>堆专储快照文件</strong>.</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>$ jmap <span class="token parameter variable">-dump:format</span><span class="token operator">=</span>b,file<span class="token operator">=</span>heap.hprof <span class="token number">6</span>
Dumping heap to /home/shared/apps/leo-homework/heap.hprof <span class="token punctuation">..</span>.
Heap dump <span class="token function">file</span> created
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>获取文件后可以通过 jhat(一般不使用), <strong>mat</strong> 等工具<strong>分析</strong>该 dump 文件.</p> <h5 id="_6-jstack-java堆栈跟踪工具"><a href="#_6-jstack-java堆栈跟踪工具" class="header-anchor">#</a> 6.jstack:Java堆栈跟踪工具</h5> <blockquote><p>工具介绍</p></blockquote> <p><mark><strong>jstack 命令用于生成虚拟机当前时刻的线程快照(一般称为 threaddump 或者 javacore 文件)</strong></mark> . <strong>线程快照就是当前虚拟机内每一条线程正在执行的方法堆栈的集合, 生成线程快照的目的通常是定位线程出现长时间停顿的原因, 如线程间死锁, 死循环, 请求外部资源导致的长时间挂起等, 都是导致线程长时间停顿的常见原因. 线程出现停顿时通过 jstack 来查看各个线程的调用堆栈, 就可以获知没有响应的线程到底在后台做些什么事情, 或者等待着什么资源</strong>.</p> <p>jstack 命令格式:</p> <div class="language-ziti1 line-numbers-mode"><pre class="language-text"><code>jstack [可选项] pid(进程号)
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>option 选项的合法值与具体含义如下表所示.</p> <p><img src="/img/Image00058-20240302133505-otxvy8w.jpg" alt=""></p> <p>从 JDK 5 起, java.lang.Thread 类新增了一个 getAllStackTraces() 方法用于获取虚拟机中所有线程的 StackTraceElement 对象. 使用这个方法可以通过简单的几行代码完成 jstack 的大部分功能.</p> <blockquote><p>jstack线程死锁分析示例</p></blockquote> <p>下面是一个线程死锁的代码. 通过 jstack 命令进行死锁检查, 输出死锁信息, 可以帮助找到发生死锁的线程.</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DeadLockDemo</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">Object</span> resource1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">// 资源 1</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">Object</span> resource2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">// 资源 2</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token comment">// 锁定资源1</span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>resource1<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;获取资源1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token comment">// 睡眠等待</span>
                    <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;等待资源2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 请求资源2</span>
                <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>resource2<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;获取资源2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;线程 1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token comment">// 锁定资源1</span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>resource2<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;获取资源2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token comment">// 睡眠等待</span>
                    <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;等待资源1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 请求资源2</span>
                <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>resource1<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;获取资源1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;线程 2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br></div></div><p>两个线程互相等待资源, 造成死锁. 输出:</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>Thread<span class="token punctuation">[</span>线程 <span class="token number">1,5</span>,main<span class="token punctuation">]</span>获取资源1
Thread<span class="token punctuation">[</span>线程 <span class="token number">2,5</span>,main<span class="token punctuation">]</span>获取资源2
Thread<span class="token punctuation">[</span>线程 <span class="token number">1,5</span>,main<span class="token punctuation">]</span>等待资源2
Thread<span class="token punctuation">[</span>线程 <span class="token number">2,5</span>,main<span class="token punctuation">]</span>等待资源1
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>查看指定进程号的线程快照:</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>$ jstack <span class="token number">6</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>输出的部分内容如下:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>$  jps                                        
<span class="token number">29408</span> <span class="token class-name">Launcher</span>
<span class="token number">29409</span> <span class="token class-name">DeadLockDemo</span>        <span class="token comment">// 测试进程</span>
<span class="token number">424</span> 
<span class="token number">29016</span> <span class="token class-name">RemoteMavenServer36</span>
<span class="token number">426</span> 
<span class="token number">29420</span> <span class="token class-name">Jps</span>
<span class="token comment">// jstack分析测试进程</span>
$ jstack <span class="token number">29409</span>
<span class="token comment">// ....</span>

<span class="token comment">// 找到一个死锁情况</span>
<span class="token class-name">Found</span> one <span class="token class-name">Java</span><span class="token operator">-</span>level deadlock<span class="token operator">:</span>
<span class="token generics"><span class="token punctuation">&lt;</span>mark<span class="token punctuation">&gt;</span></span><span class="token operator">&lt;</span><span class="token operator">/</span>mark<span class="token operator">&gt;</span><span class="token generics"><span class="token punctuation">&lt;</span>mark<span class="token punctuation">&gt;</span></span><span class="token operator">&lt;</span><span class="token operator">/</span>mark<span class="token operator">&gt;</span><span class="token generics"><span class="token punctuation">&lt;</span>mark<span class="token punctuation">&gt;</span></span><span class="token operator">&lt;</span><span class="token operator">/</span>mark<span class="token operator">&gt;</span><span class="token generics"><span class="token punctuation">&lt;</span>mark<span class="token punctuation">&gt;</span></span><span class="token operator">&lt;</span><span class="token operator">/</span>mark<span class="token operator">&gt;</span><span class="token generics"><span class="token punctuation">&lt;</span>mark<span class="token punctuation">&gt;</span></span><span class="token operator">&lt;</span><span class="token operator">/</span>mark<span class="token operator">&gt;</span><span class="token generics"><span class="token punctuation">&lt;</span>mark<span class="token punctuation">&gt;</span></span><span class="token operator">&lt;</span><span class="token operator">/</span>mark<span class="token operator">&gt;</span><span class="token generics"><span class="token punctuation">&lt;</span>mark<span class="token punctuation">&gt;</span></span><span class="token operator">&lt;</span><span class="token operator">/</span>mark<span class="token operator">&gt;=</span>
<span class="token string">&quot;线程 2&quot;</span><span class="token operator">:</span>
  waiting <span class="token keyword">to</span> <span class="token namespace">lock</span> monitor <span class="token number">0x00007fadc08334a8</span> <span class="token punctuation">(</span>object <span class="token number">0x000000076ac965f0</span><span class="token punctuation">,</span> a <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>Object</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  which is held by <span class="token string">&quot;线程 1&quot;</span>
<span class="token string">&quot;线程 1&quot;</span><span class="token operator">:</span>
  waiting <span class="token keyword">to</span> <span class="token namespace">lock</span> monitor <span class="token number">0x00007fadc0830c18</span> <span class="token punctuation">(</span>object <span class="token number">0x000000076ac96600</span><span class="token punctuation">,</span> a <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>Object</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  which is held by <span class="token string">&quot;线程 2&quot;</span>

<span class="token class-name">Java</span> stack information <span class="token keyword">for</span> the threads listed above<span class="token operator">:</span>
<span class="token generics"><span class="token punctuation">&lt;</span>mark<span class="token punctuation">&gt;</span></span><span class="token operator">&lt;</span><span class="token operator">/</span>mark<span class="token operator">&gt;</span><span class="token generics"><span class="token punctuation">&lt;</span>mark<span class="token punctuation">&gt;</span></span><span class="token operator">&lt;</span><span class="token operator">/</span>mark<span class="token operator">&gt;</span><span class="token generics"><span class="token punctuation">&lt;</span>mark<span class="token punctuation">&gt;</span></span><span class="token operator">&lt;</span><span class="token operator">/</span>mark<span class="token operator">&gt;</span><span class="token generics"><span class="token punctuation">&lt;</span>mark<span class="token punctuation">&gt;</span></span><span class="token operator">&lt;</span><span class="token operator">/</span>mark<span class="token operator">&gt;</span><span class="token generics"><span class="token punctuation">&lt;</span>mark<span class="token punctuation">&gt;</span></span><span class="token operator">&lt;</span><span class="token operator">/</span>mark<span class="token operator">&gt;</span><span class="token generics"><span class="token punctuation">&lt;</span>mark<span class="token punctuation">&gt;</span></span><span class="token operator">&lt;</span><span class="token operator">/</span>mark<span class="token operator">&gt;</span><span class="token generics"><span class="token punctuation">&lt;</span>mark<span class="token punctuation">&gt;</span></span><span class="token operator">&lt;</span><span class="token operator">/</span>mark<span class="token operator">&gt;</span><span class="token generics"><span class="token punctuation">&lt;</span>mark<span class="token punctuation">&gt;</span></span><span class="token operator">&lt;</span><span class="token operator">/</span>mark<span class="token operator">&gt;</span><span class="token generics"><span class="token punctuation">&lt;</span>mark<span class="token punctuation">&gt;</span></span><span class="token operator">&lt;</span><span class="token operator">/</span>mark<span class="token operator">&gt;</span><span class="token generics"><span class="token punctuation">&lt;</span>mark<span class="token punctuation">&gt;</span></span><span class="token operator">&lt;</span><span class="token operator">/</span>mark<span class="token operator">&gt;</span><span class="token generics"><span class="token punctuation">&lt;</span>mark<span class="token punctuation">&gt;</span></span><span class="token operator">&lt;</span><span class="token operator">/</span>mark<span class="token operator">&gt;</span><span class="token generics"><span class="token punctuation">&lt;</span>mark<span class="token punctuation">&gt;</span></span><span class="token operator">&lt;</span><span class="token operator">/</span>mark<span class="token operator">&gt;=</span><span class="token operator">==</span>
<span class="token string">&quot;线程 2&quot;</span><span class="token operator">:</span>
        at <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>nano<span class="token punctuation">.</span>deadlock<span class="token punctuation">.</span></span>DeadLockDemo</span><span class="token punctuation">.</span>lambda$main$<span class="token function">1</span><span class="token punctuation">(</span><span class="token class-name">DeadLockDemo</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">44</span><span class="token punctuation">)</span>
        <span class="token operator">-</span> waiting <span class="token keyword">to</span> <span class="token namespace">lock</span> <span class="token generics"><span class="token punctuation">&lt;</span>0x000000076ac965f0<span class="token punctuation">&gt;</span></span> <span class="token punctuation">(</span>a <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>Object</span><span class="token punctuation">)</span>
        <span class="token operator">-</span> locked <span class="token generics"><span class="token punctuation">&lt;</span>0x000000076ac96600<span class="token punctuation">&gt;</span></span> <span class="token punctuation">(</span>a <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>Object</span><span class="token punctuation">)</span>
        at <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>nano<span class="token punctuation">.</span>deadlock<span class="token punctuation">.</span></span>DeadLockDemo</span>$$<span class="token class-name">Lambda</span>$<span class="token number">2</span><span class="token operator">/</span><span class="token number">500977346.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">Unknown</span> <span class="token class-name">Source</span><span class="token punctuation">)</span>
        at <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>Thread</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">748</span><span class="token punctuation">)</span>
<span class="token string">&quot;线程 1&quot;</span><span class="token operator">:</span>
        at <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>nano<span class="token punctuation">.</span>deadlock<span class="token punctuation">.</span></span>DeadLockDemo</span><span class="token punctuation">.</span>lambda$main$<span class="token function">0</span><span class="token punctuation">(</span><span class="token class-name">DeadLockDemo</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">26</span><span class="token punctuation">)</span>
        <span class="token operator">-</span> waiting <span class="token keyword">to</span> <span class="token namespace">lock</span> <span class="token generics"><span class="token punctuation">&lt;</span>0x000000076ac96600<span class="token punctuation">&gt;</span></span> <span class="token punctuation">(</span>a <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>Object</span><span class="token punctuation">)</span>
        <span class="token operator">-</span> locked <span class="token generics"><span class="token punctuation">&lt;</span>0x000000076ac965f0<span class="token punctuation">&gt;</span></span> <span class="token punctuation">(</span>a <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>Object</span><span class="token punctuation">)</span>
        at <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>nano<span class="token punctuation">.</span>deadlock<span class="token punctuation">.</span></span>DeadLockDemo</span>$$<span class="token class-name">Lambda</span>$<span class="token number">1</span><span class="token operator">/</span><span class="token number">1338668845.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">Unknown</span> <span class="token class-name">Source</span><span class="token punctuation">)</span>
        at <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>Thread</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">748</span><span class="token punctuation">)</span>

<span class="token class-name">Found</span> <span class="token number">1</span> deadlock<span class="token punctuation">.</span>    <span class="token comment">// 找到一个死锁</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br></div></div><p>还可以用 <strong>Visual VM</strong> 自动检测死锁(VisualVM:多合-故障处理工具).</p> <h4 id="可视化故障处理工具"><a href="#可视化故障处理工具" class="header-anchor">#</a> 可视化故障处理工具</h4> <p><strong>JDK</strong> 中除了附带大量的命令行工具外, 还提供了几个功能集成度更高的可视化工具, 用户可以使用这些可视化工具以更加便捷的方式进行进程故障诊断和调试工作.</p> <p>JHSDB 虽然名义上是 JDK 9 中才正式提供, 但之前已经以 sa-jdi.jar 包里面的 HSDB(可视化工具)和 CLHSDB(命令行工具)的形式存在了很长一段时间. 它们两个都是 JDK 的正式成员, 随着 JDK 一同发布, 无须独立下载, 使用也是完全免费的.</p> <p>VisualVM 已不是 JDK 中的正式成员, 但仍是可以免费下载, 使用的.</p> <p>为避免本节讲解的内容变成对软件说明文档的简单翻译, 这里准备了一些代码样例, 大多数是笔者特意编写的反面教材. 稍后将会使用几款工具去监控, 分析这些代码存在的问题, 算是本节简单的实战演练. 读者可以把在可视化工具观察到的数据, 现象, 与前面两章中讲解的理论知识进行互相验证.</p> <h5 id="_1-jhsdb-基于服务性代理的调试工具"><a href="#_1-jhsdb-基于服务性代理的调试工具" class="header-anchor">#</a> 1.JHSDB:基于服务性代理的调试工具</h5> <blockquote><p>工具介绍</p></blockquote> <p>JDK 中提供了 JCMD 和 JHSDB 两个集成式的<strong>多功能工具箱</strong>, 它们不仅整合了上一节介绍到的所有基础工具所能提供的专项功能, 而且由于有着 &quot;后发优势&quot;, 能够做得往往比之前的老工具们更好, 更强大, 下表所示是 JCMD, JHSDB 与原基础工具实现相同功能的简要对比.</p> <p><img src="/img/Image00069-20240302133505-fir4zsg.jpg" alt=""></p> <p>本节的主题是<strong>可视化</strong>的故障处理, 所以 JCMD 及 JHSDB 的命令行模式就不再作重点讲解了, 读者可参考上一节的基础命令, 再借助它们在 JCMD 和 JHSDB 中的 help 去使用, 相信是很容易举一反三, 触类旁通的. 接下来通过一个实验来讲解 JHSDB 的图形模式下的功能.</p> <p><strong>JHSDB 是一款基于服务性代理(Serviceability Agent, SA)实现的进程外调试工具</strong>. 服务性代理是 HotSpot 虚拟机中一组用于映射 Java 虚拟机运行信息的, 主要基于 Java 语言(含少量 JNI 代码)实现的 API 集合. 服务性代理以 HotSpot 内部的数据结构为参照物进行设计, 把这些 C++ 的数据抽象出 Java 模型对象, 相当于 HotSpot 的 C++ 代码的一个镜像. 通过服务性代理的 API, 可以在一个独立的 Java 虚拟机的进程里分析其他 HotSpot 虚拟机的内部数据, 或者从 HotSpot 虚拟机进程内存中 dump 出来的转储快照里还原出它的运行状态细节. 服务性代理的工作原理跟 Linux 上的 GDB 或者 Windows 上的 Windbg 是相似的.</p> <blockquote><p>JHSDB查看对象内存位置示例</p></blockquote> <p>本次, 要借助 JHSDB 来分析一下下面的代码, 并通过实验来回答一个简单问题: staticObj, instanceObj, localObj 这三个变量本身(而不是它们所指向的对象)存放在哪里?</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
 * staticObj, instanceObj, localObj 存放在哪里? 
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">JHSDB_TestCase</span> <span class="token punctuation">{</span>

    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Test</span> <span class="token punctuation">{</span>
        <span class="token keyword">static</span> <span class="token class-name">ObjectHolder</span> staticObj <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectHolder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ObjectHolder</span> instanceObj <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectHolder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">void</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">ObjectHolder</span> localObj <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectHolder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;done&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 这里设一个断点</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">ObjectHolder</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Test</span> test <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JHSDB_TestCase<span class="token punctuation">.</span>Test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        test<span class="token punctuation">.</span><span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><p>答案读者当然都知道: staticObj 随着 Test 的类型信息存放在方法区, instanceObj 随着 Test 的对象实例存放在 Java 堆, localObject 则是存放在 foo() 方法栈帧的局部变量表中. 这个答案是通过前两章学习的理论知识得出的, 现在要做的是<strong>通过 JHSDB 来实践验证这一点</strong>.</p> <p>首先, 要确保这三个变量已经在内存中分配好, 然后将程序暂停下来, 以便有空隙进行实验, 这只要把断点设置在代码中的打印语句上, 然后在调试模式下运行程序即可. 本例中采用的运行参数如下:</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code><span class="token parameter variable">-Xmx10m</span> <span class="token parameter variable">-XX:+UseSerialGC</span> <span class="token parameter variable">-XX:-UseCompressedOops</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>程序执行后通过 jps 查询到测试程序的进程 ID, 具体如下:</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>jps <span class="token parameter variable">-l</span>
<span class="token number">8440</span> org.jetbrains.jps.cmdline.Launcher
<span class="token number">11180</span> JHSDB_TestCase
<span class="token number">15692</span> jdk.jcmd/sun.tools.jps.Jps
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>使用以下命令进入 JHSDB 的图形化模式, 并使其附加进程 11180:</p> <div class="language-ziti1 line-numbers-mode"><pre class="language-text"><code>jhsdb hsdb --pid 11180
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>命令打开的 JHSDB 的界面如下图所示.</p> <p><img src="/img/Image00070-20240302133505-nyoe3up.jpg" alt="" title="JHSDB 的界面"></p> <p>阅读代码可知, 运行至断点位置一共会创建三个 ObjectHolder 对象的实例, 只要是对象实例必然会在 Java 堆中分配, 既然要查找引用这三个对象的指针存放在哪里, 不妨从这三个对象开始着手, 先<strong>把它们从 Java 堆中找出来</strong>.</p> <p>首先点击菜单中的 Tools-&gt;Heap Parameters, 结果如下图所示, 因为笔者的运行参数中指定了使用的是 Serial 收集器, 图中看到了典型的 Serial 的分代内存布局, Heap Parameters 窗口中清楚列出了新生代的 Eden, S1, S2 和老年代的容量(单位为字节)以及它们的虚拟内存地址起止范围.</p> <p><img src="/img/Image00071-20240302133505-ixgzwbu.jpg" alt="" title="Serial 收集器的堆布局"></p> <p>如果读者实践时不指定收集器, 即使用 JDK 默认的 G1 的话, 得到的信息应该类似如下所示:</p> <div class="language-ziti1 line-numbers-mode"><pre class="language-text"><code>Heap Parameters:
garbage-first heap [0x00007f32c7800000, 0x00007f32c8200000] region size 1024K
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>请注意一下图中各个区域的内存地址范围, 后面还要用到它们. 打开 Windows-&gt;Console 窗口, 使用 scanoops 命令在 Java 堆的<strong>新生代</strong>(从 Eden 起始地址到 To Survivor 结束地址)范围内查找 ObjectHolder 的实例, 结果如下所示:</p> <div class="language-ziti1 line-numbers-mode"><pre class="language-text"><code>hsdb&gt;scanoops 0x00007f32c7800000 0x00007f32c7b50000 JHSDB_TestCase$ObjectHolder
0x00007f32c7a7c458 JHSDB_TestCase$ObjectHolder
0x00007f32c7a7c480 JHSDB_TestCase$ObjectHolder
0x00007f32c7a7c490 JHSDB_TestCase$ObjectHolder
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>果然找出了三个实例的地址, 而且它们的地址都落到了 Eden 的范围之内, 算是顺带验证了一般情况下新对象在 Eden 中创建的分配规则. 再使用 Tools-&gt;Inspector 功能确认一下这三个地址中存放的对象, 结果如下图所示.</p> <p><img src="/img/Image00072-20240302133505-xlhp4xa.jpg" alt="" title="查看对象实例数据"></p> <p>Inspector 展示了<strong>对象头和指向对象元数据的指针</strong>, 里面包括了 Java 类型的名字, 继承关系, 实现接口关系, 字段信息, 方法信息, 运行时常量池的指针, 内嵌的虚方法表(vtable)以及接口方法表(itable)等. 由于的确没有在 ObjectHolder 上定义过任何字段, 所以图中并没有看到任何实例字段数据, 在做实验时不妨定义一些不同数据类型的字段, 观察它们在 HotSpot 虚拟机里面是如何存储的.</p> <p>接下来要根据堆中对象实例地址找出引用它们的指针, 原本 JHSDB 的 Tools 菜单中有 Compute Reverse Ptrs 来完成这个功能, 这里改为<strong>使用命令</strong>来做也很简单, 先拿第一个对象来试试看:</p> <div class="language-ziti1 line-numbers-mode"><pre class="language-text"><code>hsdb&gt; revptrs 0x00007f32c7a7c458
Computing reverse pointers...
Done.
Oop for java/lang/Class @ 0x00007f32c7a7b180
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>果然找到了一个引用该对象的地方, 是在一个 java.lang.Class 的实例里, 并且给出了这个实例的地址, 通过 Inspector 查看该对象实例, 可以清楚看到这确实是一个 java.lang.Class 类型的对象实例, 里面有一个名为 staticObj 的实例字段, 如下图所示.</p> <p><img src="/img/Image00073-20240302133505-4f10gbt.jpg" alt="" title="Class 对象"></p> <p>从《Java 虚拟机规范》所定义的概念模型来看, 所有 Class 相关的信息都应该存放在方法区之中, 但方法区该如何实现, 《Java 虚拟机规范》并未做出规定, 这就成了一件允许不同虚拟机自己灵活把握的事情. JDK 7 及其以后版本的 HotSpot 虚拟机选择把静态变量与类型在 Java 语言一端的映射 Class 对象存放在一起, 存储于 Java 堆之中, 从实验中也明确验证了这一点.</p> <p>接下来继续查找第二个对象实例:</p> <div class="language-ziti1 line-numbers-mode"><pre class="language-text"><code>hsdb&gt;revptrs 0x00007f32c7a7c480
Computing reverse pointers...
Done.
Oop for JHSDB_TestCase$Test @ 0x00007f32c7a7c468
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>这次找到一个类型为 JHSDB_TestCase$Test 的对象实例, 在 Inspector 中该对象实例显示如下图所示.</p> <p><img src="/img/Image00074-20240302133505-qi87a82.jpg" alt="" title="JHSDB_TestCase$Test 对象"></p> <p>这个结果完全符合预期, 第二个 ObjectHolder 的指针是在 Java 堆中 JHSDB_TestCase$Test 对象的 instanceObj 字段上. 但是采用相同方法查找第三个 ObjectHolder 实例时, JHSDB 返回了一个 null, 表示未查找到任何结果:</p> <div class="language-ziti1 line-numbers-mode"><pre class="language-text"><code>hsdb&gt; revptrs 0x00007f32c7a7c490
null
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>看来 revptrs 命令并不支持查找栈上的指针引用, 不过没有关系, 得益于测试代码足够简洁, 人工也可以来完成这件事情. 在 Java Thread 窗口选中 main 线程后点击 Stack Memory 按钮查看该线程的栈内存, 如下图所示.</p> <p><img src="/img/Image00075-20240302133505-syxobpq.jpg" alt="" title="main 线程的栈内存"></p> <p>这个线程只有两个方法栈帧, 尽管没有查找功能, 但通过肉眼观察在地址 0x00007f32e771c998 上的值正好就是 0x00007f32c7a7c490, 而且 JHSDB 在旁边已经自动生成注释, 说明这里确实是引用了一个来自新生代的 <code>JHSDB_TestCase$ObjectHolder</code>​ 对象. 至此, 本次实验中三个对象均已找到, 并成功追溯到引用它们的地方, 也就实践验证了开篇中提出的这些对象的引用是存储在什么地方的问题.</p> <p>JHSDB 提供了非常强大且灵活的命令和功能, 本节的例子只是其中一个很小的应用, 读者在实际开发, 学习时, 可以用它来调试虚拟机进程或者 dump 出来的内存转储快照, 以积累更多的实际经验.</p> <h5 id="_2-jconsole-java监视与管理控制台"><a href="#_2-jconsole-java监视与管理控制台" class="header-anchor">#</a> 2.JConsole:Java监视与管理控制台</h5> <p>JConsole 是一款基于 JMX(Java Manage-ment Extensions)的可视化监视, 管理工具. 它的主要功能是<strong>通过 JMX 的 MBean(Managed Bean)对系统进行信息收集和参数动态调整</strong>. JMX 是一种开放性的技术, 不仅可以用在虚拟机本身的管理上, 还可以运行于虚拟机之上的软件中, 典型的如中间件大多也基于 JMX 来实现<strong>管理与监控</strong>. 虚拟机对 JMX MBean 的访问也是完全开放的, 可以使用代码调用 API, 支持 JMX 协议的管理控制台, 或者其他符合 JMX 规范的软件进行访问.</p> <p><img src="/img/Image00076-20240302133505-k9lurdv.jpg" alt="" title="JConsole 连接页面"></p> <blockquote><p>1.启动JConsole</p></blockquote> <p>通过 JDK/bin 目录下的 jconsole.exe 启动 JCon-sole 后, 会自动搜索出本机运行的所有虚拟机进程, 而不需要用户自己使用 jps 来查询, 如上图所示. 双击选择其中一个进程便可进入主界面开始监控. JMX 支持跨服务器的管理, 也可以使用下面的 &quot;远程进程&quot; 功能来连接远程服务器, 对远程虚拟机进行监控.</p> <p>图中可以看到运行了 Eclipse, JConsole, MonitoringTest 三个本地虚拟机进程, 这里 MonitoringTest 是本节准备的 &quot;反面教材&quot; 代码之一. 双击它进入 JConsole 主界面, 可以看到主界面里共包括 &quot;概述&quot;, &quot;内存&quot;, &quot;线程&quot;, &quot;类&quot;, &quot;VM 摘要&quot;, &quot;MBean&quot; 六个页签, 如下图所示.</p> <p><img src="/img/Image00077-20240302133505-actq3g1.jpg" alt="" title="JConsole 主界面"></p> <p>&quot;概述&quot; 页签里显示的是整个虚拟机主要运行数据的概览信息, 包括 &quot;堆内存使用情况&quot;, &quot;线程&quot;, &quot;类&quot;, &quot;CPU 使用情况&quot; 四项信息的曲线图, 这些曲线图是后面 &quot;内存&quot;, &quot;线程&quot;, &quot;类&quot; 页签的信息汇总, 具体内容将在稍后介绍.</p> <blockquote><p>2.内存监控</p></blockquote> <p><strong>&quot;内存&quot; 页签的作用相当于可视化的 jstat 命令, 用于监视被收集器管理的虚拟机内存(被收集器直接管理的 Java 堆和被间接管理的方法区)的变化趋势</strong>.</p> <p>下面通过运行代码来体验一下它的监视功能. 运行时设置的虚拟机参数为:</p> <div class="language-ziti1 line-numbers-mode"><pre class="language-text"><code>-Xms100m -Xmx100m -XX:+UseSerialGC
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><strong>JConsole 监视代码示例</strong></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
 * 内存占位符对象, 一个 OOMObject 大约占64KB
 */</span>
<span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">OOMObject</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> placeholder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token number">64</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">fillHeap</span><span class="token punctuation">(</span><span class="token keyword">int</span> num<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">OOMObject</span><span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">OOMObject</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> num<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 稍作延时, 令监视曲线的变化更加明显</span>
        <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">OOMObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">gc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token function">fillHeap</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><p>这段代码的作用是以 64KB/50ms 的速度向 Java 堆中填充数据, 一共填充 1000 次, 使用 JConsole 的 &quot;内存&quot; 页签进行监视, 观察曲线和柱状指示图的变化.</p> <p>程序运行后, 在 &quot;内存&quot; 页签中可以看到内存池 Eden 区的运行趋势呈现折线状, 如下图所示. 监视范围扩大至整个堆后, 会发现曲线是一直平滑向上增长的. 从柱状图可以看到, 在 1000 次循环执行结束, 运行了 System.gc() 后, 虽然整个新生代 Eden 和 Survivor 区都基本被清空了, 但是代表老年代的柱状图仍然保持峰值状态, 说明被填充进堆中的数据在 System.gc() 方法执行之后仍然存活. 这里提两个小问题:</p> <p>(1) 虚拟机启动参数只限制了 Java 堆为 100MB, 但没有明确使用 -Xmn 参数指定新生代大小, 读者能否从监控图中估算出新生代的容量?</p> <p>(2) 为何执行了 System.gc() 之后, 下图中代表老年代的柱状图仍然显示峰值状态, 代码需要如何调整才能让 System.gc() 回收掉填充到堆中的对象?</p> <p><img src="/img/Image00078-20240302133505-73bqlzd.jpg" alt="" title="Eden 区内存变化状况"></p> <p>问题 1 答案: 上图显示 Eden 空间为 27328KB, 因为没有设置 <code>-XX: SurvivorRadio</code>​ 参数, 所以 Eden 与 Survivor 空间比例的默认值为 8∶1, 因此整个新生代空间大约为 27328KB×125%=34160KB.</p> <p>问题 2 答案: 执行 System.gc() 之后, 空间未能回收是因为 <code>List&lt;OOMObject&gt;list</code>​ 对象仍然存活, fillHeap() 方法仍然没有退出, 因此 list 对象在 System.gc() 执行时仍然处于作用域之内. 如果把 System.gc() 移动到 fillHeap() 方法外调用就可以回收掉全部内存.</p> <blockquote><p>3.线程监控</p></blockquote> <p>如果说 JConsole 的 &quot;内存&quot; 页签相当于可视化的 jstat 命令的话, 那  <strong>&quot;线程&quot; 页签的功能就相当于可视化的 jstack 命令了</strong>, 遇到线程停顿的时候可以使用这个页签的功能进行分析. 前面讲解 jstack 命令时提到线程长时间停顿的主要原因有等待外部资源(数据库连接, 网络资源, 设备资源等), 死循环, 锁等待等, 下面将分别演示这几种情况.</p> <p><strong>代码清单4-8　线程等待演示代码</strong></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
 * 线程死循环演示
 */</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">createBusyThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token class-name">Thread</span> thread <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>   <span class="token comment">// 第41行</span>
            <span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;testBusyThread&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
thread<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 * 线程锁等待演示
 */</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">createLockThread</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">Object</span> lock<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token class-name">Thread</span> thread <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>lock<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                lock<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;testLockThread&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
thread<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token class-name">BufferedReader</span> br <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BufferedReader</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">InputStreamReader</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span>in<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    br<span class="token punctuation">.</span><span class="token function">readLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">createBusyThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    br<span class="token punctuation">.</span><span class="token function">readLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Object</span> obj <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">createLockThread</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br></div></div><p>程序运行后, 首先在 &quot;线程&quot; 页签中选择 main 线程. 堆栈追踪显示 BufferedReader 的 readBytes() 方法正在等待 System.in 的键盘输入, 这时候线程为 Runnable 状态, Runnable 状态的线程仍会被分配运行时间, 但 readBytes() 方法检查到流没有更新就会立刻归还执行令牌给操作系统, 这种等待只消耗很小的处理器资源.</p> <p>接着监控 testBusyThread 线程, 如下图所示. testBusyThread 线程一直在执行空循环, 从堆栈追踪中看到一直在 MonitoringTest.java 代码的 41 行停留, 41 行的代码为 while(true). 这时候线程为 Runnable 状态, 而且没有归还线程执行令牌的动作, 所以会在空循环耗尽操作系统分配给它的执行时间, 直到线程切换为止, 这种等待会消耗大量的处理器资源.</p> <p><img src="/img/Image00079-20240302133505-9f9nrxp.jpg" alt="" title="main 线程"></p> <p><img src="/img/Image00080-20240302133505-cduoh9m.jpg" alt="" title="testBusyThread 线程"></p> <p>下图显示 testLockThread 线程在等待 lock 对象的 notify() 或 notifyAll() 方法的出现, 线程这时候处于 WAITING 状态, 在重新唤醒前不会被分配执行时间.</p> <p><img src="/img/Image00081-20240302133505-n1s2227.jpg" alt="" title="testLockThread 线程"></p> <p>testLockThread 线程正处于正常的活锁等待中, 只要 lock 对象的 notify() 或 notifyAll() 方法被调用, 这个线程便能激活继续执行. 下面演示了一个无法再被激活的死锁等待.</p> <p><strong>死锁代码样例</strong></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
 * 线程死锁等待演示
 */</span>
<span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">SynAddRunalbe</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> a<span class="token punctuation">,</span> b<span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token class-name">SynAddRunalbe</span><span class="token punctuation">(</span><span class="token keyword">int</span> a<span class="token punctuation">,</span> <span class="token keyword">int</span> b<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>a <span class="token operator">=</span> a<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>b <span class="token operator">=</span> b<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>a <span class="token operator">+</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">100</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">SynAddRunalbe</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">SynAddRunalbe</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><p>这段代码开了 200 个线程去分别计算 1 + 2 以及 2 + 1 的值, 理论上 for 循环都是可省略的, 两个线程也可能会导致死锁, 不过那样概率太小, 需要尝试运行很多次才能看到死锁的效果. 如果运气不是特别差的话, 上面带 for 循环的版本最多运行两三次就会遇到线程死锁, 程序无法结束. 造成死锁的根本原因是 Integer.valueOf() 方法出于减少对象创建次数和节省内存的考虑, 会对数值为 -128～127 之间的 Integer 对象进行缓存, 如果 valueOf() 方法传入的参数在这个范围之内, 就直接返回缓存中的对象. 也就是说代码中尽管调用了 200 次 Integer.valueOf() 方法, 但一共只返回了两个不同的 Integer 对象. 假如某个线程的两个 synchronized 块之间发生了一次线程切换, 那就会出现线程 A 在等待被线程 B 持有的 Integer.valueOf(1), 线程 B 又在等待被线程 A 持有的 Integer.valueOf(2), 结果大家都跑不下去的情况.</p> <p>出现线程死锁之后, 点击 JConsole 线程面板的 &quot;检测到死锁&quot; 按钮, 将出现一个新的 &quot;死锁&quot; 页签, 如下图所示.</p> <p><img src="/img/Image00082-20240302133505-2kuy08e.jpg" alt="" title="线程死锁"></p> <p>图中很清晰地显示, 线程 Thread-43 在等待一个被线程 Thread-12 持有的 Integer 对象, 而点击线程 Thread-12 则显示它也在等待一个被线程 Thread-43 持有的 Integer 对象, 这样两个线程就互相卡住, 除非牺牲其中一个, 否则死锁无法释放.</p> <h5 id="_3-visualvm-多合一故障处理工具"><a href="#_3-visualvm-多合一故障处理工具" class="header-anchor">#</a> 3.VisualVM:多合一故障处理工具</h5> <p>VisualVM(All-in-One Java Troubleshooting Tool)是功能<strong>最强大</strong>的运行监视和故障处理程序之一, 曾经在很长一段时间内是 Oracle 官方主力发展的虚拟机故障处理工具. Oracle 曾在 VisualVM 的软件说明中写上了 &quot;All-in-One&quot; 的字样, 预示着它除了常规的运行监视, 故障处理外, 还将提供其他方面的能力, 譬如<strong>性能分析</strong>(Profiling). VisualVM 还有一个很大的优点: 不需要被监视的程序基于特殊 Agent 去运行, 因此它的通用性很强, 对应用程序实际性能的影响也较小, 使得它可以直接应用在生产环境中.</p> <blockquote><p>1.VisualVM兼容范围与插件安装</p></blockquote> <p>VisualVM 基于 NetBeans 平台开发工具, 所以一开始它就具备了<strong>通过插件扩展功能的能力</strong>, 有了插件扩展支持, VisualVM 可以做到:</p> <ul><li>显示虚拟机进程以及进程的配置, 环境信息(jps, jinfo).</li> <li>监视应用程序的处理器, 垃圾收集, 堆, 方法区以及线程的信息(jstat, jstack).</li> <li>dump 以及分析堆转储快照(jmap, jhat).</li> <li>方法级的程序运行性能分析, 找出被调用最多, 运行时间最长的方法.</li> <li>离线程序快照: 收集程序的运行时配置, 线程 dump, 内存 dump 等信息建立一个快照, 可以将快照发送开发者处进行 Bug 反馈.</li> <li>其他插件带来的无限可能性.</li></ul> <p>首次启动 VisualVM 后, 读者先不必着急找应用程序进行监测, 初始状态下的 VisualVM 并没有加载任何插件, 虽然基本的监视, 线程面板的功能主程序都以默认插件的形式提供, <strong>但是如果不在 VisualVM 上装任何扩展插件, 就相当于放弃它最精华的功能</strong>, 和没有安装任何应用软件的操作系统差不多.</p> <p>VisualVM 的插件可以手工进行安装, 在网站上下载 nbm 包后, 点击 &quot;工具-&gt;插件-&gt;已下载&quot; 菜单, 然后在弹出对话框中指定 nbm 包路径便可完成安装. 独立安装的插件存储在 VisualVM 的根目录, 譬如 JDK 9之前自带的 VisulalVM, 插件安装后是放在 <code>JDK_HOME/lib/visualvm</code>​ 中的. 手工安装插件并不常用, VisualVM 的自动安装功能已可找到大多数所需的插件, 在有网络连接的环境下, 点击 &quot;工具-&gt;插件菜单&quot;, 弹出如下图所示的插件页签, 在页签的 &quot;可用插件&quot; 及 &quot;已安装&quot; 中列举了当前版本 VisualVM 可以使用的全部插件, 选中插件后在右边窗口会显示这个插件的基本信息, 如开发者, 版本, 功能描述等.</p> <p><img src="/img/Image00085-20240302133505-wjetdgo.jpg" alt="" title="VisualVM 插件页签"></p> <p>读者可根据自己的工作需要和兴趣选择合适的插件, 然后点击 &quot;安装&quot; 按钮, 跟着提示操作即可完成安装.</p> <p>选择一个需要监视的程序就可以进入程序的主界面了, 如下图所示. 由于 VisualVM 的版本以及选择安装插件数量的不同, 所以看到的页签可能和笔者的截图有所差别.</p> <p><img src="/img/Image00087-20240302133505-zzim8vj.jpg" alt="" title="VisualVM 主界面"></p> <p>VisualVM 中 &quot;概述&quot;, &quot;监视&quot;, &quot;线程&quot;, &quot;MBeans&quot; 的功能与前面介绍的 JConsole 差别不大, 读者可根据上一节内容类比使用, 这里挑选几个有特色的功能和插件进行简要介绍.</p> <blockquote><p>2.生成, 浏览堆转储快照</p></blockquote> <p>在 VisualVM 中<strong>生成堆转储快照文件</strong>有两种方式, 可以执行下列任一操作:</p> <ul><li>在 &quot;应用程序&quot; 窗口中右键单击应用程序节点, 然后选择 &quot;堆 Dump&quot;.</li> <li>在 &quot;应用程序&quot; 窗口中双击应用程序节点以打开应用程序标签, 然后在 &quot;监视&quot; 标签中单击 &quot;堆 Dump&quot;.</li></ul> <p>生成堆转储快照文件之后, 应用程序页签会在该堆的应用程序下增加一个以 <code>[heap-dump]</code>​ 开头的子节点, 并且在主页签中打开该转储快照, 如下图所示. 如果需要把堆转储快照保存或发送出去, 就应在 heapdump 节点上右键选择 &quot;另存为&quot; 菜单, 否则当 VisualVM 关闭时, 生成的堆转储快照文件会被当作临时文件自动清理掉. 要打开一个由已经存在的堆转储快照文件, 通过文件菜单中的 &quot;装入&quot; 功能, 选择硬盘上的文件即可.</p> <p><img src="/img/Image00088-20240302133505-kxi762s.jpg" alt="" title="浏览 dump 文件"></p> <p>堆页签中的 &quot;摘要&quot; 面板可以看到应用程序 dump 时的运行时参数, System.getProperties() 的内容, 线程堆栈等信息; &quot;类&quot; 面板则是以类为统计口径统计类的实例数量, 容量信息; &quot;实例&quot; 面板不能直接使用, 因为 VisualVM 在此时还无法确定用户想查看哪个类的实例, 所以需要通过 &quot;类&quot; 面板进入, 在 &quot;类&quot; 中选择一个需要查看的类, 然后双击即可在 &quot;实例&quot; 里面看到此类的其中 500 个实例的具体属性信息; &quot;OQL 控制台&quot; 面板则是运行 OQL 查询语句的, 同 jhat 中介绍的 OQL 功能一样.</p> <blockquote><p>3.分析程序性能</p></blockquote> <p>在 Profiler 页签中, VisualVM 提供了<strong>程序运行期间方法级的处理器执行时间分析以及内存分析</strong>. 做 Profiling 分析肯定会对程序运行性能有比较大的影响, 所以<strong>一般不在生产环境使用这项功能</strong>, 或者改用 JMC 来完成, JMC 的 Profiling 能力更强, 对应用的影响非常轻微.</p> <p>要开始性能分析, 先选择 &quot;CPU&quot; 和 &quot;内存&quot; 按钮中的一个, 然后切换到应用程序中对程序进行操作, VisualVM 会记录这段时间中应用程序执行过的所有方法. 如果是进行处理器执行时间分析, 将会统计每个方法的执行次数, 执行耗时; 如果是内存分析, 则会统计每个方法关联的对象数以及这些对象所占的空间. 等要分析的操作执行结束后, 点击 &quot;停止&quot; 按钮结束监控过程, 如下图所示.</p> <p><img src="/img/Image00089-20240302133505-iqr9ip1.jpg" alt="" title="对应用程序进行 CPU 执行时间分析"></p> <p>图中是对 Eclipse IDE 一段操作的录制和分析结果, 读者分析自己的应用程序时, 可根据实际业务复杂程度与方法的时间, 调用次数做比较, 找到最优化价值方法.</p> <blockquote><p>4.BTrace动态日志跟踪</p></blockquote> <p>BTrace 是一个很神奇的 VisualVM 插件, 它本身也是一个可运行的独立程序. BTrace 的作用是在不中断目标程序运行的前提下, <strong>通过 HotSpot 虚拟机的 Instrument 功能动态加入原本并不存在的调试代码</strong>. 这项功能对实际生产中的程序很有意义: 如当程序出现问题时, 排查错误的一些必要信息时(譬如方法参数, 返回值等), 在开发时并没有打印到日志之中以至于不得不停掉服务时, 都可以通过调试增量来加入日志代码以解决问题.</p> <p>在 VisualVM 中安装了 BTrace 插件后, 在应用程序面板中右击要调试的程序, 会出现 &quot;Trace Application...&quot; 菜单, 点击将进入 BTrace 面板. 这个面板看起来就像一个简单的 Java 程序开发环境, 里面甚至已经有了一小段 Java 代码, 如下图所示.</p> <p><img src="/img/Image00090-20240302133505-c9ih9er.jpg" alt="" title="BTrace 动态跟踪"></p> <p>下面准备了一段简单的 Java 代码来演示 BTrace 的功能: 产生两个 1000 以内的随机整数, 输出这两个数字相加的结果.</p> <p>B<strong>Trace 跟踪演示代码</strong></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">BTraceTest</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">int</span> a<span class="token punctuation">,</span> <span class="token keyword">int</span> b<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> a <span class="token operator">+</span> b<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        <span class="token class-name">BTraceTest</span> test <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BTraceTest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">BufferedReader</span> reader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BufferedReader</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">InputStreamReader</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span>in<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            reader<span class="token punctuation">.</span><span class="token function">readLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> a <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">round</span><span class="token punctuation">(</span><span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> b <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">round</span><span class="token punctuation">(</span><span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>test<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>假设这段程序已经上线运行, 而现在又有了新的需求, 想要知道<strong>程序中生成的两个随机数是什么</strong>, 但程序并没有在执行过程中输出这一点. 此时, 在 VisualVM 中打开该程序的监视, 在 BTrace 页签填充 TracingScript 的内容, 输入调试代码, 如下所示, 即可<strong>在不中断程序运行的情况下</strong>做到这一点.</p> <p><strong>BTrace 调试代码示例</strong></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/* BTrace Script Template */</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>sun<span class="token punctuation">.</span>btrace<span class="token punctuation">.</span>annotations<span class="token punctuation">.</span></span><span class="token operator">*</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token keyword">static</span> <span class="token import static"><span class="token namespace">com<span class="token punctuation">.</span>sun<span class="token punctuation">.</span>btrace<span class="token punctuation">.</span></span><span class="token class-name">BTraceUtils</span><span class="token punctuation">.</span><span class="token operator">*</span></span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@BTrace</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TracingScript</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@OnMethod</span><span class="token punctuation">(</span>
        clazz<span class="token operator">=</span><span class="token string">&quot;org.fenixsoft.monitoring.BTraceTest&quot;</span><span class="token punctuation">,</span>
        method<span class="token operator">=</span><span class="token string">&quot;add&quot;</span><span class="token punctuation">,</span>
        location<span class="token operator">=</span><span class="token annotation punctuation">@Location</span><span class="token punctuation">(</span><span class="token class-name">Kind</span><span class="token punctuation">.</span><span class="token constant">RETURN</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">func</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Self</span> <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>fenixsoft<span class="token punctuation">.</span>monitoring<span class="token punctuation">.</span></span>BTraceTest</span> instance<span class="token punctuation">,</span><span class="token keyword">int</span> a<span class="token punctuation">,</span> <span class="token keyword">int</span> b<span class="token punctuation">,</span><span class="token annotation punctuation">@Return</span> <span class="token keyword">int</span> result<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;调用堆栈:&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">jstack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">println</span><span class="token punctuation">(</span><span class="token function">strcat</span><span class="token punctuation">(</span><span class="token string">&quot;方法参数 A:&quot;</span><span class="token punctuation">,</span> <span class="token function">str</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">println</span><span class="token punctuation">(</span><span class="token function">strcat</span><span class="token punctuation">(</span><span class="token string">&quot;方法参数 B:&quot;</span><span class="token punctuation">,</span> <span class="token function">str</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">println</span><span class="token punctuation">(</span><span class="token function">strcat</span><span class="token punctuation">(</span><span class="token string">&quot;方法结果:&quot;</span><span class="token punctuation">,</span> <span class="token function">str</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>点击 Start 按钮后稍等片刻, 编译完成后, Output 面板中会出现 &quot;BTrace code successfuly deployed&quot; 的字样. 当程序运行时将会在 Output 面板输出如下图所示的调试信息.</p> <p><img src="/img/Image00091-20240302133505-qrows4u.jpg" alt="" title="BTrace 跟踪结果"></p> <p><strong>BTrace 的用途很广泛, 打印调用堆栈, 参数, 返回值</strong>只是它最基础的使用形式, 在它的网站上有使用 BTrace 进行性能监视, 定位连接泄漏, 内存泄漏, 解决多线程竞争问题等的使用案例.</p> <p>BTrace 能够实现动态修改程序行为, 是因为它是基于 Java 虚拟机的 Instrument 开发的. Instrument 是 Java 虚拟机工具接口(Java Virtual Machine Tool Interface, JVMTI)的重要组件, 提供了一套代理(Agent)机制, 使得第三方工具程序可以以代理的方式访问和修改 Java 虚拟机内部的数据. <mark><strong>阿里巴巴开源的诊断工具 Arthas 也通过 Instrument 实现了与 BTrace 类似的功能</strong></mark>. 参考: Javaagent.</p> <h4 id="hotspot虚拟机插件及工具"><a href="#hotspot虚拟机插件及工具" class="header-anchor">#</a> HotSpot虚拟机插件及工具</h4> <p>HotSpot 虚拟机发展了二十余年, 现在已经是一套很复杂的软件系统, 如果深入挖掘 HotSpot 的源码, 可以发现在 HotSpot 的研发过程中, 开发团队曾经编写(或者收集)过不少虚拟机的<strong>插件和辅助工具</strong>, 它们存放在 HotSpot 源码 <code>hotspot/src/share/tools</code>​ 目录下, 包括(含曾经有过但新版本中已被移除的):</p> <ul><li>Ideal Graph Visualizer: 用于可视化展示 C2 即时编译器是如何将字节码转化为理想图, 然后转化为机器码的.</li> <li>Client Compiler Visualizer: 用于查看 C1 即时编译器生成高级中间表示(HIR), 转换成低级中间表示(LIR)和做物理寄存器分配的过程.</li> <li>Project Creator: 帮忙生成 Visual Studio 的.project 文件的工具.</li> <li>LogCompilation: 将 <code>-XX: +LogCompilation</code>​ 输出的日志整理成更容易阅读的格式的工具.</li> <li>HSDIS: 即时编译器的反汇编插件.</li></ul> <p>最后一个 HSDIS 是学习, 实践本书第四部分 &quot;程序编译与代码优化&quot; 的有力辅助工具, 借本章讲解虚拟机工具的机会, 简要介绍其使用方法.</p> <h5 id="_1-hsdis-jit生成代码反汇编"><a href="#_1-hsdis-jit生成代码反汇编" class="header-anchor">#</a> 1.HSDIS:JIT生成代码反汇编</h5> <p>在《Java 虚拟机规范》里详细定义了<strong>虚拟机指令集中每条指令的语义</strong>, 尤其是执行过程前后对操作数栈, 局部变量表的影响. 这些细节描述与早期 Java 虚拟机(Sun Classic 虚拟机)高度吻合, 但随着技术的发展, 高性能虚拟机真正的细节实现方式已经渐渐与《Java 虚拟机规范》所描述的内容产生越来越大的偏差, 《Java 虚拟机规范》中的规定逐渐成为 Java 虚拟机实现的 &quot;概念模型&quot;, 即实现只保证与规范描述等效, 而不一定是按照规范描述去执行. 由于这个原因, 在讨论程序的执行语义问题(虚拟机做了什么)时, 在字节码层面上分析完全可行, 但讨论程序的执行行为问题(虚拟机是怎样做的, 性能如何)时, 在字节码层面上分析就没有什么意义了, 必须通过其他途径解决.</p> <p>至于<strong>分析程序如何执行</strong>, 使用软件调试工具(GDB, Windbg 等)来进行断点调试是一种常见的方式, 但是这样的调试方式在 Java 虚拟机中也遇到了很大麻烦, 因为大量执行代码是通过即时编译器动态生成到代码缓存中的, 并没有特别简单的手段来处理这种混合模式的调试, 不得不通过一些曲线的间接方法来解决问题. 在这样的背景下, 本节的主角——HSDIS 插件就正式登场了.</p> <p><strong>HSDIS 是一个被官方推荐的 HotSpot 虚拟机即时编译代码的反汇编插件</strong>, 它包含在 HotSpot 虚拟机的源码当中也可以找到单独的源码下载, 但并没有提供编译后的程序.</p> <p>HSDIS 插件的作用是让 HotSpot 的 <code>-XX: +PrintAssembly</code>​ 指令调用它来<strong>把即时编译器动态生成的本地代码还原为汇编代码输出, 同时还会自动产生大量非常有价值的注释</strong>, 这样就可以通过输出的汇编代码来从最本质的角度分析问题. 读者可以根据自己的操作系统和处理器型号, 从网上直接搜索, 下载编译好的插件, 直接放到 <code>JDK_HOME/jre/bin/server</code>​ 目录(JDK 9以下)或 <code>JDK_HOME/lib/amd64/server</code>​(JDK 9 或以上)中即可使用. 如果读者确实没有找到所采用操作系统的对应编译成品, 那就自己用源码编译一遍(网上能找到各种操作系统下的编译教程).</p> <p>下面简单演示一下如何使用这个插件.</p> <p><strong>测试代码</strong></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Bar</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> a <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">static</span> <span class="token keyword">int</span> b <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">int</span> c<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> a <span class="token operator">+</span> b <span class="token operator">+</span> c<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">new</span> <span class="token class-name">Bar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sum</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p><strong>编译</strong>这段代码, 并使用以下命令执行:</p> <div class="language-ziti1 line-numbers-mode"><pre class="language-text"><code>java -XX:+PrintAssembly -Xcomp -XX:CompileCommand=dontinline,*Bar.sum -XX:Compile-Command=compileonly,*Bar.sum test.Bar
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>其中, 参数 -Xcomp 是让虚拟机<strong>以编译模式执行代码</strong>, 这样不需要执行足够次数来预热就能触发即时编译. 两个 <code>-XX: CompileCommand</code>​ 的意思是让编译器不要内联 sum() 并且只编译 sum(), <code>-XX: +PrintAssembly</code>​ 就是输出反汇编内容. 如果一切顺利, 屏幕上会出现类似下面代码所示的内容.</p> <p><strong>测试代码</strong></p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code><span class="token punctuation">[</span>Disassembling <span class="token keyword">for</span> <span class="token assign-left variable">mach</span><span class="token operator">=</span><span class="token string">'i386'</span><span class="token punctuation">]</span>
<span class="token punctuation">[</span>Entry Point<span class="token punctuation">]</span>
<span class="token punctuation">[</span>Constants<span class="token punctuation">]</span>
    <span class="token comment"># {method} 'sum' '(I)I' in 'test/Bar'</span>
    <span class="token comment"># this:     ecx       = 'test/Bar'</span>
    <span class="token comment"># parm0:    edx       = int</span>
    <span class="token comment">#           [sp+0x20]  (sp of caller)</span>
    <span class="token punctuation">..</span><span class="token punctuation">..</span>
    0x01cac407: <span class="token function">cmp</span>    0x4<span class="token punctuation">(</span>%ecx<span class="token punctuation">)</span>,%eax
    0x01cac40a: jne    0x01c6b050               <span class="token punctuation">;</span> <span class="token punctuation">{</span>runtime_call<span class="token punctuation">}</span>
<span class="token punctuation">[</span>Verified Entry Point<span class="token punctuation">]</span>
    0x01cac410: mov    %eax,-0x8000<span class="token punctuation">(</span>%esp<span class="token punctuation">)</span>
    0x01cac417: push   %ebp
    0x01cac418: sub    <span class="token variable">$0x18</span>,%esp               <span class="token punctuation">;</span> *aload_0
                                                <span class="token punctuation">;</span> - test.Bar::sum@0 <span class="token punctuation">(</span>line  <span class="token number">8</span><span class="token punctuation">)</span>
    <span class="token punctuation">;</span><span class="token punctuation">;</span>  block B0 <span class="token punctuation">[</span><span class="token number">0</span>, <span class="token number">10</span><span class="token punctuation">]</span>

    0x01cac41b: mov    0x8<span class="token punctuation">(</span>%ecx<span class="token punctuation">)</span>,%eax   <span class="token punctuation">;</span> *getfield a
                                        <span class="token punctuation">;</span> - test.Bar::sum@1 <span class="token punctuation">(</span>line <span class="token number">8</span><span class="token punctuation">)</span>
    0x01cac41e: mov    <span class="token variable">$0x3d2fad8</span>,%esi  <span class="token punctuation">;</span> <span class="token punctuation">{</span>oop<span class="token punctuation">(</span>a
<span class="token string">'java/lang/Class'</span> <span class="token operator">=</span> <span class="token string">'test/Bar'</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
    0x01cac423: mov    0x68<span class="token punctuation">(</span>%esi<span class="token punctuation">)</span>,%esi  <span class="token punctuation">;</span> *getstatic b
                                        <span class="token punctuation">;</span> - test.Bar::sum@4 <span class="token punctuation">(</span>line <span class="token number">8</span><span class="token punctuation">)</span>
    0x01cac426: <span class="token function">add</span>    %esi,%eax
    0x01cac428: <span class="token function">add</span>    %edx,%eax
    0x01cac42a: <span class="token function">add</span>    <span class="token variable">$0x18</span>,%esp
    0x01cac42d: pop    %ebp
    0x01cac42e: <span class="token builtin class-name">test</span>   %eax,0x2b0100    <span class="token punctuation">;</span> <span class="token punctuation">{</span>poll_return<span class="token punctuation">}</span>
    0x01cac434: ret
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br></div></div><p>虽然是汇编, 但代码并不多, 一句一句来阅读:</p> <p>(1) <code>mov%eax, -0x8000(%esp)</code>​: 检查栈溢.</p> <p>(2) <code>push%ebp</code>​: 保存上一栈帧基址.</p> <p>(3) <code>sub$0x18, %esp</code>​: 给新帧分配空间.</p> <p>(4) <code>mov 0x8(%ecx), %eax</code>​: 取实例变量 a, 这里 <code>0x8(%ecx)</code>​ 就是 <code>ecx+0x8</code>​ 的意思, 前面代码片段 &quot;<code>[Constants]</code>​&quot; 中提示了 &quot;<code>this: ecx='test/Bar'</code>​&quot;, 即 ecx 寄存器中放的就是 this 对象的地址. 偏移 0x8 是越过 this 对象的对象头, 之后就是实例变量 a 的内存位置. 这次是访问 Java 堆中的数据.</p> <p>(5) <code>mov$0x3d2fad8, %esi</code>​: 取 test.Bar 在方法区的指针.</p> <p>(6) <code>mov 0x68(%esi), %esi</code>​: 取类变量 b, 这次是访问方法区中的数据.</p> <p>(7) <code>add%esi, %eax, add%edx, %eax</code>​: 做 2 次加法, 求 a+b+c 的值, 前面的代码把 a 放在 eax 中, 把 b 放在 esi 中, 而 c 在 <code>[Constants]</code>​ 中提示了, &quot;<code>parm0: edx=int</code>​&quot;, 说明 c 在 edx 中.</p> <p>(8) <code>add$0x18, %esp</code>​: 撤销栈帧.</p> <p>(9) <code>pop%ebp</code>​: 恢复上一栈帧.</p> <p>(10) <code>test%eax, 0x2b0100</code>​: 轮询方法返回处的 SafePoint.</p> <p>(11) <code>ret</code>​: 方法返回.</p> <p>在这个例子中测试代码比较简单, 肉眼直接看日志中的汇编输出是可行的, 但在正式环境中 <code>-XX: +PrintAssembly</code>​ 的日志输出量巨大, 且难以和代码对应起来, 这就必须<strong>使用工具来辅助</strong>了.</p> <p><strong>JITWatch 是 HSDIS 经常搭配使用的可视化的编译日志分析工具</strong>, 为便于在 JITWatch 中读取, 读者可使用以下参数把日志输出到 logfile 文件:</p> <div class="language-ziti1 line-numbers-mode"><pre class="language-text"><code>-XX:+UnlockDiagnosticVMOptions
-XX:+TraceClassLoading
-XX:+LogCompilation
-XX:LogFile=/tmp/logfile.log
-XX:+PrintAssembly
-XX:+TraceClassLoading
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>在 JITWatch 中加载日志后, 就可以看到<strong>执行期间使用过的各种对象类型和对应调用过的方法</strong>了, 界面如下图所示.</p> <p><img src="/img/Image00096-20240302133505-89hwmkk.jpg" alt="" title="JITWatch 主界面"></p> <p>选择想要查看的类和方法, 即可查看对应的 Java 源代码, 字节码和即时编译器生成的汇编代码, 如下图所示.</p> <p><img src="/img/Image00097-20240302133505-dk5dhdk.jpg" alt="" title="查看方法代码"></p> <h4 id="堆转储文件"><a href="#堆转储文件" class="header-anchor">#</a> 堆转储文件</h4> <h5 id="_1-基础"><a href="#_1-基础" class="header-anchor">#</a> 1.基础</h5> <p><strong>Heap Dump</strong> 也叫<strong>堆转储文件</strong>, 是一个 Java 进程在<strong>某个时间点上的内存快照</strong>. Heap Dump 有多种类型, 不过总体上 Heap Dump 在触发快照的时候都保存了 Java 对象和类的信息. <strong>通常在写 Heap Dump 文件前会触发一次 Full GC, 所以 Heap Dump 文件中保存的是 Full GC 后留下的对象信息</strong>.</p> <blockquote><p>堆转储文件的用途</p></blockquote> <p>一般在 Heap Dump 文件中可以获取到如下信息:</p> <ul><li><strong>对象信息</strong>: 类, 成员变量, 直接量以及引用值.</li> <li><strong>类信息</strong>: 类加载器, 名称, 超类, 静态成员.</li> <li><strong>GC Roots</strong>: JVM 可达的对象.</li> <li><strong>线程栈以及本地变量</strong>: 获取快照时的线程栈信息, 以及局部变量的详细信息.</li></ul> <p>因此可以分析如下问题:</p> <ul><li>找出<strong>内存泄漏</strong>的原因.</li> <li>找出重复引用的 jar 或类.</li> <li>分析<strong>类加载器</strong>.</li></ul> <p>对 Heap Dump 的分析就是对应用的内存使用情况进行分析, 从而更加合理地使用内存.</p> <h5 id="_2-获取堆转储文件"><a href="#_2-获取堆转储文件" class="header-anchor">#</a> 2.获取堆转储文件</h5> <p>(1) <strong>设置虚拟机参数 -XX:+HeapDumpOnOutOfMemoryError</strong>: 设置此参数可以在发生 <strong>OutOfMemoryError</strong> 后获取到一份 HPROF 二进制 Heap Dump 文件.</p> <p>可以设置<strong>内存溢出自动导出</strong> dump 文件(内存很大的时候, 可能会导不出来).</p> <ol><li><strong>-XX:+HeapDumpOnOutOfMemoryError</strong></li> <li><strong>-XX:HeapDumpPath=Path(文件保存路径)</strong></li></ol> <p>(2) <strong>使用 jmap 工具</strong>(参考: jmap:Java内存映像工具).</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>jmap <span class="token operator">-</span>dump<span class="token operator">:</span>format<span class="token operator">=</span>b<span class="token punctuation">,</span>file<span class="token operator">=</span><span class="token generics"><span class="token punctuation">&lt;</span>filename<span class="token punctuation">.</span>hprof<span class="token punctuation">&gt;</span></span> <span class="token generics"><span class="token punctuation">&lt;</span>pid<span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>(3) <strong>使用 JConsole 工具</strong>(参考: JConsole).</p> <h4 id="虚拟机及垃圾收集器日志"><a href="#虚拟机及垃圾收集器日志" class="header-anchor">#</a> 虚拟机及垃圾收集器日志</h4> <h6 id="_1-日志收集配置"><a href="#_1-日志收集配置" class="header-anchor">#</a> (1)日志收集配置</h6> <p>阅读分析虚拟机和垃圾收集器的日志是<strong>处理 Java 虚拟机内存问题</strong>必备的基础技能, 垃圾收集器日志是一系列人为设定的规则, 多少有点随开发者编码时的心情而定, 没有任何的 &quot;业界标准&quot; 可言, 换句话说, <strong>每个收集器的日志格式都可能不一样</strong>. 除此以外还有一个麻烦, 在 JDK 9 以前, HotSpot 并没有提供统一的日志处理框架, 虚拟机各个功能模块的日志开关分布在不同的参数上, 日志级别, 循环日志大小, 输出格式, 重定向等设置在不同功能上都要单独解决. 直到 JDK 9, 这种混乱不堪的局面才终于消失, HotSpot 所有功能的日志都收归到了 &quot;<code>-Xlog</code>​&quot; 参数上, 这个参数的能力也相应被极大拓展了:</p> <div class="language-ziti1 line-numbers-mode"><pre class="language-text"><code>-Xlog[:[selector][:[output][:[decorators][:output-options]]]]
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><strong>命令行中最关键的参数是选择器(Selector), 它由标签(Tag)和日志级别(Level)共同组成</strong>. 标签可理解为虚拟机中某个<strong>功能模块</strong>的名字, 它告诉日志框架用户希望得到虚拟机哪些功能的日志输出. 垃圾收集器的标签名称为 &quot;gc&quot;, 由此可见, 垃圾收集器日志只是 HotSpot 众多功能日志的其中一项, 全部支持的功能模块标签名如下所示:</p> <div class="language-ziti1 line-numbers-mode"><pre class="language-text"><code>add, age, alloc, annotation, aot, arguments, attach, barrier, biasedlocking, blocks, bot, breakpoint, bytecode, census, class, classhisto, cleanup, compaction, comparator, constraints, constantpool, coops, cpu, cset, data, defaultmethods, dump, ergo, event, exceptions, exit, fingerprint, freelist, gc, hashtables, heap, humongous, ihop, iklass, init, itables, jfr, jni, jvmti, liveness, load, loader, logging, mark, marking, metadata, metaspace, method, mmu, modules, monitorinflation, monitormismatch, nmethod, normalize, objecttagging, obsolete, oopmap, os, pagesize, parser, patch, path, phases, plab, preorder, promotion, protectiondomain, purge, redefine, ref, refine, region, remset, resolve, safepoint, scavenge, scrub, setting, stackmap, stacktrace, stackwalk, start, startuptime, state, stats, stringdedup, stringtable, subclass, survivor, sweep, system, task, thread, time, timer, tlab, unload, update, verification, verify, vmoperation, vtables, workgang
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>日志级别从低到高, 共有 <strong>Trace, Debug, Info, Warning, Error, Off</strong> 六种级别, 日志级别决定了输出信息的详细程度, 默认级别为 Info, HotSpot 的日志规则与 Log4j, SLF4j 这类 Java 日志框架大体上是一致的. 另外, 还可以使用修饰器(Decorator)来要求每行日志输出都附加上额外的内容, 支持附加在日志行上的信息包括:</p> <ul><li>time: 当前日期和时间.</li> <li>uptime: 虚拟机启动到现在经过的时间, 以秒为单位.</li> <li>timemillis: 当前时间的毫秒数, 相当于 System.currentTimeMillis() 的输出.</li> <li>uptimemillis: 虚拟机启动到现在经过的毫秒数.</li> <li>timenanos: 当前时间的纳秒数, 相当于 System.nanoTime() 的输出.</li> <li>uptimenanos: 虚拟机启动到现在经过的纳秒数.</li> <li>pid: 进程 ID.</li> <li>tid: 线程 ID.</li> <li>level: 日志级别.</li> <li>tags: 日志输出的标签集.</li></ul> <p>如果不指定, 默认值是 <strong>uptime, level, tags</strong> 这三个, 此时日志输出类似于以下形式:</p> <div class="language-ziti1 line-numbers-mode"><pre class="language-text"><code>[3.080s][info][gc,cpu] GC(5) User=0.03s Sys=0.00s Real=0.01s
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h6 id="_2-gc日志分析示例"><a href="#_2-gc日志分析示例" class="header-anchor">#</a> (2)GC日志分析示例</h6> <blockquote><p>JDK9之前GC日志分析示例</p></blockquote> <p>一段示例 <strong>GC 日志</strong>:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token number">33.125</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token constant">GC</span><span class="token punctuation">[</span><span class="token class-name">DefNew</span><span class="token operator">:</span><span class="token number">3324</span>K<span class="token operator">-&gt;</span><span class="token function">152K</span><span class="token punctuation">(</span><span class="token number">3712</span>K<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0.0025925</span> secs<span class="token punctuation">]</span><span class="token number">3324</span>K<span class="token operator">-&gt;</span><span class="token function">152K</span><span class="token punctuation">(</span><span class="token number">11904</span>K<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0.0031680</span> secs<span class="token punctuation">]</span>
<span class="token number">100.667</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token class-name">Full</span> <span class="token constant">GC</span><span class="token punctuation">[</span><span class="token class-name">Tenured</span><span class="token operator">:</span><span class="token number">0</span> <span class="token class-name">K</span><span class="token operator">-&gt;</span><span class="token function">210K</span><span class="token punctuation">(</span><span class="token number">10240</span>K<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0.0149142</span>secs<span class="token punctuation">]</span><span class="token number">4603</span>K<span class="token operator">-&gt;</span><span class="token function">210K</span><span class="token punctuation">(</span><span class="token number">19456</span>K<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token class-name">Perm</span><span class="token operator">:</span><span class="token number">2999</span>K<span class="token operator">-&gt;</span><span class="token function">2999K</span><span class="token punctuation">(</span><span class="token number">21248</span>K<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0.0150007</span> secs<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token class-name">Times</span><span class="token operator">:</span>user<span class="token operator">=</span><span class="token number">0.01</span> sys<span class="token operator">=</span><span class="token number">0.00</span><span class="token punctuation">,</span> real<span class="token operator">=</span><span class="token number">0.02</span> secs<span class="token punctuation">]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>分析:</p> <ul><li>首先 &quot;33.125&quot; 和 &quot;100.667&quot; 这个数值的意义是代表 GC 发生的<strong>时间</strong>, 该数字是 GC 启动以来的时间.</li> <li>&quot;GC&quot; 和 &quot;Full GC&quot; 则代表这次 GC 发生的<strong>类型</strong>, 如果为 Full GC, 则代表这次 GC 是 Stop The World 的. 如果通过 System.gc() 方法触发的则会显示 Full GC(System).</li> <li>&quot;DefNew, Tenured, Perm&quot; 表示 GC 发生的<strong>区域</strong>, 这里显示的区域名称与使用的 GC 收集器是密切相关的.</li> <li>&quot;3324K-＞152K(3712K)&quot; 代表 <strong>GC 前</strong>该区域内已使用的<strong>容量</strong> -&gt; <strong>GC 后</strong>该区域内已使用的容量(该区域内的总容量).</li> <li>&quot;0.0025925 secs&quot; 表示这次 GC 所占用的时间单位为<strong>秒</strong>.</li> <li>&quot;3324K-&gt;152K(11904K)&quot; 则是 <strong>GC 前</strong> Java 堆已使用容量 -＞ <strong>GC 后</strong> Java 堆已使用容量(Java 堆总容量).</li> <li>&quot;[Times:user=0.01 sys=0.00, real=0.02 secs]&quot; 里的 user, sys, real 分别代表用户态消耗 CPU 的时间和内核态消耗的 CPU 的时间和操作开始到结束所经历的时间.</li></ul> <p><strong>再看一个 GC 日志:</strong></p> <p><img src="https://nano-note.oss-cn-beijing.aliyuncs.com/images/image-20200622152448238-3129000.png" alt="image-20200622152448238"></p> <p>可以看到图中<strong>第一行红框</strong>, 是<strong>项目的配置参数</strong>. 这里不仅配置了打印 GC 日志, 还有相关的 VM 内存参数.</p> <p><strong>第二行红框</strong>中的是在这个 GC 时间点<strong>发生 GC 之后相关 GC 情况</strong>.</p> <ul><li>&quot;2.909&quot; 这是具体发生 GC 的时间点. 这是时间戳是从 JVM <strong>启动开始计算</strong>的, 前面还有具体的发生时间日期.</li> <li>&quot;Full GC(Metadata GC Threshold)&quot; 指这是一次 Full GC, 括号里是 GC 的原因, &quot;PSYoungGen&quot; 是年轻代的 GC, &quot;ParOldGen&quot; 是老年代的 GC, &quot;Metaspace&quot; 是元空间的 GC.</li> <li>&quot;6160K-&gt;0K(141824K)&quot;: 这三个数字分别对应 GC 之前占用年轻代的大小, GC 之后年轻代占用, 以及整个年轻代的大小.</li> <li>&quot;112K-&gt;6056K(95744K)&quot;: 这三个数字分别对应 GC 之前占用老年代的大小, GC 之后老年代占用, 以及整个老年代的大小.</li> <li>&quot;6272K-&gt;6056K(237568K)&quot;: 这三个数字分别对应 GC 之前占用堆内存的大小, GC 之后堆内存占用, 以及整个堆内存的大小.</li> <li>&quot;20516K-&gt;20516K(1069056K)&quot;: 这三个数字分别对应 GC 之前占用元空间内存的大小, GC 之后元空间内存占用, 以及整个元空间内存的大小.</li> <li>&quot;0.0209707&quot; 是该时间点 GC 总耗费时间.</li></ul> <p>从日志可以发现几次 Full GC 都是由于元空间不够导致的, 所以可以将元空间调大点.</p> <p>通过上面的这些参数就能知道 GC 的垃圾收集情况. 但是如果 GC 日志<strong>过多且繁杂</strong>, 有时候为了发现问题往往需要连续运行很久, 比如几个周, 这就会有很多的 GC 日志, 直接去看就不现实, 可以使用可视化工具 <strong>gceasy</strong> 进行分析. 可以看到堆内存在 GC 之前和之后的变化, 以及其他信息.</p> <p><img src="https://nano-note.oss-cn-beijing.aliyuncs.com/images/image-20200622154910625.png" alt=""></p> <blockquote><p>JDK9后GC日志分析示例</p></blockquote> <p>下面举几个例子, 展示在 <strong>JDK 9 统一日志框架前, 后</strong>是如何获得垃圾收集器过程的相关信息, 以下均以 JDK 9 的 <strong>G1 收集器</strong>(JDK 9 下默认收集器就是 G1, 所以命令行中没有指定收集器)为例.</p> <p>(1) <strong>查看 GC 基本信息</strong>, 在 JDK 9 之前使用 <code>-XX: +PrintGC</code>​, JDK 9 后使用 <code>-Xlog: gc</code>​:</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>bash-3.2$ <span class="token function">java</span> <span class="token parameter variable">-Xlog:gc</span> GCTest
<span class="token punctuation">[</span><span class="token number">0</span>.222s<span class="token punctuation">]</span><span class="token punctuation">[</span>info<span class="token punctuation">]</span><span class="token punctuation">[</span>gc<span class="token punctuation">]</span> Using G1
<span class="token punctuation">[</span><span class="token number">2</span>.825s<span class="token punctuation">]</span><span class="token punctuation">[</span>info<span class="token punctuation">]</span><span class="token punctuation">[</span>gc<span class="token punctuation">]</span> GC<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> Pause Young <span class="token punctuation">(</span>G1 Evacuation Pause<span class="token punctuation">)</span> 26M-<span class="token operator">&gt;</span>5M<span class="token punctuation">(</span>256M<span class="token punctuation">)</span> <span class="token number">355</span>.623ms
<span class="token punctuation">[</span><span class="token number">3</span>.096s<span class="token punctuation">]</span><span class="token punctuation">[</span>info<span class="token punctuation">]</span><span class="token punctuation">[</span>gc<span class="token punctuation">]</span> GC<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> Pause Young <span class="token punctuation">(</span>G1 Evacuation Pause<span class="token punctuation">)</span> 14M-<span class="token operator">&gt;</span>7M<span class="token punctuation">(</span>256M<span class="token punctuation">)</span> <span class="token number">50</span>.030ms
<span class="token punctuation">[</span><span class="token number">3</span>.385s<span class="token punctuation">]</span><span class="token punctuation">[</span>info<span class="token punctuation">]</span><span class="token punctuation">[</span>gc<span class="token punctuation">]</span> GC<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> Pause Young <span class="token punctuation">(</span>G1 Evacuation Pause<span class="token punctuation">)</span> 17M-<span class="token operator">&gt;</span>10M<span class="token punctuation">(</span>256M<span class="token punctuation">)</span> <span class="token number">40</span>.576ms
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>(2) <strong>查看 GC 详细信息</strong>, 在 JDK 9 之前使用 <code>-XX: +PrintGCDetails</code>​, 在 JDK 9之后使用 <code>-X-log: gc*</code>​, 用通配符 <code>*</code>​ 将 GC 标签下所有细分过程都打印出来, 如果把日志级别调整到 Debug 或者 Trace(基于版面篇幅考虑, 例子中并没有), 还将获得更多细节信息:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>bash<span class="token operator">-</span><span class="token number">3.2</span>$ java <span class="token operator">-</span><span class="token class-name">Xlog</span><span class="token operator">:</span>gc<span class="token operator">*</span> <span class="token class-name">GCTest</span>
<span class="token punctuation">[</span><span class="token number">0.233</span>s<span class="token punctuation">]</span><span class="token punctuation">[</span>info<span class="token punctuation">]</span><span class="token punctuation">[</span>gc<span class="token punctuation">,</span>heap<span class="token punctuation">]</span> <span class="token class-name">Heap</span> region size<span class="token operator">:</span> <span class="token number">1</span>M
<span class="token punctuation">[</span><span class="token number">0.383</span>s<span class="token punctuation">]</span><span class="token punctuation">[</span>info<span class="token punctuation">]</span><span class="token punctuation">[</span>gc <span class="token punctuation">]</span> <span class="token class-name">Using</span> <span class="token constant">G1</span>
<span class="token punctuation">[</span><span class="token number">0.383</span>s<span class="token punctuation">]</span><span class="token punctuation">[</span>info<span class="token punctuation">]</span><span class="token punctuation">[</span>gc<span class="token punctuation">,</span>heap<span class="token punctuation">,</span>coops<span class="token punctuation">]</span> <span class="token class-name">Heap</span> address<span class="token operator">:</span> <span class="token number">0xfffffffe50400000</span><span class="token punctuation">,</span> size<span class="token operator">:</span> <span class="token number">4064</span> <span class="token constant">MB</span><span class="token punctuation">,</span> <span class="token class-name">Compressed</span> <span class="token class-name">Oops</span> mode<span class="token operator">:</span> <span class="token class-name">Non</span><span class="token operator">-</span>zero based<span class="token operator">:</span>
<span class="token number">0xfffffffe50000000</span><span class="token punctuation">,</span> <span class="token class-name">Oop</span> shift amount<span class="token operator">:</span> <span class="token number">3</span>
<span class="token punctuation">[</span><span class="token number">3.064</span>s<span class="token punctuation">]</span><span class="token punctuation">[</span>info<span class="token punctuation">]</span><span class="token punctuation">[</span>gc<span class="token punctuation">,</span>start <span class="token punctuation">]</span> <span class="token function">GC</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token class-name">Pause</span> <span class="token class-name">Young</span> <span class="token punctuation">(</span><span class="token constant">G1</span> <span class="token class-name">Evacuation</span> <span class="token class-name">Pause</span><span class="token punctuation">)</span>
gc<span class="token punctuation">,</span>task <span class="token punctuation">]</span> <span class="token function">GC</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token class-name">Using</span> <span class="token number">23</span> workers of <span class="token number">23</span> <span class="token keyword">for</span> evacuation
<span class="token punctuation">[</span><span class="token number">3.420</span>s<span class="token punctuation">]</span><span class="token punctuation">[</span>info<span class="token punctuation">]</span><span class="token punctuation">[</span>gc<span class="token punctuation">,</span>phases <span class="token punctuation">]</span> <span class="token function">GC</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token class-name">Pre</span> <span class="token class-name">Evacuate</span> <span class="token class-name">Collection</span> <span class="token class-name">Set</span><span class="token operator">:</span> <span class="token number">0.2</span>ms
<span class="token punctuation">[</span><span class="token number">3.421</span>s<span class="token punctuation">]</span><span class="token punctuation">[</span>info<span class="token punctuation">]</span><span class="token punctuation">[</span>gc<span class="token punctuation">,</span>phases <span class="token punctuation">]</span> <span class="token function">GC</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token class-name">Evacuate</span> <span class="token class-name">Collection</span> <span class="token class-name">Set</span><span class="token operator">:</span> <span class="token number">348.0</span>ms
gc<span class="token punctuation">,</span>phases <span class="token punctuation">]</span> <span class="token function">GC</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token class-name">Post</span> <span class="token class-name">Evacuate</span> <span class="token class-name">Collection</span> <span class="token class-name">Set</span><span class="token operator">:</span> <span class="token number">6.2</span>ms
<span class="token punctuation">[</span><span class="token number">3.421</span>s<span class="token punctuation">]</span><span class="token punctuation">[</span>info<span class="token punctuation">]</span><span class="token punctuation">[</span>gc<span class="token punctuation">,</span>phases <span class="token punctuation">]</span> <span class="token function">GC</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token class-name">Other</span><span class="token operator">:</span> <span class="token number">2.8</span>ms
gc<span class="token punctuation">,</span>heap <span class="token punctuation">]</span> <span class="token function">GC</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token class-name">Eden</span> regions<span class="token operator">:</span> <span class="token number">24</span><span class="token operator">-&gt;</span><span class="token function">0</span><span class="token punctuation">(</span><span class="token number">9</span><span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token number">3.421</span>s<span class="token punctuation">]</span><span class="token punctuation">[</span>info<span class="token punctuation">]</span><span class="token punctuation">[</span>gc<span class="token punctuation">,</span>heap <span class="token punctuation">]</span> <span class="token function">GC</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token class-name">Survivor</span> regions<span class="token operator">:</span> <span class="token number">0</span><span class="token operator">-&gt;</span><span class="token function">3</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token number">3.421</span>s<span class="token punctuation">]</span><span class="token punctuation">[</span>info<span class="token punctuation">]</span><span class="token punctuation">[</span>gc<span class="token punctuation">,</span>heap <span class="token punctuation">]</span> <span class="token function">GC</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token class-name">Old</span> regions<span class="token operator">:</span> <span class="token number">0</span><span class="token operator">-&gt;</span><span class="token number">2</span>
<span class="token punctuation">[</span><span class="token number">3.421</span>s<span class="token punctuation">]</span><span class="token punctuation">[</span>info<span class="token punctuation">]</span><span class="token punctuation">[</span>gc<span class="token punctuation">,</span>heap <span class="token punctuation">]</span> <span class="token function">GC</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token class-name">Humongous</span> regions<span class="token operator">:</span> <span class="token number">2</span><span class="token operator">-&gt;</span><span class="token number">1</span>
<span class="token punctuation">[</span><span class="token number">3.421</span>s<span class="token punctuation">]</span><span class="token punctuation">[</span>info<span class="token punctuation">]</span><span class="token punctuation">[</span>gc<span class="token punctuation">,</span>metaspace <span class="token punctuation">]</span> <span class="token function">GC</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token class-name">Metaspace</span><span class="token operator">:</span> <span class="token number">4719</span>K<span class="token operator">-&gt;</span><span class="token function">4719K</span><span class="token punctuation">(</span><span class="token number">1056768</span>K<span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token number">3.421</span>s<span class="token punctuation">]</span><span class="token punctuation">[</span>info<span class="token punctuation">]</span><span class="token punctuation">[</span>gc <span class="token punctuation">]</span> <span class="token function">GC</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token class-name">Pause</span> <span class="token class-name">Young</span> <span class="token punctuation">(</span><span class="token constant">G1</span> <span class="token class-name">Evacuation</span> <span class="token class-name">Pause</span><span class="token punctuation">)</span> <span class="token number">26</span>M<span class="token operator">-&gt;</span><span class="token function">5M</span><span class="token punctuation">(</span><span class="token number">256</span>M<span class="token punctuation">)</span> <span class="token number">357.743</span>ms
<span class="token punctuation">[</span><span class="token number">3.422</span>s<span class="token punctuation">]</span><span class="token punctuation">[</span>info<span class="token punctuation">]</span><span class="token punctuation">[</span>gc<span class="token punctuation">,</span>cpu <span class="token punctuation">]</span> <span class="token function">GC</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token class-name">User</span><span class="token operator">=</span><span class="token number">0.70</span>s <span class="token class-name">Sys</span><span class="token operator">=</span><span class="token number">5.13</span>s <span class="token class-name">Real</span><span class="token operator">=</span><span class="token number">0.36</span>s
<span class="token punctuation">[</span><span class="token number">3.648</span>s<span class="token punctuation">]</span><span class="token punctuation">[</span>info<span class="token punctuation">]</span><span class="token punctuation">[</span>gc<span class="token punctuation">,</span>start <span class="token punctuation">]</span> <span class="token function">GC</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token class-name">Pause</span> <span class="token class-name">Young</span> <span class="token punctuation">(</span><span class="token constant">G1</span> <span class="token class-name">Evacuation</span> <span class="token class-name">Pause</span><span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token number">3.648</span>s<span class="token punctuation">]</span><span class="token punctuation">[</span>info<span class="token punctuation">]</span><span class="token punctuation">[</span>gc<span class="token punctuation">,</span>task <span class="token punctuation">]</span> <span class="token function">GC</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token class-name">Using</span> <span class="token number">23</span> workers of <span class="token number">23</span> <span class="token keyword">for</span> evacuation
<span class="token punctuation">[</span><span class="token number">3.699</span>s<span class="token punctuation">]</span><span class="token punctuation">[</span>info<span class="token punctuation">]</span><span class="token punctuation">[</span>gc<span class="token punctuation">,</span>phases <span class="token punctuation">]</span> <span class="token function">GC</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token class-name">Pre</span> <span class="token class-name">Evacuate</span> <span class="token class-name">Collection</span> <span class="token class-name">Set</span><span class="token operator">:</span> <span class="token number">0.3</span>ms
gc<span class="token punctuation">,</span>phases <span class="token punctuation">]</span> <span class="token function">GC</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token class-name">Evacuate</span> <span class="token class-name">Collection</span> <span class="token class-name">Set</span><span class="token operator">:</span> <span class="token number">45.6</span>ms
gc<span class="token punctuation">,</span>phases <span class="token punctuation">]</span> <span class="token function">GC</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token class-name">Post</span> <span class="token class-name">Evacuate</span> <span class="token class-name">Collection</span> <span class="token class-name">Set</span><span class="token operator">:</span> <span class="token number">3.4</span>ms
gc<span class="token punctuation">,</span>phases <span class="token punctuation">]</span> <span class="token function">GC</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token class-name">Other</span><span class="token operator">:</span> <span class="token number">1.7</span>ms
gc<span class="token punctuation">,</span>heap <span class="token punctuation">]</span> <span class="token function">GC</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token class-name">Eden</span> regions<span class="token operator">:</span> <span class="token number">9</span><span class="token operator">-&gt;</span><span class="token function">0</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token number">3.699</span>s<span class="token punctuation">]</span><span class="token punctuation">[</span>info<span class="token punctuation">]</span><span class="token punctuation">[</span>gc<span class="token punctuation">,</span>heap <span class="token punctuation">]</span> <span class="token function">GC</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token class-name">Survivor</span> regions<span class="token operator">:</span> <span class="token number">3</span><span class="token operator">-&gt;</span><span class="token function">2</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token number">3.699</span>s<span class="token punctuation">]</span><span class="token punctuation">[</span>info<span class="token punctuation">]</span><span class="token punctuation">[</span>gc<span class="token punctuation">,</span>heap <span class="token punctuation">]</span> <span class="token function">GC</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token class-name">Old</span> regions<span class="token operator">:</span> <span class="token number">2</span><span class="token operator">-&gt;</span><span class="token number">5</span>
<span class="token punctuation">[</span><span class="token number">3.700</span>s<span class="token punctuation">]</span><span class="token punctuation">[</span>info<span class="token punctuation">]</span><span class="token punctuation">[</span>gc<span class="token punctuation">,</span>heap <span class="token punctuation">]</span> <span class="token function">GC</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token class-name">Humongous</span> regions<span class="token operator">:</span> <span class="token number">1</span><span class="token operator">-&gt;</span><span class="token number">1</span>
<span class="token punctuation">[</span><span class="token number">3.700</span>s<span class="token punctuation">]</span><span class="token punctuation">[</span>info<span class="token punctuation">]</span><span class="token punctuation">[</span>gc<span class="token punctuation">,</span>metaspace <span class="token punctuation">]</span> <span class="token function">GC</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token class-name">Metaspace</span><span class="token operator">:</span> <span class="token number">4726</span>K<span class="token operator">-&gt;</span><span class="token function">4726K</span><span class="token punctuation">(</span><span class="token number">1056768</span>K<span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token number">3.700</span>s<span class="token punctuation">]</span><span class="token punctuation">[</span>info<span class="token punctuation">]</span><span class="token punctuation">[</span>gc <span class="token punctuation">]</span> <span class="token function">GC</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token class-name">Pause</span> <span class="token class-name">Young</span> <span class="token punctuation">(</span><span class="token constant">G1</span> <span class="token class-name">Evacuation</span> <span class="token class-name">Pause</span><span class="token punctuation">)</span> <span class="token number">14</span>M<span class="token operator">-&gt;</span><span class="token function">7M</span><span class="token punctuation">(</span><span class="token number">256</span>M<span class="token punctuation">)</span> <span class="token number">51.872</span>ms
<span class="token punctuation">[</span><span class="token number">3.700</span>s<span class="token punctuation">]</span><span class="token punctuation">[</span>info<span class="token punctuation">]</span><span class="token punctuation">[</span>gc<span class="token punctuation">,</span>cpu <span class="token punctuation">]</span> <span class="token function">GC</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token class-name">User</span><span class="token operator">=</span><span class="token number">0.56</span>s <span class="token class-name">Sys</span><span class="token operator">=</span><span class="token number">0.46</span>s <span class="token class-name">Real</span><span class="token operator">=</span><span class="token number">0.05</span>s
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br></div></div><p>(3) <strong>查看 GC 前后的堆, 方法区可用容量变化</strong>, 在 JDK 9 之前使用 <code>-XX: +PrintHeapAtGC</code>​, JDK 9 之后使用 <code>-Xlog: gc+heap=debug</code>​:</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>bash-3.2$ <span class="token function">java</span> -Xlog:gc+heap<span class="token operator">=</span>debug GCTest
<span class="token punctuation">[</span><span class="token number">0</span>.113s<span class="token punctuation">]</span><span class="token punctuation">[</span>info<span class="token punctuation">]</span><span class="token punctuation">[</span>gc,heap<span class="token punctuation">]</span> Heap region size: 1M
<span class="token punctuation">[</span><span class="token number">0</span>.113s<span class="token punctuation">]</span><span class="token punctuation">[</span>debug<span class="token punctuation">]</span><span class="token punctuation">[</span>gc,heap<span class="token punctuation">]</span> Minimum heap <span class="token number">8388608</span> Initial heap <span class="token number">268435456</span> Maximum heap <span class="token number">4261412864</span>
<span class="token punctuation">[</span><span class="token number">2</span>.529s<span class="token punctuation">]</span><span class="token punctuation">[</span>debug<span class="token punctuation">]</span><span class="token punctuation">[</span>gc,heap<span class="token punctuation">]</span> GC<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> Heap before GC <span class="token assign-left variable">invocations</span><span class="token operator">=</span><span class="token number">0</span> <span class="token punctuation">(</span>full <span class="token number">0</span><span class="token punctuation">)</span>:
<span class="token punctuation">[</span><span class="token number">2</span>.529s<span class="token punctuation">]</span><span class="token punctuation">[</span>debug<span class="token punctuation">]</span><span class="token punctuation">[</span>gc,heap<span class="token punctuation">]</span> GC<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> garbage-first heap total 262144K, used 26624K <span class="token punctuation">[</span>0xfffffffe50400000, 0xfffffffe50500800,
0xffffffff4e400000<span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token number">2</span>.529s<span class="token punctuation">]</span><span class="token punctuation">[</span>debug<span class="token punctuation">]</span><span class="token punctuation">[</span>gc,heap<span class="token punctuation">]</span> GC<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> region size 1024K, <span class="token number">24</span> young <span class="token punctuation">(</span>24576K<span class="token punctuation">)</span>, <span class="token number">0</span> survivors <span class="token punctuation">(</span>0K<span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token number">2</span>.530s<span class="token punctuation">]</span><span class="token punctuation">[</span>debug<span class="token punctuation">]</span><span class="token punctuation">[</span>gc,heap<span class="token punctuation">]</span> GC<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> Metaspace used 4719K, capacity 4844K, committed 5120K, reserved 1056768K
<span class="token punctuation">[</span><span class="token number">2</span>.530s<span class="token punctuation">]</span><span class="token punctuation">[</span>debug<span class="token punctuation">]</span><span class="token punctuation">[</span>gc,heap<span class="token punctuation">]</span> GC<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> class space used 413K, capacity 464K, committed 512K, reserved 1048576K
<span class="token punctuation">[</span><span class="token number">2</span>.892s<span class="token punctuation">]</span><span class="token punctuation">[</span>info <span class="token punctuation">]</span><span class="token punctuation">[</span>gc,heap<span class="token punctuation">]</span> GC<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> Eden regions: <span class="token number">24</span>-<span class="token operator">&gt;</span><span class="token number">0</span><span class="token punctuation">(</span><span class="token number">9</span><span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token number">2</span>.892s<span class="token punctuation">]</span><span class="token punctuation">[</span>info <span class="token punctuation">]</span><span class="token punctuation">[</span>gc,heap<span class="token punctuation">]</span> GC<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> Survivor regions: <span class="token number">0</span>-<span class="token operator">&gt;</span><span class="token number">3</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token number">2</span>.892s<span class="token punctuation">]</span><span class="token punctuation">[</span>info <span class="token punctuation">]</span><span class="token punctuation">[</span>gc,heap<span class="token punctuation">]</span> GC<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> Old regions: <span class="token number">0</span>-<span class="token operator">&gt;</span><span class="token number">2</span>
<span class="token punctuation">[</span><span class="token number">2</span>.892s<span class="token punctuation">]</span><span class="token punctuation">[</span>info <span class="token punctuation">]</span><span class="token punctuation">[</span>gc,heap<span class="token punctuation">]</span> GC<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> Humongous regions: <span class="token number">2</span>-<span class="token operator">&gt;</span><span class="token number">1</span>
<span class="token punctuation">[</span><span class="token number">2</span>.893s<span class="token punctuation">]</span><span class="token punctuation">[</span>debug<span class="token punctuation">]</span><span class="token punctuation">[</span>gc,heap<span class="token punctuation">]</span> GC<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> Heap after GC <span class="token assign-left variable">invocations</span><span class="token operator">=</span><span class="token number">1</span> <span class="token punctuation">(</span>full <span class="token number">0</span><span class="token punctuation">)</span>:
<span class="token punctuation">[</span><span class="token number">2</span>.893s<span class="token punctuation">]</span><span class="token punctuation">[</span>debug<span class="token punctuation">]</span><span class="token punctuation">[</span>gc,heap<span class="token punctuation">]</span> GC<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> garbage-first heap total 262144K, used 5850K <span class="token punctuation">[</span>0xfffffffe50400000, 0xfffffffe50500800, 0xffffffff4e400000<span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token number">2</span>.893s<span class="token punctuation">]</span><span class="token punctuation">[</span>debug<span class="token punctuation">]</span><span class="token punctuation">[</span>gc,heap<span class="token punctuation">]</span> GC<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> region size 1024K, <span class="token number">3</span> young <span class="token punctuation">(</span>3072K<span class="token punctuation">)</span>, <span class="token number">3</span> survivors <span class="token punctuation">(</span>3072K<span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token number">2</span>.893s<span class="token punctuation">]</span><span class="token punctuation">[</span>debug<span class="token punctuation">]</span><span class="token punctuation">[</span>gc,heap<span class="token punctuation">]</span> GC<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> Metaspace used 4719K, capacity 4844K, committed 5120K, reserved 1056768K
<span class="token punctuation">[</span><span class="token number">2</span>.893s<span class="token punctuation">]</span><span class="token punctuation">[</span>debug<span class="token punctuation">]</span><span class="token punctuation">[</span>gc,heap<span class="token punctuation">]</span> GC<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> class space used 413K, capacity 464K, committed 512K, reserved 1048576K
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>(4) <strong>查看 GC 过程中用户线程并发时间以及停顿的时间</strong>, 在 JDK 9 之前使用 <code>-XX: +Print-GCApplicationConcurrentTime</code>​ 以及 <code>-XX: +PrintGCApplicationStoppedTime</code>​, JDK 9 之后使用 <code>-Xlog: safepoint</code>​:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>bash<span class="token operator">-</span><span class="token number">3.2</span>$ java <span class="token operator">-</span><span class="token class-name">Xlog</span><span class="token operator">:</span>safepoint <span class="token class-name">GCTest</span>
<span class="token punctuation">[</span><span class="token number">1.376</span>s<span class="token punctuation">]</span><span class="token punctuation">[</span>info<span class="token punctuation">]</span><span class="token punctuation">[</span>safepoint<span class="token punctuation">]</span> <span class="token class-name">Application</span> time<span class="token operator">:</span> <span class="token number">0.3091519</span> seconds
<span class="token punctuation">[</span><span class="token number">1.377</span>s<span class="token punctuation">]</span><span class="token punctuation">[</span>info<span class="token punctuation">]</span><span class="token punctuation">[</span>safepoint<span class="token punctuation">]</span> <span class="token class-name">Total</span> time <span class="token keyword">for</span> which application threads were stopped<span class="token operator">:</span> <span class="token number">0.0004600</span> seconds<span class="token punctuation">,</span> <span class="token class-name">Stopping</span> threads took<span class="token operator">:</span>
<span class="token number">0.0002648</span> seconds
<span class="token punctuation">[</span><span class="token number">2.386</span>s<span class="token punctuation">]</span><span class="token punctuation">[</span>info<span class="token punctuation">]</span><span class="token punctuation">[</span>safepoint<span class="token punctuation">]</span> <span class="token class-name">Application</span> time<span class="token operator">:</span> <span class="token number">1.0091637</span> seconds
<span class="token punctuation">[</span><span class="token number">2.387</span>s<span class="token punctuation">]</span><span class="token punctuation">[</span>info<span class="token punctuation">]</span><span class="token punctuation">[</span>safepoint<span class="token punctuation">]</span> <span class="token class-name">Total</span> time <span class="token keyword">for</span> which application threads were stopped<span class="token operator">:</span> <span class="token number">0.0005217</span> seconds<span class="token punctuation">,</span> <span class="token class-name">Stopping</span> threads took<span class="token operator">:</span>
<span class="token number">0.0002297</span> seconds
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>(5) <strong>查看收集器 Ergonomics 机制</strong>(自动设置堆空间各分代区域大小, 收集目标等内容, 从 Parallel 收集器开始支持)自动调节的相关信息. 在 JDK 9 之前使用 <code>-XX: +PrintAdaptive-SizePolicy</code>​, JDK 9 之后使用 <code>-Xlog: gc+ergo*=trace</code>​:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>bash<span class="token operator">-</span><span class="token number">3.2</span>$ java <span class="token operator">-</span><span class="token class-name">Xlog</span><span class="token operator">:</span>gc<span class="token operator">+</span>ergo<span class="token operator">*=</span>trace <span class="token class-name">GCTest</span> <span class="token punctuation">[</span><span class="token number">0.122</span>s<span class="token punctuation">]</span><span class="token punctuation">[</span>debug<span class="token punctuation">]</span><span class="token punctuation">[</span>gc<span class="token punctuation">,</span>ergo<span class="token punctuation">,</span>refine<span class="token punctuation">]</span> <span class="token class-name">Initial</span> <span class="token class-name">Refinement</span> <span class="token class-name">Zones</span><span class="token operator">:</span> green<span class="token operator">:</span> <span class="token number">23</span><span class="token punctuation">,</span> yellow<span class="token operator">:</span>
<span class="token number">69</span><span class="token punctuation">,</span> red<span class="token operator">:</span> <span class="token number">115</span><span class="token punctuation">,</span> min yellow size<span class="token operator">:</span> <span class="token number">46</span>
<span class="token punctuation">[</span><span class="token number">0.142</span>s<span class="token punctuation">]</span><span class="token punctuation">[</span>debug<span class="token punctuation">]</span><span class="token punctuation">[</span>gc<span class="token punctuation">,</span>ergo<span class="token punctuation">,</span>heap <span class="token punctuation">]</span> <span class="token class-name">Expand</span> the heap<span class="token punctuation">.</span> requested expansion amount<span class="token operator">:</span><span class="token number">268435456</span>B expansion amount<span class="token operator">:</span><span class="token number">268435456</span>B
<span class="token punctuation">[</span><span class="token number">2.475</span>s<span class="token punctuation">]</span><span class="token punctuation">[</span>trace<span class="token punctuation">]</span><span class="token punctuation">[</span>gc<span class="token punctuation">,</span>ergo<span class="token punctuation">,</span>cset <span class="token punctuation">]</span> <span class="token function">GC</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token class-name">Start</span> choosing <span class="token class-name">CSet</span><span class="token punctuation">.</span> pending cards<span class="token operator">:</span> <span class="token number">0</span> predicted base time<span class="token operator">:</span> <span class="token number">10.00</span>ms remaining time<span class="token operator">:</span>
<span class="token number">190.00</span>ms target pause time<span class="token operator">:</span> <span class="token number">200.00</span>ms
<span class="token punctuation">[</span><span class="token number">2.476</span>s<span class="token punctuation">]</span><span class="token punctuation">[</span>trace<span class="token punctuation">]</span><span class="token punctuation">[</span>gc<span class="token punctuation">,</span>ergo<span class="token punctuation">,</span>cset <span class="token punctuation">]</span> <span class="token function">GC</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token class-name">Add</span> young regions <span class="token keyword">to</span> <span class="token class-name">CSet</span><span class="token punctuation">.</span> eden<span class="token operator">:</span> <span class="token number">24</span> regions<span class="token punctuation">,</span> survivors<span class="token operator">:</span> <span class="token number">0</span> regions<span class="token punctuation">,</span> predicted young
region time<span class="token operator">:</span> <span class="token number">367.19</span>ms<span class="token punctuation">,</span> target pause time<span class="token operator">:</span> <span class="token number">200.00</span>ms
<span class="token punctuation">[</span><span class="token number">2.476</span>s<span class="token punctuation">]</span><span class="token punctuation">[</span>debug<span class="token punctuation">]</span><span class="token punctuation">[</span>gc<span class="token punctuation">,</span>ergo<span class="token punctuation">,</span>cset <span class="token punctuation">]</span> <span class="token function">GC</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token class-name">Finish</span> choosing <span class="token class-name">CSet</span><span class="token punctuation">.</span> old<span class="token operator">:</span> <span class="token number">0</span> regions<span class="token punctuation">,</span> predicted old region time<span class="token operator">:</span> <span class="token number">0.00</span>ms<span class="token punctuation">,</span> time
remaining<span class="token operator">:</span> <span class="token number">0.00</span>
<span class="token punctuation">[</span><span class="token number">2.826</span>s<span class="token punctuation">]</span><span class="token punctuation">[</span>debug<span class="token punctuation">]</span><span class="token punctuation">[</span>gc<span class="token punctuation">,</span>ergo <span class="token punctuation">]</span> <span class="token function">GC</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token class-name">Running</span> <span class="token constant">G1</span> <span class="token class-name">Clear</span> <span class="token class-name">Card</span> <span class="token class-name">Table</span> <span class="token class-name">Task</span> using <span class="token number">1</span> workers <span class="token keyword">for</span> <span class="token number">1</span> units of work <span class="token keyword">for</span> <span class="token number">24</span> regions<span class="token punctuation">.</span>
<span class="token punctuation">[</span><span class="token number">2.827</span>s<span class="token punctuation">]</span><span class="token punctuation">[</span>debug<span class="token punctuation">]</span><span class="token punctuation">[</span>gc<span class="token punctuation">,</span>ergo <span class="token punctuation">]</span> <span class="token function">GC</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token class-name">Running</span> <span class="token constant">G1</span> <span class="token class-name">Free</span> <span class="token class-name">Collection</span> <span class="token class-name">Set</span> using <span class="token number">1</span> workers <span class="token keyword">for</span> collection set length <span class="token number">24</span>
<span class="token punctuation">[</span><span class="token number">2.828</span>s<span class="token punctuation">]</span><span class="token punctuation">[</span>trace<span class="token punctuation">]</span><span class="token punctuation">[</span>gc<span class="token punctuation">,</span>ergo<span class="token punctuation">,</span>refine<span class="token punctuation">]</span> <span class="token function">GC</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token class-name">Updating</span> <span class="token class-name">Refinement</span> <span class="token class-name">Zones</span><span class="token operator">:</span> update_rs time<span class="token operator">:</span> <span class="token number">0.004</span>ms<span class="token punctuation">,</span> update_rs buffers<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> update_rs
goal time<span class="token operator">:</span> <span class="token number">19.999</span>ms
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>(6) <strong>查看熬过收集后剩余对象的年龄分布信息</strong>, 在 JDK 9 前使用 <code>-XX: +PrintTenuring-Distribution</code>​, JDK 9 之后使用 <code>-Xlog: gc+age=trace</code>​:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>bash<span class="token operator">-</span><span class="token number">3.2</span>$ java <span class="token operator">-</span><span class="token class-name">Xlog</span><span class="token operator">:</span>gc<span class="token operator">+</span>age<span class="token operator">=</span>trace <span class="token class-name">GCTest</span>
<span class="token punctuation">[</span><span class="token number">2.406</span>s<span class="token punctuation">]</span><span class="token punctuation">[</span>debug<span class="token punctuation">]</span><span class="token punctuation">[</span>gc<span class="token punctuation">,</span>age<span class="token punctuation">]</span> <span class="token function">GC</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token class-name">Desired</span> survivor size <span class="token number">1572864</span> bytes<span class="token punctuation">,</span> <span class="token keyword">new</span> threshold <span class="token number">15</span> <span class="token punctuation">(</span>max threshold <span class="token number">15</span><span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token number">2.745</span>s<span class="token punctuation">]</span><span class="token punctuation">[</span>trace<span class="token punctuation">]</span><span class="token punctuation">[</span>gc<span class="token punctuation">,</span>age<span class="token punctuation">]</span> <span class="token function">GC</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token class-name">Age</span> table <span class="token keyword">with</span> <span class="token namespace">threshold</span> <span class="token number">15</span> <span class="token punctuation">(</span>max threshold <span class="token number">15</span><span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token number">2.745</span>s<span class="token punctuation">]</span><span class="token punctuation">[</span>trace<span class="token punctuation">]</span><span class="token punctuation">[</span>gc<span class="token punctuation">,</span>age<span class="token punctuation">]</span> <span class="token function">GC</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">-</span> age <span class="token number">1</span><span class="token operator">:</span> <span class="token number">3100640</span> bytes<span class="token punctuation">,</span> <span class="token number">3100640</span> total
<span class="token punctuation">[</span><span class="token number">4.700</span>s<span class="token punctuation">]</span><span class="token punctuation">[</span>debug<span class="token punctuation">]</span><span class="token punctuation">[</span>gc<span class="token punctuation">,</span>age<span class="token punctuation">]</span> <span class="token function">GC</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span> <span class="token class-name">Desired</span> survivor size <span class="token number">2097152</span> bytes<span class="token punctuation">,</span> <span class="token keyword">new</span> threshold <span class="token number">15</span> <span class="token punctuation">(</span>max threshold <span class="token number">15</span><span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token number">4.810</span>s<span class="token punctuation">]</span><span class="token punctuation">[</span>trace<span class="token punctuation">]</span><span class="token punctuation">[</span>gc<span class="token punctuation">,</span>age<span class="token punctuation">]</span> <span class="token function">GC</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span> <span class="token class-name">Age</span> table <span class="token keyword">with</span> <span class="token namespace">threshold</span> <span class="token number">15</span> <span class="token punctuation">(</span>max threshold <span class="token number">15</span><span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token number">4.810</span>s<span class="token punctuation">]</span><span class="token punctuation">[</span>trace<span class="token punctuation">]</span><span class="token punctuation">[</span>gc<span class="token punctuation">,</span>age<span class="token punctuation">]</span> <span class="token function">GC</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span> <span class="token operator">-</span> age <span class="token number">1</span><span class="token operator">:</span> <span class="token number">2658280</span> bytes<span class="token punctuation">,</span> <span class="token number">2658280</span> total
<span class="token punctuation">[</span><span class="token number">4.810</span>s<span class="token punctuation">]</span><span class="token punctuation">[</span>trace<span class="token punctuation">]</span><span class="token punctuation">[</span>gc<span class="token punctuation">,</span>age<span class="token punctuation">]</span> <span class="token function">GC</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span> <span class="token operator">-</span> age <span class="token number">2</span><span class="token operator">:</span> <span class="token number">1527360</span> bytes<span class="token punctuation">,</span> <span class="token number">4185640</span> total
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>囿于篇幅原因, 不再一一列举, 下表给出了全部在 JDK 9 中<strong>被废弃</strong>的日志相关参数及它们在 JDK 9 后使用 <code>-Xlog</code>​ 的代替配置形式.</p> <blockquote><p>JDK 9前后日志参数变化</p></blockquote> <p><img src="/img/Image00048-20240302133505-j3omzqp.jpg" alt=""></p> <p><img src="/img/Image00049-20240302133505-8bfhl21.jpg" alt=""></p> <h4 id="jstat调优实例"><a href="#jstat调优实例" class="header-anchor">#</a> jstat调优实例</h4> <p><strong>用 jstat gc -pid 命令</strong>可以计算出如下一些<strong>关键数据</strong>, 先给自己的系统设置一些<strong>初始性的 JVM 参数</strong>, 比如堆内存大小, 年轻代大小, Eden 和 Survivor 的比例, 老年代的大小, 大对象的阈值, 大龄对象进入老年代的阈值等.</p> <blockquote><p>年轻代对象增长的速率</p></blockquote> <p>可以执行命令 <strong>jstat -gc pid 1000 10</strong>(每隔 1 秒执行 1 次命令, 共执行 10 次), 通过观察 <strong>EU</strong>(eden 区的使用)来估算每秒 eden 大概<strong>新增多少对象</strong>, 如果系统负载不高, 可以把频率 1 秒换成 1 分钟, 甚至 10 分钟来观察整体情况. 注意, 一般系统可能有高峰期和日常期, 所以需要在不同的时间分别估算不同情况下对象增长速率.</p> <blockquote><p>Young GC 的触发频率和每次耗时</p></blockquote> <p>知道年轻代对象增长速率后就能根据 Eden 区的大小推算出 Young GC 大概多久触发一次, Young GC 的平均耗时可以通过 <strong>YGCT/YGC</strong> 公式算出, 根据结果大概就能知道<strong>系统大概多久会因为 Young GC 的执行而卡顿多久</strong>.</p> <blockquote><p>每次 Young GC 后有多少对象存活和进入老年代</p></blockquote> <p>由于前面步骤已经大概知道 Young GC 的频率, 假设是每 5 分钟一次, 那么可以执行命令 jstat -gc pid 300000 10, 观察每次结果中 <strong>Eden</strong>, <strong>Survivor 和老年代</strong>使用的变化情况, 在每次 GC 后 Eden 区使用一般会大幅减少, Survivor 和老年代都有可能增长, 这些增长的对象就是每次 Young GC 后存活的对象, 同时还可以看出每次 Young GC 后进去老年代大概多少对象, 从而可以推算出<strong>老年代对象增长速率.</strong></p> <blockquote><p>Full GC 的触发频率和每次耗时</p></blockquote> <p>知道了老年代对象的增长速率就可以推算出 <strong>Full GC 的触发频率</strong>了, Full GC 的每次耗时可以用公式 <strong>FGCT/FGC</strong> 计算得出.</p> <p><strong>优化思路</strong>其实简单来说就是<strong>尽量让每次 Young GC 后的存活对象小于 Survivor 区域的 50%, 都留存在年轻代里. 尽量别让对象进入老年代. 尽量减少 Full GC 的频率, 避免频繁 Full GC 对 JVM 性能的影响.</strong></p> <h4 id="本章小结"><a href="#本章小结" class="header-anchor">#</a> 本章小结</h4> <p>本章介绍了随 JDK 发布的命令行工具与可视化的故障处理工具, 灵活使用这些工具, 可以为处理问题带来很大的便利. 除了本章涉及的 OpenJDK 中自带的工具之外, 还有很多其他监控和故障处理工具, 如何进行监控和故障诊断, 这并不是《Java 虚拟机规范》中定义的内容, 而是取决于虚拟机实现自身的设计, 因此每种处理工具都有针对的目标范围.</p> <p>‍</p> <h4 id="参考资料"><a href="#参考资料" class="header-anchor">#</a> 参考资料</h4> <ul><li>虚拟机性能监控与故障处理工具: <a href="http://blog.csdn.net/wsyw126/article/details/62422005" target="_blank" rel="noopener noreferrer">http://blog.csdn.net/wsyw126/article/details/62422005<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li>堆转储分析: <a href="https://blog.csdn.net/hehmxy/article/details/89114116" target="_blank" rel="noopener noreferrer">https://blog.csdn.net/hehmxy/article/details/89114116<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div>  <div class="page-edit"><div class="edit-link"><a href="https://github.com/xugaoyi/vuepress-theme-vdoing/edit/main/docs/20.开发/2000.Java/600.JVM/22.JVM性能监控与故障处理工具🌼.md" target="_blank" rel="noopener noreferrer">编辑</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <!----> <!----></div> <div class="page-nav-wapper"><div class="page-nav-centre-wrap"><a href="/pages/48d1be/" class="page-nav-centre page-nav-centre-prev"><div class="tooltip">垃圾收集器与内存分配策略🌼</div></a> <a href="/pages/106680/" class="page-nav-centre page-nav-centre-next"><div class="tooltip">调优案例分析与实战🌼</div></a></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/pages/48d1be/" class="prev">垃圾收集器与内存分配策略🌼</a></span> <span class="next"><a href="/pages/106680/">调优案例分析与实战🌼</a>→
      </span></p></div></div></div> <!----></main></div> <div class="footer"><div class="icons"><a href="mailto:1174520425@qq.com" title="发邮件" target="_blank" class="iconfont icon-youjian"></a><a href="https://github.com/nanodaemony" title="GitHub" target="_blank" class="iconfont icon-github"></a></div> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="本站主题">Vdoing</a> 
    | Copyright © 2019-2025
    <span>达尔文的猹 | MIT License</span></div> <div class="buttons"><div title="返回顶部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去评论" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主题模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          跟随系统
        </li><li class="iconfont icon-rijianmoshi">
          浅色模式
        </li><li class="iconfont icon-yejianmoshi">
          深色模式
        </li><li class="iconfont icon-yuedu">
          阅读模式
        </li></ul></div></div> <!----> <!----> <!----></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.3f3e0e10.js" defer></script><script src="/assets/js/2.e9fcb30c.js" defer></script><script src="/assets/js/3.1998f389.js" defer></script><script src="/assets/js/80.d5b24fea.js" defer></script>
  </body>
</html>
