<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Spring IOCæºç åˆ†æ-æ¦‚è§ˆ | Pangolin Note</title>
    <meta name="generator" content="VuePress 1.9.5">
    <link rel="icon" href="/img/favicon.ico">
    <meta name="description" content="å¤§é“è‡³ç®€">
    <meta name="keywords" content="å‰ç«¯åšå®¢,ä¸ªäººæŠ€æœ¯åšå®¢,å‰ç«¯,å‰ç«¯å¼€å‘,å‰ç«¯æ¡†æ¶,webå‰ç«¯,å‰ç«¯é¢è¯•é¢˜,æŠ€æœ¯æ–‡æ¡£,å­¦ä¹ ,é¢è¯•,JavaScript,js,ES6,TypeScript,vue,python,css3,html5,Node,git,github,markdown">
    <meta name="baidu-site-verification" content="7F55weZDDc">
    <meta name="theme-color" content="#11a8cd">
    
    <link rel="preload" href="/assets/css/0.styles.56073ad3.css" as="style"><link rel="preload" href="/assets/js/app.3f3e0e10.js" as="script"><link rel="preload" href="/assets/js/2.e9fcb30c.js" as="script"><link rel="preload" href="/assets/js/3.1998f389.js" as="script"><link rel="preload" href="/assets/js/117.4024cfe2.js" as="script"><link rel="prefetch" href="/assets/js/10.0b55747f.js"><link rel="prefetch" href="/assets/js/100.b8912a99.js"><link rel="prefetch" href="/assets/js/101.a6740c8a.js"><link rel="prefetch" href="/assets/js/102.e31e89b2.js"><link rel="prefetch" href="/assets/js/103.2c5dbdae.js"><link rel="prefetch" href="/assets/js/104.0e9c02f6.js"><link rel="prefetch" href="/assets/js/105.8288396c.js"><link rel="prefetch" href="/assets/js/106.62f43c11.js"><link rel="prefetch" href="/assets/js/107.70c90211.js"><link rel="prefetch" href="/assets/js/108.b488ce56.js"><link rel="prefetch" href="/assets/js/109.12942650.js"><link rel="prefetch" href="/assets/js/11.ac3fd1ca.js"><link rel="prefetch" href="/assets/js/110.1e57ecba.js"><link rel="prefetch" href="/assets/js/111.6e33b4ea.js"><link rel="prefetch" href="/assets/js/112.bd52831b.js"><link rel="prefetch" href="/assets/js/113.868c1ac9.js"><link rel="prefetch" href="/assets/js/114.090549d1.js"><link rel="prefetch" href="/assets/js/115.d97f6c2b.js"><link rel="prefetch" href="/assets/js/116.097c4b4e.js"><link rel="prefetch" href="/assets/js/118.e3057cba.js"><link rel="prefetch" href="/assets/js/119.4ef1fa3b.js"><link rel="prefetch" href="/assets/js/12.863eaabe.js"><link rel="prefetch" href="/assets/js/120.78f9df50.js"><link rel="prefetch" href="/assets/js/121.8e16df87.js"><link rel="prefetch" href="/assets/js/122.f21c0107.js"><link rel="prefetch" href="/assets/js/123.ea1cb375.js"><link rel="prefetch" href="/assets/js/124.01c04c6e.js"><link rel="prefetch" href="/assets/js/125.d383e301.js"><link rel="prefetch" href="/assets/js/126.3162cb47.js"><link rel="prefetch" href="/assets/js/127.c6bebae6.js"><link rel="prefetch" href="/assets/js/128.d659db60.js"><link rel="prefetch" href="/assets/js/129.2afdcf48.js"><link rel="prefetch" href="/assets/js/13.4f59ce35.js"><link rel="prefetch" href="/assets/js/130.beb9ed9d.js"><link rel="prefetch" href="/assets/js/131.35b05f8a.js"><link rel="prefetch" href="/assets/js/132.d77f4f93.js"><link rel="prefetch" href="/assets/js/133.4ceda6e5.js"><link rel="prefetch" href="/assets/js/134.11390c5f.js"><link rel="prefetch" href="/assets/js/135.32f9e38f.js"><link rel="prefetch" href="/assets/js/136.6d8bb0f2.js"><link rel="prefetch" href="/assets/js/137.9c0ffeef.js"><link rel="prefetch" href="/assets/js/138.88d86e5f.js"><link rel="prefetch" href="/assets/js/139.8c2c3d6c.js"><link rel="prefetch" href="/assets/js/14.11c82d35.js"><link rel="prefetch" href="/assets/js/140.c5c375d3.js"><link rel="prefetch" href="/assets/js/141.d703f30b.js"><link rel="prefetch" href="/assets/js/142.6a005a44.js"><link rel="prefetch" href="/assets/js/143.9b2edf6f.js"><link rel="prefetch" href="/assets/js/144.3fd013c9.js"><link rel="prefetch" href="/assets/js/145.b05079c5.js"><link rel="prefetch" href="/assets/js/146.ed5360a6.js"><link rel="prefetch" href="/assets/js/147.7408d86f.js"><link rel="prefetch" href="/assets/js/148.f390b370.js"><link rel="prefetch" href="/assets/js/149.95017f0a.js"><link rel="prefetch" href="/assets/js/15.bd143bd5.js"><link rel="prefetch" href="/assets/js/150.f0ede764.js"><link rel="prefetch" href="/assets/js/151.b7093623.js"><link rel="prefetch" href="/assets/js/152.a82a6c83.js"><link rel="prefetch" href="/assets/js/153.965e3fb2.js"><link rel="prefetch" href="/assets/js/154.9e49311e.js"><link rel="prefetch" href="/assets/js/155.cef33ba5.js"><link rel="prefetch" href="/assets/js/156.bcc397ae.js"><link rel="prefetch" href="/assets/js/157.90824739.js"><link rel="prefetch" href="/assets/js/158.efd429b9.js"><link rel="prefetch" href="/assets/js/159.122ff5b7.js"><link rel="prefetch" href="/assets/js/16.2449162b.js"><link rel="prefetch" href="/assets/js/160.0b806535.js"><link rel="prefetch" href="/assets/js/161.835052c6.js"><link rel="prefetch" href="/assets/js/162.ca34e2d2.js"><link rel="prefetch" href="/assets/js/163.08000d04.js"><link rel="prefetch" href="/assets/js/164.a1cc0109.js"><link rel="prefetch" href="/assets/js/165.65444686.js"><link rel="prefetch" href="/assets/js/166.7d73c84f.js"><link rel="prefetch" href="/assets/js/167.009d47a3.js"><link rel="prefetch" href="/assets/js/168.0afeae2a.js"><link rel="prefetch" href="/assets/js/169.7654cb31.js"><link rel="prefetch" href="/assets/js/17.eb7f9def.js"><link rel="prefetch" href="/assets/js/170.58569530.js"><link rel="prefetch" href="/assets/js/171.7db9ed40.js"><link rel="prefetch" href="/assets/js/172.3cb50ed4.js"><link rel="prefetch" href="/assets/js/173.0846425f.js"><link rel="prefetch" href="/assets/js/174.9e95f111.js"><link rel="prefetch" href="/assets/js/175.ef2098f2.js"><link rel="prefetch" href="/assets/js/176.c2635fe9.js"><link rel="prefetch" href="/assets/js/177.4fa38e8e.js"><link rel="prefetch" href="/assets/js/178.2be7037f.js"><link rel="prefetch" href="/assets/js/179.bf3bba28.js"><link rel="prefetch" href="/assets/js/18.0455f4d1.js"><link rel="prefetch" href="/assets/js/180.72c5f597.js"><link rel="prefetch" href="/assets/js/181.42287bcc.js"><link rel="prefetch" href="/assets/js/182.6cd4bf1a.js"><link rel="prefetch" href="/assets/js/183.05dbbfd9.js"><link rel="prefetch" href="/assets/js/184.03de7e00.js"><link rel="prefetch" href="/assets/js/185.42dd210e.js"><link rel="prefetch" href="/assets/js/186.28ee0f8a.js"><link rel="prefetch" href="/assets/js/187.bb58697b.js"><link rel="prefetch" href="/assets/js/188.1bc8be96.js"><link rel="prefetch" href="/assets/js/189.fac747e3.js"><link rel="prefetch" href="/assets/js/19.ae9e35d6.js"><link rel="prefetch" href="/assets/js/190.ea533ac7.js"><link rel="prefetch" href="/assets/js/191.6dc6eb13.js"><link rel="prefetch" href="/assets/js/192.184d249f.js"><link rel="prefetch" href="/assets/js/193.4a06bc12.js"><link rel="prefetch" href="/assets/js/194.8cce60a9.js"><link rel="prefetch" href="/assets/js/195.93231a13.js"><link rel="prefetch" href="/assets/js/196.4a596bde.js"><link rel="prefetch" href="/assets/js/197.96c113cf.js"><link rel="prefetch" href="/assets/js/198.73ba3f67.js"><link rel="prefetch" href="/assets/js/199.74bab595.js"><link rel="prefetch" href="/assets/js/20.b542d0e7.js"><link rel="prefetch" href="/assets/js/200.69a6928a.js"><link rel="prefetch" href="/assets/js/201.9ffa7c5a.js"><link rel="prefetch" href="/assets/js/202.41edb652.js"><link rel="prefetch" href="/assets/js/203.7fabcef3.js"><link rel="prefetch" href="/assets/js/204.b0ae2f62.js"><link rel="prefetch" href="/assets/js/205.add8738b.js"><link rel="prefetch" href="/assets/js/206.f3a712ec.js"><link rel="prefetch" href="/assets/js/207.cd7dd729.js"><link rel="prefetch" href="/assets/js/208.78b33afa.js"><link rel="prefetch" href="/assets/js/209.9d3329ff.js"><link rel="prefetch" href="/assets/js/21.5a050318.js"><link rel="prefetch" href="/assets/js/210.d285d5ac.js"><link rel="prefetch" href="/assets/js/211.8791bb3f.js"><link rel="prefetch" href="/assets/js/212.84ed81a8.js"><link rel="prefetch" href="/assets/js/213.7b990580.js"><link rel="prefetch" href="/assets/js/214.da31f20c.js"><link rel="prefetch" href="/assets/js/215.9eeed659.js"><link rel="prefetch" href="/assets/js/216.9539f0ec.js"><link rel="prefetch" href="/assets/js/217.11b575be.js"><link rel="prefetch" href="/assets/js/218.a67f12f1.js"><link rel="prefetch" href="/assets/js/219.bfbb817a.js"><link rel="prefetch" href="/assets/js/22.2bc6f7e3.js"><link rel="prefetch" href="/assets/js/220.8b01342f.js"><link rel="prefetch" href="/assets/js/221.b450decd.js"><link rel="prefetch" href="/assets/js/222.97468507.js"><link rel="prefetch" href="/assets/js/223.b6dafd73.js"><link rel="prefetch" href="/assets/js/224.c86c18c6.js"><link rel="prefetch" href="/assets/js/225.b0dcf86e.js"><link rel="prefetch" href="/assets/js/226.02cc2999.js"><link rel="prefetch" href="/assets/js/227.8474ef5a.js"><link rel="prefetch" href="/assets/js/228.0298e421.js"><link rel="prefetch" href="/assets/js/229.6aeaf595.js"><link rel="prefetch" href="/assets/js/23.9995fce4.js"><link rel="prefetch" href="/assets/js/230.a5785286.js"><link rel="prefetch" href="/assets/js/231.d791daa4.js"><link rel="prefetch" href="/assets/js/232.97aeeb00.js"><link rel="prefetch" href="/assets/js/233.46e51e28.js"><link rel="prefetch" href="/assets/js/234.2cffe82f.js"><link rel="prefetch" href="/assets/js/235.14965da6.js"><link rel="prefetch" href="/assets/js/236.00a5afc0.js"><link rel="prefetch" href="/assets/js/237.3b73d52f.js"><link rel="prefetch" href="/assets/js/238.6e1db765.js"><link rel="prefetch" href="/assets/js/239.75866c5e.js"><link rel="prefetch" href="/assets/js/24.9141eeb2.js"><link rel="prefetch" href="/assets/js/240.af9c2cc9.js"><link rel="prefetch" href="/assets/js/241.388acab2.js"><link rel="prefetch" href="/assets/js/242.c60f2b48.js"><link rel="prefetch" href="/assets/js/243.d8e81b13.js"><link rel="prefetch" href="/assets/js/244.58b0b21d.js"><link rel="prefetch" href="/assets/js/245.c3768497.js"><link rel="prefetch" href="/assets/js/246.ac8bbe7a.js"><link rel="prefetch" href="/assets/js/247.d095f70a.js"><link rel="prefetch" href="/assets/js/248.e9f210b5.js"><link rel="prefetch" href="/assets/js/249.a9fad023.js"><link rel="prefetch" href="/assets/js/25.98e8593e.js"><link rel="prefetch" href="/assets/js/250.ae7f0ebb.js"><link rel="prefetch" href="/assets/js/251.9a617d55.js"><link rel="prefetch" href="/assets/js/252.ce082446.js"><link rel="prefetch" href="/assets/js/253.4575302d.js"><link rel="prefetch" href="/assets/js/254.5899a61b.js"><link rel="prefetch" href="/assets/js/255.66c69f31.js"><link rel="prefetch" href="/assets/js/256.8fd6c706.js"><link rel="prefetch" href="/assets/js/257.31b77e5e.js"><link rel="prefetch" href="/assets/js/258.eba48891.js"><link rel="prefetch" href="/assets/js/259.edf74b59.js"><link rel="prefetch" href="/assets/js/26.e69924ea.js"><link rel="prefetch" href="/assets/js/260.cf2ed36d.js"><link rel="prefetch" href="/assets/js/261.9e7792d8.js"><link rel="prefetch" href="/assets/js/262.e7b9433e.js"><link rel="prefetch" href="/assets/js/263.1185b25c.js"><link rel="prefetch" href="/assets/js/264.5e0f89cb.js"><link rel="prefetch" href="/assets/js/265.a38d3b94.js"><link rel="prefetch" href="/assets/js/266.2ef170b3.js"><link rel="prefetch" href="/assets/js/267.a7d14651.js"><link rel="prefetch" href="/assets/js/268.05b18748.js"><link rel="prefetch" href="/assets/js/269.dad48d6f.js"><link rel="prefetch" href="/assets/js/27.13612515.js"><link rel="prefetch" href="/assets/js/270.4f5a6b8d.js"><link rel="prefetch" href="/assets/js/271.7ebf6682.js"><link rel="prefetch" href="/assets/js/272.7c2fbfd1.js"><link rel="prefetch" href="/assets/js/273.8ee20732.js"><link rel="prefetch" href="/assets/js/274.d525242a.js"><link rel="prefetch" href="/assets/js/275.a8a19acb.js"><link rel="prefetch" href="/assets/js/276.df3a4eb4.js"><link rel="prefetch" href="/assets/js/277.336debda.js"><link rel="prefetch" href="/assets/js/278.c470625f.js"><link rel="prefetch" href="/assets/js/279.a91e1a64.js"><link rel="prefetch" href="/assets/js/28.ab7ae1df.js"><link rel="prefetch" href="/assets/js/280.87e25c9a.js"><link rel="prefetch" href="/assets/js/281.87c1ba25.js"><link rel="prefetch" href="/assets/js/282.dcd4dce0.js"><link rel="prefetch" href="/assets/js/283.abac2e00.js"><link rel="prefetch" href="/assets/js/284.f6079659.js"><link rel="prefetch" href="/assets/js/285.f1b39879.js"><link rel="prefetch" href="/assets/js/286.f6a79242.js"><link rel="prefetch" href="/assets/js/287.06bebe07.js"><link rel="prefetch" href="/assets/js/288.89e325df.js"><link rel="prefetch" href="/assets/js/289.3aa1bedd.js"><link rel="prefetch" href="/assets/js/29.ebe50f76.js"><link rel="prefetch" href="/assets/js/290.ee059c92.js"><link rel="prefetch" href="/assets/js/291.fa9a921a.js"><link rel="prefetch" href="/assets/js/292.2a8811cd.js"><link rel="prefetch" href="/assets/js/293.eec09cdf.js"><link rel="prefetch" href="/assets/js/294.dfac20dc.js"><link rel="prefetch" href="/assets/js/295.825d2070.js"><link rel="prefetch" href="/assets/js/296.f645861e.js"><link rel="prefetch" href="/assets/js/297.424fdb17.js"><link rel="prefetch" href="/assets/js/298.ebf87cdc.js"><link rel="prefetch" href="/assets/js/299.b8f19cbb.js"><link rel="prefetch" href="/assets/js/30.75237511.js"><link rel="prefetch" href="/assets/js/300.10fb6d4f.js"><link rel="prefetch" href="/assets/js/301.ef77c612.js"><link rel="prefetch" href="/assets/js/302.1b839763.js"><link rel="prefetch" href="/assets/js/303.609f7d98.js"><link rel="prefetch" href="/assets/js/304.1d255f19.js"><link rel="prefetch" href="/assets/js/305.b0234f2c.js"><link rel="prefetch" href="/assets/js/306.48677f64.js"><link rel="prefetch" href="/assets/js/307.14390d4b.js"><link rel="prefetch" href="/assets/js/308.fa730b28.js"><link rel="prefetch" href="/assets/js/309.0496b9e0.js"><link rel="prefetch" href="/assets/js/31.cf3f471a.js"><link rel="prefetch" href="/assets/js/310.a31676dc.js"><link rel="prefetch" href="/assets/js/311.ed53adc5.js"><link rel="prefetch" href="/assets/js/312.1b0ff2f1.js"><link rel="prefetch" href="/assets/js/313.bf123f32.js"><link rel="prefetch" href="/assets/js/314.4e6ce06b.js"><link rel="prefetch" href="/assets/js/315.8eb18560.js"><link rel="prefetch" href="/assets/js/32.74fef842.js"><link rel="prefetch" href="/assets/js/33.bc2d190b.js"><link rel="prefetch" href="/assets/js/34.d23438fc.js"><link rel="prefetch" href="/assets/js/35.7675c4d0.js"><link rel="prefetch" href="/assets/js/36.96a4161b.js"><link rel="prefetch" href="/assets/js/37.d1824f2f.js"><link rel="prefetch" href="/assets/js/38.4effff9e.js"><link rel="prefetch" href="/assets/js/39.6509914b.js"><link rel="prefetch" href="/assets/js/4.4d01750f.js"><link rel="prefetch" href="/assets/js/40.1509d08b.js"><link rel="prefetch" href="/assets/js/41.f2c1124f.js"><link rel="prefetch" href="/assets/js/42.e541d077.js"><link rel="prefetch" href="/assets/js/43.369de999.js"><link rel="prefetch" href="/assets/js/44.43959db0.js"><link rel="prefetch" href="/assets/js/45.282fbd31.js"><link rel="prefetch" href="/assets/js/46.1b83cfe9.js"><link rel="prefetch" href="/assets/js/47.c3a88e41.js"><link rel="prefetch" href="/assets/js/48.bc7c0a1b.js"><link rel="prefetch" href="/assets/js/49.92a4e5ba.js"><link rel="prefetch" href="/assets/js/5.c3991e24.js"><link rel="prefetch" href="/assets/js/50.9c488c6c.js"><link rel="prefetch" href="/assets/js/51.546ea632.js"><link rel="prefetch" href="/assets/js/52.0d2ccee1.js"><link rel="prefetch" href="/assets/js/53.6f52b5b1.js"><link rel="prefetch" href="/assets/js/54.c838b295.js"><link rel="prefetch" href="/assets/js/55.13af99ee.js"><link rel="prefetch" href="/assets/js/56.6be6d1ed.js"><link rel="prefetch" href="/assets/js/57.67c98b39.js"><link rel="prefetch" href="/assets/js/58.107e82ec.js"><link rel="prefetch" href="/assets/js/59.b3e5edc7.js"><link rel="prefetch" href="/assets/js/6.36a535f9.js"><link rel="prefetch" href="/assets/js/60.3b0b4ba5.js"><link rel="prefetch" href="/assets/js/61.3df843df.js"><link rel="prefetch" href="/assets/js/62.1213823d.js"><link rel="prefetch" href="/assets/js/63.e8f3f926.js"><link rel="prefetch" href="/assets/js/64.e1219050.js"><link rel="prefetch" href="/assets/js/65.5bf5bb0b.js"><link rel="prefetch" href="/assets/js/66.a2502afb.js"><link rel="prefetch" href="/assets/js/67.690dd59b.js"><link rel="prefetch" href="/assets/js/68.de7b0915.js"><link rel="prefetch" href="/assets/js/69.ac61dd61.js"><link rel="prefetch" href="/assets/js/7.5d254238.js"><link rel="prefetch" href="/assets/js/70.3edd41b1.js"><link rel="prefetch" href="/assets/js/71.d23407e9.js"><link rel="prefetch" href="/assets/js/72.a5bd01bc.js"><link rel="prefetch" href="/assets/js/73.c9f4dd57.js"><link rel="prefetch" href="/assets/js/74.66323fc1.js"><link rel="prefetch" href="/assets/js/75.e1a72e00.js"><link rel="prefetch" href="/assets/js/76.801268b4.js"><link rel="prefetch" href="/assets/js/77.3a5fda67.js"><link rel="prefetch" href="/assets/js/78.54d84cd4.js"><link rel="prefetch" href="/assets/js/79.fa10f4e3.js"><link rel="prefetch" href="/assets/js/8.e060e47d.js"><link rel="prefetch" href="/assets/js/80.d5b24fea.js"><link rel="prefetch" href="/assets/js/81.0e9da714.js"><link rel="prefetch" href="/assets/js/82.e96ff6d7.js"><link rel="prefetch" href="/assets/js/83.771cced1.js"><link rel="prefetch" href="/assets/js/84.220b69e7.js"><link rel="prefetch" href="/assets/js/85.7dcc5659.js"><link rel="prefetch" href="/assets/js/86.44ba2100.js"><link rel="prefetch" href="/assets/js/87.281da75d.js"><link rel="prefetch" href="/assets/js/88.12d88449.js"><link rel="prefetch" href="/assets/js/89.f28c86d3.js"><link rel="prefetch" href="/assets/js/9.8f9fef32.js"><link rel="prefetch" href="/assets/js/90.715cabb2.js"><link rel="prefetch" href="/assets/js/91.6ced7c82.js"><link rel="prefetch" href="/assets/js/92.c05b33ca.js"><link rel="prefetch" href="/assets/js/93.6bf5fb66.js"><link rel="prefetch" href="/assets/js/94.3561200e.js"><link rel="prefetch" href="/assets/js/95.0f2cf716.js"><link rel="prefetch" href="/assets/js/96.ac8487ea.js"><link rel="prefetch" href="/assets/js/97.48042b5a.js"><link rel="prefetch" href="/assets/js/98.441bb7f8.js"><link rel="prefetch" href="/assets/js/99.4b214d92.js">
    <link rel="stylesheet" href="/assets/css/0.styles.56073ad3.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu"><header class="navbar blur"><div title="ç›®å½•" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/img/magic.png" alt="Pangolin Note" class="logo"> <span class="site-name can-hide">Pangolin Note</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">ğŸ¡é¦–é¡µ</a></div><div class="nav-item"><a href="/basic/" class="nav-link">åŸºç¡€</a></div><div class="nav-item"><a href="/develop/" class="nav-link">å¼€å‘</a></div><div class="nav-item"><a href="/middleware/" class="nav-link">ç³»ç»Ÿ</a></div><div class="nav-item"><a href="/algorithm/" class="nav-link">ç®—æ³•</a></div><div class="nav-item"><a href="/books/" class="nav-link">ğŸ€è¯»ä¹¦ç¬”è®°</a></div><div class="nav-item"><a href="/work/" class="nav-link">å·¥ä½œ</a></div><div class="nav-item"><a href="/pangolin/" class="nav-link">ğŸŒ¸è¾¾å°”æ–‡çš„çŒ¹</a></div><div class="nav-item"><a href="/pages/beb6c0bd8a66cea6/" class="nav-link">æ”¶è—</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="ç´¢å¼•" class="dropdown-title"><a href="/archives/" class="link-title">ç´¢å¼•</a> <span class="title" style="display:none;">ç´¢å¼•</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">åˆ†ç±»</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">æ ‡ç­¾</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">å½’æ¡£</a></li></ul></div></div> <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><div class="blogger"><img src="/img/avatarnew.png"> <div class="blogger-info"><h3>è¾¾å°”æ–‡çš„çŒ¹</h3> <span>å¤§é“è‡³ç®€ æ‚Ÿåœ¨å¤©æˆ</span></div></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">ğŸ¡é¦–é¡µ</a></div><div class="nav-item"><a href="/basic/" class="nav-link">åŸºç¡€</a></div><div class="nav-item"><a href="/develop/" class="nav-link">å¼€å‘</a></div><div class="nav-item"><a href="/middleware/" class="nav-link">ç³»ç»Ÿ</a></div><div class="nav-item"><a href="/algorithm/" class="nav-link">ç®—æ³•</a></div><div class="nav-item"><a href="/books/" class="nav-link">ğŸ€è¯»ä¹¦ç¬”è®°</a></div><div class="nav-item"><a href="/work/" class="nav-link">å·¥ä½œ</a></div><div class="nav-item"><a href="/pangolin/" class="nav-link">ğŸŒ¸è¾¾å°”æ–‡çš„çŒ¹</a></div><div class="nav-item"><a href="/pages/beb6c0bd8a66cea6/" class="nav-link">æ”¶è—</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="ç´¢å¼•" class="dropdown-title"><a href="/archives/" class="link-title">ç´¢å¼•</a> <span class="title" style="display:none;">ç´¢å¼•</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">åˆ†ç±»</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">æ ‡ç­¾</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">å½’æ¡£</a></li></ul></div></div> <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Java</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading open"><span>åŸºç¡€</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/4f30b9/" class="sidebar-link">JavaåŸºç¡€</a></li><li><a href="/pages/795eca/" class="sidebar-link">ç±»ä¸ç»§æ‰¿</a></li><li><a href="/pages/c69152/" class="sidebar-link">æŠ½è±¡ç±»ä¸æ¥å£</a></li><li><a href="/pages/d71abb/" class="sidebar-link">å†…éƒ¨ç±»</a></li><li><a href="/pages/f06dca/" class="sidebar-link">æšä¸¾ç±»</a></li><li><a href="/pages/259f57/" class="sidebar-link">å¸¸ç”¨ç±»</a></li><li><a href="/pages/84b03b/" class="sidebar-link">å…³é”®å­—</a></li><li><a href="/pages/31b87b/" class="sidebar-link">æ³¨è§£</a></li><li><a href="/pages/f81c0d/" class="sidebar-link">å¼‚å¸¸</a></li><li><a href="/pages/ae7746/" class="sidebar-link">æ³›å‹</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading"><span>å®¹å™¨ç±»</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/0c88ac/" class="sidebar-link">é›†åˆå®¹å™¨ç±»åŸºç¡€</a></li><li><a href="/pages/f805ed/" class="sidebar-link">Listä¸Queueç±»</a></li><li><a href="/pages/d24b60/" class="sidebar-link">Mapä¸Setç±»</a></li><li><a href="/pages/54e5d3/" class="sidebar-link">å¹¶å‘å®¹å™¨ç±»</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading"><span>å¹¶å‘</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/67d70f/" class="sidebar-link">å¤šçº¿ç¨‹åŸºç¡€</a></li><li><a href="/pages/ffc8f7/" class="sidebar-link">Javaå†…ç½®é”</a></li><li><a href="/pages/c43494/" class="sidebar-link">AQS</a></li><li><a href="/pages/eb5b61/" class="sidebar-link">æ˜¾å¼é”ReentrantLock</a></li><li><a href="/pages/eb8cbc/" class="sidebar-link">çº¿ç¨‹åä½œä¸JUCç»„ä»¶</a></li><li><a href="/pages/23c79a/" class="sidebar-link">AtomicåŸå­å˜é‡ä¸Unsafeç±»ä¸CAS</a></li><li><a href="/pages/9d6ed4/" class="sidebar-link">çº¿ç¨‹æ± ä¸å®šæ—¶ä»»åŠ¡</a></li><li><a href="/pages/5b787a/" class="sidebar-link">ThreadLocal</a></li><li><a href="/pages/db53d1/" class="sidebar-link">Javaå¹¶å‘ç¼–ç¨‹å®æˆ˜(æå®¢æ—¶é—´)ğŸŒ¸</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading"><span>IO</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/b4d461/" class="sidebar-link">æ–‡ä»¶æ“ä½œ</a></li><li><a href="/pages/1b9d6c/" class="sidebar-link">IOæµæ“ä½œ</a></li><li><a href="/pages/076a47/" class="sidebar-link">Javaç½‘ç»œIOæ¨¡å‹</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading"><span>é«˜çº§ç‰¹æ€§</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/d76905/" class="sidebar-link">Lambdaè¡¨è¾¾å¼</a></li><li><a href="/pages/f7f0e6/" class="sidebar-link">æµStream</a></li><li><a href="/pages/7cc40a/" class="sidebar-link">åå°„</a></li><li><a href="/pages/945326/" class="sidebar-link">ä»£ç†</a></li><li><a href="/pages/7fd9b4/" class="sidebar-link">Javaagent</a></li><li><a href="/pages/a3cee0/" class="sidebar-link">Guava</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading"><span>JVM</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/d308f6/" class="sidebar-link">èµ°è¿›JVMğŸŒ¼</a></li><li><a href="/pages/be0269/" class="sidebar-link">JVMå†…å­˜åŒºåŸŸä¸å¯¹è±¡è§£æğŸŒ¼</a></li><li><a href="/pages/48d1be/" class="sidebar-link">åƒåœ¾æ”¶é›†å™¨ä¸å†…å­˜åˆ†é…ç­–ç•¥ğŸŒ¼</a></li><li><a href="/pages/3a4c8a/" class="sidebar-link">JVMæ€§èƒ½ç›‘æ§ä¸æ•…éšœå¤„ç†å·¥å…·ğŸŒ¼</a></li><li><a href="/pages/106680/" class="sidebar-link">è°ƒä¼˜æ¡ˆä¾‹åˆ†æä¸å®æˆ˜ğŸŒ¼</a></li><li><a href="/pages/16a914/" class="sidebar-link">ç±»æ–‡ä»¶ç»“æ„ğŸŒ¼</a></li><li><a href="/pages/ea287c/" class="sidebar-link">è™šæ‹Ÿæœºç±»åŠ è½½æœºåˆ¶ğŸŒ¼</a></li><li><a href="/pages/6367b0/" class="sidebar-link">è™šæ‹Ÿæœºå­—èŠ‚ç æ‰§è¡Œå¼•æ“ğŸŒ¼</a></li><li><a href="/pages/c6c210/" class="sidebar-link">ç±»åŠ è½½åŠæ‰§è¡Œå­ç³»ç»Ÿçš„æ¡ˆä¾‹ä¸å®æˆ˜ğŸŒ¼</a></li><li><a href="/pages/deb8b7/" class="sidebar-link">å‰ç«¯ç¼–è¯‘ä¸ä¼˜åŒ–ğŸŒ¼</a></li><li><a href="/pages/1f8f72/" class="sidebar-link">åç«¯ç¼–è¯‘ä¸ä¼˜åŒ–ğŸŒ¼</a></li><li><a href="/pages/3d72db/" class="sidebar-link">Javaå†…å­˜æ¨¡å‹ä¸çº¿ç¨‹å®ç°ğŸŒ¼</a></li><li><a href="/pages/ed086e/" class="sidebar-link">çº¿ç¨‹å®‰å…¨ä¸å†…ç½®é”ä¼˜åŒ–ğŸŒ¼</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading"><span>å…¶ä»–</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/56b9dd/" class="sidebar-link">Javaæ€§èƒ½é—®é¢˜å®šä½åˆ†æ</a></li><li><a href="/pages/939bf8/" class="sidebar-link">æ‚è®°</a></li></ul></section></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>å¼€å‘</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading"><span>è½¯ä»¶è®¾è®¡</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/a5f6fe/" class="sidebar-link">è®¾è®¡åŸºç¡€ç†è®º</a></li><li><a href="/pages/3b245c/" class="sidebar-link">è®¾è®¡æ¨¡å¼ä¹‹ç¾(æå®¢æ—¶é—´)ğŸŒŸ</a></li><li><a href="/pages/661fa4/" class="sidebar-link">é¢†åŸŸé©±åŠ¨è®¾è®¡(DDD)</a></li><li><a href="/pages/856368/" class="sidebar-link">DDDå®æˆ˜è¯¾(æå®¢æ—¶é—´)ğŸŒ¸</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading"><span>æ•°æ®åº“</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/d3fbd2/" class="sidebar-link">æ•°æ®åº“åŸºç¡€</a></li><li><a href="/pages/691fc3/" class="sidebar-link">æ•°æ®åº“ç³»ç»ŸåŸç†</a></li><li><a href="/pages/50f6b7/" class="sidebar-link">MySQLåŸºç¡€å¿…çŸ¥å¿…ä¼š</a></li><li><a href="/pages/fe297e/" class="sidebar-link">MySQLç‰¹æ€§</a></li><li><a href="/pages/07bdb6/" class="sidebar-link">MySQLç´¢å¼•ğŸŒŸ</a></li><li><a href="/pages/984715/" class="sidebar-link">MySQLé”ğŸŒŸ</a></li><li><a href="/pages/53b588/" class="sidebar-link">MySQLäº‹åŠ¡ğŸŒŸ</a></li><li><a href="/pages/becc59/" class="sidebar-link">MySQLé«˜çº§ç‰¹æ€§</a></li><li><a href="/pages/056463/" class="sidebar-link">MySQLåŸºç¡€æ¶æ„ä¸å­˜å‚¨å¼•æ“ğŸŒŸ</a></li><li><a href="/pages/63b46e/" class="sidebar-link">MySQLæ¶æ„ä¼˜åŒ–ä¸è¿ç»´</a></li><li><a href="/pages/9995e5/" class="sidebar-link">MySQLä¼˜åŒ–</a></li><li><a href="/pages/c1c2f6/" class="sidebar-link">MySQLæ¶æ„</a></li><li><a href="/pages/8e8e0a/" class="sidebar-link">MySQLè®¾è®¡è§„èŒƒ</a></li><li><a href="/pages/0219aa/" class="sidebar-link">MySQLè¿ç»´</a></li><li><a href="/pages/e288c0/" class="sidebar-link">MySQLä¸­é—´ä»¶</a></li><li><a href="/pages/c6cafa/" class="sidebar-link">MySQLå®æˆ˜45è®²(æå®¢æ—¶é—´)ğŸŒŸ</a></li><li><a href="/pages/4a6106/" class="sidebar-link">æ•°æ®åº“LeetCodeé¢˜ç›®</a></li><li><a href="/pages/2827f1/" class="sidebar-link">æ•°æ®åº“ç»¼åˆé—®é¢˜</a></li><li><a href="/pages/c616d5/" class="sidebar-link">MongoDB</a></li><li><a href="/pages/075e71/" class="sidebar-link">ClickHouse</a></li><li><a href="/pages/d74f6d/" class="sidebar-link">Doris</a></li><li><a href="/pages/b6bad9/" class="sidebar-link">HBase</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading open"><span>Spring</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/bd8eb8/" class="sidebar-link">Spring BootåŸºç¡€</a></li><li><a href="/pages/d0d797/" class="sidebar-link">Spring Bootåº”ç”¨æ•´åˆ</a></li><li><a href="/pages/314cdc/" class="sidebar-link">Spring MVCåŸºç¡€</a></li><li><a href="/pages/80de47/" class="sidebar-link">Spring AOPåŸºç¡€</a></li><li><a href="/pages/f0d4d6/" class="sidebar-link">Springäº‹åŠ¡åŸºç¡€</a></li><li><a href="/pages/db6afe/" aria-current="page" class="active sidebar-link">Spring IOCæºç åˆ†æ-æ¦‚è§ˆ</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/pages/672e98/" class="sidebar-link">Spring IOCæºç åˆ†æ-getBean()</a></li><li><a href="/pages/695b90/" class="sidebar-link">Spring IOCæºç åˆ†æ-createBean()</a></li><li><a href="/pages/f89bcf/" class="sidebar-link">Spring AOPæºç åˆ†æ</a></li><li><a href="/pages/3b52f4/" class="sidebar-link">Springäº‹åŠ¡æºç åˆ†æ</a></li><li><a href="/pages/186902/" class="sidebar-link">Spring Bootæºç åˆ†æ</a></li><li><a href="/pages/16bd1c/" class="sidebar-link">Spring MVCæºç åˆ†æ</a></li><li><a href="/pages/3d0c1f/" class="sidebar-link">Spring Cloud</a></li><li><a href="/pages/d56156/" class="sidebar-link">Springç¼–ç¨‹å¸¸è§é”™è¯¯50ä¾‹(æå®¢æ—¶é—´)ğŸŒ¸</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading"><span>MyBatis</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/bb032d/" class="sidebar-link">åŸºç¡€</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading"><span>å·¥å…·ä¸ç¯å¢ƒ</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/c9cb6e/" class="sidebar-link">Arthas</a></li><li><a href="/pages/3172bb/" class="sidebar-link">Maven</a></li><li><a href="/pages/37f79a/" class="sidebar-link">Git</a></li><li><a href="/pages/db9f99/" class="sidebar-link">ç¯å¢ƒæ­å»ºä¸éƒ¨ç½²</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading"><span>æµ‹è¯•</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/c725f5/" class="sidebar-link">æµ‹è¯•åŸºç¡€</a></li><li><a href="/pages/7893a4/" class="sidebar-link">å•å…ƒæµ‹è¯•</a></li><li><a href="/pages/af9f25/" class="sidebar-link">å‹åŠ›æµ‹è¯•</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading"><span>ä»£ç è´¨é‡</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/ec2b81/" class="sidebar-link">ä»£ç æ•´æ´ä¹‹é“</a></li><li><a href="/pages/474cdf/" class="sidebar-link">é˜¿é‡Œå·´å·´ç¼–ç¨‹è§„èŒƒ</a></li><li><a href="/pages/c47e15/" class="sidebar-link">ä»£ç ä¹‹ä¸‘(æå®¢æ—¶é—´)ğŸŒ¸</a></li><li><a href="/pages/4d4606/" class="sidebar-link">Javaä¸šåŠ¡å¼€å‘å¸¸è§é”™è¯¯100ä¾‹(æå®¢æ—¶é—´)ğŸŒ¸</a></li></ul></section></li></ul></section></li></ul> </aside> <div><main class="page"><div class="theme-vdoing-wrapper "><div class="articleInfo-wrap" data-v-06970110><div class="articleInfo" data-v-06970110><ul class="breadcrumbs" data-v-06970110><li data-v-06970110><a href="/" title="é¦–é¡µ" class="iconfont icon-home router-link-active" data-v-06970110></a></li> <li data-v-06970110><a href="/develop/#å¼€å‘" data-v-06970110>å¼€å‘</a></li><li data-v-06970110><a href="/develop/#å¼€å‘" data-v-06970110>å¼€å‘</a></li><li data-v-06970110><a href="/develop/#Spring" data-v-06970110>Spring</a></li></ul> <div class="info" data-v-06970110><div title="ä½œè€…" class="author iconfont icon-touxiang" data-v-06970110><a href="https://github.com/nanodaemony" target="_blank" title="ä½œè€…" class="beLink" data-v-06970110>NanoDaemony</a></div> <div title="åˆ›å»ºæ—¶é—´" class="date iconfont icon-riqi" data-v-06970110><a href="javascript:;" data-v-06970110>2025-02-26</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-title">æœ¬æ–‡ç›®å½•</div> <div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABGpJREFUSA3tVVtoXFUU3fvOI53UlmCaKIFmwEhsE7QK0ipFEdHEKpXaZGrp15SINsXUWvBDpBgQRKi0+KKoFeJHfZA+ED9KKoIU2gYD9UejTW4rVIzm0VSTziPzuNu1z507dibTTjL4U/DAzLn3nL3X2o91ziX6f9wMFdh6Jvbm9nNSV0msViVO6tN1Rm7NMu2OpeJ9lWBUTDxrJbYTS0hInuwciu9eLHlFxCLCZEk3MegsJmZ5K/JD6t7FkFdEvGUo1g7qJoG3MHImqRIn8/nzY1K9UPKKiJmtnUqHVE3Gbuay6vJE/N2FEmuxFjW2nUuE0yQXRRxLiTUAzs36zhZvOXJPdX850EVnnLZkB8prodQoM5JGj7Xk2mvC7JB8tG04Ef5PiXtG0UtxupRQSfTnBoCy554x18yJHI6I+G5Eru4LHmPJZEQsrvPUbMiA8G/WgMK7w7I+ez7++o2ANfbrjvaOl1tFMs+htG3IrZH9/hDX1Pr8Tc0UvH8tcX29KzAgIGcEkINyW5BF9x891hw6VYqgJHEk0huccS7vh3C6gTiODL+26huuBtbct8eZnqLML8PkxGYpuPZBqtqwkSjgc4mB5gbgig5i+y0UDK35LMxXisn9xQtK+nd26gTIHsHe/oblK/b29fUmN/8Y+9jAQrnBp56m1LcDlDp9irKTExSKduXJVWSqdBMA08pEJnEIOB3FPPMybu/oeV8zFeYN3xx576Q6RH+VmplE4ncQV5v+5rzSoyOU7PuEAg8g803PwBJ0CExno/jcMbN8tONYeOmHiuUNryvm3fRUy4tMPVLdAGkUhNWuggGrJcXPv+ouCjz0MKUHz1J2/E8IC9nqTabcxgaBYM0hPhD5Y65FsbxRQKxCQrDjDctW7PUM3HuZunFyifSAqEfuzCp48Il24luWUWZoyJCaPR82jE0+kFA643wRFVni4RYSq3ohJO2pZ7B5dO4xkDWbEpossJPLSrPjYID8rS2UHTlvyNxqIGsg674XJJ7vnh5L7PNwC4hh2sjCI96mzszOTpxLF0T7l88Yz7lAuK6OnL8gXLOnTvpzSb22YG8W7us3jSebFHeeqnXRG1vt+MoUM84LQIBmMsCTAcOauTh0T0l0neQK7m2bLMt2mGxU3HYssS0J2cdv5wljlPsrIuZLAG/2DOZIXgCYT8uMGZN+e2kSirfxZOPCsC0f24nTZzspnVn9VePS1Z5vubmAGGXG8ZFno9Hel0yfA5ZPhF7Dh972BQJ2qCpgH67lmWtBYbvk6sz02wjky2vXyz0XErP/kFB619js1BtwfOV4OPRqOQBjy3Qbk18vigUPPSD5ceHnwck7W9bhAqZdd7SuG7w4/P2F/GaJh8c7e9qgow+Q7cGBo+98WsLkuktFqiZabtXuQTu/Y5ETbR0v7tNSFnvrmu6pjdoan2KjMu8q/Hmj1EfCO2ZGfEIbIXKUlw8qaX9/b2oeSJmFksSeT/Fn0V3nSypChh4Gjh74ybO9aeZ/AN2dwciu2/MhAAAAAElFTkSuQmCC">Spring IOCæºç åˆ†æ-æ¦‚è§ˆ<!----></h1>  <div class="theme-vdoing-content content__default"><h1 id="_10-spring-iocæºç åˆ†æ-æ¦‚è§ˆ"><a href="#_10-spring-iocæºç åˆ†æ-æ¦‚è§ˆ" class="header-anchor">#</a> 10.Spring IOCæºç åˆ†æ-æ¦‚è§ˆ</h1> <h3 id="åŸºç¡€"><a href="#åŸºç¡€" class="header-anchor">#</a> åŸºç¡€</h3> <h4 id="springå®¹å™¨ç»§æ‰¿å›¾"><a href="#springå®¹å™¨ç»§æ‰¿å›¾" class="header-anchor">#</a> Springå®¹å™¨ç»§æ‰¿å›¾</h4> <p><img src="https://nano-note.oss-cn-beijing.aliyuncs.com/images/wecom-temp-bc3754265b2ff7a526fcd02a9e79da8b.png" alt="wecom-temp-bc3754265b2ff7a526fcd02a9e79da8b"></p> <h3 id="å¼•å…¥ä¸æ„é€ æ–¹æ³•"><a href="#å¼•å…¥ä¸æ„é€ æ–¹æ³•" class="header-anchor">#</a> å¼•å…¥ä¸æ„é€ æ–¹æ³•</h3> <h4 id="åˆ†æå¼•å…¥"><a href="#åˆ†æå¼•å…¥" class="header-anchor">#</a> åˆ†æå¼•å…¥</h4> <p>å®šä¹‰é…ç½®ç±»å¦‚ä¸‹.</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">NanoConfig</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Bean</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;testBean&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">TestBean</span> <span class="token function">testBean</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">TestBean</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>åˆå§‹åŒ–ä¸€ä¸ªå®¹å™¨, ç„¶åä»å®¹å™¨è·å–æŒ‡å®šåç§°çš„ bean.</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ä¼ å…¥é…ç½®ç±»</span>
    <span class="token class-name">AnnotationConfigApplicationContext</span> context <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AnnotationConfigApplicationContext</span><span class="token punctuation">(</span><span class="token class-name">NanoConfig</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span><span class="token string">&quot;testBean&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>è¿›å…¥ AnnotationConfigApplicationContext çš„æ„é€ å™¨.</p> <blockquote><p>AnnotationConfigApplicationContextæ„é€ æ–¹æ³•</p></blockquote> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">AnnotationConfigApplicationContext</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> annotatedClasses<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// æ„é€ å™¨: (1)æ³¨å†Œäº†å†…éƒ¨ç”¨åˆ°çš„å„ç§å¤„ç†å™¨çš„BeanDefinition; (2)é…ç½®äº†é»˜è®¤çš„åŒ…æ‰«æç­–ç•¥;</span>
    <span class="token keyword">this</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// å¾€å®¹å™¨ä¸­æ³¨å†Œä¼ å…¥çš„é…ç½®ç±»</span>
    <span class="token function">register</span><span class="token punctuation">(</span>annotatedClasses<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// æå…¶é‡è¦...</span>
    <span class="token function">refresh</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>è¿™é‡Œä¸»è¦æµç¨‹å¦‚ä¸‹:</p> <p><img src="https://nano-note.oss-cn-beijing.aliyuncs.com/images/image-20220131171127462.png" alt="image-20220131171127462"></p> <p>ä¸‹é¢ä¾æ¬¡åˆ†æä¸Šè¿°æ–¹æ³•çš„ä¸‰å¥ä»£ç .</p> <h4 id="å‡†å¤‡å·¥ä½œ"><a href="#å‡†å¤‡å·¥ä½œ" class="header-anchor">#</a> å‡†å¤‡å·¥ä½œ</h4> <p>é¦–å…ˆçœ‹è°ƒç”¨ this() æ–¹æ³•å¦‚ä¸‹. å®Œæˆçš„äº‹æƒ…: (1)æ³¨å†Œäº†å†…éƒ¨ç”¨åˆ°çš„å„ç§å¤„ç†å™¨çš„ BeanDefinition; (2)é…ç½®äº†é»˜è®¤çš„åŒ…æ‰«æç­–ç•¥;</p> <h5 id="_1-æ„é€ æ–¹æ³•"><a href="#_1-æ„é€ æ–¹æ³•" class="header-anchor">#</a> 1.æ„é€ æ–¹æ³•</h5> <p>this() æ–¹æ³•åˆå§‹åŒ–ä¸€ä¸ªå®¹å™¨å¯¹è±¡. ç”±äº AnnotationConfigApplicationContext ç±»ç»§æ‰¿äº† <strong>GenericApplicationContext</strong> ç±», æ‰€ä»¥è¿™é‡Œå…ˆåˆå§‹åŒ–çˆ¶ç±» GenericApplicationContext å¯¹è±¡, å…¶åˆå§‹åŒ–æ–¹æ³•å¦‚ä¸‹.</p> <blockquote><p>GenericApplicationContextæ„é€ æ–¹æ³•</p></blockquote> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">GenericApplicationContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// è°ƒç”¨é»˜è®¤æ„é€ æ–¹æ³•</span>
    <span class="token comment">// DefaultListableBeanFactoryæ˜¯å„ç§æ¥å£çš„å®ç°ç±», åŠŸèƒ½é½å…¨</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>beanFactory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultListableBeanFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>è¿™é‡Œå®ä¾‹åŒ–äº†ä¸€ä¸ª <strong>DefaultListableBeanFactory</strong> å¯¹è±¡ä½œä¸º beanFactory çš„å®ç°. å¯ä»¥çœ‹ä¸‹é¢çš„ç»§æ‰¿å›¾, è¿™é‡Œçœ‹åˆ° DefaultListableBeanFactory å®ç°äº†å¤šä¸ªæ¥å£, åŠŸèƒ½æœ€ä¸ºé½å…¨.</p> <p><img src="https://nano-note.oss-cn-beijing.aliyuncs.com/images/wecom-temp-bc3754265b2ff7a526fcd02a9e79da8b-0097455.png" alt="wecom-temp-bc3754265b2ff7a526fcd02a9e79da8b"></p> <p>å†å›åˆ° AnnotationConfigApplicationContext ç±»çš„æ„é€ å™¨. æºç å¦‚ä¸‹.</p> <blockquote><p>AnnotationConfigApplicationContextæ„é€ æ–¹æ³•</p></blockquote> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">AnnotationConfigApplicationContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token comment">// é¦–å…ˆè¿›è¡Œæ„é€  æœ¬ç±»ç»§æ‰¿äº†GenericApplicationContext å› æ­¤ä¼šå…ˆè¿›è¡Œçˆ¶ç±»çš„åˆå§‹åŒ–</span>
    <span class="token comment">// è¿™é‡Œçˆ¶ç±»ç”¨ DefaultListableBeanFactory å®ä¾‹åŒ–äº†ä¸€ä¸ªBeanFactory!!!!</span>

    <span class="token comment">// BeanDefinitionè¯»å–å™¨</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>reader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AnnotatedBeanDefinitionReader</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// åˆå§‹åŒ–ä¸€ä¸ªæ ¹æ®è·¯å¾„è¿›è¡ŒåŒ…æ‰«æçš„Scanner!!!</span>
    <span class="token comment">// æŒ‡å®šäº†é»˜è®¤çš„æ‰«æç­–ç•¥ æ‰«æ @Component ç›¸å…³çš„ç±»!</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>scanner <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ClassPathBeanDefinitionScanner</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>è¿™é‡Œå®ä¾‹åŒ–äº†ä¸¤ä¸ªå¯¹è±¡, åˆ†åˆ«æ˜¯ BeanDefinition è¯»å–å™¨å’ŒåŒ…æ‰«æå™¨.</p> <h5 id="_2-åˆå§‹åŒ–annotatedbeandefinitionreader"><a href="#_2-åˆå§‹åŒ–annotatedbeandefinitionreader" class="header-anchor">#</a> 2.åˆå§‹åŒ–AnnotatedBeanDefinitionReader</h5> <p>é¦–å…ˆåˆå§‹åŒ–äº†ä¸€ä¸ª BeanDefinition çš„è¯»å–å™¨. çœ‹çœ‹æºç .</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">this</span><span class="token punctuation">.</span>reader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AnnotatedBeanDefinitionReader</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><blockquote><p>AnnotatedBeanDefinitionReaderæ„é€ æ–¹æ³•</p></blockquote> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">AnnotatedBeanDefinitionReader</span><span class="token punctuation">(</span><span class="token class-name">BeanDefinitionRegistry</span> registry<span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token comment">// å…ˆç”Ÿæˆç¯å¢ƒå†åˆ›å»º</span>
    <span class="token keyword">this</span><span class="token punctuation">(</span>registry<span class="token punctuation">,</span> <span class="token function">getOrCreateEnvironment</span><span class="token punctuation">(</span>registry<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>è¿›å» this() æ–¹æ³•.</p> <blockquote><p>AnnotatedBeanDefinitionReaderé‡è½½æ„é€ æ–¹æ³•</p></blockquote> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">AnnotatedBeanDefinitionReader</span><span class="token punctuation">(</span><span class="token class-name">BeanDefinitionRegistry</span> registry<span class="token punctuation">,</span> <span class="token class-name">Environment</span> environment<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">notNull</span><span class="token punctuation">(</span>registry<span class="token punctuation">,</span> <span class="token string">&quot;BeanDefinitionRegistry must not be null&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">notNull</span><span class="token punctuation">(</span>environment<span class="token punctuation">,</span> <span class="token string">&quot;Environment must not be null&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>registry <span class="token operator">=</span> registry<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>conditionEvaluator <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConditionEvaluator</span><span class="token punctuation">(</span>registry<span class="token punctuation">,</span> environment<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// è¿™é‡Œå¾ˆé‡è¦</span>
    <span class="token comment">// å¾€å®¹å™¨ä¸­æ³¨å…¥äº†å„ç§å†…éƒ¨éœ€è¦çš„ç»„ä»¶çš„BeanDefinition!!!</span>
    <span class="token class-name">AnnotationConfigUtils</span><span class="token punctuation">.</span><span class="token function">registerAnnotationConfigProcessors</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>registry<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>registerAnnotationConfigProcessors() æ–¹æ³•å¦‚ä¸‹.</p> <blockquote><p>AnnotationConfigUtils.registerAnnotationConfigProcessors()</p></blockquote> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">registerAnnotationConfigProcessors</span><span class="token punctuation">(</span><span class="token class-name">BeanDefinitionRegistry</span> registry<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// è¿›å»çœ‹</span>
    <span class="token function">registerAnnotationConfigProcessors</span><span class="token punctuation">(</span>registry<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>ä¸‹é¢æ‰æ˜¯å…³é”®æ–¹æ³•.</p> <blockquote><p>AnnotationConfigUtils.registerAnnotationConfigProcessors()</p></blockquote> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BeanDefinitionHolder</span><span class="token punctuation">&gt;</span></span> <span class="token function">registerAnnotationConfigProcessors</span><span class="token punctuation">(</span>
    <span class="token class-name">BeanDefinitionRegistry</span> registry<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">Object</span> source<span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token class-name">DefaultListableBeanFactory</span> beanFactory <span class="token operator">=</span> <span class="token function">unwrapDefaultListableBeanFactory</span><span class="token punctuation">(</span>registry<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>beanFactory <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>beanFactory<span class="token punctuation">.</span><span class="token function">getDependencyComparator</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">instanceof</span> <span class="token class-name">AnnotationAwareOrderComparator</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            beanFactory<span class="token punctuation">.</span><span class="token function">setDependencyComparator</span><span class="token punctuation">(</span><span class="token class-name">AnnotationAwareOrderComparator</span><span class="token punctuation">.</span><span class="token constant">INSTANCE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>beanFactory<span class="token punctuation">.</span><span class="token function">getAutowireCandidateResolver</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">instanceof</span> <span class="token class-name">ContextAnnotationAutowireCandidateResolver</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            beanFactory<span class="token punctuation">.</span><span class="token function">setAutowireCandidateResolver</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ContextAnnotationAutowireCandidateResolver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BeanDefinitionHolder</span><span class="token punctuation">&gt;</span></span> beanDefs <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedHashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// å¾ˆé‡è¦!!!</span>
    <span class="token comment">// org.springframework.context.annotation.internalConfigurationAnnotationProcessor</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>registry<span class="token punctuation">.</span><span class="token function">containsBeanDefinition</span><span class="token punctuation">(</span><span class="token constant">CONFIGURATION_ANNOTATION_PROCESSOR_BEAN_NAME</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">RootBeanDefinition</span> def <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RootBeanDefinition</span><span class="token punctuation">(</span><span class="token class-name">ConfigurationClassPostProcessor</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        def<span class="token punctuation">.</span><span class="token function">setSource</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// æ³¨å†ŒBeanå®šä¹‰åˆ°å®¹å™¨ä¸­</span>
        beanDefs<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token function">registerPostProcessor</span><span class="token punctuation">(</span>registry<span class="token punctuation">,</span> def<span class="token punctuation">,</span> <span class="token constant">CONFIGURATION_ANNOTATION_PROCESSOR_BEAN_NAME</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>registry<span class="token punctuation">.</span><span class="token function">containsBeanDefinition</span><span class="token punctuation">(</span><span class="token constant">AUTOWIRED_ANNOTATION_PROCESSOR_BEAN_NAME</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">RootBeanDefinition</span> def <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RootBeanDefinition</span><span class="token punctuation">(</span><span class="token class-name">AutowiredAnnotationBeanPostProcessor</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        def<span class="token punctuation">.</span><span class="token function">setSource</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span><span class="token punctuation">;</span>
        beanDefs<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token function">registerPostProcessor</span><span class="token punctuation">(</span>registry<span class="token punctuation">,</span> def<span class="token punctuation">,</span> <span class="token constant">AUTOWIRED_ANNOTATION_PROCESSOR_BEAN_NAME</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>registry<span class="token punctuation">.</span><span class="token function">containsBeanDefinition</span><span class="token punctuation">(</span><span class="token constant">REQUIRED_ANNOTATION_PROCESSOR_BEAN_NAME</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">RootBeanDefinition</span> def <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RootBeanDefinition</span><span class="token punctuation">(</span><span class="token class-name">RequiredAnnotationBeanPostProcessor</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        def<span class="token punctuation">.</span><span class="token function">setSource</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span><span class="token punctuation">;</span>
        beanDefs<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token function">registerPostProcessor</span><span class="token punctuation">(</span>registry<span class="token punctuation">,</span> def<span class="token punctuation">,</span> <span class="token constant">REQUIRED_ANNOTATION_PROCESSOR_BEAN_NAME</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Check for JSR-250 support, and if present add the CommonAnnotationBeanPostProcessor.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>jsr250Present <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>registry<span class="token punctuation">.</span><span class="token function">containsBeanDefinition</span><span class="token punctuation">(</span><span class="token constant">COMMON_ANNOTATION_PROCESSOR_BEAN_NAME</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">RootBeanDefinition</span> def <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RootBeanDefinition</span><span class="token punctuation">(</span><span class="token class-name">CommonAnnotationBeanPostProcessor</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        def<span class="token punctuation">.</span><span class="token function">setSource</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span><span class="token punctuation">;</span>
        beanDefs<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token function">registerPostProcessor</span><span class="token punctuation">(</span>registry<span class="token punctuation">,</span> def<span class="token punctuation">,</span> <span class="token constant">COMMON_ANNOTATION_PROCESSOR_BEAN_NAME</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Check for JPA support, and if present add the PersistenceAnnotationBeanPostProcessor.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>jpaPresent <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>registry<span class="token punctuation">.</span><span class="token function">containsBeanDefinition</span><span class="token punctuation">(</span><span class="token constant">PERSISTENCE_ANNOTATION_PROCESSOR_BEAN_NAME</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">RootBeanDefinition</span> def <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RootBeanDefinition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            def<span class="token punctuation">.</span><span class="token function">setBeanClass</span><span class="token punctuation">(</span><span class="token class-name">ClassUtils</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span><span class="token constant">PERSISTENCE_ANNOTATION_PROCESSOR_CLASS_NAME</span><span class="token punctuation">,</span>
                                                <span class="token class-name">AnnotationConfigUtils</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ClassNotFoundException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span>
                <span class="token string">&quot;Cannot load optional framework class: &quot;</span> <span class="token operator">+</span> <span class="token constant">PERSISTENCE_ANNOTATION_PROCESSOR_CLASS_NAME</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        def<span class="token punctuation">.</span><span class="token function">setSource</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span><span class="token punctuation">;</span>
        beanDefs<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token function">registerPostProcessor</span><span class="token punctuation">(</span>registry<span class="token punctuation">,</span> def<span class="token punctuation">,</span> <span class="token constant">PERSISTENCE_ANNOTATION_PROCESSOR_BEAN_NAME</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>registry<span class="token punctuation">.</span><span class="token function">containsBeanDefinition</span><span class="token punctuation">(</span><span class="token constant">EVENT_LISTENER_PROCESSOR_BEAN_NAME</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">RootBeanDefinition</span> def <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RootBeanDefinition</span><span class="token punctuation">(</span><span class="token class-name">EventListenerMethodProcessor</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        def<span class="token punctuation">.</span><span class="token function">setSource</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span><span class="token punctuation">;</span>
        beanDefs<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token function">registerPostProcessor</span><span class="token punctuation">(</span>registry<span class="token punctuation">,</span> def<span class="token punctuation">,</span> <span class="token constant">EVENT_LISTENER_PROCESSOR_BEAN_NAME</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>registry<span class="token punctuation">.</span><span class="token function">containsBeanDefinition</span><span class="token punctuation">(</span><span class="token constant">EVENT_LISTENER_FACTORY_BEAN_NAME</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">RootBeanDefinition</span> def <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RootBeanDefinition</span><span class="token punctuation">(</span><span class="token class-name">DefaultEventListenerFactory</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        def<span class="token punctuation">.</span><span class="token function">setSource</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span><span class="token punctuation">;</span>
        beanDefs<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token function">registerPostProcessor</span><span class="token punctuation">(</span>registry<span class="token punctuation">,</span> def<span class="token punctuation">,</span> <span class="token constant">EVENT_LISTENER_FACTORY_BEAN_NAME</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> beanDefs<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br></div></div><p>è¿™é‡Œå°±æ˜¯å°†å„ç§<mark><strong>å†…éƒ¨éœ€è¦</strong></mark>â€‹<strong>çš„ç»„ä»¶, è§£æå™¨</strong>çš„ BeanDefinition æ³¨å†Œåˆ°å®¹å™¨ä¸­! ! !</p> <p>é€šè¿‡ debug æ¨¡å¼çœ‹çœ‹, å½“æ‰§è¡Œå®Œ AnnotatedBeanDefinitionReader çš„åˆå§‹åŒ–å, å·²ç»å®ä¾‹åŒ–äº†ä¸€ä¸ª <strong>DefaultListableBeanFactory</strong> å¯¹è±¡ä½œä¸º BeanFactory. æ­¤æ—¶ beanFactory ä¸­çš„ beanDefinitionMap å’Œ beanDefinitionNames å·²ç»åŒ…å«äº†ä¸Šè¿°ä»£ç ä¸­æ·»åŠ åˆ°å®¹å™¨ä¸­çš„å‡ ä¸ª BeanDefinition äº†.</p> <p><img src="https://nano-note.oss-cn-beijing.aliyuncs.com/images/image-20220116113626164.png" alt="image-20220116113626164"></p> <h5 id="_3-åˆå§‹åŒ–classpathbeandefinitionscanner"><a href="#_3-åˆå§‹åŒ–classpathbeandefinitionscanner" class="header-anchor">#</a> 3.åˆå§‹åŒ–ClassPathBeanDefinitionScanner</h5> <p>BeanDefinition è¯»å–å™¨åˆå§‹åŒ–å®Œæˆå, å†åˆå§‹åŒ–ä¸€ä¸ªæ ¹æ®è·¯å¾„è¿›è¡ŒåŒ…æ‰«æçš„ <strong>Scanner</strong>, åˆå§‹åŒ–çš„åŒæ—¶æŒ‡å®šäº†é»˜è®¤çš„æ‰«æç­–ç•¥, å¯ä»¥æ‰«æ  <strong>@Component æ³¨è§£</strong>ç›¸å…³çš„ç±». çœ‹çœ‹æºç .</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">this</span><span class="token punctuation">.</span>scanner <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ClassPathBeanDefinitionScanner</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><blockquote><p>ClassPathBeanDefinitionScanneræ„é€ æ–¹æ³•</p></blockquote> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">ClassPathBeanDefinitionScanner</span><span class="token punctuation">(</span><span class="token class-name">BeanDefinitionRegistry</span> registry<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// è¿›å»(ä½¿ç”¨é»˜è®¤Filter)</span>
    <span class="token keyword">this</span><span class="token punctuation">(</span>registry<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>è¿™é‡Œè°ƒç”¨äº†å¦ä¸€ä¸ªæ„é€ æ–¹æ³•, ä¼  true è¡¨ç¤º<strong>ä½¿ç”¨é»˜è®¤çš„ Filter</strong>.</p> <blockquote><p>ClassPathBeanDefinitionScanneré‡è½½æ„é€ æ–¹æ³•</p></blockquote> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">ClassPathBeanDefinitionScanner</span><span class="token punctuation">(</span><span class="token class-name">BeanDefinitionRegistry</span> registry<span class="token punctuation">,</span> <span class="token keyword">boolean</span> useDefaultFilters<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// è¿›å»</span>
    <span class="token keyword">this</span><span class="token punctuation">(</span>registry<span class="token punctuation">,</span> useDefaultFilters<span class="token punctuation">,</span> <span class="token function">getOrCreateEnvironment</span><span class="token punctuation">(</span>registry<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>è¿›å»çœ‹çœ‹:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">ClassPathBeanDefinitionScanner</span><span class="token punctuation">(</span><span class="token class-name">BeanDefinitionRegistry</span> registry<span class="token punctuation">,</span> <span class="token keyword">boolean</span> useDefaultFilters<span class="token punctuation">,</span>
                                      <span class="token class-name">Environment</span> environment<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">(</span>registry<span class="token punctuation">,</span> useDefaultFilters<span class="token punctuation">,</span> environment<span class="token punctuation">,</span>
         <span class="token punctuation">(</span>registry <span class="token keyword">instanceof</span> <span class="token class-name">ResourceLoader</span> <span class="token operator">?</span> <span class="token punctuation">(</span><span class="token class-name">ResourceLoader</span><span class="token punctuation">)</span> registry <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>å†è¿›å»:</p> <blockquote><p>ClassPathBeanDefinitionScanneré‡è½½æ„é€ æ–¹æ³•</p></blockquote> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">ClassPathBeanDefinitionScanner</span><span class="token punctuation">(</span><span class="token class-name">BeanDefinitionRegistry</span> registry<span class="token punctuation">,</span> <span class="token keyword">boolean</span> useDefaultFilters<span class="token punctuation">,</span>
                                      <span class="token class-name">Environment</span> environment<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">ResourceLoader</span> resourceLoader<span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">notNull</span><span class="token punctuation">(</span>registry<span class="token punctuation">,</span> <span class="token string">&quot;BeanDefinitionRegistry must not be null&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>registry <span class="token operator">=</span> registry<span class="token punctuation">;</span>

    <span class="token comment">// ä½¿ç”¨é»˜è®¤Filter</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>useDefaultFilters<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// é‡è¦: æ³¨å†Œé»˜è®¤çš„Filter!!!è¿›å»!!!</span>
        <span class="token function">registerDefaultFilters</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// è®¾ç½®ç¯å¢ƒ</span>
    <span class="token function">setEnvironment</span><span class="token punctuation">(</span>environment<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// è®¾ç½®èµ„æºåŠ è½½å™¨</span>
    <span class="token function">setResourceLoader</span><span class="token punctuation">(</span>resourceLoader<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>è¿™é‡Œ <strong>registerDefaultFilters()</strong>  æ–¹æ³•æ¯”è¾ƒé‡è¦, è¿›å»åº·åº·.</p> <blockquote><p>ClassPathBeanDefinitionScanner::registerDefaultFilters()</p></blockquote> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">registerDefaultFilters</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// è¿™é‡Œç›¸å½“äºè‡ªåŠ¨å¾€åŒ…æ‰«æå™¨ä¸­åŠ å…¥äº†Componentç±»å‹çš„æ³¨è§£çš„æ‰«æ, æ­¤æ—¶Component, Repository, Service, Controllerç­‰æ³¨è§£çš„ç±»å°†ä¼šè¢«æ‰«æåˆ°!!!!!!!!</span>
    <span class="token comment">// è¿™ä¸ªè·Ÿæ³¨è§£@ComponentScançš„ç”¨æ³•æ˜¯ç±»ä¼¼çš„!!!!</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>includeFilters<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">AnnotationTypeFilter</span><span class="token punctuation">(</span><span class="token class-name">Component</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">ClassLoader</span> cl <span class="token operator">=</span> <span class="token class-name">ClassPathScanningCandidateComponentProvider</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>includeFilters<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">AnnotationTypeFilter</span><span class="token punctuation">(</span>
            <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">Annotation</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span> <span class="token class-name">ClassUtils</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span><span class="token string">&quot;javax.annotation.ManagedBean&quot;</span><span class="token punctuation">,</span> cl<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;JSR-250 'javax.annotation.ManagedBean' found and supported for component scanning&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ClassNotFoundException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// JSR-250 1.1 API (as included in Java EE 6) not available - simply skip.</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>includeFilters<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">AnnotationTypeFilter</span><span class="token punctuation">(</span>
            <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">Annotation</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span> <span class="token class-name">ClassUtils</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span><span class="token string">&quot;javax.inject.Named&quot;</span><span class="token punctuation">,</span> cl<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;JSR-330 'javax.inject.Named' annotation found and supported for component scanning&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ClassNotFoundException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// JSR-330 API not available - simply skip.</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><p>æ³¨æ„çœ‹æ­¤æ–¹æ³•çš„ç¬¬ä¸€å¥.</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">this</span><span class="token punctuation">.</span>includeFilters<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">AnnotationTypeFilter</span><span class="token punctuation">(</span><span class="token class-name">Component</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>è¿™é‡Œå°±æ˜¯æ·»åŠ äº† Component æ³¨è§£åˆ° includeFilters ä¸­, è¿™ä¸ªå…¶å®å°±ä¸ @ComponentScan æ³¨è§£çš„ includeFilters å‚æ•°æ˜¯ä¸€æ ·çš„. å› æ­¤åˆ°äº†è¿™é‡Œ, Spring å°±ä¼š<strong>è‡ªåŠ¨å»åŠ è½½æ ‡æ³¨äº† @Component æ³¨è§£çš„ç±»</strong>, åŒ…å« @Configuration, @Controller, @Service, @Repository ç­‰çš„ç±».</p> <h4 id="æ³¨å†Œé…ç½®ç±»"><a href="#æ³¨å†Œé…ç½®ç±»" class="header-anchor">#</a> æ³¨å†Œé…ç½®ç±»</h4> <p>æ¥ç€åˆ†æå®¹å™¨æ„é€ å™¨ç¬¬äºŒå¥ä»£ç .</p> <blockquote><p>AnnotationConfigApplicationContextæ„é€ æ–¹æ³•</p></blockquote> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">AnnotationConfigApplicationContext</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> annotatedClasses<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// æ„é€ å™¨: (1)æ³¨å†Œäº†å†…éƒ¨ç”¨åˆ°çš„å„ç§å¤„ç†å™¨çš„BeanDefinition; (2)é…ç½®äº†é»˜è®¤çš„åŒ…æ‰«æç­–ç•¥;</span>
    <span class="token keyword">this</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// å¾€å®¹å™¨ä¸­æ³¨å†Œä¼ å…¥çš„é…ç½®ç±»</span>
    <span class="token function">register</span><span class="token punctuation">(</span>annotatedClasses<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// æå…¶é‡è¦.......</span>
    <span class="token function">refresh</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>è¿™é‡Œé€šè¿‡å‰ä¸€æ­¥åˆå§‹åŒ–çš„ <strong>AnnotatedBeanDefinitionReader</strong> å¯¹ä¼ å…¥çš„é…ç½®ç±»è¿›è¡Œè§£æå¹¶æ³¨å†Œ.</p> <blockquote><p>AnnotationConfigApplicationContext::register()</p></blockquote> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">register</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> annotatedClasses<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">notEmpty</span><span class="token punctuation">(</span>annotatedClasses<span class="token punctuation">,</span> <span class="token string">&quot;At least one annotated class must be specified&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// ç‚¹è¿›å»</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>reader<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span>annotatedClasses<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>è¿™é‡ŒæŒ¨ç€æ³¨å†Œä¼ å…¥çš„é…ç½®ç±», è°ƒç”¨ä¹‹å‰åˆ›å»ºçš„ AnnotatedBeanDefinitionReader çš„ register() æ–¹æ³•è¿›è¡Œæ³¨å†Œ.</p> <blockquote><p>AnnotationConfigApplicationContext::register()</p></blockquote> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">register</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> annotatedClasses<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> annotatedClass <span class="token operator">:</span> annotatedClasses<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// æ³¨å†Œé…ç½®ç±»ä¸­çš„Bean</span>
        <span class="token function">registerBean</span><span class="token punctuation">(</span>annotatedClass<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><blockquote><p>AnnotatedBeanDefinitionReader::register()</p></blockquote> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">registerBean</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> annotatedClass<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">doRegisterBean</span><span class="token punctuation">(</span>annotatedClass<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>çœŸæ­£å¹²æ´»çš„æ˜¯ doRegisterBean() æ–¹æ³•.</p> <blockquote><p>AnnotatedBeanDefinitionReader::doRegisterBean()</p></blockquote> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">void</span> <span class="token function">doRegisterBean</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> annotatedClass<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">Supplier</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> instanceSupplier<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">String</span> name<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">Annotation</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> qualifiers<span class="token punctuation">,</span> <span class="token class-name">BeanDefinitionCustomizer</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> definitionCustomizers<span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token comment">// åˆå§‹åŒ–ä¸€ä¸ªBeanDefinitionå¯¹è±¡(ç”±äºæ‰¿è½½å„ç§Beançš„å±æ€§)</span>
    <span class="token class-name">AnnotatedGenericBeanDefinition</span> abd <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AnnotatedGenericBeanDefinition</span><span class="token punctuation">(</span>annotatedClass<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>conditionEvaluator<span class="token punctuation">.</span><span class="token function">shouldSkip</span><span class="token punctuation">(</span>abd<span class="token punctuation">.</span><span class="token function">getMetadata</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    abd<span class="token punctuation">.</span><span class="token function">setInstanceSupplier</span><span class="token punctuation">(</span>instanceSupplier<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">ScopeMetadata</span> scopeMetadata <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>scopeMetadataResolver<span class="token punctuation">.</span><span class="token function">resolveScopeMetadata</span><span class="token punctuation">(</span>abd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    abd<span class="token punctuation">.</span><span class="token function">setScope</span><span class="token punctuation">(</span>scopeMetadata<span class="token punctuation">.</span><span class="token function">getScopeName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> beanName <span class="token operator">=</span> <span class="token punctuation">(</span>name <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> name <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>beanNameGenerator<span class="token punctuation">.</span><span class="token function">generateBeanName</span><span class="token punctuation">(</span>abd<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>registry<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">AnnotationConfigUtils</span><span class="token punctuation">.</span><span class="token function">processCommonDefinitionAnnotations</span><span class="token punctuation">(</span>abd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>qualifiers <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">Annotation</span><span class="token punctuation">&gt;</span></span> qualifier <span class="token operator">:</span> qualifiers<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Primary</span><span class="token punctuation">.</span><span class="token keyword">class</span> <span class="token generics"><span class="token punctuation">&lt;</span>mark<span class="token punctuation">&gt;</span></span> qualifier<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                abd<span class="token punctuation">.</span><span class="token function">setPrimary</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// æ˜¯å¦æ ‡æ³¨å»¶è¿Ÿåˆå§‹åŒ–</span>
            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Lazy</span><span class="token punctuation">.</span><span class="token keyword">class</span> <span class="token operator">&lt;</span><span class="token operator">/</span>mark<span class="token operator">&gt;</span> qualifier<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                abd<span class="token punctuation">.</span><span class="token function">setLazyInit</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">else</span> <span class="token punctuation">{</span>
                abd<span class="token punctuation">.</span><span class="token function">addQualifier</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">AutowireCandidateQualifier</span><span class="token punctuation">(</span>qualifier<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">BeanDefinitionCustomizer</span> customizer <span class="token operator">:</span> definitionCustomizers<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        customizer<span class="token punctuation">.</span><span class="token function">customize</span><span class="token punctuation">(</span>abd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// ç”ŸæˆBeanDefinitionHolder</span>
    <span class="token class-name">BeanDefinitionHolder</span> definitionHolder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BeanDefinitionHolder</span><span class="token punctuation">(</span>abd<span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
    definitionHolder <span class="token operator">=</span> <span class="token class-name">AnnotationConfigUtils</span><span class="token punctuation">.</span><span class="token function">applyScopedProxyMode</span><span class="token punctuation">(</span>scopeMetadata<span class="token punctuation">,</span> definitionHolder<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>registry<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// æ³¨å†ŒBeanDefinitionHolder</span>
    <span class="token comment">// æŠŠè‡ªå·±çš„é…ç½®ç±»çš„å®šä¹‰æ³¨å†Œåˆ°å®¹å™¨ä¸­</span>
    <span class="token class-name">BeanDefinitionReaderUtils</span><span class="token punctuation">.</span><span class="token function">registerBeanDefinition</span><span class="token punctuation">(</span>definitionHolder<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>registry<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br></div></div><p>çœ‹çœ‹æœ€åä¸€å¥ BeanDefinitionReaderUtils.registerBeanDefinition() æ–¹æ³•. è¿™é‡Œè¿›è¡Œå¯¹ BeanDefinition è¿›è¡Œæ³¨å†Œ.</p> <blockquote><p>BeanDefinitionReaderUtils.registerBeanDefinition()</p></blockquote> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">registerBeanDefinition</span><span class="token punctuation">(</span><span class="token class-name">BeanDefinitionHolder</span> definitionHolder<span class="token punctuation">,</span> <span class="token class-name">BeanDefinitionRegistry</span> registry<span class="token punctuation">)</span>
    <span class="token keyword">throws</span> <span class="token class-name">BeanDefinitionStoreException</span> <span class="token punctuation">{</span>

    <span class="token comment">// ä½¿ç”¨beanNameä½œä¸ºå”¯ä¸€æ ‡è¯†æ³¨å†Œ</span>
    <span class="token class-name">String</span> beanName <span class="token operator">=</span> definitionHolder<span class="token punctuation">.</span><span class="token function">getBeanName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// é€šè¿‡æ³¨å†Œå™¨å°†BeanDefinitionæ³¨å†Œåˆ°beanDefinitionMapä¸­</span>
    <span class="token comment">// å®ç°ç±»: DefaultListableBeanFactory.java</span>
    registry<span class="token punctuation">.</span><span class="token function">registerBeanDefinition</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> definitionHolder<span class="token punctuation">.</span><span class="token function">getBeanDefinition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// æ³¨å†Œæ‰€æœ‰çš„åˆ«å(å¦‚æœå­˜åœ¨)</span>
    <span class="token comment">// å¦‚æœè¿˜æœ‰åˆ«åçš„è¯, ä¹Ÿè¦æ ¹æ®åˆ«åå…¨éƒ¨æ³¨å†Œä¸€é, ä¸ç„¶æ ¹æ®åˆ«åå°±ä¼šæ‰¾ä¸åˆ°Beanäº†</span>
    <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> aliases <span class="token operator">=</span> definitionHolder<span class="token punctuation">.</span><span class="token function">getAliases</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>aliases <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> alias <span class="token operator">:</span> aliases<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// alias -&gt; beanName ä¿å­˜å®ƒä»¬çš„åˆ«åä¿¡æ¯, è¿™ä¸ªå¾ˆç®€å•, ç”¨ä¸€ä¸ªmapä¿å­˜ä¸€ä¸‹å°±å¯ä»¥äº†, </span>
            <span class="token comment">// è·å–çš„æ—¶å€™, ä¼šå…ˆå°†aliasè½¬æ¢ä¸ºbeanName, ç„¶åå†æŸ¥æ‰¾</span>
            registry<span class="token punctuation">.</span><span class="token function">registerAlias</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> alias<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p>è‡³æ­¤å°±æŠŠä¼ å…¥çš„<strong>é…ç½®ç±»</strong>çš„ BeanDefinition æ³¨å†Œåˆ°äº†å®¹å™¨ä¸­.</p> <p>ç»§ç»­çœ‹çœ‹ debug æ¨¡å¼ä¸‹çš„æ‰§è¡Œè¿‡ç¨‹. å¯ä»¥çœ‹åˆ°æ‰§è¡Œå®Œ registry() æ–¹æ³•å, beanDefinitionMap ä¸­å·²ç»åŠ å…¥äº†è‡ªå·±ä¼ å…¥çš„é…ç½®ç±»çš„ BeanDefinition.</p> <p><img src="https://nano-note.oss-cn-beijing.aliyuncs.com/images/image-20220116114153322.png" alt="image-20220116114153322"></p> <h3 id="refresh"><a href="#refresh" class="header-anchor">#</a> refresh()</h3> <p>ç¬¬ä¸‰æ­¥æ˜¯<strong>æœ€æ ¸å¿ƒ</strong>çš„æ–¹æ³•, <strong>AbstractApplicationContext</strong> ç±»çš„ <strong>refresh()</strong>  æ–¹æ³•, è¿™ä¸ªæ–¹æ³•å°±æ˜¯æ„å»ºæ•´ä¸ª IoC å®¹å™¨è¿‡ç¨‹çš„å®Œæ•´ä»£ç , è¿™é‡Œå¯¹å„ä¸ªæ­¥éª¤è¿›è¡Œåˆ†æ.</p> <blockquote><p>AbstractApplicationContext::refresh()</p></blockquote> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">refresh</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">BeansException</span><span class="token punctuation">,</span> <span class="token class-name">IllegalStateException</span> <span class="token punctuation">{</span>

    <span class="token comment">// åŠ é” é˜²æ­¢refresh()è¿˜æ²¡ç»“æŸåˆæ¥ä¸ªå¯åŠ¨æˆ–é”€æ¯å®¹å™¨çš„æ“ä½œ</span>
    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>startupShutdownMonitor<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token comment">// 1.å‡†å¤‡å·¥ä½œ</span>
        <span class="token comment">// è®°å½•å®¹å™¨çš„å¯åŠ¨æ—¶é—´, æ ‡è®°&quot;å·²å¯åŠ¨&quot;çŠ¶æ€, å¤„ç†é…ç½®æ–‡ä»¶ä¸­çš„å ä½ç¬¦,å¯¹ç³»ç»Ÿå±æ€§ä¸ç¯å¢ƒå˜é‡è¿›è¡Œå‡†å¤‡ä¸éªŒè¯</span>
        <span class="token function">prepareRefresh</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 2.åˆå§‹åŒ–BeanFactory(*)</span>
        <span class="token comment">// è¿™æ­¥å®Œæˆå, é…ç½®æ–‡ä»¶å°±ä¼šè§£ææˆä¸€ä¸ªä¸ªBeanDefinition, æ³¨å†Œåˆ°BeanFactoryä¸­, </span>
        <span class="token comment">// è¿™é‡ŒBeanè¿˜æ²¡æœ‰åˆå§‹åŒ–, åªæ˜¯é…ç½®ä¿¡æ¯éƒ½æå–å‡ºæ¥äº†, æ³¨å†Œä¹Ÿåªæ˜¯å°†è¿™äº›ä¿¡æ¯éƒ½ä¿å­˜</span>
        <span class="token comment">// åˆ°äº†æ³¨å†Œä¸­å¿ƒä¸­(å…¶æ ¸å¿ƒæ˜¯ä¸€ä¸ªbeanName -&gt; beanDefinitionçš„map)</span>
        <span class="token class-name">ConfigurableListableBeanFactory</span> beanFactory <span class="token operator">=</span> <span class="token function">obtainFreshBeanFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 3.è®¾ç½®BeanFactoryçš„ç±»åŠ è½½å™¨, æ·»åŠ å‡ ä¸ªBeanPostProcessor, ç¡¬ç¼–ç æ³¨å†Œå‡ ä¸ªç‰¹æ®Šçš„bean</span>
        <span class="token comment">// å¯¹BeanFactoryè¿›è¡Œå„ç§åŠŸèƒ½å¡«å……, æ¯”å¦‚@Qualifierä¸@Autowiredç­‰æ³¨è§£å°±æ˜¯åœ¨è¿™æ­¥ä¸­æ”¯æŒçš„</span>
        <span class="token function">prepareBeanFactory</span><span class="token punctuation">(</span>beanFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">// 4.å¦‚æœBeanå®ç°äº†BeanFactoryPostProcessoræ¥å£, åœ¨å®¹å™¨åˆå§‹åŒ–ä»¥å, </span>
            <span class="token comment">// ä¼šè°ƒç”¨æ¥å£çš„postProcessBeanFactoryæ–¹æ³•. è¿™é‡Œæ˜¯æä¾›ç»™å­ç±»çš„æ‰©å±•ç‚¹, åˆ°è¿™é‡Œçš„æ—¶å€™, </span>
            <span class="token comment">// æ‰€æœ‰çš„Beanéƒ½åŠ è½½, æ³¨å†Œå®Œæˆäº†, ä½†æ˜¯éƒ½è¿˜æ²¡æœ‰åˆå§‹åŒ–</span>
            <span class="token comment">// å…·ä½“çš„å­ç±»å¯ä»¥åœ¨è¿™æ­¥çš„æ—¶å€™æ·»åŠ ä¸€äº›ç‰¹æ®Šçš„BeanFactoryPostProcessorçš„å®ç°ç±»æˆ–åšç‚¹ä»€ä¹ˆäº‹</span>
            <span class="token comment">// å­ç±»è¦†ç›–æ–¹æ³•åšé¢å¤–çš„å¤„ç†</span>
            <span class="token function">postProcessBeanFactory</span><span class="token punctuation">(</span>beanFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// 5.è°ƒç”¨BeanFactoryPostProcessoræ¥å£å„ä¸ªå®ç°ç±»çš„postProcessBeanFactory(factory)æ–¹æ³•</span>
            <span class="token comment">// è°ƒç”¨å„ç§BeanFactoryå¤„ç†å™¨</span>
            <span class="token function">invokeBeanFactoryPostProcessors</span><span class="token punctuation">(</span>beanFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// 6.æ³¨å†ŒBeanPostProcessoræ¥å£çš„å®ç°ç±»(æ³¨æ„ä¸BeanFactoryPostProcessoræ¥å£çš„åŒºåˆ«)</span>
            <span class="token comment">// æ­¤æ¥å£ä¸¤ä¸ªæ–¹æ³•: postProcessBeforeInitialization()å’ŒpostProcessAfterInitialization()</span>
            <span class="token comment">// è¿™ä¸¤ä¸ªæ–¹æ³•åˆ†åˆ«åœ¨Beanåˆå§‹åŒ–ä¹‹å‰å’Œåˆå§‹åŒ–ä¹‹åå¾—åˆ°æ‰§è¡Œ. æ³¨æ„è¿™é‡Œä»…ä»…æ˜¯æ³¨å†Œäº†åå¤„ç†å™¨, </span>
            <span class="token comment">// çœŸæ­£çš„è°ƒç”¨æ˜¯åœ¨getBeanè¿›è¡Œå®ä¾‹åŒ–çš„æ—¶å€™, è¿™é‡Œbeanè¿˜æ²¡åˆå§‹åŒ–</span>
            <span class="token function">registerBeanPostProcessors</span><span class="token punctuation">(</span>beanFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// 7.åˆå§‹åŒ–å½“å‰å®¹å™¨çš„MessageSourceå›½é™…åŒ–å¤„ç†</span>
            <span class="token function">initMessageSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// 8.åˆå§‹åŒ–å¹¶å¾€å®¹å™¨åŠ å…¥ä¸€ä¸ªApplicationContextçš„äº‹ä»¶å¹¿æ’­å™¨(äº‹ä»¶å¤šæ’­å™¨)</span>
            <span class="token function">initApplicationEventMulticaster</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// 9.å…¸å‹çš„æ¨¡æ¿æ–¹æ³•(æ„é€ æ–¹æ³•), å­ç±»å¯ä»¥åœ¨åˆå§‹åŒ–å•ä¾‹beansä¹‹å‰æ¥åˆå§‹åŒ–ä¸€äº›ç‰¹æ®ŠBean</span>
            <span class="token function">onRefresh</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// 10.æ³¨å†Œäº‹ä»¶ç›‘å¬å™¨åˆ°äº‹ä»¶å¤šæ’­å™¨ä¸Š(ç›‘å¬å™¨éœ€å®ç°ApplicationListeneræ¥å£)</span>
            <span class="token function">registerListeners</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// 11.(é‡ç‚¹é‡ç‚¹é‡ç‚¹): åˆå§‹åŒ–å‰©ä¸‹æ‰€æœ‰çš„å•ä¾‹çš„beans(é…ç½®äº†lazy-initçš„é™¤å¤–)</span>
            <span class="token function">finishBeanFactoryInitialization</span><span class="token punctuation">(</span>beanFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// 12.å¹¿æ’­äº‹ä»¶, ApplicationContextåˆå§‹åŒ–å®Œæˆ</span>
            <span class="token function">finishRefresh</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">BeansException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isWarnEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                logger<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;Exception encountered during context initialization - &quot;</span> <span class="token operator">+</span>
                            <span class="token string">&quot;cancelling refresh attempt: &quot;</span> <span class="token operator">+</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment">// é”€æ¯å·²ç»åˆå§‹åŒ–çš„å•ä¾‹Beans, ä»¥å…æœ‰äº›beanä¼šä¸€ç›´å ç”¨èµ„æº</span>
            <span class="token function">destroyBeans</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// é‡ç½®activeæ ‡å¿—ä½</span>
            <span class="token function">cancelRefresh</span><span class="token punctuation">(</span>ex<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// æŠ›å¼‚å¸¸</span>
            <span class="token keyword">throw</span> ex<span class="token punctuation">;</span>

        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token function">resetCommonCaches</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br></div></div><h4 id="å„æ­¥éª¤æ¦‚è¿°"><a href="#å„æ­¥éª¤æ¦‚è¿°" class="header-anchor">#</a> å„æ­¥éª¤æ¦‚è¿°</h4> <h5 id="_1-preparerefresh"><a href="#_1-preparerefresh" class="header-anchor">#</a> 1.prepareRefresh()</h5> <p>ä¸»è¦æ˜¯ä¸€äº›å‡†å¤‡å·¥ä½œ. ä¸ºåˆ·æ–°å‡†å¤‡æ–°çš„<strong>ä¸Šä¸‹æ–‡ç¯å¢ƒ</strong>, è®¾ç½®å…¶å¯åŠ¨æ—¥æœŸå’Œæ´»åŠ¨æ ‡å¿—ä»¥åŠæ‰§è¡Œä¸€äº›å±æ€§çš„åˆå§‹åŒ–.</p> <h5 id="_2-obtainfreshbeanfactory"><a href="#_2-obtainfreshbeanfactory" class="header-anchor">#</a> 2.obtainFreshBeanFactory()ğŸŒŸ</h5> <p>ç”¨äºè·å¾—ä¸€ä¸ªæ–°çš„ BeanFactory.</p> <p>è¯¥æ–¹æ³•ä¼šè§£ææ‰€æœ‰ Spring <strong>é…ç½®æ–‡ä»¶</strong>(é€šå¸¸ä¼šæ”¾åœ¨ resources ç›®å½•ä¸‹), å¹¶å°†æ‰€æœ‰é…ç½®æ–‡ä»¶ä¸­çš„ bean å®šä¹‰å°è£…æˆ <strong>BeanDefinition</strong> åŠ è½½åˆ° BeanFactory ä¸­. å¸¸è§çš„, å¦‚æœè§£æåˆ° @ComponentScan æ³¨è§£æ—¶, ä¼šæ‰«æ base-package æŒ‡å®šçš„ç›®å½•, å°†è¯¥ç›®å½•ä¸‹ä½¿ç”¨æŒ‡å®šæ³¨è§£(@Controller, @Service, @Component, @Repository) çš„ <strong>bean å®šä¹‰ä¹ŸåŒæ ·å°è£…æˆ BeanDefinition</strong> åŠ è½½åˆ° BeanFactory ä¸­.</p> <p>ä¸Šé¢ &quot;åŠ è½½åˆ° BeanFactory ä¸­&quot; çš„å†…å®¹ä¸»è¦æŒ‡çš„æ˜¯ä»¥ä¸‹ 3 ä¸ªç¼“å­˜:</p> <ul><li><strong>beanDefinitionNames ç¼“å­˜</strong>: æ‰€æœ‰è¢«åŠ è½½åˆ° BeanFactory ä¸­çš„ bean çš„ <strong>beanName</strong> é›†åˆ.</li> <li><strong>beanDefinitionMap ç¼“å­˜</strong>: æ‰€æœ‰è¢«åŠ è½½åˆ° BeanFactory ä¸­çš„ bean çš„ <strong>beanName</strong> ä¸ <strong>BeanDefinition</strong> æ˜ å°„.</li> <li><strong>aliasMap ç¼“å­˜</strong>: æ‰€æœ‰è¢«åŠ è½½åˆ° BeanFactory ä¸­çš„ bean çš„ <strong>beanName ä¸åˆ«å</strong>æ˜ å°„.</li></ul> <h5 id="_3-preparebeanfactory-beanfactory"><a href="#_3-preparebeanfactory-beanfactory" class="header-anchor">#</a> 3.prepareBeanFactory(beanFactory)</h5> <p>é…ç½® beanFactory çš„<strong>æ ‡å‡†ä¸Šä¸‹æ–‡ç‰¹å¾</strong>, ä¾‹å¦‚ä¸Šä¸‹æ–‡çš„ ClassLoader, åç½®å¤„ç†å™¨ç­‰. è¿™ä¸ªæ–¹æ³•ä¼šæ³¨å†Œ 3 ä¸ªé»˜è®¤ç¯å¢ƒ bean: environment, systemProperties å’Œ systemEnvironment, æ³¨å†Œ 2 ä¸ª bean åç½®å¤„ç†å™¨: <strong>ApplicationContextAwareProcessor</strong> å’Œ <strong>ApplicationListenerDetector</strong>.</p> <h5 id="_4-postprocessbeanfactory-beanfactory"><a href="#_4-postprocessbeanfactory-beanfactory" class="header-anchor">#</a> 4.postProcessBeanFactory(beanFactory)</h5> <p>å…è®¸<strong>å­ç±»å¯¹ BeanFactory è¿›è¡Œåç»­å¤„ç†</strong>, é»˜è®¤å®ç°ä¸ºç©º, ç•™ç»™<strong>å­ç±»</strong>å®ç°.</p> <h5 id="_5-invokebeanfactorypostprocessors-beanfactory"><a href="#_5-invokebeanfactorypostprocessors-beanfactory" class="header-anchor">#</a> 5.invokeBeanFactoryPostProcessors(beanFactory)ğŸŒŸ</h5> <p>å®ä¾‹åŒ–å’Œè°ƒç”¨æ‰€æœ‰ **BeanFactoryPostProcessor ** æ¥å£çš„å®ç°ç±», åŒ…æ‹¬å…¶å­æ¥å£ <strong>BeanDefinitionRegistryPostProcessor</strong> çš„å®ç°ç±».</p> <p><mark><strong>BeanFactoryPostProcessor</strong></mark> æ¥å£æ˜¯ Spring <mark><strong>åˆå§‹åŒ– BeanFactory æ—¶</strong></mark>å¯¹å¤–æš´éœ²çš„æ‰©å±•ç‚¹, Spring IoC å®¹å™¨å…è®¸ BeanFactoryPostProcessor åœ¨<strong>å®¹å™¨å®ä¾‹åŒ–ä»»ä½• bean ä¹‹å‰è¯»å– bean çš„å®šä¹‰, å¹¶å¯ä»¥ä¿®æ”¹å®ƒ</strong>.</p> <p><mark><strong>BeanDefinitionRegistryPostProcessor</strong></mark> æ¥å£ç»§æ‰¿è‡ª BeanFactoryPostProcessor æ¥å£, æ¯” BeanFactoryPostProcessor å…·æœ‰<strong>æ›´é«˜çš„ä¼˜å…ˆçº§</strong>, ä¸»è¦ç”¨æ¥åœ¨å¸¸è§„çš„ BeanFactoryPostProcessor æ¿€æ´»ä¹‹å‰<strong>æ³¨å†Œä¸€äº› bean å®šä¹‰</strong>. ç‰¹åˆ«çš„, å¯ä»¥é€šè¿‡ BeanDefinitionRegistryPostProcessor æ¥<strong>æ³¨å†Œä¸€äº›å¸¸è§„çš„ BeanFactoryPostProcessor</strong>, å› ä¸ºæ­¤æ—¶æ‰€æœ‰å¸¸è§„çš„ BeanFactoryPostProcessor éƒ½è¿˜æ²¡å¼€å§‹è¢«å¤„ç†.</p> <p>æ³¨: è¿™é‡Œ &quot;å¸¸è§„ BeanFactoryPostProcessor&quot; ä¸»è¦ç”¨æ¥ä¸ BeanDefinitionRegistryPostProcessor åŒºåˆ†.</p> <h5 id="_6-registerbeanpostprocessors-beanfactory"><a href="#_6-registerbeanpostprocessors-beanfactory" class="header-anchor">#</a> 6.registerBeanPostProcessors(beanFactory)ğŸŒŸ</h5> <p>æ³¨å†Œæ‰€æœ‰çš„ <strong>BeanPostProcessor</strong>, å°†æ‰€æœ‰å®ç°äº† BeanPostProcessor æ¥å£çš„ç±»<strong>åŠ è½½åˆ° BeanFactory ä¸­</strong>.</p> <p>BeanPostProcessor æ¥å£æ˜¯ Spring <strong>åˆå§‹åŒ– bean æ—¶</strong>å¯¹å¤–æš´éœ²çš„æ‰©å±•ç‚¹, Spring IoC å®¹å™¨å…è®¸ BeanPostProcessor åœ¨<strong>å®¹å™¨åˆå§‹åŒ– bean çš„å‰å</strong>, æ·»åŠ è‡ªå·±çš„é€»è¾‘å¤„ç†.</p> <p>è¿™ä¸ªæ–¹æ³•åªæ˜¯å°† BeanPostProcessor å®ç°ç±»æ³¨å†Œåˆ° BeanFactory ä¸­, <strong>å…·ä½“è°ƒç”¨æ˜¯åœ¨åé¢å¯¹ bean è¿›è¡Œåˆå§‹åŒ–çš„ finishBeanFactoryInitialization() æ–¹æ³•ä¸­</strong>. åœ¨åé¢æ‰€æœ‰ bean å®ä¾‹åŒ–è¿‡ç¨‹ä¸­, åœ¨æ‰§è¡Œ<strong>åˆå§‹åŒ–æ–¹æ³•å‰åä¼šåˆ†åˆ«è°ƒç”¨</strong>æ‰€æœ‰ BeanPostProcessor æ¥å£çš„ <strong>postProcessBeforeInitialization()</strong>  æ–¹æ³•ä¸ <strong>postProcessAfterInitialization()</strong>  æ–¹æ³•.</p> <h5 id="_7-initmessagesource"><a href="#_7-initmessagesource" class="header-anchor">#</a> 7.initMessageSource()</h5> <p>å›½é™…åŒ–ç›¸å…³. åˆå§‹åŒ–æ¶ˆæ¯èµ„æº MessageSource.</p> <h5 id="_8-initapplicationeventmulticaster"><a href="#_8-initapplicationeventmulticaster" class="header-anchor">#</a> 8.initApplicationEventMulticaster()</h5> <p>åˆå§‹åŒ–åº”ç”¨çš„äº‹ä»¶å¹¿æ’­(å¤šæ’­)å™¨ ApplicationEventMulticaster.</p> <h5 id="_9-onrefresh"><a href="#_9-onrefresh" class="header-anchor">#</a> 9.onRefresh()</h5> <p>è¯¥æ–¹æ³•ä¸º<strong>æ¨¡æ¿æ–¹æ³•</strong>, æä¾›ç»™<strong>å­ç±»</strong>æ‰©å±•å®ç°, å¯ä»¥é‡å†™ä»¥æ·»åŠ ç‰¹å®šäºä¸Šä¸‹æ–‡çš„åˆ·æ–°å·¥ä½œ, é»˜è®¤å®ç°ä¸ºç©º. æ¯”å¦‚ <strong>Spring Boot</strong> é€šè¿‡è¿™ä¸ªæ–¹æ³•å®ç° <strong>Tomcat</strong> çš„å¯åŠ¨.</p> <h5 id="_10-registerlisteners"><a href="#_10-registerlisteners" class="header-anchor">#</a> 10.registerListeners()</h5> <p>æ³¨å†Œäº‹ä»¶ç›‘å¬å™¨.</p> <h5 id="_11-finishbeanfactoryinitialization-beanfactory"><a href="#_11-finishbeanfactoryinitialization-beanfactory" class="header-anchor">#</a> 11.finishBeanFactoryInitialization(beanFactory)ğŸŒŸ</h5> <p>è¯¥æ–¹æ³•ä¼šå®ä¾‹åŒ–æ‰€æœ‰<strong>å‰©ä½™çš„éæ‡’åŠ è½½å•ä¾‹ bean</strong>. é™¤äº†ä¸€äº›å†…éƒ¨çš„ bean, å®ç°äº† BeanFactoryPostProcessor æ¥å£çš„ bean, å®ç°äº† BeanPostProcessor æ¥å£çš„ bean, å…¶ä»–çš„éæ‡’åŠ è½½å•ä¾‹ bean éƒ½ä¼šåœ¨è¿™ä¸ªæ–¹æ³•ä¸­è¢«å®ä¾‹åŒ–, å¹¶ä¸” <strong>BeanPostProcessor</strong> çš„æ¥å£æ–¹æ³•ä¹Ÿæ˜¯åœ¨è¿™ä¸ªæ–¹æ³•ä¸­è§¦å‘.</p> <h5 id="_12-finishrefresh"><a href="#_12-finishrefresh" class="header-anchor">#</a> 12.finishRefresh()</h5> <p>å®Œæˆæ­¤ä¸Šä¸‹æ–‡çš„åˆ·æ–°, ä¸»è¦æ˜¯æ¨é€ä¸Šä¸‹æ–‡åˆ·æ–°å®Œæ¯•äº‹ä»¶(ContextRefreshedEvent)åˆ°ç›‘å¬å™¨.</p> <p>ä¸Šæ–‡åŠ æ˜Ÿçš„æ–¹æ³•ä¸ºæ„å»º IoC æ„æˆä¸­æœ€é‡è¦çš„ 4 ä¸ªæ–¹æ³•, ç®€å•çš„æè¿°å°±æ˜¯:</p> <ul><li><strong>obtainFreshBeanFactory()</strong> : åˆ›å»ºä¸€ä¸ªæ–°çš„ BeanFactory, è¯»å–å’Œè§£æ <strong>bean å®šä¹‰</strong>.</li> <li><strong>invokeBeanFactoryPostProcessors()</strong> : æä¾›ç»™å¼€å‘è€…å¯¹ <strong>BeanFactory</strong> è¿›è¡Œæ‰©å±•.</li> <li><strong>registerBeanPostProcessors()</strong> : æä¾›ç»™å¼€å‘è€…å¯¹ <strong>bean</strong> è¿›è¡Œæ‰©å±•.</li> <li><strong>finishBeanFactoryInitialization()</strong> : <strong>å®ä¾‹åŒ–</strong>å‰©ä½™çš„æ‰€æœ‰éæ‡’åŠ è½½å•ä¾‹ bean.</li></ul> <h4 id="obtainfreshbeanfactory"><a href="#obtainfreshbeanfactory" class="header-anchor">#</a> obtainFreshBeanFactory()</h4> <h5 id="_1-æ¦‚è¿°"><a href="#_1-æ¦‚è¿°" class="header-anchor">#</a> 1.æ¦‚è¿°</h5> <p>è¯¥æ–¹æ³•ä¼šè§£ææ‰€æœ‰ Spring <strong>é…ç½®æ–‡ä»¶</strong>(é€šå¸¸ä¼šæ”¾åœ¨ resources ç›®å½•ä¸‹), å¹¶å°†æ‰€æœ‰é…ç½®æ–‡ä»¶ä¸­çš„ bean å®šä¹‰å°è£…æˆ <strong>BeanDefinition</strong> åŠ è½½åˆ° BeanFactory ä¸­. å¸¸è§çš„, å¦‚æœè§£æåˆ° @ComponentScan æ³¨è§£æ—¶, ä¼šæ‰«æ base-package æŒ‡å®šçš„ç›®å½•, å°†è¯¥ç›®å½•ä¸‹ä½¿ç”¨æŒ‡å®šæ³¨è§£(@Controller, @Service, @Component, @Repository) çš„ <strong>bean å®šä¹‰ä¹ŸåŒæ ·å°è£…æˆ BeanDefinition</strong> åŠ è½½åˆ° BeanFactory ä¸­.</p> <p>è¿™é‡Œ &quot;åŠ è½½åˆ° BeanFactory ä¸­&quot; çš„å†…å®¹ä¸»è¦æŒ‡çš„æ˜¯ä»¥ä¸‹ 3 ä¸ªç¼“å­˜:</p> <ul><li><strong>beanDefinitionNames ç¼“å­˜</strong>: æ‰€æœ‰è¢«åŠ è½½åˆ° BeanFactory ä¸­çš„ bean çš„ <strong>beanName</strong> é›†åˆ.</li> <li><strong>beanDefinitionMap ç¼“å­˜</strong>: æ‰€æœ‰è¢«åŠ è½½åˆ° BeanFactory ä¸­çš„ bean çš„ <strong>beanName</strong> ä¸ <strong>BeanDefinition</strong> æ˜ å°„.</li> <li><strong>aliasMap ç¼“å­˜</strong>: æ‰€æœ‰è¢«åŠ è½½åˆ° BeanFactory ä¸­çš„ bean çš„ <strong>beanName ä¸åˆ«å</strong>æ˜ å°„.</li></ul> <h5 id="_2-æºç åˆ†æ"><a href="#_2-æºç åˆ†æ" class="header-anchor">#</a> 2.æºç åˆ†æ</h5> <p>æ–¹æ³•æºç å¦‚ä¸‹.</p> <blockquote><p>AbstractApplicationContext::obtainFreshBeanFactory()</p></blockquote> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">protected</span> <span class="token class-name">ConfigurableListableBeanFactory</span> <span class="token function">obtainFreshBeanFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token comment">// å¦‚æœæœ‰åˆ™å…³é—­æ—§çš„BeanFactory, åˆ›å»ºæ–°çš„BeanFactory, åŠ è½½Beanå®šä¹‰, æ³¨å†ŒBeanç­‰ç­‰</span>
    <span class="token comment">// å®ç°ç±»ä¸ºGenericApplicationContext</span>
    <span class="token function">refreshBeanFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// è¿”å›åˆšåˆšåˆ›å»ºçš„BeanFactory</span>
    <span class="token class-name">ConfigurableListableBeanFactory</span> beanFactory <span class="token operator">=</span> <span class="token function">getBeanFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Bean factory for &quot;</span> <span class="token operator">+</span> <span class="token function">getDisplayName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;: &quot;</span> <span class="token operator">+</span> beanFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> beanFactory<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>æ ¸å¿ƒæ–¹æ³• refreshBeanFactory() æ˜¯ä¸€ä¸ª<strong>æŠ½è±¡æ–¹æ³•</strong>, å¦‚æœæ˜¯åŸºäº XML é…ç½®çš„å®¹å™¨, å…¶å®ç°ç±»ä¸º AbstractRefreshableApplicationContext ç±». è¿™é‡Œæ˜¯é€šè¿‡<strong>æ³¨è§£</strong>çš„å½¢å¼, å®ç°ç±»çœ‹ <strong>GenericApplicationContext</strong>. ä¸‹é¢çœ‹çœ‹æºç .</p> <blockquote><p>GenericApplicationContext::refreshBeanFactory()</p></blockquote> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
 * Do nothing: We hold a single internal BeanFactory and rely on callers
 * to register beans through our public methods (or the BeanFactory's).
 * @see #registerBeanDefinition
 */</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">protected</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">refreshBeanFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IllegalStateException</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>refreshed<span class="token punctuation">.</span><span class="token function">compareAndSet</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span>
            <span class="token string">&quot;GenericApplicationContext does not support multiple refresh attempts: just call 'refresh' once&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>beanFactory<span class="token punctuation">.</span><span class="token function">setSerializationId</span><span class="token punctuation">(</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>è¿™é‡Œå•¥ä¹Ÿæ²¡å¹². ä½†æ˜¯å¦‚æœåŸºäº XML é…ç½®çš„å®¹å™¨, å…¶å®ç°ç±»æ˜¯ AbstractRefreshableApplicationContext, é‚£ä¹ˆè¿™ä¸ªæ–¹æ³•å°±æ¯”è¾ƒå¤šäº†.</p> <blockquote><p>AbstractRefreshableApplicationContext::refreshBeanFactory()</p></blockquote> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">protected</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">refreshBeanFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">BeansException</span> <span class="token punctuation">{</span>

    <span class="token comment">// 1.å¦‚æœå½“å‰ApplicationContextä¸­å·²ç»åŠ è½½è¿‡BeanFactoryäº†, é”€æ¯æ‰€æœ‰Bean, å…³é—­BeanFactory</span>
    <span class="token comment">// æ³¨æ„: åº”ç”¨ä¸­BeanFactoryæœ¬æ¥å°±æ˜¯å¯ä»¥å¤šä¸ªçš„, è¿™é‡Œä¸æ˜¯è¯´åº”ç”¨å…¨å±€æ˜¯å¦æœ‰BeanFactory, è€Œæ˜¯å½“å‰ApplicationContextæ˜¯å¦æœ‰BeanFactory</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">hasBeanFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// é”€æ¯å·²ç»å­˜åœ¨çš„bean</span>
        <span class="token function">destroyBeans</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// å…³é—­BeanFactory</span>
        <span class="token function">closeBeanFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span> <span class="token keyword">try</span> <span class="token punctuation">{</span>

        <span class="token comment">// 2.åˆå§‹åŒ–ä¸€ä¸ªæ–°çš„BeanFactory</span>
        <span class="token comment">// å®ç°ç±»æ˜¯DefaultListableBeanFactory!!!!å®ƒæ˜¯ä¸€ä¸ªéå¸¸å…¨çš„BeanFactoryå®ä¾‹, åé¢çš„æ“ä½œéƒ½æ˜¯å§”æ‰˜å…¶è¿›è¡Œçš„</span>
        <span class="token class-name">DefaultListableBeanFactory</span> beanFactory <span class="token operator">=</span> <span class="token function">createBeanFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// ç”¨äºBeanFactoryçš„åºåˆ—åŒ–</span>
        beanFactory<span class="token punctuation">.</span><span class="token function">setSerializationId</span><span class="token punctuation">(</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 3.è®¾ç½®BeanFactoryçš„ä¸¤ä¸ªé…ç½®å±æ€§: æ˜¯å¦å…è®¸Beanè¦†ç›–, æ˜¯å¦å…è®¸å¾ªç¯å¼•ç”¨</span>
        <span class="token comment">// å®ç°ç±»: AbstractRefreshableApplicationContext.java</span>
        <span class="token function">customizeBeanFactory</span><span class="token punctuation">(</span>beanFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 4.åŠ è½½BeanDefinitionåˆ°BeanFactoryä¸­ çœ‹å®ç°ç±»: AnnotationConfigWebApplicationContext.java</span>
        <span class="token function">loadBeanDefinitions</span><span class="token punctuation">(</span>beanFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// å°†äº§ç”Ÿçš„beanFactoryèµ‹äºˆæœ¬å®¹å™¨</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>beanFactory <span class="token operator">=</span> beanFactory<span class="token punctuation">;</span>

    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ApplicationContextException</span><span class="token punctuation">(</span><span class="token string">&quot;I/O error parsing bean definition source for &quot;</span> <span class="token operator">+</span> <span class="token function">getDisplayName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br></div></div><h4 id="invokebeanfactorypostprocessors-beanfactory"><a href="#invokebeanfactorypostprocessors-beanfactory" class="header-anchor">#</a> invokeBeanFactoryPostProcessors(beanFactory)</h4> <h5 id="_1-æ¦‚è¿°-2"><a href="#_1-æ¦‚è¿°-2" class="header-anchor">#</a> 1.æ¦‚è¿°</h5> <p>BeanFactoryPostProcessor æ˜¯ <strong>BeanFactory çš„åç½®å¤„ç†å™¨</strong>, å…¶<strong>è§¦å‘æ—¶æœŸæ˜¯åœ¨ BeanDefinition åŠ è½½å®Œæˆå, ä½†æ˜¯æ²¡æœ‰è¿›è¡Œ Bean çš„å®ä¾‹åŒ–ä¹‹å‰</strong>. è¿™é‡Œå¯ä»¥å¯¹ <strong>BeanDefinition</strong> åšä¸€äº›<strong>å±æ€§ä¿®æ”¹</strong>æ“ä½œ.</p> <p>è¿™é‡Œå®ä¾‹åŒ–å¹¶è°ƒç”¨å…¨éƒ¨å·²ç»æ³¨å†Œçš„ BeanFactoryPostProcessor Beans, å¹¶ä¸”å¿…é¡»åœ¨å•ä¾‹ Bean åˆå§‹åŒ–ä¹‹å‰è°ƒç”¨. æœ¬æ–¹æ³•ä¼šå®ä¾‹åŒ–å’Œè°ƒç”¨æ‰€æœ‰ <strong>BeanFactoryPostProcessor</strong>(åŒ…æ‹¬å…¶å­ç±» BeanDefinitionRegistryPostProcessor).</p> <h5 id="_2-é‡è¦æ¥å£"><a href="#_2-é‡è¦æ¥å£" class="header-anchor">#</a> 2.é‡è¦æ¥å£</h5> <p>æœ¬éƒ¨åˆ†æ¶‰åŠä¸¤ä¸ªä¸»è¦æ¥å£. <strong>BeanFactoryPostProcessor</strong> æ¥å£å¦‚ä¸‹. BeanFactoryPostProcessor æ¥å£æ˜¯ Spring åˆå§‹åŒ– <strong>BeanFactory</strong> æ—¶å¯¹å¤–æš´éœ²çš„æ‰©å±•ç‚¹, <strong>Spring IoC å®¹å™¨å…è®¸ BeanFactoryPostProcessor åœ¨å®¹å™¨å®ä¾‹åŒ–ä»»ä½• bean ä¹‹å‰è¯»å– beanDefinition, å¹¶å¯ä»¥ä¿®æ”¹å®ƒ</strong>.</p> <blockquote><p>BeanFactoryPostProcessoræ¥å£</p></blockquote> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">BeanFactoryPostProcessor</span> <span class="token punctuation">{</span>
    <span class="token comment">/**
     * Modify the application context's internal bean factory after its standard
     * initialization. All bean definitions will have been loaded, but no beans
     * will have been instantiated yet. This allows for overriding or adding
     * properties even to eager-initializing beans.
     * @param beanFactory the bean factory used by the application context
     * @throws org.springframework.beans.BeansException in case of errors
     */</span>
    <span class="token keyword">void</span> <span class="token function">postProcessBeanFactory</span><span class="token punctuation">(</span><span class="token class-name">ConfigurableListableBeanFactory</span> beanFactory<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">BeansException</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>BeanDefinitionRegistryPostProcessor æ¥å£ç»§æ‰¿äº† BeanFactoryPostProcessor æ¥å£å¦‚ä¸‹.</p> <p><strong>BeanDefinitionRegistryPostProcessor</strong> ç»§æ‰¿è‡ª <strong>BeanFactoryPostProcessor</strong>, æ¯” BeanFactoryPostProcessor å…·æœ‰<strong>æ›´é«˜çš„ä¼˜å…ˆçº§</strong>, ä¸»è¦ç”¨æ¥åœ¨<strong>å¸¸è§„çš„ BeanFactoryPostProcessor æ£€æµ‹å¼€å§‹ä¹‹å‰æ³¨å†Œå…¶ä»– beanDefinition</strong>. ç‰¹åˆ«çš„, å¯ä»¥é€šè¿‡ BeanDefinitionRegistryPostProcessor æ¥<strong>æ³¨å†Œ</strong>ä¸€äº›å¸¸è§„çš„ BeanFactoryPostProcessor, å› ä¸ºæ­¤æ—¶æ‰€æœ‰å¸¸è§„çš„ BeanFactoryPostProcessor éƒ½è¿˜æ²¡å¼€å§‹è¢«å¤„ç†.</p> <p><strong>BeanDefinitionRegistryPostProcessor</strong> åœ¨ BeanDefinition è¿˜æ²¡æœ‰åŠ è½½ä¹‹å‰, å¯ä»¥<strong>è‡ªå·±å¾€å®¹å™¨åŠ å…¥ BeanDefinition</strong>.</p> <blockquote><p>BeanDefinitionRegistryPostProcessoræ¥å£</p></blockquote> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">BeanDefinitionRegistryPostProcessor</span> <span class="token keyword">extends</span> <span class="token class-name">BeanFactoryPostProcessor</span> <span class="token punctuation">{</span>

    <span class="token comment">/**
     * Modify the application context's internal bean definition registry after its
     * standard initialization. All regular bean definitions will have been loaded,
     * but no beans will have been instantiated yet. This allows for adding further
     * bean definitions before the next post-processing phase kicks in.
     * @param registry the bean definition registry used by the application context
     * @throws org.springframework.beans.BeansException in case of errors
     */</span>
    <span class="token keyword">void</span> <span class="token function">postProcessBeanDefinitionRegistry</span><span class="token punctuation">(</span><span class="token class-name">BeanDefinitionRegistry</span> registry<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">BeansException</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>ä¸»è¦åŒºåˆ«:</p> <ul><li><mark><strong>BeanDefinitionRegistryPostProcessor</strong></mark>â€‹ ** æ¥å£**: åœ¨ BeanDefinition è¿˜æ²¡æœ‰åŠ è½½ä¹‹å‰, å¯ä»¥<strong>è‡ªå·±å¾€å®¹å™¨åŠ å…¥ BeanDefinition</strong>. å¼ºè°ƒ<mark><strong>æ–°å¢ BeanDefinition</strong></mark>.</li> <li><mark><strong>BeanFactoryPostProcessor</strong></mark>â€‹ ** æ¥å£**: åœ¨å®¹å™¨å®ä¾‹åŒ–ä»»ä½• bean ä¹‹å‰è¯»å– beanDefinition, å¹¶å¯ä»¥<strong>ä¿®æ”¹</strong>å®ƒ. å¼ºè°ƒ<mark><strong>ä¿®æ”¹ BeanDefinition</strong></mark>.</li></ul> <h5 id="_3-æºç åˆ†æ"><a href="#_3-æºç åˆ†æ" class="header-anchor">#</a> 3.æºç åˆ†æ</h5> <p>invokeBeanFactoryPostProcessors() æ–¹æ³•æºç å¦‚ä¸‹.</p> <blockquote><p>AbstractApplicationContext::invokeBeanFactoryPostProcessors()</p></blockquote> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">invokeBeanFactoryPostProcessors</span><span class="token punctuation">(</span><span class="token class-name">ConfigurableListableBeanFactory</span> beanFactory<span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token comment">// é‡ç‚¹æ–¹æ³•</span>
    <span class="token class-name">PostProcessorRegistrationDelegate</span><span class="token punctuation">.</span><span class="token function">invokeBeanFactoryPostProcessors</span><span class="token punctuation">(</span>beanFactory<span class="token punctuation">,</span> <span class="token function">getBeanFactoryPostProcessors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Detect a LoadTimeWeaver and prepare for weaving, if found in the meantime</span>
    <span class="token comment">// (e.g. through an @Bean method registered by ConfigurationClassPostProcessor)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>beanFactory<span class="token punctuation">.</span><span class="token function">getTempClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> beanFactory<span class="token punctuation">.</span><span class="token function">containsBean</span><span class="token punctuation">(</span><span class="token constant">LOAD_TIME_WEAVER_BEAN_NAME</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        beanFactory<span class="token punctuation">.</span><span class="token function">addBeanPostProcessor</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">LoadTimeWeaverAwareProcessor</span><span class="token punctuation">(</span>beanFactory<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        beanFactory<span class="token punctuation">.</span><span class="token function">setTempClassLoader</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ContextTypeMatchClassLoader</span><span class="token punctuation">(</span>beanFactory<span class="token punctuation">.</span><span class="token function">getBeanClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>è¿›å…¥ <strong>invokeBeanFactoryPostProcessors()</strong>  æ–¹æ³•. è´¼é•¿.</p> <blockquote><p>PostProcessorRegistrationDelegate.invokeBeanFactoryPostProcessors()</p></blockquote> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">invokeBeanFactoryPostProcessors</span><span class="token punctuation">(</span>
    <span class="token class-name">ConfigurableListableBeanFactory</span> beanFactory<span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BeanFactoryPostProcessor</span><span class="token punctuation">&gt;</span></span> beanFactoryPostProcessors<span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token comment">// Invoke BeanDefinitionRegistryPostProcessors first, if any.</span>
    <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> processedBeans <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 1.åˆ¤æ–­IOCå®¹å™¨æ˜¯ä¸æ˜¯BeanDefinitionRegistryçš„</span>
    <span class="token comment">// ç”±äºDefaultListableBeanFactoryå®ç°äº†BeanDefinitionRegistryæ¥å£, è¿™é‡Œä¼šè¿›å…¥ä¸‹é¢çš„é€»è¾‘</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>beanFactory <span class="token keyword">instanceof</span> <span class="token class-name">BeanDefinitionRegistry</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">BeanDefinitionRegistry</span> registry <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">BeanDefinitionRegistry</span><span class="token punctuation">)</span> beanFactory<span class="token punctuation">;</span>
        <span class="token comment">// ç”¨äºå­˜æ”¾æ™®é€šçš„BeanFactoryPostProcessor</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BeanFactoryPostProcessor</span><span class="token punctuation">&gt;</span></span> regularPostProcessors <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// ç”¨äºå­˜æ”¾BeanDefinitionRegistryPostProcessor</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BeanDefinitionRegistryPostProcessor</span><span class="token punctuation">&gt;</span></span> registryProcessors <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 2.é¦–å…ˆå¤„ç†å…¥å‚ä¸­çš„beanFactoryPostProcessors, è¿™äº›æ˜¯å®¹å™¨ç¡¬ç¼–ç (new å‡ºæ¥çš„)å¯¼å…¥çš„åå¤„ç†å™¨</span>
        <span class="token comment">// éå†æ‰€æœ‰çš„beanFactoryPostProcessors,å°†BeanDefinitionRegistryPostProcessorå’Œæ™®é€šBeanFactoryPostProcessoråŒºåˆ†å¼€</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">BeanFactoryPostProcessor</span> postProcessor <span class="token operator">:</span> beanFactoryPostProcessors<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>postProcessor <span class="token keyword">instanceof</span> <span class="token class-name">BeanDefinitionRegistryPostProcessor</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// 2.1 å¦‚æœæ˜¯BeanDefinitionRegistryPostProcessor</span>
                <span class="token class-name">BeanDefinitionRegistryPostProcessor</span> registryProcessor <span class="token operator">=</span>
                    <span class="token punctuation">(</span><span class="token class-name">BeanDefinitionRegistryPostProcessor</span><span class="token punctuation">)</span> postProcessor<span class="token punctuation">;</span>
                <span class="token comment">// é‡è¦!!!</span>
                <span class="token comment">// 2.1.1 ç›´æ¥æ‰§è¡ŒBeanDefinitionRegistryPostProcessoræ¥å£çš„postProcessBeanDefinitionRegistryæ–¹æ³•</span>
                registryProcessor<span class="token punctuation">.</span><span class="token function">postProcessBeanDefinitionRegistry</span><span class="token punctuation">(</span>registry<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 2.1.2 æ·»åŠ åˆ°registryProcessors(ç”¨äºæœ€åæ‰§è¡ŒpostProcessBeanFactoryæ–¹æ³•)</span>
                registryProcessors<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>registryProcessor<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment">// 2.2 å¦åˆ™åªæ˜¯æ™®é€šçš„BeanFactoryPostProcessor</span>
                <span class="token comment">// 2.2.1 æ·»åŠ åˆ°regularPostProcessors(ç”¨äºæœ€åæ‰§è¡ŒpostProcessBeanFactoryæ–¹æ³•)</span>
                regularPostProcessors<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>postProcessor<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// ç”¨äºä¿å­˜æœ¬æ¬¡è¦æ‰§è¡Œçš„BeanDefinitionRegistryPostProcessor</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BeanDefinitionRegistryPostProcessor</span><span class="token punctuation">&gt;</span></span> currentRegistryProcessors <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 3.è°ƒç”¨æ‰€æœ‰å®ç°PriorityOrderedæ¥å£çš„BeanDefinitionRegistryPostProcessorå®ç°ç±»</span>
        <span class="token comment">// 3.1 æ‰¾å‡ºæ‰€æœ‰å®ç°BeanDefinitionRegistryPostProcessoræ¥å£çš„Beançš„beanName</span>
        <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> postProcessorNames <span class="token operator">=</span>
            beanFactory<span class="token punctuation">.</span><span class="token function">getBeanNamesForType</span><span class="token punctuation">(</span><span class="token class-name">BeanDefinitionRegistryPostProcessor</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 3.2 éå†postProcessorNames, è°ƒç”¨å®ç°äº†PriorityOrderedæ¥å£çš„PostProcessor</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> ppName <span class="token operator">:</span> postProcessorNames<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 3.3 æ ¡éªŒæ˜¯å¦å®ç°äº†PriorityOrderedæ¥å£</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>beanFactory<span class="token punctuation">.</span><span class="token function">isTypeMatch</span><span class="token punctuation">(</span>ppName<span class="token punctuation">,</span> <span class="token class-name">PriorityOrdered</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// 3.4 è·å–ppNameå¯¹åº”çš„beanå®ä¾‹, æ·»åŠ åˆ°currentRegistryProcessorsä¸­,</span>
                <span class="token comment">// beanFactory.getBean: è¿™è¾¹getBeanæ–¹æ³•ä¼šè§¦å‘åˆ›å»ºppNameå¯¹åº”çš„beanå¯¹è±¡</span>
                currentRegistryProcessors<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>beanFactory<span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span>ppName<span class="token punctuation">,</span> <span class="token class-name">BeanDefinitionRegistryPostProcessor</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 3.5 å°†è¦è¢«æ‰§è¡Œçš„åŠ å…¥processedBeans, é¿å…åç»­é‡å¤æ‰§è¡Œ</span>
                processedBeans<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>ppName<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 3.6 è¿›è¡Œæ’åº(æ ¹æ®æ˜¯å¦å®ç°PriorityOrdered, Orderedæ¥å£å’Œorderå€¼æ¥æ’åº)</span>
        <span class="token function">sortPostProcessors</span><span class="token punctuation">(</span>currentRegistryProcessors<span class="token punctuation">,</span> beanFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 3.7 æ·»åŠ åˆ°registryProcessors(ç”¨äºæœ€åæ‰§è¡ŒpostProcessBeanFactoryæ–¹æ³•)</span>
        registryProcessors<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span>currentRegistryProcessors<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// é‡è¦! ! ! æ‰«æåŠ è½½æ‰€æœ‰çš„BeanDefinition! ! ! </span>
        <span class="token comment">// 3.8 éå†currentRegistryProcessors, æ‰§è¡ŒpostProcessBeanDefinitionRegistryæ–¹æ³•</span>
        <span class="token function">invokeBeanDefinitionRegistryPostProcessors</span><span class="token punctuation">(</span>currentRegistryProcessors<span class="token punctuation">,</span> registry<span class="token punctuation">)</span><span class="token punctuation">;</span>
        currentRegistryProcessors<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">// 3.9 æ‰§è¡Œå®Œäº†æ¸…ç†ä¸€ä¸‹</span>

        <span class="token comment">// 4.è°ƒç”¨æ‰€æœ‰å®ç°äº†Orderedæ¥å£çš„BeanDefinitionRegistryPostProcessorå®ç°ç±»(è¿‡ç¨‹è·Ÿä¸Šé¢çš„æ­¥éª¤3åŸºæœ¬ä¸€æ ·)</span>
        <span class="token comment">// 4.1 æ‰¾å‡ºæ‰€æœ‰å®ç°BeanDefinitionRegistryPostProcessoræ¥å£çš„ç±», è¿™è¾¹é‡å¤æŸ¥æ‰¾æ˜¯å› ä¸ºæ‰§è¡Œå®Œä¸Šé¢çš„BeanDefinitionRegistryPostProcessor,</span>
        <span class="token comment">// å¯èƒ½ä¼šæ–°å¢äº†å…¶ä»–çš„BeanDefinitionRegistryPostProcessor,å› æ­¤éœ€è¦é‡æ–°æŸ¥æ‰¾</span>
        postProcessorNames <span class="token operator">=</span> beanFactory<span class="token punctuation">.</span><span class="token function">getBeanNamesForType</span><span class="token punctuation">(</span><span class="token class-name">BeanDefinitionRegistryPostProcessor</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> ppName <span class="token operator">:</span> postProcessorNames<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// æ ¡éªŒæ˜¯å¦å®ç°äº†Orderedæ¥å£, å¹¶ä¸”è¿˜æœªæ‰§è¡Œè¿‡</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>processedBeans<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>ppName<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> beanFactory<span class="token punctuation">.</span><span class="token function">isTypeMatch</span><span class="token punctuation">(</span>ppName<span class="token punctuation">,</span> <span class="token class-name">Ordered</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                currentRegistryProcessors<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>beanFactory<span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span>ppName<span class="token punctuation">,</span> <span class="token class-name">BeanDefinitionRegistryPostProcessor</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                processedBeans<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>ppName<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token function">sortPostProcessors</span><span class="token punctuation">(</span>currentRegistryProcessors<span class="token punctuation">,</span> beanFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>
        registryProcessors<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span>currentRegistryProcessors<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 4.2 éå†currentRegistryProcessors,æ‰§è¡ŒpostProcessBeanDefinitionRegistryæ–¹æ³•</span>
        <span class="token function">invokeBeanDefinitionRegistryPostProcessors</span><span class="token punctuation">(</span>currentRegistryProcessors<span class="token punctuation">,</span> registry<span class="token punctuation">)</span><span class="token punctuation">;</span>
        currentRegistryProcessors<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 5.æœ€åè°ƒç”¨æ‰€æœ‰å‰©ä¸‹çš„BeanDefinitionRegistryPostProcessors</span>
        <span class="token keyword">boolean</span> reiterate <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>reiterate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            reiterate <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token comment">// 5.1 æ‰¾å‡ºæ‰€æœ‰å®ç°BeanDefinitionRegistryPostProcessoræ¥å£çš„ç±»</span>
            postProcessorNames <span class="token operator">=</span> beanFactory<span class="token punctuation">.</span><span class="token function">getBeanNamesForType</span><span class="token punctuation">(</span><span class="token class-name">BeanDefinitionRegistryPostProcessor</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> ppName <span class="token operator">:</span> postProcessorNames<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// 5.2 è·³è¿‡å·²ç»æ‰§è¡Œè¿‡çš„</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>processedBeans<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>ppName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    currentRegistryProcessors<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>beanFactory<span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span>ppName<span class="token punctuation">,</span> <span class="token class-name">BeanDefinitionRegistryPostProcessor</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    processedBeans<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>ppName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">// 5.3 å¦‚æœæœ‰BeanDefinitionRegistryPostProcessorè¢«æ‰§è¡Œ, åˆ™æœ‰å¯èƒ½ä¼šäº§ç”Ÿæ–°çš„BeanDefinitionRegistryPostProcessor,</span>
                    <span class="token comment">// å› æ­¤è¿™è¾¹å°†reiterateèµ‹å€¼ä¸ºtrue, ä»£è¡¨éœ€è¦å†å¾ªç¯æŸ¥æ‰¾ä¸€æ¬¡</span>
                    reiterate <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token function">sortPostProcessors</span><span class="token punctuation">(</span>currentRegistryProcessors<span class="token punctuation">,</span> beanFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>
            registryProcessors<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span>currentRegistryProcessors<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 5.4 éå†currentRegistryProcessors,æ‰§è¡ŒpostProcessBeanDefinitionRegistryæ–¹æ³•</span>
            <span class="token function">invokeBeanDefinitionRegistryPostProcessors</span><span class="token punctuation">(</span>currentRegistryProcessors<span class="token punctuation">,</span> registry<span class="token punctuation">)</span><span class="token punctuation">;</span>
            currentRegistryProcessors<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 6.è°ƒç”¨æ‰€æœ‰BeanDefinitionRegistryPostProcessorçš„postProcessBeanFactoryæ–¹æ³•(BeanDefinitionRegistryPostProcessorç»§æ‰¿è‡ªBeanFactoryPostProcessor)</span>
        <span class="token function">invokeBeanFactoryPostProcessors</span><span class="token punctuation">(</span>registryProcessors<span class="token punctuation">,</span> beanFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 7.æœ€åè°ƒç”¨å…¥å‚beanFactoryPostProcessorsä¸­çš„æ™®é€šBeanFactoryPostProcessorçš„postProcessBeanFactoryæ–¹æ³•</span>
        <span class="token function">invokeBeanFactoryPostProcessors</span><span class="token punctuation">(</span>regularPostProcessors<span class="token punctuation">,</span> beanFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// Invoke factory processors registered with the context instance.</span>
        <span class="token function">invokeBeanFactoryPostProcessors</span><span class="token punctuation">(</span>beanFactoryPostProcessors<span class="token punctuation">,</span> beanFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// åˆ°è¿™é‡Œ, å…¥å‚beanFactoryPostProcessorså’Œå®¹å™¨ä¸­æ‰€æœ‰BeanDefinitionRegistryPostProcessorå·²ç»å…¨éƒ¨å¤„ç†å®Œæ¯•,</span>
    <span class="token comment">// ä¸‹é¢å¼€å§‹å¤„ç†å®¹å™¨ä¸­çš„æ‰€æœ‰BeanFactoryPostProcessor</span>

    <span class="token comment">// 8.æ‰¾å‡ºæ‰€æœ‰å®ç°BeanFactoryPostProcessoræ¥å£çš„ç±»</span>
    <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> postProcessorNames <span class="token operator">=</span>
        beanFactory<span class="token punctuation">.</span><span class="token function">getBeanNamesForType</span><span class="token punctuation">(</span><span class="token class-name">BeanFactoryPostProcessor</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// å°†BeanFactoryPostProcessorsåˆ†æˆä¸‰ç±»: 1.å®ç°äº†PriorityOrderedæ¥å£çš„ 2.å®ç°äº†Orderedæ¥å£çš„ 3.å…¶ä»–çš„</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BeanFactoryPostProcessor</span><span class="token punctuation">&gt;</span></span> priorityOrderedPostProcessors <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> orderedPostProcessorNames <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> nonOrderedPostProcessorNames <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 8.1 éå†postProcessorNames,å°†BeanFactoryPostProcessoræŒ‰å®ç°PriorityOrdered, å®ç°Orderedæ¥å£, æ™®é€šä¸‰ç§åŒºåˆ†å¼€</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> ppName <span class="token operator">:</span> postProcessorNames<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 8.2 è·³è¿‡å·²ç»æ‰§è¡Œè¿‡çš„</span>
        <span class="token comment">// å¿½ç•¥å·²ç»åœ¨ä¸Šä¸€é˜¶æ®µå¤„ç†è¿‡çš„Processor</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>processedBeans<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>ppName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// skip - already processed in first phase above</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>beanFactory<span class="token punctuation">.</span><span class="token function">isTypeMatch</span><span class="token punctuation">(</span>ppName<span class="token punctuation">,</span> <span class="token class-name">PriorityOrdered</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 8.3 æ·»åŠ å®ç°äº†PriorityOrderedæ¥å£çš„BeanFactoryPostProcessor</span>
            priorityOrderedPostProcessors<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>beanFactory<span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span>ppName<span class="token punctuation">,</span> <span class="token class-name">BeanFactoryPostProcessor</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>beanFactory<span class="token punctuation">.</span><span class="token function">isTypeMatch</span><span class="token punctuation">(</span>ppName<span class="token punctuation">,</span> <span class="token class-name">Ordered</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 8.4 æ·»åŠ å®ç°äº†Orderedæ¥å£çš„BeanFactoryPostProcessorçš„beanName</span>
            orderedPostProcessorNames<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>ppName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment">// 8.5 æ·»åŠ å‰©ä¸‹çš„æ™®é€šBeanFactoryPostProcessorçš„beanName</span>
            nonOrderedPostProcessorNames<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>ppName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 9.é¦–å…ˆè°ƒç”¨æ‰€æœ‰å®ç°PriorityOrderedæ¥å£çš„BeanFactoryPostProcessor</span>
    <span class="token comment">// 9.1 å¯¹priorityOrderedPostProcessorsæ’åº</span>
    <span class="token function">sortPostProcessors</span><span class="token punctuation">(</span>priorityOrderedPostProcessors<span class="token punctuation">,</span> beanFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 9.2 éå†priorityOrderedPostProcessors, æ‰§è¡ŒpostProcessBeanFactoryæ–¹æ³•</span>
    <span class="token function">invokeBeanFactoryPostProcessors</span><span class="token punctuation">(</span>priorityOrderedPostProcessors<span class="token punctuation">,</span> beanFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 10.å…¶æ¬¡è°ƒç”¨æ‰€æœ‰å®ç°Orderedæ¥å£çš„BeanFactoryPostProcessor</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BeanFactoryPostProcessor</span><span class="token punctuation">&gt;</span></span> orderedPostProcessors <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> postProcessorName <span class="token operator">:</span> orderedPostProcessorNames<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 10.1 è·å–postProcessorNameå¯¹åº”çš„beanå®ä¾‹(é€šè¿‡beanåç§°è·å–bean), æ·»åŠ åˆ°orderedPostProcessors, å‡†å¤‡æ‰§è¡Œ</span>
        orderedPostProcessors<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>beanFactory<span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span>postProcessorName<span class="token punctuation">,</span> <span class="token class-name">BeanFactoryPostProcessor</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 10.2 å¯¹orderedPostProcessorsæ’åº</span>
    <span class="token function">sortPostProcessors</span><span class="token punctuation">(</span>orderedPostProcessors<span class="token punctuation">,</span> beanFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 10.3 éå†orderedPostProcessors, æ‰§è¡ŒpostProcessBeanFactoryæ–¹æ³•</span>
    <span class="token function">invokeBeanFactoryPostProcessors</span><span class="token punctuation">(</span>orderedPostProcessors<span class="token punctuation">,</span> beanFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 11.æœ€åè°ƒç”¨æ‰€æœ‰å‰©ä¸‹çš„BeanFactoryPostProcessor</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BeanFactoryPostProcessor</span><span class="token punctuation">&gt;</span></span> nonOrderedPostProcessors <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> postProcessorName <span class="token operator">:</span> nonOrderedPostProcessorNames<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 11.1 è·å–postProcessorNameå¯¹åº”çš„beanå®ä¾‹, æ·»åŠ åˆ°nonOrderedPostProcessors, å‡†å¤‡æ‰§è¡Œ</span>
        nonOrderedPostProcessors<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>beanFactory<span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span>postProcessorName<span class="token punctuation">,</span> <span class="token class-name">BeanFactoryPostProcessor</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 11.2 éå†nonOrderedPostProcessors, æ‰§è¡ŒpostProcessBeanFactoryæ–¹æ³•</span>
    <span class="token function">invokeBeanFactoryPostProcessors</span><span class="token punctuation">(</span>nonOrderedPostProcessors<span class="token punctuation">,</span> beanFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 12.æ¸…é™¤å…ƒæ•°æ®ç¼“å­˜(mergedBeanDefinitions, allBeanNamesByType, singletonBeanNamesByType), </span>
    <span class="token comment">// å› ä¸ºåå¤„ç†å™¨å¯èƒ½å·²ç»ä¿®æ”¹äº†åŸå§‹å…ƒæ•°æ®, ä¾‹å¦‚, æ›¿æ¢å€¼ä¸­çš„å ä½ç¬¦...</span>
    beanFactory<span class="token punctuation">.</span><span class="token function">clearMetadataCache</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br><span class="line-number">165</span><br><span class="line-number">166</span><br><span class="line-number">167</span><br><span class="line-number">168</span><br><span class="line-number">169</span><br><span class="line-number">170</span><br></div></div><p>æ•´ä¸ª invokeBeanFactoryPostProcessors() æ–¹æ³•å›´ç»•ä¸¤ä¸ªæ¥å£, <strong>BeanDefinitionRegistryPostProcessor</strong> å’Œ <strong>BeanFactoryPostProcessor</strong>, è¿™é‡Œ BeanDefinitionRegistryPostProcessor ç»§æ‰¿äº† BeanFactoryPostProcessor. BeanDefinitionRegistryPostProcessor ä¸»è¦ç”¨æ¥åœ¨<strong>å¸¸è§„ BeanFactoryPostProcessor æ£€æµ‹å¼€å§‹ä¹‹å‰æ³¨å†Œå…¶ä»– Bean å®šä¹‰, BeanDefinitionRegistryPostProcessor å…·æœ‰æ›´é«˜çš„ä¼˜å…ˆçº§, æ‰§è¡Œé¡ºåºåœ¨ BeanFactoryPostProcessor ä¹‹å‰</strong>.</p> <p>æ•´ä¸ª invokeBeanFactoryPostProcessors() æ–¹æ³•æ“ä½œäº† 3 ç§ bean å¯¹è±¡:</p> <ul><li><strong>å…¥å‚ beanFactoryPostProcessors</strong>: è¿™ä¸ªæ‹¿çš„æ˜¯ AbstractApplicationContext ç±»çš„ beanFactoryPostProcessors å±æ€§å€¼, ä¹Ÿå°±æ˜¯åœ¨ä¹‹å‰å·²ç»æ·»åŠ åˆ° beanFactoryPostProcessors ä¸­çš„ BeanFactoryPostProcessor.</li> <li><strong>BeanDefinitionRegistryPostProcessor æ¥å£å®ç°ç±»</strong>: å®ç°äº† BeanDefinitionRegistryPostProcessor æ¥å£, å¹¶ä¸”æ³¨å†Œåˆ° Spring IoC å®¹å™¨ä¸­.</li> <li><strong>å¸¸è§„ BeanFactoryPostProcessor æ¥å£å®ç°ç±»</strong>: å®ç°äº† BeanFactoryPostProcessor æ¥å£, å¹¶ä¸”æ³¨å†Œåˆ° Spring IoC å®¹å™¨ä¸­.</li></ul> <h6 id="_1-postprocessbeandefinitionregistry-registry"><a href="#_1-postprocessbeandefinitionregistry-registry" class="header-anchor">#</a> (1)postProcessBeanDefinitionRegistry(registry)</h6> <p>æ³¨é‡Š 2.1.1: ç›´æ¥æ‰§è¡Œ BeanDefinitionRegistryPostProcessor æ¥å£çš„ <strong>postProcessBeanDefinitionRegistry()</strong>  æ–¹æ³•.</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>registryProcessor<span class="token punctuation">.</span><span class="token function">postProcessBeanDefinitionRegistry</span><span class="token punctuation">(</span>registry<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>è¿›å»çœ‹çœ‹. è¿™é‡Œè¿›çš„æ˜¯å®ç°ç±» ConfigurationClassPostProcessor.</p> <blockquote><p>ConfigurationClassPostProcessor::postProcessBeanDefinitionRegistry()</p></blockquote> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">postProcessBeanDefinitionRegistry</span><span class="token punctuation">(</span><span class="token class-name">BeanDefinitionRegistry</span> registry<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> registryId <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">identityHashCode</span><span class="token punctuation">(</span>registry<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>registriesPostProcessed<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>registryId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span>
            <span class="token string">&quot;postProcessBeanDefinitionRegistry already called on this post-processor against &quot;</span> <span class="token operator">+</span> registry<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>factoriesPostProcessed<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>registryId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span>
            <span class="token string">&quot;postProcessBeanFactory already called on this post-processor against &quot;</span> <span class="token operator">+</span> registry<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>registriesPostProcessed<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>registryId<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// è¿›å»! ! </span>
    <span class="token function">processConfigBeanDefinitions</span><span class="token punctuation">(</span>registry<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>å†ç»§ç»­è¿›å» processConfigBeanDefinitions() æ–¹æ³•. ä¸‹é¢çš„æ–¹æ³•å°†è‡ªå·±å®šä¹‰çš„  <strong>@Configuration é…ç½®ç±»</strong>æ‰«æåˆ°äº†å®¹å™¨ä¸­.</p> <blockquote><p>ConfigurationClassPostProcessor::processConfigBeanDefinitions()</p></blockquote> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
 * Build and validate a configuration model based on the registry of
 * {@link Configuration} classes.
 */</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">processConfigBeanDefinitions</span><span class="token punctuation">(</span><span class="token class-name">BeanDefinitionRegistry</span> registry<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// å­˜æ”¾BeanDefinitionHolder</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BeanDefinitionHolder</span><span class="token punctuation">&gt;</span></span> configCandidates <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// è·å–å·²ç»æ³¨å†Œçš„BeanDefinition(å†…éƒ¨+è‡ªå·±æ³¨å†Œçš„)</span>
    <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> candidateNames <span class="token operator">=</span> registry<span class="token punctuation">.</span><span class="token function">getBeanDefinitionNames</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// æŒ¨ç€å¤„ç†æ‰¾å‡ºè‡ªå·±çš„é…ç½®ç±»(æ ‡æ³¨äº†@Configurationçš„ç±»)</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> beanName <span class="token operator">:</span> candidateNames<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">BeanDefinition</span> beanDef <span class="token operator">=</span> registry<span class="token punctuation">.</span><span class="token function">getBeanDefinition</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">ConfigurationClassUtils</span><span class="token punctuation">.</span><span class="token function">isFullConfigurationClass</span><span class="token punctuation">(</span>beanDef<span class="token punctuation">)</span> <span class="token operator">||</span>
            <span class="token class-name">ConfigurationClassUtils</span><span class="token punctuation">.</span><span class="token function">isLiteConfigurationClass</span><span class="token punctuation">(</span>beanDef<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Bean definition has already been processed as a configuration class: &quot;</span> <span class="token operator">+</span> beanDef<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// è¿™é‡Œç­›é€‰å‡ºè‡ªå·±çš„é…ç½®ç±»</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">ConfigurationClassUtils</span><span class="token punctuation">.</span><span class="token function">checkConfigurationClassCandidate</span><span class="token punctuation">(</span>beanDef<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>metadataReaderFactory<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            configCandidates<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BeanDefinitionHolder</span><span class="token punctuation">(</span>beanDef<span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// æ²¡æœ‰è‡ªå·±å®šä¹‰çš„æ ‡æ³¨äº†@Configurationçš„é…ç½®ç±»</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>configCandidates<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// æ ¹æ®@Orderæ³¨è§£æ’åº</span>
    configCandidates<span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span><span class="token punctuation">(</span>bd1<span class="token punctuation">,</span> bd2<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> i1 <span class="token operator">=</span> <span class="token class-name">ConfigurationClassUtils</span><span class="token punctuation">.</span><span class="token function">getOrder</span><span class="token punctuation">(</span>bd1<span class="token punctuation">.</span><span class="token function">getBeanDefinition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> i2 <span class="token operator">=</span> <span class="token class-name">ConfigurationClassUtils</span><span class="token punctuation">.</span><span class="token function">getOrder</span><span class="token punctuation">(</span>bd2<span class="token punctuation">.</span><span class="token function">getBeanDefinition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">compare</span><span class="token punctuation">(</span>i1<span class="token punctuation">,</span> i2<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Detect any custom bean name generation strategy supplied through the enclosing application context</span>
    <span class="token class-name">SingletonBeanRegistry</span> sbr <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>registry <span class="token keyword">instanceof</span> <span class="token class-name">SingletonBeanRegistry</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        sbr <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">SingletonBeanRegistry</span><span class="token punctuation">)</span> registry<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>localBeanNameGeneratorSet<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">BeanNameGenerator</span> generator <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">BeanNameGenerator</span><span class="token punctuation">)</span> sbr<span class="token punctuation">.</span><span class="token function">getSingleton</span><span class="token punctuation">(</span><span class="token constant">CONFIGURATION_BEAN_NAME_GENERATOR</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>generator <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>componentScanBeanNameGenerator <span class="token operator">=</span> generator<span class="token punctuation">;</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>importBeanNameGenerator <span class="token operator">=</span> generator<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>environment <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>environment <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StandardEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// åˆå§‹åŒ–é…ç½®ç±»è§£æå™¨</span>
    <span class="token class-name">ConfigurationClassParser</span> parser <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConfigurationClassParser</span><span class="token punctuation">(</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>metadataReaderFactory<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>problemReporter<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>environment<span class="token punctuation">,</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>resourceLoader<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>componentScanBeanNameGenerator<span class="token punctuation">,</span> registry<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// è§£ææ¯ä¸ª@Configurationé…ç½®ç±»</span>
    <span class="token comment">// å€™é€‰çš„åˆ—è¡¨</span>
    <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BeanDefinitionHolder</span><span class="token punctuation">&gt;</span></span> candidates <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedHashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>configCandidates<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// å·²è§£æçš„åˆ—è¡¨</span>
    <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ConfigurationClass</span><span class="token punctuation">&gt;</span></span> alreadyParsed <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>configCandidates<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">do</span> <span class="token punctuation">{</span>
        <span class="token comment">// æ ¸å¿ƒæ–¹æ³•1: è§£æé…ç½®ç±»,è¿™é‡Œå°†åŒ…æ‰«æèƒ½å¤Ÿæ‰«æåˆ°çš„BeanDefinitionæ³¨å†Œåˆ°å®¹å™¨ä¸­!!!!!!</span>
        parser<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>candidates<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// æ ¡éªŒ</span>
        parser<span class="token punctuation">.</span><span class="token function">validate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ConfigurationClass</span><span class="token punctuation">&gt;</span></span> configClasses <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedHashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>parser<span class="token punctuation">.</span><span class="token function">getConfigurationClasses</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        configClasses<span class="token punctuation">.</span><span class="token function">removeAll</span><span class="token punctuation">(</span>alreadyParsed<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Read the model and create bean definitions based on its content</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>reader <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>reader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConfigurationClassBeanDefinitionReader</span><span class="token punctuation">(</span>
                registry<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>sourceExtractor<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>resourceLoader<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>environment<span class="token punctuation">,</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>importBeanNameGenerator<span class="token punctuation">,</span> parser<span class="token punctuation">.</span><span class="token function">getImportRegistry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// æ ¸å¿ƒæ–¹æ³•2: è¿™é‡Œå°†é…ç½®ç±»ä¸­å®šä¹‰çš„BeanDefinitionæ³¨å†Œåˆ°å®¹å™¨ä¸­!!!å¦‚é€šè¿‡@Importå’Œ@Beanæ³¨è§£é…ç½®çš„bean !!!!!</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>reader<span class="token punctuation">.</span><span class="token function">loadBeanDefinitions</span><span class="token punctuation">(</span>configClasses<span class="token punctuation">)</span><span class="token punctuation">;</span>
        alreadyParsed<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span>configClasses<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// ä¸‹é¢å°±æ˜¯åšæ•´ä½“éªŒè¯</span>
        candidates<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// å·²ç»æ³¨å†Œçš„beanå®šä¹‰ä¸ªæ•°å¤§äºå¼€å§‹æ—¶å¼€å§‹ç³»ç»Ÿ+ä¸»é…ç½®ç±»çš„(å‘ç”Ÿè¿‡è§£æ)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>registry<span class="token punctuation">.</span><span class="token function">getBeanDefinitionCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> candidateNames<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// è·å–ç³»ç»Ÿ+è‡ªå·±è§£æçš„+é…ç½®ç±»ä¸­çš„beanå®šä¹‰ä¿¡æ¯</span>
            <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> newCandidateNames <span class="token operator">=</span> registry<span class="token punctuation">.</span><span class="token function">getBeanDefinitionNames</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// ç³»ç»Ÿçš„+é…ç½®ç±»ä¸­çš„beanå®šä¹‰ä¿¡æ¯(ä¸€å¼€å§‹ä¼ å…¥çš„)</span>
            <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> oldCandidateNames <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span>candidateNames<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> alreadyParsedClasses <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// æœ¬æ–¹æ³•æ±‡æ€»å·²ç»è§£æè¿‡çš„è‡ªå·±çš„ç»„ä»¶</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">ConfigurationClass</span> configurationClass <span class="token operator">:</span> alreadyParsed<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                alreadyParsedClasses<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>configurationClass<span class="token punctuation">.</span><span class="token function">getMetadata</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getClassName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> candidateName <span class="token operator">:</span> newCandidateNames<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>oldCandidateNames<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>candidateName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token class-name">BeanDefinition</span> bd <span class="token operator">=</span> registry<span class="token punctuation">.</span><span class="token function">getBeanDefinition</span><span class="token punctuation">(</span>candidateName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">ConfigurationClassUtils</span><span class="token punctuation">.</span><span class="token function">checkConfigurationClassCandidate</span><span class="token punctuation">(</span>bd<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>metadataReaderFactory<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
                        <span class="token operator">!</span>alreadyParsedClasses<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>bd<span class="token punctuation">.</span><span class="token function">getBeanClassName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        candidates<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BeanDefinitionHolder</span><span class="token punctuation">(</span>bd<span class="token punctuation">,</span> candidateName<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            candidateNames <span class="token operator">=</span> newCandidateNames<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>candidates<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Register the ImportRegistry as a bean in order to support ImportAware @Configuration classes</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>sbr <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>sbr<span class="token punctuation">.</span><span class="token function">containsSingleton</span><span class="token punctuation">(</span><span class="token constant">IMPORT_REGISTRY_BEAN_NAME</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        sbr<span class="token punctuation">.</span><span class="token function">registerSingleton</span><span class="token punctuation">(</span><span class="token constant">IMPORT_REGISTRY_BEAN_NAME</span><span class="token punctuation">,</span> parser<span class="token punctuation">.</span><span class="token function">getImportRegistry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>metadataReaderFactory <span class="token keyword">instanceof</span> <span class="token class-name">CachingMetadataReaderFactory</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// Clear cache in externally provided MetadataReaderFactory; this is a no-op</span>
        <span class="token comment">// for a shared cache since it'll be cleared by the ApplicationContext.</span>
        <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">CachingMetadataReaderFactory</span><span class="token punctuation">)</span> <span class="token keyword">this</span><span class="token punctuation">.</span>metadataReaderFactory<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">clearCache</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br></div></div><p>è¿™é‡Œæœ‰ä¸¤ä¸ªæ ¸å¿ƒæ–¹æ³•:</p> <p>(1) <strong>parse()</strong>  æ–¹æ³•. è§£æ<strong>é…ç½®ç±»</strong>, å°†<strong>åŒ…æ‰«æèƒ½å¤Ÿæ‰«æåˆ°çš„ BeanDefinition æ³¨å†Œåˆ°å®¹å™¨ä¸­</strong>!!!!!!</p> <p>(2) <strong>this.reader.loadBeanDefinitions(configClasses)</strong>  æ–¹æ³•. è¿™é‡Œå°†<strong>é…ç½®ç±»</strong>ä¸­å®šä¹‰çš„ BeanDefinition æ³¨å†Œåˆ°å®¹å™¨ä¸­!!! å¦‚é€šè¿‡ @Import å’Œ @Bean æ³¨è§£é…ç½®çš„ bean !!!!!</p> <p>é¦–å…ˆçœ‹çœ‹æ ¸å¿ƒæ–¹æ³• <strong>parse() æ–¹æ³•</strong>.</p> <blockquote><p>ConfigurationClassParser::parse()</p></blockquote> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">parse</span><span class="token punctuation">(</span><span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BeanDefinitionHolder</span><span class="token punctuation">&gt;</span></span> configCandidates<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>deferredImportSelectors <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">BeanDefinitionHolder</span> holder <span class="token operator">:</span> configCandidates<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">BeanDefinition</span> bd <span class="token operator">=</span> holder<span class="token punctuation">.</span><span class="token function">getBeanDefinition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">// æ³¨è§£æ–¹å¼é…ç½®çš„</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>bd <span class="token keyword">instanceof</span> <span class="token class-name">AnnotatedBeanDefinition</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">parse</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">AnnotatedBeanDefinition</span><span class="token punctuation">)</span> bd<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMetadata</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> holder<span class="token punctuation">.</span><span class="token function">getBeanName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>bd <span class="token keyword">instanceof</span> <span class="token class-name">AbstractBeanDefinition</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">AbstractBeanDefinition</span><span class="token punctuation">)</span> bd<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">hasBeanClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">parse</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">AbstractBeanDefinition</span><span class="token punctuation">)</span> bd<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBeanClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> holder<span class="token punctuation">.</span><span class="token function">getBeanName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token function">parse</span><span class="token punctuation">(</span>bd<span class="token punctuation">.</span><span class="token function">getBeanClassName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> holder<span class="token punctuation">.</span><span class="token function">getBeanName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">BeanDefinitionStoreException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> ex<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BeanDefinitionStoreException</span><span class="token punctuation">(</span>
                <span class="token string">&quot;Failed to parse configuration class [&quot;</span> <span class="token operator">+</span> bd<span class="token punctuation">.</span><span class="token function">getBeanClassName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;]&quot;</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token function">processDeferredImportSelectors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">protected</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">parse</span><span class="token punctuation">(</span><span class="token class-name">AnnotationMetadata</span> metadata<span class="token punctuation">,</span> <span class="token class-name">String</span> beanName<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
    <span class="token function">processConfigurationClass</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ConfigurationClass</span><span class="token punctuation">(</span>metadata<span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">processConfigurationClass</span><span class="token punctuation">(</span><span class="token class-name">ConfigurationClass</span> configClass<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>conditionEvaluator<span class="token punctuation">.</span><span class="token function">shouldSkip</span><span class="token punctuation">(</span>configClass<span class="token punctuation">.</span><span class="token function">getMetadata</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">ConfigurationPhase</span><span class="token punctuation">.</span><span class="token constant">PARSE_CONFIGURATION</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// çœ‹çœ‹æ˜¯å¦å·²ç»æœ‰äº†</span>
    <span class="token class-name">ConfigurationClass</span> existingClass <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>configurationClasses<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>configClass<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>existingClass <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>configClass<span class="token punctuation">.</span><span class="token function">isImported</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>existingClass<span class="token punctuation">.</span><span class="token function">isImported</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                existingClass<span class="token punctuation">.</span><span class="token function">mergeImportedBy</span><span class="token punctuation">(</span>configClass<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// Otherwise ignore new imported config class; existing non-imported class overrides it.</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment">// Explicit bean definition found, probably replacing an import.</span>
            <span class="token comment">// Let's remove the old one and go with the new one.</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>configurationClasses<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>configClass<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>knownSuperclasses<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">removeIf</span><span class="token punctuation">(</span>configClass<span class="token operator">::</span><span class="token function">equals</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Recursively process the configuration class and its superclass hierarchy.</span>
    <span class="token class-name">SourceClass</span> sourceClass <span class="token operator">=</span> <span class="token function">asSourceClass</span><span class="token punctuation">(</span>configClass<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">do</span> <span class="token punctuation">{</span>
        <span class="token comment">// çœŸæ­£å¹²æ´»çš„....</span>
        sourceClass <span class="token operator">=</span> <span class="token function">doProcessConfigurationClass</span><span class="token punctuation">(</span>configClass<span class="token punctuation">,</span> sourceClass<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>sourceClass <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span>configurationClasses<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>configClass<span class="token punctuation">,</span> configClass<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br></div></div><p>è¿›å…¥ <strong>doProcessConfigurationClass()</strong>  æ–¹æ³•.</p> <blockquote><p>ConfigurationClassParser::doProcessConfigurationClass()</p></blockquote> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Nullable</span>
<span class="token keyword">protected</span> <span class="token keyword">final</span> <span class="token class-name">SourceClass</span> <span class="token function">doProcessConfigurationClass</span><span class="token punctuation">(</span><span class="token class-name">ConfigurationClass</span> configClass<span class="token punctuation">,</span> <span class="token class-name">SourceClass</span> sourceClass<span class="token punctuation">)</span>
    <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>

    <span class="token comment">// Recursively process any member (nested) classes first</span>
    <span class="token function">processMemberClasses</span><span class="token punctuation">(</span>configClass<span class="token punctuation">,</span> sourceClass<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 1.å¤„ç†@PropertySourceæ³¨è§£</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">AnnotationAttributes</span> propertySource <span class="token operator">:</span> <span class="token class-name">AnnotationConfigUtils</span><span class="token punctuation">.</span><span class="token function">attributesForRepeatable</span><span class="token punctuation">(</span>
        sourceClass<span class="token punctuation">.</span><span class="token function">getMetadata</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">PropertySources</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span>
        <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span>PropertySource</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>environment <span class="token keyword">instanceof</span> <span class="token class-name">ConfigurableEnvironment</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">processPropertySource</span><span class="token punctuation">(</span>propertySource<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span> <span class="token punctuation">{</span>
            logger<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;Ignoring @PropertySource annotation on [&quot;</span> <span class="token operator">+</span> sourceClass<span class="token punctuation">.</span><span class="token function">getMetadata</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getClassName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span>
                        <span class="token string">&quot;]. Reason: Environment must implement ConfigurableEnvironment&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 2.å¤„ç†@ComponentScanæ³¨è§£(é‡è¦!!!)</span>
    <span class="token comment">// è§£æä¸ºComponentScanç±»å‹çš„AnnotationAttributes</span>
    <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AnnotationAttributes</span><span class="token punctuation">&gt;</span></span> componentScans <span class="token operator">=</span> <span class="token class-name">AnnotationConfigUtils</span><span class="token punctuation">.</span><span class="token function">attributesForRepeatable</span><span class="token punctuation">(</span>
        sourceClass<span class="token punctuation">.</span><span class="token function">getMetadata</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">ComponentScans</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token class-name">ComponentScan</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>componentScans<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
        <span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>conditionEvaluator<span class="token punctuation">.</span><span class="token function">shouldSkip</span><span class="token punctuation">(</span>sourceClass<span class="token punctuation">.</span><span class="token function">getMetadata</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">ConfigurationPhase</span><span class="token punctuation">.</span><span class="token constant">REGISTER_BEAN</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">AnnotationAttributes</span> componentScan <span class="token operator">:</span> componentScans<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// è¿”å›æ‰«æåˆ°çš„BeanDefinitionä¿¡æ¯: è¿™é‡Œå°±å¯¹æ ‡æ³¨çš„ @Controller @Service ç­‰æ³¨è§£çš„ç±»è¿›è¡Œäº†æ‰«æ</span>
            <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BeanDefinitionHolder</span><span class="token punctuation">&gt;</span></span> scannedBeanDefinitions <span class="token operator">=</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>componentScanParser<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>componentScan<span class="token punctuation">,</span> sourceClass<span class="token punctuation">.</span><span class="token function">getMetadata</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getClassName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// Check the set of scanned definitions for any further config classes and parse recursively if needed</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">BeanDefinitionHolder</span> holder <span class="token operator">:</span> scannedBeanDefinitions<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">BeanDefinition</span> bdCand <span class="token operator">=</span> holder<span class="token punctuation">.</span><span class="token function">getBeanDefinition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getOriginatingBeanDefinition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>bdCand <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    bdCand <span class="token operator">=</span> holder<span class="token punctuation">.</span><span class="token function">getBeanDefinition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">ConfigurationClassUtils</span><span class="token punctuation">.</span><span class="token function">checkConfigurationClassCandidate</span><span class="token punctuation">(</span>bdCand<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>metadataReaderFactory<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token function">parse</span><span class="token punctuation">(</span>bdCand<span class="token punctuation">.</span><span class="token function">getBeanClassName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> holder<span class="token punctuation">.</span><span class="token function">getBeanName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 3.å¤„ç†@Importæ³¨è§£</span>
    <span class="token function">processImports</span><span class="token punctuation">(</span>configClass<span class="token punctuation">,</span> sourceClass<span class="token punctuation">,</span> <span class="token function">getImports</span><span class="token punctuation">(</span>sourceClass<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 4.å¤„ç†@ImportResourceæ³¨è§£(ç”¨çš„ä¸å¤šå¿½ç•¥)</span>
    <span class="token class-name">AnnotationAttributes</span> importResource <span class="token operator">=</span>
        <span class="token class-name">AnnotationConfigUtils</span><span class="token punctuation">.</span><span class="token function">attributesFor</span><span class="token punctuation">(</span>sourceClass<span class="token punctuation">.</span><span class="token function">getMetadata</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">ImportResource</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>importResource <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> resources <span class="token operator">=</span> importResource<span class="token punctuation">.</span><span class="token function">getStringArray</span><span class="token punctuation">(</span><span class="token string">&quot;locations&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">BeanDefinitionReader</span><span class="token punctuation">&gt;</span></span> readerClass <span class="token operator">=</span> importResource<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token string">&quot;reader&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> resource <span class="token operator">:</span> resources<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">String</span> resolvedResource <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>environment<span class="token punctuation">.</span><span class="token function">resolveRequiredPlaceholders</span><span class="token punctuation">(</span>resource<span class="token punctuation">)</span><span class="token punctuation">;</span>
            configClass<span class="token punctuation">.</span><span class="token function">addImportedResource</span><span class="token punctuation">(</span>resolvedResource<span class="token punctuation">,</span> readerClass<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Process individual @Bean methods</span>
    <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MethodMetadata</span><span class="token punctuation">&gt;</span></span> beanMethods <span class="token operator">=</span> <span class="token function">retrieveBeanMethodMetadata</span><span class="token punctuation">(</span>sourceClass<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">MethodMetadata</span> methodMetadata <span class="token operator">:</span> beanMethods<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        configClass<span class="token punctuation">.</span><span class="token function">addBeanMethod</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BeanMethod</span><span class="token punctuation">(</span>methodMetadata<span class="token punctuation">,</span> configClass<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Process default methods on interfaces</span>
    <span class="token function">processInterfaces</span><span class="token punctuation">(</span>configClass<span class="token punctuation">,</span> sourceClass<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Process superclass, if any</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>sourceClass<span class="token punctuation">.</span><span class="token function">getMetadata</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">hasSuperClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> superclass <span class="token operator">=</span> sourceClass<span class="token punctuation">.</span><span class="token function">getMetadata</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getSuperClassName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>superclass <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>superclass<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">&quot;java&quot;</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
            <span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>knownSuperclasses<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>superclass<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>knownSuperclasses<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>superclass<span class="token punctuation">,</span> configClass<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// Superclass found, return its annotation metadata and recurse</span>
            <span class="token keyword">return</span> sourceClass<span class="token punctuation">.</span><span class="token function">getSuperClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// No superclass -&gt; processing is complete</span>
    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br></div></div><p>ä¸Šè¿°æ–¹æ³•å°±ä¼šå¯¹æ ‡æ³¨äº†  <strong>@Controller @Service</strong> ç­‰æ³¨è§£çš„ç±»è¿›è¡Œäº†æ‰«æ, å¹¶å°†å…¶ BeanDefinition è¿›è¡Œæ³¨å†Œ.</p> <p>æ³¨æ„: <mark><strong>æ³¨é‡Š 3 å¤„, å¤„ç†äº† @Import ç›¸å…³æ³¨è§£, è¿™é‡Œä¼šè°ƒç”¨ ImportSelector æ¥å£å®ç°ç±»çš„ selectImports() æ–¹æ³•å®ç° bean çš„å¯¼å…¥, è¿™é‡Œå°±æ˜¯ Spring Boot å®ç°è‡ªåŠ¨è£…é…çš„æ–¹æ³•</strong></mark>.</p> <p>æ¥ç€çœ‹çœ‹ç¬¬äºŒä¸ªæ ¸å¿ƒæ–¹æ³•: <strong>loadBeanDefinitions(configClasses)</strong>  æ–¹æ³•. è¿™é‡Œå…¥å‚ä¸ºé…ç½®ç±», ä¹Ÿå°±æ˜¯åŠ è½½é…ç½®ç±»ä¸­çš„ BeanDefinition.</p> <blockquote><p>ConfigurationClassBeanDefinitionReader::loadBeanDefinitions()</p></blockquote> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">loadBeanDefinitions</span><span class="token punctuation">(</span><span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ConfigurationClass</span><span class="token punctuation">&gt;</span></span> configurationModel<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">TrackedConditionEvaluator</span> trackedConditionEvaluator <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TrackedConditionEvaluator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">ConfigurationClass</span> configClass <span class="token operator">:</span> configurationModel<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// ä¸ºé…ç½®ç±»åŠ è½½BeanDefinition</span>
        <span class="token function">loadBeanDefinitionsForConfigurationClass</span><span class="token punctuation">(</span>configClass<span class="token punctuation">,</span> trackedConditionEvaluator<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>çœ‹æ–¹æ³•åå°±æ˜¯ä¸ºé…ç½®ç±»åŠ è½½ BeanDefinition.</p> <blockquote><p>ConfigurationClassBeanDefinitionReader::loadBeanDefinitionsForConfigurationClass()</p></blockquote> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">loadBeanDefinitionsForConfigurationClass</span><span class="token punctuation">(</span>
    <span class="token class-name">ConfigurationClass</span> configClass<span class="token punctuation">,</span> <span class="token class-name">TrackedConditionEvaluator</span> trackedConditionEvaluator<span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>trackedConditionEvaluator<span class="token punctuation">.</span><span class="token function">shouldSkip</span><span class="token punctuation">(</span>configClass<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> beanName <span class="token operator">=</span> configClass<span class="token punctuation">.</span><span class="token function">getBeanName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">hasLength</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>registry<span class="token punctuation">.</span><span class="token function">containsBeanDefinition</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>registry<span class="token punctuation">.</span><span class="token function">removeBeanDefinition</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>importRegistry<span class="token punctuation">.</span><span class="token function">removeImportingClass</span><span class="token punctuation">(</span>configClass<span class="token punctuation">.</span><span class="token function">getMetadata</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getClassName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// åˆ¤æ–­æ˜¯ä¸æ˜¯é€šè¿‡importå¯¼å…¥çš„</span>
    <span class="token comment">// å°†@Importæ³¨è§£ä¸­é…ç½®çš„ç±»çš„BeanDefinitionæ³¨å†Œåˆ°å®¹å™¨ä¸­!!!</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>configClass<span class="token punctuation">.</span><span class="token function">isImported</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">registerBeanDefinitionForImportedConfigurationClass</span><span class="token punctuation">(</span>configClass<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// çœ‹çœ‹æœ‰æ²¡æœ‰beanMethod</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">BeanMethod</span> beanMethod <span class="token operator">:</span> configClass<span class="token punctuation">.</span><span class="token function">getBeanMethods</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// é‡è¦!!! å°†@Beanæ³¨è§£é…ç½®çš„BeanDefinitionæ³¨å†Œåˆ°å®¹å™¨ä¸­!!!</span>
        <span class="token function">loadBeanDefinitionsForBeanMethod</span><span class="token punctuation">(</span>beanMethod<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">loadBeanDefinitionsFromImportedResources</span><span class="token punctuation">(</span>configClass<span class="token punctuation">.</span><span class="token function">getImportedResources</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">loadBeanDefinitionsFromRegistrars</span><span class="token punctuation">(</span>configClass<span class="token punctuation">.</span><span class="token function">getImportBeanDefinitionRegistrars</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><p>ä¸‹é¢å†å°†  <strong>@Bean æ³¨è§£</strong>é…ç½®çš„ BeanDefinition æ³¨å†Œåˆ°å®¹å™¨ä¸­.</p> <blockquote><p>ConfigurationClassBeanDefinitionReader::loadBeanDefinitionsForBeanMethod()</p></blockquote> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">loadBeanDefinitionsForBeanMethod</span><span class="token punctuation">(</span><span class="token class-name">BeanMethod</span> beanMethod<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// è·å–é…ç½®ç±»</span>
    <span class="token class-name">ConfigurationClass</span> configClass <span class="token operator">=</span> beanMethod<span class="token punctuation">.</span><span class="token function">getConfigurationClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">MethodMetadata</span> metadata <span class="token operator">=</span> beanMethod<span class="token punctuation">.</span><span class="token function">getMetadata</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> methodName <span class="token operator">=</span> metadata<span class="token punctuation">.</span><span class="token function">getMethodName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Do we need to mark the bean as skipped by its condition?</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>conditionEvaluator<span class="token punctuation">.</span><span class="token function">shouldSkip</span><span class="token punctuation">(</span>metadata<span class="token punctuation">,</span> <span class="token class-name">ConfigurationPhase</span><span class="token punctuation">.</span><span class="token constant">REGISTER_BEAN</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        configClass<span class="token punctuation">.</span>skippedBeanMethods<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>methodName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>configClass<span class="token punctuation">.</span>skippedBeanMethods<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>methodName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// è¿™é‡Œè§£æé…ç½®ç±»ä¸­é…ç½®çš„@Beançš„æ³¨è§£çš„å„ç§ä¿¡æ¯</span>
    <span class="token class-name">AnnotationAttributes</span> bean <span class="token operator">=</span> <span class="token class-name">AnnotationConfigUtils</span><span class="token punctuation">.</span><span class="token function">attributesFor</span><span class="token punctuation">(</span>metadata<span class="token punctuation">,</span> <span class="token class-name">Bean</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">state</span><span class="token punctuation">(</span>bean <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string">&quot;No @Bean annotation attributes&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// beanNameä¸åˆ«åç›¸å…³</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> names <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span>bean<span class="token punctuation">.</span><span class="token function">getStringArray</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> beanName <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">!</span>names<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span> names<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">:</span> methodName<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// æ³¨å†ŒBeançš„åˆ«å</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> alias <span class="token operator">:</span> names<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>registry<span class="token punctuation">.</span><span class="token function">registerAlias</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> alias<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Has this effectively been overridden before (e.g. via XML)?</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isOverriddenByExistingDefinition</span><span class="token punctuation">(</span>beanMethod<span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>beanName<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>beanMethod<span class="token punctuation">.</span><span class="token function">getConfigurationClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBeanName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BeanDefinitionStoreException</span><span class="token punctuation">(</span>beanMethod<span class="token punctuation">.</span><span class="token function">getConfigurationClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getResource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDescription</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                                   beanName<span class="token punctuation">,</span> <span class="token string">&quot;Bean name derived from @Bean method '&quot;</span> <span class="token operator">+</span> beanMethod<span class="token punctuation">.</span><span class="token function">getMetadata</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMethodName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span>
                                                   <span class="token string">&quot;' clashes with bean name for containing configuration class; please make those names unique!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// åˆå§‹åŒ–ä¸€ä¸ª: é…ç½®ç±»ä¸­å®šä¹‰ç±»çš„BeanDefinition</span>
    <span class="token class-name">ConfigurationClassBeanDefinition</span> beanDef <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConfigurationClassBeanDefinition</span><span class="token punctuation">(</span>configClass<span class="token punctuation">,</span> metadata<span class="token punctuation">)</span><span class="token punctuation">;</span>
    beanDef<span class="token punctuation">.</span><span class="token function">setSource</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>sourceExtractor<span class="token punctuation">.</span><span class="token function">extractSource</span><span class="token punctuation">(</span>metadata<span class="token punctuation">,</span> configClass<span class="token punctuation">.</span><span class="token function">getResource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>metadata<span class="token punctuation">.</span><span class="token function">isStatic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// static @Bean method</span>
        beanDef<span class="token punctuation">.</span><span class="token function">setBeanClassName</span><span class="token punctuation">(</span>configClass<span class="token punctuation">.</span><span class="token function">getMetadata</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getClassName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        beanDef<span class="token punctuation">.</span><span class="token function">setFactoryMethodName</span><span class="token punctuation">(</span>methodName<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// instance @Bean method</span>
        beanDef<span class="token punctuation">.</span><span class="token function">setFactoryBeanName</span><span class="token punctuation">(</span>configClass<span class="token punctuation">.</span><span class="token function">getBeanName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        beanDef<span class="token punctuation">.</span><span class="token function">setUniqueFactoryMethodName</span><span class="token punctuation">(</span>methodName<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    beanDef<span class="token punctuation">.</span><span class="token function">setAutowireMode</span><span class="token punctuation">(</span><span class="token class-name">AbstractBeanDefinition</span><span class="token punctuation">.</span><span class="token constant">AUTOWIRE_CONSTRUCTOR</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    beanDef<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token class-name">RequiredAnnotationBeanPostProcessor</span><span class="token punctuation">.</span><span class="token constant">SKIP_REQUIRED_CHECK_ATTRIBUTE</span><span class="token punctuation">,</span> <span class="token class-name">Boolean</span><span class="token punctuation">.</span><span class="token constant">TRUE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">AnnotationConfigUtils</span><span class="token punctuation">.</span><span class="token function">processCommonDefinitionAnnotations</span><span class="token punctuation">(</span>beanDef<span class="token punctuation">,</span> metadata<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// è·å–@Beanä¸­é…ç½®çš„å„ç§å±æ€§</span>
    <span class="token class-name">Autowire</span> autowire <span class="token operator">=</span> bean<span class="token punctuation">.</span><span class="token function">getEnum</span><span class="token punctuation">(</span><span class="token string">&quot;autowire&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>autowire<span class="token punctuation">.</span><span class="token function">isAutowire</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        beanDef<span class="token punctuation">.</span><span class="token function">setAutowireMode</span><span class="token punctuation">(</span>autowire<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// è·å–é…ç½®çš„åˆå§‹åŒ–æ–¹æ³•</span>
    <span class="token class-name">String</span> initMethodName <span class="token operator">=</span> bean<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">&quot;initMethod&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">hasText</span><span class="token punctuation">(</span>initMethodName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        beanDef<span class="token punctuation">.</span><span class="token function">setInitMethodName</span><span class="token punctuation">(</span>initMethodName<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// è·å–é…ç½®çš„é”€æ¯æ–¹æ³•</span>
    <span class="token class-name">String</span> destroyMethodName <span class="token operator">=</span> bean<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">&quot;destroyMethod&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    beanDef<span class="token punctuation">.</span><span class="token function">setDestroyMethodName</span><span class="token punctuation">(</span>destroyMethodName<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// è®¾ç½®Scope</span>
    <span class="token class-name">ScopedProxyMode</span> proxyMode <span class="token operator">=</span> <span class="token class-name">ScopedProxyMode</span><span class="token punctuation">.</span><span class="token constant">NO</span><span class="token punctuation">;</span>
    <span class="token class-name">AnnotationAttributes</span> attributes <span class="token operator">=</span> <span class="token class-name">AnnotationConfigUtils</span><span class="token punctuation">.</span><span class="token function">attributesFor</span><span class="token punctuation">(</span>metadata<span class="token punctuation">,</span> <span class="token class-name">Scope</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>attributes <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        beanDef<span class="token punctuation">.</span><span class="token function">setScope</span><span class="token punctuation">(</span>attributes<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">&quot;value&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        proxyMode <span class="token operator">=</span> attributes<span class="token punctuation">.</span><span class="token function">getEnum</span><span class="token punctuation">(</span><span class="token string">&quot;proxyMode&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>proxyMode <span class="token operator">==</span> <span class="token class-name">ScopedProxyMode</span><span class="token punctuation">.</span><span class="token constant">DEFAULT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            proxyMode <span class="token operator">=</span> <span class="token class-name">ScopedProxyMode</span><span class="token punctuation">.</span><span class="token constant">NO</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Replace the original bean definition with the target one, if necessary</span>
    <span class="token class-name">BeanDefinition</span> beanDefToRegister <span class="token operator">=</span> beanDef<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>proxyMode <span class="token operator">!=</span> <span class="token class-name">ScopedProxyMode</span><span class="token punctuation">.</span><span class="token constant">NO</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">BeanDefinitionHolder</span> proxyDef <span class="token operator">=</span> <span class="token class-name">ScopedProxyCreator</span><span class="token punctuation">.</span><span class="token function">createScopedProxy</span><span class="token punctuation">(</span>
            <span class="token keyword">new</span> <span class="token class-name">BeanDefinitionHolder</span><span class="token punctuation">(</span>beanDef<span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>registry<span class="token punctuation">,</span>
            proxyMode <span class="token operator">==</span> <span class="token class-name">ScopedProxyMode</span><span class="token punctuation">.</span><span class="token constant">TARGET_CLASS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        beanDefToRegister <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConfigurationClassBeanDefinition</span><span class="token punctuation">(</span>
            <span class="token punctuation">(</span><span class="token class-name">RootBeanDefinition</span><span class="token punctuation">)</span> proxyDef<span class="token punctuation">.</span><span class="token function">getBeanDefinition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> configClass<span class="token punctuation">,</span> metadata<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;Registering bean definition for @Bean method %s.%s()&quot;</span><span class="token punctuation">,</span>
                                   configClass<span class="token punctuation">.</span><span class="token function">getMetadata</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getClassName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// æœ€åå°†é…ç½®ç±»ä¸­çš„@Beanæ³¨è§£çš„BeanDefinitionè¿›è¡Œæ³¨å†Œ</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>registry<span class="token punctuation">.</span><span class="token function">registerBeanDefinition</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> beanDefToRegister<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br></div></div><h5 id="_4-æ‹“å±•ä½¿ç”¨"><a href="#_4-æ‹“å±•ä½¿ç”¨" class="header-anchor">#</a> 4.æ‹“å±•ä½¿ç”¨</h5> <h6 id="_1-beandefinitionregistrypostprocessoræ¥å£åº”ç”¨"><a href="#_1-beandefinitionregistrypostprocessoræ¥å£åº”ç”¨" class="header-anchor">#</a> (1)BeanDefinitionRegistryPostProcessoræ¥å£åº”ç”¨</h6> <p>ä¸€ä¸ªå®ç°ç±»ä¾‹å­å¦‚ä¸‹.</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">NanoBeanDefinitionRegistryPostProcessor</span> <span class="token keyword">implements</span> <span class="token class-name">BeanDefinitionRegistryPostProcessor</span><span class="token punctuation">,</span> <span class="token class-name">Ordered</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">postProcessBeanFactory</span><span class="token punctuation">(</span><span class="token class-name">ConfigurableListableBeanFactory</span> beanFactory<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">BeansException</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;NanoBeanDefinitionRegistryPostProcessorç±»çš„postProcessBeanFactoryæ–¹æ³•...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// è‡ªå·±çš„é€»è¾‘å¤„ç†</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">postProcessBeanDefinitionRegistry</span><span class="token punctuation">(</span><span class="token class-name">BeanDefinitionRegistry</span> registry<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">BeansException</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;NanoBeanDefinitionRegistryPostProcessorç±»çš„postProcessBeanDefinitionRegistryæ–¹æ³•...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// è‡ªå·±çš„é€»è¾‘å¤„ç†</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><p>å®é™…çš„åº”ç”¨ä¾‹å­: åœ¨ä½¿ç”¨ MyBatis + Spring æ—¶, ç»å¸¸ç”¨åˆ°çš„ <strong>org.mybatis.spring.mapper.MapperScannerConfigurer</strong> å°±æ˜¯ä¸€ä¸ª <strong>BeanDefinitionRegistryPostProcessor</strong>.</p> <p>MapperScannerConfigurer åœ¨ postProcessBeanDefinitionRegistry() æ–¹æ³•ä¸­è¿›è¡Œäº†<strong>ä¸€äº›æ“ä½œ</strong>, æ¯”å¦‚: æ‰«æ basePackage æŒ‡å®šçš„ç›®å½•, å°†è¯¥ç›®å½•ä¸‹çš„ç±»(é€šå¸¸æ˜¯ DAO/MAPPER æ¥å£)å°è£…æˆ <strong>BeanDefinition</strong> å¹¶åŠ è½½åˆ° BeanFactory ä¸­. å› æ­¤, é¡¹ç›®ä¸­çš„ DAO(MAPPER) æ¥å£, é€šå¸¸éƒ½<strong>æ²¡æœ‰</strong>ä½¿ç”¨æ³¨è§£æˆ– XML çš„æ–¹å¼æ³¨å†Œåˆ° Spring å®¹å™¨, ä½†è¿˜æ˜¯å¯ä»¥åœ¨ Service æœåŠ¡ä¸­ä½¿ç”¨ @Autowire æ³¨è§£æ¥å°†å…¶æ³¨å…¥åˆ° Service ä¸­å°±æ˜¯è¿™ä¸ªåŸå› .</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>org.mybatis.spring.mapper.MapperScannerConfigurer<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!--basePackageæŒ‡å®šè¦æ‰«æçš„åŒ…, åœ¨æ­¤åŒ…ä¹‹ä¸‹çš„æ˜ å°„å™¨éƒ½ä¼šè¢«æœç´¢åˆ°. å¯æŒ‡å®šå¤šä¸ªåŒ…, åŒ…ä¸åŒ…ä¹‹é—´ç”¨é€—å·æˆ–åˆ†å·åˆ†éš”--&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>basePackage<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>com.nano.demo.mapper<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>sqlSessionFactoryBeanName<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>sqlSessionFactory<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p><img src="https://nano-note.oss-cn-beijing.aliyuncs.com/images/ComponentScan.png" alt="img"></p> <h6 id="_2-beanfactorypostprocessoræ¥å£åº”ç”¨"><a href="#_2-beanfactorypostprocessoræ¥å£åº”ç”¨" class="header-anchor">#</a> (2)BeanFactoryPostProcessoræ¥å£åº”ç”¨</h6> <p>ä¸€ä¸ªè‡ªå®šä¹‰çš„å®ç°ç±».</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">NanoBeanFactoryPostProcessor</span> <span class="token keyword">implements</span> <span class="token class-name">BeanFactoryPostProcessor</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">postProcessBeanFactory</span><span class="token punctuation">(</span><span class="token class-name">ConfigurableListableBeanFactory</span> beanFactory<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">BeansException</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;NanoBeanFactoryPostProcessorç±»çš„postProcessBeanFactoryæ–¹æ³•...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// è‡ªå·±çš„é€»è¾‘å¤„ç†</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h4 id="registerbeanpostprocessors-beanfactory"><a href="#registerbeanpostprocessors-beanfactory" class="header-anchor">#</a> registerBeanPostProcessors(beanFactory)</h4> <h5 id="_1-æ¦‚è¿°-3"><a href="#_1-æ¦‚è¿°-3" class="header-anchor">#</a> 1.æ¦‚è¿°</h5> <p>å‰ä¸€ä¸ª invokeBeanFactoryPostProcessors() æ–¹æ³•ä¸»è¦ç”¨äºæ³¨å†Œä¸å¤„ç† <strong>BeanFactoryPostProcessor</strong> æ¥å£, è€Œ registerBeanPostProcessors æ–¹æ³•ä¸»è¦ç”¨äºå¤„ç† <strong>BeanPostProcessor</strong> æ¥å£å®ç°ç±».</p> <p>BeanFactoryPostProcessor å’Œ BeanPostProcessor è¿™ä¸¤ä¸ªæ¥å£â€œé•¿å¾—å¾ˆåƒâ€.</p> <p><mark><strong>BeanFactoryPostProcessor</strong></mark> æ˜¯é’ˆå¯¹ <mark><strong>BeanFactory</strong></mark> çš„æ‰©å±•, ä¸»è¦ç”¨åœ¨ <strong>bean å®ä¾‹åŒ–ä¹‹å‰, è¯»å– bean çš„å®šä¹‰, å¹¶å¯ä»¥ä¿®æ”¹å®ƒ</strong>.</p> <p><mark><strong>BeanPostProcessor</strong></mark> æ˜¯é’ˆå¯¹ <mark><strong>bean</strong></mark> çš„æ‰©å±•, ä¸»è¦ç”¨åœ¨ <strong>bean å®ä¾‹åŒ–ä¹‹å, æ‰§è¡Œåˆå§‹åŒ–æ–¹æ³•å‰å, å…è®¸å¼€å‘è€…å¯¹ bean å®ä¾‹è¿›è¡Œä¿®æ”¹</strong>.</p> <p>æœ¬æ–¹æ³•ä¼šæ³¨å†Œæ‰€æœ‰çš„ BeanPostProcessor, å°†æ‰€æœ‰å®ç°äº† BeanPostProcessor æ¥å£çš„ç±»åŠ è½½åˆ° BeanFactory ä¸­.</p> <p><strong>BeanPostProcessor</strong> æ¥å£æ˜¯ Spring åˆå§‹åŒ– <strong>bean</strong> æ—¶å¯¹å¤–æš´éœ²çš„æ‰©å±•ç‚¹, IoC å®¹å™¨å…è®¸ BeanPostProcessor åœ¨<strong>å®¹å™¨åˆå§‹åŒ– bean çš„å‰å</strong>, æ·»åŠ è‡ªå·±çš„é€»è¾‘å¤„ç†. <mark><strong>è¿™é‡Œçš„ registerBeanPostProcessors() æ–¹æ³•åªæ˜¯å°†å„ç§ BeanPostProcessor æ³¨å†Œåˆ° BeanFactory ä¸­, å…·ä½“çš„æ¥å£æ–¹æ³•è°ƒç”¨æ˜¯åœ¨ bean åˆå§‹åŒ–çš„æ—¶å€™</strong></mark>.</p> <p>BeanPostProcessor æ¥å£å¦‚ä¸‹:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">BeanPostProcessor</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Nullable</span>
    <span class="token keyword">default</span> <span class="token class-name">Object</span> <span class="token function">postProcessBeforeInitialization</span><span class="token punctuation">(</span><span class="token class-name">Object</span> bean<span class="token punctuation">,</span> <span class="token class-name">String</span> beanName<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">BeansException</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> bean<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Nullable</span>
    <span class="token keyword">default</span> <span class="token class-name">Object</span> <span class="token function">postProcessAfterInitialization</span><span class="token punctuation">(</span><span class="token class-name">Object</span> bean<span class="token punctuation">,</span> <span class="token class-name">String</span> beanName<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">BeansException</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> bean<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>å…·ä½“çš„: åœ¨ä¹‹åçš„ finishBeanFactoryInitialization() æ–¹æ³•å¯¹æ‰€æœ‰ bean è¿›è¡Œå®ä¾‹åŒ–æ—¶, æ‰§è¡Œ<strong>åˆå§‹åŒ–æ–¹æ³•å‰</strong>ä¼šè°ƒç”¨æ‰€æœ‰ BeanPostProcessor çš„ <strong>postProcessBeforeInitialization()</strong>  æ–¹æ³•, åœ¨æ‰§è¡Œ<strong>åˆå§‹åŒ–æ–¹æ³•å</strong>ä¼šè°ƒç”¨æ‰€æœ‰ BeanPostProcessor çš„ <strong>postProcessAfterInitialization()</strong>  æ–¹æ³•.</p> <h5 id="_2-åˆ†æ"><a href="#_2-åˆ†æ" class="header-anchor">#</a> 2.åˆ†æ</h5> <p>è¿›å»æ–¹æ³•æºç . è¿™ä¸ªæ–¹æ³•å®Œæˆåæ‰€æœ‰çš„<strong>åç½®å¤„ç†å™¨</strong>éƒ½å¯ä»¥æ­£å¸¸å·¥ä½œäº†.</p> <blockquote><p>AbstractApplicationContext::registerBeanPostProcessors()</p></blockquote> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">registerBeanPostProcessors</span><span class="token punctuation">(</span><span class="token class-name">ConfigurableListableBeanFactory</span> beanFactory<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ç»§ç»­çœ‹</span>
    <span class="token class-name">PostProcessorRegistrationDelegate</span><span class="token punctuation">.</span><span class="token function">registerBeanPostProcessors</span><span class="token punctuation">(</span>beanFactory<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>è¿›å»çœ‹:</p> <blockquote><p>PostProcessorRegistrationDelegate.registerBeanPostProcessors()</p></blockquote> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">registerBeanPostProcessors</span><span class="token punctuation">(</span>
    <span class="token class-name">ConfigurableListableBeanFactory</span> beanFactory<span class="token punctuation">,</span> <span class="token class-name">AbstractApplicationContext</span> applicationContext<span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token comment">// 1.è·å–æ‰€æœ‰å®ç°BeanPostProcessoræ¥å£çš„ç±»çš„BeanName</span>
    <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> postProcessorNames <span class="token operator">=</span> beanFactory<span class="token punctuation">.</span><span class="token function">getBeanNamesForType</span><span class="token punctuation">(</span><span class="token class-name">BeanPostProcessor</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// BeanPostProcessorçš„ç›®æ ‡è®¡æ•°</span>
    <span class="token keyword">int</span> beanProcessorTargetCount <span class="token operator">=</span> beanFactory<span class="token punctuation">.</span><span class="token function">getBeanPostProcessorCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">+</span> postProcessorNames<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
    <span class="token comment">// 2.æ·»åŠ BeanPostProcessorChecker(ä¸»è¦ç”¨äºè®°å½•ä¿¡æ¯)åˆ°beanFactoryä¸­</span>
    beanFactory<span class="token punctuation">.</span><span class="token function">addBeanPostProcessor</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BeanPostProcessorChecker</span><span class="token punctuation">(</span>beanFactory<span class="token punctuation">,</span> beanProcessorTargetCount<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 3.å®šä¹‰ä¸åŒçš„å˜é‡ç”¨äºåŒºåˆ†: å®ç°PriorityOrderedæ¥å£çš„BeanPostProcessor, å®ç°Orderedæ¥å£çš„BeanPostProcessor, æ™®é€šBeanPostProcessor</span>
    <span class="token comment">// 3.1 priorityOrderedPostProcessors: ç”¨äºå­˜æ”¾å®ç°PriorityOrderedæ¥å£çš„BeanPostProcessor</span>
    <span class="token comment">// ä½¿ç”¨PriorityOrderedä¿è¯é¡ºåº</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BeanPostProcessor</span><span class="token punctuation">&gt;</span></span> priorityOrderedPostProcessors <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 3.2 internalPostProcessors: ç”¨äºå­˜æ”¾Springå†…éƒ¨çš„BeanPostProcessor</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BeanPostProcessor</span><span class="token punctuation">&gt;</span></span> internalPostProcessors <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 3.3 orderedPostProcessorNames: ç”¨äºå­˜æ”¾å®ç°Orderedæ¥å£çš„BeanPostProcessorçš„beanName</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> orderedPostProcessorNames <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 3.4 nonOrderedPostProcessorNames: ç”¨äºå­˜æ”¾æ™®é€šBeanPostProcessorçš„beanName</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> nonOrderedPostProcessorNames <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 4.éå†postProcessorNames, å°†BeanPostProcessorsæŒ‰3.1 - 3.4å®šä¹‰çš„å˜é‡åŒºåˆ†å¼€</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> ppName <span class="token operator">:</span> postProcessorNames<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>beanFactory<span class="token punctuation">.</span><span class="token function">isTypeMatch</span><span class="token punctuation">(</span>ppName<span class="token punctuation">,</span> <span class="token class-name">PriorityOrdered</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 4.1 å¦‚æœppNameå¯¹åº”çš„Beanå®ä¾‹å®ç°äº†PriorityOrderedæ¥å£, åˆ™æ‹¿åˆ°ppNameå¯¹åº”çš„Beanå®ä¾‹å¹¶æ·»åŠ åˆ°priorityOrderedPostProcessors</span>
            <span class="token comment">// è¿™é‡Œä½¿ç”¨getBean()æ–¹æ³•æ˜¾å¼çš„åˆ›å»ºäº†bean</span>
            <span class="token class-name">BeanPostProcessor</span> pp <span class="token operator">=</span> beanFactory<span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span>ppName<span class="token punctuation">,</span> <span class="token class-name">BeanPostProcessor</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            priorityOrderedPostProcessors<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>pp<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>pp <span class="token keyword">instanceof</span> <span class="token class-name">MergedBeanDefinitionPostProcessor</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// 4.2 å¦‚æœppNameå¯¹åº”çš„Beanå®ä¾‹ä¹Ÿå®ç°äº†MergedBeanDefinitionPostProcessoræ¥å£,</span>
                <span class="token comment">// åˆ™å°†ppNameå¯¹åº”çš„Beanå®ä¾‹æ·»åŠ åˆ°internalPostProcessors</span>
                internalPostProcessors<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>pp<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>beanFactory<span class="token punctuation">.</span><span class="token function">isTypeMatch</span><span class="token punctuation">(</span>ppName<span class="token punctuation">,</span> <span class="token class-name">Ordered</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 4.3 å¦‚æœppNameå¯¹åº”çš„Beanå®ä¾‹æ²¡æœ‰å®ç°PriorityOrderedæ¥å£, ä½†æ˜¯å®ç°äº†Orderedæ¥å£, åˆ™å°†ppNameæ·»åŠ åˆ°orderedPostProcessorNames</span>
            orderedPostProcessorNames<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>ppName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment">// 4.4 å¦åˆ™å°†ppNameæ·»åŠ åˆ°nonOrderedPostProcessorNames</span>
            nonOrderedPostProcessorNames<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>ppName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 5.é¦–å…ˆ,æ³¨å†Œå®ç°äº†PriorityOrderedæ¥å£çš„BeanPostProcessors</span>
    <span class="token comment">// 5.1 å¯¹priorityOrderedPostProcessorsè¿›è¡Œæ’åº</span>
    <span class="token function">sortPostProcessors</span><span class="token punctuation">(</span>priorityOrderedPostProcessors<span class="token punctuation">,</span> beanFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 5.2 æ³¨å†ŒpriorityOrderedPostProcessors</span>
    <span class="token function">registerBeanPostProcessors</span><span class="token punctuation">(</span>beanFactory<span class="token punctuation">,</span> priorityOrderedPostProcessors<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 6.å…¶æ¬¡,æ³¨å†Œå®ç°äº†Orderedæ¥å£çš„BeanPostProcessors</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BeanPostProcessor</span><span class="token punctuation">&gt;</span></span> orderedPostProcessors <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> ppName <span class="token operator">:</span> orderedPostProcessorNames<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 6.1 æ‹¿åˆ°ppNameå¯¹åº”çš„BeanPostProcessorå®ä¾‹å¯¹è±¡</span>
        <span class="token class-name">BeanPostProcessor</span> pp <span class="token operator">=</span> beanFactory<span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span>ppName<span class="token punctuation">,</span> <span class="token class-name">BeanPostProcessor</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 6.2 å°†ppNameå¯¹åº”çš„BeanPostProcessorå®ä¾‹å¯¹è±¡æ·»åŠ åˆ°orderedPostProcessors, å‡†å¤‡æ‰§è¡Œæ³¨å†Œ</span>
        orderedPostProcessors<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>pp<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>pp <span class="token keyword">instanceof</span> <span class="token class-name">MergedBeanDefinitionPostProcessor</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 6.3 å¦‚æœppNameå¯¹åº”çš„Beanå®ä¾‹ä¹Ÿå®ç°äº†MergedBeanDefinitionPostProcessoræ¥å£,</span>
            <span class="token comment">// åˆ™å°†ppNameå¯¹åº”çš„Beanå®ä¾‹æ·»åŠ åˆ°internalPostProcessors</span>
            internalPostProcessors<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>pp<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 6.4 å¯¹orderedPostProcessorsè¿›è¡Œæ’åº</span>
    <span class="token function">sortPostProcessors</span><span class="token punctuation">(</span>orderedPostProcessors<span class="token punctuation">,</span> beanFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 6.5 æ³¨å†ŒorderedPostProcessors</span>
    <span class="token function">registerBeanPostProcessors</span><span class="token punctuation">(</span>beanFactory<span class="token punctuation">,</span> orderedPostProcessors<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 7.æ³¨å†Œæ‰€æœ‰å¸¸è§„çš„BeanPostProcessors(è¿‡ç¨‹ä¸6ç±»ä¼¼)</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BeanPostProcessor</span><span class="token punctuation">&gt;</span></span> nonOrderedPostProcessors <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> ppName <span class="token operator">:</span> nonOrderedPostProcessorNames<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">BeanPostProcessor</span> pp <span class="token operator">=</span> beanFactory<span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span>ppName<span class="token punctuation">,</span> <span class="token class-name">BeanPostProcessor</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        nonOrderedPostProcessors<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>pp<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>pp <span class="token keyword">instanceof</span> <span class="token class-name">MergedBeanDefinitionPostProcessor</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            internalPostProcessors<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>pp<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token function">registerBeanPostProcessors</span><span class="token punctuation">(</span>beanFactory<span class="token punctuation">,</span> nonOrderedPostProcessors<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 8.æœ€å,é‡æ–°æ³¨å†Œæ‰€æœ‰å†…éƒ¨BeanPostProcessors(ç›¸å½“äºå†…éƒ¨çš„BeanPostProcessorä¼šè¢«ç§»åˆ°å¤„ç†å™¨é“¾çš„æœ«å°¾)</span>
    <span class="token comment">// 8.1 å¯¹internalPostProcessorsè¿›è¡Œæ’åº</span>
    <span class="token function">sortPostProcessors</span><span class="token punctuation">(</span>internalPostProcessors<span class="token punctuation">,</span> beanFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 8.2æ³¨å†ŒinternalPostProcessors</span>
    <span class="token function">registerBeanPostProcessors</span><span class="token punctuation">(</span>beanFactory<span class="token punctuation">,</span> internalPostProcessors<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// æ·»åŠ ApplicationListeneræ¢æµ‹å™¨</span>
    <span class="token comment">// 9.é‡æ–°æ³¨å†ŒApplicationListenerDetector(è·Ÿ8ç±»ä¼¼, ä¸»è¦æ˜¯ä¸ºäº†ç§»åŠ¨åˆ°å¤„ç†å™¨é“¾çš„æœ«å°¾)</span>
    beanFactory<span class="token punctuation">.</span><span class="token function">addBeanPostProcessor</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ApplicationListenerDetector</span><span class="token punctuation">(</span>applicationContext<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br></div></div><p>è¿™é‡Œå°† BeanPostProcessor æ¥å£çš„<strong>å®ç°ç±»</strong>æ³¨å†Œåˆ°å®¹å™¨ä¸­. æ•´ç†çš„ä»£ç é£æ ¼è·Ÿä¹‹å‰çš„ invokeBeanFactoryPostProcessors() æ–¹æ³•å¾ˆç±»ä¼¼. æ•´ä½“åŸºæœ¬å°±æ˜¯å°† BeanPostProcessor æ¥å£çš„å®ç°ç±»æŒ‰ç…§æ˜¯å¦å®ç° <strong>PriorityOrdered, Ordered æ¥å£</strong>è€Œè¿›è¡Œåˆ†ç±», ç„¶ååˆ†åˆ«æŒ‰ç…§ä¼˜å…ˆçº§é¡ºåºæ³¨å†Œåˆ°å®¹å™¨ä¸­. æ³¨å†Œæ–¹å¼å³è°ƒç”¨å¦‚ä¸‹é‡è½½çš„é™æ€æ–¹æ³•, å¯ä»¥çœ‹åˆ°ä¸Šè¿°å¾ˆå¤šåœ°æ–¹éƒ½è°ƒç”¨äº†.</p> <blockquote><p>PostProcessorRegistrationDelegate.registerBeanPostProcessors()</p></blockquote> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">registerBeanPostProcessors</span><span class="token punctuation">(</span>
    <span class="token class-name">ConfigurableListableBeanFactory</span> beanFactory<span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BeanPostProcessor</span><span class="token punctuation">&gt;</span></span> postProcessors<span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">BeanPostProcessor</span> postProcessor <span class="token operator">:</span> postProcessors<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// é€ä¸€æ³¨å†Œåˆ°BeanFactoryä¸­</span>
        <span class="token comment">// å°†PostProcessoræ·»åŠ åˆ°BeanFactoryä¸­çš„beanPostProcessorsç¼“å­˜</span>
        beanFactory<span class="token punctuation">.</span><span class="token function">addBeanPostProcessor</span><span class="token punctuation">(</span>postProcessor<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><blockquote><p>AbstractBeanFactory#addBeanPostProcessor()</p></blockquote> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addBeanPostProcessor</span><span class="token punctuation">(</span><span class="token class-name">BeanPostProcessor</span> beanPostProcessor<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">notNull</span><span class="token punctuation">(</span>beanPostProcessor<span class="token punctuation">,</span> <span class="token string">&quot;BeanPostProcessor must not be null&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 1.å¦‚æœbeanPostProcessorå·²ç»å­˜åœ¨åˆ™ç§»é™¤</span>
    <span class="token comment">// è¿™å¯ä»¥èµ·åˆ°æ’åºçš„æ•ˆæœ, beanPostProcessorå¯èƒ½æœ¬æ¥åœ¨å‰é¢, ç§»é™¤å†æ·»åŠ , åˆ™å˜åˆ°æœ€åé¢</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>beanPostProcessors<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>beanPostProcessor<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>beanPostProcessor <span class="token keyword">instanceof</span> <span class="token class-name">InstantiationAwareBeanPostProcessor</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 2.å¦‚æœbeanPostProcessoræ˜¯InstantiationAwareBeanPostProcessor, åˆ™å°†hasInstantiationAwareBeanPostProcessorsè®¾ç½®ä¸ºtrue,</span>
        <span class="token comment">// è¯¥å˜é‡ç”¨äºæŒ‡ç¤ºbeanFactoryæ˜¯å¦å·²æ³¨å†Œè¿‡InstantiationAwareBeanPostProcessors</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>hasInstantiationAwareBeanPostProcessors <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>beanPostProcessor <span class="token keyword">instanceof</span> <span class="token class-name">DestructionAwareBeanPostProcessor</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 3.å¦‚æœbeanPostProcessoræ˜¯DestructionAwareBeanPostProcessor, åˆ™å°†hasInstantiationAwareBeanPostProcessorsè®¾ç½®ä¸ºtrue,</span>
        <span class="token comment">// è¯¥å˜é‡ç”¨äºæŒ‡ç¤ºbeanFactoryæ˜¯å¦å·²æ³¨å†Œè¿‡DestructionAwareBeanPostProcessor</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>hasDestructionAwareBeanPostProcessors <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 4.å°†beanPostProcessoræ·»åŠ åˆ°beanPostProcessorsç¼“å­˜</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>beanPostProcessors<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>beanPostProcessor<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><p>æœ¬æ–¹æ³•å°±æ˜¯å°† BeanPostProcessor æ·»åŠ åˆ° <strong>beanPostProcessors ç¼“å­˜</strong>, è¿™é‡Œç¼“å­˜å…¶å®å°±æ˜¯ BeanPostProcessor çš„ä¸€ä¸ª<strong>åˆ—è¡¨</strong>.</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BeanPostProcessor</span><span class="token punctuation">&gt;</span></span> beanPostProcessors <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CopyOnWriteArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>æœ¬æ–¹æ³•ä¸­å¯¹ BeanPostProcessor å…ˆç§»é™¤å†æ·»åŠ , ä¸»è¦æ˜¯èµ·ä¸€ä¸ª<strong>æ’åº</strong>çš„ä½œç”¨. è€Œ hasInstantiationAwareBeanPostProcessors å’Œ hasDestructionAwareBeanPostProcessors å˜é‡ç”¨äºæŒ‡ç¤º beanFactory æ˜¯å¦å·²æ³¨å†Œè¿‡ InstantiationAwareBeanPostProcessors å’Œ DestructionAwareBeanPostProcessor, åœ¨ä¹‹åçš„ IoC åˆ›å»ºè¿‡ç¨‹ä¼šç”¨åˆ°è¿™ä¸¤ä¸ªå˜é‡, è¿™è¾¹å…ˆæœ‰ä¸ªå°è±¡.</p> <h5 id="_3-æ‹“å±•ä½¿ç”¨"><a href="#_3-æ‹“å±•ä½¿ç”¨" class="header-anchor">#</a> 3.æ‹“å±•ä½¿ç”¨</h5> <p>è‡ªå®šä¹‰ç±»å®ç° BeanPostProcessor æ¥å£, å¹¶å°†è¯¥ç±»æ³¨å†Œåˆ° IoC å®¹å™¨ä¸­.</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">NanoBeanPostProcessor</span> <span class="token keyword">implements</span> <span class="token class-name">BeanPostProcessor</span><span class="token punctuation">,</span> <span class="token class-name">PriorityOrdered</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">postProcessBeforeInitialization</span><span class="token punctuation">(</span><span class="token class-name">Object</span> bean<span class="token punctuation">,</span> <span class="token class-name">String</span> beanName<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">BeansException</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;MyBeanPostProcessor#postProcessBeforeInitialization&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>bean <span class="token keyword">instanceof</span> <span class="token class-name">LoginService</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// è‡ªå·±çš„é€»è¾‘</span>
        <span class="token keyword">return</span> bean<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">postProcessAfterInitialization</span><span class="token punctuation">(</span><span class="token class-name">Object</span> bean<span class="token punctuation">,</span> <span class="token class-name">String</span> beanName<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">BeansException</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;NanoBeanPostProcessorç±»çš„postProcessAfterInitializationæ–¹æ³•...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// è‡ªå·±çš„é€»è¾‘</span>
        <span class="token keyword">return</span> bean<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><p>è¿™æ ·åœ¨ Spring åˆ›å»º bean å®ä¾‹æ—¶, æ‰§è¡Œåˆå§‹åŒ–æ–¹æ³•å‰ä¼šè°ƒç”¨è‡ªå®šä¹‰ NanoBeanPostProcessor çš„ postProcessBeforeInitialization() æ–¹æ³•, åœ¨æ‰§è¡Œåˆå§‹åŒ–æ–¹æ³•åä¼šè°ƒç”¨ NanoBeanPostProcessor çš„ postProcessAfterInitialization() æ–¹æ³•, ä»è€Œå¯¹è‡ªå·±å…³æ³¨çš„ bean è¿›è¡Œæ‹“å±•.</p> <h5 id="_4-æ€»ç»“"><a href="#_4-æ€»ç»“" class="header-anchor">#</a> 4.æ€»ç»“</h5> <ul><li>æ•´ä¸ª registerBeanPostProcessors() æ–¹æ³•å›´ç»• <strong>BeanPostProcessor</strong> æ¥å£å±•å¼€, å’Œ invokeBeanFactoryPostProcessors() ä¸åŒçš„æ˜¯, invokeBeanFactoryPostProcessors() æ–¹æ³•ä¼š<strong>ç›´æ¥è°ƒç”¨ BeanFactoryPostProcessor å®ç°ç±»</strong>çš„æ–¹æ³•, è€Œ <strong>registerBeanPostProcessors()</strong>  æ–¹æ³•åªæ˜¯å°† BeanPostProcessor å®ç°ç±»<strong>æ³¨å†Œåˆ° BeanFactory çš„ beanPostProcessors ç¼“å­˜</strong>ä¸­.</li> <li>registerBeanPostProcessors() æ–¹æ³•ä¸ä¼šè°ƒç”¨åå¤„ç†å™¨çš„æ–¹æ³•, è¿™æ˜¯å› ä¸ºå½“å‰è¿˜æœªåˆ° BeanPostProcessor å®ç°ç±»â€œå‡ºåœºçš„æ—¶å€™â€. BeanPostProcessor å®ç°ç±»å…·ä½“çš„ â€œå‡ºåœºæ—¶æœºâ€ æ˜¯åœ¨ finishBeanFactoryInitialization() åˆ›å»º bean å®ä¾‹æ—¶, æ‰§è¡Œåˆå§‹åŒ–æ–¹æ³•å‰å. <strong>postProcessBeforeInitialization()</strong>  æ–¹æ³•åœ¨æ‰§è¡Œåˆå§‹åŒ–æ–¹æ³•å‰è¢«è°ƒç”¨, <strong>postProcessAfterInitialization()</strong>  æ–¹æ³•åœ¨æ‰§è¡Œåˆå§‹åŒ–æ–¹æ³•åè¢«è°ƒç”¨.</li> <li>BeanPostProcessor å®ç°ç±»å’Œ BeanFactoryPostProcessor å®ç°ç±»ä¸€æ ·, ä¹Ÿå¯ä»¥é€šè¿‡å®ç° PriorityOrdered, Ordered æ¥å£æ¥è°ƒæ•´è‡ªå·±çš„<strong>ä¼˜å…ˆçº§</strong>.</li> <li>registerBeanPostProcessors() æ–¹æ³•å’Œ invokeBeanFactoryPostProcessors() ä¸€æ ·ä¹Ÿä¼šè§¦å‘ <strong>bean å®ä¾‹çš„åˆ›å»º</strong>, åˆ›å»º Bean å®ä¾‹æ˜¯ IoC çš„æ ¸å¿ƒå†…å®¹, ä¹‹åä¼šå•ç‹¬è§£æ, ç›®å‰æš‚ä¸æ·±å…¥è§£æ.</li></ul> <h4 id="äº‹ä»¶å¹¿æ’­ä¸æ¶ˆæ¯"><a href="#äº‹ä»¶å¹¿æ’­ä¸æ¶ˆæ¯" class="header-anchor">#</a> äº‹ä»¶å¹¿æ’­ä¸æ¶ˆæ¯</h4> <h5 id="_1-äº‹ä»¶å¤šæ’­å™¨"><a href="#_1-äº‹ä»¶å¤šæ’­å™¨" class="header-anchor">#</a> 1.äº‹ä»¶å¤šæ’­å™¨</h5> <p>è‡ªå®šä¹‰ä¸€ä¸ª NanoApplicationListener å®ç° <strong>ApplicationListener</strong> æ¥å£, å¹¶ä¸”æŠŠè¯¥ç»„ä»¶åŠ å…¥åˆ°å®¹å™¨ä¸­.</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">NanoApplicationListener</span> <span class="token keyword">implements</span> <span class="token class-name">ApplicationListener</span> <span class="token punctuation">{</span>

    <span class="token comment">// æ¥å—åˆ°æ¶ˆæ¯ å›è°ƒè¯¥æ–¹æ³•</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onApplicationEvent</span><span class="token punctuation">(</span><span class="token class-name">ApplicationEvent</span> event<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;NanoApplicationListener received an event: &quot;</span> <span class="token operator">+</span> event<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>è¿™éƒ¨åˆ†åŠŸèƒ½å¯¹åº” refresh() ä¸­çš„äº‹ä»¶å¹¿æ’­å™¨æ“ä½œç›¸å…³æ–¹æ³•.</p> <p>æ•´ä½“æµç¨‹: <strong>initApplicationEventMulticaster()</strong>  å¾€å®¹å™¨ä¸­åˆå§‹åŒ–å¹¶åŠ å…¥ä¸€ä¸ª ApplicationContext çš„äº‹ä»¶å¹¿æ’­å™¨, å¹¿æ’­å™¨å¯ä»¥è¿›è¡Œäº‹ä»¶çš„æ´¾å‘ä¸å¹¿æ’­. æœ‰äº†äº‹ä»¶çš„å¹¿æ’­è€…, è¿™é‡Œè¿˜éœ€è¦æ³¨å†Œäº‹ä»¶çš„ç›‘å¬å™¨, å› æ­¤ refresh() æ–¹æ³•ä¸­çš„ <strong>registerListeners()</strong>  æ–¹æ³•å®ç°å¯¹å„ä¸ªäº‹ä»¶ç›‘å¬å™¨çš„<strong>æ³¨å†Œ</strong>.</p> <h6 id="_1-åˆå§‹åŒ–äº‹ä»¶å¹¿æ’­å™¨"><a href="#_1-åˆå§‹åŒ–äº‹ä»¶å¹¿æ’­å™¨" class="header-anchor">#</a> (1)åˆå§‹åŒ–äº‹ä»¶å¹¿æ’­å™¨</h6> <p>é¦–å…ˆçœ‹çœ‹ <strong>initApplicationEventMulticaster()</strong>  æ–¹æ³•.</p> <blockquote><p>AbstractApplicationContext::initApplicationEventMulticaster()</p></blockquote> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">initApplicationEventMulticaster</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// è·å–BeanFactory</span>
    <span class="token class-name">ConfigurableListableBeanFactory</span> beanFactory <span class="token operator">=</span> <span class="token function">getBeanFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// å·²ç»æœ‰äº†å¹¿æ’­å™¨</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>beanFactory<span class="token punctuation">.</span><span class="token function">containsLocalBean</span><span class="token punctuation">(</span><span class="token constant">APPLICATION_EVENT_MULTICASTER_BEAN_NAME</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>applicationEventMulticaster <span class="token operator">=</span>
            beanFactory<span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span><span class="token constant">APPLICATION_EVENT_MULTICASTER_BEAN_NAME</span><span class="token punctuation">,</span> <span class="token class-name">ApplicationEventMulticaster</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Using ApplicationEventMulticaster [&quot;</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>applicationEventMulticaster <span class="token operator">+</span> <span class="token string">&quot;]&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// æ²¡æœ‰åˆ™åˆå§‹åŒ–ä¸€ä¸ªå¹¿æ’­å™¨</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// çœ‹è¿™é‡Œ: ç”Ÿæˆäº†é»˜è®¤çš„äº‹ä»¶å¹¿æ’­å™¨! </span>
        <span class="token comment">// å¯ä»¥è¿›å»çœ‹çœ‹ multicastEvent() å¹¿æ’­äº‹ä»¶æ–¹æ³•</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>applicationEventMulticaster <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SimpleApplicationEventMulticaster</span><span class="token punctuation">(</span>beanFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// å°†åˆå§‹åŒ–çš„äº‹ä»¶å¹¿æ’­å™¨æ³¨å†Œåˆ°å®¹å™¨ä¸­</span>
        beanFactory<span class="token punctuation">.</span><span class="token function">registerSingleton</span><span class="token punctuation">(</span><span class="token constant">APPLICATION_EVENT_MULTICASTER_BEAN_NAME</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>applicationEventMulticaster<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Unable to locate ApplicationEventMulticaster with name '&quot;</span> <span class="token operator">+</span>
                         <span class="token constant">APPLICATION_EVENT_MULTICASTER_BEAN_NAME</span> <span class="token operator">+</span>
                         <span class="token string">&quot;': using default [&quot;</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>applicationEventMulticaster <span class="token operator">+</span> <span class="token string">&quot;]&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><p>æ‰§è¡Œå®Œå, å®¹å™¨ä¸­å°±æœ‰äº†ä¸€ä¸ªå®ä¾‹åŒ–çš„<strong>äº‹ä»¶å¹¿æ’­å™¨</strong> applicationEventMulticaster.</p> <p>é€šè¿‡ getApplicationEventMulticaster() æ–¹æ³•å³å¯è·å–åˆ°å®¹å™¨ä¸­çš„äº‹ä»¶å¹¿æ’­å™¨, å¦‚ä¸‹.</p> <blockquote><p>AbstractApplicationContext::getApplicationEventMulticaster()</p></blockquote> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">ApplicationEventMulticaster</span> <span class="token function">getApplicationEventMulticaster</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IllegalStateException</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>applicationEventMulticaster <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">&quot;ApplicationEventMulticaster not initialized - &quot;</span> <span class="token operator">+</span>
                                        <span class="token string">&quot;call 'refresh' before multicasting events via the context: &quot;</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>applicationEventMulticaster<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h6 id="_2-æ³¨å†Œäº‹ä»¶ç›‘å¬å™¨"><a href="#_2-æ³¨å†Œäº‹ä»¶ç›‘å¬å™¨" class="header-anchor">#</a> (2)æ³¨å†Œäº‹ä»¶ç›‘å¬å™¨</h6> <p>å¹¿æ’­å™¨æœ‰äº†ä¹‹å, ä¹Ÿå°±æ˜¯æœ‰äº†äº‹ä»¶çš„å‘é€è€…, ä¸‹ä¸€æ­¥å³æ³¨å†Œäº‹ä»¶çš„æ¥æ”¶è€…, ä¹Ÿå°±æ˜¯<strong>äº‹ä»¶ç›‘å¬å™¨</strong>. äº‹ä»¶ç›‘å¬å™¨æ˜¯å®ç°äº† <strong>ApplicationListener</strong> æ¥å£çš„ç±».</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// æ¥æ”¶çš„äº‹ä»¶æ˜¯ApplicationEventçš„å­ç±»</span>
<span class="token annotation punctuation">@FunctionalInterface</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">ApplicationListener</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span> <span class="token keyword">extends</span> <span class="token class-name">ApplicationEvent</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">extends</span> <span class="token class-name">EventListener</span> <span class="token punctuation">{</span>

    <span class="token comment">/** æ¥æ”¶åˆ°æ¶ˆæ¯åçš„å›è°ƒæ–¹æ³• */</span>
    <span class="token keyword">void</span> <span class="token function">onApplicationEvent</span><span class="token punctuation">(</span><span class="token class-name">E</span> event<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>å¯ä»¥çœ‹åˆ°äº‹ä»¶ç›‘å¬å™¨éœ€è¦çš„äº‹ä»¶æ˜¯ <strong>ApplicationEvent</strong> çš„å­ç±».</p> <p>ç»§ç»­çœ‹ refresh() çš„æ³¨å†Œç›‘å¬å™¨çš„é€»è¾‘ registerListeners().</p> <blockquote><p>AbstractApplicationContext::registerListeners()</p></blockquote> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">registerListeners</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// å°†ç¡¬ç¼–ç æ–¹å¼çš„äº‹ä»¶ç›‘å¬å™¨æ³¨å†Œåˆ°äº‹ä»¶å¹¿æ’­å™¨ä¸­</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">ApplicationListener</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> listener <span class="token operator">:</span> <span class="token function">getApplicationListeners</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">getApplicationEventMulticaster</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addApplicationListener</span><span class="token punctuation">(</span>listener<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// è·å–é…ç½®æ–‡ä»¶æ³¨å†Œçš„ç›‘å¬å™¨(ä¹Ÿå°±æ˜¯è‡ªå·±å®ç°äº†ApplicationListeneræ¥å£çš„ç›‘å¬å™¨)å¹¶æ³¨å†Œåˆ°äº‹ä»¶å¹¿æ’­å™¨ä¸­</span>
    <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> listenerBeanNames <span class="token operator">=</span> <span class="token function">getBeanNamesForType</span><span class="token punctuation">(</span><span class="token class-name">ApplicationListener</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> listenerBeanName <span class="token operator">:</span> listenerBeanNames<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">getApplicationEventMulticaster</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addApplicationListenerBean</span><span class="token punctuation">(</span>listenerBeanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// çœ‹çœ‹æœ‰æ²¡æœ‰æ—©æœŸçš„äº‹ä»¶ æœ‰çš„è¯å°±è¿›è¡Œå¹¿æ’­</span>
    <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ApplicationEvent</span><span class="token punctuation">&gt;</span></span> earlyEventsToProcess <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>earlyApplicationEvents<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>earlyApplicationEvents <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>earlyEventsToProcess <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">ApplicationEvent</span> earlyEvent <span class="token operator">:</span> earlyEventsToProcess<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// è§‚å¯Ÿè€…æ¨¡å¼é€šçŸ¥ç›‘å¬å™¨</span>
            <span class="token function">getApplicationEventMulticaster</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">multicastEvent</span><span class="token punctuation">(</span>earlyEvent<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><p>è¿™é‡Œé¦–å…ˆè·å–äº†ç³»ç»Ÿä¸­<strong>ç¡¬ç¼–ç </strong>å®šä¹‰å¥½çš„äº‹ä»¶ç›‘å¬å™¨, è·å–åˆ°äº‹ä»¶å¹¿æ’­å™¨åæ³¨å†Œåˆ°å¹¿æ’­å™¨ä¸­. ç„¶åè·å–äº†é…ç½®æ–‡ä»¶æ³¨å†Œçš„ç›‘å¬å™¨(ä¹Ÿå°±æ˜¯è‡ªå·±å®ç°äº† ApplicationListener æ¥å£çš„ç›‘å¬å™¨)å¹¶æ³¨å†Œåˆ°äº‹ä»¶å¹¿æ’­å™¨ä¸­. è¿™é‡Œå°±å®ç°äº†äº‹ä»¶ç›‘å¬å™¨çš„æ³¨å†Œ. è¿™é‡Œç”¨åˆ°çš„å°±æ˜¯<strong>è§‚å¯Ÿè€…æ¨¡å¼</strong>.</p> <p>æœ€åä¸€æ­¥, çœ‹çœ‹æœ‰æ²¡æœ‰<strong>æ—©æœŸå‘å¸ƒçš„äº‹ä»¶</strong>, æœ‰çš„è¯å°±æŒ¨ç€è¿›è¡Œå¹¿æ’­(å¤šæ’­). ä»€ä¹ˆæ˜¯<strong>æ—©æœŸå‘å¸ƒçš„äº‹ä»¶</strong>? æŒ‡çš„æ˜¯åœ¨<strong>äº‹ä»¶ç›‘å¬å™¨æ³¨å†Œä¹‹å‰</strong>å‘å¸ƒçš„å¹¿æ’­äº‹ä»¶. Spring å¯åŠ¨è¿‡ç¨‹æ²¡æœ‰è¿™ç§äº‹ä»¶, ä½†æ˜¯ Spring Boot å¯åŠ¨æ—¶, å¯èƒ½ä¼šå»è°ƒç”¨è¦†å†™çš„ <strong>onRefresh() æ–¹æ³•</strong>è¿›è¡Œ <strong>Tomcat çš„åŠ è½½</strong>, è¿™é‡Œå¯èƒ½ä¼šè¿›è¡Œäº‹ä»¶çš„å‘å¸ƒ. ç„¶è€Œæ­¤æ—¶å®¹å™¨ä¸­ä»…æœ‰äº‹ä»¶å¹¿æ’­å™¨è€Œæ²¡æœ‰äº‹ä»¶ç›‘å¬å™¨, æ‰€ä»¥ä¼šæŠŠè¿™äº›æ—©æœŸçš„äº‹ä»¶<strong>å­˜å‚¨</strong>åˆ°äº‹ä»¶å¹¿æ’­å™¨çš„ earlyApplicationEvents ä¸­, ç­‰åˆ°äº‹ä»¶ç›‘å¬å™¨æ³¨å†Œå®Œæˆåæ‰è¿›è¡Œé€ä¸€çš„å¹¿æ’­.</p> <p>çœ‹çœ‹å¹¿æ’­äº‹ä»¶çš„æ–¹æ³• multicastEvent().</p> <blockquote><p>SimpleApplicationEventMulticaster::multicastEvent()</p></blockquote> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">multicastEvent</span><span class="token punctuation">(</span><span class="token class-name">ApplicationEvent</span> event<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">multicastEvent</span><span class="token punctuation">(</span>event<span class="token punctuation">,</span> <span class="token function">resolveDefaultEventType</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>è¿›è¡Œäº‹ä»¶å¹¿æ’­.</p> <blockquote><p>SimpleApplicationEventMulticaster::multicastEvent()</p></blockquote> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">multicastEvent</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">ApplicationEvent</span> event<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">ResolvableType</span> eventType<span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token class-name">ResolvableType</span> type <span class="token operator">=</span> <span class="token punctuation">(</span>eventType <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> eventType <span class="token operator">:</span> <span class="token function">resolveDefaultEventType</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// éå†æ‰€æœ‰äº‹ä»¶ç›‘å¬å™¨</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">ApplicationListener</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> listener <span class="token operator">:</span> <span class="token function">getApplicationListeners</span><span class="token punctuation">(</span>event<span class="token punctuation">,</span> type<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// æ”¯æŒå¼‚æ­¥å‘é€äº‹ä»¶</span>
        <span class="token class-name">Executor</span> executor <span class="token operator">=</span> <span class="token function">getTaskExecutor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>executor <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            executor<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token function">invokeListener</span><span class="token punctuation">(</span>listener<span class="token punctuation">,</span> event<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// åŒæ­¥å‘é€äº‹ä»¶</span>
        <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment">// å›è°ƒListenerçš„onApplicationEventæ–¹æ³•, å°†äº‹ä»¶å‘é€ç»™å„ä¸ªäº‹ä»¶ç›‘å¬å™¨</span>
            <span class="token function">invokeListener</span><span class="token punctuation">(</span>listener<span class="token punctuation">,</span> event<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p>è¿™é‡Œé€šè¿‡äº‹ä»¶çš„ç±»å‹è·å–å·²ç»æ³¨å†Œäº†, ä¸”ç›‘å¬äº†è¿™ä¸ªç±»å‹æ¶ˆæ¯çš„äº‹ä»¶ç›‘å¬å™¨, ç„¶åé€ä¸€è¿›è¡Œæ¶ˆæ¯å‘é€. å¦‚æœæ”¯æŒå¼‚æ­¥å‘é€åˆ™é‡‡ç”¨å¼‚æ­¥æ–¹å¼, å¦åˆ™è¿›è¡ŒåŒæ­¥å‘é€æ¶ˆæ¯. è¿™é‡Œå°±è§¦å‘äº†å„ä¸ªç›‘å¬å™¨å†… onApplicationEvent() æ–¹æ³•çš„å›è°ƒ. å¦‚ä¸‹æ‰€ç¤º.</p> <blockquote><p>SimpleApplicationEventMulticaster::invokeListener()</p></blockquote> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">invokeListener</span><span class="token punctuation">(</span><span class="token class-name">ApplicationListener</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> listener<span class="token punctuation">,</span> <span class="token class-name">ApplicationEvent</span> event<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">ErrorHandler</span> errorHandler <span class="token operator">=</span> <span class="token function">getErrorHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>errorHandler <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token function">doInvokeListener</span><span class="token punctuation">(</span>listener<span class="token punctuation">,</span> event<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            errorHandler<span class="token punctuation">.</span><span class="token function">handleError</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token function">doInvokeListener</span><span class="token punctuation">(</span>listener<span class="token punctuation">,</span> event<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><blockquote><p>SimpleApplicationEventMulticaster::doInvokeListener()</p></blockquote> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">doInvokeListener</span><span class="token punctuation">(</span><span class="token class-name">ApplicationListener</span> listener<span class="token punctuation">,</span> <span class="token class-name">ApplicationEvent</span> event<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment">// å›è°ƒListenerçš„onApplicationEventæ–¹æ³•!!!</span>
        listener<span class="token punctuation">.</span><span class="token function">onApplicationEvent</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ClassCastException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> msg <span class="token operator">=</span> ex<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>msg <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> <span class="token function">matchesClassCastMessage</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> event<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// Possibly a lambda-defined listener which we could not resolve the generic event type for</span>
            <span class="token comment">// -&gt; let's suppress the exception and just log a debug message.</span>
            <span class="token class-name">Log</span> logger <span class="token operator">=</span> <span class="token class-name">LogFactory</span><span class="token punctuation">.</span><span class="token function">getLog</span><span class="token punctuation">(</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Non-matching event type for listener: &quot;</span> <span class="token operator">+</span> listener<span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> ex<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><h4 id="finishbeanfactoryinitialization-beanfactory"><a href="#finishbeanfactoryinitialization-beanfactory" class="header-anchor">#</a> finishBeanFactoryInitialization(beanFactory)</h4> <h5 id="_1-æ¦‚è¿°-4"><a href="#_1-æ¦‚è¿°-4" class="header-anchor">#</a> 1.æ¦‚è¿°</h5> <p>finishBeanFactoryInitialization() æ˜¯è¿™å››ä¸ªæ–¹æ³•ä¸­æœ€å¤æ‚ä¹Ÿæ˜¯æœ€é‡è¦çš„, æ˜¯æ•´ä¸ª Spring IoC æ ¸å¿ƒä¸­çš„<strong>æ ¸å¿ƒ</strong>.</p> <p>è¯¥æ–¹æ³•ä¼š<strong>å®ä¾‹åŒ–æ‰€æœ‰å‰©ä½™çš„éæ‡’åŠ è½½å•ä¾‹ bean</strong>. é™¤äº†ä¸€äº›<strong>å†…éƒ¨çš„ bean</strong>, å®ç°äº† BeanFactoryPostProcessor æ¥å£çš„ bean, å®ç°äº† BeanPostProcessor æ¥å£çš„ bean, <strong>å…¶ä»–çš„éæ‡’åŠ è½½å•ä¾‹ bean éƒ½ä¼šåœ¨è¿™ä¸ªæ–¹æ³•ä¸­è¢«å®ä¾‹åŒ–, å¹¶ä¸” BeanPostProcessor å®ç°ç±»æ–¹æ³•çš„è§¦å‘ä¹Ÿæ˜¯åœ¨è¿™ä¸ªæ–¹æ³•ä¸­</strong>.</p> <p>åœ¨ finishBeanFactoryInitialization æ–¹æ³•ä¸»è¦åšäº†ä»¥ä¸‹æ“ä½œ:</p> <ul><li>å°†ä¹‹å‰è§£æçš„ BeanDefinition è¿›ä¸€æ­¥å¤„ç†, å°†æœ‰çˆ¶ BeanDefinition çš„è¿›è¡Œåˆå¹¶, è·å¾— MergedBeanDefinition.</li> <li>å°è¯•<strong>ä»ç¼“å­˜è·å– bean å®ä¾‹</strong>.</li> <li>å¤„ç†ç‰¹æ®Šçš„ bean â€”â€” FactoryBean çš„åˆ›å»º.</li> <li><strong>åˆ›å»º bean å®ä¾‹</strong>.</li> <li><strong>å¾ªç¯å¼•ç”¨çš„å¤„ç†</strong>.</li> <li><strong>bean å®ä¾‹å±æ€§å¡«å…….</strong></li> <li><strong>bean å®ä¾‹çš„åˆå§‹åŒ–.</strong></li> <li>BeanPostProcessor çš„å„ç§<strong>æ‰©å±•åº”ç”¨</strong>.</li></ul> <h5 id="_2-æºç åˆ†æ-2"><a href="#_2-æºç åˆ†æ-2" class="header-anchor">#</a> 2.æºç åˆ†æ</h5> <p>çœ‹çœ‹ finishBeanFactoryInitialization() æ–¹æ³•çš„æºä»£ç . æœ¬æ–¹æ³•ä¼šå®ä¾‹åŒ–æ‰€æœ‰ä¹‹å‰æ²¡æœ‰å®ä¾‹åŒ–çš„å•ä¾‹ bean(è®¾ç½®äº†æ‡’åŠ è½½çš„é™¤å¤–).</p> <blockquote><p>AbstractApplicationContext::finishBeanFactoryInitialization()</p></blockquote> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">finishBeanFactoryInitialization</span><span class="token punctuation">(</span><span class="token class-name">ConfigurableListableBeanFactory</span> beanFactory<span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token comment">// 1.åˆå§‹åŒ–æ­¤ä¸Šä¸‹æ–‡çš„è½¬æ¢æœåŠ¡,å³é¦–å…ˆåˆå§‹åŒ–åä¸ºconversionServiceçš„Bean</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>beanFactory<span class="token punctuation">.</span><span class="token function">containsBean</span><span class="token punctuation">(</span><span class="token constant">CONVERSION_SERVICE_BEAN_NAME</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
        beanFactory<span class="token punctuation">.</span><span class="token function">isTypeMatch</span><span class="token punctuation">(</span><span class="token constant">CONVERSION_SERVICE_BEAN_NAME</span><span class="token punctuation">,</span> <span class="token class-name">ConversionService</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        beanFactory<span class="token punctuation">.</span><span class="token function">setConversionService</span><span class="token punctuation">(</span>
            beanFactory<span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span><span class="token constant">CONVERSION_SERVICE_BEAN_NAME</span><span class="token punctuation">,</span> <span class="token class-name">ConversionService</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 2.å¦‚æœbeanFactoryä¹‹å‰æ²¡æœ‰æ³¨å†ŒåµŒå…¥å€¼è§£æå™¨, åˆ™æ³¨å†Œé»˜è®¤çš„åµŒå…¥å€¼è§£æå™¨: ä¸»è¦ç”¨äºæ³¨è§£å±æ€§å€¼çš„è§£æ</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>beanFactory<span class="token punctuation">.</span><span class="token function">hasEmbeddedValueResolver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        beanFactory<span class="token punctuation">.</span><span class="token function">addEmbeddedValueResolver</span><span class="token punctuation">(</span>strVal <span class="token operator">-&gt;</span> <span class="token function">getEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">resolvePlaceholders</span><span class="token punctuation">(</span>strVal<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 3.åˆå§‹åŒ–LoadTimeWeaverAware Beanå®ä¾‹å¯¹è±¡</span>
    <span class="token comment">// è¿™æ˜¯AspectJç›¸å…³çš„å†…å®¹, æ”¾å¿ƒè·³è¿‡</span>
    <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> weaverAwareNames <span class="token operator">=</span> beanFactory<span class="token punctuation">.</span><span class="token function">getBeanNamesForType</span><span class="token punctuation">(</span><span class="token class-name">LoadTimeWeaverAware</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> weaverAwareName <span class="token operator">:</span> weaverAwareNames<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">getBean</span><span class="token punctuation">(</span>weaverAwareName<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Stop using the temporary ClassLoader for type matching.</span>
    beanFactory<span class="token punctuation">.</span><span class="token function">setTempClassLoader</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 4.å†»ç»“æ‰€æœ‰beanDefinition, æ³¨å†Œçš„beanå®šä¹‰ä¸ä¼šè¢«ä¿®æ”¹æˆ–è¿›ä¸€æ­¥åå¤„ç†, é©¬ä¸Šè¦å®ä¾‹åŒ–beanäº†</span>
    <span class="token comment">// è‚¯å®šä¸å¸Œæœ›è¿™ä¸ªæ—¶å€™è¿˜å‡ºç° bean å®šä¹‰è§£æ, åŠ è½½, æ³¨å†Œ. </span>
    beanFactory<span class="token punctuation">.</span><span class="token function">freezeConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 5.é‡ç‚¹: å®ä¾‹åŒ–å…¨éƒ¨å‰©ä¸‹çš„singletons(lazy-initçš„é™¤å¤–)!!!!</span>
    beanFactory<span class="token punctuation">.</span><span class="token function">preInstantiateSingletons</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br></div></div><p>è¿™ä¸ªæ–¹æ³•æœ€é‡è¦çš„å°±æ˜¯æœ€åä¸€å¥è¯. çœ‹çœ‹è¿™ä¸ª <strong>preInstantiateSingletons() æ–¹æ³•</strong>.</p> <blockquote><p>DefaultListableBeanFactory::preInstantiateSingletons()</p></blockquote> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">preInstantiateSingletons</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">BeansException</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isInfoEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;Pre-instantiating singletons in: &quot;</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 1.åˆ›å»ºbeanDefinitionNamesçš„å‰¯æœ¬beanNamesç”¨äºåç»­çš„éå†, ä»¥å…è®¸initç­‰æ–¹æ³•æ³¨å†Œæ–°çš„beanå®šä¹‰</span>
    <span class="token comment">// this.beanDefinitionNames ä¿å­˜äº†æ‰€æœ‰çš„ beanNames</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> beanNames <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>beanDefinitionNames<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 2.å¯¹æ¯ä¸€ä¸ªélazy-initçš„singleton beanè¿›è¡Œåˆå§‹åŒ–</span>
    <span class="token comment">// ä¸‹é¢è¿™ä¸ªå¾ªç¯, è§¦å‘æ‰€æœ‰çš„éæ‡’åŠ è½½çš„singleton beansçš„åˆå§‹åŒ–æ“ä½œ</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> beanName <span class="token operator">:</span> beanNames<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token comment">// 3.è·å–beanNameå¯¹åº”çš„MergedBeanDefinition</span>
        <span class="token class-name">RootBeanDefinition</span> bd <span class="token operator">=</span> <span class="token function">getMergedLocalBeanDefinition</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 4.å¯¹BeanDefinitionè¿›è¡Œåˆ¤æ–­, ä»…å¯¹ä¸æ˜¯æŠ½è±¡ç±», singletonä¸”éæ‡’åŠ è½½çš„å®ä¾‹åŒ–</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>bd<span class="token punctuation">.</span><span class="token function">isAbstract</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> bd<span class="token punctuation">.</span><span class="token function">isSingleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>bd<span class="token punctuation">.</span><span class="token function">isLazyInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

            <span class="token comment">// 5.åˆ¤æ–­beanNameå¯¹åº”çš„beanæ˜¯å¦ä¸ºFactoryBean</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isFactoryBean</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// 5.1 é€šè¿‡beanNameè·å–FactoryBeanå®ä¾‹</span>
                <span class="token comment">// æ³¨æ„: é€šè¿‡getBean(&amp;beanName)æ‹¿åˆ°çš„æ˜¯FactoryBeanæœ¬èº«; é€šè¿‡getBean(beanName)æ‹¿åˆ°çš„æ˜¯FactoryBeanåˆ›å»ºçš„Beanå®ä¾‹</span>
                <span class="token class-name">Object</span> bean <span class="token operator">=</span> <span class="token function">getBean</span><span class="token punctuation">(</span><span class="token constant">FACTORY_BEAN_PREFIX</span> <span class="token operator">+</span> beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span>bean <span class="token keyword">instanceof</span> <span class="token class-name">FactoryBean</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token class-name">FactoryBean</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> factory <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">FactoryBean</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span> bean<span class="token punctuation">;</span>
                    <span class="token comment">// 5.2 åˆ¤æ–­è¿™ä¸ªFactoryBeanæ˜¯å¦å¸Œæœ›æ€¥åˆ‡çš„åˆå§‹åŒ–</span>
                    <span class="token comment">// åˆ¤æ–­å½“å‰FactoryBeanæ˜¯å¦æ˜¯SmartFactoryBeançš„å®ç°, æ­¤å¤„å¿½ç•¥, ç›´æ¥è·³è¿‡</span>
                    <span class="token keyword">boolean</span> isEagerInit<span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">getSecurityManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> factory <span class="token keyword">instanceof</span> <span class="token class-name">SmartFactoryBean</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        isEagerInit <span class="token operator">=</span> <span class="token class-name">AccessController</span><span class="token punctuation">.</span><span class="token function">doPrivileged</span><span class="token punctuation">(</span>
                            <span class="token punctuation">(</span><span class="token class-name">PrivilegedAction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Boolean</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">SmartFactoryBean</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span> factory<span class="token punctuation">)</span><span class="token operator">::</span><span class="token function">isEagerInit</span><span class="token punctuation">,</span>
                            <span class="token function">getAccessControlContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                        isEagerInit <span class="token operator">=</span> <span class="token punctuation">(</span>factory <span class="token keyword">instanceof</span> <span class="token class-name">SmartFactoryBean</span> <span class="token operator">&amp;&amp;</span>
                                       <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">SmartFactoryBean</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span> factory<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isEagerInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment">// 5.3 å¦‚æœå¸Œæœ›æ€¥åˆ‡çš„åˆå§‹åŒ–, åˆ™é€šè¿‡beanNameè·å–beanå®ä¾‹</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>isEagerInit<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token function">getBean</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>

                <span class="token comment">// 6.ä¸æ˜¯FactoryBean, ä»…ä»…æ˜¯æ™®é€šçš„ Bean, è°ƒç”¨ getBean(beanName) æ–¹æ³•å³å¯è¿›è¡Œåˆå§‹åŒ–</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token function">getBean</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 7.åˆ°è¿™é‡Œè¯´æ˜æ‰€æœ‰çš„éæ‡’åŠ è½½çš„å•ä¾‹ beans å·²ç»å®Œæˆäº†åˆå§‹åŒ–</span>
    <span class="token comment">// å¦‚æœå®šä¹‰çš„ bean æ˜¯å®ç°äº† SmartInitializingSingleton æ¥å£çš„, é‚£ä¹ˆåœ¨è¿™é‡Œè¿›è¡Œå›è°ƒ(å¿½ç•¥)</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> beanName <span class="token operator">:</span> beanNames<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Object</span> singletonInstance <span class="token operator">=</span> <span class="token function">getSingleton</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>singletonInstance <span class="token keyword">instanceof</span> <span class="token class-name">SmartInitializingSingleton</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">SmartInitializingSingleton</span> smartSingleton <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">SmartInitializingSingleton</span><span class="token punctuation">)</span> singletonInstance<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">getSecurityManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">AccessController</span><span class="token punctuation">.</span><span class="token function">doPrivileged</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">PrivilegedAction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
                    smartSingleton<span class="token punctuation">.</span><span class="token function">afterSingletonsInstantiated</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token function">getAccessControlContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                smartSingleton<span class="token punctuation">.</span><span class="token function">afterSingletonsInstantiated</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br></div></div><p>ä¸‹é¢é€ä¸€åˆ†æè¿™é‡Œçš„å‡ ä¸ªé‡è¦æ–¹æ³•.</p> <h6 id="_1-getmergedlocalbeandefinition"><a href="#_1-getmergedlocalbeandefinition" class="header-anchor">#</a> (1)getMergedLocalBeanDefinition()</h6> <p>ä¸‹é¢åˆ†ææ•´ä½“æ–¹æ³•çš„å¦‚ä¸‹ç‰‡æ®µ:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// 3.è·å–beanNameå¯¹åº”çš„MergedBeanDefinition</span>
<span class="token class-name">RootBeanDefinition</span> bd <span class="token operator">=</span> <span class="token function">getMergedLocalBeanDefinition</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>æºä»£ç å¦‚ä¸‹:</p> <blockquote><p>AbstractBeanFactory::getMergedLocalBeanDefinition()</p></blockquote> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">protected</span> <span class="token class-name">RootBeanDefinition</span> <span class="token function">getMergedLocalBeanDefinition</span><span class="token punctuation">(</span><span class="token class-name">String</span> beanName<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">BeansException</span> <span class="token punctuation">{</span>
    <span class="token comment">// 1.æ£€æŸ¥beanNameå¯¹åº”çš„MergedBeanDefinitionæ˜¯å¦å­˜åœ¨äºç¼“å­˜ä¸­</span>
    <span class="token class-name">RootBeanDefinition</span> mbd <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mergedBeanDefinitions<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 2.å¦‚æœå­˜åœ¨äºç¼“å­˜ä¸­åˆ™ç›´æ¥è¿”å›</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>mbd <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> mbd<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 3.å¦‚æœä¸å­˜åœ¨äºç¼“å­˜ä¸­</span>
    <span class="token comment">// 3.1 getBeanDefinition(beanName): è·å–beanNameå¯¹åº”çš„BeanDefinition, ä»beanDefinitionMapç¼“å­˜ä¸­è·å–</span>
    <span class="token comment">// 3.2 getMergedBeanDefinition: æ ¹æ®beanNameå’Œå¯¹åº”çš„BeanDefinition, è·å–MergedBeanDefinition</span>
    <span class="token keyword">return</span> <span class="token function">getMergedBeanDefinition</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> <span class="token function">getBeanDefinition</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>è¿™é‡Œæ³¨é‡Š 3 å¾ˆç»•, ä¸»è¦çœ‹çœ‹ getMergedBeanDefinition() æ–¹æ³•.</p> <blockquote><p>AbstractBeanFactory::getMergedBeanDefinition()</p></blockquote> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">protected</span> <span class="token class-name">RootBeanDefinition</span> <span class="token function">getMergedBeanDefinition</span><span class="token punctuation">(</span><span class="token class-name">String</span> beanName<span class="token punctuation">,</span> <span class="token class-name">BeanDefinition</span> bd<span class="token punctuation">)</span>
    <span class="token keyword">throws</span> <span class="token class-name">BeanDefinitionStoreException</span> <span class="token punctuation">{</span>
    <span class="token comment">// è¿›å»</span>
    <span class="token keyword">return</span> <span class="token function">getMergedBeanDefinition</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> bd<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><blockquote><p>AbstractBeanFactory::getMergedBeanDefinition()</p></blockquote> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">protected</span> <span class="token class-name">RootBeanDefinition</span> <span class="token function">getMergedBeanDefinition</span><span class="token punctuation">(</span>
    <span class="token class-name">String</span> beanName<span class="token punctuation">,</span> <span class="token class-name">BeanDefinition</span> bd<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">BeanDefinition</span> containingBd<span class="token punctuation">)</span>
    <span class="token keyword">throws</span> <span class="token class-name">BeanDefinitionStoreException</span> <span class="token punctuation">{</span>

    <span class="token comment">// 1.åŠ é”å†è¿›è¡Œæ“ä½œ</span>
    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>mergedBeanDefinitions<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token comment">// ç”¨äºå­˜å‚¨bdçš„MergedBeanDefinition, ä¹Ÿæ˜¯æœ¬æ–¹æ³•çš„è¿”å›å€¼</span>
        <span class="token class-name">RootBeanDefinition</span> mbd <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

        <span class="token comment">// 2.æ£€æŸ¥beanNameå¯¹åº”çš„MergedBeanDefinitionæ˜¯å¦å­˜åœ¨äºç¼“å­˜ä¸­</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>containingBd <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            mbd <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mergedBeanDefinitions<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 3.å¦‚æœbeanNameå¯¹åº”çš„MergedBeanDefinitionä¸å­˜åœ¨äºç¼“å­˜ä¸­</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mbd <span class="token generics"><span class="token punctuation">&lt;</span>mark<span class="token punctuation">&gt;</span></span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 4.å¦‚æœbdçš„parentNameä¸ºç©º, ä»£è¡¨bdæ²¡æœ‰çˆ¶å®šä¹‰, æ— éœ€ä¸çˆ¶å®šä¹‰è¿›è¡Œåˆå¹¶æ“ä½œ, </span>
            <span class="token comment">// ä¹Ÿå°±æ˜¯bdçš„MergedBeanDefinitionå°±æ˜¯bdæœ¬èº«(å¯èƒ½éœ€è¦è½¬æˆRootBeanDefinition)</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>bd<span class="token punctuation">.</span><span class="token function">getParentName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span><span class="token operator">/</span>mark<span class="token operator">&gt;</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

                <span class="token comment">// 4.1 å¦‚æœbdçš„ç±»å‹ä¸ºRootBeanDefinition, åˆ™bdçš„MergedBeanDefinitionå°±æ˜¯bdæœ¬èº«, åˆ™ç›´æ¥å…‹éš†ä¸€ä¸ªå‰¯æœ¬</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>bd <span class="token keyword">instanceof</span> <span class="token class-name">RootBeanDefinition</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    mbd <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">RootBeanDefinition</span><span class="token punctuation">)</span> bd<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">cloneBeanDefinition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment">// 4.2 å¦åˆ™, å°†bdä½œä¸ºå‚æ•°, æ„å»ºä¸€ä¸ªRootBeanDefinition. </span>
                <span class="token comment">// æ­£å¸¸ä½¿ç”¨ä¸‹, BeanDefinitionåœ¨è¢«åŠ è½½åæ˜¯GenericBeanDefinitionæˆ–ScannedGenericBeanDefinition</span>
                <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    mbd <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RootBeanDefinition</span><span class="token punctuation">(</span>bd<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment">// 5.å¦åˆ™, bdå­˜åœ¨çˆ¶å®šä¹‰, éœ€è¦ä¸çˆ¶å®šä¹‰åˆå¹¶</span>
                <span class="token class-name">BeanDefinition</span> pbd<span class="token punctuation">;</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token comment">// 5.1 è·å–çˆ¶å®šä¹‰çš„beanName</span>
                    <span class="token class-name">String</span> parentBeanName <span class="token operator">=</span> <span class="token function">transformedBeanName</span><span class="token punctuation">(</span>bd<span class="token punctuation">.</span><span class="token function">getParentName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">// 5.2 å¦‚æœçˆ¶å®šä¹‰çš„beanNameä¸è¯¥beançš„beanNameä¸åŒ</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>beanName<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>parentBeanName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment">// 5.3 è·å–çˆ¶å®šä¹‰çš„MergedBeanDefinition(å› ä¸ºçˆ¶å®šä¹‰ä¹Ÿå¯èƒ½æœ‰çˆ¶å®šä¹‰, ä¹Ÿå°±æ˜¯bdçš„çˆ·çˆ·å®šä¹‰...)</span>
                        pbd <span class="token operator">=</span> <span class="token function">getMergedBeanDefinition</span><span class="token punctuation">(</span>parentBeanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment">// 5.4 å¦‚æœçˆ¶å®šä¹‰çš„beanNameä¸bdçš„beanNameç›¸åŒ, åˆ™æ‹¿åˆ°çˆ¶BeanFactory, </span>
                    <span class="token comment">// åªæœ‰åœ¨å­˜åœ¨çˆ¶BeanFactoryçš„æƒ…å†µä¸‹, æ‰å…è®¸çˆ¶å®šä¹‰beanNameä¸è‡ªå·±ç›¸åŒ, å¦åˆ™å°±æ˜¯å°†è‡ªå·±è®¾ç½®ä¸ºçˆ¶å®šä¹‰</span>
                    <span class="token keyword">else</span> <span class="token punctuation">{</span>
                        <span class="token class-name">BeanFactory</span> parent <span class="token operator">=</span> <span class="token function">getParentBeanFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token comment">// 5.5 å¦‚æœçˆ¶BeanFactoryæ˜¯ConfigurableBeanFactory, åˆ™é€šè¿‡çˆ¶BeanFactoryè·å–çˆ¶å®šä¹‰çš„MergedBeanDefinition</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>parent <span class="token keyword">instanceof</span> <span class="token class-name">ConfigurableBeanFactory</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            pbd <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">ConfigurableBeanFactory</span><span class="token punctuation">)</span> parent<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMergedBeanDefinition</span><span class="token punctuation">(</span>parentBeanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NoSuchBeanDefinitionException</span><span class="token punctuation">(</span>parentBeanName<span class="token punctuation">,</span>
                                                                    <span class="token string">&quot;Parent name '&quot;</span> <span class="token operator">+</span> parentBeanName <span class="token operator">+</span> <span class="token string">&quot;' is equal to bean name '&quot;</span> <span class="token operator">+</span> beanName <span class="token operator">+</span>
                                                                    <span class="token string">&quot;': cannot be resolved without a ConfigurableBeanFactory parent&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">NoSuchBeanDefinitionException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BeanDefinitionStoreException</span><span class="token punctuation">(</span>bd<span class="token punctuation">.</span><span class="token function">getResourceDescription</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> beanName<span class="token punctuation">,</span>
                                                           <span class="token string">&quot;Could not resolve parent bean definition '&quot;</span> <span class="token operator">+</span> bd<span class="token punctuation">.</span><span class="token function">getParentName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;'&quot;</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment">// 5.7 ä½¿ç”¨çˆ¶å®šä¹‰pbdæ„å»ºä¸€ä¸ªæ–°çš„RootBeanDefinitionå¯¹è±¡(æ·±æ‹·è´)</span>
                mbd <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RootBeanDefinition</span><span class="token punctuation">(</span>pbd<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 5.8 ä½¿ç”¨bdè¦†ç›–çˆ¶å®šä¹‰</span>
                mbd<span class="token punctuation">.</span><span class="token function">overrideFrom</span><span class="token punctuation">(</span>bd<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment">// 6.å¦‚æœæ²¡æœ‰é…ç½®scope, åˆ™è®¾ç½®æˆé»˜è®¤çš„singleton</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">hasLength</span><span class="token punctuation">(</span>mbd<span class="token punctuation">.</span><span class="token function">getScope</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                mbd<span class="token punctuation">.</span><span class="token function">setScope</span><span class="token punctuation">(</span><span class="token constant">SCOPE_SINGLETON</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment">// 7.å¦‚æœcontainingBdä¸ä¸ºç©º &amp;&amp; containingBdä¸ä¸ºsingleton &amp;&amp; mbdä¸ºsingleton, </span>
            <span class="token comment">// åˆ™å°†mdbçš„scopeè®¾ç½®ä¸ºcontainingBdçš„scope</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>containingBd <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>containingBd<span class="token punctuation">.</span><span class="token function">isSingleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> mbd<span class="token punctuation">.</span><span class="token function">isSingleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                mbd<span class="token punctuation">.</span><span class="token function">setScope</span><span class="token punctuation">(</span>containingBd<span class="token punctuation">.</span><span class="token function">getScope</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment">// 8.å°†beanNameä¸mbdæ”¾åˆ°mergedBeanDefinitionsç¼“å­˜, ä»¥ä¾¿ä¹‹åå¯ä»¥ç›´æ¥ä½¿ç”¨</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>containingBd <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isCacheBeanMetadata</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>mergedBeanDefinitions<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> mbd<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> mbd<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br></div></div><p>è¿™ä¸ªæ–¹æ³•ä¹Ÿååˆ†æ“è›‹, äº‘é‡Œé›¾é‡Œçš„.</p> <p><strong>MergedBeanDefinition</strong> ä¸»è¦æ˜¯ç”¨æ¥è¡¨ç¤º &quot;åˆå¹¶çš„ bean å®šä¹‰&quot;, ä¹‹æ‰€ä»¥ç§°ä¹‹ä¸º &quot;åˆå¹¶çš„&quot;, æ˜¯å› ä¸ºå­˜åœ¨ &quot;å­å®šä¹‰&quot; å’Œ &quot;çˆ¶å®šä¹‰&quot; çš„æƒ…å†µ. å¯¹äºä¸€ä¸ª bean å®šä¹‰æ¥è¯´, å¯èƒ½å­˜åœ¨ä»¥ä¸‹å‡ ç§æƒ…å†µ:</p> <ul><li>è¯¥ BeanDefinition å­˜åœ¨ &quot;çˆ¶å®šä¹‰&quot;: é¦–å…ˆä½¿ç”¨ &quot;çˆ¶å®šä¹‰&quot; çš„å‚æ•°æ„å»ºä¸€ä¸ª RootBeanDefinition, ç„¶åå†ä½¿ç”¨è¯¥ BeanDefinition çš„å‚æ•°æ¥è¿›è¡Œè¦†ç›–.</li> <li>è¯¥ BeanDefinition ä¸å­˜åœ¨ &quot;çˆ¶å®šä¹‰&quot;, å¹¶ä¸”è¯¥ BeanDefinition çš„ç±»å‹æ˜¯ RootBeanDefinition: ç›´æ¥è¿”å›è¯¥ RootBeanDefinition çš„ä¸€ä¸ªå…‹éš†.</li> <li>è¯¥ BeanDefinition ä¸å­˜åœ¨ &quot;çˆ¶å®šä¹‰&quot;, ä½†æ˜¯è¯¥ BeanDefinition çš„ç±»å‹ä¸æ˜¯ RootBeanDefinition: ä½¿ç”¨è¯¥ BeanDefinition çš„å‚æ•°æ„å»ºä¸€ä¸ª RootBeanDefinition.</li></ul> <p>ä¹‹æ‰€ä»¥åŒºåˆ†å‡º 2 å’Œ 3, æ˜¯å› ä¸ºé€šå¸¸ BeanDefinition åœ¨ä¹‹å‰åŠ è½½åˆ° BeanFactory ä¸­çš„æ—¶å€™, é€šå¸¸æ˜¯è¢«å°è£…æˆ GenericBeanDefinition æˆ– ScannedGenericBeanDefinition, ä½†æ˜¯ä»è¿™è¾¹ä¹‹å bean çš„åç»­æµç¨‹å¤„ç†éƒ½æ˜¯é’ˆå¯¹ RootBeanDefinition, å› æ­¤åœ¨è¿™è¾¹ä¼šç»Ÿä¸€å°† BeanDefinition è½¬æ¢æˆ RootBeanDefinition.</p> <p>åœ¨æ—¥å¸¸ä½¿ç”¨çš„è¿‡ç¨‹ä¸­, é€šå¸¸ä¼šæ˜¯ä¸Šé¢çš„ç¬¬ 3 ç§æƒ…å†µ. å¦‚æœä½¿ç”¨ XML é…ç½®æ¥æ³¨å†Œ bean, åˆ™è¯¥ bean å®šä¹‰ä¼šè¢«å°è£…æˆ: GenericBeanDefinition; å¦‚æœä½¿ç”¨æ³¨è§£çš„æ–¹å¼æ¥æ³¨å†Œ bean, ä¹Ÿå°±æ˜¯ <a href="/pages/db6afe/context:component-scan/">context:component-scan/</a> + @Compoment, åˆ™è¯¥ bean å®šä¹‰ä¼šè¢«å°è£…æˆ ScannedGenericBeanDefinition.</p> <p>è¿™éƒ¨åˆ†æœ‰ç‚¹ç»•, å¯ä»¥å‚è€ƒä¸‹é¢çš„æ–‡ç« ç»§ç»­æ·±å…¥çš„è§£æé‡Œé¢çš„æ–¹æ³•.</p> <ul><li><a href="https://blog.csdn.net/v123411739/article/details/87907784" target="_blank" rel="noopener noreferrer">https://blog.csdn.net/v123411739/article/details/87907784<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul> <h6 id="_2-factorybean"><a href="#_2-factorybean" class="header-anchor">#</a> (2)FactoryBean</h6> <p>ä¸€èˆ¬æƒ…å†µä¸‹, Spring é€šè¿‡<strong>åå°„æœºåˆ¶</strong>åˆ©ç”¨ bean çš„ class å±æ€§æŒ‡å®šå®ç°ç±»æ¥<strong>å®ä¾‹åŒ– bean</strong>. è€Œ FactoryBean æ˜¯ä¸€ç§<strong>ç‰¹æ®Šçš„ bean</strong>, å®ƒæ˜¯ä¸ªå·¥å‚ bean, å¯ä»¥<strong>è‡ªå·±åˆ›å»º bean å®ä¾‹</strong>, å¦‚æœä¸€ä¸ªç±»å®ç°äº† <strong>FactoryBean</strong> æ¥å£, åˆ™è¯¥ç±»å¯ä»¥è‡ªå·±å®šä¹‰åˆ›å»ºå®ä¾‹å¯¹è±¡çš„æ–¹æ³•, åªéœ€è¦å®ç°å®ƒçš„ <strong>getObject()</strong>  æ–¹æ³•.</p> <p>æ³¨: å¾ˆå¤š<strong>ä¸­é—´ä»¶</strong>éƒ½åˆ©ç”¨ FactoryBean æ¥è¿›è¡Œæ‰©å±•. æ¯”å¦‚ MyBatis ä¸­çš„ <strong>SqlSessionFactory</strong> bean å°±æ˜¯é€šè¿‡è¿™ç§æ–¹å¼é…ç½®å±æ€§çš„.</p> <p>ä¾‹å¦‚:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">BookFactoryBean</span> <span class="token keyword">implements</span> <span class="token class-name">FactoryBean</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Book</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Book</span> <span class="token function">getObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">Book</span> book <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Book</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        book<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">&quot;Tom&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> book<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> <span class="token function">getObjectType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">Book</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isSingleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p>ä¸ºäº†åŒºåˆ† &quot;<strong>FactoryBean</strong>&quot; å’Œ &quot;<strong>FactoryBean åˆ›å»ºçš„ bean å®ä¾‹</strong>&quot;, Spring ä½¿ç”¨äº†  <strong>&quot;&amp;&quot; å‰ç¼€</strong>. å‡è®¾ beanName ä¸º &quot;book&quot;, åˆ™ getBean(&quot;book&quot;) è·å¾—çš„æ˜¯ BookFactoryBean é€šè¿‡ getObject() æ–¹æ³•<strong>åˆ›å»ºçš„ bean å®ä¾‹</strong>; è€Œ getBean(&quot;&amp;book&quot;) è·å¾—çš„æ˜¯ BookFactoryBean è‡ªèº«ä»£è¡¨çš„ bean.</p> <h6 id="_3-isfactorybean"><a href="#_3-isfactorybean" class="header-anchor">#</a> (3)isFactoryBean()</h6> <p>ç»§ç»­çœ‹ preInstantiateSingletons() è¿™ä¸ªæ ¸å¿ƒæ–¹æ³•é‡Œçš„æ–¹æ³• isFactoryBean(). ç”¨äºåˆ¤æ–­æ˜¯å¦æ˜¯ FactoryBean.</p> <blockquote><p>AbstractBeanFactory::isFactoryBean()</p></blockquote> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isFactoryBean</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">NoSuchBeanDefinitionException</span> <span class="token punctuation">{</span>
    <span class="token comment">// 1.æ‹¿åˆ°çœŸæ­£çš„beanName(å»æ‰&amp;å‰ç¼€, è§£æåˆ«å)</span>
    <span class="token class-name">String</span> beanName <span class="token operator">=</span> <span class="token function">transformedBeanName</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 2.å°è¯•ä»ç¼“å­˜è·å–Beanå®ä¾‹å¯¹è±¡</span>
    <span class="token class-name">Object</span> beanInstance <span class="token operator">=</span> <span class="token function">getSingleton</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 3.beanInstanceå­˜åœ¨, åˆ™ç›´æ¥åˆ¤æ–­ç±»å‹æ˜¯å¦ä¸ºFactoryBean</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>beanInstance <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span>beanInstance <span class="token keyword">instanceof</span> <span class="token class-name">FactoryBean</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// No singleton instance found -&gt; check bean definition.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">containsBeanDefinition</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">getParentBeanFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">instanceof</span> <span class="token class-name">ConfigurableBeanFactory</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 4.å¦‚æœç¼“å­˜ä¸­ä¸å­˜åœ¨æ­¤beanName &amp;&amp; çˆ¶beanFactoryæ˜¯ConfigurableBeanFactory, åˆ™è°ƒç”¨çˆ¶BeanFactoryåˆ¤æ–­æ˜¯å¦ä¸ºFactoryBean</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">ConfigurableBeanFactory</span><span class="token punctuation">)</span> <span class="token function">getParentBeanFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isFactoryBean</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 6.é€šè¿‡MergedBeanDefinitionæ¥æ£€æŸ¥beanNameå¯¹åº”çš„Beanæ˜¯å¦ä¸ºFactoryBean</span>
    <span class="token keyword">return</span> <span class="token function">isFactoryBean</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> <span class="token function">getMergedLocalBeanDefinition</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p>æ³¨é‡Š 2: å°è¯•ä»ç¼“å­˜è·å– Bean å®ä¾‹å¯¹è±¡, è¿™é‡Œè°ƒç”¨äº† <mark><strong>getSingleton(beanName, false)</strong></mark>  æ–¹æ³•, è¿™ä¸ªæ–¹æ³•å¾ˆé‡è¦.</p> <blockquote><p>DefaultSingletonBeanRegistry::getSingleton()</p></blockquote> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Nullable</span>
<span class="token keyword">protected</span> <span class="token class-name">Object</span> <span class="token function">getSingleton</span><span class="token punctuation">(</span><span class="token class-name">String</span> beanName<span class="token punctuation">,</span> <span class="token keyword">boolean</span> allowEarlyReference<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 1.ä»å•ä¾‹å¯¹è±¡ç¼“å­˜Mapä¸­è·å–beanNameå¯¹åº”çš„å•ä¾‹å¯¹è±¡</span>
    <span class="token class-name">Object</span> singletonObject <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>singletonObjects<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 2.å¦‚æœå•ä¾‹å¯¹è±¡ç¼“å­˜ä¸­æ²¡æœ‰, ä¸”è¯¥beanNameå¯¹åº”çš„å•ä¾‹beanæ­£åœ¨åˆ›å»ºä¸­</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>singletonObject <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isSingletonCurrentlyInCreation</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token comment">// 3.åŠ é”è¿›è¡Œæ“ä½œ</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>singletonObjects<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 4.ä»æ—©æœŸå•ä¾‹å¯¹è±¡ç¼“å­˜ä¸­è·å–å•ä¾‹å¯¹è±¡(ä¹‹æ‰€ç§°æˆä¸ºæ—©æœŸå•ä¾‹å¯¹è±¡, æ˜¯å› ä¸ºearlySingletonObjectsé‡Œ</span>
            <span class="token comment">// çš„å¯¹è±¡çš„éƒ½æ˜¯é€šè¿‡æå‰æ›å…‰çš„ObjectFactoryåˆ›å»ºå‡ºæ¥çš„, è¿˜æœªè¿›è¡Œå±æ€§å¡«å……ç­‰æ“ä½œ</span>
            <span class="token comment">// å¦‚æœæ­¤beanæ­£åœ¨åŠ è½½åˆ™ä¸å¤„ç†</span>
            singletonObject <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>earlySingletonObjects<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// 5.å¦‚æœåœ¨æ—©æœŸå•ä¾‹å¯¹è±¡ç¼“å­˜ä¸­ä¹Ÿæ²¡æœ‰, å¹¶ä¸”å…è®¸åˆ›å»ºæ—©æœŸå•ä¾‹å¯¹è±¡å¼•ç”¨</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>singletonObject <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> allowEarlyReference<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// 6.ä»å•ä¾‹å·¥å‚ç¼“å­˜ä¸­è·å–beanNameçš„å•ä¾‹å·¥å‚</span>
                <span class="token comment">// å½“æŸäº›æ–¹æ³•éœ€è¦æå‰åˆå§‹åŒ–çš„æ—¶å€™åˆ™ä¼šè°ƒç”¨addSingletonFactoryæ–¹æ³•å°†å¯¹åº”çš„ObjectFactoryåˆå§‹åŒ–ç­–ç•¥å­˜å‚¨åœ¨singletonFactoriesä¸­</span>
                <span class="token class-name">ObjectFactory</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> singletonFactory <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>singletonFactories<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>singletonFactory <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">// 7.å¦‚æœå­˜åœ¨å•ä¾‹å¯¹è±¡å·¥å‚FactoryBean, åˆ™é€šè¿‡å·¥å‚åˆ›å»ºä¸€ä¸ªå•ä¾‹å¯¹è±¡</span>
                    <span class="token comment">// è°ƒç”¨é¢„å…ˆè®¾å®šçš„getObjectæ–¹æ³•</span>
                    singletonObject <span class="token operator">=</span> singletonFactory<span class="token punctuation">.</span><span class="token function">getObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">// 8.å°†é€šè¿‡å•ä¾‹å¯¹è±¡å·¥å‚åˆ›å»ºçš„å•ä¾‹å¯¹è±¡, æ”¾åˆ°æ—©æœŸå•ä¾‹å¯¹è±¡ç¼“å­˜ä¸­</span>
                    <span class="token comment">// è®°å½•åœ¨ç¼“å­˜ä¸­, earlySingletonObjectsä¸singletonFactoriesäº’æ–¥</span>
                    <span class="token keyword">this</span><span class="token punctuation">.</span>earlySingletonObjects<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> singletonObject<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">// 9.ç§»é™¤è¯¥beanNameå¯¹åº”çš„å•ä¾‹å¯¹è±¡å·¥å‚, å› ä¸ºè¯¥å•ä¾‹å·¥å‚å·²ç»åˆ›å»ºäº†ä¸€ä¸ªå®ä¾‹å¯¹è±¡, å¹¶ä¸”æ”¾åˆ°earlySingletonObjectsç¼“å­˜äº†, </span>
                    <span class="token comment">// å› æ­¤, åç»­è·å–beanNameçš„å•ä¾‹å¯¹è±¡, å¯ä»¥é€šè¿‡earlySingletonObjectsç¼“å­˜æ‹¿åˆ°, ä¸éœ€è¦åœ¨ç”¨åˆ°è¯¥å•ä¾‹å·¥å‚</span>
                    <span class="token keyword">this</span><span class="token punctuation">.</span>singletonFactories<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 10.è¿”å›å•ä¾‹å¯¹è±¡</span>
    <span class="token keyword">return</span> singletonObject<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br></div></div><blockquote><p>DefaultSingletonBeanRegistry::isSingletonCurrentlyInCreation()</p></blockquote> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isSingletonCurrentlyInCreation</span><span class="token punctuation">(</span><span class="token class-name">String</span> beanName<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>singletonsCurrentlyInCreation<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>è¿™æ®µä»£ç å¾ˆé‡è¦, åœ¨æ­£å¸¸æƒ…å†µä¸‹, è¯¥ä»£ç å¾ˆæ™®é€š, åªæ˜¯æ­£å¸¸çš„æ£€æŸ¥ä¸‹è¦æ‹¿çš„ bean å®ä¾‹æ˜¯å¦å­˜åœ¨äºç¼“å­˜ä¸­, å¦‚æœæœ‰å°±è¿”å›ç¼“å­˜ä¸­çš„ bean å®ä¾‹, å¦åˆ™å°±è¿”å› null.</p> <p>ç„¶è€Œè¯¥æ®µä»£ç æ˜¯ Spring <strong>è§£å†³å¾ªç¯ä¾èµ–</strong>çš„æ ¸å¿ƒä»£ç .</p> <p>è§£å†³å¾ªç¯ä¾èµ–é€»è¾‘: ä½¿ç”¨<strong>æ„é€ æ–¹æ³•</strong>åˆ›å»ºä¸€ä¸ª &quot;ä¸å®Œæ•´&quot; çš„ bean å®ä¾‹(ä¹‹æ‰€ä»¥è¯´ä¸å®Œæ•´, æ˜¯å› ä¸ºæ­¤æ—¶è¯¥ bean <strong>å®ä¾‹è¿˜æœªåˆå§‹åŒ–</strong>), å¹¶ä¸”æå‰æ›å…‰è¯¥ bean å®ä¾‹çš„ ObjectFactory(æå‰æ›å…‰å°±æ˜¯å°† ObjectFactory æ”¾åˆ° <strong>singletonFactories</strong> ç¼“å­˜), é€šè¿‡ ObjectFactory å¯ä»¥æ‹¿åˆ°è¯¥ bean å®ä¾‹çš„<strong>å¼•ç”¨</strong>. å¦‚æœå‡ºç°å¾ªç¯ä¾èµ–, å¯ä»¥é€šè¿‡<strong>ç¼“å­˜ä¸­çš„ ObjectFactory æ¥æ‹¿åˆ° bean å®ä¾‹</strong>, ä»è€Œé¿å…å‡ºç°å¾ªç¯ä¾èµ–å¯¼è‡´çš„æ­»å¾ªç¯. è¿™è¾¹é€šè¿‡ç¼“å­˜ä¸­çš„ ObjectFactory æ‹¿åˆ°çš„ bean å®ä¾‹è™½ç„¶æ‹¿åˆ°çš„<strong>æ˜¯ &quot;ä¸å®Œæ•´&quot; çš„è¿˜æœªè¿›è¡Œåˆå§‹åŒ–çš„ bean å®ä¾‹</strong>, ä½†æ˜¯ç”±äºæ˜¯<strong>å•ä¾‹</strong>, æ‰€ä»¥<strong>åç»­åˆå§‹åŒ–å®Œæˆå, è¯¥ bean å®ä¾‹çš„å¼•ç”¨åœ°å€å¹¶ä¸ä¼šå˜, æ‰€ä»¥æœ€ç»ˆçœ‹åˆ°çš„è¿˜æ˜¯å®Œæ•´ bean å®ä¾‹</strong>.</p> <p>Spring ä¸­å¤§é‡ä½¿ç”¨äº†<strong>æœ¬åœ°ç¼“å­˜</strong>, è¿™é‡Œå¼•è¿›äº† 4 ä¸ªé‡è¦ç¼“å­˜:</p> <ul><li><strong>(ä¸€çº§ç¼“å­˜)singletonObjects ç¼“å­˜</strong>: beanName -&gt; å•ä¾‹ bean å¯¹è±¡.</li> <li><strong>(äºŒçº§ç¼“å­˜)earlySingletonObjects ç¼“å­˜</strong>: beanName -&gt; å•ä¾‹ bean å¯¹è±¡, è¯¥ç¼“å­˜å­˜æ”¾çš„æ˜¯<strong>æ—©æœŸå•ä¾‹</strong> bean å¯¹è±¡, å¯ä»¥ç†è§£æˆè¿˜æœªè¿›è¡Œå±æ€§å¡«å……, åˆå§‹åŒ–.</li> <li><strong>(ä¸‰çº§ç¼“å­˜)singletonFactories ç¼“å­˜</strong>: beanName -&gt; ObjectFactory.</li> <li><strong>singletonsCurrentlyInCreation ç¼“å­˜</strong>: å½“å‰æ­£åœ¨åˆ›å»ºå•ä¾‹ bean å¯¹è±¡çš„ beanName é›†åˆ.</li></ul> <p>singletonObjects, earlySingletonObjects, singletonFactories åœ¨è¿™è¾¹æ„æˆäº†ä¸€ä¸ªç±»ä¼¼äº &quot;<strong>ä¸‰çº§ç¼“å­˜</strong>&quot; çš„æ¦‚å¿µ.</p> <p>preInstantiateSingletons() æ–¹æ³•è¿˜æœ‰ä¸€ä¸ªæ ¸å¿ƒæ–¹æ³• <strong>getBean()</strong> , è¿™é‡Œä¸‹ä¸€èŠ‚å•ç‹¬è¯´.</p> <h4 id="finishrefresh"><a href="#finishrefresh" class="header-anchor">#</a> finishRefresh()</h4> <p>finishRefresh() æ–¹æ³•å¦‚ä¸‹.</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">finishRefresh</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Clear context-level resource caches (such as ASM metadata from scanning).</span>
    <span class="token function">clearResourceCaches</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 1.ä¸ºæ­¤ä¸Šä¸‹æ–‡åˆå§‹åŒ–ç”Ÿå‘½å‘¨æœŸå¤„ç†å™¨</span>
    <span class="token function">initLifecycleProcessor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 2.é¦–å…ˆå°†åˆ·æ–°å®Œæ¯•äº‹ä»¶ä¼ æ’­åˆ°ç”Ÿå‘½å‘¨æœŸå¤„ç†å™¨(è§¦å‘isAutoStartupæ–¹æ³•è¿”å›trueçš„SmartLifecycleçš„startæ–¹æ³•)</span>
    <span class="token comment">// å¯åŠ¨æ‰€æœ‰å®ç°äº†Lifecycleæ¥å£çš„bean</span>
    <span class="token function">getLifecycleProcessor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">onRefresh</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 3.æ¨é€ä¸Šä¸‹æ–‡åˆ·æ–°å®Œæ¯•äº‹ä»¶åˆ°ç›¸åº”çš„ç›‘å¬å™¨</span>
    <span class="token comment">// æœ€åå‘å¸ƒå®¹å™¨å¯åŠ¨å®Œæˆçš„äº‹ä»¶(è°ƒç”¨äº‹ä»¶å¹¿æ’­å™¨è¿›è¡Œäº‹ä»¶å¹¿æ’­)</span>
    <span class="token function">publishEvent</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ContextRefreshedEvent</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Participate in LiveBeansView MBean, if active.</span>
    <span class="token class-name">LiveBeansView</span><span class="token punctuation">.</span><span class="token function">registerApplicationContext</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>â€</p> <p>â€</p> <h4 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="header-anchor">#</a> å‚è€ƒèµ„æ–™</h4> <ul><li>å¤§ä½¬IOCåˆé›†: <a href="https://blog.csdn.net/v123411739/article/details/87741251" target="_blank" rel="noopener noreferrer">https://blog.csdn.net/v123411739/article/details/87741251<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div>  <div class="page-edit"><div class="edit-link"><a href="https://github.com/xugaoyi/vuepress-theme-vdoing/edit/main/docs/20.å¼€å‘/2100.å¼€å‘/300.Spring/10.Spring IOCæºç åˆ†æ-æ¦‚è§ˆ.md" target="_blank" rel="noopener noreferrer">ç¼–è¾‘</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <!----> <!----></div> <div class="page-nav-wapper"><div class="page-nav-centre-wrap"><a href="/pages/f0d4d6/" class="page-nav-centre page-nav-centre-prev"><div class="tooltip">Springäº‹åŠ¡åŸºç¡€</div></a> <a href="/pages/672e98/" class="page-nav-centre page-nav-centre-next"><div class="tooltip">Spring IOCæºç åˆ†æ-getBean()</div></a></div> <div class="page-nav"><p class="inner"><span class="prev">
        â†
        <a href="/pages/f0d4d6/" class="prev">Springäº‹åŠ¡åŸºç¡€</a></span> <span class="next"><a href="/pages/672e98/">Spring IOCæºç åˆ†æ-getBean()</a>â†’
      </span></p></div></div></div> <!----></main></div> <div class="footer"><div class="icons"><a href="mailto:1174520425@qq.com" title="å‘é‚®ä»¶" target="_blank" class="iconfont icon-youjian"></a><a href="https://github.com/nanodaemony" title="GitHub" target="_blank" class="iconfont icon-github"></a></div> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="æœ¬ç«™ä¸»é¢˜">Vdoing</a> 
    | Copyright Â© 2019-2025
    <span>è¾¾å°”æ–‡çš„çŒ¹ | MIT License</span></div> <div class="buttons"><div title="è¿”å›é¡¶éƒ¨" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="å»è¯„è®º" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="ä¸»é¢˜æ¨¡å¼" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          è·Ÿéšç³»ç»Ÿ
        </li><li class="iconfont icon-rijianmoshi">
          æµ…è‰²æ¨¡å¼
        </li><li class="iconfont icon-yejianmoshi">
          æ·±è‰²æ¨¡å¼
        </li><li class="iconfont icon-yuedu">
          é˜…è¯»æ¨¡å¼
        </li></ul></div></div> <!----> <!----> <!----></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.3f3e0e10.js" defer></script><script src="/assets/js/2.e9fcb30c.js" defer></script><script src="/assets/js/3.1998f389.js" defer></script><script src="/assets/js/117.4024cfe2.js" defer></script>
  </body>
</html>
