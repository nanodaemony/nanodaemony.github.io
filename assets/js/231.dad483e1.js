(window.webpackJsonp=window.webpackJsonp||[]).push([[231],{559:function(s,n,t){"use strict";t.r(n);var e=t(4),a=Object(e.a)({},(function(){var s=this,n=s._self._c;return n("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[n("h1",{attrs:{id:"_33-redis哨兵"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_33-redis哨兵"}},[s._v("#")]),s._v(" 33.Redis哨兵")]),s._v(" "),n("h4",{attrs:{id:"redis-sentinel架构基础🌟"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#redis-sentinel架构基础🌟"}},[s._v("#")]),s._v(" Redis Sentinel架构基础🌟")]),s._v(" "),n("h5",{attrs:{id:"_1-普通主从复制的问题"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_1-普通主从复制的问题"}},[s._v("#")]),s._v(" 1.普通主从复制的问题")]),s._v(" "),n("p",[n("strong",[s._v("主从复制")]),s._v("存在以下问题:")]),s._v(" "),n("ul",[n("li",[s._v("一旦主节点"),n("strong",[s._v("出现故障")]),s._v(", 需要手动将一个从节点晋升为主节点, 同时需要修改应用方的主节点地址, 还需要命令其他从节点去复制新的主节点, 整个过程需要"),n("strong",[s._v("人工干预")]),s._v(".")]),s._v(" "),n("li",[s._v("主节点的"),n("strong",[s._v("写能力")]),s._v("受到单机的限制, 主节点的"),n("strong",[s._v("存储能力")]),s._v("受到单机的限制.")])]),s._v(" "),n("p",[s._v("这一点也"),n("strong",[s._v("不高可用")]),s._v(".")]),s._v(" "),n("h5",{attrs:{id:"_2-redis-sentinel架构"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2-redis-sentinel架构"}},[s._v("#")]),s._v(" 2.Redis Sentinel架构")]),s._v(" "),n("p",[s._v("Redis Sentinel 是一个"),n("strong",[s._v("分布式架构")]),s._v(", 其中包含"),n("strong",[s._v("若干个 Sentinel 节点")]),s._v("和 Redis 数据节点, 每个 Sentinel 节点会对数据节点和"),n("strong",[s._v("其余")]),s._v(" Sentinel 节点进行监控, 当它发现节点不可达时, 会对节点做"),n("strong",[s._v("下线标识")]),s._v(". 如果被标识的是"),n("strong",[s._v("主节点")]),s._v(', 它还会和其他 Sentinel 节点进行 "'),n("strong",[s._v("协商")]),s._v('", 当大多数 Sentinel 节点'),n("strong",[s._v("都认为主节点不可达")]),s._v("时, 它们会"),n("strong",[s._v("选举出一个 Sentinel 节点")]),s._v("来完成"),n("strong",[s._v("自动故障转移")]),s._v("的工作, 同时会将这个变化"),n("strong",[s._v("实时通知")]),s._v("给客户端.")]),s._v(" "),n("p",[s._v("主节点出现故障时, "),n("strong",[s._v("Redis Sentinel")]),s._v(" 能"),n("strong",[s._v("自动完成故障发现和故障转移")]),s._v(", 并"),n("strong",[s._v("通知应用方")]),s._v(", 整个过程完全是"),n("strong",[s._v("自动")]),s._v("的, 不需要人工来介入, 从而实现真正的"),n("strong",[s._v("高可用")]),s._v(".")]),s._v(" "),n("p",[s._v("Redis Sentinel 与 Redis 主从复制的架构相比较"),n("strong",[s._v("只是多了若干 Sentinel 节点")]),s._v(", 所以 Redis Sentinel "),n("strong",[s._v("并没有")]),s._v("针对 Redis 节点做特殊处理.")]),s._v(" "),n("p",[n("img",{attrs:{src:"https://nano-note.oss-cn-beijing.aliyuncs.com/images/image-20211218185927434.png",alt:""}})]),s._v(" "),n("p",[n("strong",[s._v("Sentinel 节点本身就是独立的 Redis 节点, 只不过它们有一些特殊, 它们不存储数据, 只支持部分命令")]),s._v(". Sentinel 节点"),n("strong",[s._v("集合")]),s._v("会定期对"),n("strong",[s._v("所有节点")]),s._v("进行监控, 特别是对主节点的"),n("strong",[s._v("故障实现自动转移")]),s._v(".")]),s._v(" "),n("p",[s._v("Redis Sentinel 同时包含了"),n("strong",[s._v("若个 Sentinel 节点")]),s._v(", 这样做有如下好处:")]),s._v(" "),n("ul",[n("li",[s._v("节点"),n("strong",[s._v("故障判断")]),s._v("由多个 Sentinel 节点"),n("strong",[s._v("共同完成")]),s._v(", 可以"),n("strong",[s._v("防止误判")]),s._v(".")]),s._v(" "),n("li",[s._v("Sentinel 节点集合由若干个 Sentinel 节点组成, 即使个别 Sentinel 节点不可用, 整个 Sentinel 节点集合依然是健壮的, 防止 Sentinel 出现单点故障.")])]),s._v(" "),n("h5",{attrs:{id:"_3-sentinel的功能"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-sentinel的功能"}},[s._v("#")]),s._v(" 3.Sentinel的功能")]),s._v(" "),n("p",[s._v("Redis Sentinel 具有以下几个功能:")]),s._v(" "),n("ul",[n("li",[n("strong",[s._v("监控")]),s._v(": Sentinel 节点会定期检测 Redis 数据节点以及其余 Sentinel 节点是否可达.")]),s._v(" "),n("li",[n("strong",[s._v("通知")]),s._v(": Sentinel 节点会将故障转移的结果通知给应用方.")]),s._v(" "),n("li",[n("strong",[s._v("主节点故障转移")]),s._v(": 实现从节点晋升为主节点并维护后续正确的主从关系.")]),s._v(" "),n("li",[n("strong",[s._v("配置提供者")]),s._v(": 在 Sentinel 结构中, 客户端初始化时连接的是 Sentinel 节点"),n("strong",[s._v("集合")]),s._v(", 从中获取主节点信息.")])]),s._v(" "),n("h5",{attrs:{id:"_4-sentinel部署与配置"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_4-sentinel部署与配置"}},[s._v("#")]),s._v(" 4.Sentinel部署与配置")]),s._v(" "),n("p",[s._v("部署实操可以看看 Sentinel 架构的部署过程: "),n("a",{attrs:{href:"https://blog.csdn.net/cuiwjava/article/details/98844949",target:"_blank",rel:"noopener noreferrer"}},[s._v("https://blog.csdn.net/cuiwjava/article/details/98844949"),n("OutboundLink")],1)]),s._v(" "),n("h6",{attrs:{id:"_1-配置参数及优化"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_1-配置参数及优化"}},[s._v("#")]),s._v(" (1)配置参数及优化")]),s._v(" "),n("p",[s._v("Redis 安装目录下有一个 "),n("strong",[s._v("sentinel.conf")]),s._v(", 是默认的 Sentinel 节点"),n("strong",[s._v("配置文件")]),s._v(".")]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[s._v("port "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("26379")]),s._v("\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 端口")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("dir")]),s._v(" /opt/soft/redis/data  "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 工作目录")]),s._v("\nsentinel monitor mymaster "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1 "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("6379")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 配置主节点地址端口, 不可达票数为2")]),s._v("\nsentinel down-after-milliseconds mymaster "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("30000")]),s._v("\nsentinel parallel-syncs mymaster "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\nsentinel failover-timeout mymaster "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("180000")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#sentinel auth-pass <master-name> <password>")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#sentinel notification-script <master-name> <script-path>")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#sentinel client-reconfig-script <master-name> <script-path>")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br")])]),n("p",[n("strong",[s._v("① sentinel monitor")])]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[s._v("$ sentinel monitor "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("master-name"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("ip"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("port"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("quorum"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("Sentinel 节点会定期监控"),n("strong",[s._v("主节点")]),s._v(", 所以从配置上必然也会有所体现, Sentinel 节点要监控的是一个名字叫做 "),n("master-name",[s._v(", ip 地址和端口为 "),n("ip",[n("port",[s._v(" 的"),n("strong",[s._v("主节点")]),s._v(".")])],1)],1)],1),s._v(" "),n("p",[n("strong",[s._v("<quorum>")]),s._v(" 代表要判定**==主节点最终不可达所需要的票数=="),n("strong",[s._v(". "),n("quorum",[s._v(" 参数用于故障发现和判定, 例如将 quorum 配置为 2, 代表至少有 2 个 Sentinel 节点")])],1),s._v("认为"),n("strong",[s._v("主节点不可达时, 这个不可达的判定才是客观的. 一般建议将其")]),s._v("设置为 Sentinel 节点数量的一半加 1**.")]),s._v(" "),n("p",[s._v("同时 "),n("strong",[s._v("<quorum>")]),s._v(" 还与 Sentinel 节点的"),n("strong",[s._v("领导者选举")]),s._v("有关, 至少要有 "),n("strong",[s._v("max(quorum, num(sentinels) / 2 + 1)")]),s._v(" 个 Sentinel 节点参与选举, 才能选出领导者 Sentinel, 从而完成故障转移.")]),s._v(" "),n("p",[s._v("Sentinel 节点会对"),n("strong",[s._v("所有节点")]),s._v("进行监控, 但在 Sentinel 节点配置中没有看到有关从节点和其余 Sentinel 节点的配置, 这是因为 Sentinel 节点会"),n("strong",[s._v("自动从主节中获取有关从节点以及其余 Sentinel 节点")]),s._v("的相关信息.")]),s._v(" "),n("p",[s._v("例如某个 Sentinel "),n("strong",[s._v("初始节点配置")]),s._v("如下:")]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[s._v("port "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("26379")]),s._v("\ndaemonize "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("yes")]),s._v("\nlogfile "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"26379.log"')]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("dir")]),s._v(" /opt/soft/redis/data\nsentinel monitor mymaster "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1 "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("6379")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 只有主节点的配置")]),s._v("\nsentinel down-after-milliseconds mymaster "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("30000")]),s._v("\nsentinel parallel-syncs mymaster "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\nsentinel failover-timeout mymaster "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("180000")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br")])]),n("p",[s._v("当所有节点启动后, 配置文件中的内容发生了"),n("strong",[s._v("变化")]),s._v(", 原来配置文件中会"),n("strong",[s._v("自动加入从节点和其他 Sentinel 结点的信息")]),s._v(", 并会去掉一些默认配置参数. 如下.")]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[s._v("port "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("26379")]),s._v("\ndaemonize "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("yes")]),s._v("\nlogfile "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"26379.log"')]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("dir")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/opt/soft/redis/data"')]),s._v("\nsentinel monitor mymaster "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1 "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("6379")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("\nsentinel config-epoch mymaster "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\nsentinel leader-epoch mymaster "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#发现两个slave节点")]),s._v("\nsentinel known-slave mymaster "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1 "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("6380")]),s._v("\nsentinel known-slave mymaster "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1 "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("6381")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#发现两个sentinel节点")]),s._v("\nsentinel known-sentinel mymaster "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1 "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("26380")]),s._v(" 282a70ff56c36ed56e8f7ee6ada741\n24140d6f53\nsentinel known-sentinel mymaster "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1 "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("26381")]),s._v(" f714470d30a61a8e39ae031192f1fe\nae7eb5b2be\nsentinel current-epoch "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br")])]),n("p",[s._v("Redis Sentinel 可以"),n("strong",[s._v("同时监控多个主节点")]),s._v(". 配置时只需要指定"),n("strong",[s._v("多个 masterName")]),s._v(" 来区分"),n("strong",[s._v("不同的主节点")]),s._v("即可.")]),s._v(" "),n("p",[n("img",{attrs:{src:"https://nano-note.oss-cn-beijing.aliyuncs.com/images/image-20211218185927434.png",alt:""}})]),s._v(" "),n("p",[n("strong",[s._v("② sentinel down-after-milliseconds")])]),s._v(" "),n("p",[s._v("配置结点间不可达"),n("strong",[s._v("超时时间")]),s._v(".")]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[s._v("$ sentinel down-after-milliseconds "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("master-name"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("times"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("每个 Sentinel 节点都要通过"),n("strong",[s._v("定期发送 ping 命令")]),s._v("来判断 Redis 数据节点和其余 Sentinel 节点"),n("strong",[s._v("是否可达")]),s._v(", 如果超过了 down-after-milliseconds 配置的"),n("strong",[s._v("时间")]),s._v("且没有有效的回复, 则判定节点不可达.")]),s._v(" "),n("p",[n("strong",[s._v("③ sentinel parallel-syncs")])]),s._v(" "),n("p",[s._v("用来限制在一次"),n("strong",[s._v("故障转移")]),s._v("之后, "),n("strong",[s._v("每次向新的主节点发起复制操作")]),s._v("的从节点个数.")]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[s._v("$ sentinel parallel-syncs "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("master-name"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("nums"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("h6",{attrs:{id:"_2-部署技巧"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2-部署技巧"}},[s._v("#")]),s._v(" (2)部署技巧")]),s._v(" "),n("ul",[n("li",[s._v("Sentinel 节点应部署在多台物理机器上.")]),s._v(" "),n("li",[s._v("部署"),n("strong",[s._v("三个以上且奇数个")]),s._v("的 Sentinel 节点. 3 个以上是通过增加 Sentinel 节点的个数提高对于故障判定的"),n("strong",[s._v("准确性")]),s._v(", 因为领导者选举需要至少一半加 1 个节点, 奇数个节点可以在满足该条件的基础上节省一个节点.")])]),s._v(" "),n("h5",{attrs:{id:"_5-哨兵部署与故障转移demo"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_5-哨兵部署与故障转移demo"}},[s._v("#")]),s._v(" 5.哨兵部署与故障转移Demo")]),s._v(" "),n("p",[n("strong",[s._v("(1)第一步: 创建主从节点配置文件并启动")])]),s._v(" "),n("p",[s._v("安装目录下找到 redis.conf 文件复制三份分别命名为 redis-master.conf/redis-slave1.conf/redis-slave2.conf, 分别作为 1 个主节点和 2 个从节点的配置文件. 分别修改如下所示:")]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# redis-master.conf")]),s._v("\nport "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("6379")]),s._v("\ndaemonize "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("yes")]),s._v("\nlogfile "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"6379.log"')]),s._v("\ndbfilename "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"dump-6379.rdb"')]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# redis-slave1.conf")]),s._v("\nport "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("6380")]),s._v("\ndaemonize "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("yes")]),s._v("\nlogfile "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"6380.log"')]),s._v("\ndbfilename "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"dump-6380.rdb"')]),s._v("\nslaveof "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1 "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("6379")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# redis-slave2.conf")]),s._v("\nport "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("6381")]),s._v("\ndaemonize "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("yes")]),s._v("\nlogfile "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"6381.log"')]),s._v("\ndbfilename "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"dump-6381.rdb"')]),s._v("\nslaveof "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1 "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("6379")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br")])]),n("p",[s._v("然后执行 "),n("strong",[s._v("redis-server <"),n("strong",[s._v("​")]),s._v("config file path>")]),s._v(" 来根据配置文件启动不同的 Redis 节点实例.")]),s._v(" "),n("div",{staticClass:"language-sh line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-sh"}},[n("code",[s._v("$ redis-server /usr/local/redis-5.0.3/redis-master.conf\n$ redis-server /usr/local/redis-5.0.3/redis-slave1.conf\n$ redis-server /usr/local/redis-5.0.3/redis-slave2.conf\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br")])]),n("p",[s._v("节点启动后客户端连接到端口为 "),n("strong",[s._v("6379 的主节点")]),s._v("执行 "),n("strong",[s._v("info Replication")]),s._v(" 检查一下"),n("strong",[s._v("主从状态")]),s._v("是否正常(可以看到下方正确地显示了两个从节点):")]),s._v(" "),n("p",[n("img",{attrs:{src:"https://nano-note.oss-cn-beijing.aliyuncs.com/images/7896890-a1c935f094240cac-3785108.png",alt:""}})]),s._v(" "),n("p",[n("strong",[s._v("(2)第二步: 创建哨兵节点配置文件并启动")])]),s._v(" "),n("p",[s._v("按照同样的方法, 给"),n("strong",[s._v("哨兵节点")]),s._v("也创建"),n("strong",[s._v("三个配置文件")]),s._v(". 哨兵节点本质上是特殊的 Redis 节点, 所以配置几乎没什么差别, 只是在端口上做区分即可.")]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# redis-sentinel-1.conf")]),s._v("\nport "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("26379")]),s._v("\ndaemonize "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("yes")]),s._v("\nlogfile "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"26379.log"')]),s._v("\nsentinel monitor mymaster "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1 "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("6379")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# redis-sentinel-2.conf")]),s._v("\nport "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("26380")]),s._v("\ndaemonize "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("yes")]),s._v("\nlogfile "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"26380.log"')]),s._v("\nsentinel monitor mymaster "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1 "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("6379")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# redis-sentinel-3.conf")]),s._v("\nport "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("26381")]),s._v("\ndaemonize "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("yes")]),s._v("\nlogfile "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"26381.log"')]),s._v("\nsentinel monitor mymaster "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1 "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("6379")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br")])]),n("p",[s._v("其中 "),n("strong",[s._v("sentinel monitor mymaster 127.0.0.1 6379 2")]),s._v(" 配置的含义是: 该哨兵节点监控 127.0.0.1:6379 这个"),n("strong",[s._v("主节点")]),s._v(", 该主节点的名称是 mymaster, 最后 2 的含义与主节点的故障判定有关: "),n("strong",[s._v("至少需要 2 个哨兵节点同意")]),s._v(", 才能判定主节点故障并进行故障转移.")]),s._v(" "),n("p",[s._v("执行命令启动哨兵节点.")]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[s._v("$ redis-server /usr/local/redis-5.0.3/redis-sentinel-1.conf "),n("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--sentinel")]),s._v("\n$ redis-server /usr/local/redis-5.0.3/redis-sentinel-2.conf "),n("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--sentinel")]),s._v("\n$ redis-server /usr/local/redis-5.0.3/redis-sentinel-3.conf "),n("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--sentinel")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br")])]),n("p",[s._v("使用客户端连接哨兵节点, 并执行 "),n("strong",[s._v("info Sentinel 命令")]),s._v("来查看是否已经在监视主节点了.")]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 连接端口为 26379 的 Redis 节点")]),s._v("\n$ redis-cli "),n("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-p")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("26379")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1:2637"),n("span",{pre:!0,attrs:{class:"token operator"}},[n("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[s._v("9")]),s._v(">")]),s._v(" info Sentinel\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# Sentinel")]),s._v("\nsentinel_masters:1\nsentinel_tilt:0\nsentinel_running_scripts:0\nsentinel_scripts_queue_length:0\nsentinel_simulate_failure_flags:0\nmaster0:name"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("mymaster,status"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("ok,address"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1:6379,slaves"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(",sentinels"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br")])]),n("p",[s._v("查看哨兵配置文件, 会发现已经自动写入一些节点相关的信息.")]),s._v(" "),n("p",[n("strong",[s._v("(3)第三步: 模拟故障转移")])]),s._v(" "),n("p",[s._v("使用 "),n("strong",[s._v('"kill -9"')]),s._v(" 命令"),n("strong",[s._v("杀掉主节点")]),s._v(", 同时在哨兵节点中执行 "),n("strong",[s._v('"info Sentinel" 命令')]),s._v("来观察故障节点的过程.")]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[s._v("$ "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("ps")]),s._v(" aux "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("grep")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("6379")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("nano")]),s._v("          "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("74529")]),s._v("   "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.3")]),s._v("  "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.0")]),s._v("  "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("4346936")]),s._v("   "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2132")]),s._v("   ??  Ss   "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v(":30上午   "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(":03.09 redis-server *:26379 "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("sentinel"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("nano")]),s._v("          "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("73541")]),s._v("   "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.2")]),s._v("  "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.0")]),s._v("  "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("4348072")]),s._v("   "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2292")]),s._v("   ??  Ss   "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v(":18上午   "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(":04.79 redis-server *:6379\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("nano")]),s._v("          "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("75521")]),s._v("   "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.0")]),s._v("  "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.0")]),s._v("  "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("4286728")]),s._v("    "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("728")]),s._v(" s008  S+   "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v(":39上午   "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(":00.00 "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("grep")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--color")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("auto --exclude-dir"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(".bzr --exclude-dir"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("CVS --exclude-dir"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(".git --exclude-dir"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(".hg --exclude-dir"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(".svn "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("6379")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("nano")]),s._v("          "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("74836")]),s._v("   "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.0")]),s._v("  "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.0")]),s._v("  "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("4289844")]),s._v("    "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("944")]),s._v(" s006  S+   "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v(":32上午   "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(":00.01 redis-cli "),n("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-p")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("26379")]),s._v("\n$ "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("kill")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-9")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("73541")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br")])]),n("p",[s._v("如果"),n("strong",[s._v("刚杀掉瞬间")]),s._v('在哨兵节点中执行 "info" 命令, 会发现主节点还没有切换过来, 因为哨兵发现主节点故障并转移需要一段时间. 一段时间之后再执行 '),n("strong",[s._v('"info" 命令')]),s._v(", 就会发现"),n("strong",[s._v("主节点已经切换成了 6381 端口的从节点")]),s._v(".")]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 过一段时间之后在执行, 发现已经切换了 6381 端口")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1:2637"),n("span",{pre:!0,attrs:{class:"token operator"}},[n("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[s._v("9")]),s._v(">")]),s._v(" info Sentinel\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# Sentinel")]),s._v("\nsentinel_masters:1\nsentinel_tilt:0\nsentinel_running_scripts:0\nsentinel_scripts_queue_length:0\nsentinel_simulate_failure_flags:0\nmaster0:name"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("mymaster,status"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("ok,address"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1:6381,slaves"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(",sentinels"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br")])]),n("p",[s._v("但同时还可以发现, "),n("strong",[s._v("哨兵节点认为新的主节点仍然有两个从节点")]),s._v("(上方 slaves=2), 这是因为哨兵在将 6381 切换成主节点的同时, 将 6379 节点置为其从节点. 虽然 6379 从节点已经挂掉, 但是由于 "),n("strong",[s._v("哨兵并不会对从节点进行客观下线")]),s._v(", 因此认为该从节点一直存在. 当 6379 节点重新启动后, 会自动变成 6381 节点的从节点.")]),s._v(" "),n("p",[s._v("另外在故障转移的阶段, 哨兵和主从节点的配置文件都会被改写:")]),s._v(" "),n("ul",[n("li",[n("strong",[s._v("对于主从节点: ​")]),s._v("主要是 slaveof 配置的变化, 新的主节点没有了 slaveof 配置, 其从节点则 slaveof 新的主节点.")]),s._v(" "),n("li",[n("strong",[s._v("对于哨兵节点: ​")]),s._v("除了主从节点信息的变化, 用于记录当前集群状态的参数纪元(epoch) 也会变化, 纪元相关的参数都 +1 了.")])]),s._v(" "),n("h4",{attrs:{id:"redis-sentinel-api与客户端"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#redis-sentinel-api与客户端"}},[s._v("#")]),s._v(" Redis Sentinel API与客户端")]),s._v(" "),n("h5",{attrs:{id:"_1-sentinel-api"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_1-sentinel-api"}},[s._v("#")]),s._v(" 1.Sentinel API")]),s._v(" "),n("p",[s._v("Sentinel 节点是一个"),n("strong",[s._v("特殊的 Redis 节点")]),s._v(", 它有自己"),n("strong",[s._v("专属的 API")]),s._v(".")]),s._v(" "),n("p",[n("strong",[s._v("① sentinel masters")]),s._v(": 展示所有被监控的"),n("strong",[s._v("主节点")]),s._v("状态以及相关的统计信息.")]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[n("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1:2637"),n("span",{pre:!0,attrs:{class:"token operator"}},[n("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[s._v("9")]),s._v(">")]),s._v(" sentinel masters\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"name"')]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"mymaster-2"')]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"ip"')]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"127.0.0.1"')]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"port"')]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("6")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"6382"')]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".忽略"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"name"')]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"mymaster-1"')]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"ip"')]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"127.0.0.1"')]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"port"')]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("6")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"6379"')]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".忽略"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br")])]),n("p",[n("strong",[s._v("② sentinel master <"),n("strong",[s._v("​")]),s._v("master name>")]),s._v(": 展示指定 "),n("master",{attrs:{name:""}},[s._v(" 的"),n("strong",[s._v("主节点")]),s._v("状态以及相关的统计信息.")])],1),s._v(" "),n("p",[n("strong",[s._v("③ sentinel slaves <"),n("strong",[s._v("​")]),s._v("master name>")]),s._v(": 展示指定 "),n("master",{attrs:{name:""}},[s._v(" 的"),n("strong",[s._v("从节点")]),s._v("状态以及相关的统计信息.")])],1),s._v(" "),n("p",[n("strong",[s._v("④ sentinel sentinels <"),n("strong",[s._v("​")]),s._v("master name>")]),s._v(": 展示指定 "),n("master",{attrs:{name:""}},[s._v(" 的 "),n("strong",[s._v("Sentinel 节点集合")]),s._v(", 不包含当前 Sentinel 节点.")])],1),s._v(" "),n("p",[n("strong",[s._v("⑤ sentinel failover <"),n("strong",[s._v("​")]),s._v("master name>")]),s._v(": 对指定 "),n("master",{attrs:{name:""}},[n("strong",[s._v("主节点进行强制故障转移")]),s._v("(没有和其他 Sentinel 节点协商), 当故障转移完成后, 其他 Sentinel 节点按照故障转移的结果"),n("strong",[s._v("更新自身配置")]),s._v(", 这个命令在 Redis Sentinel 的"),n("strong",[s._v("日常运维中非常有用")]),s._v(".")])],1),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[n("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1:2637"),n("span",{pre:!0,attrs:{class:"token operator"}},[n("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[s._v("9")]),s._v(">")]),s._v(" sentinel failover mymaster-2\nOK\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br")])]),n("p",[n("strong",[s._v("⑥ sentinel remove <"),n("strong",[s._v("​")]),s._v("master name>")]),s._v(": 取消对某个主节点的监控.")]),s._v(" "),n("h5",{attrs:{id:"_2-客户端连接"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2-客户端连接"}},[s._v("#")]),s._v(" 2.客户端连接")]),s._v(" "),n("h6",{attrs:{id:"_1-概述"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_1-概述"}},[s._v("#")]),s._v(" (1)概述")]),s._v(" "),n("p",[n("strong",[s._v("客户端初始化时连接")]),s._v("的是 Sentinel "),n("strong",[s._v("节点集合")]),s._v(", "),n("strong",[s._v("不再是")]),s._v("具体的 Redis 节点, 但 Sentinel 只是配置中心不是代理.")]),s._v(" "),n("p",[s._v("Sentinel 节点集合具备了"),n("strong",[s._v("监控, 通知, 自动故障转移, 配置提供者若干功能")]),s._v(", 所以最了解主节点信息的就是 Sentinel 节点集合, 而各个主节点可以通过 "),n("master-name",[s._v(" 进行标识. 如果需要正确地连接 Redis Sentinel, 必须有 "),n("strong",[s._v("Sentinel 节点集合和 masterName 两个参数")]),s._v(".")])],1),s._v(" "),n("p",[s._v("客户端基本操作:")]),s._v(" "),n("ul",[n("li",[s._v("遍历 Sentinel 节点集合获取一个可用的 Sentinel 节点, Sentinel 节点之间可以"),n("strong",[s._v("共享数据")]),s._v(", 所以从"),n("strong",[s._v("任意")]),s._v("一个 Sentinel 节点获取"),n("strong",[s._v("主节点")]),s._v("信息都是可以的.")]),s._v(" "),n("li",[s._v("需要"),n("strong",[s._v("验证")]),s._v('当前获取的 "主节点" 是真正的主节点, 这样做的目的是为了防止'),n("strong",[s._v("故障转移期间")]),s._v("主节点的变化.")]),s._v(" "),n("li",[s._v("保持和 Sentinel 节点集合的联系, 时刻获取关于主节点的相关信息.")])]),s._v(" "),n("h6",{attrs:{id:"_2-jedis"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2-jedis"}},[s._v("#")]),s._v(" (2)Jedis")]),s._v(" "),n("p",[s._v("Jedis 也提供了 "),n("strong",[s._v("Sentinel")]),s._v(" 连接池.")]),s._v(" "),n("div",{staticClass:"language-java line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-java"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("JedisSentinelPool")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("String")]),s._v(" masterName"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 主节点名")]),s._v("\n       "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Set")]),n("span",{pre:!0,attrs:{class:"token generics"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("String")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v(" sentinels"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// Sentinel节点集合")]),s._v("\n       "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("final")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("GenericObjectPoolConfig")]),s._v(" poolConfig"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("    "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// common-pool连接池配置")]),s._v("\n       "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("final")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" connectionTimeout"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\t\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 连接超时")]),s._v("\n       "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("final")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" soTimeout"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\t\t\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 读写超时")]),s._v("\n       "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("final")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("String")]),s._v(" password"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" \t"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 主节点密码")]),s._v("\n       "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("final")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" database"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\t\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 当前数据库索引")]),s._v("\n       "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("final")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("String")]),s._v(" clientName"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 客户端名")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br")])]),n("p",[s._v("连接时"),n("strong",[s._v("遍历")]),s._v(" Sentinel 结点集合, 找到一个可用的 Sentinel 结点, 然后从中得到"),n("strong",[s._v("主节点信息")]),s._v(".")]),s._v(" "),n("h4",{attrs:{id:"哨兵实现原理🌟"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#哨兵实现原理🌟"}},[s._v("#")]),s._v(" 哨兵实现原理🌟")]),s._v(" "),n("p",[s._v("详细介绍一下哨兵机制是如何实现的.")]),s._v(" "),n("h5",{attrs:{id:"_1-三个定时监控任务"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_1-三个定时监控任务"}},[s._v("#")]),s._v(" 1.三个定时监控任务")]),s._v(" "),n("p",[s._v("一套合理的监控机制是 Sentinel 节点判定节点"),n("strong",[s._v("不可达")]),s._v("的重要保证, Redis Sentinel 通过"),n("strong",[s._v("三个定时监控任务")]),s._v("完成对各个节点发现和监控.")]),s._v(" "),n("h6",{attrs:{id:"_1-sentinel与数据结点的定时任务"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_1-sentinel与数据结点的定时任务"}},[s._v("#")]),s._v(" (1)Sentinel与数据结点的定时任务")]),s._v(" "),n("p",[s._v("每隔 "),n("strong",[s._v("10 秒")]),s._v(", 每个 "),n("strong",[s._v("Sentinel 节点")]),s._v("会向"),n("strong",[s._v("主节点和从节点")]),s._v("发送 "),n("strong",[s._v("info 命令")]),s._v("获取最新的拓扑结构.")]),s._v(" "),n("p",[n("img",{attrs:{src:"https://nano-note.oss-cn-beijing.aliyuncs.com/images/image-20220523213535648.png",alt:""}})]),s._v(" "),n("p",[s._v("如在一个主节点执行 "),n("strong",[s._v("info replication")]),s._v(" 命令.")]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# Replication")]),s._v("\nrole:master\nconnected_slaves:2\nslave0:ip"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1,port"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("6380")]),s._v(",state"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("online,offset"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("4917")]),s._v(",lag"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\nslave1:ip"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1,port"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("6381")]),s._v(",state"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("online,offset"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("4917")]),s._v(",lag"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br")])]),n("p",[s._v("Sentinel 节点通过对上述结果进行"),n("strong",[s._v("解析")]),s._v("就可以找到相应的"),n("strong",[s._v("从节点")]),s._v(".")]),s._v(" "),n("p",[s._v("这个定时任务的作用有:")]),s._v(" "),n("ul",[n("li",[s._v("通过向主节点执行 info 命令, 获取从节点的信息, 因此 Sentinel 节点无需显式配置监控从节点.")]),s._v(" "),n("li",[s._v("当有新的从节点加入时都可以"),n("strong",[s._v("立刻感知")]),s._v("出来.")]),s._v(" "),n("li",[s._v("节点不可达或者故障转移后, 可以通过 info 命令实时"),n("strong",[s._v("更新")]),s._v("节点拓扑信息.")])]),s._v(" "),n("h6",{attrs:{id:"_2-sentinel之间的定时任务"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2-sentinel之间的定时任务"}},[s._v("#")]),s._v(" (2)Sentinel之间的定时任务")]),s._v(" "),n("p",[s._v("每隔 "),n("strong",[s._v("2 秒")]),s._v(", "),n("strong",[s._v("每个 Sentinel 节点")]),s._v("会向 Redis "),n("strong",[s._v("数据节点")]),s._v("的 "),n("strong",[n("strong",[s._v("sentinel")])]),s._v("​**: hello** 频道上发送该 Sentinel 节点对于"),n("strong",[s._v("主节点的判断")]),s._v("以及当前 Sentinel "),n("strong",[s._v("节点的信息")]),s._v(", 同时每个 Sentinel 节点也会"),n("strong",[s._v("订阅该频道")]),s._v(", 来了解其他 Sentinel 节点以及它们对主节点的判断.")]),s._v(" "),n("p",[n("img",{attrs:{src:"https://nano-note.oss-cn-beijing.aliyuncs.com/images/image-20220523213648378.png",alt:""}})]),s._v(" "),n("p",[s._v("这个定时任务的作用:")]),s._v(" "),n("ul",[n("li",[s._v("发现"),n("strong",[s._v("新的 Sentinel 节点")]),s._v(": 通过订阅主节点的 "),n("em",[n("em",[s._v("sentinel")])]),s._v(": hello 了解其他的 Sentinel 节点信息, 如果是新加入的 Sentinel 节点, 将该 Sentinel 节点信息保存起来, 并与该 Sentinel 节点创建连接.")]),s._v(" "),n("li",[s._v("Sentinel 节点之间"),n("strong",[s._v("交换主节点的状态")]),s._v(", 作为后面"),n("strong",[s._v("客观下线")]),s._v("以及"),n("strong",[s._v("领导者选举")]),s._v("的依据.")])]),s._v(" "),n("h6",{attrs:{id:"_3-心跳定时任务"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-心跳定时任务"}},[s._v("#")]),s._v(" (3)心跳定时任务")]),s._v(" "),n("p",[s._v("每隔 "),n("strong",[s._v("1 秒")]),s._v(", 每个 Sentinel 节点会向"),n("strong",[s._v("主节点, 从节点, 其余 Sentinel 节点")]),s._v("发送一条 "),n("strong",[s._v("ping 命令做一次心跳检测")]),s._v(", 来确认这些节点当前"),n("strong",[s._v("是否可达")]),s._v(". 通过上面的定时任务, Sentinel 节点对主节点, 从节点, 其余 Sentinel 节点"),n("strong",[s._v("都建立起连接")]),s._v(", 实现了对"),n("strong",[s._v("每个节点")]),s._v("的监控, 这个定时任务是节点失败判定的重要依据.")]),s._v(" "),n("p",[n("img",{attrs:{src:"https://nano-note.oss-cn-beijing.aliyuncs.com/images/image-20220523213736868.png",alt:""}})]),s._v(" "),n("h5",{attrs:{id:"_2-主观下线与客观下线"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2-主观下线与客观下线"}},[s._v("#")]),s._v(" 2.主观下线与客观下线")]),s._v(" "),n("h6",{attrs:{id:"_1-主观下线"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_1-主观下线"}},[s._v("#")]),s._v(" (1)主观下线")]),s._v(" "),n("p",[n("strong",[s._v("每个 Sentinel 节点")]),s._v("会每隔 1 秒对主节点, 从节点, 其他 Sentinel 节点发送 ping 命令做"),n("strong",[s._v("心跳检测")]),s._v(", 当这些节点超过 down-after-milliseconds "),n("strong",[s._v("没有进行有效回复")]),s._v(", 这个 Sentinel 节点就会对"),n("strong",[s._v("该节点做失败判定")]),s._v(", 这个行为叫做"),n("strong",[s._v("主观下线")]),s._v(".")]),s._v(" "),n("p",[n("img",{attrs:{src:"https://nano-note.oss-cn-beijing.aliyuncs.com/images/image-20220523213813042.png",alt:""}})]),s._v(" "),n("p",[s._v("从字面意思也可以看出主观下线是"),n("strong",[s._v("当前 Sentinel 节点的一家之言")]),s._v(", 存在"),n("strong",[s._v("误判")]),s._v("的可能. 也就是可能就这一个 Sentinel 认为一个结点是下线了.")]),s._v(" "),n("h6",{attrs:{id:"_2-客观下线"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2-客观下线"}},[s._v("#")]),s._v(" (2)客观下线")]),s._v(" "),n("p",[s._v("当 Sentinel 主观下线的节点是"),n("strong",[s._v("主节点")]),s._v("时, 该 Sentinel 节点会通过 "),n("strong",[s._v("sentinel ismaster-down-by-addr")]),s._v(" 命令向其他 Sentinel 节点"),n("strong",[s._v("询问对主节点的判断")]),s._v(", 当"),n("strong",[s._v("超过 <quorum> 个数")]),s._v(", Sentinel 节点认为主节点"),n("strong",[s._v("确实有问题")]),s._v(", 这时该 Sentinel 节点会"),n("strong",[s._v("做出客观下线")]),s._v("的决定, 也就是大部分 Sentinel 节点都对主节点的下线做了同意的判定, 那么这个判定就是"),n("strong",[s._v("客观")]),s._v("的.")]),s._v(" "),n("p",[n("img",{attrs:{src:"https://nano-note.oss-cn-beijing.aliyuncs.com/images/image-20220523213901063.png",alt:""}})]),s._v(" "),n("p",[s._v("注意: "),n("strong",[s._v("从节点, Sentinel 节点在主观下线后, 没有后续的故障转移操作")]),s._v(". "),n("strong",[s._v("只对主节点做故障转移")]),s._v(".")]),s._v(" "),n("h5",{attrs:{id:"_3-领导者sentinel选举"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-领导者sentinel选举"}},[s._v("#")]),s._v(" 3.领导者Sentinel选举")]),s._v(" "),n("p",[s._v("假如 Sentinel 节点对于"),n("strong",[s._v("主节点")]),s._v("已经做了"),n("strong",[s._v("客观下线")]),s._v(", 并不是马上进行故障转移. 实际上"),n("strong",[s._v("故障转移的工作")]),s._v("只需要"),n("strong",[s._v("一个 Sentinel 节点来完成")]),s._v("即可, 所以 Sentinel 节点之间会做一个"),n("strong",[s._v("领导者选举")]),s._v("的工作, 选出一个 Sentinel 节点"),n("strong",[s._v("作为领导者进行故障转移")]),s._v("的工作. Redis 使用了 "),n("strong",[s._v("Raft 算法")]),s._v("实现领导者选举. 大致思路:")]),s._v(" "),n("p",[s._v("(1) 每个在线的 Sentinel 节点都有资格成为领导者, 当它确认主节点主观下线时候, 会向其他 Sentinel 节点发送 sentinel is-master-down-by-addr 命令, 要求"),n("strong",[s._v("将自己")]),s._v("设置为领导者.")]),s._v(" "),n("p",[s._v("(2) 收到命令的 Sentinel 节点, 如果没有同意过其他 Sentinel 节点的 sentinel is-master-down-by-addr 命令, 将"),n("strong",[s._v("同意")]),s._v("该请求, 否则拒绝.")]),s._v(" "),n("p",[s._v("(3) 如果该 Sentinel 节点发现"),n("strong",[s._v("自己的票数已经大于等于 max(quorum, num(sentinels) / 2 + 1)")]),s._v(", 那么它将成为"),n("strong",[s._v("领导者")]),s._v(". 每个 Sentinel 节点只有"),n("strong",[s._v("一票")]),s._v(".")]),s._v(" "),n("p",[s._v("(4) 如果此过程没有选举出领导者, 将进入"),n("strong",[s._v("下一次")]),s._v("选举.")]),s._v(" "),n("p",[n("img",{attrs:{src:"https://nano-note.oss-cn-beijing.aliyuncs.com/images/image-20200725150625390.png",alt:""}})]),s._v(" "),n("p",[s._v("选举的过程非常快, 基本上谁先完成客观下线, 谁就是领导者.")]),s._v(" "),n("h5",{attrs:{id:"_4-故障转移过程"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_4-故障转移过程"}},[s._v("#")]),s._v(" 4.故障转移过程")]),s._v(" "),n("p",[s._v("故障转移过程如下. 故障转移每一步都可以通过"),n("strong",[s._v("发布订阅")]),s._v("来获取.")]),s._v(" "),n("p",[s._v("(1) 加入主节点出现"),n("strong",[s._v("故障")]),s._v(", 此时两个从节点与主节点"),n("strong",[s._v("失去连接")]),s._v(", "),n("strong",[s._v("主从复制失败")]),s._v(".")]),s._v(" "),n("p",[n("img",{attrs:{src:"https://nano-note.oss-cn-beijing.aliyuncs.com/images/image-20220523214205176.png",alt:""}})]),s._v(" "),n("p",[s._v("(2) 每个 Sentinel 节点通过"),n("strong",[s._v("定期监控")]),s._v("发现主节点出现了故障.")]),s._v(" "),n("p",[n("img",{attrs:{src:"https://nano-note.oss-cn-beijing.aliyuncs.com/images/image-20220523214232398.png",alt:""}})]),s._v(" "),n("p",[s._v("(3) 多个 Sentinel 节点对主节点的故障"),n("strong",[s._v("达成一致")]),s._v(", "),n("strong",[s._v("选举出 sentinel-3 节点作为领导者负责故障转移")]),s._v(".")]),s._v(" "),n("p",[n("img",{attrs:{src:"https://nano-note.oss-cn-beijing.aliyuncs.com/images/image-20220523214302088.png",alt:""}})]),s._v(" "),n("p",[s._v("(4) Sentinel 领导者节点执行了"),n("strong",[s._v("故障转移")]),s._v(". 流程如下.")]),s._v(" "),n("p",[n("img",{attrs:{src:"https://nano-note.oss-cn-beijing.aliyuncs.com/images/image-20220523214329887.png",alt:""}})]),s._v(" "),n("p",[s._v("需要在"),n("strong",[s._v("从节点列表")]),s._v("中选出一个节点作为"),n("strong",[s._v("新的主节点")]),s._v(', 选择方法有: (1).过滤 "不健康" 的节点; (2).选择 '),n("strong",[s._v("salve-priority")]),s._v(" 最高的从节点列表; (3).选择**复制偏移量最大(复制数据最完整)**的节点; (4).选择 runid 最小的从节点.")]),s._v(" "),n("ul",[n("li",[s._v("假设这里从节点 1 变成主节点.")]),s._v(" "),n("li",[s._v("Sentinel 领导者节点会对选出来的从节点执行 slaveof no one 命令让其成为"),n("strong",[s._v("主节点")]),s._v(", 此时原来的从节点 1 变成新的主节点.")]),s._v(" "),n("li",[s._v("Sentinel 领导者节点会向"),n("strong",[s._v("剩余的从节点")]),s._v("发送命令, 让它们成为新主节点的从节点, "),n("strong",[s._v("复制规则")]),s._v("和 parallel-syncs 参数有关.")]),s._v(" "),n("li",[s._v("然后 Sentinel 领导者节点"),n("strong",[s._v("通知")]),s._v("客户端.")]),s._v(" "),n("li",[s._v("最后原来的故障主节点"),n("strong",[s._v("重启")]),s._v("成为一个"),n("strong",[s._v("从节点")]),s._v(".")])]),s._v(" "),n("p",[n("strong",[s._v("故障转移后")]),s._v("整个 Redis Sentinel 的"),n("strong",[s._v("拓扑结构图")]),s._v("如下.")]),s._v(" "),n("p",[n("img",{attrs:{src:"https://nano-note.oss-cn-beijing.aliyuncs.com/images/image-20220523214440695.png",alt:""}})]),s._v(" "),n("p",[s._v("整个故障转移过程会产生大量的"),n("strong",[s._v("日志")]),s._v(", 如有需要再看看.")]),s._v(" "),n("h5",{attrs:{id:"_5-节点上下线"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_5-节点上下线"}},[s._v("#")]),s._v(" 5.节点上下线")]),s._v(" "),n("h6",{attrs:{id:"_1-节点下线"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_1-节点下线"}},[s._v("#")]),s._v(" (1)节点下线")]),s._v(" "),n("p",[s._v("对"),n("strong",[s._v("主节点")]),s._v("进行下线, 比较合理的做法是选出一个合适(例如性能更高的机器) 的"),n("strong",[s._v("从节点")]),s._v(", 使用 "),n("strong",[s._v("sentinel failover")]),s._v(" 功能将从节点晋升主节点, 只需要在任意可用的 Sentinel 节点.")]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[s._v("$ sentinel failover "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("master name"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("在"),n("strong",[s._v("任意")]),s._v('一个 Sentinel 节点上执行 "sentinel failover" 即可. 如果需要对'),n("strong",[s._v("从节点或者 Sentinel 节点")]),s._v("进行下线, 只需要确定好是临时还是永久下线后执行相应操作即可.")]),s._v(" "),n("h6",{attrs:{id:"_2-节点上线"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2-节点上线"}},[s._v("#")]),s._v(" (2)节点上线")]),s._v(" "),n("p",[n("strong",[s._v("从节点上线")]),s._v(": 添加 "),n("strong",[s._v("slaveof {masterIp} {masterPort}")]),s._v(" 的配置, 使用 redis-server 启动即可, 它将被 Sentinel 节点"),n("strong",[s._v("自动发现")]),s._v(".")]),s._v(" "),n("p",[n("strong",[s._v("Sentinel 节点上线")]),s._v(": 添加 "),n("strong",[s._v("sentinel monitor")]),s._v(" 主节点的配置, 使用 redis-sentinel 启动即可, 它将被其余 Sentinel 节点"),n("strong",[s._v("自动发现")]),s._v(".")]),s._v(" "),n("h4",{attrs:{id:"高可用读写分离🌟"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#高可用读写分离🌟"}},[s._v("#")]),s._v(" 高可用读写分离🌟")]),s._v(" "),n("p",[s._v("Redis Sentinel 实现"),n("strong",[s._v("读写分离高可用")]),s._v("可以依赖 Sentinel 节点的"),n("strong",[s._v("消息通知")]),s._v(", 获取 Redis 数据节点的"),n("strong",[s._v("状态变化")]),s._v(".")]),s._v(" "),n("p",[n("strong",[s._v("从节点")]),s._v("的作用:")]),s._v(" "),n("ul",[n("li",[s._v("当主节点出现故障时, 作为主节点的后备顶上来实现"),n("strong",[s._v("故障转移")]),s._v(", Redis Sentinel 已经实现了该功能的自动化, 实现了真正的高可用.")]),s._v(" "),n("li",[s._v("扩展主节点的"),n("strong",[s._v("读能力")]),s._v(", 尤其是在"),n("strong",[s._v("读多写少的场景")]),s._v("非常适用.")])]),s._v(" "),n("p",[n("img",{attrs:{src:"https://nano-note.oss-cn-beijing.aliyuncs.com/images/image-20220523214621694.png",alt:""}})]),s._v(" "),n("p",[s._v("但上述模型中, 从节点"),n("strong",[s._v("不是高可用")]),s._v("的, 如果 slave-1 节点"),n("strong",[s._v("出现故障")]),s._v(", 首先客户端 client-1 将与其"),n("strong",[s._v("失联")]),s._v(", 其次 Sentinel 节点只会对该节点做"),n("strong",[s._v("主观下线")]),s._v(", 因为 Redis Sentinel 的"),n("strong",[s._v("故障转移是针对主节点")]),s._v("的.")]),s._v(" "),n("p",[s._v("所以很多时候 Redis Sentinel 中的"),n("strong",[s._v("从节点仅仅是作为主节点一个热备")]),s._v(", 不让它参与客户端的读操作, 就是为了保证整体高可用性, 但实际上这种使用方法还是有一些浪费, 尤其是在有很多从节点或者确实需要读写分离的场景, 所以"),n("strong",[s._v("如何实现从节点的高可用")]),s._v("是非常有必要的.")]),s._v(" "),n("p",[n("strong",[s._v("Redis Sentinel 读写分离设计思路")]),s._v(": Sentinel 在对各个节点的监控中, 如果有对应"),n("strong",[s._v("事件")]),s._v("的发生, 都会发出相应的"),n("strong",[s._v("事件消息")]),s._v(". 在设计 Redis Sentinel 的"),n("strong",[s._v("从节点高可用")]),s._v("时, 只要能够实时掌握"),n("strong",[s._v("所有从节点的状态")]),s._v(", 把所有从节点看做一个"),n("strong",[s._v("资源池")]),s._v(", 无论是上线还是下线从节点, 客户端都能"),n("strong",[s._v("及时感知")]),s._v("到(将其从资源池中添加或者删除), 这样从节点的高可用目标就达到了.")]),s._v(" "),n("p",[n("img",{attrs:{src:"https://nano-note.oss-cn-beijing.aliyuncs.com/images/image-20220523214707545.png",alt:""}})]),s._v(" "),n("p",[s._v("‍")]),s._v(" "),n("h4",{attrs:{id:"参考资料"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#参考资料"}},[s._v("#")]),s._v(" 参考资料")]),s._v(" "),n("ul",[n("li",[s._v("《Redis开发与运维》")])])])}),[],!1,null,null,null);n.default=a.exports}}]);