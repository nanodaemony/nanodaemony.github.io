(window.webpackJsonp=window.webpackJsonp||[]).push([[147],{476:function(s,a,t){"use strict";t.r(a);var n=t(4),e=Object(n.a)({},(function(){var s=this,a=s._self._c;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h1",{attrs:{id:"_505-java性能问题定位分析"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_505-java性能问题定位分析"}},[s._v("#")]),s._v(" 505.Java性能问题定位分析")]),s._v(" "),a("p",[s._v("性能优化一向是后端服务优化的重点, 但是线上性能故障问题不是经常出现, 或者受限于业务产品, 根本就没办法出现性能问题, 包括笔者自己遇到的性能问题也不多, 所以为了提前储备知识, 当出现问题的时候不会手忙脚乱, 这里模拟下常见的几个Java性能故障, 来学习怎么去分析和定位.")]),s._v(" "),a("h4",{attrs:{id:"基础工具"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#基础工具"}},[s._v("#")]),s._v(" 基础工具")]),s._v(" "),a("p",[s._v("既然是"),a("strong",[s._v("定位问题")]),s._v("肯定是需要借助工具, 需要了解一些常用工具.")]),s._v(" "),a("h5",{attrs:{id:"_1-top命令"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-top命令"}},[s._v("#")]),s._v(" 1.top命令")]),s._v(" "),a("p",[a("strong",[s._v("top 命令")]),s._v("使最常用的 Linux 命令之一, 它可以实时的显示当前"),a("strong",[s._v("正在执行的进程的 CPU 使用率")]),s._v(", "),a("strong",[s._v("内存使用率")]),s._v("等系统信息. "),a("strong",[s._v("top -Hp pid")]),s._v(" 可以查看线程的系统资源使用情况.")]),s._v(" "),a("h5",{attrs:{id:"_2-vmstat命令"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-vmstat命令"}},[s._v("#")]),s._v(" 2.vmstat命令")]),s._v(" "),a("p",[s._v("vmstat 是一个指定周期和采集次数的虚拟内存检测工具, 可以统计内存, CPU, swap 的使用情况, 它还有一个重要的常用功能, 用来观察进程的"),a("strong",[s._v("上下文切换")]),s._v(". 字段说明如下:")]),s._v(" "),a("ul",[a("li",[s._v("r: 运行队列中进程数量(当数量大于 CPU 核数表示有阻塞的线程)")]),s._v(" "),a("li",[s._v("b: 等待 IO 的进程数量")]),s._v(" "),a("li",[s._v("swpd: 使用虚拟内存大小")]),s._v(" "),a("li",[s._v("free: 空闲物理内存大小")]),s._v(" "),a("li",[s._v("buff: 用作缓冲的内存大小(内存和硬盘的缓冲区)")]),s._v(" "),a("li",[s._v("cache: 用作缓存的内存大小(CPU 和内存之间的缓冲区)")]),s._v(" "),a("li",[s._v("si: 每秒从交换区写到内存的大小, 由磁盘调入内存")]),s._v(" "),a("li",[s._v("so: 每秒写入交换区的内存大小, 由内存调入磁盘")]),s._v(" "),a("li",[s._v("bi: 每秒读取的块数")]),s._v(" "),a("li",[s._v("bo: 每秒写入的块数")]),s._v(" "),a("li",[s._v("in: 每秒中断数, 包括时钟中断.")]),s._v(" "),a("li",[s._v("cs: 每秒上下文切换数.")]),s._v(" "),a("li",[s._v("us: 用户进程执行时间百分比(user time)")]),s._v(" "),a("li",[s._v("sy: 内核系统进程执行时间百分比(system time)")]),s._v(" "),a("li",[s._v("wa: IO 等待时间百分比")]),s._v(" "),a("li",[s._v("id: 空闲时间百分比")])]),s._v(" "),a("h5",{attrs:{id:"_3-pidstat命令"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-pidstat命令"}},[s._v("#")]),s._v(" 3.pidstat命令")]),s._v(" "),a("p",[a("strong",[s._v("pidstat")]),s._v(" 是 Sysstat 中的一个组件, 也是一款功能强大的性能监测工具, "),a("strong",[s._v("top")]),s._v(" 和 "),a("strong",[s._v("vmstat")]),s._v(" 两个命令都是"),a("strong",[s._v("监测进程的内存")]),s._v(", CPU 以及 I/O 使用情况, 而 "),a("strong",[s._v("pidstat 命令可以检测到线程级别")]),s._v("的. pidstat 命令线程切换字段说明如下:")]),s._v(" "),a("ul",[a("li",[s._v("UID: 被监控任务的真实用户ID.")]),s._v(" "),a("li",[s._v("TGID: 线程组ID.")]),s._v(" "),a("li",[s._v("TID: 线程ID.")]),s._v(" "),a("li",[s._v("cswch/s: 主动切换上下文次数, 这里是因为资源阻塞而切换线程, 比如锁等待等情况.")]),s._v(" "),a("li",[s._v("nvcswch/s: 被动切换上下文次数, 这里指CPU调度切换了线程.")])]),s._v(" "),a("h5",{attrs:{id:"_4-jstack命令"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_4-jstack命令"}},[s._v("#")]),s._v(" 4.jstack命令")]),s._v(" "),a("p",[a("strong",[s._v("jstack")]),s._v(" 是 JDK 工具命令, 它是一种"),a("strong",[s._v("线程堆栈分析")]),s._v("工具, 最常用的功能就是使用 jstack pid 命令查看线程的堆栈信息, 也经常用来"),a("strong",[s._v("排除死锁")]),s._v("情况.")]),s._v(" "),a("h5",{attrs:{id:"_5-jstat命令"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_5-jstat命令"}},[s._v("#")]),s._v(" 5.jstat命令")]),s._v(" "),a("p",[s._v("它可以检测 Java 程序运行的"),a("strong",[s._v("实时情况")]),s._v(", 包括"),a("strong",[s._v("堆内存信息和垃圾回收信息")]),s._v(", 我们常常用来查看程序垃圾回收情况. 常用的命令是"),a("code",[s._v("jstat -gc pid")]),s._v(". 信息字段说明如下:")]),s._v(" "),a("ul",[a("li",[s._v("S0C: 年轻代中 To Survivor 的容量(单位 KB);")]),s._v(" "),a("li",[s._v("S1C: 年轻代中 From Survivor 的容量(单位 KB);")]),s._v(" "),a("li",[s._v("S0U: 年轻代中 To Survivor 目前已使用空间(单位 KB);")]),s._v(" "),a("li",[s._v("S1U: 年轻代中 From Survivor 目前已使用空间(单位 KB);")]),s._v(" "),a("li",[s._v("EC: 年轻代中 Eden 的容量(单位 KB);")]),s._v(" "),a("li",[s._v("EU: 年轻代中 Eden 目前已使用空间(单位 KB);")]),s._v(" "),a("li",[s._v("OC: 老年代的容量(单位 KB);")]),s._v(" "),a("li",[s._v("OU: 老年代目前已使用空间(单位 KB);")]),s._v(" "),a("li",[s._v("MC: 元空间的容量(单位 KB);")]),s._v(" "),a("li",[s._v("MU: 元空间目前已使用空间(单位 KB);")]),s._v(" "),a("li",[s._v("YGC: 从应用程序启动到采样时年轻代中 gc 次数;")]),s._v(" "),a("li",[s._v("YGCT: 从应用程序启动到采样时年轻代中 gc 所用时间 (s);")]),s._v(" "),a("li",[s._v("FGC: 从应用程序启动到采样时 老年代(Full Gc)gc 次数;")]),s._v(" "),a("li",[s._v("FGCT: 从应用程序启动到采样时 老年代代(Full Gc)gc 所用时间 (s);")]),s._v(" "),a("li",[s._v("GCT: 从应用程序启动到采样时 gc 用的总时间 (s).")])]),s._v(" "),a("h5",{attrs:{id:"_6-jmap命令"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_6-jmap命令"}},[s._v("#")]),s._v(" 6.jmap命令")]),s._v(" "),a("p",[s._v("jmap 也是 JDK 工具命令, 可以查看"),a("strong",[s._v("堆内存")]),s._v("的初始化信息以及堆内存的使用情况, 还可以生成 "),a("strong",[s._v("dump 文件")]),s._v("来进行详细分析. 查看堆内存情况命令 "),a("strong",[s._v("jmap -heap pid")]),s._v(". 堆转储.")]),s._v(" "),a("h5",{attrs:{id:"_7-mat内存工具"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_7-mat内存工具"}},[s._v("#")]),s._v(" 7.mat内存工具")]),s._v(" "),a("p",[a("strong",[s._v("MAT")]),s._v("(Memory Analyzer Tool) 工具是 eclipse 的一个插件(MAT 也可以单独使用), 它"),a("strong",[s._v("分析大内存的 dump 文件")]),s._v("时, 可以非常直观的看到各个对象在堆空间中所占用的内存大小, 类实例数量, 对象引用关系, 利用 OQL 对象查询, 以及可以很方便的找出对象 GC Roots 的相关信息.")]),s._v(" "),a("p",[a("strong",[s._v("idea 中也有这么一个插件, 就是 JProfiler")]),s._v(".")]),s._v(" "),a("h4",{attrs:{id:"环境准备"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#环境准备"}},[s._v("#")]),s._v(" 环境准备")]),s._v(" "),a("p",[s._v("基础环境 Jdk1.8, 采用 SpringBoot 框架来写"),a("strong",[s._v("几个接口来触发模拟场景")]),s._v(", 首先是模拟 CPU 占满情况.")]),s._v(" "),a("h4",{attrs:{id:"常见问题分析及定位"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#常见问题分析及定位"}},[s._v("#")]),s._v(" 常见问题分析及定位")]),s._v(" "),a("h5",{attrs:{id:"_1-cpu占满"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-cpu占满"}},[s._v("#")]),s._v(" 1.CPU占满")]),s._v(" "),a("p",[s._v("写一个死循环模拟 CPU 占满即可.")]),s._v(" "),a("div",{staticClass:"language-java line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[a("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[s._v("@GetMapping")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/cpu/loop"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("void")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("testCPULoop")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("throws")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("InterruptedException")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("System")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("out"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("println")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"请求cpu死循环"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Thread")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("currentThread")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("setName")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"loop-thread-cpu"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" num "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("while")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("true")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        num"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("++")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("num "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Integer")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token constant"}},[s._v("MAX_VALUE")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n            "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("System")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("out"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("println")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"reset"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n        num "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br")])]),a("p",[s._v("请求接口地址测试 curl localhost:8080/cpu/loop, 发现 CPU 立马飙升到 100%.")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://nano-note.oss-cn-beijing.aliyuncs.com/images/java-performance1-4239739.png",alt:"java-performance1"}})]),s._v(" "),a("p",[s._v("通过执行 "),a("strong",[s._v("top -Hp 32805")]),s._v(" 查看 Java 线程情况.")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://nano-note.oss-cn-beijing.aliyuncs.com/images/java-performance2-4239754.png",alt:"java-performance2"}})]),s._v(" "),a("p",[s._v("执行 printf '%x' 32826 获取 16 进制的线程 "),a("strong",[s._v("id")]),s._v(", 用于 "),a("strong",[s._v("dump 信息查询")]),s._v(", 结果为 803a. 最后执行 jstack 32805 | grep -A 20 803a 来查看下详细的 dump 信息.")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://nano-note.oss-cn-beijing.aliyuncs.com/images/java-performance3.png",alt:"java-performance3"}})]),s._v(" "),a("p",[s._v("这里 dump 信息直接定位出了问题方法以及代码行, 这就定位出了 "),a("strong",[s._v("CPU 占满")]),s._v("的问题.")]),s._v(" "),a("h5",{attrs:{id:"_2-内存泄露"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-内存泄露"}},[s._v("#")]),s._v(" 2.内存泄露")]),s._v(" "),a("p",[s._v("模拟内存泄漏借助了 "),a("strong",[s._v("ThreadLocal")]),s._v(" 对象来完成, ThreadLocal 是一个线程私有变量, 可以"),a("strong",[s._v("绑定到线程")]),s._v("上, 在整个线程的生命周期都会存在, 但是由于 ThreadLocal 的特殊性, ThreadLocal 是基于 ThreadLocalMap 实现的, ThreadLocalMap 的 Entry 继承 WeakReference, 而 Entry 的 Key 是 WeakReference 的封装, 换句话说 "),a("strong",[s._v("Key 就是弱引用")]),s._v(", 弱引用在下次 GC 之后就会被回收, 如果 "),a("strong",[s._v("ThreadLocal 在 set 之后不进行后续的操作")]),s._v(", 因为 "),a("strong",[s._v("GC 会把 Key 清除掉, 但是 Value 由于线程还在存活, 所以 Value 一直不会被回收, 最后就会发生内存泄漏")]),s._v(".")]),s._v(" "),a("div",{staticClass:"language-java line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("/**\n * 模拟内存泄漏\n */")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[s._v("@GetMapping")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("value "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/memory/leak"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("String")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("leak")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("System")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("out"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("println")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"模拟内存泄漏"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("ThreadLocal")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Byte")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" localVariable "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("new")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("ThreadLocal")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Byte")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    localVariable"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("set")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("new")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Byte")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4096")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1024")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 为线程添加变量")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"ok"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br")])]),a("p",[s._v("给启动加上"),a("strong",[s._v("堆内存大小限制")]),s._v(", 同时设置内存溢出的时候输出"),a("strong",[s._v("堆栈快照")]),s._v("并输出日志.")]),s._v(" "),a("div",{staticClass:"language-java line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[s._v("java "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("jar "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Xms500m")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Xmx500m")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),a("span",{pre:!0,attrs:{class:"token constant"}},[s._v("XX")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("HeapDumpOnOutOfMemoryError")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),a("span",{pre:!0,attrs:{class:"token constant"}},[s._v("XX")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("HeapDumpPath")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("tmp"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("heapdump"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("hprof "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),a("span",{pre:!0,attrs:{class:"token constant"}},[s._v("XX")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("PrintGCTimeStamps")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),a("span",{pre:!0,attrs:{class:"token constant"}},[s._v("XX")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("PrintGCDetails")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Xloggc")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("tmp"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("heaplog"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("log analysis"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("demo"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.0")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".1")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),a("span",{pre:!0,attrs:{class:"token constant"}},[s._v("SNAPSHOT")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("jar\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("启动成功后循环执行 100 次.")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token for-or-select variable"}},[s._v("i")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("500")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("do")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("curl")]),s._v(" localhost:8080/memory/leak"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("done")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("还没执行完毕, 系统已经返回 500 错误了. 查看系统日志出现了如下异常:")]),s._v(" "),a("div",{staticClass:"language-java line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[a("span",{pre:!0,attrs:{class:"token class-name"}},[a("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("java"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("lang"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")])]),s._v("OutOfMemoryError")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Java")]),s._v(" heap space\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("用 jstat -gc pid 命令来看看程序的 GC 情况.")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://nano-note.oss-cn-beijing.aliyuncs.com/images/java-performance4-1604832.png",alt:"java-performance4-1604832"}})]),s._v(" "),a("p",[s._v("很明显内存溢出了, 堆内存经过 45 次 Full Gc 之后都没释放出可用内存, 这说明当前堆内存中的对象都是"),a("strong",[s._v("存活")]),s._v("的, 有 GC Roots 引用, 无法回收. 那是什么原因导致内存溢出呢? 是不是只要加大内存就行了呢? 如果是普通的内存溢出也许扩大内存就行了, 但是如果是内存泄漏的话, 扩大的内存不一会就会被占满, 所以还需要确定"),a("strong",[s._v("是不是内存泄漏")]),s._v(". 之前保存了堆 Dump 文件, 这个时候借助 MAT 工具来分析下. 导入工具选择 Leak Suspects Report, 工具直接就会列出问题报告.")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://nano-note.oss-cn-beijing.aliyuncs.com/images/java-performance5-1604840-4239820.png",alt:""}})]),s._v(" "),a("p",[s._v("这里已经列出了可疑的 4 个内存泄漏问题, 点击其中一个查看详情.")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://nano-note.oss-cn-beijing.aliyuncs.com/images/java-performance6-4239851.png",alt:""}})]),s._v(" "),a("p",[s._v("这里已经指出了内存被线程占用了接近 50M 的内存, 占用的对象就是 ThreadLocal. 如果想详细的通过手动去分析的话, 可以点击 Histogram, 查看最大的对象占用是谁, 然后再分析它的引用关系, 即可确定是谁导致的内存溢出.")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://nano-note.oss-cn-beijing.aliyuncs.com/images/java-performance7.png",alt:"java-performance7"}})]),s._v(" "),a("p",[s._v("上图发现占用内存最大的对象是一个 "),a("strong",[s._v("Byte 数组")]),s._v(", 看看它到底被哪个 GC Root "),a("strong",[s._v("引用")]),s._v("导致没有被回收. 按照上图红框操作指引, 结果如下图:")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://nano-note.oss-cn-beijing.aliyuncs.com/images/java-performance8-4239891.png",alt:"java-performance8"}})]),s._v(" "),a("p",[s._v("Byte 数组是被"),a("strong",[s._v("线程对象引用的")]),s._v(", 图中也标明, Byte 数组对像的 GC Root 是线程, 所以它是"),a("strong",[s._v("不会被回收")]),s._v("的, 展开详细信息查看, 发现最终的内存占用对象是被 ThreadLocal 对象占据了. 这也和 "),a("strong",[s._v("MAT 工具")]),s._v("自动分析的结果一致.")]),s._v(" "),a("h5",{attrs:{id:"_3-死锁"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-死锁"}},[s._v("#")]),s._v(" 3.死锁")]),s._v(" "),a("p",[s._v("死锁会导致耗尽线程资源, 占用内存, 表现就是"),a("strong",[s._v("内存占用升高")]),s._v(", CPU 不一定会飙升(看场景决定), 如果是直接 new 线程, 会导致 JVM 内存被耗尽, 报无法创建线程的错误, 这也是体现了使用线程池的好处.")]),s._v(" "),a("div",{staticClass:"language-java line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 线程池")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("ExecutorService")]),s._v(" service \n    "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("new")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("ThreadPoolExecutor")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("TimeUnit")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token constant"}},[s._v("SECONDS")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" \n                             "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("new")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("LinkedBlockingQueue")]),a("span",{pre:!0,attrs:{class:"token generics"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Runnable")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1024")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n                             "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Executors")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("defaultThreadFactory")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n                             "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("new")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("ThreadPoolExecutor"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("AbortPolicy")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("/**\n * 模拟死锁\n */")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[s._v("@GetMapping")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/cpu/test"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("String")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("testCPU")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("throws")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("InterruptedException")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("System")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("out"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("println")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"请求cpu"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Object")]),s._v(" lock1 "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("new")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Object")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Object")]),s._v(" lock2 "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("new")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Object")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    service"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("submit")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("new")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("DeadLockThread")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("lock1"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" lock2"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"deadLookThread-"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("new")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Random")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("nextInt")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    service"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("submit")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("new")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("DeadLockThread")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("lock2"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" lock1"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"deadLookThread-"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("new")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Random")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("nextInt")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"ok"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("class")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("DeadLockThread")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("implements")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Runnable")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("private")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Object")]),s._v(" lock1"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("private")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Object")]),s._v(" lock2"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("DeadLockThread1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Object")]),s._v(" lock1"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Object")]),s._v(" lock2"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("this")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("lock1 "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" lock1"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("this")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("lock2 "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" lock2"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[s._v("@Override")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("void")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("run")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("synchronized")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("lock2"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n            "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("System")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("out"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("println")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Thread")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("currentThread")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("getName")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"get lock2 and wait lock1"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n            "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("try")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n                "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("TimeUnit")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token constant"}},[s._v("MILLISECONDS")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sleep")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2000")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n            "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("catch")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("InterruptedException")]),s._v(" e"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n                e"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("printStackTrace")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n            "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n            "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("synchronized")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("lock1"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n                "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("System")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("out"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("println")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Thread")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("currentThread")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("getName")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"get lock1 and lock2 "')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n            "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br"),a("span",{staticClass:"line-number"},[s._v("33")]),a("br"),a("span",{staticClass:"line-number"},[s._v("34")]),a("br"),a("span",{staticClass:"line-number"},[s._v("35")]),a("br"),a("span",{staticClass:"line-number"},[s._v("36")]),a("br"),a("span",{staticClass:"line-number"},[s._v("37")]),a("br"),a("span",{staticClass:"line-number"},[s._v("38")]),a("br"),a("span",{staticClass:"line-number"},[s._v("39")]),a("br"),a("span",{staticClass:"line-number"},[s._v("40")]),a("br"),a("span",{staticClass:"line-number"},[s._v("41")]),a("br"),a("span",{staticClass:"line-number"},[s._v("42")]),a("br"),a("span",{staticClass:"line-number"},[s._v("43")]),a("br")])]),a("p",[s._v("循环请求接口 2000 次, 发现不一会系统就出现了日志错误, 线程池和队列都满了, 由于选择的当队列满了就拒绝的策略, 所以系统直接抛出异常.")]),s._v(" "),a("div",{staticClass:"language-java line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[a("span",{pre:!0,attrs:{class:"token class-name"}},[a("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("java"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("util"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("concurrent"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")])]),s._v("RejectedExecutionException")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Task")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[a("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("java"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("util"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("concurrent"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")])]),s._v("FutureTask")]),a("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[s._v("@2760298")]),s._v(" rejected from "),a("span",{pre:!0,attrs:{class:"token class-name"}},[a("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("java"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("util"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("concurrent"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")])]),s._v("ThreadPoolExecutor")]),a("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[s._v("@7ea7cd51")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Running")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" pool size "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" active threads "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" queued tasks "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1024")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" completed tasks "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("846")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("通过 "),a("strong",[s._v("ps -ef|grep java")]),s._v(" 命令找出 Java 进程 pid, 执行 jstack pid 即可出现 Java 线程堆栈信息, 这里发现了 5 个死锁, 只列出其中一个, 很明显线程 "),a("strong",[s._v("pool-1-thread-2")]),s._v(" 锁住了 0x00000000f8387d88 等待 0x00000000f8387d98 锁, 线程 pool-1-thread-1 锁住了 0x00000000f8387d98 等待锁 0x00000000f8387d88, 这就产生了死锁.")]),s._v(" "),a("div",{staticClass:"language-java line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Java")]),s._v(" stack information "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" the threads listed above"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"pool-1-thread-2"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v("\n        at "),a("span",{pre:!0,attrs:{class:"token class-name"}},[a("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("top"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("luozhou"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("analysisdemo"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("controller"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")])]),s._v("DeadLockThread2")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("run")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("DeadLockThread")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("java"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("30")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v(" waiting "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("to")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("lock")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token generics"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),s._v("0x00000000f8387d98"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("a "),a("span",{pre:!0,attrs:{class:"token class-name"}},[a("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("java"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("lang"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")])]),s._v("Object")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v(" locked "),a("span",{pre:!0,attrs:{class:"token generics"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),s._v("0x00000000f8387d88"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("a "),a("span",{pre:!0,attrs:{class:"token class-name"}},[a("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("java"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("lang"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")])]),s._v("Object")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n        at "),a("span",{pre:!0,attrs:{class:"token class-name"}},[a("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("java"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("util"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("concurrent"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")])]),s._v("Executors")]),s._v("$"),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("RunnableAdapter")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("call")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Executors")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("java"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("511")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n        at "),a("span",{pre:!0,attrs:{class:"token class-name"}},[a("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("java"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("util"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("concurrent"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")])]),s._v("FutureTask")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("run")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("FutureTask")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("java"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("266")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n        at "),a("span",{pre:!0,attrs:{class:"token class-name"}},[a("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("java"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("util"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("concurrent"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")])]),s._v("ThreadPoolExecutor")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("runWorker")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("ThreadPoolExecutor")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("java"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1149")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n        at "),a("span",{pre:!0,attrs:{class:"token class-name"}},[a("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("java"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("util"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("concurrent"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")])]),s._v("ThreadPoolExecutor")]),s._v("$"),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Worker")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("run")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("ThreadPoolExecutor")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("java"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("624")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n        at "),a("span",{pre:!0,attrs:{class:"token class-name"}},[a("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("java"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("lang"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")])]),s._v("Thread")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("run")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Thread")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("java"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("748")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"pool-1-thread-1"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v("\n        at "),a("span",{pre:!0,attrs:{class:"token class-name"}},[a("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("top"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("luozhou"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("analysisdemo"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("controller"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")])]),s._v("DeadLockThread1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("run")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("DeadLockThread")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("java"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("30")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v(" waiting "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("to")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("lock")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token generics"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),s._v("0x00000000f8387d88"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("a "),a("span",{pre:!0,attrs:{class:"token class-name"}},[a("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("java"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("lang"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")])]),s._v("Object")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v(" locked "),a("span",{pre:!0,attrs:{class:"token generics"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),s._v("0x00000000f8387d98"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("a "),a("span",{pre:!0,attrs:{class:"token class-name"}},[a("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("java"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("lang"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")])]),s._v("Object")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n        at "),a("span",{pre:!0,attrs:{class:"token class-name"}},[a("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("java"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("util"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("concurrent"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")])]),s._v("Executors")]),s._v("$"),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("RunnableAdapter")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("call")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Executors")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("java"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("511")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n        at "),a("span",{pre:!0,attrs:{class:"token class-name"}},[a("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("java"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("util"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("concurrent"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")])]),s._v("FutureTask")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("run")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("FutureTask")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("java"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("266")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n        at "),a("span",{pre:!0,attrs:{class:"token class-name"}},[a("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("java"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("util"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("concurrent"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")])]),s._v("ThreadPoolExecutor")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("runWorker")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("ThreadPoolExecutor")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("java"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1149")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n        at "),a("span",{pre:!0,attrs:{class:"token class-name"}},[a("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("java"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("util"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("concurrent"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")])]),s._v("ThreadPoolExecutor")]),s._v("$"),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Worker")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("run")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("ThreadPoolExecutor")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("java"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("624")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n        at "),a("span",{pre:!0,attrs:{class:"token class-name"}},[a("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("java"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("lang"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")])]),s._v("Thread")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("run")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Thread")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("java"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("748")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n          \n "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Found")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),s._v(" deadlocks"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br")])]),a("h5",{attrs:{id:"_4-线程频繁切换"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_4-线程频繁切换"}},[s._v("#")]),s._v(" 4.线程频繁切换")]),s._v(" "),a("p",[s._v("上下文切换会导致将大量 CPU 时间浪费在"),a("strong",[s._v("寄存器, 内核栈以及虚拟内存的保存和恢复")]),s._v("上, 导致系统整体性能下降. 当发现系统的性能出现明显的下降时候, 需要考虑是否发生了大量的线程上下文切换.")]),s._v(" "),a("div",{staticClass:"language-java line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[a("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[s._v("@GetMapping")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("value "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/thread/swap"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("String")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("theadSwap")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" num"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("System")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("out"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("println")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"模拟线程切换"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" i "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" i "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v(" num"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" i"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("++")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("new")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Thread")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("new")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("ThreadSwap1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("new")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("AtomicInteger")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"thread-swap"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),s._v("i"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("start")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"ok"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("class")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("ThreadSwap1")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("implements")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Runnable")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("private")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("AtomicInteger")]),s._v(" integer"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("ThreadSwap1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("AtomicInteger")]),s._v(" integer"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("this")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("integer "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" integer"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[s._v("@Override")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("void")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("run")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("while")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("true")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n            integer"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("addAndGet")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n            "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Thread")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("yield")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 让出CPU资源")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br")])]),a("p",[s._v("这里创建多个线程去执行基础的"),a("strong",[s._v("原子+1")]),s._v("操作, 然后让出 CPU 资源, 理论上 CPU 就会去调度别的线程, 我们请求接口创建 100 个线程看看效果如何, curl localhost:8080/thread/swap?num=100. 接口请求成功后, 执行 "),a("strong",[s._v("vmstat 1 10")]),s._v(", 表示每 1 秒打印一次, 打印 10 次, 线程切换采集结果如下:")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("procs -----------memory---------- ---swap-- -----io---- -system-- ------cpu-----\nr  b   swpd   "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("free")]),s._v("   buff  cache   si   so    bi    bo   "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v("   cs us sy "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("id")]),s._v(" wa st\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("101")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("128000")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("878384")]),s._v("    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("908")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("468684")]),s._v("    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("     "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("     "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4071")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("8110498")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("14")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("86")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("100")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("128000")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("878384")]),s._v("    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("908")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("468684")]),s._v("    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("     "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("     "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4065")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("8312463")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("15")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("85")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("100")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("128000")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("878384")]),s._v("    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("908")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("468684")]),s._v("    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("     "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("     "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4107")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("8207718")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("14")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("87")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("100")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("128000")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("878384")]),s._v("    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("908")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("468684")]),s._v("    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("     "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("     "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4083")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("8410174")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("14")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("86")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("100")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("128000")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("878384")]),s._v("    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("908")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("468684")]),s._v("    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("     "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("     "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4083")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("8264377")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("14")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("86")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("100")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("128000")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("878384")]),s._v("    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("908")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("468688")]),s._v("    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("     "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("108")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4182")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("8346826")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("14")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("86")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br")])]),a("p",[s._v("这里关注 4 个指标, "),a("strong",[s._v("r, cs, us, sy. ​")])]),s._v(" "),a("p",[a("strong",[s._v("r=100")]),s._v(", 说明等待的进程数量是 100, 线程有阻塞.")]),s._v(" "),a("p",[a("strong",[s._v("cs=800多万")]),s._v(", 说明"),a("strong",[s._v("每秒上下文切换了 800")]),s._v(" 多万次, 这个数字相当大了.")]),s._v(" "),a("p",[a("strong",[s._v("us=14")]),s._v(", 说明用户态占用了 14% 的 CPU 时间片去处理逻辑.")]),s._v(" "),a("p",[a("strong",[s._v("sy=86")]),s._v(", 说明内核态占用了 86% 的 CPU, 这里明显就是做上下文切换工作了.")]),s._v(" "),a("p",[s._v("通过 "),a("strong",[s._v("top 命令")]),s._v("以及 top -Hp pid 查看进程和线程 CPU 情况, 发现 Java "),a("strong",[s._v("线程 CPU 占满")]),s._v("了, 但是线程 CPU 使用情况很平均, 没有某一个线程把 CPU 吃满的情况.")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("PID "),a("span",{pre:!0,attrs:{class:"token environment constant"}},[s._v("USER")]),s._v("      PR  NI    VIRT    RES    SHR S  %CPU %MEM     TIME+ COMMAND                                                                            \n "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("87093")]),s._v(" root      "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("20")]),s._v("   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4194788")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("299056")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("13252")]),s._v(" S "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("399.7")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("16.1")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("65")]),s._v(":34.67 "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("java")]),s._v(" \n PID "),a("span",{pre:!0,attrs:{class:"token environment constant"}},[s._v("USER")]),s._v("      PR  NI    VIRT    RES    SHR S %CPU %MEM     TIME+ COMMAND                                                                             \n "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("87189")]),s._v(" root      "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("20")]),s._v("   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4194788")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("299056")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("13252")]),s._v(" R  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4.7")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("16.1")]),s._v("   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(":41.11 "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("java")]),s._v("                                    \n "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("87129")]),s._v(" root      "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("20")]),s._v("   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4194788")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("299056")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("13252")]),s._v(" R  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4.3")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("16.1")]),s._v("   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(":41.14 "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("java")]),s._v("                                                                                \n "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("87130")]),s._v(" root      "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("20")]),s._v("   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4194788")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("299056")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("13252")]),s._v(" R  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4.3")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("16.1")]),s._v("   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(":40.51 "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("java")]),s._v("                                                                                \n "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("87133")]),s._v(" root      "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("20")]),s._v("   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4194788")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("299056")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("13252")]),s._v(" R  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4.3")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("16.1")]),s._v("   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(":40.59 "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("java")]),s._v("                                                                                \n "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("87134")]),s._v(" root      "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("20")]),s._v("   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4194788")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("299056")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("13252")]),s._v(" R  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4.3")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("16.1")]),s._v("   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(":40.95 "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("java")]),s._v(" \n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br")])]),a("p",[s._v("结合上面用户态 CPU 只使用了 14%, 内核态 CPU 占用了 86%, 可以基本判断是 Java 程序线程"),a("strong",[s._v("上下文切换")]),s._v("导致性能问题.")]),s._v(" "),a("p",[s._v("使用 "),a("strong",[s._v("pidstat")]),s._v(" 命令来看看 Java 进程内部的线程切换数据, 执行 "),a("strong",[s._v("pidstat -p 87093 -w 1 10")]),s._v(", 采集数据如下:")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token number"}},[s._v("11")]),s._v(":04:30 PM   "),a("span",{pre:!0,attrs:{class:"token environment constant"}},[s._v("UID")]),s._v("       TGID       TID   cswch/s nvcswch/s  Command\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("11")]),s._v(":04:30 PM     "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("         -     "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("87128")]),s._v("      "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.00")]),s._v("     "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("16.07")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("__java\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("11")]),s._v(":04:30 PM     "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("         -     "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("87129")]),s._v("      "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.00")]),s._v("     "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("15.60")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("__java\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("11")]),s._v(":04:30 PM     "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("         -     "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("87130")]),s._v("      "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.00")]),s._v("     "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("15.54")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("__java\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("11")]),s._v(":04:30 PM     "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("         -     "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("87131")]),s._v("      "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.00")]),s._v("     "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("15.60")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("__java\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("11")]),s._v(":04:30 PM     "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("         -     "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("87132")]),s._v("      "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.00")]),s._v("     "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("15.43")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("__java\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("11")]),s._v(":04:30 PM     "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("         -     "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("87133")]),s._v("      "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.00")]),s._v("     "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("16.02")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("__java\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("11")]),s._v(":04:30 PM     "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("         -     "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("87134")]),s._v("      "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.00")]),s._v("     "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("15.66")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("__java\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("11")]),s._v(":04:30 PM     "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("         -     "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("87135")]),s._v("      "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.00")]),s._v("     "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("15.23")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("__java\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("11")]),s._v(":04:30 PM     "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("         -     "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("87136")]),s._v("      "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.00")]),s._v("     "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("15.33")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("__java\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("11")]),s._v(":04:30 PM     "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("         -     "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("87137")]),s._v("      "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.00")]),s._v("     "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("16.04")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("__java\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br")])]),a("p",[s._v("根据上面采集的信息可以知道 Java 的线程每秒切换 15 次左右, "),a("strong",[s._v("正常情况下, 应该是个位数或者小数")]),s._v(". 结合这些信息可以断定 Java 线程开启过多, 导致频繁上下文切换, 从而影响了整体性能.")]),s._v(" "),a("p",[a("strong",[s._v("为什么系统的上下文切换是每秒 800 多万, 而 Java 进程中的某一个线程切换才 15 次左右? ​")])]),s._v(" "),a("p",[s._v("系统上下文切换分为三种情况:")]),s._v(" "),a("p",[s._v("1, 多任务: 在多任务环境中, 一个进程被切换出 CPU, 运行另外一个进程, 这里会发生上下文切换.")]),s._v(" "),a("p",[s._v("2, 中断处理: 发生中断时, 硬件会切换上下文. 在 vmstat 命令中是 in.")]),s._v(" "),a("p",[s._v("3, 用户和内核模式切换: 当操作系统中需要在用户模式和内核模式之间进行转换时, 需要进行上下文切换, 比如进行系统函数调用.")]),s._v(" "),a("p",[s._v("Linux 为每个 CPU 维护了一个"),a("strong",[s._v("就绪队列")]),s._v(", 将活跃进程按照优先级和等待 CPU 的时间排序, 然后选择最需要 CPU 的进程, 也就是优先级最高和等待 CPU 时间最长的进程来运行. 也就是 vmstat 命令中的 "),a("strong",[s._v("r")]),s._v(".")]),s._v(" "),a("p",[s._v("那么, 进程在什么时候才会被"),a("strong",[s._v("调度到 CPU 上运行")]),s._v("?")]),s._v(" "),a("ul",[a("li",[s._v("进程执行完终止了, 它之前使用的 CPU 会释放出来, 这时再从就绪队列中拿一个新的进程来运行.")]),s._v(" "),a("li",[s._v("为了保证所有进程可以得到公平调度, CPU 时间被划分为一段段的时间片, 这些时间片被轮流分配给各个进程. 当某个进程时间片耗尽了就会被系统挂起, 切换到其它等待 CPU 的进程运行.")]),s._v(" "),a("li",[s._v("进程在系统资源不足时, 要等待资源满足后才可以运行, 这时进程也会被挂起, 并由系统调度其它进程运行.")]),s._v(" "),a("li",[s._v("当进程通过睡眠函数 sleep 主动挂起时, 也会重新调度.")]),s._v(" "),a("li",[s._v("当有优先级更高的进程运行时, 为了保证高优先级进程的运行, 当前进程会被挂起, 由高优先级进程来运行.")]),s._v(" "),a("li",[s._v("发生硬件中断时, CPU 上的进程会被中断挂起, 转而执行内核中的中断服务程序.")])]),s._v(" "),a("p",[s._v("结合之前的内容分析, 阻塞的就绪队列是 100 左右, 而 CPU 只有 4 核, 这部分原因造成的上下文切换就可能会相当高, 再加上中断次数是 4000 左右和系统的函数调用等, 整个系统的上下文切换到 800 万也不足为奇了. Java 内部的线程切换才 15 次, 是因为线程使用 "),a("strong",[s._v("Thread.yield()")]),s._v(" 来让出 CPU 资源, 但是 CPU 有可能继续调度该线程, 这个时候"),a("strong",[s._v("线程之间并没有切换")]),s._v(", 这也是为什么内部的某个线程切换次数并不是非常大的原因.")]),s._v(" "),a("p",[s._v("‍")]),s._v(" "),a("p",[s._v("‍")]),s._v(" "),a("h4",{attrs:{id:"参考资料"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#参考资料"}},[s._v("#")]),s._v(" 参考资料")]),s._v(" "),a("p",[s._v("1, "),a("a",{attrs:{href:"https://linux.die.net/man/1/pidstat",target:"_blank",rel:"noopener noreferrer"}},[s._v("https://linux.die.net/man/1/pidstat"),a("OutboundLink")],1)]),s._v(" "),a("p",[s._v("2, "),a("a",{attrs:{href:"https://linux.die.net/man/8/vmstat",target:"_blank",rel:"noopener noreferrer"}},[s._v("https://linux.die.net/man/8/vmstat"),a("OutboundLink")],1)]),s._v(" "),a("p",[s._v("3, "),a("a",{attrs:{href:"https://help.eclipse.org/2020-03/index.jsp?topic=/org.eclipse.mat.ui.help/welcome.html",target:"_blank",rel:"noopener noreferrer"}},[s._v("https://help.eclipse.org/2020-03/index.jsp?topic=/org.eclipse.mat.ui.help/welcome.html"),a("OutboundLink")],1)]),s._v(" "),a("p",[s._v("4, "),a("a",{attrs:{href:"https://www.linuxblogs.cn/articles/18120200.html",target:"_blank",rel:"noopener noreferrer"}},[s._v("https://www.linuxblogs.cn/articles/18120200.html"),a("OutboundLink")],1)]),s._v(" "),a("p",[s._v("5, "),a("a",{attrs:{href:"https://www.tutorialspoint.com/what-is-context-switching-in-operating-system",target:"_blank",rel:"noopener noreferrer"}},[s._v("https://www.tutorialspoint.com/what-is-context-switching-in-operating-system"),a("OutboundLink")],1)])])}),[],!1,null,null,null);a.default=e.exports}}]);