(window.webpackJsonp=window.webpackJsonp||[]).push([[159],{469:function(s,t,n){"use strict";n.r(t);var a=n(7),e=Object(a.a)({},(function(){var s=this,t=s._self._c;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("h1",{attrs:{id:"_33-redis哨兵"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_33-redis哨兵"}},[s._v("#")]),s._v(" 33.Redis哨兵")]),s._v(" "),t("h4",{attrs:{id:"sentinel架构基础🌟"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#sentinel架构基础🌟"}},[s._v("#")]),s._v(" Sentinel架构基础🌟")]),s._v(" "),t("h5",{attrs:{id:"_1-普通主从复制的问题"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-普通主从复制的问题"}},[s._v("#")]),s._v(" 1.普通主从复制的问题")]),s._v(" "),t("p",[t("strong",[s._v("主从复制")]),s._v("存在以下问题:")]),s._v(" "),t("ul",[t("li",[s._v("一旦主节点"),t("strong",[s._v("出现故障")]),s._v(", 需要手动将一个从节点晋升为主节点, 同时需要修改应用方的主节点地址, 还需要命令其他从节点去复制新的主节点, 整个过程需要"),t("strong",[s._v("人工干预")]),s._v(".")]),s._v(" "),t("li",[s._v("主节点的"),t("strong",[s._v("写能力")]),s._v("受到单机的限制, 主节点的"),t("strong",[s._v("存储能力")]),s._v("受到单机的限制.")])]),s._v(" "),t("p",[s._v("这一点也"),t("strong",[s._v("不高可用")]),s._v(".")]),s._v(" "),t("h5",{attrs:{id:"_2-sentinel架构"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-sentinel架构"}},[s._v("#")]),s._v(" 2.Sentinel架构")]),s._v(" "),t("p",[s._v("Redis Sentinel 是一个"),t("strong",[s._v("分布式架构")]),s._v(", 其中包含"),t("strong",[s._v("若干个 Sentinel 节点")]),s._v("和 Redis 数据节点, 每个 Sentinel 节点会对数据节点和"),t("strong",[s._v("其余")]),s._v(" Sentinel 节点进行监控, 当它发现节点不可达时, 会对节点做"),t("strong",[s._v("下线标识")]),s._v(". 如果被标识的是"),t("strong",[s._v("主节点")]),s._v(', 它还会和其他 Sentinel 节点进行 "'),t("strong",[s._v("协商")]),s._v('", 当大多数 Sentinel 节点'),t("strong",[s._v("都认为主节点不可达")]),s._v("时, 它们会"),t("strong",[s._v("选举出一个 Sentinel 节点")]),s._v("来完成"),t("strong",[s._v("自动故障转移")]),s._v("的工作, 同时会将这个变化"),t("strong",[s._v("实时通知")]),s._v("给客户端.")]),s._v(" "),t("p",[s._v("Sentinel 哨兵是特殊的 Redis 服务, 不提供读写服务, 主要用来监控 Redis 实例节点. 主节点出现故障时, "),t("strong",[s._v("Redis Sentinel")]),s._v(" 能"),t("strong",[s._v("自动完成故障发现和故障转移")]),s._v(", 并"),t("strong",[s._v("通知应用方")]),s._v(", 整个过程完全是"),t("strong",[s._v("自动")]),s._v("的, 不需要人工来介入, 从而实现真正的"),t("strong",[s._v("高可用")]),s._v(".")]),s._v(" "),t("p",[s._v("Redis Sentinel 与 Redis 主从复制的架构相比较"),t("strong",[s._v("只是多了若干 Sentinel 节点")]),s._v(", 所以 Redis Sentinel "),t("strong",[s._v("并没有")]),s._v("针对 Redis 节点做特殊处理.")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://nano-note.oss-cn-beijing.aliyuncs.com/images/image-20211218185927434.png",alt:""}})]),s._v(" "),t("p",[t("strong",[s._v("Sentinel 节点本身就是独立的 Redis 节点, 只不过它们有一些特殊, 它们不存储数据, 只支持部分命令")]),s._v(". Sentinel 节点集合会定期对"),t("strong",[s._v("所有节点")]),s._v("进行监控, 特别是对主节点的"),t("strong",[s._v("故障实现自动转移")]),s._v(".")]),s._v(" "),t("p",[s._v("Redis Sentinel 同时包含了"),t("strong",[s._v("若个 Sentinel 节点")]),s._v(", 这样做有如下好处:")]),s._v(" "),t("ul",[t("li",[s._v("节点"),t("strong",[s._v("故障判断")]),s._v("由多个 Sentinel 节点"),t("strong",[s._v("共同完成")]),s._v(", 可以"),t("strong",[s._v("防止误判")]),s._v(".")]),s._v(" "),t("li",[s._v("Sentinel 节点集合由若干个 Sentinel 节点组成, 即使个别 Sentinel 节点不可用, 整个 Sentinel 节点集合依然是健壮的, 防止 Sentinel 出现单点故障.")])]),s._v(" "),t("h5",{attrs:{id:"_3-sentinel的功能"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-sentinel的功能"}},[s._v("#")]),s._v(" 3.Sentinel的功能")]),s._v(" "),t("p",[s._v("Redis Sentinel 具有以下几个功能:")]),s._v(" "),t("ul",[t("li",[t("strong",[s._v("监控")]),s._v(": Sentinel 节点会定期检测 Redis 数据节点以及其余 Sentinel 节点是否可达.")]),s._v(" "),t("li",[t("strong",[s._v("通知")]),s._v(": Sentinel 节点会将故障转移的结果通知给应用方.")]),s._v(" "),t("li",[t("strong",[s._v("主节点故障转移")]),s._v(": 实现从节点晋升为主节点并维护后续正确的主从关系.")]),s._v(" "),t("li",[t("strong",[s._v("配置提供者")]),s._v(": 在 Sentinel 结构中, 客户端初始化时连接的是 Sentinel 节点"),t("strong",[s._v("集合")]),s._v(", 从中获取主节点信息.")])]),s._v(" "),t("h4",{attrs:{id:"sentinel部署与配置"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#sentinel部署与配置"}},[s._v("#")]),s._v(" Sentinel部署与配置")]),s._v(" "),t("p",[s._v("部署实操可以看看 Sentinel 架构的部署过程: "),t("a",{attrs:{href:"https://blog.csdn.net/cuiwjava/article/details/98844949",target:"_blank",rel:"noopener noreferrer"}},[s._v("https://blog.csdn.net/cuiwjava/article/details/98844949"),t("OutboundLink")],1)]),s._v(" "),t("h5",{attrs:{id:"_1-配置参数"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-配置参数"}},[s._v("#")]),s._v(" 1.配置参数")]),s._v(" "),t("p",[s._v("Redis 安装目录下有一个 "),t("strong",[s._v("sentinel.conf")]),s._v(", 是默认的 Sentinel 节点"),t("strong",[s._v("配置文件")]),s._v(".")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("port "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("26379")]),s._v("\t"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 端口")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("dir")]),s._v(" /opt/soft/redis/data  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 工作目录")]),s._v("\nsentinel monitor mymaster "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1 "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("6379")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("\t"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 配置主节点地址端口, 不可达票数为2")]),s._v("\nsentinel down-after-milliseconds mymaster "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("30000")]),s._v("\nsentinel parallel-syncs mymaster "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\nsentinel failover-timeout mymaster "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("180000")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#sentinel auth-pass <master-name> <password>")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#sentinel notification-script <master-name> <script-path>")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#sentinel client-reconfig-script <master-name> <script-path>")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br")])]),t("p",[t("strong",[s._v("① sentinel monitor")])]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("$ sentinel monitor "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("master-name"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("ip"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("port"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("quorum"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("Sentinel 节点会定期监控"),t("strong",[s._v("主节点")]),s._v(", 所以从配置上必然也会有所体现, Sentinel 节点要监控的是一个名字叫做 "),t("code",[s._v("<master-name>")]),s._v("​, ip 地址和端口为 "),t("code",[s._v("<ip><port>")]),s._v("​ 的"),t("strong",[s._v("主节点")]),s._v(".")]),s._v(" "),t("p",[s._v("​"),t("code",[s._v("<quorum>")]),s._v("​ 代表要判定"),t("mark",[t("strong",[s._v("主节点最终不可达所需要的票数")])]),s._v(". "),t("code",[s._v("<quorum>")]),s._v("​ 参数用于故障发现和判定, 例如将 quorum 配置为 2, 代表至少有 2 个 Sentinel 节点"),t("strong",[s._v("认为")]),s._v("主节点不可达时, 这个不可达的判定才是客观的. 一般建议将其"),t("strong",[s._v("设置为 Sentinel 节点数量的一半加 1")]),s._v(".")]),s._v(" "),t("p",[s._v("同时 "),t("code",[s._v("<quorum>")]),s._v("​ 还与 Sentinel 节点的"),t("strong",[s._v("领导者选举")]),s._v("有关, 至少要有 "),t("strong",[s._v("max(quorum, num(sentinels) / 2 + 1)")]),s._v("  个 Sentinel 节点参与选举, 才能选出领导者 Sentinel, 从而完成故障转移.")]),s._v(" "),t("p",[s._v("Sentinel 节点会对"),t("strong",[s._v("所有节点")]),s._v("进行监控, 但在 Sentinel 节点配置中没有看到有关从节点和其余 Sentinel 节点的配置, 这是因为 Sentinel 节点会"),t("strong",[s._v("自动从主节中获取有关从节点以及其余 Sentinel 节点")]),s._v("的相关信息.")]),s._v(" "),t("p",[s._v("例如某个 Sentinel "),t("strong",[s._v("初始节点配置")]),s._v("如下:")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("port "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("26379")]),s._v("\ndaemonize "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("yes")]),s._v("\nlogfile "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"26379.log"')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("dir")]),s._v(" /opt/soft/redis/data\nsentinel monitor mymaster "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1 "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("6379")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("\t"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 只有主节点的配置")]),s._v("\nsentinel down-after-milliseconds mymaster "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("30000")]),s._v("\nsentinel parallel-syncs mymaster "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\nsentinel failover-timeout mymaster "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("180000")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br")])]),t("p",[s._v("当所有节点启动后, 配置文件中的内容发生了"),t("strong",[s._v("变化")]),s._v(", 原来配置文件中会"),t("strong",[s._v("自动加入从节点和其他 Sentinel 结点的信息")]),s._v(", 并会去掉一些默认配置参数. 如下.")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("port "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("26379")]),s._v("\ndaemonize "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("yes")]),s._v("\nlogfile "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"26379.log"')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("dir")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/opt/soft/redis/data"')]),s._v("\nsentinel monitor mymaster "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1 "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("6379")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("\nsentinel config-epoch mymaster "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\nsentinel leader-epoch mymaster "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 发现两个slave节点")]),s._v("\nsentinel known-slave mymaster "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1 "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("6380")]),s._v("\nsentinel known-slave mymaster "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1 "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("6381")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 发现两个sentinel节点")]),s._v("\nsentinel known-sentinel mymaster "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1 "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("26380")]),s._v(" 282a70ff56c36ed56e8f7ee6ada741\n24140d6f53\nsentinel known-sentinel mymaster "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1 "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("26381")]),s._v(" f714470d30a61a8e39ae031192f1fe\nae7eb5b2be\nsentinel current-epoch "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br")])]),t("p",[s._v("Redis Sentinel 可以"),t("strong",[s._v("同时监控多个主节点")]),s._v(". 配置时只需要指定"),t("strong",[s._v("多个 masterName")]),s._v(" 来区分"),t("strong",[s._v("不同的主节点")]),s._v("即可.")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://nano-note.oss-cn-beijing.aliyuncs.com/images/image-20211218185927434.png",alt:""}})]),s._v(" "),t("p",[t("strong",[s._v("② sentinel down-after-milliseconds")])]),s._v(" "),t("p",[s._v("配置结点间不可达"),t("strong",[s._v("超时时间")]),s._v(".")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("$ sentinel down-after-milliseconds "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("master-name"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("times"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("每个 Sentinel 节点都要通过"),t("strong",[s._v("定期发送 ping 命令")]),s._v("来判断 Redis 数据节点和其余 Sentinel 节点"),t("strong",[s._v("是否可达")]),s._v(", 如果超过了 down-after-milliseconds 配置的"),t("strong",[s._v("时间")]),s._v("且没有有效的回复, 则判定节点不可达.")]),s._v(" "),t("p",[t("strong",[s._v("③ sentinel parallel-syncs")])]),s._v(" "),t("p",[s._v("用来限制在一次"),t("strong",[s._v("故障转移")]),s._v("之后, "),t("strong",[s._v("每次向新的主节点发起复制操作")]),s._v("的从节点个数.")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("$ sentinel parallel-syncs "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("master-name"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("nums"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("blockquote",[t("p",[s._v("部署技巧")])]),s._v(" "),t("ul",[t("li",[s._v("Sentinel 节点应部署在多台物理机器上.")]),s._v(" "),t("li",[s._v("部署"),t("strong",[s._v("三个以上且奇数个")]),s._v("的 Sentinel 节点. 3 个以上是通过增加 Sentinel 节点的个数提高对于故障判定的"),t("strong",[s._v("准确性")]),s._v(", 因为领导者选举需要至少一半加 1 个节点, 奇数个节点可以在满足该条件的基础上节省一个节点.")])]),s._v(" "),t("h5",{attrs:{id:"_2-哨兵部署与故障转移示例"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-哨兵部署与故障转移示例"}},[s._v("#")]),s._v(" 2.哨兵部署与故障转移示例")]),s._v(" "),t("p",[t("strong",[s._v("(1)第一步: 创建主从节点配置文件并启动")])]),s._v(" "),t("p",[s._v("安装目录下找到 redis.conf 文件复制三份分别命名为 redis-master.conf/redis-slave1.conf/redis-slave2.conf, 分别作为 1 个主节点和 2 个从节点的配置文件. 分别修改如下所示:")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# redis-master.conf")]),s._v("\nport "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("6379")]),s._v("\ndaemonize "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("yes")]),s._v("\nlogfile "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"6379.log"')]),s._v("\ndbfilename "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"dump-6379.rdb"')]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# redis-slave1.conf")]),s._v("\nport "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("6380")]),s._v("\ndaemonize "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("yes")]),s._v("\nlogfile "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"6380.log"')]),s._v("\ndbfilename "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"dump-6380.rdb"')]),s._v("\nslaveof "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1 "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("6379")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# redis-slave2.conf")]),s._v("\nport "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("6381")]),s._v("\ndaemonize "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("yes")]),s._v("\nlogfile "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"6381.log"')]),s._v("\ndbfilename "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"dump-6381.rdb"')]),s._v("\nslaveof "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1 "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("6379")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br")])]),t("p",[s._v("然后执行 "),t("code",[s._v("redis-server <config file path>")]),s._v("​ 来根据配置文件启动不同的 Redis 节点实例.")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("$ redis-server /usr/local/redis-5.0.3/redis-master.conf\n$ redis-server /usr/local/redis-5.0.3/redis-slave1.conf\n$ redis-server /usr/local/redis-5.0.3/redis-slave2.conf\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br")])]),t("p",[s._v("节点启动后客户端连接到端口为 "),t("strong",[s._v("6379 的主节点")]),s._v("执行 "),t("strong",[s._v("info Replication")]),s._v(" 检查一下"),t("strong",[s._v("主从状态")]),s._v("是否正常(可以看到下方正确地显示了两个从节点):")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://nano-note.oss-cn-beijing.aliyuncs.com/images/7896890-a1c935f094240cac-3785108.png",alt:""}})]),s._v(" "),t("p",[t("strong",[s._v("(2)第二步: 创建哨兵节点配置文件并启动")])]),s._v(" "),t("p",[s._v("按照同样的方法, 给"),t("strong",[s._v("哨兵节点")]),s._v("也创建"),t("strong",[s._v("三个配置文件")]),s._v(". 哨兵节点本质上是特殊的 Redis 节点, 所以配置几乎没什么差别, 只是在端口上做区分即可.")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# redis-sentinel-1.conf")]),s._v("\nport "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("26379")]),s._v("\ndaemonize "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("yes")]),s._v("\nlogfile "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"26379.log"')]),s._v("\nsentinel monitor mymaster "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1 "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("6379")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# redis-sentinel-2.conf")]),s._v("\nport "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("26380")]),s._v("\ndaemonize "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("yes")]),s._v("\nlogfile "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"26380.log"')]),s._v("\nsentinel monitor mymaster "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1 "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("6379")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# redis-sentinel-3.conf")]),s._v("\nport "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("26381")]),s._v("\ndaemonize "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("yes")]),s._v("\nlogfile "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"26381.log"')]),s._v("\nsentinel monitor mymaster "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1 "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("6379")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br")])]),t("p",[s._v("其中 "),t("strong",[s._v("sentinel monitor mymaster 127.0.0.1 6379 2")]),s._v(" 配置的含义是: 该哨兵节点监控 127.0.0.1:6379 这个"),t("strong",[s._v("主节点")]),s._v(", 该主节点的名称是 mymaster, 最后 2 的含义与主节点的故障判定有关: "),t("strong",[s._v("至少需要 2 个哨兵节点同意")]),s._v(", 才能判定主节点故障并进行故障转移.")]),s._v(" "),t("p",[s._v("执行命令启动哨兵节点.")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("$ redis-server /usr/local/redis-5.0.3/redis-sentinel-1.conf "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--sentinel")]),s._v("\n$ redis-server /usr/local/redis-5.0.3/redis-sentinel-2.conf "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--sentinel")]),s._v("\n$ redis-server /usr/local/redis-5.0.3/redis-sentinel-3.conf "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--sentinel")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br")])]),t("p",[s._v("使用客户端连接哨兵节点, 并执行 "),t("strong",[s._v("info Sentinel 命令")]),s._v("来查看是否已经在监视主节点了.")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 连接端口为 26379 的 Redis 节点")]),s._v("\n$ redis-cli "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-p")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("26379")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1:2637"),t("span",{pre:!0,attrs:{class:"token operator"}},[t("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[s._v("9")]),s._v(">")]),s._v(" info Sentinel\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# Sentinel")]),s._v("\nsentinel_masters:1\nsentinel_tilt:0\nsentinel_running_scripts:0\nsentinel_scripts_queue_length:0\nsentinel_simulate_failure_flags:0\nmaster0:name"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("mymaster,status"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("ok,address"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1:6379,slaves"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(",sentinels"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br")])]),t("p",[s._v("查看哨兵配置文件, 会发现已经自动写入一些节点相关的信息.")]),s._v(" "),t("p",[t("strong",[s._v("(3)第三步: 模拟故障转移")])]),s._v(" "),t("p",[s._v("使用  "),t("strong",[s._v('"kill -9"')]),s._v("  命令"),t("strong",[s._v("杀掉主节点")]),s._v(", 同时在哨兵节点中执行  "),t("strong",[s._v('"info Sentinel" 命令')]),s._v("来观察故障节点的过程.")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("$ "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ps")]),s._v(" aux "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("grep")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("6379")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("nano")]),s._v("          "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("74529")]),s._v("   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.3")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.0")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("4346936")]),s._v("   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2132")]),s._v("   ??  Ss   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v(":30上午   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(":03.09 redis-server *:26379 "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("sentinel"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("nano")]),s._v("          "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("73541")]),s._v("   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.2")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.0")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("4348072")]),s._v("   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2292")]),s._v("   ??  Ss   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v(":18上午   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(":04.79 redis-server *:6379\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("nano")]),s._v("          "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("75521")]),s._v("   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.0")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.0")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("4286728")]),s._v("    "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("728")]),s._v(" s008  S+   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v(":39上午   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(":00.00 "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("grep")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--color")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("auto --exclude-dir"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(".bzr --exclude-dir"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("CVS --exclude-dir"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(".git --exclude-dir"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(".hg --exclude-dir"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(".svn "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("6379")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("nano")]),s._v("          "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("74836")]),s._v("   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.0")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.0")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("4289844")]),s._v("    "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("944")]),s._v(" s006  S+   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v(":32上午   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(":00.01 redis-cli "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-p")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("26379")]),s._v("\n$ "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("kill")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-9")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("73541")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br")])]),t("p",[s._v("如果"),t("strong",[s._v("刚杀掉瞬间")]),s._v('在哨兵节点中执行 "info" 命令, 会发现主节点还没有切换过来, 因为哨兵发现主节点故障并转移需要一段时间. 一段时间之后再执行  '),t("strong",[s._v('"info" 命令')]),s._v(", 就会发现"),t("strong",[s._v("主节点已经切换成了 6381 端口的从节点")]),s._v(".")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 过一段时间之后在执行, 发现已经切换了 6381 端口")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1:2637"),t("span",{pre:!0,attrs:{class:"token operator"}},[t("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[s._v("9")]),s._v(">")]),s._v(" info Sentinel\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# Sentinel")]),s._v("\nsentinel_masters:1\nsentinel_tilt:0\nsentinel_running_scripts:0\nsentinel_scripts_queue_length:0\nsentinel_simulate_failure_flags:0\nmaster0:name"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("mymaster,status"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("ok,address"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1:6381,slaves"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(",sentinels"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br")])]),t("p",[s._v("但同时还可以发现, "),t("strong",[s._v("哨兵节点认为新的主节点仍然有两个从节点")]),s._v("(上方 slaves=2), 这是因为哨兵在将 6381 切换成主节点的同时, 将 6379 节点置为其从节点. 虽然 6379 从节点已经挂掉, 但是由于 "),t("strong",[s._v("哨兵并不会对从节点进行客观下线")]),s._v(", 因此认为该从节点一直存在. 当 6379 节点重新启动后, 会自动变成 6381 节点的从节点.")]),s._v(" "),t("p",[s._v("另外在故障转移的阶段, 哨兵和主从节点的配置文件都会被改写:")]),s._v(" "),t("ul",[t("li",[s._v("**对于主从节点: ** 主要是 slaveof 配置的变化, 新的主节点没有了 slaveof 配置, 其从节点则 slaveof 新的主节点.")]),s._v(" "),t("li",[s._v("**对于哨兵节点: ** 除了主从节点信息的变化, 用于记录当前集群状态的参数纪元(epoch) 也会变化, 纪元相关的参数都 +1 了.")])]),s._v(" "),t("h4",{attrs:{id:"sentinel客户端操作"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#sentinel客户端操作"}},[s._v("#")]),s._v(" Sentinel客户端操作")]),s._v(" "),t("h5",{attrs:{id:"_1-客户端命令"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-客户端命令"}},[s._v("#")]),s._v(" 1.客户端命令")]),s._v(" "),t("p",[s._v("Sentinel 节点是一个"),t("strong",[s._v("特殊的 Redis 节点")]),s._v(", 它有自己"),t("strong",[s._v("专属的 API")]),s._v(".")]),s._v(" "),t("p",[t("strong",[s._v("① sentinel masters")]),s._v(": 展示所有被监控的"),t("strong",[s._v("主节点")]),s._v("状态以及相关的统计信息.")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1:2637"),t("span",{pre:!0,attrs:{class:"token operator"}},[t("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[s._v("9")]),s._v(">")]),s._v(" sentinel masters\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"name"')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"mymaster-2"')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"ip"')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"127.0.0.1"')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"port"')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("6")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"6382"')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".忽略"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"name"')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"mymaster-1"')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"ip"')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"127.0.0.1"')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"port"')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("6")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"6379"')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".忽略"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br")])]),t("p",[t("strong",[s._v("② sentinel master (master name)")]),s._v(" : 展示指定 master name 的"),t("strong",[s._v("主节点")]),s._v("状态以及相关的统计信息.")]),s._v(" "),t("p",[t("strong",[s._v("③ sentinel slaves (master name)")]),s._v(" : 展示指定 master name 的"),t("strong",[s._v("从节点")]),s._v("状态以及相关的统计信息.")]),s._v(" "),t("p",[t("strong",[s._v("④ sentinel sentinels (master name)")]),s._v(" : 展示指定 master name 的 "),t("strong",[s._v("Sentinel 节点集合")]),s._v(", 不包含当前 Sentinel 节点.")]),s._v(" "),t("p",[t("strong",[s._v("⑤ sentinel failover (master name)")]),s._v(" : 对指定 master name "),t("strong",[s._v("主节点进行强制故障转移")]),s._v("(没有和其他 Sentinel 节点协商), 当故障转移完成后, 其他 Sentinel 节点按照故障转移的结果"),t("strong",[s._v("更新自身配置")]),s._v(", 这个命令在 Redis Sentinel 的"),t("strong",[s._v("日常运维中非常有用")]),s._v(".")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1:2637"),t("span",{pre:!0,attrs:{class:"token operator"}},[t("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[s._v("9")]),s._v(">")]),s._v(" sentinel failover mymaster-2\nOK\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])]),t("p",[t("strong",[s._v("⑥ sentinel remove (master name)")]),s._v(" : 取消对某个主节点的监控.")]),s._v(" "),t("h5",{attrs:{id:"_2-客户端连接"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-客户端连接"}},[s._v("#")]),s._v(" 2.客户端连接")]),s._v(" "),t("h6",{attrs:{id:"_1-概述"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-概述"}},[s._v("#")]),s._v(" (1)概述")]),s._v(" "),t("p",[t("strong",[s._v("客户端初始化时连接")]),s._v("的是 Sentinel "),t("strong",[s._v("节点集合")]),s._v(", "),t("strong",[s._v("不再是")]),s._v("具体的 Redis 节点, 但 Sentinel 只是配置中心不是代理.")]),s._v(" "),t("p",[s._v("Sentinel 节点集合具备了"),t("strong",[s._v("监控, 通知, 自动故障转移, 配置提供者若干功能")]),s._v(", 所以最了解主节点信息的就是 Sentinel 节点集合, 而各个主节点可以通过 "),t("code",[s._v("<master-name>")]),s._v("​ 进行标识. 如果需要正确地连接 Redis Sentinel, 必须有 "),t("strong",[s._v("Sentinel 节点集合和 masterName 两个参数")]),s._v(".")]),s._v(" "),t("p",[s._v("客户端基本操作:")]),s._v(" "),t("ul",[t("li",[s._v("遍历 Sentinel 节点集合获取一个可用的 Sentinel 节点, Sentinel 节点之间可以"),t("strong",[s._v("共享数据")]),s._v(", 所以从"),t("strong",[s._v("任意")]),s._v("一个 Sentinel 节点获取"),t("strong",[s._v("主节点")]),s._v("信息都是可以的.")]),s._v(" "),t("li",[s._v("需要"),t("strong",[s._v("验证")]),s._v('当前获取的 "主节点" 是真正的主节点, 这样做的目的是为了防止'),t("strong",[s._v("故障转移期间")]),s._v("主节点的变化.")]),s._v(" "),t("li",[s._v("保持和 Sentinel 节点集合的联系, 时刻获取关于主节点的相关信息.")])]),s._v(" "),t("h6",{attrs:{id:"_2-jedis操作哨兵"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-jedis操作哨兵"}},[s._v("#")]),s._v(" (2)Jedis操作哨兵")]),s._v(" "),t("p",[s._v("Jedis 也提供了 "),t("strong",[s._v("Sentinel")]),s._v(" 连接池.")]),s._v(" "),t("div",{staticClass:"language-java line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-java"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("JedisSentinelPool")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("String")]),s._v(" masterName"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 主节点名")]),s._v("\n       "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Set")]),t("span",{pre:!0,attrs:{class:"token generics"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("String")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v(" sentinels"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\t"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// Sentinel节点集合")]),s._v("\n       "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("final")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("GenericObjectPoolConfig")]),s._v(" poolConfig"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// common-pool连接池配置")]),s._v("\n       "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("final")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" connectionTimeout"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\t\t"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 连接超时")]),s._v("\n       "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("final")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" soTimeout"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\t\t\t"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 读写超时")]),s._v("\n       "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("final")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("String")]),s._v(" password"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" \t"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 主节点密码")]),s._v("\n       "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("final")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" database"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\t\t"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 当前数据库索引")]),s._v("\n       "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("final")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("String")]),s._v(" clientName"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\t"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 客户端名")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br")])]),t("p",[s._v("连接时"),t("strong",[s._v("遍历")]),s._v(" Sentinel 结点集合, 找到一个可用的 Sentinel 结点, 然后从中得到"),t("strong",[s._v("主节点信息")]),s._v(".")]),s._v(" "),t("p",[s._v("示例代码:")]),s._v(" "),t("div",{staticClass:"language-java line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-java"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("class")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("JedisSentinelTest")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("static")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("void")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("main")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("String")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" args"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("throws")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("IOException")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\n        "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("JedisPoolConfig")]),s._v(" config "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("new")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("JedisPoolConfig")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        config"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("setMaxTotal")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("20")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        config"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("setMaxIdle")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        config"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("setMinIdle")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n        "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("String")]),s._v(" masterName "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"mymaster"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Set")]),t("span",{pre:!0,attrs:{class:"token generics"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("String")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v(" sentinels "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("new")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("HashSet")]),t("span",{pre:!0,attrs:{class:"token generics"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("String")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        sentinels"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("add")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("new")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("HostAndPort")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"192.168.0.60"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("26379")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("toString")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        sentinels"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("add")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("new")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("HostAndPort")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"192.168.0.60"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("26380")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("toString")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        sentinels"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("add")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("new")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("HostAndPort")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"192.168.0.60"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("26381")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("toString")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// JedisSentinelPool其实本质跟JedisPool类似, 都是与redis主节点建立的连接池")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// JedisSentinelPool并不是说与sentinel建立的连接池, 而是通过sentinel发现redis主节点并与其建立连接")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("JedisSentinelPool")]),s._v(" jedisSentinelPool "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("new")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("JedisSentinelPool")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("masterName"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" sentinels"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" config"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("3000")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("null")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Jedis")]),s._v(" jedis "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("null")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("try")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n            jedis "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" jedisSentinelPool"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("getResource")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("System")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("out"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("println")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("jedis"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("set")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"sentinel"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"zhuge"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("System")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("out"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("println")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("jedis"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("get")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"sentinel"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("catch")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Exception")]),s._v(" e"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n            e"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("printStackTrace")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("finally")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 注意这里不是关闭连接, 在JedisPool模式下, Jedis会被归还给资源池. ")]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("jedis "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("null")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n                jedis"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("close")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br"),t("span",{staticClass:"line-number"},[s._v("25")]),t("br"),t("span",{staticClass:"line-number"},[s._v("26")]),t("br"),t("span",{staticClass:"line-number"},[s._v("27")]),t("br"),t("span",{staticClass:"line-number"},[s._v("28")]),t("br"),t("span",{staticClass:"line-number"},[s._v("29")]),t("br"),t("span",{staticClass:"line-number"},[s._v("30")]),t("br")])]),t("h6",{attrs:{id:"_3-spring-boot整合哨兵"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-spring-boot整合哨兵"}},[s._v("#")]),s._v(" (3)Spring Boot整合哨兵")]),s._v(" "),t("p",[s._v("引入相关依赖:")]),s._v(" "),t("div",{staticClass:"language-XML line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-xml"}},[t("code",[t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),s._v("dependency")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("\n   "),t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),s._v("groupId")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("org.springframework.boot"),t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("</")]),s._v("groupId")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("\n   "),t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),s._v("artifactId")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("spring-boot-starter-data-redis"),t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("</")]),s._v("artifactId")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("</")]),s._v("dependency")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),s._v("dependency")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("\n   "),t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),s._v("groupId")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("org.apache.commons"),t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("</")]),s._v("groupId")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("\n   "),t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),s._v("artifactId")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("commons-pool2"),t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("</")]),s._v("artifactId")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("</")]),s._v("dependency")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br")])]),t("p",[s._v("Spring Boot 配置:")]),s._v(" "),t("div",{staticClass:"language-YML line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-yml"}},[t("code",[t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("server")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("port")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("8080")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("spring")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("redis")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("database")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("timeout")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("3000")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("sentinel")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 哨兵模式")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("master")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" mymaster "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 主服务器所在集群名称")]),s._v("\n     "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("nodes")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" 192.168.0.60"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("26379")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("192.168.0.60"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("26380")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("192.168.0.60"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("26381")]),s._v("\n   "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("lettuce")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("pool")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("max-idle")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("50")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("min-idle")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("max-active")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("100")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("max-wait")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1000")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br")])]),t("p",[s._v("示例代码:")]),s._v(" "),t("div",{staticClass:"language-java line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-java"}},[t("code",[t("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[s._v("@RestController")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("class")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("IndexController")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("private")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("static")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("final")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Logger")]),s._v(" logger "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("LoggerFactory")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("getLogger")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("IndexController")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("class")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n    "),t("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[s._v("@Autowired")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("private")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("StringRedisTemplate")]),s._v(" stringRedisTemplate"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("/**\n     * 测试节点挂了哨兵重新选举新的master节点, 客户端是否能动态感知到\n     * 新的master选举出来后, 哨兵会把消息发布出去, 客户端实际上是实现了一个消息监听机制, \n     * 当哨兵把新master的消息发布出去, 客户端会立马感知到新master的信息, 从而动态切换访问的masterip\n     *\n     * @throws InterruptedException\n     */")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[s._v("@RequestMapping")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/test-sentinel"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("void")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("testSentinel")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("throws")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("InterruptedException")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" i "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("while")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("true")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("try")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n                stringRedisTemplate"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("opsForValue")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("set")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"zhuge"')]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),s._v("i"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" i"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('""')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n                "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("System")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("out"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("println")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"设置key: "')]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"zhuge"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),s._v(" i"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n                i"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("++")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n                "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Thread")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("sleep")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1000")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("catch")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Exception")]),s._v(" e"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n                logger"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("error")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"错误: "')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" e"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br"),t("span",{staticClass:"line-number"},[s._v("25")]),t("br"),t("span",{staticClass:"line-number"},[s._v("26")]),t("br"),t("span",{staticClass:"line-number"},[s._v("27")]),t("br"),t("span",{staticClass:"line-number"},[s._v("28")]),t("br"),t("span",{staticClass:"line-number"},[s._v("29")]),t("br"),t("span",{staticClass:"line-number"},[s._v("30")]),t("br")])]),t("blockquote",[t("p",[s._v("StringRedisTemplate与RedisTemplate")])]),s._v(" "),t("p",[s._v("Spring 封装了 "),t("strong",[s._v("RedisTemplate 对象")]),s._v("来进行对 Redis 的各种操作, 它支持所有的 Redis 原生的 api. 在 RedisTemplate 中提供了几个常用的接口方法的使用, 分别是:")]),s._v(" "),t("div",{staticClass:"language-java line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-java"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("private")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("ValueOperations")]),t("span",{pre:!0,attrs:{class:"token generics"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("K")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("V")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v(" valueOps"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("private")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("HashOperations")]),t("span",{pre:!0,attrs:{class:"token generics"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("K")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("V")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v(" hashOps"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("private")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("ListOperations")]),t("span",{pre:!0,attrs:{class:"token generics"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("K")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("V")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v(" listOps"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("private")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("SetOperations")]),t("span",{pre:!0,attrs:{class:"token generics"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("K")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("V")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v(" setOps"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("private")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("ZSetOperations")]),t("span",{pre:!0,attrs:{class:"token generics"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("K")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("V")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v(" zSetOps"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br")])]),t("p",[s._v("RedisTemplate 中定义了对 5 种数据结构操作")]),s._v(" "),t("div",{staticClass:"language-java line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-java"}},[t("code",[s._v("redisTemplate"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("opsForValue")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 操作字符串")]),s._v("\nredisTemplate"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("opsForHash")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 操作hash")]),s._v("\nredisTemplate"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("opsForList")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 操作list")]),s._v("\nredisTemplate"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("opsForSet")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("   "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 操作set")]),s._v("\nredisTemplate"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("opsForZSet")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 操作有序set")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br")])]),t("p",[s._v("StringRedisTemplate 继承自 RedisTemplate, 也一样拥有上面这些操作.")]),s._v(" "),t("p",[s._v("StringRedisTemplate 默认采用的是 String 的序列化策略, 保存的 key 和 value 都是采用此策略序列化保存的.")]),s._v(" "),t("p",[s._v("RedisTemplate 默认采用的是 JDK 的序列化策略, 保存的 key 和 value 都是采用此策略序列化保存的.")]),s._v(" "),t("h4",{attrs:{id:"哨兵实现原理🌟"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#哨兵实现原理🌟"}},[s._v("#")]),s._v(" 哨兵实现原理🌟")]),s._v(" "),t("p",[s._v("下面详细介绍一下哨兵机制是如何实现的.")]),s._v(" "),t("h5",{attrs:{id:"_1-三个定时监控任务"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-三个定时监控任务"}},[s._v("#")]),s._v(" 1.三个定时监控任务")]),s._v(" "),t("p",[s._v("一套合理的监控机制是 Sentinel 节点判定节点"),t("strong",[s._v("不可达")]),s._v("的重要保证, Redis Sentinel 通过"),t("strong",[s._v("三个定时监控任务")]),s._v("完成对各个节点发现和监控.")]),s._v(" "),t("h6",{attrs:{id:"_1-sentinel与数据结点的定时任务"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-sentinel与数据结点的定时任务"}},[s._v("#")]),s._v(" (1)Sentinel与数据结点的定时任务")]),s._v(" "),t("p",[t("strong",[s._v("每隔 10 秒, 每个 Sentinel 节点会向主节点和从节点发送 info 命令获取最新的拓扑结构")]),s._v(".")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://nano-note.oss-cn-beijing.aliyuncs.com/images/image-20220523213535648.png",alt:""}})]),s._v(" "),t("p",[s._v("如在一个主节点执行 "),t("strong",[s._v("info replication")]),s._v(" 命令.")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# Replication")]),s._v("\nrole:master\nconnected_slaves:2\nslave0:ip"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1,port"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("6380")]),s._v(",state"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("online,offset"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("4917")]),s._v(",lag"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\nslave1:ip"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1,port"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("6381")]),s._v(",state"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("online,offset"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("4917")]),s._v(",lag"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br")])]),t("p",[s._v("Sentinel 节点通过对上述结果进行"),t("strong",[s._v("解析")]),s._v("就可以找到相应的"),t("strong",[s._v("从节点")]),s._v(".")]),s._v(" "),t("p",[s._v("这个定时任务的作用有:")]),s._v(" "),t("ul",[t("li",[s._v("通过向主节点执行 info 命令, 获取从节点的信息, 因此 Sentinel 节点无需显式配置监控从节点.")]),s._v(" "),t("li",[s._v("当有新的从节点加入时都可以"),t("strong",[s._v("立刻感知")]),s._v("出来.")]),s._v(" "),t("li",[s._v("节点不可达或者故障转移后, 可以通过 info 命令实时"),t("strong",[s._v("更新")]),s._v("节点拓扑信息.")])]),s._v(" "),t("h6",{attrs:{id:"_2-sentinel之间的定时任务"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-sentinel之间的定时任务"}},[s._v("#")]),s._v(" (2)Sentinel之间的定时任务")]),s._v(" "),t("p",[s._v("每隔 "),t("strong",[s._v("2 秒")]),s._v(", "),t("strong",[s._v("每个 Sentinel 节点")]),s._v("会向 Redis "),t("strong",[s._v("数据节点")]),s._v("的 "),t("strong",[t("strong",[s._v("sentinel")])]),s._v("​ "),t("strong",[s._v(": hello")]),s._v(" 频道上发送该 Sentinel 节点对于"),t("strong",[s._v("主节点的判断")]),s._v("以及当前 Sentinel "),t("strong",[s._v("节点的信息")]),s._v(", 同时每个 Sentinel 节点也会"),t("strong",[s._v("订阅该频道")]),s._v(", 来了解其他 Sentinel 节点以及它们对主节点的判断.")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://nano-note.oss-cn-beijing.aliyuncs.com/images/image-20220523213648378.png",alt:""}})]),s._v(" "),t("p",[s._v("这个定时任务的作用:")]),s._v(" "),t("ul",[t("li",[s._v("发现"),t("strong",[s._v("新的 Sentinel 节点")]),s._v(": 通过订阅主节点的 "),t("code",[s._v("_sentinel_: hello")]),s._v("​ 了解其他的 Sentinel 节点信息, 如果是新加入的 Sentinel 节点, 将该 Sentinel 节点信息保存起来, 并与该 Sentinel 节点创建连接.")]),s._v(" "),t("li",[s._v("Sentinel 节点之间"),t("strong",[s._v("交换主节点的状态")]),s._v(", 作为后面"),t("strong",[s._v("客观下线")]),s._v("以及"),t("strong",[s._v("领导者选举")]),s._v("的依据.")])]),s._v(" "),t("h6",{attrs:{id:"_3-心跳定时任务"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-心跳定时任务"}},[s._v("#")]),s._v(" (3)心跳定时任务")]),s._v(" "),t("p",[s._v("每隔 1 秒, 每个 Sentinel 节点会向"),t("strong",[s._v("主节点, 从节点, 其余 Sentinel 节点")]),s._v("发送一条 "),t("strong",[s._v("ping 命令做一次心跳检测")]),s._v(", 来确认这些节点当前"),t("strong",[s._v("是否可达")]),s._v(". 通过上面的定时任务, Sentinel 节点对主节点, 从节点, 其余 Sentinel 节点"),t("strong",[s._v("都建立起连接")]),s._v(", 实现了对"),t("strong",[s._v("每个节点")]),s._v("的监控, 这个定时任务是节点失败判定的重要依据.")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://nano-note.oss-cn-beijing.aliyuncs.com/images/image-20220523213736868.png",alt:""}})]),s._v(" "),t("h5",{attrs:{id:"_2-主观下线与客观下线"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-主观下线与客观下线"}},[s._v("#")]),s._v(" 2.主观下线与客观下线")]),s._v(" "),t("h6",{attrs:{id:"_1-主观下线"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-主观下线"}},[s._v("#")]),s._v(" (1)主观下线")]),s._v(" "),t("p",[t("strong",[s._v("每个 Sentinel 节点")]),s._v("会每隔 1 秒对主节点, 从节点, 其他 Sentinel 节点发送 ping 命令做"),t("strong",[s._v("心跳检测")]),s._v(", 当这些节点超过 down-after-milliseconds "),t("strong",[s._v("没有进行有效回复")]),s._v(", 这个 Sentinel 节点就会对"),t("strong",[s._v("该节点做失败判定")]),s._v(", 这个行为叫做"),t("strong",[s._v("主观下线")]),s._v(".")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://nano-note.oss-cn-beijing.aliyuncs.com/images/image-20220523213813042.png",alt:""}})]),s._v(" "),t("p",[s._v("从字面意思也可以看出主观下线是"),t("strong",[s._v("当前 Sentinel 节点的一家之言")]),s._v(", 存在"),t("strong",[s._v("误判")]),s._v("的可能. 也就是可能就这一个 Sentinel 认为一个结点是下线了.")]),s._v(" "),t("h6",{attrs:{id:"_2-客观下线"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-客观下线"}},[s._v("#")]),s._v(" (2)客观下线")]),s._v(" "),t("p",[s._v("当 Sentinel 主观下线的节点是"),t("strong",[s._v("主节点")]),s._v("时, 该 Sentinel 节点会通过 "),t("code",[s._v("sentinel ismaster-down-by-addr")]),s._v("​ 命令向其他 Sentinel 节点"),t("strong",[s._v("询问对主节点的判断")]),s._v(", 当超过 ​"),t("code",[s._v("quorum")]),s._v("​ 个数, Sentinel 节点认为主节点"),t("strong",[s._v("确实有问题")]),s._v(", 这时该 Sentinel 节点会"),t("strong",[s._v("做出客观下线")]),s._v("的决定, 也就是大部分 Sentinel 节点都对主节点的下线做了同意的判定, 那么这个判定就是"),t("strong",[s._v("客观")]),s._v("的.")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://nano-note.oss-cn-beijing.aliyuncs.com/images/image-20220523213901063.png",alt:""}})]),s._v(" "),t("p",[s._v("注意: "),t("strong",[s._v("从节点, Sentinel 节点在主观下线后, 没有后续的故障转移操作")]),s._v(". "),t("strong",[s._v("只对主节点做故障转移")]),s._v(".")]),s._v(" "),t("h5",{attrs:{id:"_3-领导者sentinel选举"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-领导者sentinel选举"}},[s._v("#")]),s._v(" 3.领导者Sentinel选举")]),s._v(" "),t("p",[s._v("假如 Sentinel 节点对于"),t("strong",[s._v("主节点")]),s._v("已经做了"),t("strong",[s._v("客观下线")]),s._v(", 并不是马上进行故障转移. 实际上"),t("strong",[s._v("故障转移的工作")]),s._v("只需要"),t("strong",[s._v("一个 Sentinel 节点来完成")]),s._v("即可, 所以 Sentinel 节点之间会做一个"),t("strong",[s._v("领导者选举")]),s._v("的工作, 选出一个 Sentinel 节点"),t("strong",[s._v("作为领导者进行故障转移")]),s._v("的工作. Redis 使用了 "),t("mark",[t("strong",[s._v("Raft 算法")])]),s._v("实现领导者选举(参考: Raft算法).")]),s._v(" "),t("p",[s._v("大致流程如下:")]),s._v(" "),t("p",[s._v("(1) 每个在线的 Sentinel 节点都有资格成为领导者, 当它确认主节点主观下线时候, 会向其他 Sentinel 节点发送 "),t("code",[s._v("sentinel is-master-down-by-addr")]),s._v("​ 命令, 要求"),t("strong",[s._v("将自己")]),s._v("设置为领导者.")]),s._v(" "),t("p",[s._v("(2) 收到命令的 Sentinel 节点, 如果没有同意过其他 Sentinel 节点的 "),t("code",[s._v("sentinel is-master-down-by-addr")]),s._v("​ 命令, 将"),t("strong",[s._v("同意")]),s._v("该请求, 否则拒绝.")]),s._v(" "),t("p",[s._v("(3) 如果该 Sentinel 节点发现"),t("strong",[s._v("自己的票数已经大于等于 max(quorum, num(sentinels) / 2 + 1)")]),s._v(" , 那么它将成为"),t("strong",[s._v("领导者")]),s._v(". 每个 Sentinel 节点只有"),t("strong",[s._v("一票")]),s._v(".")]),s._v(" "),t("p",[s._v("(4) 如果此过程没有选举出领导者, 将进入"),t("strong",[s._v("下一次")]),s._v("选举.")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://nano-note.oss-cn-beijing.aliyuncs.com/images/image-20200725150625390.png",alt:""}})]),s._v(" "),t("p",[s._v("选举的过程非常快, 基本上谁先完成客观下线, 谁就是领导者. 注意这里只是选举一个 Sentinel 领导节点进行故障转移, 而不是选举主节点. 下面介绍的才是由选举出来的 Sentinel 领导节点主导进行故障转移的过程.")]),s._v(" "),t("h5",{attrs:{id:"_4-故障转移过程"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_4-故障转移过程"}},[s._v("#")]),s._v(" 4.故障转移过程")]),s._v(" "),t("p",[s._v("故障转移过程如下. 故障转移每一步都可以通过"),t("strong",[s._v("发布订阅")]),s._v("来获取.")]),s._v(" "),t("p",[s._v("(1) 加入主节点出现"),t("strong",[s._v("故障")]),s._v(", 此时两个从节点与主节点"),t("strong",[s._v("失去连接")]),s._v(", "),t("strong",[s._v("主从复制失败")]),s._v(".")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://nano-note.oss-cn-beijing.aliyuncs.com/images/image-20220523214205176.png",alt:""}})]),s._v(" "),t("p",[s._v("(2) 每个 Sentinel 节点通过"),t("strong",[s._v("定期监控")]),s._v("发现主节点出现了故障.")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://nano-note.oss-cn-beijing.aliyuncs.com/images/image-20220523214232398.png",alt:""}})]),s._v(" "),t("p",[s._v("(3) 多个 Sentinel 节点"),t("strong",[s._v("对主节点的故障达成一致")]),s._v(", "),t("strong",[s._v("选举出 sentinel-3 节点作为")]),s._v("​"),t("mark",[t("strong",[s._v("领导者负责故障转移")])]),s._v(".")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://nano-note.oss-cn-beijing.aliyuncs.com/images/image-20220523214302088.png",alt:""}})]),s._v(" "),t("p",[s._v("(4) Sentinel 领导者节点执行了"),t("strong",[s._v("故障转移")]),s._v(". 流程如下.")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://nano-note.oss-cn-beijing.aliyuncs.com/images/image-20220523214329887.png",alt:""}})]),s._v(" "),t("p",[t("strong",[s._v("需要在从节点列表中选出一个节点作为新的主节点")]),s._v(', 选择方法有: (1)过滤 "不健康" 的节点; (2)选择 '),t("strong",[s._v("salve-priority")]),s._v(" 最高的从节点列表; (3)选择"),t("strong",[s._v("复制偏移量最大(复制数据最完整)")]),s._v(" 的节点; (4)选择 runid 最小的从节点.")]),s._v(" "),t("ul",[t("li",[s._v("假设这里从节点 1 变成主节点.")]),s._v(" "),t("li",[s._v("Sentinel 领导者节点会对选出来的从节点执行 "),t("code",[s._v("slaveof no one")]),s._v("​ 命令让其成为"),t("strong",[s._v("主节点")]),s._v(", 此时原来的从节点 1 变成新的主节点.")]),s._v(" "),t("li",[s._v("Sentinel 领导者节点会向"),t("strong",[s._v("剩余的从节点")]),s._v("发送命令, 让它们成为新主节点的从节点, "),t("strong",[s._v("复制规则")]),s._v("和 parallel-syncs 参数有关.")]),s._v(" "),t("li",[s._v("然后 Sentinel 领导者节点"),t("strong",[s._v("通知")]),s._v("客户端.")]),s._v(" "),t("li",[s._v("最后原来的故障主节点"),t("strong",[s._v("重启")]),s._v("成为一个"),t("strong",[s._v("从节点")]),s._v(".")])]),s._v(" "),t("p",[t("strong",[s._v("故障转移后")]),s._v("整个 Redis Sentinel 的"),t("strong",[s._v("拓扑结构图")]),s._v("如下.")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://nano-note.oss-cn-beijing.aliyuncs.com/images/image-20220523214440695.png",alt:""}})]),s._v(" "),t("p",[s._v("整个故障转移过程会产生大量的"),t("strong",[s._v("日志")]),s._v(", 如有需要再看看.")]),s._v(" "),t("h4",{attrs:{id:"高可用读写分离🌟"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#高可用读写分离🌟"}},[s._v("#")]),s._v(" 高可用读写分离🌟")]),s._v(" "),t("p",[s._v("Sentinel 实现"),t("strong",[s._v("读写分离高可用")]),s._v("可以依赖 Sentinel 节点的"),t("strong",[s._v("消息通知")]),s._v(", 获取 Redis 数据节点的"),t("strong",[s._v("状态变化")]),s._v(".")]),s._v(" "),t("p",[t("strong",[s._v("从节点")]),s._v("的作用:")]),s._v(" "),t("ul",[t("li",[s._v("当主节点出现故障时, 作为主节点的后备顶上来实现"),t("strong",[s._v("故障转移")]),s._v(", Redis Sentinel 已经实现了该功能的自动化, 实现了真正的高可用.")]),s._v(" "),t("li",[s._v("扩展主节点的"),t("strong",[s._v("读能力")]),s._v(", 尤其是在"),t("strong",[s._v("读多写少的场景")]),s._v("非常适用.")])]),s._v(" "),t("p",[t("img",{attrs:{src:"https://nano-note.oss-cn-beijing.aliyuncs.com/images/image-20220523214621694.png",alt:""}})]),s._v(" "),t("p",[s._v("但上述模型中, 从节点"),t("strong",[s._v("不是高可用")]),s._v("的, 如果 slave-1 节点"),t("strong",[s._v("出现故障")]),s._v(", 首先客户端 client-1 将与其"),t("strong",[s._v("失联")]),s._v(", 其次 Sentinel 节点只会对该节点做"),t("strong",[s._v("主观下线")]),s._v(", 因为 Redis Sentinel 的"),t("strong",[s._v("故障转移是针对主节点")]),s._v("的.")]),s._v(" "),t("p",[s._v("所以很多时候 Redis Sentinel 中的"),t("strong",[s._v("从节点仅仅是作为主节点一个热备")]),s._v(", 不让它参与客户端的读操作, 就是为了保证整体高可用性, 但实际上这种使用方法还是有一些浪费, 尤其是在有很多从节点或者确实需要读写分离的场景, 所以"),t("strong",[s._v("如何实现从节点的高可用")]),s._v("是非常有必要的.")]),s._v(" "),t("p",[t("strong",[s._v("Redis Sentinel 读写分离设计思路")]),s._v(": Sentinel 在对各个节点的监控中, 如果有对应"),t("strong",[s._v("事件")]),s._v("的发生, 都会发出相应的"),t("strong",[s._v("事件消息")]),s._v(". 在设计 Redis Sentinel 的"),t("strong",[s._v("从节点高可用")]),s._v("时, 只要能够实时掌握"),t("strong",[s._v("所有从节点的状态")]),s._v(", 把所有从节点看做一个"),t("strong",[s._v("资源池")]),s._v(", 无论是上线还是下线从节点, 客户端都能"),t("strong",[s._v("及时感知")]),s._v("到(将其从资源池中添加或者删除), 这样从节点的高可用目标就达到了.")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://nano-note.oss-cn-beijing.aliyuncs.com/images/image-20220523214707545.png",alt:""}})]),s._v(" "),t("p",[s._v("‍")]),s._v(" "),t("p",[s._v("‍")]),s._v(" "),t("h4",{attrs:{id:"参考资料"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#参考资料"}},[s._v("#")]),s._v(" 参考资料")]),s._v(" "),t("ul",[t("li",[s._v("《Redis开发与运维》")])])])}),[],!1,null,null,null);t.default=e.exports}}]);