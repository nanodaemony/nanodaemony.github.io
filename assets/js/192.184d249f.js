(window.webpackJsonp=window.webpackJsonp||[]).push([[192],{506:function(s,t,a){"use strict";a.r(t);var n=a(7),e=Object(n.a)({},(function(){var s=this,t=s._self._c;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("h1",{attrs:{id:"_100-å®¹å™¨å®æˆ˜é«˜æ‰‹è¯¾-æå®¢æ—¶é—´-ğŸŒ¸"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_100-å®¹å™¨å®æˆ˜é«˜æ‰‹è¯¾-æå®¢æ—¶é—´-ğŸŒ¸"}},[s._v("#")]),s._v(" 100.å®¹å™¨å®æˆ˜é«˜æ‰‹è¯¾(æå®¢æ—¶é—´)ğŸŒ¸")]),s._v(" "),t("h3",{attrs:{id:"å¼€ç¯‡è¯"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#å¼€ç¯‡è¯"}},[s._v("#")]),s._v(" å¼€ç¯‡è¯")]),s._v(" "),t("h4",{attrs:{id:"å¼€ç¯‡è¯-ä¸€ä¸ªæ€åº¦ä¸¤ä¸ªæ­¥éª¤-æˆä¸ºå®¹å™¨å®æˆ˜é«˜æ‰‹"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#å¼€ç¯‡è¯-ä¸€ä¸ªæ€åº¦ä¸¤ä¸ªæ­¥éª¤-æˆä¸ºå®¹å™¨å®æˆ˜é«˜æ‰‹"}},[s._v("#")]),s._v(" å¼€ç¯‡è¯ | ä¸€ä¸ªæ€åº¦ä¸¤ä¸ªæ­¥éª¤,æˆä¸ºå®¹å™¨å®æˆ˜é«˜æ‰‹")]),s._v(" "),t("p",[s._v("åœ¨ 2013 å¹´, æˆ‘åŠ å…¥ eBay, ä»äº‹äº‘å¹³å°æ–¹é¢çš„å·¥ä½œ, æœ€å…ˆæ¥è§¦çš„æ˜¯ OpenStack äº‘å¹³å°. åˆ°äº† 2015 å¹´å¼€å§‹åš Kubernetes, è¦ç”¨ Kubernetes æ¥ç®¡ç† eBay æ•´ä¸ªäº‘å¹³å°. éœ€è¦è¿ç§»æ‰€æœ‰ eBay çš„åº”ç”¨ç¨‹åº, æŠŠå®ƒä»¬ä»åŸæ¥çš„ç‰©ç†æœºæˆ–è€…è™šæ‹Ÿæœºè¿ç§»åˆ°å®¹å™¨çš„ç¯å¢ƒé‡Œ.")]),s._v(" "),t("p",[s._v("åœ¨ Kubernetes å…·ä½“è½åœ°çš„è¿‡ç¨‹ä¸­, æˆ‘ä»¬ç¢°åˆ°äº†å½¢å½¢è‰²è‰²çš„å®¹å™¨é—®é¢˜.")]),s._v(" "),t("p",[s._v("é¦–å…ˆ, å®¹å™¨æ˜¯ä¸€ç§è½»é‡çº§çš„éš”ç¦»æŠ€æœ¯. è€Œè½»é‡çº§éš”ç¦»é€ æˆäº†ä¸€äº›"),t("strong",[s._v("è¡Œä¸ºæ¨¡å¼")]),s._v("çš„ä¸åŒ, æ¯”å¦‚åŸæ¥è¿è¡Œåœ¨è™šæ‹Ÿæœºé‡Œçš„ CPU ç›‘æ§ç¨‹åº, ç§»åˆ°å®¹å™¨ä¹‹å, å†ç”¨åŸæ¥çš„ç®—æ³•è®¡ç®—å®¹å™¨ CPU ä½¿ç”¨ç‡å°±ä¸é€‚ç”¨äº†.")]),s._v(" "),t("p",[s._v("ä»"),t("strong",[s._v("éš”ç¦»ç¨‹åº¦")]),s._v("è¿™ä¸ªæ–¹é¢è€ƒè™‘, CPU, memory, IO (disk and network)çœŸçš„èƒ½åšåˆ°ç²¾ç¡®éš”ç¦»å—? å…¶å®è¿˜æ˜¯æœ‰é—®é¢˜çš„, æ¯”å¦‚æƒ³è®©å¤šä¸ªç”¨æˆ·å®¹å™¨è¿è¡Œåœ¨ä¸€ä¸ªèŠ‚ç‚¹ä¸Š, å°±éœ€è¦ä¿è¯, æ¯ä¸ªå®¹å™¨çš„ç£ç›˜å®¹é‡åœ¨ä¸€å®šçš„é™é¢èŒƒå›´å†…, è¿˜è€Œä¸”éœ€è¦åˆç†åˆ†é…ç£ç›˜è¯»å†™æ€§èƒ½.")]),s._v(" "),t("p",[s._v("ç¬¬ä¸‰ä¸ªæ–¹é¢, å°±æ˜¯**å¤„ç†æ€§èƒ½æ•æ„Ÿçš„åº”ç”¨. ** å®¹å™¨æŠ€æœ¯çš„å¼•å…¥, ä¼šå¸¦æ¥æ–°çš„å¼€é”€, é‚£ä¹ˆè‚¯å®šä¼šå½±å“æ€§èƒ½. æ¯”å¦‚åŸæ¥è¿è¡Œåœ¨ç‰©ç†æœºä¸Š, æœ‰æé«˜æ€§èƒ½è¦æ±‚çš„ç¨‹åº, åœ¨è¿ç§»åˆ°å®¹å™¨å, è¿˜éœ€è¦å¯¹å®¹å™¨ç½‘ç»œåšä¼˜åŒ–, å¯¹ Cgroup åšä¼˜åŒ–. åªæœ‰åšäº†è¿™æ ·çš„ä¼˜åŒ–, æ‰èƒ½ä¿è¯è¿ç§»è¿‡æ¥çš„ç¨‹åº, å½“å®ƒä»¬è¿è¡Œåœ¨å®¹å™¨é‡Œçš„æ—¶å€™, æ€§èƒ½å·®å¼‚æ§åˆ¶åœ¨ 2% ä»¥å†…(å½“æ—¶åšè¿ç§»çš„æ ‡å‡†).")]),s._v(" "),t("p",[s._v("å¦å¤–, å¦‚æœæ¶‰åŠé«˜å†…å­˜ä½¿ç”¨çš„åº”ç”¨, åšè¿ç§»çš„æ—¶å€™, è¿˜è¦è€ƒè™‘ PageCache, Swap, è¿˜æœ‰ HugePage ç­‰ç­‰é—®é¢˜, åœ¨å åŠ äº† Cgroup ä¹‹å, ä¼šå¸¦æ¥æ–°çš„å˜åŒ–.")]),s._v(" "),t("p",[s._v("ç»¼åˆæ¥çœ‹, é‡åˆ°çš„é—®é¢˜æœ‰çš„å¾ˆç®€å•, çœ‹ä¸€ä¸‹æºä»£ç , å†™ä¸ªæµ‹è¯•ä»£ç éªŒè¯ä¸€ä¸‹, ä¸€ä¸¤ä¸ªå°æ—¶å°±å¯ä»¥æå®š. ä½†æœ‰çš„é—®é¢˜å´å¾ˆå¤æ‚, éœ€è¦å°è¯•ä¸åŒçš„æµ‹è¯•, åå¤æŸ¥çœ‹å„ç§æºä»£ç , é™†é™†ç»­ç»­èŠ±è´¹ä¸€ä¸¤ä¸ªæœˆçš„æ—¶é—´è§£å†³. é€šè¿‡ 5 å¹´çš„ä¸æ–­åŠªåŠ›, å›¢é˜Ÿé€æ¸æŠŠ eBay æ‰€æœ‰çš„ä¸šåŠ¡éƒ½è¿ç§»åˆ°äº†å®¹å™¨ä¸­. ç°åœ¨æˆ‘ä»¬çš„äº‘å¹³å°ä¸Šè¿è¡Œç€ç™¾ä¸‡ä¸ªå®¹å™¨.")]),s._v(" "),t("h5",{attrs:{id:"_1-æ€ä¹ˆç†è§£å®¹å™¨çš„çŸ¥è¯†ä½“ç³»"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-æ€ä¹ˆç†è§£å®¹å™¨çš„çŸ¥è¯†ä½“ç³»"}},[s._v("#")]),s._v(" 1.æ€ä¹ˆç†è§£å®¹å™¨çš„çŸ¥è¯†ä½“ç³»?")]),s._v(" "),t("p",[s._v("å¯ä»¥è¯´, ä»æˆ‘æ¥è§¦å®¹å™¨çŸ¥è¯†åˆ°èƒ½å¤Ÿå¾—å¿ƒåº”æ‰‹åœ°è§£å†³å„ç§å®¹å™¨é—®é¢˜, è¿™ä¸ªè¿‡ç¨‹è¿˜çœŸæ˜¯æœ‰ç‚¹ç£•ç£•ç»Šç»Š. ä¸€å¼€å§‹, æˆ‘è¢«å„ç§å„æ ·çš„é—®é¢˜æ‰€æ·¹æ²¡, è§‰å¾—å®¹å™¨çš„å†…å®¹å¤ªå¤æ‚äº†, æ²¡æœ‰ä¸€ä¸ªç³»ç»Ÿæ€§çš„è§£å†³æ–¹æ³•. åªèƒ½è§æ‹›æ‹†æ‹›, ä¸€ä¸ªä¸ªè§£å†³, å°±è¿™æ ·, éšç€æˆ‘è§£å†³çš„é—®é¢˜è¶Šæ¥è¶Šå¤š, æˆ‘ä¹Ÿå¼€å§‹æ€è€ƒ, æ˜¯ä¸æ˜¯æœ‰ä¸€äº›"),t("strong",[s._v("è§„å¾‹æ€§")]),s._v("çš„ä¸œè¥¿.")]),s._v(" "),t("p",[s._v("å®¹å™¨é—®é¢˜è™½ç„¶æœ‰å¾ˆå¤šç±»å‹, æ—¢æœ‰åŸºæœ¬åŠŸèƒ½é—®é¢˜, ä¹Ÿæœ‰æ€§èƒ½é—®é¢˜, è¿˜æœ‰ä¸å°‘ç¨³å®šæ€§é—®é¢˜. ä½†å¤§éƒ¨åˆ†é—®é¢˜, "),t("mark",[t("strong",[s._v("æœ€ç»ˆéƒ½ä¼šå½’ç»“åˆ° Linux æ“ä½œç³»ç»Ÿä¸Š")])]),s._v("â€‹ **. **")]),s._v(" "),t("p",[s._v("æ¯”å¦‚å®¹å™¨é‡Œè¿›ç¨‹è¢« OOM Kill äº†, è¿™ä¸ª OOM Killer å°±æ˜¯ Linux é‡Œå¸¸è§çš„å†…å­˜ä¿æŠ¤æœºåˆ¶; å®¹å™¨çš„è¿›ç¨‹å¼•èµ·å¹³å‡è´Ÿè½½å¢é«˜, è€Œå¹³å‡è´Ÿè½½ä¹Ÿæ˜¯åœ¨ Linux é‡Œè¢«åå¤è®¨è®ºçš„æ¦‚å¿µ; è¿˜æœ‰å®¹å™¨ä½¿ç”¨çš„ OverlayFS ç³»ç»Ÿ, çœ‹ä¸Šå»å’Œ Linux å¸¸ç”¨çš„ XFS, Ext4 ç³»ç»Ÿä¸åŒ, ä½†æ˜¯å®ƒä¹Ÿæ˜¯ Linux å†…æ ¸ç»´æŠ¤çš„ä¸€ç§æ–‡ä»¶ç³»ç»Ÿ.")]),s._v(" "),t("p",[s._v("å…¶å® Linux æ“ä½œç³»ç»Ÿä¸å¤–ä¹æ˜¯**è¿›ç¨‹ç®¡ç†, å†…å­˜ç®¡ç†, æ–‡ä»¶ç³»ç»Ÿ, ç½‘ç»œåè®®æ ˆ, å†åŠ ä¸Šä¸€äº›å®‰å…¨ç®¡ç†. ** è¿™æ ·ä¸€æ¢³ç†, å®¹å™¨çš„é—®é¢˜å°±éƒ½å¯ä»¥æŠ•å°„åˆ° Linux æ“ä½œç³»ç»Ÿè¿™äº›æ¨¡å—ä¸Šäº†, æ˜¯ä¸æ˜¯ä¸€ä¸‹å­æ„Ÿè§‰æ¸…æ™°äº†å¾ˆå¤š?")]),s._v(" "),t("p",[s._v("å½“ç„¶äº†, å®¹å™¨è¿˜æœ‰è‡ªå·±çš„ç‰¹æ®Šæ€§, "),t("strong",[s._v("Linux å†…æ ¸åŸæ¥çš„ç‰¹æ€§åŠ ä¸Š Namespace å’Œ Cgroups ä¼šå¸¦æ¥çš„å˜åŒ–")]),s._v(". æ‰€ä»¥åœ¨å¯¹åº”åˆ°æ¯ä¸ªæ¨¡å—ä¸Šåˆ†æé—®é¢˜çš„æ—¶å€™, è¿˜éœ€è¦è€ƒè™‘åˆ° Namespace å’Œ Cgroups. è¿™ä¸¤ä¸ªæ¦‚å¿µæ˜¯å®¹å™¨æŠ€æœ¯çš„åŸºçŸ³, åé¢ä¸­è¦è®¨è®ºçš„å®¹å™¨ç›¸å…³é—®é¢˜, å¤šå°‘éƒ½ä¼šå’Œ Namespace æˆ–è€… Cgroups ç›¸å…³.")]),s._v(" "),t("p",[s._v("æ€»ä¹‹å°±æ˜¯ä¸€å¥è¯, "),t("mark",[t("strong",[s._v("å¯ä»¥ç»“åˆ Linux æ“ä½œç³»ç»Ÿçš„ä¸»è¦æ¨¡å—, æŠŠå®¹å™¨çš„çŸ¥è¯†ç»“æ„ç³»ç»Ÿåœ°ä¸²è”èµ·æ¥, åŒæ—¶çœ‹åˆ° Namespace å’Œ Cgroups å¸¦æ¥çš„ç‰¹æ®Šæ€§")])]),s._v("â€‹ "),t("strong",[s._v(".")])]),s._v(" "),t("p",[t("img",{attrs:{src:"/img/2f4b60ddd907c1303b08191b15876aa4-20230731161430-o1h1ld2.png",alt:""}})]),s._v(" "),t("h5",{attrs:{id:"_2-æ€ä¹ˆè§£å†³å®¹å™¨é—®é¢˜"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-æ€ä¹ˆè§£å†³å®¹å™¨é—®é¢˜"}},[s._v("#")]),s._v(" 2.æ€ä¹ˆè§£å†³å®¹å™¨é—®é¢˜?")]),s._v(" "),t("p",[s._v("å¿ƒä¸­æœ‰äº†å®¹å™¨çš„çŸ¥è¯†ä½“ç³», ä¹Ÿå°±èƒ½åœ¨å®¹å™¨å®è·µä¸­è§£å†³å…·ä½“çš„é—®é¢˜äº†. ç»“åˆæˆ‘è‡ªå·±è¿™ä¹ˆå¤šå¹´çš„ç»å†, æ€»ç»“äº†ä¸€æ¡ç»éªŒ, **è§£å†³å®¹å™¨é—®é¢˜éœ€è¦ä¸€ä¸ªæ€åº¦ + ä¸¤ä¸ªæ­¥éª¤. **")]),s._v(" "),t("p",[s._v("åœ¨è§£å†³å®¹å™¨é—®é¢˜çš„è¿‡ç¨‹ä¸­, å¸¸è§çš„è¯¯åŒºå°±æ˜¯æµ…å°è¾„æ­¢, ä¸å»æŒ–æ˜é—®é¢˜çš„æ ¹æœ¬åŸå› . æ¥ä¸‹æ¥å°±æ‹¿ä¸€ä¸ªå…·ä½“çš„ä¾‹å­æ¥è¯´æ˜.")]),s._v(" "),t("p",[s._v("æœ‰ä¸€æ¬¡å›¢é˜Ÿä¸€ä½åŒå­¦é—®æˆ‘, æ€ä¹ˆè®© Kubernetes èŠ‚ç‚¹ä¸Šçš„å®¹å™¨, "),t("strong",[s._v("ä»å†…éƒ¨è§¦å‘è‡ªå·±çš„å®¹å™¨é‡å¯")]),s._v("å•Š? è¯•äº†ä¸€ä¸‹, åœ¨å®¹å™¨ä¸­æŠŠç¬¬ 1 å·è¿›ç¨‹æ€äº†, ç„¶åå®¹å™¨é€€å‡º, Kubernetes è‡ªåŠ¨åœ°æŠŠå®¹å™¨å¸¦å›æ¥, å°±èƒ½å®ç°ç±»ä¼¼çš„è‡ªåŠ¨é‡å¯åŠŸèƒ½äº†, åŒäº‹è¯•äº†ä¹Ÿå¯ä»¥, è®¤ä¸ºé—®é¢˜è§£å†³äº†, ä¹ŸæŒºå¼€å¿ƒçš„. æˆ‘ä¹Ÿæ²¡æœ‰å¤šæƒ³, ä»¥ä¸ºè‡ªå·±æ‰¾åˆ°æ–¹æ³•äº†.")]),s._v(" "),t("p",[s._v("åæ¥åˆæœ‰ä¸€ä¸ªåŒäº‹å’Œæˆ‘è¯´, è¿™æ ·åšæ²¡æœ‰æ•ˆæœå•Š. æˆ‘è¿™æ‰å‘ç°é—®é¢˜æ²¡é‚£ä¹ˆç®€å•.")]),s._v(" "),t("p",[s._v("æ‰€ä»¥æˆ‘åˆèŠ±æ—¶é—´ç†äº†ç† Linux ä¿¡å·çš„åŸºæœ¬çŸ¥è¯†, trace äº†ä¸€ä¸‹å†…æ ¸ä»£ç , ç»ˆäºæ‰¾åˆ°äº†çœŸæ­£çš„åŸå› , é‚£å°±æ˜¯å¯¹äº"),t("strong",[s._v("å‘é€ç»™ 1 å·è¿›ç¨‹çš„ä¿¡å·, å†…æ ¸ä¼šæ ¹æ®ä¸åŒçš„ç±»å‹, ä¸åŒçš„æ³¨å†ŒçŠ¶æ€, é‡‡å–ä¸åŒçš„å¤„ç†æ–¹å¼")]),s._v(". è¿™å°±æ˜¯è§£å†³å®¹å™¨é—®é¢˜æ—¶æˆ‘ä»¬éœ€è¦çš„ä¸€ä¸ªæ€åº¦: ä¸è¦æµ…å°è¾„æ­¢, è¦åˆ¨æ ¹é—®åº•.")]),s._v(" "),t("p",[s._v("æ€åº¦æœ‰äº†, é‚£å¦‚æœåœ¨çº¿ä¸Šç¢°åˆ°äº†æ›´åŠ å¤æ‚çš„é—®é¢˜, åˆè¯¥æ€ä¹ˆè§£å†³å‘¢? è¿™å°±éœ€è¦ä¸¤ä¸ªæ­¥éª¤äº†.")]),s._v(" "),t("p",[s._v("ç¬¬ä¸€æ­¥å°±æ˜¯**åŒ–ç¹ä¸ºç®€, é‡ç°é—®é¢˜. **")]),s._v(" "),t("p",[s._v("æƒ³è¦åšåˆ°è¿™ä¸€ç‚¹, å€’æ¨å›å», è¿˜æ˜¯éœ€è¦å¯¹åŸºæœ¬çš„æ¦‚å¿µè¶³å¤Ÿäº†è§£. åªæœ‰å¯¹æ¯ä¸ªæ¨¡å—çš„æ¦‚å¿µéƒ½å¾ˆæ¸…æ™°, æ‰èƒ½å¯¹å¤æ‚é—®é¢˜åšæ‹†åˆ†. èƒ½å¤Ÿå¯¹é—®é¢˜åšæ‹†åˆ†æ˜¯ä¸æ˜¯å°±å¤Ÿäº†å‘¢? å…¶å®è¿˜ä¸å¤Ÿ, æˆ‘è‡ªå·±æœ‰ä¸€ä¸ªåˆ¤æ–­æ ‡å‡†, å°±æ˜¯è¿˜è¦èƒ½å¤Ÿå†™æ¨¡æ‹Ÿç¨‹åº, çœ‹æ˜¯å¦å¯ä»¥ç”¨æœ€ç®€å•çš„ç¨‹åºæ¥é‡ç°é—®é¢˜. **å¦‚æœèƒ½ç”¨ç®€å•çš„ä»£ç ç¨‹åºé‡ç°é—®é¢˜, é‚£ä¹ˆé—®é¢˜ä¹Ÿå°±è§£å†³äº†ä¸€åŠ. **")]),s._v(" "),t("p",[s._v("æ¥ä¸‹æ¥è¿˜éœ€è¦è¿›è¡Œç¬¬äºŒæ­¥, å°±æ˜¯æƒ³åŠæ³•**æŠŠé»‘ç›’ç³»ç»Ÿå˜æˆç™½ç›’ç³»ç»Ÿ. **")]),s._v(" "),t("p",[s._v("å‰é¢æåˆ°è¿‡, å®¹å™¨çš„é—®é¢˜å¤§å¤šéƒ½ä¼šå½’ç»“åˆ° Linux ç³»ç»Ÿä¸Š. Linux ç³»ç»Ÿä»å†…æ ¸, åº“å‡½æ•°ä»¥åŠæœåŠ¡ç¨‹åºä¸Šçœ‹, è™½ç„¶éƒ½æ˜¯å¼€æºçš„, ä½†æ˜¯å®ƒè¿è¡Œåœ¨ç”Ÿäº§ç¯å¢ƒçš„æ—¶å€™, å‡ ä¹å°±æ˜¯ä¸€ä¸ªé»‘ç›’. ä¹‹æ‰€ä»¥è¯´ç³»ç»Ÿæ˜¯é»‘ç›’, ä¸€æ–¹é¢æ˜¯å› ä¸ºè¿™ä¸ªç³»ç»Ÿå¤ªåºå¤§, å¤ªå¤æ‚äº†; å¦ä¸€æ–¹é¢, åœ¨å®é™…è¿è¡Œçš„æ—¶å€™, åªæœ‰å¾ˆå°‘çš„ log ä¼šè®°å½•è¿è¡Œçš„è¿‡ç¨‹å’Œå‚æ•°. æ‰€ä»¥åœ¨å‡ºé—®é¢˜çš„æ—¶å€™, æ— æ³•çŸ¥é“é—®é¢˜å¯¹åº”çš„ä»£ç , ä¹Ÿä¸å¯èƒ½åœ¨ç”Ÿäº§ç¯å¢ƒä¸­éšå¿ƒæ‰€æ¬²åœ°åŠ  debug log.")]),s._v(" "),t("p",[s._v("å› æ­¤å°±éœ€è¦æƒ³ç‚¹åŠæ³•æŠŠå®ƒå˜æˆç™½ç›’, æ‰èƒ½å»æ’æŸ¥å’Œè§£å†³é—®é¢˜. å…·ä½“æ€ä¹ˆåšå‘¢? è¿™é‡Œéœ€è¦"),t("strong",[s._v("ç†Ÿç»ƒåœ°æŒæ¡è°ƒè¯•å·¥å…·")]),s._v(', è¿™æ ·æ‰èƒ½æŠŠæŸäº›å‡½æ•°å˜æˆ "ç™½ç›’", ä»è€Œæ‰¾åˆ°å¤æ‚é—®é¢˜çš„æ ¹æœ¬åŸå› , å†å¯¹ç—‡ä¸‹è¯. ç†Ÿç»ƒæŒæ¡å·¥å…·æœ‰ä¸ªé‡è¦å‰æ, å°±æ˜¯ä»å…¨å±€ä¸Šå»æŒæ¡ Linux ç³»ç»Ÿä»¥åŠå®¹å™¨, å›å½’åˆ°åº•å±‚åŸç†å»çœ‹é—®é¢˜. å¯ä»¥è¯´æŠŠåŸºç¡€æ¦‚å¿µåƒé€äº†, ç»ƒå¥½äº† "å†…åŠŸå¿ƒæ³•", æœ‰äº†è¿™ä¸ªåº•å­, å·¥å…·è¿ç”¨æ˜¯æ°´åˆ°æ¸ æˆçš„äº‹å„¿.')]),s._v(" "),t("h5",{attrs:{id:"_3-æœ¬èŠ‚è¯¾æ˜¯å¦‚ä½•è®¾è®¡çš„"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-æœ¬èŠ‚è¯¾æ˜¯å¦‚ä½•è®¾è®¡çš„"}},[s._v("#")]),s._v(" 3.æœ¬èŠ‚è¯¾æ˜¯å¦‚ä½•è®¾è®¡çš„?")]),s._v(" "),t("p",[s._v("è¿™é—¨è¯¾ç¨‹ä¼šæŠŠé›¶æ•£çš„çŸ¥è¯†ç‚¹ä½“ç³»åŒ–, æŒ‰ç…§ç±»ä¼¼æ“ä½œç³»ç»Ÿçš„æ¨¡å—åˆ’åˆ†, æ¥è®²è¿°æˆ‘æ‰€ç†è§£çš„å®¹å™¨.")]),s._v(" "),t("p",[s._v("æˆ‘ä»¬å°†ä¸€èµ·å­¦ä¹ "),t("strong",[s._v("å®¹å™¨è¿›ç¨‹, å®¹å™¨å†…å­˜, å®¹å™¨å­˜å‚¨,  å®¹å™¨ç½‘ç»œ, å®¹å™¨å®‰å…¨")]),s._v("è¿™å‡ éƒ¨åˆ†å†…å®¹. åœ¨æ¯ä¸€èŠ‚è¯¾ä¸­, éƒ½ä¼šè§£å†³ä¸€ä¸ªå®é™…é—®é¢˜æˆ–è€…ç ”ç©¶ä¸€ä¸ªç°è±¡. å›´ç»•è¿™ä¸ªé—®é¢˜, ä¼šè®²è§£ç›¸å…³çš„çŸ¥è¯†ç‚¹, å¹¶ç»“åˆå®é™…çš„æ“ä½œåšç†è§£, æœ€ç»ˆè§£å†³é—®é¢˜æˆ–è€…è§£é‡Šç°è±¡.")]),s._v(" "),t("p",[s._v("è¦å®ç°ä¸¤ä¸ªå­¦ä¹ ç›®æ ‡.")]),s._v(" "),t("p",[s._v("**ç¬¬ä¸€, ç³»ç»ŸæŒæ¡å®¹å™¨æ ¸å¿ƒç‚¹: Namespace å’Œ Cgroups. **")]),s._v(" "),t("p",[s._v("**ç¬¬äºŒ, ç†è§£ Namespace å’Œ Cgroups å¯¹ Linux åŸæ¥æ¨¡å—çš„å½±å“, çœ‹çœ‹å®ƒä»¬æ˜¯å¦‚ä½•å½±å“ä¸€äº›ä¼ ç»Ÿæ“ä½œç³»ç»Ÿçš„è¡Œä¸º. **")]),s._v(" "),t("p",[s._v("æ¯”å¦‚ Memory Cgroup, å¯¹ Pagecache å’Œ Swap ç©ºé—´æœ‰æ€æ ·çš„å½±å“; å†æ¯”å¦‚åœ¨ proc æ–‡ä»¶ç³»ç»Ÿä¸‹, ç½‘ç»œå‚æ•°åº”ç”¨äº† Network Namespace ä¹‹å, éœ€è¦å¦‚ä½•é‡æ–°è®¾ç½®ç­‰ç­‰.")]),s._v(" "),t("p",[s._v("å½“ä¸€èµ·æŠŠå®¹å™¨çŸ¥è¯†çš„æ¡†æ¶æ­å»ºèµ·æ¥, æŠŠé‡Œé¢çš„æ ¸å¿ƒæ¦‚å¿µ, åº•å±‚é€»è¾‘æŒæ¡ä¹‹å, å…¶å®å°±å¯ä»¥è§£å†³å®¹å™¨çš„å¤§éƒ¨åˆ†é—®é¢˜äº†.")]),s._v(" "),t("p",[s._v("è¯¾ç¨‹ç»“æŸå, ä¼šåšä¸€ä¸ªä¸“é¢˜åŠ é¤. æˆ‘é€‰æ‹©äº†ä¸€ä¸ªçœŸå®æ¡ˆä¾‹, å°±æ˜¯åœ¨ç”Ÿäº§ç¯å¢ƒä¸­å®¹å™¨ç½‘ç»œå»¶æ—¶ä¸ç¨³å®šçš„é—®é¢˜. åœ¨è¿™ä¸ªæ¡ˆä¾‹ä¸­, ä¼šç”¨åˆ° "),t("strong",[s._v("perf, ftrace, bcc/ebpf è¿™å‡ ä¸ª Linux è°ƒè¯•å·¥å…·")]),s._v(", äº†è§£å®ƒä»¬çš„åŸç†, ç†Ÿæ‚‰å®ƒä»¬åœ¨è°ƒè¯•é—®é¢˜çš„ä¸åŒé˜¶æ®µæ‰€å‘æŒ¥çš„ä½œç”¨, ç„¶åç”¨è¿™äº›å·¥å…·ä¸€èµ·æ¥è§£å†³ç°å®åœºæ™¯ä¸­å¤æ‚çš„å®¹å™¨é—®é¢˜.")]),s._v(" "),t("p",[s._v("åœ¨è¿™ä¸ªå®¹å™¨è¯¾ç¨‹ä¸­, æ¯ä¸€è®²é‡Œéƒ½ä¼šæœ‰ä¸€äº›å°ä¾‹å­, æ‰€ä»¥éœ€è¦**æœ‰ä¸€å°å®‰è£…æœ‰ Linux çš„æœºå™¨, æˆ–è€…ç”¨ VirtualBox å®‰è£…ä¸€ä¸ªè™šæ‹Ÿæœºæ¥è·‘ Linux. Linux çš„ç‰ˆæœ¬å»ºè®®æ˜¯ CentOS 8 æˆ–è€…æ˜¯ Ubuntu 20.04. **")]),s._v(" "),t("p",[s._v('æœ€åæˆ‘æƒ³è¯´, **å®¹å™¨æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„æŠ€æœ¯çª—å£, å®ƒå¯ä»¥å¸®åŠ©ä½ åœ¨è¿™ä¸ªç¬æ¯ä¸‡å˜çš„è®¡ç®—æœºä¸–ç•Œé‡Œçœ‹åˆ°åé¢é‚£äº› "ä¸å˜" çš„æŠ€æœ¯, åªæœ‰æŒæ¡å¥½é‚£äº› "ä¸å˜" çš„æŠ€æœ¯, æ‰å¯ä»¥æ›´åŠ ä»å®¹åœ°å»æ¥å—æŠ€æœ¯çš„ç¬æ¯ä¸‡å˜. **')]),s._v(" "),t("h4",{attrs:{id:"_01-è®¤è¯†å®¹å™¨-å®¹å™¨çš„åŸºæœ¬æ“ä½œå’Œå®ç°åŸç†"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_01-è®¤è¯†å®¹å™¨-å®¹å™¨çš„åŸºæœ¬æ“ä½œå’Œå®ç°åŸç†"}},[s._v("#")]),s._v(" 01 | è®¤è¯†å®¹å™¨:å®¹å™¨çš„åŸºæœ¬æ“ä½œå’Œå®ç°åŸç†")]),s._v(" "),t("p",[s._v('å®¹å™¨è¿™ä¸œè¥¿ä¸€ç‚¹éƒ½ä¸å¤æ‚, å¦‚æœä½ åªæ˜¯æƒ³ç”¨çš„è¯, é‚£è·Ÿç€Docker å®˜ç½‘çš„è¯´æ˜, åº”è¯¥åæ¥åˆ†é’Ÿå°±èƒ½æå®š. ç®€å•æ¥è¯´, å®ƒå°±æ˜¯ä¸ªå°å·¥å…·, å¯ä»¥æŠŠä½ æƒ³è·‘çš„ç¨‹åº, åº“æ–‡ä»¶å•Š, é…ç½®æ–‡ä»¶éƒ½ä¸€èµ· "æ‰“åŒ…". ç„¶ååœ¨ä»»ä½•ä¸€ä¸ªè®¡ç®—æœºçš„èŠ‚ç‚¹ä¸Š, éƒ½å¯ä»¥ä½¿ç”¨è¿™ä¸ªæ‰“å¥½çš„åŒ…. æœ‰äº†å®¹å™¨, ä¸€ä¸ªå‘½ä»¤å°±èƒ½æŠŠæƒ³è·‘çš„ç¨‹åºè·‘èµ·æ¥, åšåˆ°äº†**ä¸€æ¬¡æ‰“åŒ…, å°±å¯ä»¥åˆ°å¤„ä½¿ç”¨. **')]),s._v(" "),t("p",[s._v("æœ¬èŠ‚æ¥èŠèŠå®¹å™¨èƒŒåçš„å®ç°æœºåˆ¶. ç©ºè®²åŸç†ä¹Ÿæ²¡ä»€ä¹ˆæ„Ÿè§‰, æ‰€ä»¥è¿˜æ˜¯ä¼šå…ˆå¯åŠ¨ä¸€ä¸ªå®¹å™¨, ç„¶åå†ä¸€èµ·æ¥æ¢è®¨å®¹å™¨é‡Œé¢çš„"),t("mark",[t("strong",[s._v("ä¸¤å¤§å…³é”®æŠ€æœ¯---Namespace å’Œ Cgroups")])]),s._v(". åŸºæœ¬ä¸Šç†è§£äº†è¿™ä¸¤ä¸ªæ¦‚å¿µ, å°±èƒ½å½»åº•ææ‡‚å®¹å™¨çš„æ ¸å¿ƒåŸç†äº†.")]),s._v(" "),t("h5",{attrs:{id:"_1-åšä¸ªé•œåƒ"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-åšä¸ªé•œåƒ"}},[s._v("#")]),s._v(" 1.åšä¸ªé•œåƒ")]),s._v(" "),t("p",[s._v("å¯åŠ¨å®¹å™¨çš„å·¥å…·æœ‰å¾ˆå¤š, åœ¨è¿™é‡Œè¿˜æ˜¯ä½¿ç”¨ Docker è¿™ä¸ªæœ€å¸¸ç”¨çš„å®¹å™¨ç®¡ç†å·¥å…·. å®‰è£…å®Œ Docker ä¹‹å, å…ˆæ¥ç”¨ä¸‹é¢çš„å‘½ä»¤è¿è¡Œä¸€ä¸ª httpd æœåŠ¡.")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" run "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-d")]),s._v(" centos/httpd:latest\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("è¿™å‘½ä»¤ä¹Ÿå¾ˆç®€å•, run çš„æ„æ€å°±æ˜¯è¦å¯åŠ¨ä¸€ä¸ªå®¹å™¨, "),t("code",[s._v("-d")]),s._v("â€‹ å‚æ•°é‡Œ d æ˜¯ Daemon çš„é¦–å­—æ¯, ä¹Ÿå°±æ˜¯è®©å®¹å™¨åœ¨åå°è¿è¡Œ.")]),s._v(" "),t("p",[s._v("æœ€åä¸€ä¸ªå‚æ•° "),t("code",[s._v("centos/httpd:latest")]),s._v("â€‹ æŒ‡å®šäº†å…·ä½“è¦å¯åŠ¨å“ªä¸€ä¸ª"),t("strong",[s._v("é•œåƒ")]),s._v(", æ¯”å¦‚è¿™é‡Œå¯åŠ¨çš„æ˜¯ centos/httpd è¿™ä¸ªé•œåƒçš„ latest ç‰ˆæœ¬.")]),s._v(" "),t("p",[s._v("å…¶å®é•œåƒå°±æ˜¯ä¸€ä¸ª"),t("mark",[s._v("ç‰¹æ®Šçš„")]),s._v("â€‹"),t("mark",[t("strong",[s._v("æ–‡ä»¶ç³»ç»Ÿ")])]),s._v("â€‹"),t("mark",[s._v(", ")]),s._v("â€‹"),t("mark",[t("strong",[s._v("å®ƒæä¾›äº†å®¹å™¨ä¸­ç¨‹åºæ‰§è¡Œéœ€è¦çš„æ‰€æœ‰æ–‡ä»¶")])]),s._v("â€‹ "),t("strong",[s._v(". ** å…·ä½“æ¥è¯´, å°±æ˜¯")]),s._v("åº”ç”¨ç¨‹åºæƒ³å¯åŠ¨, éœ€è¦ä¸‰ç±»æ–‡ä»¶: "),t("strong",[s._v("â€‹"),t("mark",[t("strong",[s._v("ç›¸å…³çš„ç¨‹åºå¯æ‰§è¡Œæ–‡ä»¶, åº“æ–‡ä»¶å’Œé…ç½®æ–‡ä»¶")])]),s._v(", è¿™ä¸‰ç±»æ–‡ä»¶")]),s._v("éƒ½è¢«å®¹å™¨æ‰“åŒ…åšå¥½"),t("strong",[s._v("äº†. è¿™æ ·åœ¨å®¹å™¨è¿è¡Œçš„æ—¶å€™å°±")]),s._v("ä¸å†ä¾èµ–å®¿ä¸»æœºä¸Šçš„æ–‡ä»¶æ“ä½œç³»ç»Ÿç±»å‹å’Œé…ç½®**äº†, åšåˆ°äº†æƒ³åœ¨å“ªä¸ªèŠ‚ç‚¹ä¸Šè¿è¡Œ, å°±å¯ä»¥åœ¨å“ªä¸ªèŠ‚ç‚¹ä¸Šç«‹åˆ»è¿è¡Œ.")]),s._v(" "),t("p",[s._v("é‚£ä¹ˆæ€ä¹ˆæ¥åšä¸€ä¸ªå®¹å™¨é•œåƒå‘¢?")]),s._v(" "),t("p",[s._v("åˆšæ‰çš„ä¾‹å­é‡Œ, ç”¨çš„ "),t("code",[s._v("centos/httpd:latest")]),s._v("â€‹ è¿™ä¸ªé•œåƒæ˜¯ "),t("strong",[s._v("Docker é•œåƒåº“")]),s._v("é‡Œç›´æ¥æä¾›çš„. å½“ç„¶ä¹Ÿå¯ä»¥è‡ªå·±åšä¸€ä¸ªæä¾› httpd æœåŠ¡çš„å®¹å™¨é•œåƒ, è¿™é‡Œä»ç„¶å¯ä»¥ç”¨ Docker è¿™ä¸ªå·¥å…·æ¥è‡ªå®šä¹‰é•œåƒ.")]),s._v(" "),t("p",[s._v("Docker ä¸ºç”¨æˆ·è‡ªå·±å®šä¹‰é•œåƒæä¾›äº†ä¸€ä¸ªå«åš "),t("strong",[s._v("Dockerfile çš„æ–‡ä»¶")]),s._v(", åœ¨è¿™ä¸ª Dockerfile æ–‡ä»¶é‡Œ, å¯ä»¥è®¾å®šè‡ªå·±é•œåƒçš„åˆ›å»ºæ­¥éª¤.")]),s._v(" "),t("p",[s._v("å¦‚æœè‡ªå·±æ¥åšä¸€ä¸ª httpd çš„é•œåƒä¹Ÿä¸éš¾, å…¶ Dockerfile å¦‚ä¸‹.")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("$ "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" Dockerfile\nFROM centos:8.1.1911\nRUN yum "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-y")]),s._v(" httpd\nCOPY file1 /var/www/html/\nADD  file2.tar.gz /var/www/html/\nCMD "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/sbin/httpd"')]),s._v(", "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"-D"')]),s._v(", "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"FOREGROUND"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br")])]),t("p",[s._v("çœ‹ä¸‹å®ƒåšäº†å“ªå‡ ä»¶äº‹: åœ¨ä¸€ä¸ª centos çš„"),t("strong",[s._v("åŸºå‡†é•œåƒ")]),s._v("ä¸Šå®‰è£…å¥½ httpd çš„åŒ…, ç„¶ååœ¨ httpd æä¾›æ–‡ä»¶æœåŠ¡çš„é…ç½®ç›®å½•ä¸‹, æŠŠéœ€è¦å¯¹å¤–æä¾›çš„æ–‡ä»¶ file1 å’Œ file2 æ‹·è´è¿‡å», æœ€åæŒ‡å®šå®¹å™¨å¯åŠ¨ä»¥å, éœ€è¦è‡ªåŠ¨å¯åŠ¨çš„ httpd æœåŠ¡. æœ‰äº†è¿™ä¸ªé•œåƒ, å¸Œæœ›å®¹å™¨å¯åŠ¨å, å°±è¿è¡Œè¿™ä¸ª httpd æœåŠ¡, è®©ç”¨æˆ·å¯ä»¥ä¸‹è½½ file1 è¿˜æœ‰ file2 è¿™ä¸¤ä¸ªæ–‡ä»¶.")]),s._v(" "),t("p",[s._v("è¿™ä¸ª Dockerfile çš„æ¯ä¸€è¡Œ, ç¬¬ä¸€ä¸ªå¤§å†™çš„è¯éƒ½æ˜¯ Dockerfile ä¸“é—¨å®šä¹‰çš„æŒ‡ä»¤, ä¹Ÿå°±æ˜¯ "),t("code",[s._v("FROM")]),s._v("â€‹, "),t("code",[s._v("RUN")]),s._v("â€‹, "),t("code",[s._v("COPY")]),s._v("â€‹, "),t("code",[s._v("ADD")]),s._v("â€‹, "),t("code",[s._v("CMD")]),s._v("â€‹, è¿™äº›æŒ‡ä»¤éƒ½å¾ˆåŸºç¡€, æ‰€ä»¥ä¸åšè¯¦ç»†è§£é‡Šäº†, å¯ä»¥å‚è€ƒ Dockerfile çš„å®˜æ–¹æ–‡æ¡£.")]),s._v(" "),t("p",[s._v("å†™å®Œè¿™ä¸ª Dockerfile ä¹‹å, æƒ³è¦è®©å®ƒå˜æˆä¸€ä¸ªé•œåƒ, è¿˜éœ€è¦æ‰§è¡Œä¸€ä¸‹ "),t("code",[s._v("docker build")]),s._v("â€‹ å‘½ä»¤.")]),s._v(" "),t("p",[s._v("ä¸‹é¢è¿™ä¸ªå‘½ä»¤ä¸­ "),t("code",[s._v("-f ./Dockerfile")]),s._v("â€‹ æŒ‡å®š Dockerfile æ–‡ä»¶, "),t("code",[s._v("-t registry/httpd:v1")]),s._v('â€‹ æŒ‡å®šäº†ç”Ÿæˆå‡ºæ¥çš„é•œåƒå, å®ƒçš„æ ¼å¼æ˜¯ "name:tag", è¿™ä¸ªé•œåƒåä¹Ÿæ˜¯åé¢å¯åŠ¨å®¹å™¨éœ€è¦ç”¨åˆ°çš„.')]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("$ "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" build "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-t")]),s._v(" registry/httpd:v1 "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-f")]),s._v(" ./Dockerfile "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(".")]),s._v(" \n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("â€‹"),t("code",[s._v("docker build")]),s._v("â€‹ æ‰§è¡ŒæˆåŠŸä¹‹å, å†è¿è¡Œ "),t("code",[s._v("docker images")]),s._v("â€‹ è¿™ä¸ªå‘½ä»¤, å°±å¯ä»¥çœ‹åˆ°ç”Ÿæˆçš„é•œåƒäº†.")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("$ "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" images\nREPOSITORY  TAG   IMAGEID  CREATED   SIZE\nregistry/httpd  v1  c682fc3d4b9a  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v(" seconds ago  277MB\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br")])]),t("h5",{attrs:{id:"_2-å¯åŠ¨ä¸€ä¸ªå®¹å™¨-container"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-å¯åŠ¨ä¸€ä¸ªå®¹å™¨-container"}},[s._v("#")]),s._v(" 2.å¯åŠ¨ä¸€ä¸ªå®¹å™¨(Container)")]),s._v(" "),t("p",[s._v("åšå®Œä¸€ä¸ªé•œåƒä¹‹å, å°±å¯ä»¥ç”¨è¿™ä¸ªé•œåƒæ¥å¯åŠ¨ä¸€ä¸ªå®¹å™¨äº†, åˆšæ‰åšçš„é•œåƒåå­—æ˜¯ registry/httpd:v1, é‚£ä¹ˆè¿˜æ˜¯ç”¨ docker run è¿™ä¸ªå‘½ä»¤æ¥å¯åŠ¨å®¹å™¨.")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("$ "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" run "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-d")]),s._v(" registry/httpd:v1\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("å®¹å™¨å¯åŠ¨å®Œæˆå, å¯ä»¥ç”¨ "),t("code",[s._v("docker ps")]),s._v("â€‹ å‘½ä»¤æ¥æŸ¥çœ‹è¿™ä¸ªå·²ç»å¯åŠ¨çš„å®¹å™¨:")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("$ "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ps")]),s._v("\nCONTAINER ID      IMAGE        COMMAND     CREATED       STATUS        PORTS               NAMES\nc5a9ff78d9c1        registry/httpd:v1   "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/sbin/httpd -D FOREâ€¦"')]),s._v("   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" seconds ago       Up "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" seconds                            loving_jackson\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br")])]),t("p",[s._v("åœ¨å‰é¢ä»‹ç» Dockerfile çš„æ—¶å€™è¯´è¿‡åšè¿™ä¸ªé•œåƒæ˜¯ç”¨æ¥æä¾› HTTP æœåŠ¡çš„, ä¹Ÿå°±æ˜¯è®©ç”¨æˆ·å¯ä»¥ä¸‹è½½ file1, file2 è¿™ä¸¤ä¸ªæ–‡ä»¶.")]),s._v(" "),t("p",[s._v("é‚£æ€æ ·æ¥éªŒè¯å»ºèµ·æ¥çš„å®¹å™¨æ˜¯ä¸æ˜¯æ­£å¸¸å·¥ä½œçš„å‘¢? å¯ä»¥é€šè¿‡è¿™ä¸¤æ­¥æ¥éªŒè¯:")]),s._v(" "),t("ol",[t("li",[s._v("ç¬¬ä¸€æ­¥, å¯ä»¥è¿›å…¥å®¹å™¨çš„è¿è¡Œç©ºé—´, æŸ¥çœ‹ httpd æœåŠ¡æ˜¯ä¸æ˜¯å¯åŠ¨äº†, é…ç½®æ–‡ä»¶æ˜¯ä¸æ˜¯æ­£ç¡®çš„.")]),s._v(" "),t("li",[s._v("ç¬¬äºŒæ­¥, å¯¹äº HTTP æ–‡ä»¶æœåŠ¡, å¦‚æœèƒ½ç”¨ "),t("code",[s._v("curl")]),s._v("â€‹ å‘½ä»¤ä¸‹è½½æ–‡ä»¶, å°±å¯ä»¥è¯æ˜è¿™ä¸ªå®¹å™¨æä¾›äº†é¢„æœŸçš„ httpd æœåŠ¡.")])]),s._v(" "),t("p",[s._v("å…ˆæ¥åšç¬¬ä¸€æ­¥éªŒè¯, å¯ä»¥è¿è¡Œ "),t("code",[s._v("docker exec")]),s._v("â€‹ è¿™ä¸ªå‘½ä»¤è¿›å…¥å®¹å™¨çš„"),t("strong",[s._v("è¿è¡Œç©ºé—´")]),s._v(", è‡³äºä»€ä¹ˆæ˜¯å®¹å™¨çš„è¿è¡Œç©ºé—´, å®ƒçš„æ ‡å‡†è¯´æ³•æ˜¯å®¹å™¨çš„å‘½åç©ºé—´(Namespace), è¿™ä¸ªæ¦‚å¿µç­‰ä¼šå„¿å†åšä»‹ç».")]),s._v(" "),t("p",[s._v("è¿›å…¥å®¹å™¨è¿è¡Œç©ºé—´ä¹‹å, æ€ä¹ˆç¡®è®¤ httpd çš„æœåŠ¡è¿›ç¨‹å·²ç»åœ¨å®¹å™¨é‡Œå¯åŠ¨äº†å‘¢?")]),s._v(" "),t("p",[s._v("è¿è¡Œä¸‹é¢è¿™ä¸ª "),t("code",[s._v("docker exec")]),s._v("â€‹ å‘½ä»¤, ä¹Ÿå°±æ˜¯æ‰§è¡Œ "),t("code",[s._v("docker exec c5a9ff78d9c1 ps -ef")]),s._v("â€‹, å¯ä»¥çœ‹åˆ° httpd çš„æœåŠ¡è¿›ç¨‹æ­£åœ¨å®¹å™¨çš„ç©ºé—´ä¸­è¿è¡Œ.")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("$ "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("exec")]),s._v(" c5a9ff78d9c1 "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ps")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-ef")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token environment constant"}},[s._v("UID")]),s._v("        PID  "),t("span",{pre:!0,attrs:{class:"token environment constant"}},[s._v("PPID")]),s._v("  C STIME TTY          TIME CMD\nroot         "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("     "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" 01:59 ?        00:00:00 /sbin/httpd "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-D")]),s._v(" FOREGROUND\napache       "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("6")]),s._v("     "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" 01:59 ?        00:00:00 /sbin/httpd "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-D")]),s._v(" FOREGROUND\napache       "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("7")]),s._v("     "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" 01:59 ?        00:00:00 /sbin/httpd "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-D")]),s._v(" FOREGROUND\napache       "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("8")]),s._v("     "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" 01:59 ?        00:00:00 /sbin/httpd "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-D")]),s._v(" FOREGROUND\napache       "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("9")]),s._v("     "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" 01:59 ?        00:00:00 /sbin/httpd "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-D")]),s._v(" FOREGROUND\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br")])]),t("p",[s._v("è§£é‡Šä¸€ä¸‹, åœ¨è¿™ä¸ª "),t("code",[s._v("docker exec")]),s._v("â€‹ åé¢ç´§è·Ÿç€çš„ ID è¡¨ç¤ºå®¹å™¨çš„ ID, è¿™ä¸ª ID å°±æ˜¯ä¹‹å‰è¿è¡Œ "),t("code",[s._v("docker ps")]),s._v("â€‹ æŸ¥çœ‹è¿‡é‚£ä¸ªå®¹å™¨, å®¹å™¨çš„ ID å€¼æ˜¯ "),t("code",[s._v("c5a9ff78d9c1")]),s._v("â€‹. åœ¨è¿™ä¸ª ID å€¼çš„åé¢, å°±æ˜¯è¦åœ¨å®¹å™¨ç©ºé—´é‡Œè¿è¡Œçš„ "),t("code",[s._v("ps -ef")]),s._v("â€‹ å‘½ä»¤.")]),s._v(" "),t("p",[s._v("æ¥ä¸‹æ¥å†æ¥ç¡®è®¤ä¸€ä¸‹, httpd æä¾›æ–‡ä»¶æœåŠ¡çš„ç›®å½•ä¸­ file1 å’Œ file2 æ–‡ä»¶æ˜¯å¦å­˜åœ¨.")]),s._v(" "),t("p",[s._v("åŒæ ·å¯ä»¥ç”¨ "),t("code",[s._v("docker exec")]),s._v("â€‹ æ¥æŸ¥çœ‹ä¸€ä¸‹å®¹å™¨çš„æ–‡ä»¶ç³»ç»Ÿä¸­, httpd æä¾›æ–‡ä»¶æœåŠ¡çš„ç›®å½• "),t("code",[s._v("/var/www/html")]),s._v("â€‹ æ˜¯å¦æœ‰è¿™ä¸¤ä¸ªæ–‡ä»¶. å¾ˆå¥½, å¯ä»¥çœ‹åˆ° file1, file2 è¿™ä¸¤ä¸ªæ–‡ä»¶ä¹Ÿéƒ½æ”¾åœ¨æŒ‡å®šç›®å½•ä¸­äº†.")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("$ "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("exec")]),s._v(" c5a9ff78d9c1 "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ls")]),s._v(" /var/www/html\nfile1\nfile2\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br")])]),t("p",[s._v("åˆ°è¿™é‡Œå®Œæˆäº†ç¬¬ä¸€æ­¥çš„éªŒè¯, è¿›å…¥åˆ°å®¹å™¨çš„è¿è¡Œç©ºé—´é‡Œ, éªŒè¯äº† httpd æœåŠ¡å·²ç»å¯åŠ¨, é…ç½®æ–‡ä»¶ä¹Ÿæ˜¯æ­£ç¡®çš„.")]),s._v(" "),t("p",[s._v("é‚£ä¸‹é¢è¦åšç¬¬äºŒæ­¥çš„éªŒè¯, ç”¨ "),t("code",[s._v("curl")]),s._v("â€‹ å‘½ä»¤æ¥éªŒè¯æ˜¯å¦å¯ä»¥ä»å®¹å™¨çš„ httpd æœåŠ¡é‡Œä¸‹è½½åˆ°æ–‡ä»¶.")]),s._v(" "),t("p",[s._v("å¦‚æœè¦è®¿é—® httpd æœåŠ¡, å°±éœ€è¦çŸ¥é“è¿™ä¸ªå®¹å™¨çš„ IP åœ°å€. å®¹å™¨çš„ç½‘ç»œç©ºé—´ä¹Ÿæ˜¯ç‹¬ç«‹çš„, æœ‰ä¸€ä¸ªå®ƒè‡ªå·±çš„ IP. è¿˜æ˜¯å¯ä»¥ç”¨ "),t("code",[s._v("docker exec")]),s._v("â€‹ è¿›å…¥åˆ°å®¹å™¨çš„ç½‘ç»œç©ºé—´, æŸ¥çœ‹ä¸€ä¸‹è¿™ä¸ªå®¹å™¨çš„ IP.")]),s._v(" "),t("p",[s._v("è¿è¡Œä¸‹é¢çš„è¿™æ¡ "),t("code",[s._v("docker exec c5a9ff78d9c1 ip addr")]),s._v("â€‹ å‘½ä»¤, å¯ä»¥çœ‹åˆ°å®¹å™¨é‡Œç½‘ç»œæ¥å£ eth0 ä¸Šé…ç½®çš„ IP æ˜¯ "),t("code",[s._v("172.17.0.2")]),s._v("â€‹. è¿™ä¸ª IP ç›®å‰"),t("strong",[s._v("åªèƒ½åœ¨å®¹å™¨çš„å®¿ä¸»æœºä¸Šè®¿é—®")]),s._v(", åœ¨åˆ«çš„æœºå™¨ä¸Šç›®å‰æ˜¯ä¸èƒ½è®¿é—®çš„. å…³äºå®¹å™¨ç½‘ç»œçš„çŸ¥è¯†, ä¼šåœ¨åé¢ä»‹ç».")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("$ "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("exec")]),s._v(" c5a9ff78d9c1 "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ip")]),s._v(" addr\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(": lo: "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("LOOPBACK,UP,LOWER_UP"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" mtu "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("65536")]),s._v(" qdisc noqueue state UNKNOWN group default qlen "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1000")]),s._v("\n    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00\n    inet "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1/8 scope "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("host")]),s._v(" lo\n       valid_lft forever preferred_lft forever\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("168")]),s._v(": eth0@if169: "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("BROADCAST,MULTICAST,UP,LOWER_UP"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" mtu "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1500")]),s._v(" qdisc noqueue state UP group default\n    link/ether 02:42:ac:11:00:02 brd ff:ff:ff:ff:ff:ff link-netnsid "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\n    inet "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.17")]),s._v(".0.2/16 brd "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.17")]),s._v(".255.255 scope global eth0\n       valid_lft forever preferred_lft forever\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br")])]),t("p",[s._v("è·å–äº† httpd æœåŠ¡çš„ IP åœ°å€ä¹‹å, éšä¾¿ä¸‹è½½ä¸€ä¸ªæ–‡ä»¶è¯•è¯•, æ¯”å¦‚é€‰ file2.")]),s._v(" "),t("p",[s._v("åœ¨å®¿ä¸»æœºä¸Šè¿è¡Œ "),t("code",[s._v("curl")]),s._v("â€‹, å°±å¯ä»¥ä¸‹è½½è¿™ä¸ªæ–‡ä»¶äº†, æ“ä½œå¦‚ä¸‹. æ–‡ä»¶ä¸‹è½½æˆåŠŸäº†, è¿™è¯æ˜äº†è¿™ä¸ªæä¾› httpd æœåŠ¡çš„å®¹å™¨æ­£å¸¸è¿è¡Œäº†.")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("$ "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("curl")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-L")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-O")]),s._v(" http://172.17.0.2/file2\n  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current\n                                 Dload  Upload   Total   Spent    Left  Speed\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("100")]),s._v("     "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("6")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("100")]),s._v("     "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("6")]),s._v("    "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("     "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1500")]),s._v("      "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" --:--:-- --:--:-- --:--:--  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1500")]),s._v("\n$ "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ls")]),s._v("\nfile2\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br")])]),t("p",[s._v("ä¸Šé¢çš„æ­¥éª¤å®Œæˆä¹‹å, ç¬¬äºŒæ­¥éªŒè¯, ç”¨ "),t("code",[s._v("curl")]),s._v("â€‹ ä¸‹è½½ httpd æœåŠ¡æä¾›çš„æ–‡ä»¶ä¹ŸæˆåŠŸäº†.")]),s._v(" "),t("p",[s._v("é€šè¿‡è¿™ä¸Šé¢çš„è¿™äº›æ“ä½œç»ƒä¹ , ä¼°è®¡ä½ å·²ç»åˆæ­¥æ„ŸçŸ¥åˆ°, "),t("strong",[s._v("å®¹å™¨çš„æ–‡ä»¶ç³»ç»Ÿæ˜¯ç‹¬ç«‹çš„, è¿è¡Œçš„è¿›ç¨‹ç¯å¢ƒæ˜¯ç‹¬ç«‹çš„, ç½‘ç»œçš„è®¾ç½®ä¹Ÿæ˜¯ç‹¬ç«‹çš„")]),s._v(". æ„Ÿè§‰å®ƒä»¬å’Œå®¿ä¸»æœºä¸Šçš„æ–‡ä»¶ç³»ç»Ÿ, è¿›ç¨‹ç¯å¢ƒä»¥åŠç½‘ç»œæ„Ÿè§‰éƒ½å·²ç»åˆ†å¼€äº†. çš„ç¡®æ˜¯è¿™æ ·. åˆšæ‰å¯åŠ¨çš„å®¹å™¨, å·²ç»ä»å®¿ä¸»æœºç¯å¢ƒé‡Œè¢«åˆ†éš”å‡ºæ¥äº†, å°±åƒä¸‹é¢è¿™å¼ å›¾é‡Œçš„æè¿°ä¸€æ ·.")]),s._v(" "),t("p",[t("img",{attrs:{src:"/img/522a5bef9073ca778a5295ac78ecb801-20230731161430-ys3fcge.png",alt:""}})]),s._v(" "),t("p",[s._v("**ä»ç”¨æˆ·ä½¿ç”¨çš„è§’åº¦æ¥çœ‹, å®¹å™¨å’Œä¸€å°ç‹¬ç«‹çš„æœºå™¨æˆ–è€…è™šæ‹Ÿæœºæ²¡æœ‰ä»€ä¹ˆå¤ªå¤§çš„åŒºåˆ«, ä½†æ˜¯å®ƒå’Œè™šæ‹Ÿæœºç›¸æ¯”, å´æ²¡æœ‰å„ç§å¤æ‚çš„ç¡¬ä»¶è™šæ‹Ÿå±‚, æ²¡æœ‰ç‹¬ç«‹çš„ Linux å†…æ ¸. **")]),s._v(" "),t("p",[t("strong",[s._v("å®¹å™¨æ‰€æœ‰çš„è¿›ç¨‹è°ƒåº¦, å†…å­˜è®¿é—®, æ–‡ä»¶çš„è¯»å†™éƒ½ç›´æ¥è·‘åœ¨å®¿ä¸»æœºçš„å†…æ ¸ä¹‹ä¸Š")]),s._v(", è¿™æ˜¯æ€ä¹ˆåšåˆ°çš„å‘¢?")]),s._v(" "),t("h5",{attrs:{id:"_3-å®¹å™¨æ˜¯ä»€ä¹ˆ"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-å®¹å™¨æ˜¯ä»€ä¹ˆ"}},[s._v("#")]),s._v(" 3.å®¹å™¨æ˜¯ä»€ä¹ˆ")]),s._v(" "),t("p",[s._v("è¦å›ç­”è¿™ä¸ªé—®é¢˜, å¯ä»¥å…ˆè®°ä½è¿™ä¸¤ä¸ªæœ¯è¯­ "),t("mark",[t("strong",[s._v("Namespace å’Œ Cgroups")])]),s._v(". å¦‚æœæœ‰äººé—®ä½  Linux ä¸Šçš„å®¹å™¨æ˜¯ä»€ä¹ˆ, æœ€ç®€å•ç›´æ¥çš„å›ç­”å°±æ˜¯ Namesapce å’Œ Cgroups. "),t("mark",[t("strong",[s._v("Namespace å’Œ Cgroups å¯ä»¥è®©ç¨‹åºåœ¨ä¸€ä¸ªèµ„æºå¯æ§çš„ç‹¬ç«‹(éš”ç¦»)ç¯å¢ƒä¸­è¿è¡Œ, è¿™ä¸ªå°±æ˜¯å®¹å™¨äº†")])]),s._v(".")]),s._v(" "),t("p",[s._v("ç°åœ¨å·²ç»å‘ç°: å®¹å™¨çš„è¿›ç¨‹, ç½‘ç»œè¿˜æœ‰æ–‡ä»¶ç³»ç»Ÿéƒ½æ˜¯ç‹¬ç«‹çš„. é‚£é—®é¢˜æ¥äº†, å®¹å™¨çš„ç‹¬ç«‹è¿è¡Œç¯å¢ƒåˆ°åº•æ˜¯æ€ä¹ˆåˆ›é€ çš„å‘¢? è¿™å°±è¦æåˆ° Namespace è¿™ä¸ªæ¦‚å¿µäº†. æ‰€ä»¥æ¥ä¸‹æ¥å°±å…ˆä»å·²ç»æœ‰ç‚¹æ„Ÿè§‰çš„ Namespace å¼€å§‹åˆ†æ.")]),s._v(" "),t("h6",{attrs:{id:"_1-namespace"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-namespace"}},[s._v("#")]),s._v(" (1)Namespace")]),s._v(" "),t("p",[s._v("æ¥ç€å‰é¢çš„ä¾‹å­, æ­£å¥½æœ‰äº†ä¸€ä¸ªæ­£åœ¨è¿è¡Œçš„å®¹å™¨, é‚£å°±æ‹¿è¿™ä¸ªè¿è¡Œçš„å®¹å™¨æ¥çœ‹çœ‹ Namespace åˆ°åº•æ˜¯ä»€ä¹ˆ? åœ¨å‰é¢è¿è¡Œ "),t("code",[s._v("docker exec c5a9ff78d9c1 ps -ef")]),s._v("â€‹, çœ‹åˆ°äº† 5 ä¸ª httpd è¿›ç¨‹, è€Œä¸”ä¹Ÿåªæœ‰è¿™ 5 ä¸ªè¿›ç¨‹.")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("$ "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("exec")]),s._v(" c5a9ff78d9c1 "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ps")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-ef")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token environment constant"}},[s._v("UID")]),s._v("        PID  "),t("span",{pre:!0,attrs:{class:"token environment constant"}},[s._v("PPID")]),s._v("  C STIME TTY          TIME CMD\nroot         "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("     "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" 01:59 ?        00:00:00 /sbin/httpd "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-D")]),s._v(" FOREGROUND\napache       "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("6")]),s._v("     "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" 01:59 ?        00:00:00 /sbin/httpd "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-D")]),s._v(" FOREGROUND\napache       "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("7")]),s._v("     "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" 01:59 ?        00:00:00 /sbin/httpd "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-D")]),s._v(" FOREGROUND\napache       "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("8")]),s._v("     "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" 01:59 ?        00:00:00 /sbin/httpd "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-D")]),s._v(" FOREGROUND\napache       "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("9")]),s._v("     "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" 01:59 ?        00:00:00 /sbin/httpd "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-D")]),s._v(" FOREGROUND\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br")])]),t("p",[s._v("å¦‚æœä¸ç”¨ "),t("code",[s._v("docker exec")]),s._v("â€‹, ç›´æ¥åœ¨å®¿ä¸»æœºä¸Šè¿è¡Œ ps -ef, å°±ä¼šçœ‹åˆ°å¾ˆå¤šè¿›ç¨‹. å¦‚æœè¿è¡Œä¸€ä¸‹ "),t("code",[s._v("grep httpd")]),s._v("â€‹ , åŒæ ·å¯ä»¥çœ‹åˆ°è¿™ 5 ä¸ª httpd çš„è¿›ç¨‹:")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("$ "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ps")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-ef")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("grep")]),s._v(" httpd\n"),t("span",{pre:!0,attrs:{class:"token environment constant"}},[s._v("UID")]),s._v("        PID  "),t("span",{pre:!0,attrs:{class:"token environment constant"}},[s._v("PPID")]),s._v("  C STIME TTY          TIME CMD\nroot     "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("20731")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("20684")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("18")]),s._v(":59 ?        00:00:01 /sbin/httpd "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-D")]),s._v(" FOREGROUND\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("48")]),s._v("       "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("20787")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("20731")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("18")]),s._v(":59 ?        00:00:00 /sbin/httpd "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-D")]),s._v(" FOREGROUND\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("48")]),s._v("       "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("20788")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("20731")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("18")]),s._v(":59 ?        00:00:06 /sbin/httpd "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-D")]),s._v(" FOREGROUND\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("48")]),s._v("       "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("20789")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("20731")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("18")]),s._v(":59 ?        00:00:05 /sbin/httpd "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-D")]),s._v(" FOREGROUND\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("48")]),s._v("       "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("20791")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("20731")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("18")]),s._v(":59 ?        00:00:05 /sbin/httpd "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-D")]),s._v(" FOREGROUN\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br")])]),t("p",[s._v("è¿™ä¸¤ç»„è¾“å‡ºç»“æœåˆ°åº•æœ‰ä»€ä¹ˆå·®åˆ«å‘¢, å¯ä»¥ä»”ç»†åšä¸ªå¯¹æ¯”, æœ€å¤§çš„ä¸åŒå°±æ˜¯"),t("mark",[t("strong",[s._v("è¿›ç¨‹çš„ PID ä¸ä¸€æ ·")])]),s._v("â€‹ **. ** é‚£ä¸ºä»€ä¹ˆ PID ä¼šä¸åŒå‘¢? æˆ–è€…è¯´è¿è¡Œ "),t("code",[s._v("docker exec c5a9ff78d9c1 ps -ef")]),s._v("â€‹ å’Œ "),t("code",[s._v("ps -ef")]),s._v("â€‹ å®è´¨çš„åŒºåˆ«åœ¨å“ªé‡Œå‘¢?")]),s._v(" "),t("p",[s._v("å¦‚æœç†è§£äº† PID ä¸ºä½•ä¸åŒ, å°±èƒ½ææ¸…æ¥š Linux Namespace çš„æ¦‚å¿µäº†, ä¸ºäº†æ–¹ä¾¿åæ–‡çš„è®²è§£, å…ˆç”¨ä¸‹é¢è¿™å¼ å›¾æ¥æ¢³ç†ä¸€ä¸‹çœ‹åˆ°çš„ PID.")]),s._v(" "),t("p",[t("img",{attrs:{src:"/img/c8048e34bd752ffa0081f61fe5ce497e-20230731161430-hj8rgqd.png",alt:""}})]),s._v(" "),t("p",[s._v("**Linux åœ¨åˆ›å»ºå®¹å™¨çš„æ—¶å€™, å°±ä¼šå»ºå‡ºä¸€ä¸ª PID Namespace, PID å…¶å®å°±æ˜¯è¿›ç¨‹çš„ç¼–å·. è¿™ä¸ª PID Namespace, å°±æ˜¯æŒ‡æ¯å»ºç«‹å‡ºä¸€ä¸ª Namespace, å°±ä¼šå•ç‹¬å¯¹è¿›ç¨‹è¿›è¡Œ PID ç¼–å·, æ¯ä¸ª Namespace çš„ PID ç¼–å·éƒ½ä» 1 å¼€å§‹. **")]),s._v(" "),t("p",[s._v("åŒæ—¶åœ¨è¿™ä¸ª PID Namespace ä¸­ä¹Ÿåªèƒ½çœ‹åˆ° Namespace ä¸­çš„è¿›ç¨‹, è€Œä¸”çœ‹ä¸åˆ°å…¶ä»– Namespace é‡Œçš„è¿›ç¨‹.  è¿™ä¹Ÿå°±æ˜¯è¯´, å¦‚æœæœ‰å¦å¤–ä¸€ä¸ªå®¹å™¨, é‚£ä¹ˆå®ƒä¹Ÿæœ‰è‡ªå·±çš„ä¸€ä¸ª PID Namespace, è€Œè¿™ä¸¤ä¸ª PID Namespace ä¹‹é—´æ˜¯ä¸èƒ½çœ‹åˆ°å¯¹æ–¹çš„è¿›ç¨‹çš„, è¿™é‡Œå°±ä½“ç°å‡ºäº† Namespace çš„ä½œç”¨: "),t("mark",[t("strong",[s._v("ç›¸äº’éš”ç¦»")])]),s._v(".")]),s._v(" "),t("p",[s._v("è€Œåœ¨å®¿ä¸»æœºä¸Šçš„ Host PID Namespace, å®ƒæ˜¯å…¶ä»– Namespace çš„çˆ¶äº² Namespace, å¯ä»¥çœ‹åˆ°åœ¨è¿™å°æœºå™¨ä¸Šçš„æ‰€æœ‰è¿›ç¨‹, ä¸è¿‡è¿›ç¨‹ PID ç¼–å·ä¸æ˜¯ Container PID Namespace é‡Œçš„ç¼–å·äº†, è€Œæ˜¯"),t("strong",[s._v("æŠŠæ‰€æœ‰åœ¨å®¿ä¸»æœºè¿è¡Œçš„è¿›ç¨‹æ”¾åœ¨ä¸€èµ·, å†è¿›è¡Œç¼–å·")]),s._v(".")]),s._v(" "),t("p",[s._v("è®²äº† PID Namespace ä¹‹å, "),t("mark",[t("strong",[s._v("Namespace å…¶å®å°±æ˜¯ä¸€ç§éš”ç¦»æœºåˆ¶, ä¸»è¦ç›®çš„æ˜¯éš”ç¦»è¿è¡Œåœ¨åŒä¸€ä¸ªå®¿ä¸»æœºä¸Šçš„å®¹å™¨, è®©è¿™äº›å®¹å™¨ä¹‹é—´ä¸èƒ½è®¿é—®å½¼æ­¤çš„èµ„æº")])]),s._v("â€‹ **. **")]),s._v(" "),t("p",[s._v("è¿™ç§éš”ç¦»æœ‰ä¸¤ä¸ªä½œç”¨: "),t("mark",[t("strong",[s._v("ç¬¬ä¸€æ˜¯å¯ä»¥å……åˆ†åœ°åˆ©ç”¨ç³»ç»Ÿçš„èµ„æº, ä¹Ÿå°±æ˜¯è¯´åœ¨åŒä¸€å°å®¿ä¸»æœºä¸Šå¯ä»¥è¿è¡Œå¤šä¸ªç”¨æˆ·çš„å®¹å™¨; ç¬¬äºŒæ˜¯ä¿è¯äº†å®‰å…¨æ€§, å› ä¸ºä¸åŒç”¨æˆ·ä¹‹é—´ä¸èƒ½è®¿é—®å¯¹æ–¹çš„èµ„æº")])]),s._v("â€‹ **. **")]),s._v(" "),t("p",[s._v("é™¤äº† "),t("strong",[s._v("PID Namespace")]),s._v(", è¿˜æœ‰å…¶ä»–å¸¸è§çš„ Namespace ç±»å‹, æ¯”å¦‚ä¹‹å‰è¿è¡Œäº† "),t("code",[s._v("docker exec c5a9ff78d9c1 ip addr")]),s._v("â€‹ è¿™ä¸ªå‘½ä»¤å»æŸ¥çœ‹å®¹å™¨å†…éƒ¨çš„ IP åœ°å€, è¿™é‡Œå…¶å®å°±æ˜¯åœ¨æŸ¥çœ‹ Network Namespace.")]),s._v(" "),t("p",[s._v("åœ¨ Network Namespace ä¸­éƒ½æœ‰ä¸€å¥—**ç‹¬ç«‹çš„ç½‘ç»œæ¥å£, ** æ¯”å¦‚è¿™é‡Œçš„ lo, eth0, è¿˜æœ‰ç‹¬ç«‹çš„ TCP/IP çš„åè®®æ ˆé…ç½®.")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("$ "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("exec")]),s._v(" c5a9ff78d9c1 "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ip")]),s._v(" addr\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(": lo: "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("LOOPBACK,UP,LOWER_UP"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" mtu "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("65536")]),s._v(" qdisc noqueue state UNKNOWN group default qlen "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1000")]),s._v("\n    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00\n    inet "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1/8 scope "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("host")]),s._v(" lo\n       valid_lft forever preferred_lft forever\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("168")]),s._v(": eth0@if169: "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("BROADCAST,MULTICAST,UP,LOWER_UP"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" mtu "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1500")]),s._v(" qdisc noqueue state UP group default\n    link/ether 02:42:ac:11:00:02 brd ff:ff:ff:ff:ff:ff link-netnsid "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\n    inet "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.17")]),s._v(".0.2/16 brd "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.17")]),s._v(".255.255 scope global eth0\n       valid_lft forever preferred_lft forever\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br")])]),t("p",[s._v("è¿˜å¯ä»¥è¿è¡Œ "),t("code",[s._v("docker exec c5a9ff78d9c1 ls/")]),s._v("â€‹ æŸ¥çœ‹å®¹å™¨ä¸­çš„æ ¹æ–‡ä»¶ç³»ç»Ÿ(rootfs). å¯ä»¥å‘ç°, å®ƒå’Œå®¿ä¸»æœºä¸Šçš„æ ¹æ–‡ä»¶ç³»ç»Ÿä¹Ÿæ˜¯ä¸ä¸€æ ·çš„. "),t("mark",[t("strong",[s._v("å®¹å™¨ä¸­çš„æ ¹æ–‡ä»¶ç³»ç»Ÿ, å…¶å®å°±æ˜¯æˆ‘ä»¬åšçš„é•œåƒ")])]),s._v("â€‹ **. **")]),s._v(" "),t("p",[s._v("é‚£å®¹å™¨è‡ªå·±çš„æ ¹æ–‡ä»¶ç³»ç»Ÿå®Œå…¨ç‹¬ç«‹äºå®¿ä¸»æœºä¸Šçš„æ ¹æ–‡ä»¶ç³»ç»Ÿ, è¿™ä¸€ç‚¹æ˜¯æ€ä¹ˆåšåˆ°çš„å‘¢? å…¶å®è¿™é‡Œä¾é çš„æ˜¯ "),t("mark",[t("strong",[s._v("Mount Namespace")])]),s._v("â€‹ "),t("strong",[s._v(", Mount Namespace ä¿è¯äº†æ¯ä¸ªå®¹å™¨éƒ½æœ‰è‡ªå·±ç‹¬ç«‹çš„æ–‡ä»¶ç›®å½•ç»“æ„")]),s._v(".")]),s._v(" "),t("p",[s._v('Namespace çš„ç±»å‹è¿˜æœ‰å¾ˆå¤š, æŸ¥çœ‹ "Linux Programmerâ€™s Manual", å¯ä»¥çœ‹åˆ° Linux ä¸­æ‰€æœ‰çš„ Namespace: '),t("mark",[t("strong",[s._v("cgroup/ipc/network/mount/pid/time/user/uts")])]),s._v(".")]),s._v(" "),t("p",[s._v("åœ¨è¿™é‡Œéœ€è¦è®°ä½çš„æ˜¯ **Namespace æ˜¯ Linux ä¸­å®ç°å®¹å™¨çš„ä¸¤å¤§æŠ€æœ¯ä¹‹ä¸€, å®ƒæœ€é‡è¦çš„ä½œç”¨æ˜¯ä¿è¯èµ„æºçš„éš”ç¦». ** åœ¨åé¢è®²è§£åˆ°å…·ä½“é—®é¢˜æ—¶, ä¼šä¸æ–­åœ°æåˆ° Namespace è¿™ä¸ªæ¦‚å¿µ.")]),s._v(" "),t("p",[t("img",{attrs:{src:"/img/c7e3984329d63d66ae37eca39ffabb0c-20230731161430-eu2rkpj.png",alt:""}})]),s._v(" "),t("p",[s._v("åˆšæ‰è¯´äº† Namespace, è¿™äº› Namespace å°½ç®¡ç±»å‹ä¸åŒ, å…¶å®éƒ½æ˜¯ä¸ºäº†éš”ç¦»å®¹å™¨èµ„æº: "),t("mark",[t("strong",[s._v("PID Namespace è´Ÿè´£éš”ç¦»ä¸åŒå®¹å™¨çš„è¿›ç¨‹, Network Namespace åˆè´Ÿè´£ç®¡ç†ç½‘ç»œç¯å¢ƒçš„éš”ç¦», Mount Namespace ç®¡ç†æ–‡ä»¶ç³»ç»Ÿçš„éš”ç¦»")])]),s._v("â€‹ **. **")]),s._v(" "),t("p",[s._v('æ­£æ˜¯é€šè¿‡è¿™äº› Namespace, æ‰éš”ç¦»å‡ºä¸€ä¸ªå®¹å™¨, è¿™é‡Œä¹Ÿå¯ä»¥æŠŠå®ƒçœ‹ä½œæ˜¯ä¸€å° "è®¡ç®—æœº". æ—¢ç„¶æ˜¯ä¸€å° "è®¡ç®—æœº", ä½ è‚¯å®šä¼šé—®è¿™ä¸ª "è®¡ç®—æœº" æœ‰å¤šå°‘ CPU, æœ‰å¤šå°‘ Memory å•Š? é‚£ä¹ˆ Linux å¦‚ä½•ä¸ºè¿™äº› "è®¡ç®—æœº" æ¥å®šä¹‰ CPU, å®šä¹‰ Memory çš„å®¹é‡å‘¢?')]),s._v(" "),t("h6",{attrs:{id:"_2-cgroups"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-cgroups"}},[s._v("#")]),s._v(" (2)Cgroups")]),s._v(" "),t("p",[s._v('æƒ³è¦å®šä¹‰ "è®¡ç®—æœº" å„ç§å®¹é‡å¤§å°, å°±æ¶‰åŠåˆ°æ”¯æ’‘å®¹å™¨çš„ç¬¬äºŒä¸ªæŠ€æœ¯ '),t("strong",[s._v("Cgroups (Control Groups)")]),s._v(" äº†. "),t("mark",[t("strong",[s._v("Cgroups å¯ä»¥å¯¹æŒ‡å®šçš„è¿›ç¨‹åšå„ç§è®¡ç®—æœºèµ„æºçš„é™åˆ¶, æ¯”å¦‚é™åˆ¶ CPU çš„ä½¿ç”¨ç‡, å†…å­˜ä½¿ç”¨é‡, IO è®¾å¤‡çš„æµé‡ç­‰ç­‰")])]),s._v(".")]),s._v(" "),t("p",[s._v("Cgroups ç©¶ç«Ÿæœ‰ä»€ä¹ˆå¥½å¤„å‘¢? è¦çŸ¥é“, åœ¨ Cgroups å‡ºç°ä¹‹å‰, ä»»æ„ä¸€ä¸ªè¿›ç¨‹éƒ½å¯ä»¥åˆ›å»ºå‡ºæˆç™¾ä¸Šåƒä¸ªçº¿ç¨‹, å¯ä»¥è½»æ˜“åœ°æ¶ˆè€—å®Œä¸€å°è®¡ç®—æœºçš„æ‰€æœ‰ CPU èµ„æºå’Œå†…å­˜èµ„æº. ä½†æœ‰äº† Cgroups è¿™ä¸ªæŠ€æœ¯ä»¥å, å°±å¯ä»¥"),t("strong",[s._v("å¯¹ä¸€ä¸ªè¿›ç¨‹æˆ–è€…ä¸€ç»„è¿›ç¨‹çš„è®¡ç®—æœºèµ„æºçš„æ¶ˆè€—è¿›è¡Œé™åˆ¶")]),s._v("äº†.")]),s._v(" "),t("p",[s._v("**Cgroups é€šè¿‡ä¸åŒçš„å­ç³»ç»Ÿé™åˆ¶äº†ä¸åŒçš„èµ„æº, æ¯ä¸ªå­ç³»ç»Ÿé™åˆ¶ä¸€ç§èµ„æº. æ¯ä¸ªå­ç³»ç»Ÿé™åˆ¶èµ„æºçš„æ–¹å¼éƒ½æ˜¯ç±»ä¼¼çš„, å°±æ˜¯æŠŠç›¸å…³çš„ä¸€ç»„è¿›ç¨‹åˆ†é…åˆ°ä¸€ä¸ªæ§åˆ¶ç»„é‡Œ, ç„¶åé€šè¿‡æ ‘ç»“æ„è¿›è¡Œç®¡ç†, æ¯ä¸ªæ§åˆ¶ç»„éƒ½è®¾æœ‰è‡ªå·±çš„èµ„æºæ§åˆ¶å‚æ•°. **")]),s._v(" "),t("p",[s._v("å®Œæ•´çš„ Cgroups å­ç³»ç»Ÿçš„ä»‹ç», å¯ä»¥æŸ¥çœ‹ Linux Programmerâ€™s Manual ä¸­ Cgroups çš„å®šä¹‰.")]),s._v(" "),t("p",[s._v("è¿™é‡Œåªéœ€è¦äº†è§£å‡ ç§æ¯”è¾ƒå¸¸ç”¨çš„ Cgroups å­ç³»ç»Ÿ:")]),s._v(" "),t("ol",[t("li",[t("strong",[s._v("CPU å­ç³»ç»Ÿ")]),s._v(", ç”¨æ¥é™åˆ¶ä¸€ä¸ªæ§åˆ¶ç»„(ä¸€ç»„è¿›ç¨‹, å¯ä»¥ç†è§£ä¸ºä¸€ä¸ªå®¹å™¨é‡Œæ‰€æœ‰çš„è¿›ç¨‹)å¯ä½¿ç”¨çš„æœ€å¤§ CPU.")]),s._v(" "),t("li",[t("strong",[s._v("memory å­ç³»ç»Ÿ")]),s._v(", ç”¨æ¥é™åˆ¶ä¸€ä¸ªæ§åˆ¶ç»„æœ€å¤§çš„å†…å­˜ä½¿ç”¨é‡.")]),s._v(" "),t("li",[t("strong",[s._v("pids å­ç³»ç»Ÿ")]),s._v(", ç”¨æ¥é™åˆ¶ä¸€ä¸ªæ§åˆ¶ç»„é‡Œæœ€å¤šå¯ä»¥è¿è¡Œå¤šå°‘ä¸ªè¿›ç¨‹.")]),s._v(" "),t("li",[t("strong",[s._v("cpuset å­ç³»ç»Ÿ")]),s._v(", è¿™ä¸ªå­ç³»ç»Ÿæ¥é™åˆ¶ä¸€ä¸ªæ§åˆ¶ç»„é‡Œçš„è¿›ç¨‹å¯ä»¥åœ¨å“ªå‡ ä¸ªç‰©ç† CPU ä¸Šè¿è¡Œ.")])]),s._v(" "),t("p",[s._v("å› ä¸º memory å­ç³»ç»Ÿçš„é™åˆ¶å‚æ•°æœ€ç®€å•, æ‰€ä»¥ä¸‹é¢å°±ç”¨ memory å­ç³»ç»Ÿä¸ºä¾‹, ä¸€èµ·çœ‹çœ‹ Cgroups æ˜¯æ€ä¹ˆå¯¹ä¸€ä¸ªå®¹å™¨åšèµ„æºé™åˆ¶çš„.")]),s._v(" "),t("p",[s._v("å¯¹äº"),t("strong",[s._v("å¯åŠ¨çš„æ¯ä¸ªå®¹å™¨, éƒ½ä¼šåœ¨ Cgroups å­ç³»ç»Ÿä¸‹å»ºç«‹ä¸€ä¸ªç›®å½•, åœ¨ Cgroups ä¸­è¿™ä¸ªç›®å½•ä¹Ÿè¢«ç§°ä½œæ§åˆ¶ç»„")]),s._v(", æ¯”å¦‚ä¸‹å›¾é‡Œçš„ "),t("code",[s._v('"docker-<id1>", "docker-<id2>"')]),s._v("â€‹ ç­‰. ç„¶å"),t("strong",[s._v("è®¾ç½®è¿™ä¸ªæ§åˆ¶ç»„çš„å‚æ•°, é€šè¿‡è¿™ä¸ªæ–¹å¼, æ¥é™åˆ¶è¿™ä¸ªå®¹å™¨çš„å†…å­˜èµ„æº")]),s._v(".")]),s._v(" "),t("p",[t("img",{attrs:{src:"/img/82c532059b2b74dcedbe4cd758ce2471-20230731161430-ljzlwsj.png",alt:""}})]),s._v(" "),t("p",[s._v("è¿˜è®°å¾—ä¹‹å‰ç”¨ Docker åˆ›å»ºçš„é‚£ä¸ªå®¹å™¨å—? åœ¨æ¯ä¸ª Cgroups å­ç³»ç»Ÿä¸‹, "),t("strong",[s._v("å¯¹åº”è¿™ä¸ªå®¹å™¨å°±ä¼šæœ‰ä¸€ä¸ªç›®å½•")]),s._v(" docker-**c5a9ff78d9c1... ** è¿™ä¸ªå®¹å™¨çš„ ID å·, "),t("strong",[s._v("å®¹å™¨ä¸­æ‰€æœ‰çš„è¿›ç¨‹éƒ½ä¼šå‚¨å­˜åœ¨è¿™ä¸ªæ§åˆ¶ç»„ä¸­ cgroup.procs è¿™ä¸ªå‚æ•°é‡Œ")]),s._v(".")]),s._v(" "),t("p",[s._v("ä½ çœ‹ä¸‹é¢çš„è¿™äº›è¿›ç¨‹å·æ˜¯ä¸æ˜¯å¾ˆç†Ÿæ‚‰å‘¢? æ²¡é”™, å®ƒä»¬å°±æ˜¯å‰é¢ç”¨ ps çœ‹åˆ°çš„è¿›ç¨‹å·.")]),s._v(" "),t("p",[s._v("å®é™…çœ‹ä¸€ä¸‹è¿™ä¸ªä¾‹å­é‡Œçš„ memory Cgroups, å®ƒå¯ä»¥æ§åˆ¶ Memory çš„ä½¿ç”¨é‡. æ¯”å¦‚å°†è¿™ä¸ªæ§åˆ¶ç»„ Memory çš„æœ€å¤§ç”¨é‡è®¾ç½®ä¸º 2GB.")]),s._v(" "),t("p",[s._v("å…·ä½“æ“ä½œæ˜¯æŠŠ (2* 1024 * 1024 * 1024 = 2147483648) è¿™ä¸ªå€¼, å†™å…¥ memory Cgroup æ§åˆ¶ç»„ä¸­çš„ memory.limit_in_bytes é‡Œ, **è¿™æ ·è®¾ç½®å, cgroup.procs é‡Œé¢æ‰€æœ‰è¿›ç¨‹ Memory ä½¿ç”¨é‡ä¹‹å’Œ, æœ€å¤§ä¹Ÿä¸ä¼šè¶…è¿‡ 2GB. **")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("$ "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("cd")]),s._v(" /sys/fs/cgroup/memory/system.slice/docker-c5a9ff78d9c1fedd52511e18fdbd26357250719fa0d128349547a50fad7c5de9.scope\n$ "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" cgroup.procs\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("20731")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("20787")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("20788")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("20789")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("20791")]),s._v("\n$ "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2147483648")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" memory.limit_in_bytes\n$ "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" memory.limit_in_bytes\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2147483648")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br")])]),t("p",[s._v("åˆšåˆšé€šè¿‡ memory Cgroups å®šä¹‰äº†å®¹å™¨çš„ memory å¯ä»¥ä½¿ç”¨çš„æœ€å¤§å€¼. å…¶ä»–çš„å­ç³»ç»Ÿç¨å¾®å¤æ‚ä¸€äº›, ä½†ç”¨æ³•ä¹Ÿå’Œ memory ç±»ä¼¼, åœ¨åé¢ä¼šç»“åˆå…·ä½“çš„å®ä¾‹æ¥è¯¦ç»†è§£é‡Šå…¶ä»–çš„ Cgroups.")]),s._v(" "),t("p",[s._v("è¿™é‡Œè¿˜è¦æä¸€ä¸‹ "),t("strong",[s._v("Cgroups æœ‰ v1 å’Œ v2 ä¸¤ä¸ªç‰ˆæœ¬")]),s._v(":")]),s._v(" "),t("p",[s._v("Cgroups v1 åœ¨ Linux ä¸­å¾ˆæ—©å°±å®ç°äº†, å„ç§å­ç³»ç»Ÿæ¯”è¾ƒç‹¬ç«‹, æ¯ä¸ªè¿›ç¨‹åœ¨å„ä¸ª Cgroups å­ç³»ç»Ÿä¸­ç‹¬ç«‹é…ç½®, å¯ä»¥å±äºä¸åŒçš„ group. è™½ç„¶è¿™æ ·æ¯”è¾ƒçµæ´», ä½†æ˜¯ä¹Ÿå­˜åœ¨é—®é¢˜, ä¼šå¯¼è‡´å¯¹"),t("strong",[s._v("åŒä¸€è¿›ç¨‹çš„èµ„æºåè°ƒæ¯”è¾ƒå›°éš¾")]),s._v("(æ¯”å¦‚ memory Cgroup ä¸ blkio Cgroup ä¹‹é—´å°±ä¸èƒ½åä½œ). è™½ç„¶ v1 æœ‰ç¼ºé™·, ä½†æ˜¯åœ¨ä¸»æµçš„ç”Ÿäº§ç¯å¢ƒä¸­, å¤§éƒ¨åˆ†ä½¿ç”¨çš„è¿˜æ˜¯ v1.")]),s._v(" "),t("p",[s._v("Cgroups v2 åšäº†è®¾è®¡æ”¹è¿›, **è§£å†³äº† v1 çš„é—®é¢˜, ä½¿å„ä¸ªå­ç³»ç»Ÿå¯ä»¥åè°ƒç»Ÿä¸€åœ°ç®¡ç†èµ„æº. ** ä¸è¿‡ Cgroups v2 åœ¨ç”Ÿäº§ç¯å¢ƒçš„åº”ç”¨è¿˜å¾ˆå°‘, å› ä¸ºè¯¥ç‰ˆæœ¬å¾ˆå¤šå­ç³»ç»Ÿçš„å®ç°éœ€è¦è¾ƒæ–°ç‰ˆæœ¬çš„ Linux å†…æ ¸, è¿˜æœ‰æ— è®ºæ˜¯ä¸»æµçš„ Linux å‘è¡Œç‰ˆæœ¬è¿˜æ˜¯å®¹å™¨äº‘å¹³å°, æ¯”å¦‚ Kubernetes å¯¹ v2 çš„æ”¯æŒä¹Ÿåˆšåˆšèµ·æ­¥.")]),s._v(" "),t("p",[s._v("æ‰€ä»¥åé¢ Cgroups çš„è®²è§£é‡Œ, ä¸»è¦è¿˜æ˜¯ç”¨ "),t("strong",[s._v("Cgroups v1 è¿™ä¸ªç‰ˆæœ¬")]),s._v(", åœ¨ç£ç›˜ I/O çš„è¿™ä¸€ç« , ä¹Ÿä¼šä»‹ç»ä¸€ä¸‹ Cgroups v2.")]),s._v(" "),t("h5",{attrs:{id:"_4-é‡ç‚¹æ€»ç»“"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_4-é‡ç‚¹æ€»ç»“"}},[s._v("#")]),s._v(" 4.é‡ç‚¹æ€»ç»“")]),s._v(" "),t("p",[s._v('æœ¬èŠ‚å¯¹å®¹å™¨æœ‰äº†ä¸€ä¸ªå¤§è‡´çš„è®¤è¯†, åŒ…æ‹¬å®ƒçš„ "å½¢", '),t("strong",[s._v("ä¸€äº›åŸºæœ¬çš„å®¹å™¨æ“ä½œ")]),s._v('; è¿˜æœ‰å®ƒçš„ "ç¥", ä¹Ÿå°±æ˜¯'),t("strong",[s._v("å®¹å™¨å®ç°çš„åŸç†")]),s._v(".")]),s._v(" "),t("p",[s._v("å¯åŠ¨å®¹å™¨çš„åŸºæœ¬æ“ä½œæ˜¯è¿™æ ·çš„, é¦–å…ˆç”¨ Dockerfile æ¥å»ºç«‹ä¸€ä¸ªå®¹å™¨çš„é•œåƒ, ç„¶åå†ç”¨è¿™ä¸ªé•œåƒæ¥å¯åŠ¨ä¸€ä¸ªå®¹å™¨.")]),s._v(" "),t("p",[s._v("é‚£å¯åŠ¨äº†å®¹å™¨ä¹‹å, æ€ä¹ˆæ£€éªŒå®ƒæ˜¯ä¸æ˜¯æ­£å¸¸å·¥ä½œäº†å‘¢?")]),s._v(" "),t("p",[s._v("å¯ä»¥è¿è¡Œ "),t("code",[s._v("docker exec")]),s._v("â€‹ è¿™ä¸ªå‘½ä»¤è¿›å…¥å®¹å™¨çš„è¿è¡Œç©ºé—´, æŸ¥çœ‹è¿›ç¨‹æ˜¯å¦å¯åŠ¨, æ£€æŸ¥é…ç½®æ–‡ä»¶æ˜¯å¦æ­£ç¡®, æ£€éªŒè®¾ç½®çš„æœåŠ¡æ˜¯å¦èƒ½å¤Ÿæ­£å¸¸æä¾›.")]),s._v(" "),t("p",[s._v("ç”¨ "),t("code",[s._v("docker exec")]),s._v("â€‹ å‘½ä»¤æŸ¥çœ‹äº†å®¹å™¨çš„è¿›ç¨‹, ç½‘ç»œå’Œæ–‡ä»¶ç³»ç»Ÿ, å°±èƒ½ä½“ä¼šåˆ°å®¹å™¨çš„æ–‡ä»¶ç³»ç»Ÿ, è¿è¡Œçš„è¿›ç¨‹ç¯å¢ƒå’Œç½‘ç»œçš„è®¾ç½®éƒ½æ˜¯ç‹¬ç«‹çš„, æ‰€ä»¥ä»ç”¨æˆ·ä½¿ç”¨çš„è§’åº¦çœ‹, å®¹å™¨å’Œä¸€å°ç‹¬ç«‹çš„æœºå™¨æˆ–è€…è™šæ‹Ÿæœºæ²¡æœ‰ä»€ä¹ˆå¤ªå¤§çš„åŒºåˆ«.")]),s._v(" "),t("p",[s._v("æœ€åä¸€èµ·å­¦ä¹ äº† Namespace å’Œ Cgroups, å®ƒä»¬æ˜¯ Linux çš„ä¸¤å¤§æŠ€æœ¯, ç”¨äºå®ç°å®¹å™¨çš„ç‰¹æ€§. ç›®å‰åªéœ€è¦å…ˆè®°ä½è¿™ä¸¤ä¸ªæŠ€æœ¯çš„ä½œç”¨, "),t("mark",[t("strong",[s._v("Namespace å¸®åŠ©å®¹å™¨æ¥å®ç°å„ç§è®¡ç®—èµ„æºçš„éš”ç¦», Cgroups ä¸»è¦é™åˆ¶çš„æ˜¯å®¹å™¨èƒ½å¤Ÿä½¿ç”¨çš„æŸç§èµ„æºé‡")])]),s._v("â€‹ **. **")]),s._v(" "),t("p",[s._v("æ‰€ä»¥åœ¨è¿™é‡Œå¯ä»¥ç›´æ¥è®°ä½: "),t("mark",[t("strong",[s._v("å®¹å™¨å…¶å®å°±æ˜¯ Namesapce + Cgroups")])]),s._v("â€‹ **. **")]),s._v(" "),t("h3",{attrs:{id:"å®¹å™¨è¿›ç¨‹"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#å®¹å™¨è¿›ç¨‹"}},[s._v("#")]),s._v(" å®¹å™¨è¿›ç¨‹")]),s._v(" "),t("h4",{attrs:{id:"_02-ç†è§£è¿›ç¨‹-1-ä¸ºä»€ä¹ˆæˆ‘åœ¨å®¹å™¨ä¸­ä¸èƒ½kill-1å·è¿›ç¨‹"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_02-ç†è§£è¿›ç¨‹-1-ä¸ºä»€ä¹ˆæˆ‘åœ¨å®¹å™¨ä¸­ä¸èƒ½kill-1å·è¿›ç¨‹"}},[s._v("#")]),s._v(" 02 | ç†è§£è¿›ç¨‹(1):ä¸ºä»€ä¹ˆæˆ‘åœ¨å®¹å™¨ä¸­ä¸èƒ½kill 1å·è¿›ç¨‹?")]),s._v(" "),t("p",[s._v("æœ¬èŠ‚æ­£å¼è¿›å…¥ç†è§£è¿›ç¨‹çš„æ¨¡å—. åé¢ä¸‰èŠ‚å°†ä»‹ç»å®¹å™¨ "),t("strong",[s._v("init è¿›ç¨‹")]),s._v("çš„ç‰¹æ®Šä¹‹å¤„, è¿˜æœ‰å®ƒéœ€è¦å…·å¤‡å“ªäº›åŠŸèƒ½, æ‰èƒ½ä¿è¯å®¹å™¨åœ¨è¿è¡Œè¿‡ç¨‹ä¸­ä¸ä¼šå‡ºç°ç±»ä¼¼åƒµå°¸è¿›ç¨‹, æˆ–è€…åº”ç”¨ç¨‹åºæ— æ³• graceful shutdown çš„é—®é¢˜.")]),s._v(" "),t("p",[s._v("æœ¬èŠ‚ä¼šä»‹ç» init è¿›ç¨‹å’Œ Linux ä¿¡å·çš„æ ¸å¿ƒæ¦‚å¿µ.")]),s._v(" "),t("h5",{attrs:{id:"_1-é—®é¢˜å†ç°"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-é—®é¢˜å†ç°"}},[s._v("#")]),s._v(" 1.é—®é¢˜å†ç°")]),s._v(" "),t("p",[s._v("æ¥ä¸‹æ¥ä¸€èµ·å†ç°ç”¨ "),t("code",[s._v("kill 1")]),s._v("â€‹ å‘½ä»¤é‡å¯å®¹å™¨çš„é—®é¢˜.")]),s._v(" "),t("p",[s._v("æˆ‘çŒœä½ è‚¯å®šæƒ³é—®, ä¸ºä»€ä¹ˆè¦åœ¨å®¹å™¨ä¸­æ‰§è¡Œ "),t("code",[s._v("kill 1")]),s._v("â€‹ æˆ–è€… "),t("code",[s._v("kill -9 1")]),s._v("â€‹ çš„å‘½ä»¤å‘¢? å…¶å®è¿™æ˜¯æˆ‘ä»¬å›¢é˜Ÿé‡Œçš„ä¸€ä½åŒå­¦æå‡ºçš„é—®é¢˜. è¿™ä½åŒå­¦å½“æ—¶é‡åˆ°çš„æƒ…å†µæ˜¯è¿™æ ·çš„, ä»–æƒ³ä¿®æ”¹å®¹å™¨é•œåƒé‡Œçš„ä¸€ä¸ª bug, ä½†å› ä¸ºç½‘è·¯é…ç½®çš„é—®é¢˜, è¿™ä¸ªåŒå­¦åˆä¸æƒ³ä¸ºäº†é‡å»º pod å»æ”¹å˜ pod IP.")]),s._v(" "),t("p",[s._v("å¦‚æœä½ ç”¨è¿‡ Kubernetes çš„è¯, ä½ ä¹Ÿè‚¯å®šçŸ¥é“, Kubernetes ä¸Šæ˜¯æ²¡æœ‰ "),t("code",[s._v("restart pod")]),s._v("â€‹ è¿™ä¸ªå‘½ä»¤çš„. è¿™æ ·çœ‹æ¥ä¼¼ä¹åªèƒ½"),t("strong",[s._v("è®© pod åšä¸ªåŸåœ°é‡å¯")]),s._v("äº†. **å½“æ—¶æˆ‘é¦–å…ˆæƒ³åˆ°çš„, å°±æ˜¯åœ¨å®¹å™¨ä¸­ä½¿ç”¨ kill pid 1 çš„æ–¹å¼é‡å¯å®¹å™¨. **")]),s._v(" "),t("p",[s._v("ä¸ºäº†æ¨¡æ‹Ÿè¿™ä¸ªè¿‡ç¨‹, å¯ä»¥è¿›è¡Œä¸‹é¢çš„è¿™æ®µæ“ä½œ.")]),s._v(" "),t("p",[s._v("å¦‚æœä½ æ²¡æœ‰åœ¨å®¹å™¨ä¸­åšè¿‡ "),t("code",[s._v("kill 1")]),s._v("â€‹, å¯ä»¥ä¸‹è½½æˆ‘åœ¨ GitHub ä¸Šçš„è¿™ä¸ªä¾‹å­, è¿è¡Œ "),t("code",[s._v("make image")]),s._v("â€‹ æ¥åšä¸€ä¸ªå®¹å™¨é•œåƒ. ç„¶åç”¨ Docker æ„å»ºä¸€ä¸ªå®¹å™¨, ç”¨ä¾‹å­ä¸­çš„ "),t("strong",[s._v("init.sh è„šæœ¬")]),s._v("ä½œä¸ºè¿™ä¸ªå®¹å™¨çš„ init è¿›ç¨‹.")]),s._v(" "),t("p",[s._v("æœ€å, åœ¨å®¹å™¨ä¸­è¿è¡Œ "),t("code",[s._v("kill 1")]),s._v("â€‹ å’Œ "),t("code",[s._v("kill -9 1")]),s._v("â€‹, çœ‹çœ‹ä¼šå‘ç”Ÿä»€ä¹ˆ.")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("$ "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" stop sig-proc"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("rm")]),s._v(" sig-proc\n$ "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" run "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--name")]),s._v(" sig-proc "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-d")]),s._v(" registry/sig-proc:v1 /init.sh\n$ "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("exec")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-it")]),s._v(" sig-proc "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("bash")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@5cc69036b7b2 /"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("$ "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ps")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-ef")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token environment constant"}},[s._v("UID")]),s._v("        PID  "),t("span",{pre:!0,attrs:{class:"token environment constant"}},[s._v("PPID")]),s._v("  C STIME TTY          TIME CMD\nroot         "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("     "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" 07:23 ?        00:00:00 /bin/bash /init.sh\nroot         "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("8")]),s._v("     "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" 07:25 ?        00:00:00 /usr/bin/coreutils --coreutils-prog-shebang"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("sleep /usr/bin/sleep "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("100")]),s._v("\nroot         "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("9")]),s._v("     "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("6")]),s._v(" 07:27 pts/0    00:00:00 "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("bash")]),s._v("\nroot        "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("22")]),s._v("     "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("9")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" 07:27 pts/0    00:00:00 "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ps")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-ef")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@5cc69036b7b2 /"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("$ "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("kill")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@5cc69036b7b2 /"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("$ "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("kill")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-9")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@5cc69036b7b2 /"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("$ "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ps")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-ef")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token environment constant"}},[s._v("UID")]),s._v("        PID  "),t("span",{pre:!0,attrs:{class:"token environment constant"}},[s._v("PPID")]),s._v("  C STIME TTY          TIME CMD\nroot         "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("     "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" 07:23 ?        00:00:00 /bin/bash /init.sh\nroot         "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("9")]),s._v("     "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" 07:27 pts/0    00:00:00 "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("bash")]),s._v("\nroot        "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("23")]),s._v("     "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" 07:27 ?        00:00:00 /usr/bin/coreutils --coreutils-prog-shebang"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("sleep /usr/bin/sleep "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("100")]),s._v("\nroot        "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("24")]),s._v("     "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("9")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" 07:27 pts/0    00:00:00 "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ps")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-ef")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br")])]),t("p",[s._v("å½“å®Œæˆå‰é¢çš„æ“ä½œ, å°±ä¼šå‘ç°æ— è®ºè¿è¡Œ "),t("code",[s._v("kill 1")]),s._v("â€‹ (å¯¹åº” Linux ä¸­çš„ SIGTERM ä¿¡å·)è¿˜æ˜¯ "),t("code",[s._v("kill -9 1")]),s._v("â€‹(å¯¹åº” Linux ä¸­çš„ SIGKILL ä¿¡å·), éƒ½"),t("strong",[s._v("æ— æ³•è®©è¿›ç¨‹ç»ˆæ­¢")]),s._v(". é—®é¢˜æ¥äº†, è¿™ä¸¤ä¸ªå¸¸å¸¸ç”¨æ¥ç»ˆæ­¢è¿›ç¨‹çš„ä¿¡å·, éƒ½å¯¹å®¹å™¨ä¸­çš„ init è¿›ç¨‹ä¸èµ·ä½œç”¨, è¿™æ˜¯æ€ä¹ˆå›äº‹?")]),s._v(" "),t("p",[s._v("è¦è§£é‡Šè¿™ä¸ªé—®é¢˜, å°±è¦å›åˆ°å®¹å™¨çš„ä¸¤ä¸ªæœ€åŸºæœ¬æ¦‚å¿µ -- "),t("strong",[s._v("init è¿›ç¨‹å’Œ Linux ä¿¡å·")]),s._v("ä¸­å¯»æ‰¾ç­”æ¡ˆ.")]),s._v(" "),t("h5",{attrs:{id:"_2-çŸ¥è¯†è¯¦è§£"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-çŸ¥è¯†è¯¦è§£"}},[s._v("#")]),s._v(" 2.çŸ¥è¯†è¯¦è§£")]),s._v(" "),t("h6",{attrs:{id:"_1-å¦‚ä½•ç†è§£initè¿›ç¨‹"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-å¦‚ä½•ç†è§£initè¿›ç¨‹"}},[s._v("#")]),s._v(" (1)å¦‚ä½•ç†è§£initè¿›ç¨‹?")]),s._v(" "),t("p",[s._v("ä½¿ç”¨å®¹å™¨çš„"),t("strong",[s._v("ç†æƒ³å¢ƒç•Œ")]),s._v("æ˜¯"),t("strong",[s._v("ä¸€ä¸ªå®¹å™¨åªå¯åŠ¨ä¸€ä¸ªè¿›ç¨‹")]),s._v(", ä½†è¿™åœ¨ç°å®åº”ç”¨ä¸­æœ‰æ—¶æ˜¯åšä¸åˆ°çš„. æ¯”å¦‚åœ¨ä¸€ä¸ªå®¹å™¨ä¸­é™¤äº†"),t("strong",[s._v("ä¸»è¿›ç¨‹")]),s._v("ä¹‹å¤–, å¯èƒ½è¿˜ä¼šå¯åŠ¨è¾…åŠ©è¿›ç¨‹, åšç›‘æ§æˆ–è€… rotate logs; å†æ¯”å¦‚éœ€è¦æŠŠåŸæ¥è¿è¡Œåœ¨è™šæ‹Ÿæœº(VM)çš„ç¨‹åºç§»åˆ°å®¹å™¨é‡Œ, è¿™äº›åŸæ¥è·‘åœ¨è™šæ‹Ÿæœºä¸Šçš„ç¨‹åºæœ¬èº«å°±æ˜¯å¤šè¿›ç¨‹çš„.")]),s._v(" "),t("p",[s._v("ä¸€æ—¦å¯åŠ¨äº†å¤šä¸ªè¿›ç¨‹, é‚£ä¹ˆå®¹å™¨é‡Œå°±ä¼šå‡ºç°ä¸€ä¸ª "),t("strong",[s._v("pid 1")]),s._v(", ä¹Ÿå°±æ˜¯å¸¸è¯´çš„ "),t("mark",[t("strong",[s._v("1 å·è¿›ç¨‹æˆ–è€… init è¿›ç¨‹")])]),s._v("â€‹"),t("mark",[s._v(", ç„¶å")]),s._v("â€‹"),t("mark",[t("strong",[s._v("ç”±è¿™ä¸ªè¿›ç¨‹åˆ›å»ºå‡ºå…¶ä»–çš„å­è¿›ç¨‹")])]),s._v("â€‹ **. **")]),s._v(" "),t("p",[s._v("æ¥ä¸‹æ¥æ¢³ç†ä¸€ä¸‹ init è¿›ç¨‹æ˜¯æ€ä¹ˆæ¥çš„.")]),s._v(" "),t("p",[s._v("ä¸€ä¸ª Linux æ“ä½œç³»ç»Ÿ, åœ¨ç³»ç»Ÿæ‰“å¼€ç”µæº, æ‰§è¡Œ BIOS/boot-loader ä¹‹å, å°±ä¼šç”± boot-loader è´Ÿè´£åŠ è½½ Linux å†…æ ¸. Linux å†…æ ¸æ‰§è¡Œæ–‡ä»¶ä¸€èˆ¬ä¼šæ”¾åœ¨ /boot ç›®å½•ä¸‹, æ–‡ä»¶åç±»ä¼¼ "),t("code",[s._v("vmlinuz*")]),s._v("â€‹. åœ¨å†…æ ¸å®Œæˆäº†æ“ä½œç³»ç»Ÿçš„å„ç§åˆå§‹åŒ–ä¹‹å, "),t("mark",[t("strong",[s._v("è¿™ä¸ªç¨‹åºéœ€è¦æ‰§è¡Œçš„ç¬¬ä¸€ä¸ªç”¨æˆ·æ€ç¨‹å°±æ˜¯ init è¿›ç¨‹")])]),s._v("â€‹ **. **")]),s._v(" "),t("p",[s._v("å†…æ ¸ä»£ç å¯åŠ¨ 1 å·è¿›ç¨‹çš„æ—¶å€™, åœ¨æ²¡æœ‰å¤–é¢å‚æ•°æŒ‡å®šç¨‹åºè·¯å¾„çš„æƒ…å†µä¸‹, ä¸€èˆ¬ä¼šä»å‡ ä¸ªç¼ºçœè·¯å¾„å°è¯•æ‰§è¡Œ 1 å·è¿›ç¨‹çš„ä»£ç . è¿™å‡ ä¸ªè·¯å¾„éƒ½æ˜¯ Unix å¸¸ç”¨çš„å¯æ‰§è¡Œä»£ç è·¯å¾„.")]),s._v(" "),t("p",[s._v("**ç³»ç»Ÿå¯åŠ¨çš„æ—¶å€™å…ˆæ˜¯æ‰§è¡Œå†…æ ¸æ€çš„ä»£ç , ç„¶ååœ¨å†…æ ¸ä¸­è°ƒç”¨ 1 å·è¿›ç¨‹çš„ä»£ç , ä»å†…æ ¸æ€åˆ‡æ¢åˆ°ç”¨æˆ·æ€. **")]),s._v(" "),t("p",[s._v("ç›®å‰ä¸»æµçš„ Linux å‘è¡Œç‰ˆ, æ— è®ºæ˜¯ RedHat ç³»çš„è¿˜æ˜¯ Debian ç³»çš„, éƒ½ä¼šæŠŠ /sbin/init ä½œä¸ºç¬¦å·é“¾æ¥æŒ‡å‘ Systemd. "),t("strong",[s._v("Systemd æ˜¯ç›®å‰æœ€æµè¡Œçš„ Linux init è¿›ç¨‹")]),s._v(", åœ¨å®ƒä¹‹å‰è¿˜æœ‰ SysVinit, UpStart ç­‰ Linux init è¿›ç¨‹. "),t("mark",[t("strong",[s._v("ä½†æ— è®ºæ˜¯å“ªç§ Linux init è¿›ç¨‹, å®ƒæœ€åŸºæœ¬çš„åŠŸèƒ½éƒ½æ˜¯åˆ›å»ºå‡º Linux ç³»ç»Ÿä¸­å…¶ä»–æ‰€æœ‰çš„è¿›ç¨‹, å¹¶ä¸”ç®¡ç†è¿™äº›è¿›ç¨‹")])]),s._v("â€‹ **. ** å…·ä½“åœ¨ kernel é‡Œçš„ä»£ç å®ç°å¦‚ä¸‹:")]),s._v(" "),t("div",{staticClass:"language-c line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-c"}},[t("code",[s._v("init"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("main"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("c\n        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("/*\n         * We try each of these until one succeeds.\n         *\n         * The Bourne shell can be used instead of init if we are\n         * trying to recover a really broken machine.\n         */")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("execute_command"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n                ret "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("run_init_process")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("execute_command"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n                "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),s._v("ret"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n                        "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n                "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("panic")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Requested init %s failed (error %d)."')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n                      execute_command"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" ret"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("try_to_run_init_process")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/sbin/init"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("||")]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("try_to_run_init_process")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/etc/init"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("||")]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("try_to_run_init_process")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/bin/init"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("||")]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("try_to_run_init_process")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/bin/sh"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n                "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("panic")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"No working init found.  Try passing init= option to kernel. "')]),s._v("\n              "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"See Linux Documentation/admin-guide/init.rst for guidance."')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br")])]),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("$ "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ls")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-l")]),s._v(" /sbin/init\nlrwxrwxrwx "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" root root "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("20")]),s._v(" Feb  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),s._v(" 01:07 /sbin/init -"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" /lib/systemd/systemd\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])]),t("p",[s._v("åœ¨ Linux ä¸Šæœ‰äº†å®¹å™¨çš„æ¦‚å¿µä¹‹å, "),t("strong",[s._v("ä¸€æ—¦å®¹å™¨å»ºç«‹äº†è‡ªå·±çš„ Pid Namespace(è¿›ç¨‹å‘½åç©ºé—´), è¿™ä¸ª Namespace é‡Œçš„è¿›ç¨‹å·ä¹Ÿæ˜¯ä» 1 å¼€å§‹æ ‡è®°çš„. æ‰€ä»¥å®¹å™¨çš„ init è¿›ç¨‹ä¹Ÿè¢«ç§°ä¸º 1 å·è¿›ç¨‹")]),s._v(".")]),s._v(" "),t("p",[s._v("è¿™é‡Œåªéœ€è¦è®°ä½: "),t("mark",[t("strong",[s._v("1 å·è¿›ç¨‹æ˜¯ç¬¬ä¸€ä¸ªç”¨æˆ·æ€çš„è¿›ç¨‹, ç”±å®ƒç›´æ¥æˆ–è€…é—´æ¥åˆ›å»ºäº† Namespace ä¸­çš„å…¶ä»–è¿›ç¨‹")])]),s._v("â€‹ **. **")]),s._v(" "),t("h6",{attrs:{id:"_2-å¦‚ä½•ç†è§£linuxä¿¡å·"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-å¦‚ä½•ç†è§£linuxä¿¡å·"}},[s._v("#")]),s._v(" (2)å¦‚ä½•ç†è§£Linuxä¿¡å·?")]),s._v(" "),t("p",[s._v('è¦æƒ³è§£å†³ "ä¸ºä»€ä¹ˆæˆ‘åœ¨å®¹å™¨ä¸­ä¸èƒ½ kill 1 å·è¿›ç¨‹" è¿™ä¸ªé—®é¢˜, è¿˜å¾—çœ‹çœ‹ kill å‘½ä»¤èµ·åˆ°çš„ä½œç”¨.')]),s._v(" "),t("p",[s._v("è¿è¡Œ kill å‘½ä»¤, å…¶å®"),t("strong",[s._v("åœ¨ Linux é‡Œå°±æ˜¯å‘é€ä¸€ä¸ªä¿¡å·")]),s._v(", é‚£ä¹ˆä¿¡å·åˆ°åº•æ˜¯ä»€ä¹ˆå‘¢? è¿™å°±æ¶‰åŠåˆ° Linux ä¿¡å·çš„æ¦‚å¿µäº†. ä¿¡å·è¿™ä¸ªæ¦‚å¿µåœ¨å¾ˆæ—©æœŸçš„ Unix ç³»ç»Ÿä¸Šå°±æœ‰äº†. å®ƒä¸€èˆ¬ä¼šä» 1 å¼€å§‹ç¼–å·, é€šå¸¸æ¥è¯´, "),t("strong",[s._v("ä¿¡å·ç¼–å·æ˜¯ 1 åˆ° 31")]),s._v(", è¿™ä¸ªç¼–å·åœ¨æ‰€æœ‰çš„ Unix ç³»ç»Ÿä¸Šéƒ½æ˜¯ä¸€æ ·çš„.")]),s._v(" "),t("p",[s._v("åœ¨ Linux ä¸Šå¯ä»¥ç”¨ "),t("code",[s._v("kill -l")]),s._v("â€‹ æ¥çœ‹è¿™äº›ä¿¡å·çš„ç¼–å·å’Œåå­—, å…·ä½“çš„ç¼–å·å’Œåå­—åˆ—åœ¨äº†ä¸‹é¢, å¯ä»¥çœ‹ä¸€çœ‹.")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("$ "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("kill")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-l")]),s._v("\n "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" SIGHUP      "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" SIGINT    "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" SIGQUIT    "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" SIGILL    "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" SIGTRAP\n "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("6")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" SIGABRT     "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("7")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" SIGBUS    "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("8")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" SIGFPE     "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("9")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" SIGKILL  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" SIGUSR1\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("11")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" SIGSEGV    "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("12")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" SIGUSR2  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("13")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" SIGPIPE   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("14")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" SIGALRM  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("15")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" SIGTERM\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("16")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" SIGSTKFLT  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("17")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" SIGCHLD  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("18")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" SIGCONT   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("19")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" SIGSTOP  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("20")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" SIGTSTP\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("21")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" SIGTTIN    "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("22")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" SIGTTOU  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("23")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" SIGURG    "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("24")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" SIGXCPU  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("25")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" SIGXFSZ\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("26")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" SIGVTALRM  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("27")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" SIGPROF  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("28")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" SIGWINCH  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("29")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" SIGIO    "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("30")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" SIGPWR\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("31")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" SIGSYS\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br")])]),t("p",[s._v("ç”¨ä¸€å¥è¯æ¥æ¦‚æ‹¬, "),t("mark",[t("strong",[s._v("ä¿¡å·(Signal)å…¶å®å°±æ˜¯ Linux è¿›ç¨‹æ”¶åˆ°çš„ä¸€ä¸ªé€šçŸ¥")])]),s._v("â€‹ **. ** è¿™äº›é€šçŸ¥äº§ç”Ÿçš„æºå¤´æœ‰å¾ˆå¤šç§, é€šçŸ¥çš„ç±»å‹ä¹Ÿæœ‰å¾ˆå¤šç§.")]),s._v(" "),t("p",[s._v("æ¯”å¦‚ä¸‹é¢è¿™å‡ ä¸ªå…¸å‹çš„åœºæ™¯å¯ä»¥çœ‹ä¸€ä¸‹:")]),s._v(" "),t("ol",[t("li",[s._v('å¦‚æœæŒ‰ä¸‹é”®ç›˜ "Ctrl+C", å½“å‰è¿è¡Œçš„è¿›ç¨‹å°±ä¼šæ”¶åˆ°ä¸€ä¸ªä¿¡å· '),t("strong",[s._v("SIGINT")]),s._v(" è€Œé€€å‡º;")]),s._v(" "),t("li",[s._v("å¦‚æœä»£ç å†™å¾—æœ‰é—®é¢˜, å¯¼è‡´å†…å­˜è®¿é—®å‡ºé”™äº†, å½“å‰çš„è¿›ç¨‹å°±ä¼šæ”¶åˆ°å¦ä¸€ä¸ªä¿¡å· "),t("strong",[s._v("SIGSEGV")]),s._v(";")]),s._v(" "),t("li",[s._v('ä¹Ÿå¯ä»¥é€šè¿‡å‘½ä»¤ kill <pid>, ç›´æ¥å‘ä¸€ä¸ªè¿›ç¨‹å‘é€ä¸€ä¸ªä¿¡å·, ç¼ºçœæƒ…å†µä¸‹ä¸æŒ‡å®šä¿¡å·çš„ç±»å‹, é‚£ä¹ˆè¿™ä¸ªä¿¡å·å°±æ˜¯ SIGTERM. ä¹Ÿå¯ä»¥æŒ‡å®šä¿¡å·ç±»å‹, æ¯”å¦‚å‘½ä»¤ "'),t("code",[s._v("kill -9 <pid>")]),s._v('â€‹", è¿™é‡Œçš„ 9, å°±æ˜¯ç¼–å·ä¸º 9 çš„ä¿¡å·, SIGKILL ä¿¡å·.')])]),s._v(" "),t("p",[s._v("æœ¬èŠ‚ä¸»è¦ç”¨åˆ° "),t("strong",[s._v("SIGTERM(15)å’Œ SIGKILL(9)è¿™ä¸¤ä¸ªä¿¡å·")]),s._v(", æ‰€ä»¥è¿™é‡Œä¸»è¦äº†è§£è¿™ä¸¤ä¸ªä¿¡å·å°±å¯ä»¥äº†, å…¶ä»–ä¿¡å·ä»¥åç”¨åˆ°æ—¶å†åšä»‹ç».")]),s._v(" "),t("p",[t("strong",[s._v("è¿›ç¨‹åœ¨æ”¶åˆ°ä¿¡å·å, å°±ä¼šå»åšç›¸åº”çš„å¤„ç†")]),s._v(". æ€ä¹ˆå¤„ç†å‘¢? å¯¹äºæ¯ä¸€ä¸ªä¿¡å·, è¿›ç¨‹å¯¹å®ƒçš„å¤„ç†éƒ½æœ‰ä¸‹é¢ä¸‰ä¸ªé€‰æ‹©.")]),s._v(" "),t("ul",[t("li",[s._v("ç¬¬ä¸€ä¸ªé€‰æ‹©æ˜¯"),t("strong",[s._v("å¿½ç•¥(Ignore)")]),s._v(" , å°±æ˜¯å¯¹è¿™ä¸ªä¿¡å·ä¸åšä»»ä½•å¤„ç†, ä½†æ˜¯æœ‰ä¸¤ä¸ªä¿¡å·ä¾‹å¤–, å¯¹äº SIGKILL å’Œ SIGSTOP è¿™ä¸ªä¸¤ä¸ªä¿¡å·, è¿›ç¨‹æ˜¯"),t("strong",[s._v("ä¸èƒ½å¿½ç•¥")]),s._v("çš„. è¿™æ˜¯å› ä¸ºå®ƒä»¬çš„ä¸»è¦ä½œç”¨æ˜¯ä¸º Linux kernel å’Œè¶…çº§ç”¨æˆ·æä¾›åˆ é™¤ä»»æ„è¿›ç¨‹çš„ç‰¹æƒ.")]),s._v(" "),t("li",[s._v("ç¬¬äºŒä¸ªé€‰æ‹©æ˜¯"),t("strong",[s._v("æ•è·(Catch)")]),s._v(" , è¿™ä¸ªæ˜¯æŒ‡è®©ç”¨æˆ·è¿›ç¨‹å¯ä»¥"),t("strong",[s._v("æ³¨å†Œ")]),s._v("è‡ªå·±é’ˆå¯¹è¿™ä¸ªä¿¡å·çš„ handler. å…·ä½“æ€ä¹ˆåšç›®å‰æš‚æ—¶æ¶‰åŠä¸åˆ°, å…ˆçŸ¥é“å°±è¡Œ, åé¢ä¼šè¿›è¡Œè¯¦ç»†ä»‹ç». **å¯¹äºæ•è·, SIGKILL å’Œ SIGSTOP è¿™ä¸¤ä¸ªä¿¡å·ä¹ŸåŒæ ·ä¾‹å¤–, è¿™ä¸¤ä¸ªä¿¡å·ä¸èƒ½æœ‰ç”¨æˆ·è‡ªå·±çš„å¤„ç†ä»£ç , åªèƒ½æ‰§è¡Œç³»ç»Ÿçš„ç¼ºçœè¡Œä¸º. **")]),s._v(" "),t("li",[s._v("ç¬¬ä¸‰ä¸ªé€‰æ‹©æ˜¯"),t("strong",[s._v("ç¼ºçœè¡Œä¸º(Default)")]),s._v(" , Linux ä¸ºæ¯ä¸ªä¿¡å·éƒ½å®šä¹‰äº†ä¸€ä¸ªç¼ºçœçš„è¡Œä¸º, å¯ä»¥åœ¨ Linux ç³»ç»Ÿä¸­è¿è¡Œ "),t("code",[s._v("man 7 signal")]),s._v("â€‹ æ¥æŸ¥çœ‹æ¯ä¸ªä¿¡å·çš„ç¼ºçœè¡Œä¸º.")])]),s._v(" "),t("p",[s._v("å¯¹äºå¤§éƒ¨åˆ†çš„ä¿¡å·è€Œè¨€, åº”ç”¨ç¨‹åºä¸éœ€è¦æ³¨å†Œè‡ªå·±çš„ handler, "),t("strong",[s._v("ä½¿ç”¨ç³»ç»Ÿç¼ºçœå®šä¹‰è¡Œä¸º")]),s._v("å°±å¯ä»¥äº†.")]),s._v(" "),t("p",[t("img",{attrs:{src:"/img/91c4469c38904c5fc2ab62499be203f7-20230731161430-86vuzzd.png",alt:""}})]),s._v(" "),t("p",[s._v("SIGTERM(15)å’Œ SIGKILL(9)è¿™ä¸¤ä¸ªä¿¡å·æ˜¯éœ€è¦é‡ç‚¹æŒæ¡çš„. ç°åœ¨å·²ç»è®²è§£äº†ä¿¡å·çš„æ¦‚å¿µå’Œå¤„ç†æ–¹å¼, è¿™é‡Œå°±æ‹¿è¿™ä¸¤ä¸ªä¿¡å·ä¸ºä¾‹, å†å…·ä½“åˆ†æä¸€ä¸‹.")]),s._v(" "),t("p",[s._v("é¦–å…ˆæ¥çœ‹ SIGTERM(15), è¿™ä¸ªä¿¡å·æ˜¯ Linux å‘½ä»¤ "),t("strong",[s._v("kill ç¼ºçœå‘å‡º")]),s._v("çš„. å‰é¢ä¾‹å­é‡Œçš„å‘½ä»¤ "),t("code",[s._v("kill 1")]),s._v("â€‹, å°±æ˜¯é€šè¿‡ kill å‘ 1 å·è¿›ç¨‹å‘é€ä¸€ä¸ªä¿¡å·, åœ¨æ²¡æœ‰åˆ«çš„å‚æ•°æ—¶, è¿™ä¸ªä¿¡å·ç±»å‹å°±é»˜è®¤ä¸º "),t("strong",[s._v("SIGTERM")]),s._v(".")]),s._v(" "),t("p",[t("strong",[s._v('SIGTERM è¿™ä¸ªä¿¡å·æ˜¯å¯ä»¥è¢«æ•è·çš„, è¿™é‡Œçš„ "æ•è·" æŒ‡çš„å°±æ˜¯ç”¨æˆ·è¿›ç¨‹å¯ä»¥ä¸ºè¿™ä¸ªä¿¡å·æ³¨å†Œè‡ªå·±çš„ handler, è€Œè¿™ä¸ª handler, åé¢ä¼šçœ‹åˆ°, å®ƒå¯ä»¥å¤„ç†è¿›ç¨‹çš„ graceful-shutdown é—®é¢˜.')])]),s._v(" "),t("p",[s._v("å†æ¥äº†è§£ä¸€ä¸‹ SIGKILL (9), è¿™ä¸ªä¿¡å·æ˜¯ Linux é‡Œä¸¤ä¸ª"),t("strong",[s._v("ç‰¹æƒä¿¡å·")]),s._v("ä¹‹ä¸€. ä»€ä¹ˆæ˜¯ç‰¹æƒä¿¡å·å‘¢?")]),s._v(" "),t("p",[s._v("å‰é¢å·²ç»æåˆ°è¿‡äº†, **ç‰¹æƒä¿¡å·å°±æ˜¯ Linux ä¸º kernel å’Œè¶…çº§ç”¨æˆ·å»åˆ é™¤ä»»æ„è¿›ç¨‹æ‰€ä¿ç•™çš„, ä¸èƒ½è¢«å¿½ç•¥ä¹Ÿä¸èƒ½è¢«æ•è·. ** é‚£ä¹ˆè¿›ç¨‹ä¸€æ—¦æ”¶åˆ° SIGKILL, å°±è¦é€€å‡º.")]),s._v(" "),t("p",[s._v("åœ¨å‰é¢çš„ä¾‹å­é‡Œ, è¿è¡Œçš„å‘½ä»¤ "),t("code",[s._v("kill -9 1")]),s._v('â€‹ é‡Œçš„å‚æ•° "-9", å…¶å®å°±æ˜¯æŒ‡å‘é€ç¼–å·ä¸º 9 çš„è¿™ä¸ª SIGKILL ä¿¡å·ç»™ 1 å·è¿›ç¨‹.')]),s._v(" "),t("h5",{attrs:{id:"_3-ç°è±¡è§£é‡Š"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-ç°è±¡è§£é‡Š"}},[s._v("#")]),s._v(" 3.ç°è±¡è§£é‡Š")]),s._v(" "),t("p",[s._v('ç°åœ¨åº”è¯¥ç†è§£ init è¿›ç¨‹å’Œ Linux ä¿¡å·è¿™ä¸¤ä¸ªæ¦‚å¿µäº†, å›åˆ°å¼€å¤´çš„é—®é¢˜ä¸Šæ¥: "ä¸ºä»€ä¹ˆæˆ‘åœ¨å®¹å™¨ä¸­ä¸èƒ½ kill 1 å·è¿›ç¨‹, ç”šè‡³ SIGKILL ä¿¡å·ä¹Ÿä¸è¡Œ? "')]),s._v(" "),t("p",[s._v("æœ¬èŠ‚æœ€å¼€å§‹, å·²ç»å°è¯•è¿‡ç”¨ bash ä½œä¸ºå®¹å™¨ 1 å·è¿›ç¨‹, è¿™æ ·æ˜¯æ— æ³•æŠŠ 1 å·è¿›ç¨‹æ€æ‰çš„. é‚£ä¹ˆå†çœ‹çœ‹, ç”¨åˆ«çš„ç¼–ç¨‹è¯­è¨€å†™çš„ 1 å·è¿›ç¨‹æ˜¯å¦ä¹Ÿæ€ä¸æ‰.")]),s._v(" "),t("p",[s._v("ç°åœ¨"),t("strong",[s._v("ç”¨ C ç¨‹åºä½œä¸º init è¿›ç¨‹")]),s._v(", å°è¯•ä¸€ä¸‹æ€æ‰ 1 å·è¿›ç¨‹. å’Œ bash init è¿›ç¨‹ä¸€æ ·, æ— è®º SIGTERM ä¿¡å·è¿˜æ˜¯ SIGKILL ä¿¡å·, åœ¨å®¹å™¨é‡Œéƒ½"),t("strong",[s._v("ä¸èƒ½æ€æ­»")]),s._v("è¿™ä¸ª 1 å·è¿›ç¨‹.")]),s._v(" "),t("div",{staticClass:"language-c line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-c"}},[t("code",[t("span",{pre:!0,attrs:{class:"token macro property"}},[t("span",{pre:!0,attrs:{class:"token directive-hash"}},[s._v("#")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token directive keyword"}},[s._v("cat")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token expression"}},[s._v("c"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("init"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("nosig"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("c")])]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token macro property"}},[t("span",{pre:!0,attrs:{class:"token directive-hash"}},[s._v("#")]),t("span",{pre:!0,attrs:{class:"token directive keyword"}},[s._v("include")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("<stdio.h>")])]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token macro property"}},[t("span",{pre:!0,attrs:{class:"token directive-hash"}},[s._v("#")]),t("span",{pre:!0,attrs:{class:"token directive keyword"}},[s._v("include")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("<unistd.h>")])]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("main")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" argc"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("char")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("argv"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n       "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("printf")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Process is sleeping\\n"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n       "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("while")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n              "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("sleep")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("100")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n       "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n       "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br")])]),t("div",{staticClass:"language-c line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-c"}},[t("code",[t("span",{pre:!0,attrs:{class:"token macro property"}},[t("span",{pre:!0,attrs:{class:"token directive-hash"}},[s._v("#")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token directive keyword"}},[s._v("docker")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token expression"}},[s._v("stop sig"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("proc"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("docker rm sig"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("proc")])]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token macro property"}},[t("span",{pre:!0,attrs:{class:"token directive-hash"}},[s._v("#")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token directive keyword"}},[s._v("docker")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token expression"}},[s._v("run "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v("name sig"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("proc "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("d registry"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("sig"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("proc"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v("v1 "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("c"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("init"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("nosig")])]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token macro property"}},[t("span",{pre:!0,attrs:{class:"token directive-hash"}},[s._v("#")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token directive keyword"}},[s._v("docker")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token expression"}},[s._v("exec "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("it sig"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("proc bash")])]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),s._v("d3d42a031b1 "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("# ps "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("ef\nUID        PID  PPID  C STIME TTY          TIME CMD\nroot         "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("     "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("07")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("48")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("?")]),s._v("        "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("00")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("00")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("00")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("c"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("init"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("nosig\nroot         "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("6")]),s._v("     "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("07")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("48")]),s._v(" pts"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("    "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("00")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("00")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("00")]),s._v(" bash\nroot        "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("19")]),s._v("     "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("6")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("07")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("48")]),s._v(" pts"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("    "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("00")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("00")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("00")]),s._v(" ps "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("ef\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),s._v("d3d42a031b1 "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("# kill "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),s._v("d3d42a031b1 "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("# kill "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("9")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),s._v("d3d42a031b1 "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("# ps "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("ef\nUID        PID  PPID  C STIME TTY          TIME CMD\nroot         "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("     "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("07")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("48")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("?")]),s._v("        "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("00")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("00")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("00")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("c"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("init"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("nosig\nroot         "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("6")]),s._v("     "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("07")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("48")]),s._v(" pts"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("    "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("00")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("00")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("00")]),s._v(" bash\nroot        "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("20")]),s._v("     "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("6")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("07")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("49")]),s._v(" pts"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("    "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("00")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("00")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("00")]),s._v(" ps "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("ef\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br")])]),t("p",[s._v('æ˜¯ä¸æ˜¯è¿™æ ·å°±å¯ä»¥å¾—å‡ºç»“è®º---"å®¹å™¨é‡Œçš„ 1 å·è¿›ç¨‹, å®Œå…¨å¿½ç•¥äº† SIGTERM å’Œ SIGKILL ä¿¡å·äº†" å‘¢? å…ˆåˆ«ç€æ€¥, å†æ‹¿å…¶ä»–è¯­è¨€è¯•è¯•.')]),s._v(" "),t("p",[s._v("æ¥ä¸‹æ¥ç”¨ "),t("strong",[s._v("Golang ç¨‹åºä½œä¸º 1 å·è¿›ç¨‹")]),s._v(", å†åœ¨å®¹å™¨ä¸­æ‰§è¡Œ "),t("code",[s._v("kill -9 1")]),s._v("â€‹ å’Œ "),t("code",[s._v("kill 1")]),s._v("â€‹. å¯ä»¥å‘ç° "),t("code",[s._v("kill -9 1")]),s._v("â€‹ è¿™ä¸ªå‘½ä»¤ä»ç„¶ä¸èƒ½æ€æ­» 1 å·è¿›ç¨‹, ä¹Ÿå°±æ˜¯è¯´ SIGKILL ä¿¡å·å’Œä¹‹å‰çš„ä¸¤ä¸ªæµ‹è¯•ä¸€æ ·ä¸èµ·ä½œç”¨.")]),s._v(" "),t("p",[s._v("**ä½†æ˜¯æ‰§è¡Œ **â€‹"),t("strong",[t("strong",[s._v("â€‹"),t("code",[s._v("kill 1")]),s._v("â€‹")])]),s._v("â€‹ ** ä»¥å, SIGTERM è¿™ä¸ªä¿¡å·æŠŠ init è¿›ç¨‹ç»™æ€äº†, å®¹å™¨é€€å‡ºäº†. **")]),s._v(" "),t("div",{staticClass:"language-go line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-go"}},[t("code",[s._v("# cat "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("go")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("init"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("go")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("package")]),s._v(" main\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("\n       "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"fmt"')]),s._v("\n       "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"time"')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("func")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("main")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n       fmt"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("Println")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Start app\\n"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n       time"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("Sleep")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("time"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("Duration")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("100000")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v(" time"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("Millisecond"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br")])]),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# docker stop sig-proc;docker rm sig-proc")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# docker run --name sig-proc -d registry/sig-proc:v1 /go-init")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# docker exec -it sig-proc bash")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@234a23aa597b /"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ps -ef")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token environment constant"}},[s._v("UID")]),s._v("        PID  "),t("span",{pre:!0,attrs:{class:"token environment constant"}},[s._v("PPID")]),s._v("  C STIME TTY          TIME CMD\nroot         "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("     "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" 08:04 ?        00:00:00 /go-init\nroot        "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v("     "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("9")]),s._v(" 08:04 pts/0    00:00:00 "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("bash")]),s._v("\nroot        "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("23")]),s._v("    "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" 08:04 pts/0    00:00:00 "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ps")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-ef")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@234a23aa597b /"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kill -9 1")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@234a23aa597b /"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kill 1")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@234a23aa597b /"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# [~]# docker ps")]),s._v("\nCONTAINER ID        IMAGE               COMMAND             CREATED             STATUS              PORTS               NAMES\n\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br")])]),t("p",[s._v("å¯¹äºè¿™ä¸ªæµ‹è¯•ç»“æœ, ä½ æ˜¯ä¸æ˜¯åè€Œè§‰å¾—æ›´åŠ å›°æƒ‘äº†?")]),s._v(" "),t("p",[t("strong",[s._v("ä¸ºä»€ä¹ˆä½¿ç”¨ä¸åŒç¨‹åº, ç»“æœå°±ä¸ä¸€æ ·å‘¢")]),s._v("? æ¥ä¸‹æ¥å°±çœ‹çœ‹ kill å‘½ä»¤ä¸‹è¾¾ä¹‹å, Linux é‡Œç©¶ç«Ÿå‘ç”Ÿäº†ä»€ä¹ˆäº‹, è¿™é‡Œç³»ç»Ÿåœ°æ¢³ç†ä¸€ä¸‹æ•´ä¸ªè¿‡ç¨‹.")]),s._v(" "),t("p",[s._v("åœ¨è¿è¡Œ "),t("code",[s._v("kill 1")]),s._v("â€‹ è¿™ä¸ªå‘½ä»¤çš„æ—¶å€™, å¸Œæœ›æŠŠ SIGTERM è¿™ä¸ªä¿¡å·å‘é€ç»™ 1 å·è¿›ç¨‹, å°±åƒä¸‹é¢å›¾é‡Œçš„"),t("strong",[s._v("å¸¦ç®­å¤´è™šçº¿")]),s._v(".")]),s._v(" "),t("p",[s._v("åœ¨ Linux å®ç°é‡Œ, kill å‘½ä»¤è°ƒç”¨äº† "),t("strong",[s._v("kill() çš„è¿™ä¸ªç³»ç»Ÿè°ƒç”¨")]),s._v("(æ‰€è°“ç³»ç»Ÿè°ƒç”¨å°±æ˜¯å†…æ ¸çš„è°ƒç”¨æ¥å£)è€Œè¿›å…¥åˆ°äº†å†…æ ¸å‡½æ•° "),t("strong",[s._v("sys_kill")]),s._v("(), ä¹Ÿå°±æ˜¯ä¸‹å›¾é‡Œçš„"),t("strong",[s._v("å®çº¿ç®­å¤´")]),s._v(".")]),s._v(" "),t("p",[s._v("è€Œå†…æ ¸åœ¨å†³å®šæŠŠä¿¡å·å‘é€ç»™ 1 å·è¿›ç¨‹çš„æ—¶å€™, ä¼šè°ƒç”¨ "),t("strong",[s._v("sig_task_ignored")]),s._v("() è¿™ä¸ªå‡½æ•°æ¥åšä¸ªåˆ¤æ–­, è¿™ä¸ªåˆ¤æ–­æœ‰ä»€ä¹ˆç”¨å‘¢? å®ƒä¼šå†³å®šå†…æ ¸åœ¨"),t("strong",[s._v("å“ªäº›æƒ…å†µä¸‹ä¼šæŠŠå‘é€çš„è¿™ä¸ªä¿¡å·ç»™å¿½ç•¥æ‰")]),s._v(". å¦‚æœä¿¡å·è¢«å¿½ç•¥äº†, é‚£ä¹ˆ init è¿›ç¨‹å°±ä¸èƒ½æ”¶åˆ°æŒ‡ä»¤äº†.")]),s._v(" "),t("p",[s._v("æ‰€ä»¥æƒ³è¦çŸ¥é“ init è¿›ç¨‹ä¸ºä»€ä¹ˆæ”¶åˆ°æˆ–è€…æ”¶ä¸åˆ°ä¿¡å·, éƒ½è¦å»çœ‹çœ‹ **sig_task_ignored() çš„è¿™ä¸ªå†…æ ¸å‡½æ•°çš„å®ç°. **")]),s._v(" "),t("p",[t("img",{attrs:{src:"/img/6b42b07720a1ae463ecf5cfbc23a22a3-20230731161430-uxgmxn9.png",alt:"",title:"sig_task_ignored() å†…æ ¸å‡½æ•°å®ç°ç¤ºæ„å›¾"}})]),s._v(" "),t("p",[s._v("â€")]),s._v(" "),t("p",[s._v("åœ¨ sig_task_ignored() è¿™ä¸ªå‡½æ•°ä¸­æœ‰ä¸‰ä¸ª if{} åˆ¤æ–­, ç¬¬ä¸€ä¸ªå’Œç¬¬ä¸‰ä¸ª if{} åˆ¤æ–­å’Œæœ¬èŠ‚çš„é—®é¢˜æ²¡æœ‰å…³ç³», å¹¶ä¸”ä»£ç æœ‰æ³¨é‡Š, å°±ä¸è®¨è®ºäº†. é‡ç‚¹æ¥çœ‹ç¬¬äºŒä¸ª if{}. æ¥åˆ†æä¸€ä¸‹, åœ¨å®¹å™¨ä¸­æ‰§è¡Œ "),t("code",[s._v("kill 1")]),s._v("â€‹ æˆ–è€… "),t("code",[s._v("kill -9 1")]),s._v("â€‹ çš„æ—¶å€™, è¿™ç¬¬äºŒä¸ª if{} é‡Œçš„ä¸‰ä¸ªå­æ¡ä»¶æ˜¯å¦å¯ä»¥è¢«æ»¡è¶³å‘¢?")]),s._v(" "),t("p",[s._v("æ¥çœ‹ä¸‹é¢è¿™ä¸²ä»£ç , è¿™é‡Œè¡¨ç¤º"),t("mark",[t("strong",[s._v("ä¸€æ—¦è¿™ä¸‰ä¸ªå­æ¡ä»¶éƒ½è¢«æ»¡è¶³, é‚£ä¹ˆè¿™ä¸ªä¿¡å·å°±ä¸ä¼šå‘é€ç»™è¿›ç¨‹")])]),s._v("â€‹ **. **")]),s._v(" "),t("div",{staticClass:"language-c line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-c"}},[t("code",[s._v("kernel"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("signal"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("c\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("static")]),s._v(" bool "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("sig_task_ignored")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("struct")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("task_struct")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("t"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" sig"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" bool force"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("void")]),s._v(" __user "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("handler"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        handler "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("sig_handler")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("t"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" sig"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("/* SIGKILL and SIGSTOP may not be sent to the global init */")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("unlikely")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("is_global_init")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("t"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&&")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("sig_kernel_only")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("sig"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n                "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" true"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("unlikely")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("t"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("signal"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("flags "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&")]),s._v(" SIGNAL_UNKILLABLE"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&&")]),s._v("\n            handler "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("mark"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" SIG_DFL "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&&")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("force "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&&")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("sig_kernel_only")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("sig"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n                "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" true"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("/* Only allow kernel generated signals to this kthread */")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("unlikely")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("t"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("flags "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&")]),s._v(" PF_KTHREAD"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&&")]),s._v("\n                     "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("handler "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("mark"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" SIG_KTHREAD_KERNEL"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&&")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),s._v("force"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n                "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" true"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("sig_handler_ignored")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("handler"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" sig"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br")])]),t("p",[s._v('æ¥ä¸‹æ¥, å°±é€ä¸€åˆ†æä¸€ä¸‹è¿™ä¸‰ä¸ªå­æ¡ä»¶, æ¥è¯´è¯´è¿™ä¸ª " '),t("strong",[s._v("!(force && sig_kernel_only(sig))")]),s._v(' ".')]),s._v(" "),t("p",[s._v("ç¬¬ä¸€ä¸ªæ¡ä»¶é‡Œ force çš„å€¼, å¯¹äºåŒä¸€ä¸ª Namespace é‡Œå‘å‡ºçš„ä¿¡å·æ¥è¯´, è°ƒç”¨å€¼æ˜¯ 0, æ‰€ä»¥è¿™ä¸ªæ¡ä»¶"),t("strong",[s._v("æ€»æ˜¯æ»¡è¶³")]),s._v("çš„.")]),s._v(" "),t("p",[s._v('å†æ¥çœ‹ä¸€ä¸‹ç¬¬äºŒä¸ªæ¡ä»¶ "'),t("strong",[s._v("handler == SIG_DFL")]),s._v('", ç¬¬äºŒä¸ªæ¡ä»¶åˆ¤æ–­ä¿¡å·çš„ handler æ˜¯å¦æ˜¯ SIG_DFL. ä»€ä¹ˆæ˜¯ SIG_DFL å‘¢? '),t("strong",[s._v("å¯¹äºæ¯ä¸ªä¿¡å·, ç”¨æˆ·è¿›ç¨‹å¦‚æœä¸æ³¨å†Œä¸€ä¸ªè‡ªå·±çš„ handler, å°±ä¼šæœ‰ä¸€ä¸ªç³»ç»Ÿç¼ºçœçš„ handler, è¿™ä¸ªç¼ºçœçš„ handler å°±å«ä½œ SIG_DFL. ** å¯¹äº SIGKILL, å‰é¢ä»‹ç»è¿‡å®ƒæ˜¯ç‰¹æƒä¿¡å·, æ˜¯")]),s._v("ä¸å…è®¸è¢«æ•è·"),t("strong",[s._v("çš„, æ‰€ä»¥å®ƒçš„ handler å°±ä¸€ç›´æ˜¯ SIG_DFL. è¿™ç¬¬äºŒä¸ªæ¡ä»¶å¯¹ SIGKILL æ¥è¯´")]),s._v("æ€»æ˜¯æ»¡è¶³**çš„. å¯¹äº SIGTERM, å®ƒæ˜¯å¯ä»¥è¢«æ•è·çš„. ä¹Ÿå°±æ˜¯è¯´å¦‚æœç”¨æˆ·ä¸æ³¨å†Œ handler, é‚£ä¹ˆè¿™ä¸ªæ¡ä»¶å¯¹ SIGTERM ä¹Ÿæ˜¯æ»¡è¶³çš„.")]),s._v(" "),t("p",[s._v('æœ€åå†æ¥çœ‹ä¸€ä¸‹ç¬¬ä¸‰ä¸ªæ¡ä»¶, "t->signal->flags & SIGNAL_UNKILLABLE", è¿™é‡Œçš„æ¡ä»¶åˆ¤æ–­æ˜¯è¿™æ ·çš„, '),t("strong",[s._v("è¿›ç¨‹å¿…é¡»æ˜¯ SIGNAL_UNKILLABLE")]),s._v(" çš„.")]),s._v(" "),t("p",[s._v("è¿™ä¸ª SIGNAL_UNKILLABLE flag æ˜¯åœ¨å“ªé‡Œç½®ä½çš„å‘¢?")]),s._v(" "),t("p",[s._v("å¯ä»¥å‚è€ƒä¸‹é¢çš„è¿™æ®µä»£ç , åœ¨æ¯ä¸ª Namespace çš„ init è¿›ç¨‹å»ºç«‹çš„æ—¶å€™, å°±ä¼šæ‰“ä¸Š "),t("strong",[s._v("SIGNAL_UNKILLABLE")]),s._v(" è¿™ä¸ªæ ‡ç­¾, ä¹Ÿå°±æ˜¯è¯´"),t("strong",[s._v("åªè¦æ˜¯ 1 å·è¿›ç¨‹, å°±ä¼šæœ‰è¿™ä¸ª flag")]),s._v(", è¿™ä¸ªæ¡ä»¶ä¹Ÿæ˜¯æ»¡è¶³çš„.")]),s._v(" "),t("div",{staticClass:"language-c line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-c"}},[t("code",[s._v("kernel"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("fork"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("c\n                       "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("is_child_reaper")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("pid"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n                                "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ns_of_pid")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("pid"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("child_reaper "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" p"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n                                p"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("signal"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("flags "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|=")]),s._v(" SIGNAL_UNKILLABLE"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n                        "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("/*\n * is_child_reaper returns true if the pid is the init process\n * of the current namespace. As this one could be checked before\n * pid_ns->child_reaper is assigned in copy_process, we check\n * with the pid number.\n */")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("static")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("inline")]),s._v(" bool "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("is_child_reaper")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("struct")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("pid")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("pid"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" pid"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("numbers"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("pid"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("level"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("nr "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br")])]),t("p",[s._v("å¯ä»¥çœ‹å‡ºæ¥, å…¶å®"),t("strong",[s._v("æœ€å…³é”®çš„ä¸€ç‚¹å°±æ˜¯ "),t("strong",[s._v("â€‹")]),s._v("â€‹"),t("code",[s._v("handler <mark> SIG_DFL")]),s._v("â€‹")]),s._v("â€‹ **. "),t("strong",[s._v("â€‹")]),s._v("Linux å†…æ ¸é’ˆå¯¹æ¯ä¸ª Nnamespace é‡Œçš„ init è¿›ç¨‹, æŠŠåªæœ‰ default handler çš„ä¿¡å·éƒ½ç»™å¿½ç•¥äº†==**â€‹ **. **")]),s._v(" "),t("p",[s._v('å¦‚æœè‡ªå·±æ³¨å†Œäº†ä¿¡å·çš„ handler(åº”ç”¨ç¨‹åºæ³¨å†Œä¿¡å· handler è¢«ç§°ä½œ"Catch the Signal"), é‚£ä¹ˆè¿™ä¸ªä¿¡å· handler å°±ä¸å†æ˜¯ SIG_DFL. å³ä½¿æ˜¯ init è¿›ç¨‹åœ¨æ¥æ”¶åˆ° SIGTERM ä¹‹åä¹Ÿæ˜¯å¯ä»¥é€€å‡ºçš„.')]),s._v(" "),t("p",[s._v("ä¸è¿‡, ç”±äº SIGKILL æ˜¯ä¸€ä¸ªç‰¹ä¾‹, å› ä¸º SIGKILL æ˜¯ä¸å…è®¸è¢«æ³¨å†Œç”¨æˆ· handler çš„(è¿˜æœ‰ä¸€ä¸ªä¸å…è®¸æ³¨å†Œç”¨æˆ· handler çš„ä¿¡å·æ˜¯ SIGSTOP), é‚£ä¹ˆå®ƒåªæœ‰ SIG_DFL handler.")]),s._v(" "),t("p",[t("mark",[s._v("**æ‰€ä»¥ init è¿›ç¨‹æ˜¯æ°¸è¿œä¸èƒ½è¢« SIGKILL æ‰€æ€, ä½†æ˜¯å¯ä»¥è¢« SIGTERM æ€æ­». **")])]),s._v(" "),t("p",[s._v("è¯´åˆ°è¿™é‡Œ, è¯¥æ€ä¹ˆè¯å®è¿™ä¸€ç‚¹å‘¢? å¯ä»¥åšä¸‹é¢ä¸¤ä»¶äº‹æ¥éªŒè¯.")]),s._v(" "),t("p",[s._v("**ç¬¬ä¸€ä»¶äº‹, å¯ä»¥æŸ¥çœ‹ 1 å·è¿›ç¨‹çŠ¶æ€ä¸­ SigCgt Bitmap. **")]),s._v(" "),t("p",[s._v("å¯ä»¥çœ‹åˆ°, åœ¨ Golang ç¨‹åºé‡Œ, å¾ˆå¤šä¿¡å·éƒ½æ³¨å†Œäº†è‡ªå·±çš„ handler, å½“ç„¶ä¹ŸåŒ…æ‹¬äº† SIGTERM(15), ä¹Ÿå°±æ˜¯ bit 15. è€Œ C ç¨‹åºé‡Œ, ç¼ºçœçŠ¶æ€ä¸‹, ä¸€ä¸ªä¿¡å· handler éƒ½æ²¡æœ‰æ³¨å†Œ; bash ç¨‹åºé‡Œæ³¨å†Œäº†ä¸¤ä¸ª handler, bit 2 å’Œ bit 17, ä¹Ÿå°±æ˜¯ SIGINT å’Œ SIGCHLD, ä½†æ˜¯æ²¡æœ‰æ³¨å†Œ SIGTERM. æ‰€ä»¥, C ç¨‹åºå’Œ bash ç¨‹åºé‡Œ SIGTERM çš„ handler æ˜¯ SIG_DFL(ç³»ç»Ÿ"),t("strong",[s._v("ç¼ºçœ")]),s._v("è¡Œä¸º), é‚£ä¹ˆå®ƒä»¬å°±ä¸èƒ½è¢« SIGTERM æ‰€æ€.")]),s._v(" "),t("p",[s._v("å…·ä½“å¯ä»¥çœ‹ä¸€ä¸‹è¿™æ®µ /proc ç³»ç»Ÿçš„è¿›ç¨‹çŠ¶æ€:")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("### golang init")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cat /proc/1/status | grep -i SigCgt")]),s._v("\nSigCgt:     fffffffe7fc1feff\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("### C init")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cat /proc/1/status | grep -i SigCgt")]),s._v("\nSigCgt:     0000000000000000\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("### bash init")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cat /proc/1/status | grep -i SigCgt")]),s._v("\nSigCgt:     0000000000010002\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br")])]),t("p",[s._v("**ç¬¬äºŒä»¶äº‹, ç»™ C ç¨‹åºæ³¨å†Œä¸€ä¸‹ SIGTERM handler, æ•è· SIGTERM. **")]),s._v(" "),t("p",[s._v("è°ƒç”¨ signal() ç³»ç»Ÿè°ƒç”¨æ³¨å†Œ SIGTERM çš„ handler, åœ¨ handler é‡Œä¸»åŠ¨é€€å‡º, å†çœ‹çœ‹å®¹å™¨ä¸­ "),t("code",[s._v("kill 1")]),s._v("â€‹ çš„ç»“æœ.")]),s._v(" "),t("p",[s._v("è¿™æ¬¡å°±å¯ä»¥çœ‹åˆ°, **åœ¨è¿›ç¨‹çŠ¶æ€çš„ SigCgt bitmap é‡Œ, bit 15 (SIGTERM) å·²ç»ç½®ä½äº†. åŒæ—¶è¿è¡Œ **â€‹"),t("strong",[t("strong",[s._v("â€‹"),t("code",[s._v("kill 1")]),s._v("â€‹")])]),s._v("â€‹ ** ä¹Ÿå¯ä»¥æŠŠè¿™ä¸ª C ç¨‹åºçš„ init è¿›ç¨‹ç»™æ€æ­»äº†. **")]),s._v(" "),t("div",{staticClass:"language-c line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-c"}},[t("code",[t("span",{pre:!0,attrs:{class:"token macro property"}},[t("span",{pre:!0,attrs:{class:"token directive-hash"}},[s._v("#")]),t("span",{pre:!0,attrs:{class:"token directive keyword"}},[s._v("include")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("<stdio.h>")])]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token macro property"}},[t("span",{pre:!0,attrs:{class:"token directive-hash"}},[s._v("#")]),t("span",{pre:!0,attrs:{class:"token directive keyword"}},[s._v("include")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("<stdlib.h>")])]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token macro property"}},[t("span",{pre:!0,attrs:{class:"token directive-hash"}},[s._v("#")]),t("span",{pre:!0,attrs:{class:"token directive keyword"}},[s._v("include")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("<sys/types.h>")])]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token macro property"}},[t("span",{pre:!0,attrs:{class:"token directive-hash"}},[s._v("#")]),t("span",{pre:!0,attrs:{class:"token directive keyword"}},[s._v("include")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("<sys/wait.h>")])]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token macro property"}},[t("span",{pre:!0,attrs:{class:"token directive-hash"}},[s._v("#")]),t("span",{pre:!0,attrs:{class:"token directive keyword"}},[s._v("include")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("<unistd.h>")])]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("void")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("sig_handler")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" signo"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("signo "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),s._v(" SIGTERM"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n           "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("printf")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"received SIGTERM\\n"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n           "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("exit")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("main")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" argc"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("char")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("argv"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("signal")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("SIGTERM"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" sig_handler"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("printf")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Process is sleeping\\n"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("while")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n           "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("sleep")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("100")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br")])]),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# docker stop sig-proc;docker rm sig-proc")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# docker run --name sig-proc -d registry/sig-proc:v1 /c-init-sig")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# docker exec -it sig-proc bash")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@043f4f717cb5 /"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ps -ef")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token environment constant"}},[s._v("UID")]),s._v("        PID  "),t("span",{pre:!0,attrs:{class:"token environment constant"}},[s._v("PPID")]),s._v("  C STIME TTY          TIME CMD\nroot         "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("     "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" 09:05 ?        00:00:00 /c-init-sig\nroot         "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("6")]),s._v("     "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("18")]),s._v(" 09:06 pts/0    00:00:00 "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("bash")]),s._v("\nroot        "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("19")]),s._v("     "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("6")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" 09:06 pts/0    00:00:00 "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ps")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-ef")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@043f4f717cb5 /"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cat /proc/1/status | grep SigCgt")]),s._v("\nSigCgt: 0000000000004000\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@043f4f717cb5 /"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kill 1")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# docker ps")]),s._v("\nCONTAINER ID        IMAGE               COMMAND             CREATED             STATUS              PORTS               NAMES\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br")])]),t("p",[s._v("åˆ°è¿™é‡Œå¯ä»¥ç¡®å®šè¿™ä¸¤ç‚¹:")]),s._v(" "),t("ul",[t("li",[t("p",[t("code",[s._v("kill -9 1")]),s._v("â€‹ åœ¨å®¹å™¨ä¸­æ˜¯ä¸å·¥ä½œçš„, å†…æ ¸é˜»æ­¢äº† 1 å·è¿›ç¨‹å¯¹ SIGKILL ç‰¹æƒä¿¡å·çš„å“åº”.")])]),s._v(" "),t("li",[t("p",[t("code",[s._v("kill 1")]),s._v("â€‹ åˆ†ä¸¤ç§æƒ…å†µ, å¦‚æœ 1 å·è¿›ç¨‹æ²¡æœ‰æ³¨å†Œ SIGTERM çš„ handler, é‚£ä¹ˆå¯¹ SIGTERM ä¿¡å·ä¹Ÿä¸å“åº”, å¦‚æœæ³¨å†Œäº† handler, é‚£ä¹ˆå°±å¯ä»¥å“åº” SIGTERM ä¿¡å·.")])])]),s._v(" "),t("h5",{attrs:{id:"_4-é‡ç‚¹æ€»ç»“-2"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_4-é‡ç‚¹æ€»ç»“-2"}},[s._v("#")]),s._v(" 4.é‡ç‚¹æ€»ç»“")]),s._v(" "),t("p",[s._v('è¿™ä¸€è®²ä¸»è¦è®²äº† init è¿›ç¨‹. å›´ç»•è¿™ä¸ªçŸ¥è¯†ç‚¹, æå‡ºäº†ä¸€ä¸ªçœŸå®å‘ç”Ÿçš„é—®é¢˜: "ä¸ºä»€ä¹ˆæˆ‘åœ¨å®¹å™¨ä¸­ä¸èƒ½ kill 1 å·è¿›ç¨‹?".')]),s._v(" "),t("p",[s._v("æƒ³è¦è§£å†³è¿™ä¸ªé—®é¢˜, éœ€è¦æŒæ¡ä¸¤ä¸ªåŸºæœ¬æ¦‚å¿µ.")]),s._v(" "),t("p",[s._v("ç¬¬ä¸€ä¸ªæ¦‚å¿µæ˜¯ Linux 1 å·è¿›ç¨‹. **å®ƒæ˜¯ç¬¬ä¸€ä¸ªç”¨æˆ·æ€çš„è¿›ç¨‹. å®ƒç›´æ¥æˆ–è€…é—´æ¥åˆ›å»ºäº† Namespace ä¸­çš„å…¶ä»–è¿›ç¨‹. **")]),s._v(" "),t("p",[s._v("ç¬¬äºŒä¸ªæ¦‚å¿µæ˜¯ Linux ä¿¡å·. Linux æœ‰ 31 ä¸ªåŸºæœ¬ä¿¡å·, è¿›ç¨‹åœ¨å¤„ç†å¤§éƒ¨åˆ†ä¿¡å·æ—¶æœ‰ä¸‰ä¸ªé€‰æ‹©: **å¿½ç•¥, æ•è·å’Œç¼ºçœè¡Œä¸º. å…¶ä¸­ä¸¤ä¸ªç‰¹æƒä¿¡å· SIGKILL å’Œ SIGSTOP ä¸èƒ½è¢«å¿½ç•¥æˆ–è€…æ•è·. **")]),s._v(" "),t("p",[s._v("åªçŸ¥é“åŸºæœ¬æ¦‚å¿µè¿˜ä¸è¡Œ, è¿˜è¦å»è§£å†³é—®é¢˜. æœ¬èŠ‚å°è¯•äº†ç”¨ bash, C è¯­è¨€è¿˜æœ‰ Golang ç¨‹åºä½œä¸ºå®¹å™¨ init è¿›ç¨‹, å‘ç°å®ƒä»¬å¯¹ kill 1 çš„ååº”æ˜¯ä¸åŒçš„. å› ä¸ºä¿¡å·çš„æœ€ç»ˆå¤„ç†éƒ½æ˜¯åœ¨ Linux å†…æ ¸ä¸­è¿›è¡Œçš„, å› æ­¤éœ€è¦å¯¹ Linux å†…æ ¸ä»£ç è¿›è¡Œåˆ†æ.")]),s._v(" "),t("p",[s._v("å®¹å™¨é‡Œ 1 å·è¿›ç¨‹å¯¹ä¿¡å·å¤„ç†çš„ä¸¤ä¸ªè¦ç‚¹, è¿™ä¹Ÿæ˜¯è¿™ä¸€è®²é‡Œéœ€è¦è®°ä½çš„ä¸¤å¥è¯:")]),s._v(" "),t("ul",[t("li",[s._v("**åœ¨å®¹å™¨ä¸­, 1 å·è¿›ç¨‹æ°¸è¿œä¸ä¼šå“åº” SIGKILL å’Œ SIGSTOP è¿™ä¸¤ä¸ªç‰¹æƒä¿¡å·; **")]),s._v(" "),t("li",[s._v("**å¯¹äºå…¶ä»–çš„ä¿¡å·, å¦‚æœç”¨æˆ·è‡ªå·±æ³¨å†Œäº† handler, 1 å·è¿›ç¨‹å¯ä»¥å“åº”. **")])]),s._v(" "),t("h4",{attrs:{id:"_03-ç†è§£è¿›ç¨‹-2-ä¸ºä»€ä¹ˆæˆ‘çš„å®¹å™¨é‡Œæœ‰è¿™ä¹ˆå¤šåƒµå°¸è¿›ç¨‹"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_03-ç†è§£è¿›ç¨‹-2-ä¸ºä»€ä¹ˆæˆ‘çš„å®¹å™¨é‡Œæœ‰è¿™ä¹ˆå¤šåƒµå°¸è¿›ç¨‹"}},[s._v("#")]),s._v(" 03ï½œç†è§£è¿›ç¨‹(2):ä¸ºä»€ä¹ˆæˆ‘çš„å®¹å™¨é‡Œæœ‰è¿™ä¹ˆå¤šåƒµå°¸è¿›ç¨‹?")]),s._v(" "),t("p",[s._v("æœ¬èŠ‚æ¥çœ‹çœ‹å®¹å™¨é‡Œä¸ºä»€ä¹ˆä¼šäº§ç”Ÿåƒµå°¸è¿›ç¨‹, ç„¶åå»åˆ†æå¦‚ä½•æ€ä¹ˆè§£å†³. é€šè¿‡è¿™ä¸€è®², ä½ å°±ä¼šå¯¹åƒµå°¸è¿›ç¨‹çš„äº§ç”ŸåŸç†æœ‰ä¸€ä¸ªæ¸…æ™°çš„è®¤è¯†, ä¹Ÿä¼šæ›´æ·±å…¥åœ°ç†è§£å®¹å™¨ init è¿›ç¨‹çš„ç‰¹æ€§.")]),s._v(" "),t("h5",{attrs:{id:"_1-é—®é¢˜å†ç°-2"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-é—®é¢˜å†ç°-2"}},[s._v("#")]),s._v(" 1.é—®é¢˜å†ç°")]),s._v(" "),t("p",[s._v("å¹³æ—¶ç”¨å®¹å™¨çš„æ—¶å€™, æœ‰çš„äººä¼šå‘ç°, è‡ªå·±çš„å®¹å™¨è¿è¡Œä¹…äº†ä¹‹å, è¿è¡Œ ps å‘½ä»¤ä¼šçœ‹åˆ°ä¸€äº›è¿›ç¨‹, è¿›ç¨‹ååé¢åŠ äº† "),t("code",[s._v("<defunct>")]),s._v("â€‹ æ ‡è¯†. é‚£ä¹ˆä½ è‡ªç„¶ä¼šæœ‰è¿™æ ·çš„ç–‘é—®, è¿™äº›æ˜¯ä»€ä¹ˆè¿›ç¨‹?")]),s._v(" "),t("p",[s._v("å¯ä»¥è‡ªå·±åšä¸ªå®¹å™¨é•œåƒæ¥æ¨¡æ‹Ÿä¸€ä¸‹, å…ˆä¸‹è½½è¿™ä¸ªä¾‹å­, è¿è¡Œ "),t("code",[s._v("make image")]),s._v("â€‹ ä¹‹å, å†å¯åŠ¨å®¹å™¨. åœ¨å®¹å™¨é‡Œå¯ä»¥çœ‹åˆ°, 1 å·è¿›ç¨‹ fork å‡º 1000 ä¸ªå­è¿›ç¨‹. å½“è¿™äº›å­è¿›ç¨‹"),t("strong",[s._v("è¿è¡Œç»“æŸ")]),s._v("å, å®ƒä»¬çš„è¿›ç¨‹åå­—åé¢éƒ½åŠ äº†æ ‡è¯†.")]),s._v(" "),t("p",[s._v("ä»å®ƒä»¬çš„ "),t("strong",[s._v("Z stat(è¿›ç¨‹çŠ¶æ€)")]),s._v(" ä¸­å¯ä»¥çŸ¥é“, è¿™äº›éƒ½æ˜¯"),t("strong",[s._v("åƒµå°¸è¿›ç¨‹")]),s._v("(Zombie Process). è¿è¡Œ top å‘½ä»¤, ä¹Ÿå¯ä»¥çœ‹åˆ°è¾“å‡ºçš„å†…å®¹æ˜¾ç¤ºæœ‰ "),t("code",[s._v("1000 zombie")]),s._v("â€‹ è¿›ç¨‹.")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# docker run --name zombie-proc -d registry/zombie-proc:v1")]),s._v("\n02dec161a9e8b18922bd3599b922dbd087a2ad60c9b34afccde7c91a463bde8a\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# docker exec -it zombie-proc bash")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ps aux")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token environment constant"}},[s._v("USER")]),s._v("       PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND\nroot         "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.0")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.0")]),s._v("   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("4324")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1436")]),s._v(" ?        Ss   01:23   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(":00 /app-test "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1000")]),s._v("\nroot         "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("6")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.0")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.0")]),s._v("      "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("     "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" ?        Z    01:23   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(":00 "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("app-test"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("defunct"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\nroot         "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("7")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.0")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.0")]),s._v("      "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("     "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" ?        Z    01:23   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(":00 "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("app-test"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("defunct"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\nroot         "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("8")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.0")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.0")]),s._v("      "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("     "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" ?        Z    01:23   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(":00 "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("app-test"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("defunct"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\nroot         "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("9")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.0")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.0")]),s._v("      "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("     "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" ?        Z    01:23   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(":00 "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("app-test"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("defunct"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\nroot        "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.0")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.0")]),s._v("      "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("     "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" ?        Z    01:23   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(":00 "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("app-test"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("defunct"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\nâ€¦\nroot       "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("999")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.0")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.0")]),s._v("      "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("     "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" ?        Z    01:23   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(":00 "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("app-test"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("defunct"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\nroot      "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1000")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.0")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.0")]),s._v("      "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("     "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" ?        Z    01:23   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(":00 "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("app-test"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("defunct"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\nroot      "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1001")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.0")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.0")]),s._v("      "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("     "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" ?        Z    01:23   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(":00 "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("app-test"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("defunct"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\nroot      "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1002")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.0")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.0")]),s._v("      "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("     "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" ?        Z    01:23   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(":00 "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("app-test"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("defunct"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\nroot      "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1003")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.0")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.0")]),s._v("      "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("     "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" ?        Z    01:23   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(":00 "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("app-test"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("defunct"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\nroot      "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1004")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.0")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.0")]),s._v("      "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("     "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" ?        Z    01:23   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(":00 "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("app-test"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("defunct"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\nroot      "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1005")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.0")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.0")]),s._v("      "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("     "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" ?        Z    01:23   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(":00 "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("app-test"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("defunct"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\nroot      "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1023")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.0")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.0")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("12020")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("3392")]),s._v(" pts/0    Ss   01:39   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(":00 "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("bash")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# top")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("top")]),s._v(" - 02:18:57 up "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("31")]),s._v(" days, "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("15")]),s._v(":17,  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" users,  load average: "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.00")]),s._v(", "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.01")]),s._v(", "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.00")]),s._v("\nTasks: "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1003")]),s._v(" total,   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" running,   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" sleeping,   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" stopped, "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1000")]),s._v(" zombie\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br")])]),t("p",[s._v("é‚£ä¹ˆé—®é¢˜æ¥äº†, ä»€ä¹ˆæ˜¯åƒµå°¸è¿›ç¨‹? å®ƒä»¬æ˜¯æ€ä¹ˆäº§ç”Ÿçš„? åƒµå°¸è¿›ç¨‹å¤ªå¤šä¼šå¯¼è‡´ä»€ä¹ˆé—®é¢˜? æƒ³è¦å›ç­”è¿™äº›é—®é¢˜, å°±è¦ä»è¿›ç¨‹çŠ¶æ€çš„æºå¤´å­¦ä¹ , çœ‹çœ‹"),t("strong",[s._v("åƒµå°¸è¿›ç¨‹åˆ°åº•å¤„äºè¿›ç¨‹æ•´ä¸ªç”Ÿå‘½å‘¨æœŸé‡Œçš„å“ªä¸€ç¯")]),s._v(".")]),s._v(" "),t("h5",{attrs:{id:"_2-çŸ¥è¯†è¯¦è§£-2"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-çŸ¥è¯†è¯¦è§£-2"}},[s._v("#")]),s._v(" 2.çŸ¥è¯†è¯¦è§£")]),s._v(" "),t("h6",{attrs:{id:"_1-linuxçš„è¿›ç¨‹çŠ¶æ€"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-linuxçš„è¿›ç¨‹çŠ¶æ€"}},[s._v("#")]),s._v(" (1)Linuxçš„è¿›ç¨‹çŠ¶æ€")]),s._v(" "),t("p",[s._v("æ— è®ºè¿›ç¨‹è¿˜æ˜¯çº¿ç¨‹, åœ¨ Linux å†…æ ¸é‡Œå…¶å®éƒ½æ˜¯ç”¨ "),t("mark",[t("strong",[s._v("task_struct{}")])]),s._v("â€‹ ** è¿™ä¸ªç»“æ„"),t("strong",[s._v("æ¥è¡¨ç¤ºçš„. å®ƒå…¶å®å°±æ˜¯")]),s._v("ä»»åŠ¡(task), ä¹Ÿå°±æ˜¯ Linux é‡ŒåŸºæœ¬çš„è°ƒåº¦å•ä½**. ä¸ºäº†æ–¹ä¾¿è®²è§£, åœ¨è¿™é‡Œæš‚ä¸”ç§°å®ƒä¸ºè¿›ç¨‹.")]),s._v(" "),t("p",[s._v("é‚£ä¸€ä¸ªè¿›ç¨‹ä»åˆ›å»º(fork)åˆ°é€€å‡º(exit), è¿™ä¸ªè¿‡ç¨‹ä¸­çš„çŠ¶æ€è½¬åŒ–è¿˜æ˜¯å¾ˆç®€å•çš„.")]),s._v(" "),t("p",[s._v('ä¸‹é¢è¿™ä¸ªå›¾æ˜¯ã€ŠLinux Kernel Developmentã€‹è¿™æœ¬ä¹¦é‡Œçš„ Linux è¿›ç¨‹çŠ¶æ€è½¬åŒ–å›¾. ä»è¿™å¼ å›¾ä¸­å¯ä»¥çœ‹å‡ºæ¥, åœ¨è¿›ç¨‹ "æ´»ç€" çš„æ—¶å€™å°±åªæœ‰ä¸¤ä¸ªçŠ¶æ€: '),t("strong",[s._v("è¿è¡Œæ€")]),s._v("(TASK_RUNNING)å’Œ"),t("strong",[s._v("ç¡çœ æ€")]),s._v("(TASK_INTERRUPTIBLE, TASK_UNINTERRUPTIBLE).")]),s._v(" "),t("p",[t("img",{attrs:{src:"/img/19ff7857b6ab8570f638ed5378840ec3-20230731161430-gcgqu3u.png",alt:""}})]),s._v(" "),t("p",[s._v("é‚£è¿è¡Œæ€å’Œç¡çœ æ€è¿™ä¸¤ç§çŠ¶æ€åˆ†åˆ«æ˜¯ä»€ä¹ˆæ„æ€å‘¢?")]),s._v(" "),t("p",[t("strong",[s._v("è¿è¡Œæ€")]),s._v("çš„æ„æ€æ˜¯, æ— è®ºè¿›ç¨‹æ˜¯æ­£åœ¨è¿è¡Œä¸­(ä¹Ÿå°±æ˜¯è·å¾—äº† CPU èµ„æº), è¿˜æ˜¯è¿›ç¨‹åœ¨ run queue é˜Ÿåˆ—é‡Œéšæ—¶å¯ä»¥è¿è¡Œ, éƒ½å¤„äºè¿™ä¸ªçŠ¶æ€. æƒ³è¦æŸ¥çœ‹è¿›ç¨‹æ˜¯ä¸æ˜¯å¤„äºè¿è¡Œæ€, å…¶å®ä¹Ÿå¾ˆç®€å•, æ¯”å¦‚ä½¿ç”¨ ps å‘½ä»¤, å¯ä»¥çœ‹åˆ°å¤„äºè¿™ä¸ª"),t("strong",[s._v("çŠ¶æ€çš„è¿›ç¨‹æ˜¾ç¤ºçš„æ˜¯ R stat")]),s._v(".")]),s._v(" "),t("p",[t("strong",[s._v("ç¡çœ æ€")]),s._v("æ˜¯æŒ‡è¿›ç¨‹éœ€è¦ç­‰å¾…æŸä¸ªèµ„æºè€Œè¿›å…¥çš„çŠ¶æ€, è¦ç­‰å¾…çš„èµ„æºå¯ä»¥æ˜¯ä¸€ä¸ªä¿¡å·é‡(Semaphore), æˆ–è€…æ˜¯ç£ç›˜ I/O, è¿™ä¸ªçŠ¶æ€çš„è¿›ç¨‹ä¼šè¢«æ”¾å…¥åˆ° wait queue é˜Ÿåˆ—é‡Œ. è¿™ä¸ªç¡çœ æ€å…·ä½“è¿˜åŒ…æ‹¬ä¸¤ä¸ªå­çŠ¶æ€: ä¸€ä¸ªæ˜¯"),t("strong",[s._v("å¯ä»¥è¢«æ‰“æ–­")]),s._v("çš„(TASK_INTERRUPTIBLE), ç”¨ ps æŸ¥çœ‹åˆ°çš„è¿›ç¨‹, æ˜¾ç¤ºä¸º "),t("strong",[s._v("S stat")]),s._v(". è¿˜æœ‰ä¸€ä¸ªæ˜¯"),t("strong",[s._v("ä¸å¯è¢«æ‰“æ–­")]),s._v("çš„(TASK_UNINTERRUPTIBLE), ç”¨ ps æŸ¥çœ‹è¿›ç¨‹, å°±æ˜¾ç¤ºä¸º "),t("strong",[s._v("D stat")]),s._v(".")]),s._v(" "),t("p",[s._v("è¿™ä¸¤ä¸ªå­çŠ¶æ€, åœ¨åé¢çš„è¯¾ç¨‹é‡Œç¢°åˆ°æ–°çš„é—®é¢˜æ—¶, ä¼šå†åšè¯¦ç»†ä»‹ç», è¿™é‡Œåªè¦çŸ¥é“è¿™äº›å°±è¡Œäº†.")]),s._v(" "),t("p",[s._v("é™¤äº†ä¸Šé¢è¿›ç¨‹åœ¨æ´»çš„æ—¶å€™çš„ä¸¤ä¸ªçŠ¶æ€, è¿›ç¨‹åœ¨è°ƒç”¨ "),t("strong",[s._v("do_exit")]),s._v("() é€€å‡ºçš„æ—¶å€™, è¿˜æœ‰ä¸¤ä¸ªçŠ¶æ€.")]),s._v(" "),t("p",[s._v("ä¸€ä¸ªæ˜¯ "),t("strong",[s._v("EXIT_DEAD")]),s._v(", ä¹Ÿå°±æ˜¯è¿›ç¨‹åœ¨çœŸæ­£ç»“æŸé€€å‡ºçš„é‚£ä¸€ç¬é—´çš„çŠ¶æ€; ç¬¬äºŒä¸ªæ˜¯ "),t("mark",[t("strong",[s._v("EXIT_ZOMBIE çŠ¶æ€, è¿™æ˜¯è¿›ç¨‹åœ¨ EXIT_DEAD å‰çš„ä¸€ä¸ªçŠ¶æ€, è€Œåƒµå°¸è¿›ç¨‹å°±æ˜¯å¤„äºè¿™ä¸ªçŠ¶æ€ä¸­")])]),s._v("â€‹ **. **")]),s._v(" "),t("h6",{attrs:{id:"_2-é™åˆ¶å®¹å™¨ä¸­è¿›ç¨‹æ•°ç›®"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-é™åˆ¶å®¹å™¨ä¸­è¿›ç¨‹æ•°ç›®"}},[s._v("#")]),s._v(" (2)é™åˆ¶å®¹å™¨ä¸­è¿›ç¨‹æ•°ç›®")]),s._v(" "),t("p",[s._v("ç†è§£äº† Linux è¿›ç¨‹çŠ¶æ€ä¹‹å, è¿˜éœ€è¦çŸ¥é“, åœ¨ Linux ç³»ç»Ÿä¸­"),t("strong",[s._v("æ€ä¹ˆé™åˆ¶è¿›ç¨‹æ•°ç›®")]),s._v(". å› ä¸ºå¼„æ¸…æ¥šè¿™ä¸ªé—®é¢˜, æ‰èƒ½æ›´æ·±å…¥åœ°å»ç†è§£åƒµå°¸è¿›ç¨‹çš„å±å®³.")]),s._v(" "),t("p",[s._v("ä¸€å° Linux æœºå™¨ä¸Šçš„"),t("strong",[s._v("è¿›ç¨‹æ€»æ•°ç›®æ˜¯æœ‰é™åˆ¶")]),s._v("çš„. å¦‚æœè¶…è¿‡è¿™ä¸ªæœ€å¤§å€¼, é‚£ä¹ˆç³»ç»Ÿå°±æ— æ³•åˆ›å»ºå‡ºæ–°çš„è¿›ç¨‹äº†, æ¯”å¦‚æƒ³ SSH ç™»å½•åˆ°è¿™å°æœºå™¨ä¸Šå°±ä¸è¡Œäº†. è¿™ä¸ªæœ€å¤§å€¼å¯ä»¥åœ¨  "),t("strong",[s._v("/proc/sys/kernel/pid_max")]),s._v(" è¿™ä¸ªå‚æ•°ä¸­çœ‹åˆ°.")]),s._v(" "),t("p",[s._v("Linux å†…æ ¸åœ¨åˆå§‹åŒ–ç³»ç»Ÿçš„æ—¶å€™, ä¼šæ ¹æ®æœºå™¨ CPU çš„æ•°ç›®æ¥è®¾ç½® pid_max çš„å€¼. æ¯”å¦‚å¦‚æœæœºå™¨ä¸­ CPU æ•°ç›®å°äºç­‰äº 32, é‚£ä¹ˆ pid_max å°±ä¼šè¢«è®¾ç½®ä¸º "),t("strong",[s._v("32768")]),s._v("(32K); å¦‚æœæœºå™¨ä¸­çš„ CPU æ•°ç›®å¤§äº 32, é‚£ä¹ˆ pid_max å°±è¢«è®¾ç½®ä¸º "),t("strong",[s._v("N*1204")]),s._v(" (N å°±æ˜¯ CPU æ•°ç›®).")]),s._v(" "),t("p",[s._v("å¯¹äº Linux ç³»ç»Ÿè€Œè¨€, "),t("strong",[s._v("å®¹å™¨å°±æ˜¯ä¸€ç»„è¿›ç¨‹çš„é›†åˆ. å¦‚æœå®¹å™¨ä¸­çš„åº”ç”¨åˆ›å»ºè¿‡å¤šçš„è¿›ç¨‹æˆ–è€…å‡ºç° bug, å°±ä¼šäº§ç”Ÿç±»ä¼¼ fork bomb çš„è¡Œä¸º")]),s._v(". è¿™ä¸ª fork bomb å°±æ˜¯æŒ‡åœ¨è®¡ç®—æœºä¸­, é€šè¿‡ä¸æ–­å»ºç«‹æ–°è¿›ç¨‹æ¥æ¶ˆè€—ç³»ç»Ÿä¸­çš„è¿›ç¨‹èµ„æº, å®ƒæ˜¯ä¸€ç§é»‘å®¢æ”»å‡»æ–¹å¼. è¿™æ ·å®¹å™¨ä¸­çš„è¿›ç¨‹æ•°å°±ä¼šæŠŠæ•´ä¸ªèŠ‚ç‚¹çš„å¯ç”¨è¿›ç¨‹æ€»æ•°ç»™æ¶ˆè€—å®Œ. è¿™æ ·ä¸ä½†ä¼šä½¿åŒä¸€ä¸ªèŠ‚ç‚¹ä¸Šçš„å…¶ä»–å®¹å™¨æ— æ³•å·¥ä½œ, è¿˜ä¼šè®©"),t("strong",[s._v("å®¿ä¸»æœºæœ¬èº«")]),s._v("ä¹Ÿæ— æ³•å·¥ä½œ. æ‰€ä»¥"),t("mark",[t("strong",[s._v("å¯¹äºæ¯ä¸ªå®¹å™¨æ¥è¯´, éƒ½éœ€è¦é™åˆ¶å®ƒçš„æœ€å¤§è¿›ç¨‹æ•°ç›®, è€Œè¿™ä¸ªåŠŸèƒ½ç”± pids Cgroup è¿™ä¸ªå­ç³»ç»Ÿæ¥å®Œæˆ")])]),s._v(".")]),s._v(" "),t("p",[s._v("è€Œè¿™ä¸ªåŠŸèƒ½çš„å®ç°æ–¹æ³•æ˜¯è¿™æ ·çš„: "),t("mark",[t("strong",[s._v("pids Cgroup é€šè¿‡ Cgroup æ–‡ä»¶ç³»ç»Ÿçš„æ–¹å¼å‘ç”¨æˆ·æä¾›æ“ä½œæ¥å£, ä¸€èˆ¬å®ƒçš„ Cgroup æ–‡ä»¶ç³»ç»ŸæŒ‚è½½ç‚¹åœ¨ /sys/fs/cgroup/pids. åœ¨ä¸€ä¸ªå®¹å™¨å»ºç«‹ä¹‹å, åˆ›å»ºå®¹å™¨çš„æœåŠ¡ä¼šåœ¨ /sys/fs/cgroup/pids ä¸‹å»ºç«‹ä¸€ä¸ªå­ç›®å½•, å°±æ˜¯ä¸€ä¸ªæ§åˆ¶ç»„, æ§åˆ¶ç»„é‡Œæœ€å…³é”®çš„ä¸€ä¸ªæ–‡ä»¶å°±æ˜¯ pids.max. å¯ä»¥å‘è¿™ä¸ªæ–‡ä»¶å†™å…¥æ•°å€¼, è€Œè¿™ä¸ªå€¼å°±æ˜¯è¿™ä¸ªå®¹å™¨ä¸­å…è®¸çš„æœ€å¤§è¿›ç¨‹æ•°ç›®")])]),s._v("â€‹ "),t("strong",[s._v(".")])]),s._v(" "),t("p",[s._v("å¯¹è¿™ä¸ªå€¼åšå¥½é™åˆ¶, å®¹å™¨å°±ä¸ä¼šå› ä¸ºåˆ›å»ºå‡ºè¿‡å¤šè¿›ç¨‹è€Œå½±å“åˆ°å…¶ä»–å®¹å™¨å’Œå®¿ä¸»æœºäº†. æ¥ä¸‹æ¥å°±å®é™…ä¸Šæ‰‹è¯•ä¸€è¯•.")]),s._v(" "),t("p",[s._v("ä¸‹é¢æ˜¯å¯¹ä¸€ä¸ª Docker å®¹å™¨çš„ pids Cgroup çš„æ“ä½œ, å¯ä»¥è·Ÿç€æ“ä½œä¸€ä¸‹.")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# pwd")]),s._v("\n/sys/fs/cgroup/pids\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# df ./")]),s._v("\nFilesystem     1K-blocks  Used Available Use% Mounted on\ncgroup                 "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("     "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("         "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("    - /sys/fs/cgroup/pids\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# docker ps")]),s._v("\nCONTAINER ID        IMAGE                      COMMAND                  CREATED             STATUS              PORTS               NAMES\n7ecd3aa7fdc1        registry/zombie-proc:v1   "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/app-test 1000"')]),s._v("         "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("37")]),s._v(" hours ago        Up "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("37")]),s._v(" hours                             frosty_yalow\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# pwd")]),s._v("\n/sys/fs/cgroup/pids/system.slice/docker-7ecd3aa7fdc15a1e183813b1899d5d939beafb11833ad6c8b0432536e5b9871c.scope\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ls")]),s._v("\ncgroup.clone_children  cgroup.procs  notify_on_release  pids.current  pids.events  pids.max  tasks\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# echo 1002 > pids.max")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cat pids.max")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1002")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br")])]),t("p",[s._v("åœ¨å‰é¢ Linux è¿›ç¨‹çŠ¶æ€çš„ä»‹ç»å¯çŸ¥åƒµå°¸è¿›ç¨‹æ˜¯ Linux è¿›ç¨‹"),t("strong",[s._v("é€€å‡ºçŠ¶æ€")]),s._v("çš„ä¸€ç§. ä»å†…æ ¸è¿›ç¨‹çš„ do_exit() å‡½æ•°ä¹Ÿå¯ä»¥çœ‹åˆ°, è¿™æ—¶å€™"),t("strong",[s._v("è¿›ç¨‹ task_struct é‡Œçš„ mm/shm/sem/files ç­‰æ–‡ä»¶èµ„æºéƒ½å·²ç»é‡Šæ”¾äº†, åªç•™ä¸‹äº†ä¸€ä¸ª stask_struct instance ç©ºå£³")]),s._v(".")]),s._v(" "),t("p",[s._v("å°±åƒä¸‹é¢è¿™æ®µä»£ç æ˜¾ç¤ºçš„ä¸€æ ·, ä»è¿›ç¨‹å¯¹åº”çš„ "),t("code",[s._v("/proc/<pid>")]),s._v("â€‹ æ–‡ä»¶ç›®å½•ä¸‹, ä¹Ÿå¯ä»¥çœ‹å‡ºæ¥, å¯¹åº”çš„èµ„æºéƒ½å·²ç»æ²¡æœ‰äº†.")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cat /proc/6/cmdline")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cat /proc/6/smaps")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cat /proc/6/maps")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ls /proc/6/fd")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br")])]),t("p",[s._v("å¹¶ä¸”è¿™ä¸ªè¿›ç¨‹ä¹Ÿå·²ç»"),t("strong",[s._v("ä¸å“åº”ä»»ä½•çš„ä¿¡å·")]),s._v("äº†, æ— è®º SIGTERM(15) è¿˜æ˜¯ SIGKILL(9). ä¾‹å¦‚ä¸Šé¢ pid 6 çš„åƒµå°¸è¿›ç¨‹, è¿™ä¸¤ä¸ªä¿¡å·éƒ½å·²ç»è¢«å“åº”äº†.")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kill -15 6")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kill -9 6")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ps -ef | grep 6")]),s._v("\nroot         "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("6")]),s._v("     "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("13")]),s._v(":59 ?        00:00:00 "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("app-test"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("defunct"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br")])]),t("p",[s._v("å½“å¤šä¸ªå®¹å™¨è¿è¡Œåœ¨åŒä¸€ä¸ªå®¿ä¸»æœºä¸Šçš„æ—¶å€™, "),t("strong",[s._v("ä¸ºäº†é¿å…ä¸€ä¸ªå®¹å™¨æ¶ˆè€—å®Œæ•´ä¸ªå®¿ä¸»æœºè¿›ç¨‹å·èµ„æº, ä¼šé…ç½® pids Cgroup æ¥é™åˆ¶æ¯ä¸ªå®¹å™¨çš„æœ€å¤§è¿›ç¨‹æ•°ç›®")]),s._v(". ä¹Ÿå°±æ˜¯è¯´è¿›ç¨‹æ•°ç›®åœ¨æ¯ä¸ªå®¹å™¨ä¸­ä¹Ÿæ˜¯æœ‰é™çš„, æ˜¯ä¸€ç§å¾ˆå®è´µçš„èµ„æº.")]),s._v(" "),t("p",[s._v("æ—¢ç„¶è¿›ç¨‹å·èµ„æºåœ¨å®¿ä¸»æœºä¸Šæ˜¯æœ‰é™çš„, æ˜¾ç„¶æ®‹ç•™çš„åƒµå°¸è¿›ç¨‹å¤šäº†ä»¥å, ç»™ç³»ç»Ÿå¸¦æ¥æœ€å¤§é—®é¢˜å°±æ˜¯å®ƒå ç”¨äº†è¿›ç¨‹å·. "),t("mark",[t("strong",[s._v("è¿™å°±æ„å‘³ç€, æ®‹ç•™çš„åƒµå°¸è¿›ç¨‹åœ¨å®¹å™¨é‡Œä»ç„¶å æ®ç€è¿›ç¨‹å·èµ„æº, å¾ˆæœ‰å¯èƒ½ä¼šå¯¼è‡´æ–°çš„è¿›ç¨‹ä¸èƒ½è¿è½¬")])]),s._v(". ** **")]),s._v(" "),t("p",[s._v("è¿™é‡Œå†æ¬¡å€Ÿç”¨å¼€å¤´çš„é‚£ä¸ªä¾‹å­, ä¹Ÿå°±æ˜¯ä¸€ä¸ªäº§ç”Ÿäº† 1000 ä¸ªåƒµå°¸è¿›ç¨‹çš„å®¹å™¨, æ¥ç†è§£ä¸€ä¸‹è¿™ä¸ªä¾‹å­ä¸­è¿›ç¨‹æ•°çš„ä¸Šé™. è¿™é‡Œ 1 ä¸ª init è¿›ç¨‹ + 1000 ä¸ªåƒµå°¸è¿›ç¨‹ + 1 ä¸ª bash è¿›ç¨‹, æ€»å…±å°±æ˜¯ 1002 ä¸ªè¿›ç¨‹.")]),s._v(" "),t("p",[s._v("å¦‚æœ pids Cgroup ä¹Ÿé™åˆ¶äº†è¿™ä¸ªå®¹å™¨çš„æœ€å¤§è¿›ç¨‹å·çš„æ•°é‡, é™åˆ¶ä¸º 1002 çš„è¯, åœ¨ pids Cgroup é‡Œå¯ä»¥çœ‹åˆ°, "),t("code",[s._v("pids.current == pids.max")]),s._v("â€‹, ä¹Ÿå°±æ˜¯å·²ç»è¾¾åˆ°äº†å®¹å™¨è¿›ç¨‹å·æ•°çš„ä¸Šé™.")]),s._v(" "),t("p",[s._v("è¿™æ—¶å€™, å¦‚æœåœ¨å®¹å™¨é‡Œæƒ³å†å¯åŠ¨ä¸€ä¸ªè¿›ç¨‹, ä¾‹å¦‚è¿è¡Œä¸€ä¸‹ ls å‘½ä»¤, å°±ä¼šçœ‹åˆ° "),t("code",[s._v("Resource temporarily unavailable")]),s._v("â€‹ çš„é”™è¯¯æ¶ˆæ¯. å·²ç»é€€å‡ºçš„æ— ç”¨è¿›ç¨‹, å´é˜»ç¢äº†æœ‰ç”¨è¿›ç¨‹çš„å¯åŠ¨, æ˜¾ç„¶è¿™æ ·æ˜¯ä¸åˆç†çš„.")]),s._v(" "),t("p",[s._v("å…·ä½“ä»£ç å¦‚ä¸‹:")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("### On host")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# docker ps")]),s._v("\nCONTAINER ID        IMAGE                      COMMAND             CREATED             STATUS              PORTS               NAMES\n09e6e8e16346        registry/zombie-proc:v1   "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/app-test 1000"')]),s._v("    "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("29")]),s._v(" minutes ago      Up "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("29")]),s._v(" minutes                           peaceful_ritchie\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# pwd")]),s._v("\n/sys/fs/cgroup/pids/system.slice/docker-09e6e8e1634612580a03dd3496d2efed2cf2a510b9688160b414ce1d1ea3e4ae.scope\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cat pids.max")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1002")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cat pids.current")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1002")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("### On Container")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@09e6e8e16346 /"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ls")]),s._v("\nbash: fork: retry: Resource temporarily unavailable\nbash: fork: retry: Resource temporarily unavailable\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br")])]),t("p",[s._v("æ‰€ä»¥, æ¥ä¸‹æ¥è¿˜è¦çœ‹çœ‹è¿™äº›åƒµå°¸è¿›ç¨‹åˆ°åº•æ˜¯æ€ä¹ˆäº§ç”Ÿçš„. å› ä¸ºåªæœ‰ç†è§£å®ƒçš„äº§ç”Ÿæœºåˆ¶, æ‰èƒ½æƒ³æ˜ç™½æ€ä¹ˆé¿å…åƒµå°¸è¿›ç¨‹çš„å‡ºç°.")]),s._v(" "),t("p",[s._v("å…ˆçœ‹ä¸€ä¸‹åˆšæ‰æ¨¡æ‹Ÿåƒµå°¸è¿›ç¨‹çš„é‚£æ®µå°ç¨‹åº. è¿™æ®µç¨‹åºé‡Œ, "),t("mark",[t("strong",[s._v("çˆ¶è¿›ç¨‹åœ¨åˆ›å»ºå®Œå­è¿›ç¨‹ä¹‹åå°±ä¸ç®¡äº†, è¿™å°±æ˜¯é€ æˆå­è¿›ç¨‹å˜æˆåƒµå°¸è¿›ç¨‹çš„åŸå› ")])]),s._v("â€‹ **. **")]),s._v(" "),t("div",{staticClass:"language-c line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-c"}},[t("code",[t("span",{pre:!0,attrs:{class:"token macro property"}},[t("span",{pre:!0,attrs:{class:"token directive-hash"}},[s._v("#")]),t("span",{pre:!0,attrs:{class:"token directive keyword"}},[s._v("include")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("<stdio.h>")])]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token macro property"}},[t("span",{pre:!0,attrs:{class:"token directive-hash"}},[s._v("#")]),t("span",{pre:!0,attrs:{class:"token directive keyword"}},[s._v("include")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("<stdlib.h>")])]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token macro property"}},[t("span",{pre:!0,attrs:{class:"token directive-hash"}},[s._v("#")]),t("span",{pre:!0,attrs:{class:"token directive keyword"}},[s._v("include")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("<sys/types.h>")])]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token macro property"}},[t("span",{pre:!0,attrs:{class:"token directive-hash"}},[s._v("#")]),t("span",{pre:!0,attrs:{class:"token directive keyword"}},[s._v("include")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("<sys/wait.h>")])]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token macro property"}},[t("span",{pre:!0,attrs:{class:"token directive-hash"}},[s._v("#")]),t("span",{pre:!0,attrs:{class:"token directive keyword"}},[s._v("include")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("<unistd.h>")])]),s._v("\n \n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("main")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" argc"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("char")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("argv"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n       "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" i"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n       "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" total"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n       "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("argc "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n              total "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n       "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("else")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n              total "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("atoi")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("argv"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n       "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n       "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("printf")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"To create %d processes\\n"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" total"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n       "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("i "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" i "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v(" total"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" i"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("++")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n              "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("pid_t")]),s._v(" pid "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("fork")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n \n              "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("pid "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n                      "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("printf")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Child => PPID: %d PID: %d\\n"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("getppid")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n                             "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("getpid")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n                      "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("sleep")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("60")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n                      "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("printf")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Child process exits\\n"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n                      "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("exit")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("EXIT_SUCCESS"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n              "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("else")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("pid "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n                      "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("printf")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Parent created child %d\\n"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" i"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n              "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("else")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n                      "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("printf")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Unable to create child process. %d\\n"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" i"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n                      "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("break")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n              "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n       "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n       "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("printf")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Paraent is sleeping\\n"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n       "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("while")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n              "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("sleep")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("100")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n       "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n       "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" EXIT_SUCCESS"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br"),t("span",{staticClass:"line-number"},[s._v("25")]),t("br"),t("span",{staticClass:"line-number"},[s._v("26")]),t("br"),t("span",{staticClass:"line-number"},[s._v("27")]),t("br"),t("span",{staticClass:"line-number"},[s._v("28")]),t("br"),t("span",{staticClass:"line-number"},[s._v("29")]),t("br"),t("span",{staticClass:"line-number"},[s._v("30")]),t("br"),t("span",{staticClass:"line-number"},[s._v("31")]),t("br"),t("span",{staticClass:"line-number"},[s._v("32")]),t("br"),t("span",{staticClass:"line-number"},[s._v("33")]),t("br"),t("span",{staticClass:"line-number"},[s._v("34")]),t("br"),t("span",{staticClass:"line-number"},[s._v("35")]),t("br"),t("span",{staticClass:"line-number"},[s._v("36")]),t("br"),t("span",{staticClass:"line-number"},[s._v("37")]),t("br"),t("span",{staticClass:"line-number"},[s._v("38")]),t("br")])]),t("p",[s._v("å‰é¢é€šè¿‡åˆ†æ, å‘ç°"),t("strong",[s._v('å­è¿›ç¨‹å˜æˆåƒµå°¸è¿›ç¨‹çš„åŸå› åœ¨äºçˆ¶è¿›ç¨‹ "ä¸è´Ÿè´£"')]),s._v(" , é‚£æ‰¾åˆ°åŸå› å, å†æƒ³æƒ³å¦‚ä½•æ¥è§£å†³.")]),s._v(" "),t("p",[s._v('å…¶å®è§£å†³æ€è·¯å¾ˆå¥½ç†è§£, å°±å¥½åƒç†Šå­©å­çŠ¯äº†äº‹å„¿, è¦å»æ‰¾ä»–å®¶é•¿æ¥ç®¡æ•™, é‚£å­è¿›ç¨‹åœ¨å®¹å™¨é‡Œ "èµ–ç€ä¸èµ°", å°±éœ€è¦'),t("strong",[s._v("è®©çˆ¶è¿›ç¨‹å‡ºé¢å¤„ç†")]),s._v("äº†. æ‰€ä»¥, åœ¨ Linux ä¸­çš„è¿›ç¨‹é€€å‡ºä¹‹å, å¦‚æœ"),t("mark",[t("strong",[s._v("è¿›å…¥åƒµå°¸çŠ¶æ€, å°±éœ€è¦çˆ¶è¿›ç¨‹è°ƒç”¨ wait() è¿™ä¸ªç³»ç»Ÿè°ƒç”¨, å»å›æ”¶åƒµå°¸è¿›ç¨‹çš„æœ€åçš„é‚£äº›ç³»ç»Ÿèµ„æº, æ¯”å¦‚è¿›ç¨‹å·èµ„æº")])]),s._v(".")]),s._v(" "),t("p",[s._v("é‚£ä¹ˆåœ¨åˆšæ‰é‚£æ®µä»£ç é‡Œ, ä¸»è¿›ç¨‹è¿›å…¥ sleep(100) ä¹‹å‰, åŠ ä¸Š"),t("strong",[s._v("ä¸€æ®µ wait() å‡½æ•°è°ƒç”¨")]),s._v(", å°±"),t("strong",[s._v("ä¸ä¼šå‡ºç°åƒµå°¸è¿›ç¨‹")]),s._v("çš„æ®‹ç•™äº†.")]),s._v(" "),t("div",{staticClass:"language-c line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-c"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("i "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" i "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v(" total"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" i"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("++")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" status"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("wait")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&")]),s._v("status"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br")])]),t("p",[s._v("è€Œå®¹å™¨ä¸­æ‰€æœ‰è¿›ç¨‹çš„æœ€ç»ˆçˆ¶è¿›ç¨‹, å°±æ˜¯æ‰€è¯´çš„ init è¿›ç¨‹, ç”±å®ƒè´Ÿè´£ç”Ÿæˆå®¹å™¨ä¸­çš„æ‰€æœ‰å…¶ä»–è¿›ç¨‹. å› æ­¤"),t("strong",[s._v("å®¹å™¨çš„ init è¿›ç¨‹æœ‰è´£ä»»å›æ”¶å®¹å™¨ä¸­çš„æ‰€æœ‰åƒµå°¸è¿›ç¨‹")]),s._v(".")]),s._v(" "),t("p",[s._v("å‰é¢çŸ¥é“äº† wait() ç³»ç»Ÿè°ƒç”¨å¯ä»¥å›æ”¶åƒµå°¸è¿›ç¨‹, ä½†æ˜¯ wait() ç³»ç»Ÿè°ƒç”¨æœ‰ä¸€ä¸ªé—®é¢˜, éœ€è¦ä½ æ³¨æ„. "),t("strong",[s._v("wait() ç³»ç»Ÿè°ƒç”¨æ˜¯ä¸€ä¸ªé˜»å¡çš„è°ƒç”¨, ä¹Ÿå°±æ˜¯è¯´å¦‚æœæ²¡æœ‰å­è¿›ç¨‹æ˜¯åƒµå°¸è¿›ç¨‹çš„è¯, è¿™ä¸ªè°ƒç”¨å°±ä¸€ç›´ä¸ä¼šè¿”å›, é‚£ä¹ˆæ•´ä¸ªè¿›ç¨‹å°±ä¼šè¢«é˜»å¡ä½, è€Œä¸èƒ½å»åšåˆ«çš„äº‹äº†")]),s._v(".")]),s._v(" "),t("p",[s._v("ä¸è¿‡è¿™ä¹Ÿæ²¡æœ‰å…³ç³», è¿˜æœ‰å¦ä¸€ä¸ªæ–¹æ³•å¤„ç†. Linux è¿˜æä¾›äº†ä¸€ä¸ªç±»ä¼¼çš„ç³»ç»Ÿè°ƒç”¨ "),t("strong",[s._v("waitpid()")]),s._v(" , è¿™ä¸ªè°ƒç”¨çš„å‚æ•°æ›´å¤š. å…¶ä¸­å°±æœ‰ä¸€ä¸ªå‚æ•° WNOHANG, å®ƒçš„å«ä¹‰å°±æ˜¯, "),t("strong",[s._v("å¦‚æœåœ¨è°ƒç”¨çš„æ—¶å€™æ²¡æœ‰åƒµå°¸è¿›ç¨‹, é‚£ä¹ˆå‡½æ•°å°±é©¬ä¸Šè¿”å›äº†")]),s._v(", è€Œä¸ä¼šåƒ wait() è°ƒç”¨é‚£æ ·ä¸€ç›´ç­‰å¾…åœ¨é‚£é‡Œ.")]),s._v(" "),t("p",[s._v("æ¯”å¦‚ç¤¾åŒºçš„ä¸€ä¸ªå®¹å™¨ init é¡¹ç›® tini. åœ¨è¿™ä¸ªä¾‹å­ä¸­, å®ƒçš„ä¸»è¿›ç¨‹é‡Œ, å°±æ˜¯ä¸æ–­åœ¨è°ƒç”¨å¸¦ WNOHANG å‚æ•°çš„ waitpid(), é€šè¿‡è¿™ä¸ªæ–¹å¼"),t("strong",[s._v("æ¸…ç†å®¹å™¨ä¸­æ‰€æœ‰çš„åƒµå°¸è¿›ç¨‹")]),s._v(".")]),s._v(" "),t("div",{staticClass:"language-c line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-c"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("reap_zombies")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("const")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("pid_t")]),s._v(" child_pid"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("const")]),s._v(" child_exitcode_ptr"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("pid_t")]),s._v(" current_pid"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" current_status"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("while")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n                current_pid "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("waitpid")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&")]),s._v("current_status"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" WNOHANG"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n                "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("switch")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("current_pid"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n                        "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("case")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v("\n                                "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("errno "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),s._v(" ECHILD"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n                                        "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("PRINT_TRACE")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"No child to wait"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n                                        "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("break")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n                                "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br")])]),t("h5",{attrs:{id:"_3-é‡ç‚¹æ€»ç»“"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-é‡ç‚¹æ€»ç»“"}},[s._v("#")]),s._v(" 3.é‡ç‚¹æ€»ç»“")]),s._v(" "),t("p",[s._v("æœ¬èŠ‚è®¨è®ºçš„é—®é¢˜æ˜¯å®¹å™¨ä¸­çš„åƒµå°¸è¿›ç¨‹. é¦–å…ˆå…ˆç”¨ä»£ç æ¥æ¨¡æ‹Ÿäº†è¿™ä¸ªæƒ…å†µ, è¿˜åŸäº†åœ¨ä¸€ä¸ªå®¹å™¨ä¸­å¤§é‡çš„åƒµå°¸è¿›ç¨‹æ˜¯å¦‚ä½•äº§ç”Ÿçš„. ä¸ºäº†ç†è§£å®ƒçš„äº§ç”ŸåŸç†å’Œå±å®³, å…ˆè¦æŒæ¡ä¸¤ä¸ªçŸ¥è¯†ç‚¹:")]),s._v(" "),t("ol",[t("li",[s._v("**Linux è¿›ç¨‹çŠ¶æ€ä¸­, åƒµå°¸è¿›ç¨‹å¤„äº EXIT_ZOMBIE è¿™ä¸ªçŠ¶æ€; **")]),s._v(" "),t("li",[t("strong",[s._v("å®¹å™¨éœ€è¦å¯¹æœ€å¤§è¿›ç¨‹æ•°åšé™åˆ¶.")]),s._v("  å…·ä½“æ–¹æ³•æ˜¯å‘ Cgroup ä¸­ "),t("strong",[s._v("pids.max")]),s._v(" è¿™ä¸ªæ–‡ä»¶å†™å…¥æ•°å€¼(è¿™ä¸ªå€¼å°±æ˜¯è¿™ä¸ªå®¹å™¨ä¸­å…è®¸çš„æœ€å¤§è¿›ç¨‹æ•°ç›®).")])]),s._v(" "),t("p",[s._v("æŒæ¡äº†åŸºæœ¬æ¦‚å¿µä¹‹å, æ‰¾åˆ°äº†åƒµå°¸è¿›ç¨‹çš„äº§ç”ŸåŸå› å°±æ˜¯"),t("strong",[s._v("çˆ¶è¿›ç¨‹åœ¨åˆ›å»ºå®Œå­è¿›ç¨‹ä¹‹åå°±ä¸ç®¡äº†")]),s._v(". æ‰€ä»¥"),t("mark",[t("strong",[s._v("éœ€è¦çˆ¶è¿›ç¨‹è°ƒç”¨ wait() æˆ–è€… waitpid() ç³»ç»Ÿè°ƒç”¨æ¥é¿å…åƒµå°¸è¿›ç¨‹äº§ç”Ÿ")])]),s._v(".")]),s._v(" "),t("p",[s._v("æœ¬èŠ‚åªè¦è®°ä½ä¸‹é¢ä¸‰ä¸ªä¸»è¦çš„çŸ¥è¯†ç‚¹å°±å¯ä»¥äº†:")]),s._v(" "),t("ul",[t("li",[t("strong",[s._v("æ¯ä¸€ä¸ª Linux è¿›ç¨‹åœ¨é€€å‡ºçš„æ—¶å€™éƒ½ä¼šè¿›å…¥ä¸€ä¸ªåƒµå°¸çŠ¶æ€(EXIT_ZOMBIE);")])]),s._v(" "),t("li",[s._v("**åƒµå°¸è¿›ç¨‹å¦‚æœä¸æ¸…ç†, å°±ä¼šæ¶ˆè€—ç³»ç»Ÿä¸­çš„è¿›ç¨‹æ•°èµ„æº, æœ€åçš„æƒ…å†µæ˜¯å¯¼è‡´æ–°çš„è¿›ç¨‹æ— æ³•å¯åŠ¨; **")]),s._v(" "),t("li",[s._v("**åƒµå°¸è¿›ç¨‹ä¸€å®šéœ€è¦çˆ¶è¿›ç¨‹è°ƒç”¨ wait() æˆ–è€… waitpid() ç³»ç»Ÿè°ƒç”¨æ¥æ¸…ç†, è¿™ä¹Ÿæ˜¯å®¹å™¨ä¸­ init è¿›ç¨‹å¿…é¡»å…·å¤‡çš„ä¸€ä¸ªåŠŸèƒ½. **")])]),s._v(" "),t("h4",{attrs:{id:"_04-ç†è§£è¿›ç¨‹-3-ä¸ºä»€ä¹ˆæˆ‘åœ¨å®¹å™¨ä¸­çš„è¿›ç¨‹è¢«å¼ºåˆ¶æ€æ­»äº†"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_04-ç†è§£è¿›ç¨‹-3-ä¸ºä»€ä¹ˆæˆ‘åœ¨å®¹å™¨ä¸­çš„è¿›ç¨‹è¢«å¼ºåˆ¶æ€æ­»äº†"}},[s._v("#")]),s._v(" 04 | ç†è§£è¿›ç¨‹(3):ä¸ºä»€ä¹ˆæˆ‘åœ¨å®¹å™¨ä¸­çš„è¿›ç¨‹è¢«å¼ºåˆ¶æ€æ­»äº†?")]),s._v(" "),t("p",[s._v("æœ¬èŠ‚æ¥è®²å®¹å™¨ä¸­ init è¿›ç¨‹çš„æœ€åä¸€è®², ä¸ºä»€ä¹ˆå®¹å™¨ä¸­çš„è¿›ç¨‹è¢«å¼ºåˆ¶æ€æ­»äº†. ç†è§£äº†è¿™ä¸ªé—®é¢˜, èƒ½å¤Ÿå¸®åŠ©ä½ æ›´å¥½åœ°ç®¡ç†è¿›ç¨‹, è®©å®¹å™¨ä¸­çš„è¿›ç¨‹å¯ä»¥ "),t("strong",[s._v("graceful shutdown")]),s._v(". å…ˆè¯´è¯´ä¸ºä»€ä¹ˆè¿›ç¨‹ç®¡ç†ä¸­åšåˆ°è¿™ç‚¹å¾ˆé‡è¦. åœ¨å®é™…ç”Ÿäº§ç¯å¢ƒä¸­, æœ‰ä¸å°‘åº”ç”¨åœ¨é€€å‡ºçš„æ—¶å€™éœ€è¦åšä¸€äº›"),t("strong",[s._v("æ¸…ç†å·¥ä½œ")]),s._v(", æ¯”å¦‚æ¸…ç†ä¸€äº›è¿œç«¯çš„é“¾æ¥, æˆ–è€…æ˜¯æ¸…é™¤ä¸€äº›æœ¬åœ°çš„ä¸´æ—¶æ•°æ®. è¿™æ ·çš„æ¸…ç†å·¥ä½œ, å¯ä»¥å°½å¯èƒ½é¿å…è¿œç«¯æˆ–è€…æœ¬åœ°çš„é”™è¯¯å‘ç”Ÿ, æ¯”å¦‚å‡å°‘ä¸¢åŒ…ç­‰é—®é¢˜çš„å‡ºç°. è€Œè¿™äº›é€€å‡ºæ¸…ç†çš„å·¥ä½œ, é€šå¸¸æ˜¯åœ¨ SIGTERM è¿™ä¸ªä¿¡å·ç”¨æˆ·æ³¨å†Œçš„ handler é‡Œè¿›è¡Œçš„.")]),s._v(" "),t("p",[s._v("ä½†æ˜¯å¦‚æœ"),t("strong",[s._v("è¿›ç¨‹æ”¶åˆ°äº† SIGKILL, é‚£åº”ç”¨ç¨‹åºå°±æ²¡æœºä¼šæ‰§è¡Œè¿™äº›æ¸…ç†å·¥ä½œ")]),s._v("äº†. è¿™å°±æ„å‘³ç€, ä¸€æ—¦è¿›ç¨‹ä¸èƒ½ graceful shutdown, å°±ä¼šå¢åŠ åº”ç”¨çš„å‡ºé”™ç‡.")]),s._v(" "),t("p",[s._v("æ‰€ä»¥æ¥ä¸‹æ¥æ¥é‡ç°ä¸€ä¸‹, è¿›ç¨‹åœ¨å®¹å™¨é€€å‡ºæ—¶éƒ½å‘ç”Ÿäº†ä»€ä¹ˆ.")]),s._v(" "),t("h5",{attrs:{id:"_1-åœºæ™¯å†ç°"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-åœºæ™¯å†ç°"}},[s._v("#")]),s._v(" 1.åœºæ™¯å†ç°")]),s._v(" "),t("p",[s._v("åœ¨å®¹å™¨å¹³å°ä¸Š, æƒ³è¦åœæ­¢ä¸€ä¸ªå®¹å™¨, æ— è®ºæ˜¯åœ¨ Kubernetes ä¸­å»åˆ é™¤ä¸€ä¸ª pod, æˆ–è€…ç”¨ Docker åœæ­¢ä¸€ä¸ªå®¹å™¨, æœ€åéƒ½ä¼šç”¨åˆ° "),t("strong",[s._v("Containerd")]),s._v(" è¿™ä¸ªæœåŠ¡. è€Œ Containerd åœ¨åœæ­¢å®¹å™¨çš„æ—¶å€™, "),t("strong",[s._v("å°±ä¼šå‘å®¹å™¨çš„ init è¿›ç¨‹å‘é€ä¸€ä¸ª SIGTERM ä¿¡å·")]),s._v(".")]),s._v(" "),t("p",[s._v("å¯ä»¥å‘ç°, åœ¨ init è¿›ç¨‹é€€å‡ºä¹‹å, å®¹å™¨å†…çš„å…¶ä»–è¿›ç¨‹ä¹Ÿéƒ½ç«‹åˆ»é€€å‡ºäº†. ä¸è¿‡ä¸åŒçš„æ˜¯, "),t("mark",[t("strong",[s._v("init è¿›ç¨‹æ”¶åˆ°çš„æ˜¯ SIGTERM ä¿¡å·, è€Œå…¶ä»–è¿›ç¨‹æ”¶åˆ°çš„æ˜¯ SIGKILL ä¿¡å·")])]),s._v(". å‰é¢æåˆ°è¿‡ SIGKILL ä¿¡å·æ˜¯"),t("strong",[s._v("ä¸èƒ½è¢«æ•è·")]),s._v("çš„(catch)çš„, ä¹Ÿå°±æ˜¯ç”¨æˆ·ä¸èƒ½æ³¨å†Œè‡ªå·±çš„ handler, è€Œ SIGTERM ä¿¡å·å´å…è®¸ç”¨æˆ·æ³¨å†Œè‡ªå·±çš„ handler, è¿™æ ·çš„è¯å·®åˆ«å°±å¾ˆå¤§äº†.")]),s._v(" "),t("p",[s._v("é‚£ä¹ˆå°±"),t("strong",[s._v("çœ‹çœ‹å½“å®¹å™¨é€€å‡ºçš„æ—¶å€™, å¦‚ä½•æ‰èƒ½è®©å®¹å™¨ä¸­çš„è¿›ç¨‹éƒ½æ”¶åˆ° SIGTERM ä¿¡å·, è€Œä¸æ˜¯ SIGKILL ä¿¡å·")]),s._v(".")]),s._v(" "),t("p",[s._v("å»¶ç»­å‰é¢å¤„ç†é—®é¢˜çš„æ€è·¯, åŒæ ·å¯ä»¥è¿è¡Œä¸€ä¸ªç®€å•çš„å®¹å™¨, æ¥é‡ç°è¿™ä¸ªé—®é¢˜, ç”¨è¿™é‡Œçš„ä»£ç æ‰§è¡Œä¸€ä¸‹ "),t("code",[s._v("make image")]),s._v("â€‹, ç„¶åç”¨ Docker å¯åŠ¨è¿™ä¸ªå®¹å™¨é•œåƒ.")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" run "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-d")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--name")]),s._v(" fwd_sig registry/fwd_sig:v1 /c-init-sig\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("ä½ ä¼šå‘ç°, åœ¨ç”¨ "),t("code",[s._v("docker stop")]),s._v("â€‹ åœæ­¢è¿™ä¸ªå®¹å™¨çš„æ—¶å€™, å¦‚æœç”¨ "),t("strong",[s._v("strace")]),s._v(" å·¥å…·æ¥ç›‘æ§, å°±èƒ½çœ‹åˆ°å®¹å™¨é‡Œçš„ init è¿›ç¨‹å’Œå¦å¤–ä¸€ä¸ªè¿›ç¨‹æ”¶åˆ°çš„ä¿¡å·æƒ…å†µ.")]),s._v(" "),t("p",[s._v("åœ¨ä¸‹é¢çš„ä¾‹å­é‡Œ, è¿›ç¨‹å·ä¸º 15909 çš„å°±æ˜¯å®¹å™¨é‡Œçš„ init è¿›ç¨‹, è€Œè¿›ç¨‹å·ä¸º 15959 çš„æ˜¯å®¹å™¨é‡Œå¦å¤–ä¸€ä¸ªè¿›ç¨‹.")]),s._v(" "),t("p",[s._v("åœ¨å‘½ä»¤è¾“å‡ºä¸­å¯ä»¥çœ‹åˆ°, **init è¿›ç¨‹(15909)æ”¶åˆ°çš„æ˜¯ SIGTERM ä¿¡å·, è€Œå¦å¤–ä¸€ä¸ªè¿›ç¨‹(15959)æ”¶åˆ°çš„æœç„¶æ˜¯ SIGKILL ä¿¡å·. **")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ps -ef | grep c-init-sig")]),s._v("\nroot     "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("15857")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("14391")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" 06:23 pts/0    00:00:00 "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" run "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-it")]),s._v(" registry/fwd_sig:v1 /c-init-sig\nroot     "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("15909")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("15879")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" 06:23 pts/0    00:00:00 /c-init-sig\nroot     "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("15959")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("15909")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" 06:23 pts/0    00:00:00 /c-init-sig\nroot     "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("16046")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("14607")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" 06:23 pts/3    00:00:00 "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("grep")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--color")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("auto c-init-sig\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# strace -p 15909")]),s._v("\nstrace: Process "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("15909")]),s._v(" attached\nrestart_syscall"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(". resuming interrupted "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("read")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v("."),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" ? ERESTART_RESTARTBLOCK "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("Interrupted by signal"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n--- SIGTERM "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("si_signo"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("SIGTERM, "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("si_code")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("SI_USER, "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("si_pid")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(", "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("si_uid")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" ---\nwrite"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(", "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"received SIGTERM'),t("span",{pre:!0,attrs:{class:"token entity",title:"\\n"}},[s._v("\\n")]),s._v('"')]),s._v(", "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("17")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("      "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("17")]),s._v("\nexit_group"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("                           "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" ?\n+++ exited with "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" +++\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# strace -p 15959")]),s._v("\nstrace: Process "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("15959")]),s._v(" attached\nrestart_syscall"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(". resuming interrupted "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("read")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v("."),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" ?\n+++ killed by SIGKILL +++\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br")])]),t("h5",{attrs:{id:"_2-çŸ¥è¯†è¯¦è§£-ä¿¡å·çš„ä¸¤ä¸ªç³»ç»Ÿè°ƒç”¨"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-çŸ¥è¯†è¯¦è§£-ä¿¡å·çš„ä¸¤ä¸ªç³»ç»Ÿè°ƒç”¨"}},[s._v("#")]),s._v(" 2.çŸ¥è¯†è¯¦è§£:ä¿¡å·çš„ä¸¤ä¸ªç³»ç»Ÿè°ƒç”¨")]),s._v(" "),t("p",[s._v("æƒ³è¦ç†è§£åˆšæ‰çš„ä¾‹å­, å°±éœ€è¦ææ‡‚ä¿¡å·èƒŒåçš„ä¸¤ä¸ªç³»ç»Ÿè°ƒç”¨, å®ƒä»¬åˆ†åˆ«æ˜¯ "),t("strong",[s._v("kill() ç³»ç»Ÿè°ƒç”¨å’Œ signal() ç³»ç»Ÿè°ƒç”¨")]),s._v(".")]),s._v(" "),t("p",[s._v("è¿™é‡Œå¯ä»¥ç»“åˆå‰é¢è®²è¿‡çš„ä¿¡å·æ¥ç†è§£è¿™ä¸¤ä¸ªç³»ç»Ÿè°ƒç”¨. åœ¨å®¹å™¨ init è¿›ç¨‹çš„ç¬¬ä¸€è®²é‡Œä»‹ç»è¿‡ä¿¡å·çš„åŸºæœ¬æ¦‚å¿µäº†, **ä¿¡å·å°±æ˜¯ Linux è¿›ç¨‹æ”¶åˆ°çš„ä¸€ä¸ªé€šçŸ¥. ** æœ¬èŠ‚è¿˜ä¼šå†ä¸¾ä¸ªä½¿ç”¨å‡½æ•°çš„ä¾‹å­, å¸®åŠ©ä½ è¿›ä¸€æ­¥ç†è§£è¿›ç¨‹æ˜¯å¦‚ä½•å®ç° graceful shutdown çš„.")]),s._v(" "),t("p",[s._v("è¿›ç¨‹å¯¹ä¿¡å·çš„å¤„ç†å…¶å®å°±åŒ…æ‹¬ä¸¤ä¸ªé—®é¢˜, "),t("mark",[t("strong",[s._v("ä¸€ä¸ªæ˜¯è¿›ç¨‹å¦‚ä½•å‘é€ä¿¡å·, å¦ä¸€ä¸ªæ˜¯è¿›ç¨‹æ”¶åˆ°ä¿¡å·åå¦‚ä½•å¤„ç†")])]),s._v("â€‹ **. **")]),s._v(" "),t("p",[s._v("åœ¨ Linux ä¸­å‘é€ä¿¡å·çš„ç³»ç»Ÿè°ƒç”¨æ˜¯ kill(), ä¹‹å‰å¾ˆå¤šä¾‹å­é‡Œé¢ç”¨çš„å‘½ä»¤ "),t("code",[s._v("kill")]),s._v("â€‹, å®ƒå†…éƒ¨çš„å®ç°å°±æ˜¯"),t("strong",[s._v("è°ƒç”¨äº† kill() è¿™ä¸ªå‡½æ•°")]),s._v(".")]),s._v(" "),t("p",[s._v("ä¸‹é¢æ˜¯ Linux Programmerâ€™s Manual é‡Œå¯¹ kill() å‡½æ•°çš„å®šä¹‰.")]),s._v(" "),t("p",[s._v("è¿™ä¸ªå‡½æ•°æœ‰ä¸¤ä¸ªå‚æ•°, ä¸€ä¸ªæ˜¯ "),t("code",[s._v("sig")]),s._v("â€‹, ä»£è¡¨éœ€è¦å‘é€"),t("strong",[s._v("å“ªä¸ªä¿¡å·")]),s._v(", æ¯”å¦‚ sig çš„å€¼æ˜¯ 15 çš„è¯, å°±æ˜¯æŒ‡å‘é€ SIGTERM; å¦ä¸€ä¸ªå‚æ•°æ˜¯ "),t("code",[s._v("pid")]),s._v("â€‹, ä¹Ÿå°±æ˜¯æŒ‡ä¿¡å·éœ€è¦å‘é€ç»™"),t("strong",[s._v("å“ªä¸ªè¿›ç¨‹")]),s._v(", æ¯”å¦‚å€¼æ˜¯ 1 çš„è¯, å°±æ˜¯æŒ‡å‘é€ç»™è¿›ç¨‹å·æ˜¯ 1 çš„è¿›ç¨‹.")]),s._v(" "),t("div",{staticClass:"language-c line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-c"}},[t("code",[s._v("NAME\n       kill "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v(" send signal to a process\nSYNOPSIS\n       "),t("span",{pre:!0,attrs:{class:"token macro property"}},[t("span",{pre:!0,attrs:{class:"token directive-hash"}},[s._v("#")]),t("span",{pre:!0,attrs:{class:"token directive keyword"}},[s._v("include")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("<sys/types.h>")])]),s._v("\n       "),t("span",{pre:!0,attrs:{class:"token macro property"}},[t("span",{pre:!0,attrs:{class:"token directive-hash"}},[s._v("#")]),t("span",{pre:!0,attrs:{class:"token directive keyword"}},[s._v("include")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("<signal.h>")])]),s._v("\n       "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("kill")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("pid_t")]),s._v(" pid"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" sig"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br")])]),t("p",[s._v("çŸ¥é“äº†å‘é€ä¿¡å·çš„ç³»ç»Ÿè°ƒç”¨ä¹‹å, å†æ¥çœ‹å¦ä¸€ä¸ªç³»ç»Ÿè°ƒç”¨, ä¹Ÿå°±æ˜¯ "),t("strong",[s._v("signal()")]),s._v("  ç³»ç»Ÿè°ƒç”¨è¿™ä¸ªå‡½æ•°, å®ƒå¯ä»¥"),t("strong",[s._v("ç»™ä¿¡å·æ³¨å†Œ handler")]),s._v(".")]),s._v(" "),t("p",[s._v("ä¸‹é¢æ˜¯ signal() åœ¨ Linux Programmerâ€™s Manual é‡Œçš„å®šä¹‰, å‚æ•° "),t("code",[s._v("signum")]),s._v(" ä¹Ÿå°±æ˜¯ä¿¡å·çš„ç¼–å·, ä¾‹å¦‚æ•°å€¼ 15, å°±æ˜¯ä¿¡å· SIGTERM; å‚æ•° "),t("code",[s._v("handler")]),s._v(" æ˜¯ä¸€ä¸ªå‡½æ•°æŒ‡é’ˆå‚æ•°, ç”¨æ¥æ³¨å†Œç”¨æˆ·çš„ä¿¡å· handler.")]),s._v(" "),t("div",{staticClass:"language-c line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-c"}},[t("code",[s._v("NAME\n       signal "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v(" ANSI C signal handling\nSYNOPSIS\n       "),t("span",{pre:!0,attrs:{class:"token macro property"}},[t("span",{pre:!0,attrs:{class:"token directive-hash"}},[s._v("#")]),t("span",{pre:!0,attrs:{class:"token directive keyword"}},[s._v("include")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("<signal.h>")])]),s._v("\n       "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("typedef")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("void")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("sighandler_t")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n       "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("sighandler_t")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("signal")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" signum"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("sighandler_t")]),s._v(" handler"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br")])]),t("p",[s._v("åœ¨å®¹å™¨ init è¿›ç¨‹çš„ç¬¬ä¸€è®²é‡Œ**å­¦è¿‡è¿›ç¨‹å¯¹æ¯ç§ä¿¡å·çš„å¤„ç†, åŒ…æ‹¬ä¸‰ä¸ªé€‰æ‹©: è°ƒç”¨ç³»ç»Ÿç¼ºçœè¡Œä¸º, æ•è·, å¿½ç•¥. ** è€Œè¿™é‡Œçš„é€‰æ‹©, å…¶å®å°±æ˜¯ç¨‹åºä¸­å¦‚ä½•å»è°ƒç”¨ signal() è¿™ä¸ªç³»ç»Ÿè°ƒç”¨.")]),s._v(" "),t("p",[s._v("ç¬¬ä¸€ä¸ªé€‰æ‹©å°±æ˜¯"),t("strong",[s._v("ç¼ºçœ")]),s._v(", å¦‚æœåœ¨ä»£ç ä¸­å¯¹æŸä¸ªä¿¡å·, æ¯”å¦‚ SIGTERM ä¿¡å·, ä¸åšä»»ä½• signal() ç›¸å…³çš„ç³»ç»Ÿè°ƒç”¨, é‚£ä¹ˆåœ¨è¿›ç¨‹è¿è¡Œçš„æ—¶å€™, å¦‚æœæ¥æ”¶åˆ°ä¿¡å· SIGTERM, "),t("strong",[s._v("è¿›ç¨‹å°±ä¼šæ‰§è¡Œå†…æ ¸ä¸­ SIGTERM ä¿¡å·çš„ç¼ºçœä»£ç ")]),s._v(". å¯¹äº SIGTERM è¿™ä¸ªä¿¡å·æ¥è¯´, å®ƒçš„"),t("strong",[s._v("ç¼ºçœè¡Œä¸ºå°±æ˜¯è¿›ç¨‹é€€å‡º")]),s._v("(terminate). å†…æ ¸ä¸­å¯¹ä¸åŒçš„ä¿¡å·æœ‰ä¸åŒçš„ç¼ºçœè¡Œä¸º, ä¸€èˆ¬ä¼šé‡‡ç”¨"),t("strong",[s._v("é€€å‡º")]),s._v("(terminate), "),t("strong",[s._v("æš‚åœ")]),s._v("(stop), "),t("strong",[s._v("å¿½ç•¥")]),s._v("(ignore)è¿™ä¸‰ç§è¡Œä¸ºä¸­çš„ä¸€ç§.")]),s._v(" "),t("p",[s._v("é‚£ç¬¬äºŒä¸ªé€‰æ‹©"),t("strong",[s._v("æ•è·")]),s._v("åˆæ˜¯ä»€ä¹ˆæ„æ€å‘¢? æ•è·æŒ‡çš„å°±æ˜¯"),t("strong",[s._v("åœ¨ä»£ç ä¸­ä¸ºæŸä¸ªä¿¡å·, è°ƒç”¨ signal() æ³¨å†Œè‡ªå·±çš„ handler. è¿™æ ·è¿›ç¨‹åœ¨è¿è¡Œçš„æ—¶å€™, ä¸€æ—¦æ¥æ”¶åˆ°ä¿¡å·, å°±ä¸ä¼šå†å»æ‰§è¡Œå†…æ ¸ä¸­çš„ç¼ºçœä»£ç , è€Œæ˜¯ä¼šæ‰§è¡Œé€šè¿‡ signal() æ³¨å†Œçš„ handler")]),s._v(".")]),s._v(" "),t("p",[s._v("æ¯”å¦‚ä¸‹é¢è¿™æ®µä»£ç , ä¸º SIGTERM è¿™ä¸ªä¿¡å·æ³¨å†Œäº†ä¸€ä¸ª handler, åœ¨ handler é‡Œåªæ˜¯åšäº†ä¸€ä¸ªæ‰“å°æ“ä½œ. é‚£ä¹ˆè¿™ä¸ªç¨‹åºåœ¨è¿è¡Œçš„æ—¶å€™, å¦‚æœæ”¶åˆ° SIGTERM ä¿¡å·, å®ƒå°±"),t("strong",[s._v("ä¸ä¼šé€€å‡º")]),s._v('äº†, è€Œæ˜¯åªåœ¨å±å¹•ä¸Šæ˜¾ç¤ºå‡º "received SIGTERM".')]),s._v(" "),t("div",{staticClass:"language-c line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-c"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("void")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("sig_handler")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" signo"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("signo "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),s._v(" SIGTERM"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n          "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("printf")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"received SIGTERM\\n"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("main")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" argc"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("char")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("argv"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("signal")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("SIGTERM"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" sig_handler"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br")])]),t("p",[s._v('å†æ¥çœ‹çœ‹ç¬¬ä¸‰ä¸ªé€‰æ‹©, å¦‚æœè¦è®©è¿›ç¨‹ "'),t("strong",[s._v("å¿½ç•¥")]),s._v('" ä¸€ä¸ªä¿¡å·, å°±è¦'),t("strong",[s._v("é€šè¿‡ signal() è¿™ä¸ªç³»ç»Ÿè°ƒç”¨, ä¸ºè¿™ä¸ªä¿¡å·æ³¨å†Œä¸€ä¸ªç‰¹æ®Šçš„ handler")]),s._v(", ä¹Ÿå°±æ˜¯ "),t("code",[s._v("SIG_IGN")]),s._v("â€‹.")]),s._v(" "),t("p",[s._v("æ¯”å¦‚ä¸‹é¢çš„è¿™æ®µä»£ç , å°±æ˜¯ä¸º SIGTERM è¿™ä¸ªä¿¡å·æ³¨å†Œ "),t("code",[s._v("SIG_IGN")]),s._v("â€‹. è¿™æ ·æ“ä½œçš„æ•ˆæœ, å°±æ˜¯åœ¨ç¨‹åºè¿è¡Œçš„æ—¶å€™, "),t("strong",[s._v("å¦‚æœæ”¶åˆ° SIGTERM ä¿¡å·, ç¨‹åºæ—¢ä¸ä¼šé€€å‡º, ä¹Ÿä¸ä¼šåœ¨å±å¹•ä¸Šè¾“å‡º log, è€Œæ˜¯ä»€ä¹ˆååº”ä¹Ÿæ²¡æœ‰, å°±åƒå®Œå…¨æ²¡æœ‰æ”¶åˆ°è¿™ä¸ªä¿¡å·ä¸€æ ·")]),s._v(".")]),s._v(" "),t("div",{staticClass:"language-c line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-c"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("main")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" argc"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("char")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("argv"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("signal")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("SIGTERM"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" SIG_IGN"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br")])]),t("p",[s._v("å¥½äº†, é€šè¿‡è®²è§£ signal() è¿™ä¸ªç³»ç»Ÿè°ƒç”¨, å¸®åŠ©ä½ å›é¡¾äº†ä¿¡å·å¤„ç†çš„ä¸‰ä¸ªé€‰æ‹©: "),t("strong",[s._v("ç¼ºçœè¡Œä¸º, æ•è·å’Œå¿½ç•¥")]),s._v(".")]),s._v(" "),t("p",[s._v("è¿™é‡Œè¿˜æƒ³è¦æé†’ä¸€ç‚¹, "),t("mark",[t("strong",[s._v("SIGKILL å’Œ SIGSTOP ä¿¡å·æ˜¯ä¸¤ä¸ªç‰¹æƒä¿¡å·, å®ƒä»¬ä¸å¯ä»¥è¢«æ•è·å’Œå¿½ç•¥")])]),s._v("â€‹ "),t("strong",[s._v(", è¿™ä¸ªç‰¹ç‚¹ä¹Ÿåæ˜ åœ¨ signal() è°ƒç”¨ä¸Š. æ‰€ä»¥è¿™ä¸¤ä¸ªä¿¡å·ä¸€å®šä¼šèµ°ç¼ºçœè¡Œä¸ºçš„é€»è¾‘, è¿™ä¸ªè¿›ç¨‹å°±ä¸€å®šä¼šè¢«åˆ é™¤.")])]),s._v(" "),t("p",[s._v("å¯ä»¥è¿è¡Œä¸‹é¢çš„è¿™æ®µä»£ç , å¦‚æœç”¨ signal() ä¸º SIGKILL æ³¨å†Œ handler, é‚£ä¹ˆå®ƒå°±ä¼šè¿”å› SIG_ERR, ä¸å…è®¸åšæ•è·æ“ä½œ.")]),s._v(" "),t("div",{staticClass:"language-c line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-c"}},[t("code",[t("span",{pre:!0,attrs:{class:"token macro property"}},[t("span",{pre:!0,attrs:{class:"token directive-hash"}},[s._v("#")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token directive keyword"}},[s._v("cat")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token expression"}},[s._v("reg_sigkill"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("c")])]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token macro property"}},[t("span",{pre:!0,attrs:{class:"token directive-hash"}},[s._v("#")]),t("span",{pre:!0,attrs:{class:"token directive keyword"}},[s._v("include")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("<stdio.h>")])]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token macro property"}},[t("span",{pre:!0,attrs:{class:"token directive-hash"}},[s._v("#")]),t("span",{pre:!0,attrs:{class:"token directive keyword"}},[s._v("include")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("<stdlib.h>")])]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token macro property"}},[t("span",{pre:!0,attrs:{class:"token directive-hash"}},[s._v("#")]),t("span",{pre:!0,attrs:{class:"token directive keyword"}},[s._v("include")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("<unistd.h>")])]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token macro property"}},[t("span",{pre:!0,attrs:{class:"token directive-hash"}},[s._v("#")]),t("span",{pre:!0,attrs:{class:"token directive keyword"}},[s._v("include")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("<errno.h>")])]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token macro property"}},[t("span",{pre:!0,attrs:{class:"token directive-hash"}},[s._v("#")]),t("span",{pre:!0,attrs:{class:"token directive keyword"}},[s._v("include")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("<signal.h>")])]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("typedef")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("void")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("sighandler_t")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("void")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("sig_handler")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" signo"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("signo "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),s._v(" SIGKILL"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n                        "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("printf")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"received SIGKILL\\n"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n                        "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("exit")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n \n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("main")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" argc"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("char")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("argv"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("sighandler_t")]),s._v(" h_ret"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n            h_ret "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("signal")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("SIGKILL"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" sig_handler"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("h_ret "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),s._v(" SIG_ERR"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n                        "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("perror")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"SIG_ERR"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n# "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("reg_sigkill\nSIG_ERR"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" Invalid argument\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br"),t("span",{staticClass:"line-number"},[s._v("25")]),t("br"),t("span",{staticClass:"line-number"},[s._v("26")]),t("br")])]),t("p",[s._v("æœ€åç”¨ä¸‹é¢è¿™æ®µä»£ç æ¥åšä¸ªå°ç»“. è¿™æ®µä»£ç "),t("strong",[s._v("ç”¨ signal() å¯¹ SIGTERM è¿™ä¸ªä¿¡å·åšäº†å¿½ç•¥, æ•è·ä»¥åŠæ¢å¤å®ƒçš„ç¼ºçœè¡Œä¸º, å¹¶ä¸”æ¯ä¸€æ¬¡éƒ½ç”¨ kill() ç³»ç»Ÿè°ƒç”¨å‘è¿›ç¨‹è‡ªå·±å‘é€ SIGTERM ä¿¡å·, è¿™æ ·åšå¯ä»¥ç¡®è®¤è¿›ç¨‹å¯¹ SIGTERM ä¿¡å·çš„é€‰æ‹©")]),s._v(".")]),s._v(" "),t("div",{staticClass:"language-c line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-c"}},[t("code",[t("span",{pre:!0,attrs:{class:"token macro property"}},[t("span",{pre:!0,attrs:{class:"token directive-hash"}},[s._v("#")]),t("span",{pre:!0,attrs:{class:"token directive keyword"}},[s._v("include")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("<stdio.h>")])]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token macro property"}},[t("span",{pre:!0,attrs:{class:"token directive-hash"}},[s._v("#")]),t("span",{pre:!0,attrs:{class:"token directive keyword"}},[s._v("include")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("<signal.h>")])]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("typedef")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("void")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("sighandler_t")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("void")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("sig_handler")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" signo"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("signo "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),s._v(" SIGTERM"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n                "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("printf")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"received SIGTERM\\n\\n"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n                "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// Set SIGTERM handler to default")]),s._v("\n                "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("signal")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("SIGTERM"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" SIG_DFL"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("main")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" argc"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("char")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("argv"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// Ignore SIGTERM, and send SIGTERM")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// to process itself.")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("signal")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("SIGTERM"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" SIG_IGN"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("printf")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Ignore SIGTERM\\n\\n"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("kill")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" SIGTERM"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// Catch SIGERM, and send SIGTERM")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// to process itself.")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("signal")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("SIGTERM"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" sig_handler"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("printf")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Catch SIGTERM\\n"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("kill")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" SIGTERM"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n \n        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// Default SIGTERM. In sig_handler, it sets")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// SIGTERM handler back to default one.")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("printf")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Default SIGTERM\\n"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("kill")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" SIGTERM"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br"),t("span",{staticClass:"line-number"},[s._v("25")]),t("br"),t("span",{staticClass:"line-number"},[s._v("26")]),t("br"),t("span",{staticClass:"line-number"},[s._v("27")]),t("br"),t("span",{staticClass:"line-number"},[s._v("28")]),t("br"),t("span",{staticClass:"line-number"},[s._v("29")]),t("br"),t("span",{staticClass:"line-number"},[s._v("30")]),t("br")])]),t("p",[s._v("ä¸€èµ·æ¥æ€»ç»“ä¸€ä¸‹åˆšæ‰è®²çš„ä¸¤ä¸ªç³»ç»Ÿè°ƒç”¨:")]),s._v(" "),t("p",[s._v("å…ˆè¯´è¯´ "),t("strong",[s._v("kill()")]),s._v("  è¿™ä¸ªç³»ç»Ÿè°ƒç”¨, å®ƒå…¶å®å¾ˆç®€å•, è¾“å…¥ä¸¤ä¸ªå‚æ•°: è¿›ç¨‹å·å’Œä¿¡å·, å°±æŠŠç‰¹å®šçš„ä¿¡å·å‘é€ç»™æŒ‡å®šçš„è¿›ç¨‹äº†.")]),s._v(" "),t("p",[s._v("å†è¯´è¯´ "),t("strong",[s._v("signal()")]),s._v("  è¿™ä¸ªè°ƒç”¨, å®ƒå†³å®šäº†è¿›ç¨‹æ”¶åˆ°ç‰¹å®šçš„ä¿¡å·å¦‚ä½•æ¥å¤„ç†, SIG_DFL å‚æ•°æŠŠå¯¹åº”ä¿¡å·æ¢å¤ä¸ºç¼ºçœ handler, ä¹Ÿå¯ä»¥ç”¨è‡ªå®šä¹‰çš„å‡½æ•°ä½œä¸º handler, æˆ–è€…ç”¨ SIG_IGN å‚æ•°è®©è¿›ç¨‹å¿½ç•¥ä¿¡å·. å¯¹äº "),t("strong",[s._v("SIGKILL")]),s._v(" ä¿¡å·, å¦‚æœè°ƒç”¨ signal() å‡½æ•°, ä¸ºå®ƒæ³¨å†Œè‡ªå®šä¹‰çš„ handler, ç³»ç»Ÿå°±ä¼šæ‹’ç».")]),s._v(" "),t("h5",{attrs:{id:"_3-è§£å†³é—®é¢˜"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-è§£å†³é—®é¢˜"}},[s._v("#")]),s._v(" 3.è§£å†³é—®é¢˜")]),s._v(" "),t("p",[s._v("å­¦ä¹ äº† kill() å’Œ signal() è¿™ä¸ªä¸¤ä¸ªä¿¡å·ç›¸å…³çš„ç³»ç»Ÿè°ƒç”¨ä¹‹å, å†å›åˆ°æœ¬èŠ‚æœ€åˆçš„é—®é¢˜ä¸Š, "),t("strong",[s._v("ä¸ºä»€ä¹ˆåœ¨åœæ­¢ä¸€ä¸ªå®¹å™¨çš„æ—¶å€™, å®¹å™¨ init è¿›ç¨‹æ”¶åˆ°çš„ SIGTERM ä¿¡å·, è€Œå®¹å™¨ä¸­å…¶ä»–è¿›ç¨‹å´ä¼šæ”¶åˆ° SIGKILL ä¿¡å·å‘¢")]),s._v("?")]),s._v(" "),t("p",[s._v("å½“ Linux è¿›ç¨‹æ”¶åˆ° SIGTERM ä¿¡å·å¹¶ä¸”ä½¿è¿›ç¨‹é€€å‡º, è¿™æ—¶ Linux å†…æ ¸å¯¹å¤„ç†è¿›ç¨‹é€€å‡ºçš„å…¥å£ç‚¹å°±æ˜¯ "),t("strong",[s._v("do_exit()")]),s._v("  å‡½æ•°, do_exit() å‡½æ•°ä¸­ä¼š"),t("strong",[s._v("é‡Šæ”¾è¿›ç¨‹çš„ç›¸å…³èµ„æº, æ¯”å¦‚å†…å­˜, æ–‡ä»¶å¥æŸ„, ä¿¡å·é‡")]),s._v("ç­‰ç­‰.")]),s._v(" "),t("p",[s._v("åœ¨åšå®Œè¿™äº›å·¥ä½œä¹‹å, å®ƒä¼šè°ƒç”¨ä¸€ä¸ª "),t("strong",[s._v("exit_notify()")]),s._v("  å‡½æ•°, ç”¨æ¥"),t("strong",[s._v("é€šçŸ¥å’Œè¿™ä¸ªè¿›ç¨‹ç›¸å…³çš„çˆ¶å­è¿›ç¨‹")]),s._v("ç­‰.")]),s._v(" "),t("p",[s._v("å¯¹äºå®¹å™¨æ¥è¯´, è¿˜è¦"),t("strong",[s._v("è€ƒè™‘ Pid Namespace é‡Œçš„å…¶ä»–è¿›ç¨‹")]),s._v(". è¿™é‡Œè°ƒç”¨çš„å°±æ˜¯ "),t("strong",[s._v("zap_pid_ns_processes()")]),s._v("  è¿™ä¸ªå‡½æ•°, è€Œåœ¨è¿™ä¸ªå‡½æ•°ä¸­, å¦‚æœ"),t("mark",[t("strong",[s._v("æ˜¯å¤„äºé€€å‡ºçŠ¶æ€çš„ init è¿›ç¨‹, å®ƒä¼šå‘ Namespace ä¸­çš„å…¶ä»–è¿›ç¨‹éƒ½å‘é€ä¸€ä¸ª SIGKILL ä¿¡å·")])]),s._v(".")]),s._v(" "),t("p",[s._v("æ•´ä¸ªæµç¨‹å¦‚ä¸‹å›¾æ‰€ç¤º.")]),s._v(" "),t("p",[t("img",{attrs:{src:"/img/919c1923e68406ec62be8bb089495c1d-20230731161430-jjhc05p.png",alt:""}})]),s._v(" "),t("p",[s._v("å¯ä»¥çœ‹ä¸€ä¸‹, å†…æ ¸ä»£ç æ˜¯è¿™æ ·çš„.")]),s._v(" "),t("div",{staticClass:"language-c line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-c"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("/**\n * The last thread in the cgroup-init thread group is terminating.\n * Find remaining pid_ts in the namespace, signal and wait for them\n * to exit.\n *\n * Note:  This signals each threads in the namespace - even those that\n *        belong to the same thread group, To avoid this, we would have\n *        to walk the entire tasklist looking a processes in this\n *        namespace, but that could be unnecessarily expensive if the\n *        pid namespace has just a few processes. Or we need to\n *        maintain a tasklist for each pid namespace.\n *\n */")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("rcu_read_lock")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("read_lock")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&")]),s._v("tasklist_lock"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\nnr "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("idr_for_each_entry_continue")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&")]),s._v("pid_ns"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("idr"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" pid"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" nr"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        task "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("pid_task")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("pid"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" PIDTYPE_PID"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("task "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&&")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("__fatal_signal_pending")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("task"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n                "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("group_send_sig_info")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("SIGKILL"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" SEND_SIG_PRIV"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" task"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" PIDTYPE_MAX"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br")])]),t("p",[s._v("è¯´åˆ°è¿™é‡Œ, ä¹Ÿå°±æ˜ç™½ä¸ºä»€ä¹ˆ"),t("strong",[s._v("å®¹å™¨ init è¿›ç¨‹æ”¶åˆ°çš„ SIGTERM ä¿¡å·, è€Œå®¹å™¨ä¸­å…¶ä»–è¿›ç¨‹å´ä¼šæ”¶åˆ° SIGKILL ä¿¡å·")]),s._v("äº†. å‰é¢è®²è¿‡, SIGKILL æ˜¯ä¸ª"),t("strong",[s._v("ç‰¹æƒä¿¡å·")]),s._v("(ç‰¹æƒä¿¡å·æ˜¯ Linux "),t("strong",[s._v("ä¸º kernel å’Œè¶…çº§ç”¨æˆ·å»åˆ é™¤ä»»æ„è¿›ç¨‹æ‰€ä¿ç•™çš„, ä¸èƒ½è¢«å¿½ç•¥ä¹Ÿä¸èƒ½è¢«æ•è·")]),s._v(").")]),s._v(" "),t("p",[s._v("**æ‰€ä»¥è¿›ç¨‹æ”¶åˆ°è¿™ä¸ªä¿¡å·å, å°±ç«‹åˆ»é€€å‡ºäº†, æ²¡æœ‰æœºä¼šè°ƒç”¨ä¸€äº›é‡Šæ”¾èµ„æºçš„ handler ä¹‹å, å†åšé€€å‡ºåŠ¨ä½œ. ** è€Œ SIGTERM æ˜¯å¯ä»¥è¢«æ•è·çš„, ç”¨æˆ·æ˜¯å¯ä»¥æ³¨å†Œè‡ªå·±çš„ handler çš„, ä»è‡ªå·±çš„ handler æˆ‘ä»¬å¯ä»¥åšä¸€äº› graceful shutdown çš„æ“ä½œ.")]),s._v(" "),t("p",[s._v("å› æ­¤å®¹å™¨ä¸­çš„ç¨‹åºåœ¨ stop container çš„æ—¶å€™, æˆ‘ä»¬"),t("strong",[s._v("æ›´å¸Œæœ›è¿›ç¨‹æ”¶åˆ° SIGTERM ä¿¡å·è€Œä¸æ˜¯ SIGKILL ä¿¡å·")]),s._v(". é‚£åœ¨å®¹å™¨è¢«åœæ­¢çš„æ—¶å€™, è¯¥æ€ä¹ˆåšæ‰èƒ½"),t("strong",[s._v("è®©å®¹å™¨ä¸­çš„æ™®é€šè¿›ç¨‹æ”¶åˆ° SIGTERM ä¿¡å·")]),s._v("å‘¢?")]),s._v(" "),t("p",[s._v("ä½ å¯èƒ½å·²ç»æƒ³åˆ°äº†, "),t("mark",[t("strong",[s._v("å°±æ˜¯è®©å®¹å™¨ init è¿›ç¨‹æ¥è½¬å‘ SIGTERM ä¿¡å·")])]),s._v(". çš„ç¡®æ˜¯è¿™æ ·, æ¯”å¦‚ Docker Container é‡Œä½¿ç”¨çš„ tini ä½œä¸º init è¿›ç¨‹, tini çš„ä»£ç ä¸­å°±ä¼š"),t("strong",[s._v("è°ƒç”¨ sigtimedwait()")]),s._v("  è¿™ä¸ªå‡½æ•°æ¥æŸ¥çœ‹è‡ªå·±æ”¶åˆ°çš„ä¿¡å·, ç„¶åè°ƒç”¨ kill() æŠŠä¿¡å·å‘ç»™å­è¿›ç¨‹.")]),s._v(" "),t("p",[s._v("ä¸¾ä¸ªå…·ä½“çš„ä¾‹å­è¯´æ˜, ä»ä¸‹é¢çš„è¿™æ®µä»£ç ä¸­, å¯ä»¥çœ‹åˆ°"),t("strong",[s._v("é™¤äº† SIGCHLD è¿™ä¸ªä¿¡å·å¤–, tini ä¼šæŠŠå…¶ä»–æ‰€æœ‰çš„ä¿¡å·éƒ½è½¬å‘ç»™å®ƒçš„å­è¿›ç¨‹")]),s._v(".")]),s._v(" "),t("div",{staticClass:"language-c line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-c"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("wait_and_forward_signal")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("sigset_t")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("const")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("const")]),s._v(" parent_sigset_ptr"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("pid_t")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("const")]),s._v(" child_pid"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("siginfo_t")]),s._v(" sig"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("sigtimedwait")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("parent_sigset_ptr"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&")]),s._v("sig"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&")]),s._v("ts"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("mark"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n                "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("switch")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("errno"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n                    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// ...")]),s._v("\n                "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("else")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n                "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("/* There is a signal to handle here */")]),s._v("\n                "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("switch")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("sig"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("si_signo"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n                        "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("case")]),s._v(" SIGCHLD"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v("\n                                "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("/* Special-cased, as we don't forward SIGCHLD. Instead, we'll\n                                 * fallthrough to reaping processes.\n                                 */")]),s._v("\n                                "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("PRINT_DEBUG")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Received SIGCHLD"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n                                "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("break")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n                        "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("default")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v("\n                                "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("PRINT_DEBUG")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("\"Passing signal: '%s'\"")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("strsignal")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("sig"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("si_signo"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n                                "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("/* Forward anything else */")]),s._v("\n                                "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("kill")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("kill_process_group "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("?")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("child_pid "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" child_pid"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" sig"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("si_signo"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n                                        "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("errno "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("mark"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" ESRCH"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n                                                "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("PRINT_WARNING")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Child was dead when forwarding signal"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n                                        "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("else")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n                                                "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("PRINT_FATAL")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("\"Unexpected error when forwarding signal: '%s'\"")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("strerror")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("errno"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n                                                "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n                                        "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n                                "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n                                "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("break")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n                "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br"),t("span",{staticClass:"line-number"},[s._v("25")]),t("br"),t("span",{staticClass:"line-number"},[s._v("26")]),t("br"),t("span",{staticClass:"line-number"},[s._v("27")]),t("br"),t("span",{staticClass:"line-number"},[s._v("28")]),t("br"),t("span",{staticClass:"line-number"},[s._v("29")]),t("br"),t("span",{staticClass:"line-number"},[s._v("30")]),t("br"),t("span",{staticClass:"line-number"},[s._v("31")]),t("br")])]),t("p",[s._v("é‚£ä¹ˆåœ¨è¿™é‡Œæ˜ç¡®ä¸€ä¸‹, æ€ä¹ˆè§£å†³åœæ­¢å®¹å™¨çš„æ—¶å€™, å®¹å™¨å†…åº”ç”¨ç¨‹åºè¢«å¼ºåˆ¶æ€æ­»çš„é—®é¢˜å‘¢? "),t("mark",[s._v("**è§£å†³çš„æ–¹æ³•å°±æ˜¯åœ¨å®¹å™¨çš„ init è¿›ç¨‹ä¸­å¯¹æ”¶åˆ°çš„ä¿¡å·åšä¸ªè½¬å‘, å‘é€åˆ°å®¹å™¨ä¸­çš„å…¶ä»–å­è¿›ç¨‹, è¿™æ ·å®¹å™¨ä¸­çš„æ‰€æœ‰è¿›ç¨‹åœ¨åœæ­¢æ—¶, éƒ½ä¼šæ”¶åˆ° SIGTERM, è€Œä¸æ˜¯ SIGKILL ä¿¡å·äº†. **")])]),s._v(" "),t("h5",{attrs:{id:"_4-é‡ç‚¹å°ç»“"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_4-é‡ç‚¹å°ç»“"}},[s._v("#")]),s._v(" 4.é‡ç‚¹å°ç»“")]),s._v(" "),t("p",[s._v("æœ¬èŠ‚è¦è§£å†³çš„é—®é¢˜æ˜¯è®©å®¹å™¨ä¸­çš„è¿›ç¨‹, åœ¨å®¹å™¨åœæ­¢çš„æ—¶å€™, æœ‰æœºä¼š "),t("strong",[s._v("graceful shutdown, è€Œä¸æ˜¯æ”¶åˆ° SIGKILL ä¿¡å·è€Œè¢«å¼ºåˆ¶æ€æ­»")]),s._v(".")]),s._v(" "),t("p",[s._v("é¦–å…ˆé€šè¿‡å¯¹ kill() å’Œ signal() è¿™ä¸ªä¸¤ä¸ªç³»ç»Ÿè°ƒç”¨çš„å­¦ä¹ , è¿›ä¸€æ­¥ç†è§£äº†è¿›ç¨‹æ˜¯æ€æ ·å¤„ç† Linux ä¿¡å·çš„, é‡ç‚¹æ˜¯ä¿¡å·åœ¨æ¥æ”¶å¤„ç†çš„ä¸‰ä¸ªé€‰æ‹©: "),t("strong",[s._v("å¿½ç•¥, æ•è·å’Œç¼ºçœè¡Œä¸º")]),s._v(".")]),s._v(" "),t("p",[s._v("é€šè¿‡ä»£ç ä¾‹å­, çŸ¥é“äº† "),t("strong",[s._v("SIGTERM æ˜¯å¯ä»¥è¢«å¿½ç•¥å’Œæ•è·çš„, ä½†æ˜¯ SIGKILL æ˜¯ä¸å¯ä»¥è¢«å¿½ç•¥å’Œæ•è·")]),s._v("çš„. äº†è§£è¿™ä¸€ç‚¹ä»¥å, å°±æ‰¾åˆ°äº†é—®é¢˜çš„è§£å†³æ–¹å‘, ä¹Ÿå°±æ˜¯"),t("strong",[s._v("éœ€è¦åœ¨åœæ­¢å®¹å™¨æ—¶, è®©å®¹å™¨ä¸­çš„åº”ç”¨æ”¶åˆ° SIGTERM, è€Œä¸æ˜¯ SIGKILL")]),s._v(".")]),s._v(" "),t("p",[s._v("å…·ä½“æ€ä¹ˆæ“ä½œå‘¢? "),t("strong",[s._v("å¯ä»¥åœ¨å®¹å™¨çš„ init è¿›ç¨‹ä¸­å¯¹æ”¶åˆ°çš„ä¿¡å·åšä¸ªè½¬å‘, å‘é€åˆ°å®¹å™¨ä¸­çš„å…¶ä»–å­è¿›ç¨‹. è¿™æ ·ä¸€æ¥, å®¹å™¨ä¸­çš„æ‰€æœ‰è¿›ç¨‹åœ¨åœæ­¢å®¹å™¨æ—¶, éƒ½ä¼šæ”¶åˆ° SIGTERM, è€Œä¸æ˜¯ SIGKILL ä¿¡å·äº†")]),s._v(".")]),s._v(" "),t("p",[s._v("å…¶å®è§£å†³ init è¿›ç¨‹ä¿¡å·çš„è¿™ç±»é—®é¢˜å…¶å®å¹¶ä¸éš¾. åªéœ€è¦å…ˆæ¢³ç†ä¸€ä¸‹å’Œè¿™ä¸ªé—®é¢˜ç›¸å…³çš„å‡ ä¸ªçŸ¥è¯†ç‚¹, å†å†™ä¸ªå°ç¨‹åº, è®©å®ƒè·‘åœ¨å®¹å™¨é‡Œ, ç¨å¾®åšå‡ ä¸ªè¯•éªŒ. ç„¶åå†çœ‹ä¸€ä¸‹å†…æ ¸å’Œ Docker çš„æºä»£ç , å°±å¯ä»¥å¾ˆå¿«å¾—å‡ºç»“è®ºäº†.")]),s._v(" "),t("h4",{attrs:{id:"_05-å®¹å™¨cpu-1-æ€ä¹ˆé™åˆ¶å®¹å™¨çš„cpuä½¿ç”¨"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_05-å®¹å™¨cpu-1-æ€ä¹ˆé™åˆ¶å®¹å™¨çš„cpuä½¿ç”¨"}},[s._v("#")]),s._v(" 05ï½œå®¹å™¨CPU(1):æ€ä¹ˆé™åˆ¶å®¹å™¨çš„CPUä½¿ç”¨?")]),s._v(" "),t("p",[s._v("ä»æœ¬èŠ‚å¼€å§‹è¿›å…¥å®¹å™¨ CPU è¿™ä¸ªæ¨¡å—. å‰é¢è®²è¿‡, å®¹å™¨åœ¨ Linux ç³»ç»Ÿä¸­æœ€æ ¸å¿ƒçš„ä¸¤ä¸ªæ¦‚å¿µæ˜¯ "),t("strong",[s._v("Namespace å’Œ Cgroups")]),s._v(". å¯ä»¥"),t("strong",[s._v("é€šè¿‡ Cgroups æŠ€æœ¯é™åˆ¶èµ„æº")]),s._v(". è¿™ä¸ªèµ„æºå¯ä»¥åˆ†ä¸ºå¾ˆå¤šç±»å‹, æ¯”å¦‚ CPU, Memory, Storage, Network ç­‰ç­‰. è€Œè®¡ç®—èµ„æºæ˜¯æœ€åŸºæœ¬çš„ä¸€ç§èµ„æº, æ‰€æœ‰çš„å®¹å™¨éƒ½éœ€è¦è¿™ç§èµ„æº. æœ¬èŠ‚å°±å…ˆèŠä¸€èŠ, æ€ä¹ˆé™åˆ¶å®¹å™¨çš„ CPU ä½¿ç”¨?")]),s._v(" "),t("p",[s._v("æ‹¿ Kubernetes åšä¾‹å­, å…·ä½“æ¥çœ‹ä¸‹é¢è¿™ä¸ª pod/container é‡Œçš„ spec å®šä¹‰, åœ¨ CPU èµ„æºç›¸å…³çš„å®šä¹‰ä¸­æœ‰ä¸¤é¡¹å†…å®¹, åˆ†åˆ«æ˜¯ "),t("strong",[s._v("Request CPU")]),s._v(" å’Œ "),t("strong",[s._v("Limit CPU")]),s._v(".")]),s._v(" "),t("div",{staticClass:"language-yml line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-yml"}},[t("code",[t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("apiVersion")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" v1\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kind")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" Pod\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("metadata")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" frontend\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("spec")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("containers")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" app\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("image")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" images.my"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("company.example/app"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("v4\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("env")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("resources")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("requests")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("memory")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"64Mi"')]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("cpu")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"1"')]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("limits")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("memory")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"128Mi"')]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("cpu")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"2"')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("...")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br")])]),t("p",[s._v("å¾ˆå¤šåˆšåˆšä½¿ç”¨ Kubernetes çš„åŒå­¦, å¯èƒ½ä¸€å¼€å§‹å¹¶ä¸ç†è§£è¿™ä¸¤ä¸ªå‚æ•°æœ‰ä»€ä¹ˆä½œç”¨. è¿™é‡Œå…ˆè¯´ç»“è®º, "),t("strong",[s._v('åœ¨ Pod Spec é‡Œçš„ "Request CPU" å’Œ "Limit CPU" çš„å€¼, æœ€åä¼šé€šè¿‡ CPU Cgroup çš„é…ç½®, æ¥å®ç°æ§åˆ¶å®¹å™¨ CPU èµ„æºçš„ä½œç”¨')]),s._v(".")]),s._v(" "),t("p",[s._v("é‚£æ¥ä¸‹æ¥å…ˆä»è¿›ç¨‹çš„ CPU ä½¿ç”¨è®²èµ·, ç„¶ååœ¨ CPU Cgroup å­ç³»ç»Ÿä¸­å»ºç«‹å‡ ä¸ª"),t("strong",[s._v("æ§åˆ¶ç»„")]),s._v(", ç”¨è¿™ä¸ªä¾‹å­è®²è§£ CPU Cgroup ä¸­çš„ä¸‰ä¸ªæœ€é‡è¦çš„å‚æ•°  "),t("strong",[s._v('"cpu.cfs_quota_us", "cpu.cfs_period_us", "cpu.shares"')]),s._v(" .")]),s._v(" "),t("p",[s._v("ç†è§£äº†è¿™ä¸‰ä¸ªå‚æ•°å, å°±ä¼šæ˜ç™½è¦æ€æ ·é™åˆ¶å®¹å™¨ CPU çš„ä½¿ç”¨äº†.")]),s._v(" "),t("h5",{attrs:{id:"_1-å¦‚ä½•ç†è§£cpuä½¿ç”¨å’Œcpu-cgroup"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-å¦‚ä½•ç†è§£cpuä½¿ç”¨å’Œcpu-cgroup"}},[s._v("#")]),s._v(" 1.å¦‚ä½•ç†è§£CPUä½¿ç”¨å’ŒCPU Cgroup?")]),s._v(" "),t("p",[s._v("æ—¢ç„¶éœ€è¦ç†è§£ CPU Cgroup, é‚£ä¹ˆå°±æœ‰å¿…è¦å…ˆæ¥çœ‹ä¸€ä¸‹ Linux é‡Œçš„ CPU ä½¿ç”¨çš„æ¦‚å¿µ, è¿™æ˜¯å› ä¸º "),t("strong",[s._v("CPU Cgroup æœ€å¤§çš„ä½œç”¨å°±æ˜¯é™åˆ¶ CPU ä½¿ç”¨")]),s._v(".")]),s._v(" "),t("h6",{attrs:{id:"_1-cpuä½¿ç”¨çš„åˆ†ç±»"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-cpuä½¿ç”¨çš„åˆ†ç±»"}},[s._v("#")]),s._v(" (1)CPUä½¿ç”¨çš„åˆ†ç±»")]),s._v(" "),t("p",[s._v("å¦‚æœæƒ³æŸ¥çœ‹ Linux ç³»ç»Ÿçš„ CPU ä½¿ç”¨çš„è¯, ä¼šç”¨ä»€ä¹ˆæ–¹æ³•å‘¢? æœ€å¸¸ç”¨çš„è‚¯å®šæ˜¯è¿è¡Œ Top äº†.")]),s._v(" "),t("p",[s._v('å¯¹ç…§ä¸‹å›¾çš„ Top è¿è¡Œç•Œé¢, åœ¨æˆªå›¾ç¬¬ä¸‰è¡Œ, " '),t("strong",[s._v("%Cpu(s)")]),s._v(' " å¼€å¤´çš„è¿™ä¸€è¡Œ, ä¼šçœ‹åˆ°ä¸€ä¸²æ•°å€¼, ä¹Ÿå°±æ˜¯ "0.0 us, 0.0 sy, 0.0 ni, 99.9 id, 0.0 wa, 0.0 hi, 0.0 si, 0.0 st", é‚£ä¹ˆè¿™é‡Œçš„æ¯ä¸€é¡¹å€¼éƒ½æ˜¯ä»€ä¹ˆå«ä¹‰å‘¢?')]),s._v(" "),t("p",[t("img",{attrs:{src:"/img/3b01badf86f310a1d1f10f4b7e9c0381-20230731161430-plhm9f1.png",alt:""}})]),s._v(" "),t("p",[s._v("ä¸‹é¢è¿™å¼ å›¾é‡Œæœ€é•¿çš„å¸¦ç®­å¤´æ¨ªè½´, å¯ä»¥æŠŠå®ƒçœ‹æˆä¸€ä¸ª"),t("strong",[s._v("æ—¶é—´è½´")]),s._v(". åŒæ—¶å®ƒçš„"),t("mark",[t("strong",[s._v("ä¸ŠåŠéƒ¨åˆ†ä»£è¡¨ Linux ç”¨æˆ·æ€(User space), ä¸‹åŠéƒ¨åˆ†ä»£è¡¨å†…æ ¸æ€(Kernel space)")])]),s._v(" . è¿™é‡Œä¸ºäº†æ–¹ä¾¿ç†è§£, å…ˆå‡è®¾åªæœ‰ä¸€ä¸ª CPU.")]),s._v(" "),t("p",[t("img",{attrs:{src:"/img/9515e60d11766c6b2e4481af6bd382e8-20230731161430-g8v7nm4.png",alt:""}})]),s._v(" "),t("p",[s._v("å¯ä»¥ç”¨ä¸Šé¢è¿™å¼ å›¾, æŠŠè¿™äº›å€¼æŒ¨ä¸ªè§£é‡Šä¸€ä¸‹.")]),s._v(" "),t("p",[s._v("å‡è®¾ä¸€ä¸ªç”¨æˆ·"),t("strong",[s._v("ç¨‹åºå¼€å§‹è¿è¡Œ")]),s._v("äº†, é‚£ä¹ˆå°±å¯¹åº”ç€ç¬¬ä¸€ä¸ª  "),t("strong",[s._v('"us" æ¡†')]),s._v(",  "),t("mark",[t("strong",[s._v('"us" æ˜¯ "user" çš„ç¼©å†™, ä»£è¡¨ Linux çš„ç”¨æˆ·æ€ CPU Usage')])]),s._v(". æ™®é€šç”¨æˆ·ç¨‹åºä»£ç ä¸­, "),t("strong",[s._v('åªè¦ä¸æ˜¯è°ƒç”¨ç³»ç»Ÿè°ƒç”¨(System Call), è¿™äº›ä»£ç çš„æŒ‡ä»¤æ¶ˆè€—çš„ CPU å°±éƒ½å±äº "us"')]),s._v(" .")]),s._v(" "),t("p",[s._v("å½“è¿™ä¸ªç”¨æˆ·ç¨‹åºä»£ç ä¸­è°ƒç”¨äº†"),t("strong",[s._v("ç³»ç»Ÿè°ƒç”¨")]),s._v(", æ¯”å¦‚è¯´ read() å»è¯»å–ä¸€ä¸ªæ–‡ä»¶, è¿™æ—¶å€™è¿™ä¸ªç”¨æˆ·è¿›ç¨‹å°±ä¼š"),t("strong",[s._v("ä»ç”¨æˆ·æ€åˆ‡æ¢åˆ°å†…æ ¸æ€")]),s._v('. å†…æ ¸æ€ read() ç³»ç»Ÿè°ƒç”¨åœ¨è¯»åˆ°çœŸæ­£ disk ä¸Šçš„æ–‡ä»¶å‰, å°±ä¼šè¿›è¡Œä¸€äº›æ–‡ä»¶ç³»ç»Ÿå±‚çš„æ“ä½œ. é‚£ä¹ˆè¿™äº›ä»£ç æŒ‡ä»¤çš„æ¶ˆè€—å°±å±äº "'),t("strong",[s._v("sy")]),s._v('", è¿™é‡Œå°±å¯¹åº”ä¸Šé¢å›¾é‡Œçš„ç¬¬äºŒä¸ªæ¡†.  '),t("mark",[t("strong",[s._v('"sy" æ˜¯ "system" çš„ç¼©å†™, ä»£è¡¨å†…æ ¸æ€ CPU ä½¿ç”¨')])]),s._v(".")]),s._v(" "),t("p",[s._v('æ¥ä¸‹æ¥, è¿™ä¸ª read() ç³»ç»Ÿè°ƒç”¨ä¼šå‘ Linux çš„ Block Layer å‘å‡ºä¸€ä¸ª I/O Request, è§¦å‘ä¸€ä¸ªçœŸæ­£çš„ç£ç›˜è¯»å–æ“ä½œ. è¿™æ—¶å€™, è¿™ä¸ªè¿›ç¨‹ä¸€èˆ¬ä¼šè¢«ç½®ä¸º TASK_UNINTERRUPTIBLE. è€Œ Linux ä¼šæŠŠè¿™æ®µæ—¶é—´æ ‡ç¤ºæˆ "wa", å¯¹åº”å›¾ä¸­çš„ç¬¬ä¸‰ä¸ªæ¡†.  '),t("mark",[t("strong",[s._v('"wa" æ˜¯ "iowait" çš„ç¼©å†™, ä»£è¡¨ç­‰å¾… I/O çš„æ—¶é—´, è¿™é‡Œçš„ I/O æ˜¯æŒ‡ Disk I/O')])]),s._v(".")]),s._v(" "),t("p",[s._v('ç´§æ¥ç€, å½“ç£ç›˜è¿”å›æ•°æ®æ—¶, è¿›ç¨‹åœ¨å†…æ ¸æ€æ‹¿åˆ°æ•°æ®, è¿™é‡Œä»æ—§æ˜¯å†…æ ¸æ€çš„ CPU ä½¿ç”¨ä¸­çš„ "sy", ä¹Ÿå°±æ˜¯å›¾ä¸­çš„ç¬¬å››ä¸ªæ¡†.')]),s._v(" "),t("p",[s._v("ç„¶å, è¿›ç¨‹å†"),t("strong",[s._v("ä»å†…æ ¸æ€åˆ‡æ¢å›ç”¨æˆ·æ€")]),s._v(', åœ¨ç”¨æˆ·æ€å¾—åˆ°æ–‡ä»¶æ•°æ®, è¿™é‡Œè¿›ç¨‹åˆå›åˆ°ç”¨æˆ·æ€çš„ CPU ä½¿ç”¨, "us", å¯¹åº”å›¾ä¸­ç¬¬äº”ä¸ªæ¡†.')]),s._v(" "),t("p",[s._v("è¿™é‡Œå‡è®¾ä¸€ä¸‹, è¿™ä¸ªç”¨æˆ·è¿›ç¨‹åœ¨è¯»å–æ•°æ®ä¹‹å, æ²¡äº‹å¯åšå°±"),t("strong",[s._v("ä¼‘çœ ")]),s._v('äº†. å¹¶ä¸”å¯ä»¥è¿›ä¸€æ­¥å‡è®¾, è¿™æ—¶åœ¨è¿™ä¸ª CPU ä¸Šä¹Ÿæ²¡æœ‰å…¶ä»–éœ€è¦è¿è¡Œçš„è¿›ç¨‹äº†, é‚£ä¹ˆç³»ç»Ÿå°±ä¼šè¿›å…¥ "id" è¿™ä¸ªæ­¥éª¤, ä¹Ÿå°±æ˜¯ç¬¬å…­ä¸ªæ¡†.  '),t("mark",[t("strong",[s._v('"id" æ˜¯ "idle" çš„ç¼©å†™, ä»£è¡¨ç³»ç»Ÿå¤„äºç©ºé—²çŠ¶æ€')])]),s._v(".")]),s._v(" "),t("p",[s._v("å¦‚æœè¿™æ—¶è¿™å°æœºå™¨åœ¨ç½‘ç»œæ”¶åˆ°ä¸€ä¸ª"),t("strong",[s._v("ç½‘ç»œæ•°æ®åŒ…")]),s._v(', ç½‘å¡å°±ä¼šå‘å‡ºä¸€ä¸ªä¸­æ–­(interrupt). ç›¸åº”åœ°, CPU ä¼šå“åº”ä¸­æ–­, ç„¶åè¿›å…¥ä¸­æ–­æœåŠ¡ç¨‹åº. è¿™æ—¶ CPU å°±ä¼šè¿›å…¥ "hi", ä¹Ÿå°±æ˜¯ç¬¬ä¸ƒä¸ªæ¡†.  '),t("strong",[s._v('"hi" æ˜¯ "hardware irq" çš„ç¼©å†™, ä»£è¡¨ CPU å¤„ç†ç¡¬ä¸­æ–­çš„å¼€é”€')]),s._v(". ç”±äºä¸­æ–­æœåŠ¡å¤„ç†éœ€è¦å…³é—­ä¸­æ–­, æ‰€ä»¥è¿™ä¸ªç¡¬ä¸­æ–­çš„æ—¶é—´ä¸èƒ½å¤ªé•¿.")]),s._v(" "),t("p",[s._v("ä½†æ˜¯, å‘ç”Ÿä¸­æ–­åçš„å·¥ä½œæ˜¯å¿…é¡»è¦å®Œæˆçš„, å¦‚æœè¿™äº›å·¥ä½œæ¯”è¾ƒè€—æ—¶é‚£æ€ä¹ˆåŠå‘¢? Linux ä¸­æœ‰ä¸€ä¸ª"),t("strong",[s._v("è½¯ä¸­æ–­")]),s._v("çš„æ¦‚å¿µ(softirq), å®ƒå¯ä»¥å®Œæˆè¿™äº›"),t("strong",[s._v("è€—æ—¶æ¯”è¾ƒé•¿")]),s._v("çš„å·¥ä½œ. å¯ä»¥è¿™æ ·ç†è§£è¿™ä¸ªè½¯ä¸­æ–­, "),t("strong",[s._v("ä»ç½‘å¡æ”¶åˆ°æ•°æ®åŒ…çš„å¤§éƒ¨åˆ†å·¥ä½œ, éƒ½æ˜¯é€šè¿‡è½¯ä¸­æ–­æ¥å¤„ç†çš„")]),s._v('. é‚£ä¹ˆ, CPU å°±ä¼šè¿›å…¥åˆ°ç¬¬å…«ä¸ªæ¡†, "si". '),t("mark",[t("strong",[s._v('è¿™é‡Œ "si" æ˜¯ "softirq" çš„ç¼©å†™, ä»£è¡¨ CPU å¤„ç†è½¯ä¸­æ–­çš„å¼€é”€')])]),s._v(".")]),s._v(" "),t("p",[s._v('è¿™é‡Œè¦æ³¨æ„, **æ— è®ºæ˜¯ "hi" è¿˜æ˜¯ "si", å®ƒä»¬çš„ CPU æ—¶é—´éƒ½ä¸ä¼šè®¡å…¥è¿›ç¨‹çš„ CPU æ—¶é—´. è¿™æ˜¯å› ä¸ºæœ¬èº«å®ƒä»¬åœ¨å¤„ç†çš„æ—¶å€™å°±ä¸å±äºä»»ä½•ä¸€ä¸ªè¿›ç¨‹. **')]),s._v(" "),t("p",[s._v("é€šè¿‡è¿™ä¸ªåœºæ™¯å‡è®¾, å°±å·²ç»ä»‹ç»äº†å¤§éƒ¨åˆ†çš„ Linux CPU ä½¿ç”¨. ä¸è¿‡, è¿˜å‰©ä¸¤ä¸ªç±»å‹çš„ CPU ä½¿ç”¨æ²¡è®²åˆ°, è¿™é‡Œåšä¸ªè¡¥å……, ä¸€æ¬¡æ€§å¸¦ä½ åšä¸ªå…¨é¢äº†è§£. è¿™æ ·ä»¥åè§£å†³ç›¸å…³é—®é¢˜æ—¶, å°±ä¸ä¼šå†çŠ¹è±«, è¿™äº›å€¼åˆ°åº•å½±ä¸å½±å“ CPU Cgroup ä¸­çš„é™åˆ¶äº†. ä¸‹é¢å…·ä½“è®²ä¸€ä¸‹.")]),s._v(" "),t("p",[s._v('ä¸€ä¸ªæ˜¯ "ni", æ˜¯ "nice" çš„ç¼©å†™, è¿™é‡Œ'),t("mark",[t("strong",[s._v("è¡¨ç¤ºå¦‚æœè¿›ç¨‹çš„ nice å€¼æ˜¯æ­£å€¼(1-19), ä»£è¡¨ä¼˜å…ˆçº§æ¯”è¾ƒä½çš„è¿›ç¨‹è¿è¡Œæ—¶æ‰€å ç”¨çš„ CPU")])]),s._v(".")]),s._v(" "),t("p",[s._v('å¦å¤–ä¸€ä¸ªæ˜¯ "st",  '),t("mark",[t("strong",[s._v('"st" æ˜¯ "steal" çš„ç¼©å†™, æ˜¯åœ¨è™šæ‹Ÿæœºé‡Œç”¨çš„ä¸€ä¸ª CPU ä½¿ç”¨ç±»å‹, è¡¨ç¤ºæœ‰å¤šå°‘æ—¶é—´æ˜¯è¢«åŒä¸€ä¸ªå®¿ä¸»æœºä¸Šçš„å…¶ä»–è™šæ‹ŸæœºæŠ¢èµ°çš„')])]),s._v(".")]),s._v(" "),t("p",[s._v("ç»¼åˆå‰é¢çš„å†…å®¹, å†ç”¨è¡¨æ ¼æ€»ç»“ä¸€ä¸‹:")]),s._v(" "),t("p",[t("img",{attrs:{src:"/img/bfff882d1d32e3d1d6b72eae52df2814-20230731161430-yw4ik9h.png",alt:""}})]),s._v(" "),t("h6",{attrs:{id:"_2-cpu-cgroup"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-cpu-cgroup"}},[s._v("#")]),s._v(" (2)CPU Cgroup")]),s._v(" "),t("p",[t("strong",[s._v("Cgroups æ˜¯å¯¹æŒ‡å®šè¿›ç¨‹åšè®¡ç®—æœºèµ„æºé™åˆ¶çš„, CPU Cgroup æ˜¯ Cgroups å…¶ä¸­çš„ä¸€ä¸ª Cgroups å­ç³»ç»Ÿ, å®ƒæ˜¯ç”¨æ¥é™åˆ¶è¿›ç¨‹çš„ CPU ä½¿ç”¨çš„.")])]),s._v(" "),t("p",[s._v("å¯¹äºè¿›ç¨‹çš„ CPU ä½¿ç”¨, é€šè¿‡å‰é¢çš„ Linux CPU ä½¿ç”¨åˆ†ç±»çš„ä»‹ç», çŸ¥é“å®ƒåªåŒ…å«ä¸¤éƒ¨åˆ†: "),t("strong",[s._v("ä¸€ä¸ªæ˜¯ç”¨æˆ·æ€, è¿™é‡Œçš„ç”¨æˆ·æ€åŒ…å«äº† us å’Œ ni; è¿˜æœ‰ä¸€éƒ¨åˆ†æ˜¯å†…æ ¸æ€, ä¹Ÿå°±æ˜¯ sy")]),s._v(". è‡³äº wa, hi, si, è¿™äº› I/O æˆ–è€…ä¸­æ–­ç›¸å…³çš„ CPU ä½¿ç”¨, "),t("mark",[t("strong",[s._v("CPU Cgroup ä¸ä¼šå»åšé™åˆ¶")])]),s._v(", é‚£ä¹ˆæ¥ä¸‹æ¥å°±æ¥çœ‹çœ‹ CPU Cgoup æ˜¯æ€ä¹ˆå·¥ä½œçš„?")]),s._v(" "),t("p",[t("strong",[s._v("æ¯ä¸ª Cgroups å­ç³»ç»Ÿéƒ½æ˜¯é€šè¿‡ä¸€ä¸ª")]),s._v("â€‹"),t("mark",[t("strong",[s._v("è™šæ‹Ÿæ–‡ä»¶ç³»ç»ŸæŒ‚è½½ç‚¹")])]),s._v("â€‹"),t("strong",[s._v("çš„æ–¹å¼, æŒ‚åˆ°ä¸€ä¸ªç¼ºçœçš„ç›®å½•ä¸‹, CPU Cgroup ä¸€èˆ¬åœ¨ Linux å‘è¡Œç‰ˆé‡Œä¼šæ”¾åœ¨ "),t("strong",[s._v("â€‹ "),t("mark")]),s._v("/sys/fs/cgroup/cpu")]),s._v("â€‹ ** è¿™ä¸ªç›®å½•ä¸‹**. åœ¨è¿™ä¸ªå­ç³»ç»Ÿçš„ç›®å½•ä¸‹, "),t("strong",[s._v("æ¯ä¸ªæ§åˆ¶ç»„(Control Group) éƒ½æ˜¯ä¸€ä¸ªå­ç›®å½•, å„ä¸ªæ§åˆ¶ç»„ä¹‹é—´çš„å…³ç³»å°±æ˜¯ä¸€ä¸ªæ ‘çŠ¶çš„å±‚çº§å…³ç³»(hierarchy)")]),s._v(" .")]),s._v(" "),t("p",[s._v("æ¯”å¦‚è¯´, åœ¨å­ç³»ç»Ÿçš„æœ€é¡¶å±‚å¼€å§‹å»ºç«‹ä¸¤ä¸ªæ§åˆ¶ç»„(ä¹Ÿå°±æ˜¯å»ºç«‹ä¸¤ä¸ªç›®å½•)"),t("strong",[s._v("group1")]),s._v(" å’Œ "),t("strong",[s._v("group2")]),s._v(", ç„¶åå†åœ¨ group2 çš„ä¸‹é¢å†å»ºç«‹ä¸¤ä¸ªæ§åˆ¶ç»„ group3 å’Œ group4. è¿™æ ·æ“ä½œä»¥å, å°±å»ºç«‹äº†ä¸€ä¸ªæ ‘çŠ¶çš„æ§åˆ¶ç»„å±‚çº§, å¯ä»¥å‚è€ƒä¸‹é¢çš„ç¤ºæ„å›¾.")]),s._v(" "),t("p",[t("img",{attrs:{src:"/img/d74d6249f9de2cad802fccfeb878c890-20230731161430-zwfg6ky.png",alt:""}})]),s._v(" "),t("p",[s._v("é‚£ä¹ˆæ¯ä¸ªæ§åˆ¶ç»„é‡Œ, éƒ½æœ‰å“ªäº› CPU Cgroup ç›¸å…³çš„æ§åˆ¶ä¿¡æ¯å‘¢? è¿™é‡Œéœ€è¦çœ‹ä¸€ä¸‹"),t("strong",[s._v("æ¯ä¸ªæ§åˆ¶ç»„ç›®å½•ä¸­çš„å†…å®¹")]),s._v(":")]),s._v(" "),t("div",{staticClass:"language-yml line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-yml"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# pwd")]),s._v("\n/sys/fs/cgroup/cpu\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# mkdir group1 group2")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cd group2")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# mkdir group3 group4")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cd group3")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ls cpu.*")]),s._v("\ncpu.cfs_period_us  cpu.cfs_quota_us  cpu.rt_period_us  cpu.rt_runtime_us  cpu.shares  cpu.stat \n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br")])]),t("p",[s._v("è€ƒè™‘åˆ°åœ¨äº‘å¹³å°é‡Œ, å¤§éƒ¨åˆ†ç¨‹åºéƒ½ä¸æ˜¯å®æ—¶è°ƒåº¦çš„è¿›ç¨‹, è€Œæ˜¯"),t("strong",[s._v("æ™®é€šè°ƒåº¦")]),s._v("(SCHED_NORMAL)ç±»å‹è¿›ç¨‹, é‚£ä»€ä¹ˆæ˜¯æ™®é€šè°ƒåº¦ç±»å‹å‘¢?")]),s._v(" "),t("p",[s._v("å› ä¸ºæ™®é€šè°ƒåº¦çš„ç®—æ³•åœ¨ Linux ä¸­ç›®å‰æ˜¯ "),t("strong",[s._v("CFS")]),s._v(" (Completely Fair Scheduler, å³å®Œå…¨å…¬å¹³è°ƒåº¦å™¨). ä¸ºäº†æ–¹ä¾¿ç†è§£, å°±ç›´æ¥æ¥çœ‹ CPU Cgroup å’Œ CFS ç›¸å…³çš„å‚æ•°, ä¸€å…±æœ‰ä¸‰ä¸ª.")]),s._v(" "),t("p",[s._v("ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ "),t("mark",[t("strong",[s._v("cpu.cfs_period_us")])]),s._v(", å®ƒæ˜¯ CFS ç®—æ³•çš„ä¸€ä¸ª"),t("strong",[s._v("è°ƒåº¦å‘¨æœŸ")]),s._v(", ä¸€èˆ¬å®ƒçš„å€¼æ˜¯ 100000, ä»¥ microseconds ä¸ºå•ä½, ä¹Ÿå°± 100ms.")]),s._v(" "),t("p",[s._v("ç¬¬äºŒä¸ªå‚æ•°æ˜¯ "),t("mark",[t("strong",[s._v("cpu.cfs_quota_us")])]),s._v(", å®ƒè¡¨ç¤º CFS ç®—æ³•ä¸­, åœ¨ä¸€ä¸ªè°ƒåº¦å‘¨æœŸé‡Œ"),t("strong",[s._v("è¿™ä¸ªæ§åˆ¶ç»„è¢«å…è®¸çš„è¿è¡Œæ—¶é—´")]),s._v(", æ¯”å¦‚è¿™ä¸ªå€¼ä¸º 50000 æ—¶, å°±æ˜¯ 50ms. å¦‚æœç”¨è¿™ä¸ª"),t("strong",[s._v("å€¼å»é™¤ä»¥è°ƒåº¦å‘¨æœŸ")]),s._v("(ä¹Ÿå°±æ˜¯ cpu.cfs_period_us), 50ms/100ms = 0.5, è¿™æ ·è¿™ä¸ªæ§åˆ¶ç»„è¢«å…è®¸ä½¿ç”¨çš„ CPU æœ€å¤§é…é¢å°±æ˜¯ "),t("strong",[s._v("0.5 ä¸ª CPU")]),s._v(". ä»è¿™é‡Œèƒ½å¤Ÿçœ‹å‡º, cpu.cfs_quota_us æ˜¯ä¸€ä¸ª"),t("strong",[s._v("ç»å¯¹å€¼")]),s._v(". å¦‚æœè¿™ä¸ªå€¼æ˜¯ 200000, ä¹Ÿå°±æ˜¯ 200ms, é‚£ä¹ˆå®ƒé™¤ä»¥ period, ä¹Ÿå°±æ˜¯ 200ms/100ms=2. ç»“æœè¶…è¿‡äº† 1 ä¸ª CPU, è¿™å°±æ„å‘³ç€è¿™æ—¶æ§åˆ¶ç»„éœ€è¦ "),t("strong",[s._v("2 ä¸ª CPU")]),s._v(" çš„èµ„æºé…é¢.")]),s._v(" "),t("p",[s._v("ç¬¬ä¸‰ä¸ªå‚æ•°æ˜¯ "),t("mark",[t("strong",[s._v("cpu.shares")])]),s._v(". è¿™ä¸ªå€¼æ˜¯ CPU Cgroup å¯¹äº"),t("strong",[s._v("æ§åˆ¶ç»„ä¹‹é—´çš„ CPU åˆ†é…æ¯”ä¾‹")]),s._v(", å®ƒçš„ç¼ºçœå€¼æ˜¯ 1024. å‡è®¾å‰é¢åˆ›å»ºçš„ group3 ä¸­çš„ cpu.shares æ˜¯ 1024, è€Œ group4 ä¸­çš„ cpu.shares æ˜¯ 3072, é‚£ä¹ˆ group3:group4=1:3. è¿™ä¸ªæ¯”ä¾‹çš„æ„æ€æ˜¯, æ¯”å¦‚åœ¨ä¸€å° 4 ä¸ª CPU çš„æœºå™¨ä¸Š, å½“ group3 å’Œ group4 éƒ½"),t("strong",[s._v("éœ€è¦ 4 ä¸ª CPU çš„æ—¶å€™")]),s._v(", å®ƒä»¬å®é™…åˆ†é…åˆ°çš„ CPU åˆ†åˆ«æ˜¯è¿™æ ·çš„: group3 æ˜¯ 1 ä¸ª, group4 æ˜¯ 3 ä¸ª.")]),s._v(" "),t("p",[s._v("åˆšæ‰è®²äº† CPU Cgroup é‡Œçš„ä¸‰ä¸ªå…³é”®å‚æ•°, æ¥ä¸‹æ¥å°±é€šè¿‡å‡ ä¸ªä¾‹å­æ¥è¿›ä¸€æ­¥ç†è§£ä¸€ä¸‹, ä»£ç å¯ä»¥åœ¨è¿™é‡Œæ‰¾åˆ°.")]),s._v(" "),t("p",[s._v("ç¬¬ä¸€ä¸ªä¾‹å­, å¯åŠ¨ä¸€ä¸ªæ¶ˆè€— 2 ä¸ª CPU(200%)çš„ç¨‹åº threads-cpu, ç„¶åæŠŠè¿™ä¸ªç¨‹åºçš„ pid åŠ å…¥åˆ° group3 çš„æ§åˆ¶ç»„é‡Œ:")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("./threads-cpu/threads-cpu "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$!")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" /sys/fs/cgroup/cpu/group2/group3/cgroup.procs\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("åœ¨æ²¡æœ‰ä¿®æ”¹ cpu.cfs_quota_us å‰, ç”¨ top å‘½ä»¤å¯ä»¥çœ‹åˆ° threads-cpu è¿™ä¸ªè¿›ç¨‹çš„ CPU ä½¿ç”¨æ˜¯ 199%, è¿‘ä¼¼ 2 ä¸ª CPU.")]),s._v(" "),t("p",[t("img",{attrs:{src:"/img/648acfbc5c65f5b8c71f97d89f5d57a3-20230731161430-pfg6ie3.png",alt:""}})]),s._v(" "),t("p",[s._v("ç„¶å, æ›´æ–°è¿™ä¸ªæ§åˆ¶ç»„é‡Œçš„ "),t("strong",[s._v("cpu.cfs_quota_us")]),s._v(", æŠŠå®ƒè®¾ç½®ä¸º 150000(150ms). æŠŠè¿™ä¸ªå€¼é™¤ä»¥ cpu.cfs_period_us, è®¡ç®—è¿‡ç¨‹æ˜¯ 150ms/100ms=1.5, ä¹Ÿå°±æ˜¯ 1.5 ä¸ª CPU, åŒæ—¶ä¹ŸæŠŠ cpu.shares è®¾ç½®ä¸º 1024.")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("150000")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" /sys/fs/cgroup/cpu/group2/group3/cpu.cfs_quota_us\n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1024")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" /sys/fs/cgroup/cpu/group2/group3/cpu.shares\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])]),t("p",[s._v("è¿™æ—¶å€™å†è¿è¡Œ top, å°±ä¼šå‘ç° threads-cpu è¿›ç¨‹çš„ CPU ä½¿ç”¨å‡å°åˆ°äº† 150%. è¿™æ˜¯å› ä¸ºè®¾ç½®çš„ cpu.cfs_quota_us èµ·äº†ä½œç”¨, "),t("strong",[s._v("é™åˆ¶äº†è¿›ç¨‹ CPU çš„ç»å¯¹å€¼")]),s._v(".")]),s._v(" "),t("p",[s._v("ä½†è¿™æ—¶å€™ cpu.shares çš„ä½œç”¨è¿˜æ²¡æœ‰å‘æŒ¥å‡ºæ¥, "),t("strong",[s._v("å› ä¸º cpu.shares æ˜¯å‡ ä¸ªæ§åˆ¶ç»„ä¹‹é—´çš„ CPU åˆ†é…æ¯”ä¾‹, è€Œä¸”ä¸€å®šè¦åˆ°æ•´ä¸ªèŠ‚ç‚¹ä¸­æ‰€æœ‰çš„ CPU éƒ½è·‘æ»¡çš„æ—¶å€™, å®ƒæ‰èƒ½å‘æŒ¥ä½œç”¨")]),s._v(".")]),s._v(" "),t("p",[t("img",{attrs:{src:"/img/1a78305f2b6e82c0af20d0d5ab107150-20230731161430-16b17sa.png",alt:""}})]),s._v(" "),t("p",[s._v("ä¸‹é¢å†æ¥è¿è¡Œç¬¬äºŒä¸ªä¾‹å­æ¥ç†è§£ cpu.shares. å…ˆæŠŠç¬¬ä¸€ä¸ªä¾‹å­é‡Œçš„ç¨‹åºå¯åŠ¨, åŒæ—¶æŒ‰å‰é¢çš„å†…å®¹, ä¸€æ­¥æ­¥è®¾ç½®å¥½ group3 é‡Œ cpu.cfs_quota_us å’Œ cpu.shares. è®¾ç½®å®Œæˆå, å†å¯åŠ¨ç¬¬äºŒä¸ªç¨‹åº, å¹¶ä¸”è®¾ç½®å¥½ group4 é‡Œçš„ "),t("strong",[s._v("cpu.cfs_quota_us å’Œ cpu.shares")]),s._v(".")]),s._v(" "),t("p",[s._v("group3:")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("./threads-cpu/threads-cpu "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# å¯åŠ¨ä¸€ä¸ªæ¶ˆè€—2ä¸ªCPUçš„ç¨‹åº")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$!")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" /sys/fs/cgroup/cpu/group2/group3/cgroup.procs "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#æŠŠç¨‹åºçš„pidåŠ å…¥åˆ°æ§åˆ¶ç»„")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("150000")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" /sys/fs/cgroup/cpu/group2/group3/cpu.cfs_quota_us "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#é™åˆ¶CPUä¸º1.5CPU")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1024")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" /sys/fs/cgroup/cpu/group2/group3/cpu.shares\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br")])]),t("p",[s._v("group4:")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("./threads-cpu/threads-cpu "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# å¯åŠ¨ä¸€ä¸ªæ¶ˆè€—4ä¸ªCPUçš„ç¨‹åº")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$!")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" /sys/fs/cgroup/cpu/group2/group4/cgroup.procs "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#æŠŠç¨‹åºçš„pidåŠ å…¥åˆ°æ§åˆ¶ç»„")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("350000")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" /sys/fs/cgroup/cpu/group2/group4/cpu.cfs_quota_us  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#é™åˆ¶CPUä¸º3.5CPU")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("3072")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" /sys/fs/cgroup/cpu/group2/group3/cpu.shares "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# shares æ¯”ä¾‹ group4: group3 = 3:1")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br")])]),t("p",[s._v("ç°åœ¨èŠ‚ç‚¹ä¸Šæ€»å…±æœ‰ 4 ä¸ª CPU, è€Œ group3 çš„ç¨‹åºéœ€è¦æ¶ˆè€— 2 ä¸ª CPU, group4 é‡Œçš„ç¨‹åºè¦æ¶ˆè€— 4 ä¸ª CPU.")]),s._v(" "),t("p",[s._v("å³ä½¿ cpu.cfs_quota_us å·²ç»é™åˆ¶äº†è¿›ç¨‹ CPU ä½¿ç”¨çš„ç»å¯¹å€¼, group3 çš„é™åˆ¶æ˜¯ 1.5CPU, group4 æ˜¯ 3.5CPU, 1.5+3.5=5, è¿™ä¸ªç»“æœè¿˜æ˜¯"),t("strong",[s._v("è¶…è¿‡")]),s._v("äº†èŠ‚ç‚¹ä¸Šçš„ 4 ä¸ª CPU.")]),s._v(" "),t("p",[s._v("å¥½äº†, åˆ°è¿™é‡Œå‘ç°åœ¨è¿™ç§æƒ…å†µä¸‹, "),t("strong",[s._v("cpu.shares")]),s._v(" ç»ˆäºå¼€å§‹èµ·ä½œç”¨äº†. åœ¨è¿™é‡Œ shares æ¯”ä¾‹æ˜¯ group4:group3=3:1, åœ¨æ€»å…± 4 ä¸ª CPU çš„èŠ‚ç‚¹ä¸Š, æŒ‰ç…§æ¯”ä¾‹, group4 é‡Œçš„è¿›ç¨‹åº”è¯¥åˆ†é…åˆ° 3 ä¸ª CPU, è€Œ group3 é‡Œçš„è¿›ç¨‹ä¼šåˆ†é…åˆ° 1 ä¸ª CPU.")]),s._v(" "),t("p",[s._v("ç”¨ top å¯ä»¥çœ‹ä¸€ä¸‹, ç»“æœå’Œé¢„æœŸçš„ä¸€æ ·.")]),s._v(" "),t("p",[t("img",{attrs:{src:"/img/3179672485e2359b63bb0d76413ff490-20230731161430-87z94mf.png",alt:""}})]),s._v(" "),t("p",[s._v("å¥½äº†å¯¹ CPU Cgroup çš„å‚æ•°åšä¸€ä¸ªæ¢³ç†.")]),s._v(" "),t("p",[s._v("ç¬¬ä¸€ç‚¹, "),t("mark",[s._v("cpu.cfs_quota_us å’Œ cpu.cfs_period_us è¿™ä¸¤ä¸ªå€¼å†³å®šäº†")]),s._v("â€‹"),t("mark",[t("strong",[s._v("æ¯ä¸ªæ§åˆ¶ç»„ä¸­æ‰€æœ‰è¿›ç¨‹çš„å¯ä½¿ç”¨ CPU èµ„æºçš„æœ€å¤§å€¼")])]),s._v("â€‹ **. **")]),s._v(" "),t("p",[s._v("ç¬¬äºŒç‚¹, "),t("mark",[s._v("cpu.shares è¿™ä¸ªå€¼å†³å®šäº† ")]),s._v("â€‹"),t("mark",[t("strong",[s._v("CPU Cgroup å­ç³»ç»Ÿä¸‹æ§åˆ¶ç»„å¯ç”¨ CPU çš„ç›¸å¯¹æ¯”ä¾‹")])]),s._v(", ä¸è¿‡åªæœ‰"),t("strong",[s._v("å½“ç³»ç»Ÿä¸Š CPU å®Œå…¨è¢«å æ»¡çš„æ—¶å€™, è¿™ä¸ªæ¯”ä¾‹æ‰ä¼šåœ¨å„ä¸ªæ§åˆ¶ç»„é—´èµ·ä½œç”¨")]),s._v(".")]),s._v(" "),t("h5",{attrs:{id:"_2-ç°è±¡è§£é‡Š"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-ç°è±¡è§£é‡Š"}},[s._v("#")]),s._v(" 2.ç°è±¡è§£é‡Š")]),s._v(" "),t("p",[s._v('åœ¨è§£é‡Šäº† Linux CPU Usage å’Œ CPU Cgroup è¿™ä¸¤ä¸ªåŸºæœ¬æ¦‚å¿µä¹‹å, å†å›åˆ°æˆ‘ä»¬æœ€åˆçš„é—®é¢˜ "æ€ä¹ˆé™åˆ¶å®¹å™¨çš„ CPU ä½¿ç”¨". æœ‰äº†åŸºç¡€çŸ¥è¯†çš„é“ºå«, è¿™ä¸ªé—®é¢˜å°±æ¯”è¾ƒå¥½è§£é‡Šäº†.')]),s._v(" "),t("p",[t("strong",[s._v("é¦–å…ˆ, Kubernetes ä¼šä¸ºæ¯ä¸ªå®¹å™¨éƒ½åœ¨ CPU Cgroup çš„å­ç³»ç»Ÿä¸­å»ºç«‹ä¸€ä¸ªæ§åˆ¶ç»„, ç„¶åæŠŠå®¹å™¨ä¸­è¿›ç¨‹å†™å…¥åˆ°è¿™ä¸ªæ§åˆ¶ç»„é‡Œ")]),s._v('. è¿™æ—¶å€™ "Limit CPU" å°±éœ€è¦ä¸ºå®¹å™¨è®¾ç½®å¯ç”¨ CPU çš„ä¸Šé™. ç»“åˆå‰é¢è®²çš„å‡ ä¸ªå‚æ•°, å°±èƒ½çŸ¥é“å®¹å™¨çš„ CPU ä¸Šé™å…·ä½“å¦‚ä½•è®¡ç®—äº†.')]),s._v(" "),t("p",[s._v("**å®¹å™¨ CPU çš„ä¸Šé™ç”± cpu.cfs_quota_us é™¤ä»¥ cpu.cfs_period_us å¾—å‡ºçš„å€¼æ¥å†³å®šçš„. è€Œä¸”åœ¨æ“ä½œç³»ç»Ÿé‡Œ, cpu.cfs_period_us çš„å€¼ä¸€èˆ¬æ˜¯ä¸ªå›ºå®šå€¼, Kubernetes ä¸ä¼šå»ä¿®æ”¹å®ƒ, æ‰€ä»¥å°±æ˜¯åªä¿®æ”¹ **â€‹"),t("mark",[t("strong",[s._v("cpu.cfs_quota_us")])]),s._v("â€‹ **. **")]),s._v(" "),t("p",[s._v('è€Œ "Request CPU" å°±æ˜¯æ— è®ºå…¶ä»–å®¹å™¨ç”³è¯·å¤šå°‘ CPU èµ„æº, å³ä½¿è¿è¡Œæ—¶æ•´ä¸ªèŠ‚ç‚¹çš„ CPU éƒ½è¢«å æ»¡çš„æƒ…å†µä¸‹, è¿™ä¸ªå®¹å™¨è¿˜æ˜¯å¯ä»¥ä¿è¯è·å¾—éœ€è¦çš„ CPU æ•°ç›®, é‚£ä¹ˆè¿™ä¸ªè®¾ç½®å…·ä½“è¦æ€ä¹ˆå®ç°å‘¢? æ˜¾ç„¶éœ€è¦è®¾ç½® cpu.shares è¿™ä¸ªå‚æ•°: **åœ¨ CPU Cgroup ä¸­ cpu.shares '),t("mark",[s._v(" 1024 è¡¨ç¤º 1 ä¸ª CPU çš„æ¯”ä¾‹, é‚£ä¹ˆ Request CPU çš„å€¼å°±æ˜¯ n, "),t("strong",[s._v("â€‹")])]),s._v("ç»™ cpu.shares çš„èµ‹å€¼å¯¹åº”å°±æ˜¯ n*1024==**â€‹ **. **")]),s._v(" "),t("h5",{attrs:{id:"_3-é‡ç‚¹æ€»ç»“-2"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-é‡ç‚¹æ€»ç»“-2"}},[s._v("#")]),s._v(" 3.é‡ç‚¹æ€»ç»“")]),s._v(" "),t("p",[s._v("æœ¬èŠ‚äº†è§£äº† Linux ä¸‹ CPU Usage çš„ç§ç±». è¿™é‡Œè¦æ³¨æ„çš„æ˜¯"),t("mark",[t("strong",[s._v("æ¯ä¸ªè¿›ç¨‹çš„ CPU Usage åªåŒ…å«ç”¨æˆ·æ€(us æˆ– ni)å’Œå†…æ ¸æ€(sy)ä¸¤éƒ¨åˆ†, å…¶ä»–çš„ç³»ç»Ÿ CPU å¼€é”€å¹¶ä¸åŒ…å«åœ¨è¿›ç¨‹çš„ CPU ä½¿ç”¨ä¸­, è€Œ CPU Cgroup åªæ˜¯å¯¹è¿›ç¨‹çš„ CPU ä½¿ç”¨åšäº†é™åˆ¶")])]),s._v("â€‹ **. **")]),s._v(" "),t("p",[s._v('å…¶å®è¿™ä¸€èŠ‚çš„é—®é¢˜ "æ€ä¹ˆé™åˆ¶å®¹å™¨çš„ CPU ä½¿ç”¨", è¿™ä¸ªé—®é¢˜èƒŒåéšè—äº†å¦ä¸€ä¸ªé—®é¢˜, ä¹Ÿå°±æ˜¯'),t("strong",[s._v("å®¹å™¨æ˜¯å¦‚ä½•è®¾ç½®å®ƒçš„ CPU Cgroup ä¸­å‚æ•°å€¼çš„")]),s._v("? æƒ³è§£å†³è¿™ä¸ªé—®é¢˜å°±è¦å…ˆçŸ¥é“ CPU Cgroup éƒ½æœ‰å“ªäº›å‚æ•°.")]),s._v(" "),t("p",[s._v("æ‰€ä»¥æœ¬èŠ‚è¯¦ç»†ä»‹ç»äº† CPU Cgroup ä¸­çš„ä¸»è¦å‚æ•°, åŒ…æ‹¬è¿™ä¸‰ä¸ª: **cpu.cfs_quota_us, cpu.cfs_period_us è¿˜æœ‰ cpu.shares. **")]),s._v(" "),t("p",[t("strong",[s._v("å…¶ä¸­ cpu.cfs_quota_us(ä¸€ä¸ªè°ƒåº¦å‘¨æœŸé‡Œè¿™ä¸ªæ§åˆ¶ç»„è¢«å…è®¸çš„è¿è¡Œæ—¶é—´)é™¤ä»¥ cpu.cfs_period_us(ç”¨äºè®¾ç½®è°ƒåº¦å‘¨æœŸ)å¾—åˆ°çš„è¿™ä¸ªå€¼å†³å®šäº† CPU Cgroup æ¯ä¸ªæ§åˆ¶ç»„ä¸­ CPU ä½¿ç”¨çš„ä¸Šé™å€¼. cpu.shares å‚æ•°å€¼å†³å®šäº† CPU Cgroup å­ç³»ç»Ÿä¸‹æ§åˆ¶ç»„å¯ç”¨ CPU çš„ç›¸å¯¹æ¯”ä¾‹, å½“ç³»ç»Ÿä¸Š CPU å®Œå…¨è¢«å æ»¡çš„æ—¶å€™, è¿™ä¸ªæ¯”ä¾‹æ‰ä¼šåœ¨å„ä¸ªæ§åˆ¶ç»„é—´èµ·æ•ˆ.")])]),s._v(" "),t("p",[s._v('æ˜ç™½äº† CPU Cgroup å…³é”®å‚æ•°æ˜¯ä»€ä¹ˆå«ä¹‰å, Kubernetes ä¸­ "Limit CPU" å’Œ "Request CPU" ä¹Ÿå°±å¾ˆå¥½è§£é‡Šäº†:')]),s._v(" "),t("p",[t("strong",[s._v("Limit CPU å°±æ˜¯å®¹å™¨æ‰€åœ¨ Cgroup æ§åˆ¶ç»„ä¸­çš„ CPU ä¸Šé™å€¼, Request CPU çš„å€¼å°±æ˜¯æ§åˆ¶ç»„ä¸­çš„ cpu.shares çš„å€¼.")])]),s._v(" "),t("h4",{attrs:{id:"_06-å®¹å™¨cpu-2-å¦‚ä½•æ­£ç¡®åœ°æ‹¿åˆ°å®¹å™¨cpuçš„å¼€é”€"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_06-å®¹å™¨cpu-2-å¦‚ä½•æ­£ç¡®åœ°æ‹¿åˆ°å®¹å™¨cpuçš„å¼€é”€"}},[s._v("#")]),s._v(" 06ï½œå®¹å™¨CPU(2):å¦‚ä½•æ­£ç¡®åœ°æ‹¿åˆ°å®¹å™¨CPUçš„å¼€é”€?")]),s._v(" "),t("p",[s._v("ä¸ºå•¥è¦è§£å†³è¿™ä¸ªé—®é¢˜å‘¢, è¿˜æ˜¯æ¥æºäºå®é™…å·¥ä½œä¸­çš„éœ€è¦. æ— è®ºæ˜¯å®¹å™¨çš„æ‰€æœ‰è€…è¿˜æ˜¯å®¹å™¨å¹³å°çš„ç®¡ç†è€…, æƒ³è¦ç²¾å‡†åœ°å¯¹è¿è¡Œç€ä¼—å¤šå®¹å™¨çš„äº‘å¹³å°åš"),t("strong",[s._v("ç›‘æ§")]),s._v(", å¿«é€Ÿæ’æŸ¥ä¾‹å¦‚åº”ç”¨çš„å¤„ç†èƒ½åŠ›ä¸‹é™, èŠ‚ç‚¹è´Ÿè½½è¿‡é«˜ç­‰é—®é¢˜, å°±ç»•ä¸å¼€å®¹å™¨ CPU å¼€é”€. **å› ä¸º CPU å¼€é”€çš„å¼‚å¸¸, å¾€å¾€æ˜¯ç¨‹åºå¼‚å¸¸æœ€æ˜æ˜¾çš„ä¸€ä¸ªæŒ‡æ ‡. **")]),s._v(" "),t("p",[s._v("åœ¨ä¸€å°ç‰©ç†æœºå™¨æˆ–è€…è™šæ‹Ÿæœºé‡Œ, å¦‚æœæƒ³å¾—åˆ°è¿™ä¸ªèŠ‚ç‚¹çš„ CPU ä½¿ç”¨ç‡, æœ€å¸¸ç”¨çš„å‘½ä»¤å°±æ˜¯ top äº†å§? top ä¸€ä¸‹å­å°±èƒ½çœ‹åˆ°æ•´ä¸ªèŠ‚ç‚¹å½“å‰çš„ CPU ä½¿ç”¨æƒ…å†µ. é‚£ä¹ˆåœ¨å®¹å™¨é‡Œ, top å‘½ä»¤ä¹Ÿå¯ä»¥åšåˆ°è¿™ç‚¹å—? æƒ³è¦çŸ¥é“ç­”æ¡ˆ, è¿˜æ˜¯å¾—å®é™…åŠ¨æ‰‹è¯•ä¸€è¯•.")]),s._v(" "),t("h5",{attrs:{id:"_1-é—®é¢˜é‡ç°"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-é—®é¢˜é‡ç°"}},[s._v("#")]),s._v(" 1.é—®é¢˜é‡ç°")]),s._v(" "),t("p",[s._v("å®é™…ä¸Šåœ¨ä½¿ç”¨å®¹å™¨çš„æ—¶å€™, å¦‚æœè¿è¡Œ top å‘½ä»¤æ¥æŸ¥çœ‹å½“å‰å®¹å™¨æ€»å…±ä½¿ç”¨äº†å¤šå°‘ CPU, ä½ è‚¯å®šé©¬ä¸Šå°±ä¼šå¤±æœ›äº†. è¿™æ˜¯å› ä¸º"),t("mark",[t("strong",[s._v('åœ¨å®¹å™¨ä¸­è¿è¡Œ top å‘½ä»¤, è™½ç„¶å¯ä»¥çœ‹åˆ°å®¹å™¨ä¸­æ¯ä¸ªè¿›ç¨‹çš„ CPU ä½¿ç”¨ç‡, ä½†æ˜¯ top ä¸­ "%Cpu(s)" é‚£ä¸€è¡Œä¸­æ˜¾ç¤ºçš„æ•°å€¼, å¹¶ä¸æ˜¯è¿™ä¸ªå®¹å™¨çš„ CPU æ•´ä½“ä½¿ç”¨ç‡, è€Œæ˜¯å®¹å™¨å®¿ä¸»æœºçš„ CPU ä½¿ç”¨ç‡')])]),s._v(".")]),s._v(" "),t("p",[s._v('å°±åƒä¸‹é¢çš„è¿™ä¸ªä¾‹å­, åœ¨ä¸€ä¸ª 12 ä¸ª CPU çš„å®¿ä¸»æœºä¸Š, å¯åŠ¨ä¸€ä¸ªå®¹å™¨, ç„¶ååœ¨å®¹å™¨é‡Œè¿è¡Œ top å‘½ä»¤. è¿™æ—¶å¯ä»¥çœ‹åˆ°, å®¹å™¨é‡Œæœ‰ä¸¤ä¸ªè¿›ç¨‹ threads-cpu, æ€»å…±æ¶ˆè€—äº† 200% çš„ CPU(2 CPU Usage), è€Œ "%Cpu(s)" é‚£ä¸€è¡Œçš„ "us cpu" æ˜¯ 58.5%. å¯¹äº 12CPU çš„ç³»ç»Ÿæ¥è¯´, 12 * 58.5%=7.02, ä¹Ÿå°±æ˜¯è¯´è¿™é‡Œæ˜¾ç¤ºæ€»å…±æ¶ˆè€—äº† 7 ä¸ª CPU, è¿œè¿œå¤§äºå®¹å™¨ä¸­ 2 ä¸ª CPU çš„æ¶ˆè€—.')]),s._v(" "),t("p",[t("img",{attrs:{src:"/img/4935329c612a16fcb3c8e9e776eff064-20230731161430-ge0qqkg.png",alt:""}})]),s._v(" "),t("p",[s._v("è¿™ä¸ªä¾‹å­è¯´æ˜, **top è¿™ä¸ªå·¥å…·è™½ç„¶åœ¨ç‰©ç†æœºæˆ–è€…è™šæ‹Ÿæœºä¸Šçœ‹å¾—åˆ°ç³»ç»Ÿ CPU å¼€é”€, ä½†æ˜¯å¦‚æœæ˜¯æ”¾åœ¨å®¹å™¨ç¯å¢ƒä¸‹, **â€‹"),t("mark",[t("strong",[s._v("è¿è¡Œ top å°±æ— æ³•å¾—åˆ°å®¹å™¨ä¸­æ€»çš„ CPU ä½¿ç”¨ç‡")])]),s._v(". é‚£ä¹ˆè¿˜æœ‰ä»€ä¹ˆå…¶ä»–çš„åŠæ³•å—?")]),s._v(" "),t("h5",{attrs:{id:"_2-è¿›ç¨‹cpuä½¿ç”¨ç‡å’Œç³»ç»Ÿcpuä½¿ç”¨ç‡"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-è¿›ç¨‹cpuä½¿ç”¨ç‡å’Œç³»ç»Ÿcpuä½¿ç”¨ç‡"}},[s._v("#")]),s._v(" 2.è¿›ç¨‹CPUä½¿ç”¨ç‡å’Œç³»ç»ŸCPUä½¿ç”¨ç‡")]),s._v(" "),t("p",[s._v("é€šè¿‡é—®é¢˜é‡ç°, å‘ç° "),t("strong",[s._v("top å·¥å…·ä¸»è¦æ˜¾ç¤ºäº†å®¿ä¸»æœºç³»ç»Ÿæ•´ä½“çš„ CPU ä½¿ç”¨ç‡, ä»¥åŠå•ä¸ªè¿›ç¨‹çš„ CPU ä½¿ç”¨ç‡")]),s._v(". æ—¢ç„¶æ²¡æœ‰ç°æˆçš„å·¥å…·å¯ä»¥å¾—åˆ°å®¹å™¨ CPU å¼€é”€, é‚£éœ€è¦è‡ªå·±å¼€å‘ä¸€ä¸ªå·¥å…·æ¥è§£å†³é—®é¢˜äº†.")]),s._v(" "),t("p",[s._v("å…¶å®è‡ªå·±æ¨å¯¼, ä¹Ÿæ²¡æœ‰é‚£ä¹ˆéš¾, æœ€æœ‰æ•ˆçš„æ€è·¯è¿˜æ˜¯ä»åŸç†ä¸Šå»ç†è§£é—®é¢˜. æ‰€ä»¥åœ¨è§£å†³æ€æ ·å¾—åˆ°å•ä¸ªå®¹å™¨æ•´ä½“çš„ CPU ä½¿ç”¨ç‡è¿™ä¸ªé—®é¢˜ä¹‹å‰, å…ˆæ¥å­¦ä¹ ä¸€ä¸‹, åœ¨ Linux ä¸­åˆ°åº•æ˜¯"),t("strong",[s._v("å¦‚ä½•è®¡ç®—å•ä¸ªè¿›ç¨‹çš„ CPU ä½¿ç”¨ç‡, è¿˜æœ‰æ•´ä¸ªç³»ç»Ÿçš„ CPU ä½¿ç”¨ç‡çš„")]),s._v(".")]),s._v(" "),t("h6",{attrs:{id:"_1-è¿›ç¨‹cpuä½¿ç”¨ç‡"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-è¿›ç¨‹cpuä½¿ç”¨ç‡"}},[s._v("#")]),s._v(" (1)è¿›ç¨‹CPUä½¿ç”¨ç‡")]),s._v(" "),t("p",[s._v("Linux ä¸­"),t("strong",[s._v("æ¯ä¸ªè¿›ç¨‹")]),s._v("çš„ CPU ä½¿ç”¨ç‡, éƒ½å¯ä»¥ç”¨ "),t("strong",[s._v("top")]),s._v(' å‘½ä»¤æŸ¥çœ‹. å¯¹ç…§å‰é¢çš„é‚£å¼ ç¤ºæ„å›¾, å¯ä»¥å‘ç°, æ¯ä¸ªè¿›ç¨‹åœ¨ top å‘½ä»¤è¾“å‡ºä¸­éƒ½æœ‰å¯¹åº”çš„ä¸€è¡Œ, ç„¶å "%CPU" çš„é‚£ä¸€åˆ—å°±æ˜¯'),t("strong",[s._v("è¿™ä¸ªè¿›ç¨‹çš„å®æ—¶ CPU ä½¿ç”¨ç‡")]),s._v("äº†. æ¯”å¦‚, 100% å°±è¡¨ç¤ºè¿™ä¸ªè¿›ç¨‹åœ¨è¿™ä¸ª"),t("strong",[s._v("ç¬æ—¶")]),s._v("ä½¿ç”¨äº† 1 ä¸ª CPU, 200% å°±æ˜¯ä½¿ç”¨äº† 2 ä¸ª CPU. é‚£ä¹ˆè¿™ä¸ªç™¾åˆ†æ¯”çš„æ•°å€¼æ˜¯æ€ä¹ˆå¾—åˆ°å‘¢?")]),s._v(" "),t("p",[s._v("æœ€ç›´æ¥çš„æ–¹æ³•, å°±æ˜¯"),t("strong",[s._v("ä»æºå¤´å¼€å§‹å¯»æ‰¾ç­”æ¡ˆ")]),s._v(". å› ä¸ºæ˜¯ top å‘½ä»¤çš„è¾“å‡º, å¯ä»¥å»çœ‹ä¸€ä¸‹ top å‘½ä»¤çš„æºä»£ç . åœ¨ä»£ç ä¸­ä¼šçœ‹åˆ°å¯¹äºæ¯ä¸ªè¿›ç¨‹, "),t("mark",[t("strong",[s._v("top éƒ½ä¼šä» proc æ–‡ä»¶ç³»ç»Ÿä¸­æ¯ä¸ªè¿›ç¨‹å¯¹åº”çš„ stat æ–‡ä»¶ä¸­è¯»å– 2 ä¸ªæ•°å€¼")])]),s._v(".")]),s._v(" "),t("p",[s._v("å…ˆæ¥çœ‹è¿™ä¸ªæ–‡ä»¶, å†æ¥è§£è¯»æ–‡ä»¶ä¸­å…·ä½“çš„ä¸¤ä¸ªæ•°å€¼. è¿™ä¸ª stat æ–‡ä»¶å°±æ˜¯ "),t("code",[s._v("/proc/[pid]/stat")]),s._v("â€‹,  "),t("code",[s._v("[pid]")]),s._v("â€‹ å°±æ˜¯æ›¿æ¢æˆå…·ä½“ä¸€ä¸ªè¿›ç¨‹çš„ PID å€¼. æ¯”å¦‚ PID å€¼ä¸º 1 çš„è¿›ç¨‹, è¿™ä¸ªæ–‡ä»¶å°±æ˜¯ "),t("code",[s._v("/proc/1/stat")]),s._v("â€‹, é‚£ä¹ˆè¿™ä¸ª "),t("code",[s._v("/proc/[pid]/stat")]),s._v("â€‹ æ–‡ä»¶é‡Œæœ‰ä»€ä¹ˆä¿¡æ¯å‘¢?")]),s._v(" "),t("p",[s._v("å…¶å®è¿™ä¸ª stat æ–‡ä»¶"),t("mark",[t("strong",[s._v("å®æ—¶è¾“å‡ºäº†è¿›ç¨‹çš„çŠ¶æ€ä¿¡æ¯")])]),s._v(", æ¯”å¦‚è¿›ç¨‹çš„"),t("strong",[s._v("è¿è¡Œæ€")]),s._v("(Running è¿˜æ˜¯ Sleeping), "),t("strong",[s._v("çˆ¶è¿›ç¨‹ PID, è¿›ç¨‹ä¼˜å…ˆçº§, è¿›ç¨‹ä½¿ç”¨çš„å†…å­˜")]),s._v("ç­‰ç­‰æ€»å…± 50 å¤šé¡¹.")]),s._v(" "),t("p",[s._v("å®Œæ•´çš„ stat æ–‡ä»¶å†…å®¹å’Œæ ¼å¼åœ¨ proc æ–‡ä»¶ç³»ç»Ÿçš„ Linux programmerâ€™s manual é‡Œå®šä¹‰äº†. åœ¨è¿™é‡Œåªéœ€è¦é‡ç‚¹å…³æ³¨è¿™ä¸¤é¡¹æ•°å€¼, stat æ–‡ä»¶ä¸­çš„ç¬¬ 14 é¡¹ "),t("strong",[s._v("utime")]),s._v(" å’Œç¬¬ 15 é¡¹ "),t("strong",[s._v("stime")]),s._v(".")]),s._v(" "),t("p",[t("img",{attrs:{src:"/img/310f6276c98436dfd1d8bce2a2354740-20230731161430-7nea83u.png",alt:""}})]),s._v(" "),t("p",[s._v("é‚£ä¹ˆè¿™ä¸¤é¡¹æ•°å€¼ utime å’Œ stime æ˜¯ä»€ä¹ˆå«ä¹‰å‘¢? "),t("mark",[t("strong",[s._v("utime æ˜¯è¡¨ç¤ºè¿›ç¨‹çš„ç”¨æˆ·æ€éƒ¨åˆ†åœ¨ Linux è°ƒåº¦ä¸­è·å¾— CPU çš„ ticks, stime æ˜¯è¡¨ç¤ºè¿›ç¨‹çš„å†…æ ¸æ€éƒ¨åˆ†åœ¨ Linux è°ƒåº¦ä¸­è·å¾— CPU çš„ ticks")])]),s._v(".")]),s._v(" "),t("p",[s._v("çœ‹åˆ°è¿™ä¸ªè§£é‡Š, ä½ å¯èƒ½åˆå†’å‡ºä¸€ä¸ªæ–°é—®é¢˜, ç–‘æƒ‘ ticks æ˜¯ä»€ä¹ˆ? "),t("strong",[s._v("è¿™ä¸ª ticks å°±æ˜¯ Linux æ“ä½œç³»ç»Ÿä¸­çš„ä¸€ä¸ªæ—¶é—´å•ä½")]),s._v(", å¯ä»¥ç†è§£æˆç±»ä¼¼ç§’, æ¯«ç§’çš„æ¦‚å¿µ. åœ¨ Linux ä¸­æœ‰ä¸ªè‡ªå·±çš„æ—¶é’Ÿ, å®ƒä¼šå‘¨æœŸæ€§åœ°äº§ç”Ÿä¸­æ–­. æ¯æ¬¡ä¸­æ–­éƒ½ä¼šè§¦å‘ Linux å†…æ ¸å»åšä¸€æ¬¡è¿›ç¨‹è°ƒåº¦, è€Œè¿™"),t("strong",[s._v("ä¸€æ¬¡ä¸­æ–­å°±æ˜¯ä¸€ä¸ª tick")]),s._v(". å› ä¸ºæ˜¯å‘¨æœŸæ€§çš„ä¸­æ–­, æ¯”å¦‚ 1 ç§’é’Ÿ 100 æ¬¡ä¸­æ–­, é‚£ä¹ˆä¸€ä¸ª tick ä½œä¸ºä¸€ä¸ªæ—¶é—´å•ä½çœ‹çš„è¯, ä¹Ÿå°±æ˜¯ 1/100 ç§’.")]),s._v(" "),t("p",[s._v("ä¸¾ä¸ªä¾‹å­, å‡å¦‚è¿›ç¨‹çš„ utime æ˜¯ 130 ticks, å°±ç›¸å½“äº 130 * 1/100=1.3 ç§’, ä¹Ÿå°±æ˜¯è¿›ç¨‹ä»å¯åŠ¨å¼€å§‹åœ¨ç”¨æˆ·æ€æ€»å…±è¿è¡Œäº† 1.3 ç§’é’Ÿ.")]),s._v(" "),t("p",[s._v("è¿™é‡Œéœ€è¦æ³¨æ„, "),t("strong",[s._v("utime å’Œ stime éƒ½æ˜¯ä¸€ä¸ªç´¯è®¡å€¼, ä¹Ÿå°±æ˜¯è¯´ä»è¿›ç¨‹å¯åŠ¨å¼€å§‹, è¿™ä¸¤ä¸ªå€¼å°±æ˜¯ä¸€ç›´åœ¨ç´¯ç§¯å¢é•¿çš„")]),s._v(".")]),s._v(" "),t("p",[s._v("é‚£ä¹ˆæ€ä¹ˆè®¡ç®—, æ‰èƒ½çŸ¥é“"),t("strong",[s._v("æŸä¸€è¿›ç¨‹åœ¨ç”¨æˆ·æ€å’Œå†…æ ¸æ€")]),s._v("ä¸­, åˆ†åˆ«è·å¾—äº†å¤šå°‘ CPU çš„ ticks å‘¢?")]),s._v(" "),t("p",[s._v("é¦–å…ˆ, å¯ä»¥å‡è®¾è¿™ä¸ªç¬æ—¶æ˜¯ 1 ç§’é’Ÿ, è¿™ 1 ç§’æ˜¯ T1 æ—¶åˆ»åˆ° T2 æ—¶åˆ»ä¹‹é—´çš„, é‚£ä¹ˆè¿™æ ·å°±èƒ½è·å¾— T1 æ—¶åˆ»çš„ utime_1 å’Œ stime_1, åŒæ—¶è·å¾— T2 æ—¶åˆ»çš„ utime_2 å’Œ stime_2. åœ¨è¿™ 1 ç§’çš„ç¬æ—¶, è¿›ç¨‹ç”¨æˆ·æ€è·å¾—çš„ CPU ticks å°±æ˜¯  "),t("strong",[s._v("(utime_2 â€“ utime_1)")]),s._v(" , è¿›ç¨‹å†…æ ¸æ€è·å¾—çš„ CPU ticks å°±æ˜¯  "),t("strong",[s._v("(stime_2 â€“ stime_1)")]),s._v(" . é‚£ä¹ˆå¯ä»¥æ¨å¯¼å‡º, "),t("strong",[s._v("è¿›ç¨‹ CPU æ€»çš„å¼€é”€å°±æ˜¯ç”¨æˆ·æ€åŠ ä¸Šå†…æ ¸æ€")]),s._v(", ä¹Ÿå°±æ˜¯åœ¨ 1 ç§’ç¬æ—¶è¿›ç¨‹æ€»çš„ CPU ticks ç­‰äº  "),t("strong",[s._v("(utime_2 â€“ utime_1) + (stime_2 â€“ stime_1)")]),s._v(" .")]),s._v(" "),t("p",[s._v("ç°åœ¨å¾—åˆ°äº†è¿›ç¨‹ä»¥ ticks ä¸ºå•ä½çš„ CPU å¼€é”€, æ¥ä¸‹æ¥è¿˜è¦åšä¸ªè½¬åŒ–. æ€æ ·æ‰èƒ½æŠŠè¿™ä¸ªå€¼è½¬åŒ–æˆç†Ÿæ‚‰çš„ç™¾åˆ†æ¯”å€¼å‘¢? å…¶å®ä¹Ÿä¸éš¾, è¿˜æ˜¯å¯ä»¥å» top çš„æºä»£ç é‡Œå¾—åˆ°è¿™ä¸ªç™¾åˆ†æ¯”çš„è®¡ç®—å…¬å¼.")]),s._v(" "),t("p",[s._v("ç®€å•æ€»ç»“ä¸€ä¸‹, è¿™ä¸ªå…¬å¼æ˜¯è¿™æ ·çš„:")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("è¿›ç¨‹çš„ CPU ä½¿ç”¨ç‡ "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token variable"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("((")]),s._v("utime_2 â€“ utime_1"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("stime_2 â€“ stime_1"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("))")])]),s._v(" * "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("100.0")]),s._v(" / "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("HZ * et * "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("è¿™ä¸ªå…¬å¼é‡Œæ¯ä¸€ä¸ªéƒ¨åˆ†çš„å«ä¹‰å¦‚ä¸‹.")]),s._v(" "),t("p",[s._v("é¦–å…ˆ,  ((utime_2 â€“ utime_1) + (stime_2 â€“ stime_1)) æ˜¯ç¬æ—¶è¿›ç¨‹"),t("strong",[s._v("æ€»çš„ CPU ticks")]),s._v(". è¿™ä¸ªå·²ç»åœ¨å‰é¢è§£é‡Šè¿‡äº†.")]),s._v(" "),t("p",[s._v("å…¶æ¬¡, æ¥çœ‹ 100.0, è¿™é‡Œä¹˜ä»¥ 100.0 çš„ç›®çš„æ˜¯äº§ç”Ÿç™¾åˆ†æ¯”æ•°å€¼.")]),s._v(" "),t("p",[s._v("æœ€åå†è®²ä¸€ä¸‹ (HZ * et * 1). è¿™æ˜¯è¢«é™¤æ•°è¿™é‡Œçš„ä¸‰ä¸ªå‚æ•°.")]),s._v(" "),t("p",[s._v("ç¬¬ä¸€ä¸ª HZ æ˜¯ä»€ä¹ˆæ„æ€å‘¢? å‰é¢ä»‹ç» ticks é‡Œè¯´äº†, ticks æ˜¯æŒ‰ç…§"),t("strong",[s._v("å›ºå®šé¢‘ç‡")]),s._v("å‘ç”Ÿçš„, åœ¨ Linux ç³»ç»Ÿé‡Œ 1 ç§’é’Ÿæ˜¯ 100 æ¬¡, é‚£ä¹ˆ "),t("strong",[s._v("HZ å°±æ˜¯ 1 ç§’é’Ÿé‡Œ ticks çš„æ¬¡æ•°")]),s._v(", è¿™é‡Œå€¼æ˜¯ 100.")]),s._v(" "),t("p",[s._v('ç¬¬äºŒä¸ªå‚æ•° et æ˜¯åˆšæ‰è¯´çš„é‚£ä¸ª "ç¬æ—¶" çš„æ—¶é—´, ä¹Ÿå°±æ˜¯å¾—åˆ° utime_1 å’Œ utime_2 è¿™ä¸¤ä¸ªå€¼çš„'),t("strong",[s._v("æ—¶é—´é—´éš”")]),s._v(".")]),s._v(" "),t("p",[s._v('ç¬¬ä¸‰ä¸ª "1", å°±æ›´å®¹æ˜“ç†è§£äº†, å°±æ˜¯ '),t("strong",[s._v("1 ä¸ª CPU")]),s._v(". é‚£ä¹ˆè¿™ä¸‰ä¸ªå€¼ç›¸ä¹˜, ä½ æ˜¯ä¸æ˜¯ä¹ŸçŸ¥é“äº†å®ƒçš„æ„æ€å‘¢? å°±æ˜¯"),t("strong",[s._v('åœ¨è¿™ "ç¬æ—¶" çš„æ—¶é—´(et)é‡Œ, 1 ä¸ª CPU æ‰€åŒ…å«çš„ ticks æ•°ç›®')]),s._v(".")]),s._v(" "),t("p",[s._v("è§£é‡Šäº†è¿™äº›å‚æ•°, å¯ä»¥æŠŠè¿™ä¸ªå…¬å¼ç®€åŒ–ä¸€ä¸‹:")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("è¿›ç¨‹çš„ CPU ä½¿ç”¨ç‡ "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("è¿›ç¨‹çš„ ticks / å•ä¸ª CPU æ€» ticks"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("*100.0\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("çŸ¥é“äº†è¿™ä¸ªå…¬å¼, å°±éœ€è¦ä¸Šæ‰‹æ¥"),t("strong",[s._v("éªŒè¯")]),s._v("ä¸€ä¸‹è¿™ä¸ªæ–¹æ³•å¯¹ä¸å¯¹, æ€ä¹ˆéªŒè¯å‘¢? å¯ä»¥å¯åŠ¨ä¸€ä¸ªæ¶ˆè€— CPU çš„å°ç¨‹åº, ç„¶åè¯»å–ä¸€ä¸‹è¿›ç¨‹å¯¹åº”çš„ "),t("code",[s._v("/proc/[pid]/stat")]),s._v("â€‹ ä¸­çš„ utime å’Œ stime, ç„¶åç”¨è¿™ä¸ªæ–¹æ³•æ¥è®¡ç®—ä¸€ä¸‹è¿›ç¨‹ä½¿ç”¨ç‡è¿™ä¸ªç™¾åˆ†æ¯”å€¼, å¹¶ä¸”å’Œ top çš„è¾“å‡ºå¯¹æ¯”ä¸€ä¸‹, çœ‹çœ‹æ˜¯å¦ä¸€è‡´.")]),s._v(" "),t("p",[s._v("å…ˆå¯åŠ¨ä¸€ä¸ªæ¶ˆè€— 200% çš„å°ç¨‹åº, å®ƒçš„ PID æ˜¯ 10021, CPU ä½¿ç”¨ç‡æ˜¯ 200%.")]),s._v(" "),t("p",[t("img",{attrs:{src:"/img/d7306643e9a0acec2784990d091ada72-20230731161430-mj7sjpp.png",alt:""}})]),s._v(" "),t("p",[s._v("ç„¶åæŸ¥çœ‹è¿™ä¸ªè¿›ç¨‹å¯¹åº”çš„ stat æ–‡ä»¶ /proc/10021/stat, é—´éš” 1 ç§’é’Ÿè¾“å‡ºç¬¬äºŒæ¬¡, å› ä¸º stat æ–‡ä»¶å†…å®¹å¾ˆå¤š, æˆ‘ä»¬çŸ¥é“ utime å’Œ stime ç¬¬ 14 å’Œ 15 é¡¹, æ‰€ä»¥è¿™é‡Œåªæˆªå–äº†å‰ 15 é¡¹çš„è¾“å‡º. å¯ä»¥çœ‹åˆ°, utime_1 = 399, stime_1=0, utime_2=600, stime_2=0.")]),s._v(" "),t("p",[t("img",{attrs:{src:"/img/7260c5c45e395f01c09d86440682f2e1-20230731161430-5e7jqji.png",alt:""}})]),s._v(" "),t("p",[s._v("æ ¹æ®å‰é¢çš„å…¬å¼, è®¡ç®—ä¸€ä¸‹è¿›ç¨‹ threads-cpu çš„ CPU ä½¿ç”¨ç‡. å¥—ç”¨å‰é¢çš„å…¬å¼, è®¡ç®—çš„è¿‡ç¨‹æ˜¯:")]),s._v(" "),t("p",[t("strong",[s._v("((600 â€“ 399) + (0 â€“ 0)) * 100.0 / (100 * 1 * 1) =201")]),s._v(", ä¹Ÿå°±æ˜¯ 201%. è¿™ä¸ªå€¼å’Œè¿è¡Œ top é‡Œçš„å€¼æ˜¯ä¸€æ ·çš„, ä¹Ÿå°±éªŒè¯äº†è¿™ä¸ªå…¬å¼æ˜¯æ²¡é—®é¢˜çš„.")]),s._v(" "),t("h6",{attrs:{id:"_2-ç³»ç»Ÿcpuä½¿ç”¨ç‡"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-ç³»ç»Ÿcpuä½¿ç”¨ç‡"}},[s._v("#")]),s._v(" (2)ç³»ç»ŸCPUä½¿ç”¨ç‡")]),s._v(" "),t("p",[s._v("å‰é¢ä»‹ç»äº† Linux ä¸­å¦‚ä½•è·å–å•ä¸ªè¿›ç¨‹çš„ CPU ä½¿ç”¨ç‡, ä¸‹é¢å†æ¥çœ‹çœ‹ Linux é‡Œæ˜¯"),t("strong",[s._v("æ€ä¹ˆè®¡ç®—ç³»ç»Ÿçš„æ•´ä½“ CPU ä½¿ç”¨ç‡")]),s._v("çš„.")]),s._v(" "),t("p",[s._v("å…¶å®çŸ¥é“äº†å¦‚ä½•è®¡ç®—å•ä¸ªè¿›ç¨‹çš„ CPU ä½¿ç”¨ç‡ä¹‹å, è¦ç†è§£ç³»ç»Ÿæ•´ä½“çš„ CPU ä½¿ç”¨ç‡è®¡ç®—æ–¹æ³•å°±ç®€å•å¤šäº†.")]),s._v(" "),t("p",[s._v("åŒæ ·è¦è®¡ç®— CPU ä½¿ç”¨ç‡, é¦–å…ˆéœ€è¦æ‹¿åˆ°æ•°æ®, æ•°æ®æºä¹ŸåŒæ ·å¯ä»¥ä» proc æ–‡ä»¶ç³»ç»Ÿé‡Œå¾—åˆ°, å¯¹äºæ•´ä¸ªç³»ç»Ÿçš„ CPU ä½¿ç”¨ç‡, è¿™ä¸ªæ–‡ä»¶å°±æ˜¯  "),t("strong",[s._v("/proc/stat")]),s._v(". åœ¨ /proc/stat æ–‡ä»¶çš„ "),t("code",[s._v("cpu")]),s._v('â€‹ è¿™è¡Œæœ‰ 10 åˆ—æ•°æ®, åŒæ ·å¯ä»¥åœ¨ proc æ–‡ä»¶ç³»ç»Ÿçš„ Linux programmerâ€™s manual é‡Œ, æ‰¾åˆ°æ¯ä¸€åˆ—æ•°æ®çš„å®šä¹‰, è€Œå‰ 8 åˆ—æ•°æ®æ­£å¥½å¯¹åº” top è¾“å‡ºä¸­ "%Cpu(s)" é‚£ä¸€è¡Œé‡Œçš„ 8 é¡¹æ•°æ®, ä¹Ÿå°±æ˜¯åœ¨ä¸Šä¸€è®²ä¸­, ä»‹ç»è¿‡çš„ '),t("strong",[s._v("user/system/nice/idle/iowait/irq/softirq/steal")]),s._v(" è¿™ 8 é¡¹.")]),s._v(" "),t("p",[t("img",{attrs:{src:"/img/efcac25bf71c8d307b6ebc991368e270-20230731161430-w3chjf9.png",alt:""}})]),s._v(" "),t("p",[s._v("è€Œåœ¨ /proc/stat é‡Œçš„æ¯ä¸€é¡¹çš„æ•°å€¼, å°±æ˜¯"),t("strong",[s._v("ç³»ç»Ÿè‡ªå¯åŠ¨å¼€å§‹çš„ ticks")]),s._v('. é‚£ä¹ˆè¦è®¡ç®—å‡º "ç¬æ—¶" çš„ CPU ä½¿ç”¨ç‡, é¦–å…ˆå°±è¦ç®—å‡ºè¿™ä¸ª "ç¬æ—¶" çš„ ticks, æ¯”å¦‚ 1 ç§’é’Ÿçš„ "ç¬æ—¶", å¯ä»¥è®°å½•å¼€å§‹æ—¶åˆ» T1 çš„ ticks, ç„¶åå†è®°å½• 1 ç§’é’Ÿå T2 æ—¶åˆ»çš„ ticks, å†æŠŠè¿™ä¸¤è€…ç›¸å‡, å°±å¯ä»¥å¾—åˆ°è¿™ 1 ç§’é’Ÿçš„ ticks äº†.')]),s._v(" "),t("p",[t("img",{attrs:{src:"/img/55c515d069f8439cbabe37acd103b4c6-20230731161430-jwrutiv.png",alt:""}})]),s._v(" "),t("p",[s._v("è¿™é‡Œå¯ä»¥å¾—åˆ°, åœ¨è¿™ 1 ç§’é’Ÿé‡Œæ¯ä¸ª CPU ä½¿ç”¨ç‡çš„ ticks:")]),s._v(" "),t("p",[t("img",{attrs:{src:"/img/093614b6496e075184d1294e976d98e5-20230731161430-lt919ny.png",alt:""}})]),s._v(" "),t("p",[s._v("æƒ³è¦è®¡ç®—æ¯ä¸€ç§ CPU ä½¿ç”¨ç‡çš„ç™¾åˆ†æ¯”, å…¶å®ä¹Ÿå¾ˆç®€å•. åªéœ€è¦æŠŠæ‰€æœ‰åœ¨è¿™ 1 ç§’é‡Œçš„ ticks ç›¸åŠ å¾—åˆ°ä¸€ä¸ªæ€»å€¼, ç„¶åæ‹¿æŸä¸€é¡¹çš„ ticks å€¼, é™¤ä»¥è¿™ä¸ªæ€»å€¼. æ¯”å¦‚è®¡ç®— idle CPU çš„ä½¿ç”¨ç‡å°±æ˜¯:")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1203")]),s._v(" / "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" + "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" + "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" + "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1203")]),s._v(" + "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" + "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" + "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" + "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("100")]),s._v("%\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("ç°åœ¨æ¥æ•´ä½“æ¢³ç†ä¸€ä¸‹, é€šè¿‡ Linux é‡Œçš„å·¥å…·, è¦æ€æ ·è®¡ç®—è¿›ç¨‹çš„ CPU ä½¿ç”¨ç‡å’Œç³»ç»Ÿçš„ CPU ä½¿ç”¨ç‡.")]),s._v(" "),t("p",[s._v("å¯¹äº"),t("strong",[s._v("å•ä¸ªè¿›ç¨‹")]),s._v("çš„ CPU ä½¿ç”¨ç‡è®¡ç®—, éœ€è¦è¯»å–å¯¹åº”è¿›ç¨‹çš„ "),t("code",[s._v("/proc/[pid]/stat")]),s._v("â€‹ æ–‡ä»¶, å°†è¿›ç¨‹"),t("strong",[s._v("ç¬æ—¶ç”¨æˆ·æ€å’Œå†…æ ¸æ€çš„ ticks æ•°ç›¸åŠ , å°±èƒ½å¾—åˆ°è¿›ç¨‹çš„æ€» ticks")]),s._v('. ç„¶åè¿ç”¨å…¬å¼ " '),t("strong",[s._v("(è¿›ç¨‹çš„ ticks / å•ä¸ª CPU æ€» ticks) * 100.0")]),s._v('" è®¡ç®—å‡ºè¿›ç¨‹ CPU ä½¿ç”¨ç‡çš„ç™¾åˆ†æ¯”å€¼.')]),s._v(" "),t("p",[s._v("**å¯¹äºç³»ç»Ÿçš„ CPU ä½¿ç”¨ç‡, éœ€è¦è¯»å– /proc/stat æ–‡ä»¶, å¾—åˆ°ç¬æ—¶å„é¡¹ CPU ä½¿ç”¨ç‡çš„ ticks å€¼, ç›¸åŠ å¾—åˆ°ä¸€ä¸ªæ€»å€¼, å•é¡¹å€¼é™¤ä»¥æ€»å€¼å°±æ˜¯å„é¡¹ CPU çš„ä½¿ç”¨ç‡. **")]),s._v(" "),t("h5",{attrs:{id:"_3-è§£å†³é—®é¢˜-2"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-è§£å†³é—®é¢˜-2"}},[s._v("#")]),s._v(" 3.è§£å†³é—®é¢˜")]),s._v(" "),t("p",[s._v("å‰é¢å­¦ä¹ äº†åœ¨ Linux ä¸­, top å·¥å…·æ˜¯æ€æ ·è®¡ç®—æ¯ä¸ªè¿›ç¨‹çš„ CPU ä½¿ç”¨ç‡, ä»¥åŠç³»ç»Ÿæ€»çš„ CPU ä½¿ç”¨ç‡. ç°åœ¨å†æ¥çœ‹æœ€åˆçš„é—®é¢˜: ä¸ºä»€ä¹ˆåœ¨å®¹å™¨ä¸­è¿è¡Œ top å‘½ä»¤ä¸èƒ½å¾—åˆ°å®¹å™¨ä¸­æ€»çš„ CPU ä½¿ç”¨ç‡?")]),s._v(" "),t("p",[s._v("è¿™å°±æ¯”è¾ƒå¥½è§£é‡Šäº†, "),t("strong",[s._v("å¯¹äºç³»ç»Ÿæ€»çš„ CPU ä½¿ç”¨ç‡, éœ€è¦è¯»å– /proc/stat æ–‡ä»¶, ä½†æ˜¯è¿™ä¸ªæ–‡ä»¶ä¸­çš„å„é¡¹ CPU ticks æ˜¯åæ˜ æ•´ä¸ªèŠ‚ç‚¹çš„, å¹¶ä¸”è¿™ä¸ª /proc/stat æ–‡ä»¶ä¹Ÿä¸åŒ…å«åœ¨ä»»æ„ä¸€ä¸ª Namespace é‡Œ")]),s._v(".")]),s._v(" "),t("p",[s._v("æ‰€ä»¥"),t("mark",[t("strong",[s._v("å¯¹äº top å‘½ä»¤æ¥è¯´, å®ƒåªèƒ½æ˜¾ç¤ºæ•´ä¸ªèŠ‚ç‚¹ä¸­å„é¡¹ CPU çš„ä½¿ç”¨ç‡, ä¸èƒ½æ˜¾ç¤ºå•ä¸ªå®¹å™¨çš„å„é¡¹ CPU çš„ä½¿ç”¨ç‡")])]),s._v(". æ—¢ç„¶ top å‘½ä»¤ä¸è¡Œ, è¿˜æœ‰æ²¡æœ‰åŠæ³•å¾—åˆ°æ•´ä¸ªå®¹å™¨çš„ CPU ä½¿ç”¨ç‡å‘¢?")]),s._v(" "),t("p",[s._v("ä¹‹å‰å·²ç»å­¦ä¹ è¿‡äº† CPU Cgroup, "),t("strong",[s._v("æ¯ä¸ªå®¹å™¨éƒ½ä¼šæœ‰ä¸€ä¸ª CPU Cgroup çš„æ§åˆ¶ç»„")]),s._v(". åœ¨è¿™ä¸ªæ§åˆ¶ç»„ç›®å½•ä¸‹é¢æœ‰å¾ˆå¤šå‚æ•°æ–‡ä»¶, æœ‰çš„å‚æ•°å¯ä»¥å†³å®šè¿™ä¸ªæ§åˆ¶ç»„é‡Œæœ€å¤§çš„ CPU å¯ä½¿ç”¨ç‡å¤–, é™¤äº†å®ƒä»¬ä¹‹å¤–, "),t("strong",[s._v("ç›®å½•ä¸‹é¢è¿˜æœ‰ä¸€ä¸ªå¯è¯»é¡¹ cpuacct.stat")]),s._v(".")]),s._v(" "),t("p",[s._v("è¿™é‡ŒåŒ…å«äº†"),t("strong",[s._v("ä¸¤ä¸ªç»Ÿè®¡å€¼")]),s._v(", è¿™ä¸¤ä¸ªå€¼åˆ†åˆ«æ˜¯"),t("mark",[t("strong",[s._v("è¿™ä¸ªæ§åˆ¶ç»„é‡Œæ‰€æœ‰è¿›ç¨‹çš„å†…æ ¸æ€ ticks å’Œç”¨æˆ·æ€çš„ ticks")])]),s._v(", é‚£ä¹ˆå°±å¯ä»¥ç”¨å‰é¢è®²è¿‡çš„å…¬å¼, ä¹Ÿå°±æ˜¯è®¡ç®—è¿›ç¨‹ CPU ä½¿ç”¨ç‡çš„å…¬å¼, å»è®¡ç®—æ•´ä¸ªå®¹å™¨çš„ CPU ä½¿ç”¨ç‡:")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("CPU ä½¿ç”¨ç‡ "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token variable"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("((")]),s._v("utime_2 â€“ utime_1"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("stime_2 â€“ stime_1"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("))")])]),s._v(" * "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("100.0")]),s._v(" / "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("HZ * et * "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("è¿˜æ˜¯ä»¥é—®é¢˜é‡ç°ä¸­çš„ä¾‹å­è¯´æ˜, ä¹Ÿå°±æ˜¯æœ€å¼€å§‹å¯åŠ¨å®¹å™¨é‡Œçš„é‚£ä¸¤ä¸ªå®¹å™¨ threads-cpu è¿›ç¨‹.")]),s._v(" "),t("p",[s._v("å°±åƒä¸‹å›¾æ˜¾ç¤ºçš„è¿™æ ·, æ•´ä¸ªå®¹å™¨çš„ CPU ä½¿ç”¨ç‡çš„ç™¾åˆ†æ¯”å°±æ˜¯ ((174021 - 173820) + (4 â€“ 4)) * 100.0 / (100 * 1 * 1) = 201, ä¹Ÿå°±æ˜¯ 201%. "),t("mark",[t("strong",[s._v("æ‰€ä»¥ä»æ¯ä¸ªå®¹å™¨çš„ CPU Cgroup æ§åˆ¶ç»„é‡Œçš„ cpuacct.stat çš„ç»Ÿè®¡å€¼ä¸­, å¯ä»¥æ¯”è¾ƒå¿«åœ°å¾—åˆ°æ•´ä¸ªå®¹å™¨çš„ CPU ä½¿ç”¨ç‡")])]),s._v(".")]),s._v(" "),t("p",[t("img",{attrs:{src:"/img/3a3560e07207c81d5b1fa0b052dbafc0-20230731161430-ntfauk4.png",alt:""}})]),s._v(" "),t("h5",{attrs:{id:"_4-é‡ç‚¹æ€»ç»“-3"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_4-é‡ç‚¹æ€»ç»“-3"}},[s._v("#")]),s._v(" 4.é‡ç‚¹æ€»ç»“")]),s._v(" "),t("p",[s._v("Linux é‡Œè·å– CPU ä½¿ç”¨ç‡çš„å·¥å…·, æ¯”å¦‚ top, éƒ½æ˜¯"),t("strong",[s._v("é€šè¿‡è¯»å– proc æ–‡ä»¶ç³»ç»Ÿä¸‹çš„ stat æ–‡ä»¶æ¥å¾—åˆ° CPU ä½¿ç”¨äº†å¤šå°‘ ticks")]),s._v(". è€Œè¿™é‡Œçš„ ticks, æ˜¯ Linux æ“ä½œç³»ç»Ÿé‡Œçš„ä¸€ä¸ªæ—¶é—´å•ä½, å¯ä»¥ç†è§£æˆç±»ä¼¼ç§’, æ¯«ç§’çš„æ¦‚å¿µ.")]),s._v(" "),t("p",[s._v("**å¯¹äºæ¯ä¸ªè¿›ç¨‹æ¥è¯´, å®ƒçš„ stat æ–‡ä»¶æ˜¯ /proc/[pid]/stat, é‡Œé¢åŒ…å«äº†è¿›ç¨‹ç”¨æˆ·æ€å’Œå†…æ ¸æ€çš„ ticks æ•°ç›®; å¯¹äºæ•´ä¸ªèŠ‚ç‚¹, å®ƒçš„ stat æ–‡ä»¶æ˜¯ /proc/stat, é‡Œé¢åŒ…å«äº† user/system/nice/idle/iowait ç­‰ä¸åŒ CPU å¼€é”€ç±»å‹çš„ ticks. **")]),s._v(" "),t("p",[t("mark",[t("strong",[s._v("ç”±äº /proc/stat æ–‡ä»¶æ˜¯æ•´ä¸ªèŠ‚ç‚¹å…¨å±€çš„çŠ¶æ€æ–‡ä»¶, ä¸å±äºä»»ä½•ä¸€ä¸ª Namespace, å› æ­¤åœ¨å®¹å™¨ä¸­æ— æ³•é€šè¿‡è¯»å– /proc/stat æ–‡ä»¶æ¥è·å–å•ä¸ªå®¹å™¨çš„ CPU ä½¿ç”¨ç‡.")])])]),s._v(" "),t("p",[s._v("æ‰€ä»¥è¦å¾—åˆ°å•ä¸ªå®¹å™¨çš„ CPU ä½¿ç”¨ç‡, å¯ä»¥ä» CPU Cgroup æ¯ä¸ª"),t("strong",[s._v("æ§åˆ¶ç»„é‡Œçš„ç»Ÿè®¡æ–‡ä»¶ cpuacct.stat")]),s._v(" ä¸­è·å–. **å•ä¸ªå®¹å™¨ CPU ä½¿ç”¨ç‡ =((utime_2 â€“ utime_1) + (stime_2 â€“ stime_1)) * 100.0 / (HZ * et * 1). **")]),s._v(" "),t("p",[s._v("å¾—åˆ°å•ä¸ªå®¹å™¨çš„ CPU çš„ä½¿ç”¨ç‡, é‚£ä¹ˆå½“å®¿ä¸»æœºä¸Šè´Ÿè½½å˜é«˜çš„æ—¶å€™, å°±å¯ä»¥å¾ˆå¿«çŸ¥é“æ˜¯"),t("strong",[s._v("å“ªä¸ªå®¹å™¨")]),s._v("å¼•èµ·çš„é—®é¢˜. åŒæ—¶ç”¨æˆ·åœ¨ç®¡ç†è‡ªå·±æˆç™¾ä¸Šåƒçš„å®¹å™¨çš„æ—¶å€™, ä¹Ÿå¯ä»¥å¾ˆå¿«å‘ç° CPU ä½¿ç”¨ç‡å¼‚å¸¸çš„å®¹å™¨, è¿™æ ·å°±èƒ½åŠæ—©åœ°ä»‹å…¥å»è§£å†³é—®é¢˜.")]),s._v(" "),t("h4",{attrs:{id:"_07-load-average-åŠ äº†cpu-cgroupé™åˆ¶-ä¸ºä»€ä¹ˆæˆ‘çš„å®¹å™¨è¿˜æ˜¯å¾ˆæ…¢"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_07-load-average-åŠ äº†cpu-cgroupé™åˆ¶-ä¸ºä»€ä¹ˆæˆ‘çš„å®¹å™¨è¿˜æ˜¯å¾ˆæ…¢"}},[s._v("#")]),s._v(" 07 | Load Average:åŠ äº†CPU Cgroupé™åˆ¶,ä¸ºä»€ä¹ˆæˆ‘çš„å®¹å™¨è¿˜æ˜¯å¾ˆæ…¢?")]),s._v(" "),t("p",[s._v("æœ¬èŠ‚èŠä¸€èŠå¹³å‡è´Ÿè½½(Load Average)çš„è¯é¢˜. ä¸Šä¸€è®²æåˆ°è¿‡ CPU Cgroup å¯ä»¥é™åˆ¶è¿›ç¨‹çš„ CPU èµ„æºä½¿ç”¨, ä½†æ˜¯ CPU Cgroup å¯¹å®¹å™¨çš„èµ„æºé™åˆ¶æ˜¯å­˜åœ¨ç›²ç‚¹çš„. ä»€ä¹ˆç›²ç‚¹å‘¢? å°±æ˜¯"),t("strong",[s._v("æ— æ³•é€šè¿‡ CPU Cgroup æ¥æ§åˆ¶ Load Average çš„å¹³å‡è´Ÿè½½. è€Œæ²¡æœ‰è¿™ä¸ªé™åˆ¶, å°±ä¼šå½±å“ç³»ç»Ÿèµ„æºçš„åˆç†è°ƒåº¦, å¾ˆå¯èƒ½å¯¼è‡´ç³»ç»Ÿå˜å¾—å¾ˆæ…¢")]),s._v(".")]),s._v(" "),t("p",[s._v("æœ¬èŠ‚è®²ä¸€ä¸‹ä¸ºä»€ä¹ˆåŠ äº† CPU Cgroup çš„é…ç½®å, å³ä½¿ä¿è¯äº†å®¹å™¨çš„ CPU èµ„æº, å®¹å™¨ä¸­çš„è¿›ç¨‹è¿˜æ˜¯ä¼šè¿è¡Œå¾—å¾ˆæ…¢?")]),s._v(" "),t("h5",{attrs:{id:"_1-é—®é¢˜å†ç°-3"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-é—®é¢˜å†ç°-3"}},[s._v("#")]),s._v(" 1.é—®é¢˜å†ç°")]),s._v(" "),t("p",[s._v("åœ¨ Linux çš„ç³»ç»Ÿç»´æŠ¤ä¸­, éœ€è¦ç»å¸¸æŸ¥çœ‹ CPU ä½¿ç”¨æƒ…å†µ, å†æ ¹æ®è¿™ä¸ªæƒ…å†µåˆ†æç³»ç»Ÿæ•´ä½“çš„è¿è¡ŒçŠ¶æ€. æœ‰æ—¶å€™ä½ å¯èƒ½ä¼šå‘ç°, æ˜æ˜å®¹å™¨é‡Œæ‰€æœ‰è¿›ç¨‹çš„ CPU ä½¿ç”¨ç‡éƒ½å¾ˆä½, ç”šè‡³"),t("strong",[s._v("æ•´ä¸ªå®¿ä¸»æœºçš„ CPU ä½¿ç”¨ç‡éƒ½å¾ˆä½, è€Œæœºå™¨çš„ Load Average é‡Œçš„å€¼å´å¾ˆé«˜, å®¹å™¨é‡Œè¿›ç¨‹è¿è¡Œå¾—ä¹Ÿå¾ˆæ…¢")]),s._v(".")]),s._v(" "),t("p",[s._v('è¿™ä¹ˆè¯´æœ‰äº›æŠ½è±¡, ä¸€èµ·åŠ¨æ‰‹å†ç°ä¸€ä¸‹è¿™ä¸ªæƒ…å†µ, å°±èƒ½æ›´å¥½åœ°ç†è§£è¿™ä¸ªé—®é¢˜äº†. æ¯”å¦‚è¯´ä¸‹é¢çš„ top è¾“å‡º, ç¬¬ä¸‰è¡Œå¯ä»¥æ˜¾ç¤ºå½“å‰çš„ CPU ä½¿ç”¨æƒ…å†µ, å¯ä»¥çœ‹åˆ°æ•´ä¸ªæœºå™¨çš„ CPU Usage å‡ ä¹ä¸º 0, å› ä¸º "id" æ˜¾ç¤º 99.9%, è¿™è¯´æ˜ CPU æ˜¯å¤„äº'),t("strong",[s._v("ç©ºé—²çŠ¶æ€")]),s._v('çš„. ä½†è¯·æ³¨æ„, è¿™é‡Œ 1 åˆ†é’Ÿçš„ "load average" çš„å€¼å´é«˜è¾¾ 9.09, è¿™é‡Œçš„æ•°å€¼ 9 å‡ ä¹å°±æ„å‘³ç€ä½¿ç”¨äº† 9 ä¸ª CPU äº†, è¿™æ · CPU Usage å’Œ Load Average çš„æ•°å€¼çœ‹ä¸Šå»å°±å¾ˆçŸ›ç›¾äº†.')]),s._v(" "),t("p",[t("img",{attrs:{src:"/img/29114db9f607f6409ce678bb27d852be-20230731161430-cuc9yoq.png",alt:""}})]),s._v(" "),t("p",[s._v("é‚£é—®é¢˜æ¥äº†, åœ¨çœ‹ä¸€ä¸ªç³»ç»Ÿé‡Œ CPU ä½¿ç”¨æƒ…å†µæ—¶, åˆ°åº•æ˜¯çœ‹ CPU Usage è¿˜æ˜¯ Load Average å‘¢? è¿™é‡Œå°±æ¶‰åŠåˆ°æœ¬èŠ‚è¦è§£å†³çš„ä¸¤å¤§é—®é¢˜: Load Average åˆ°åº•æ˜¯ä»€ä¹ˆ, CPU Usage å’Œ Load Average æœ‰ä»€ä¹ˆå·®åˆ«? å¦‚æœ Load Average å€¼å‡é«˜, åº”ç”¨çš„æ€§èƒ½ä¸‹é™äº†, è¿™èƒŒåçš„åŸå› æ˜¯ä»€ä¹ˆå‘¢?")]),s._v(" "),t("h5",{attrs:{id:"_2-ä»€ä¹ˆæ˜¯load-average"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-ä»€ä¹ˆæ˜¯load-average"}},[s._v("#")]),s._v(" 2.ä»€ä¹ˆæ˜¯Load Average?")]),s._v(" "),t("p",[s._v('Load Average è¿™ä¸ªæ¦‚å¿µ, å¯èƒ½åœ¨ä½¿ç”¨ Linux çš„æ—¶å€™å°±å·²ç»æ³¨æ„åˆ°äº†, æ— è®ºæ˜¯è¿è¡Œ uptime, è¿˜æ˜¯ top, éƒ½å¯ä»¥çœ‹åˆ°ç±»ä¼¼è¿™ä¸ªè¾“å‡º "'),t("strong",[s._v("load average")]),s._v(': 2.02, 1.83, 1.20". é‚£ä¹ˆè¿™ä¸€ä¸²è¾“å‡ºåˆ°åº•æ˜¯ä»€ä¹ˆæ„æ€å‘¢?')]),s._v(" "),t("p",[s._v('æœ€ç›´æ¥çš„åŠæ³•å½“ç„¶æ˜¯çœ‹æ‰‹å†Œäº†, å¦‚æœç”¨ "Linux manual page" æœç´¢ uptime æˆ–è€… top, å°±ä¼šçœ‹åˆ°å¯¹è¿™ä¸ª "load average" å’Œåé¢ä¸‰ä¸ªæ•°å­—çš„è§£é‡Šæ˜¯ "'),t("strong",[s._v("the system load averages for the past 1, 5, and 15 minutes")]),s._v('". è¿™ä¸ªè§£é‡Šå°±æ˜¯è¯´, åé¢çš„ä¸‰ä¸ªæ•°å€¼åˆ†åˆ«ä»£è¡¨'),t("strong",[s._v("è¿‡å» 1 åˆ†é’Ÿ, 5 åˆ†é’Ÿ, 15 åˆ†é’Ÿåœ¨è¿™ä¸ªèŠ‚ç‚¹ä¸Šçš„ Load Average")]),s._v(", ä½†æ˜¯çœ‹äº†æ‰‹å†Œä¸Šçš„è§£é‡Š, è¿˜æ˜¯ä¸èƒ½ç†è§£ä»€ä¹ˆæ˜¯ Load Average.")]),s._v(" "),t("p",[s._v("å¦‚æœå†å»ç½‘ä¸Šæ‰¾èµ„æ–™, å°±ä¼šå‘ç° Load Average æ˜¯ä¸€ä¸ªå¾ˆå¤è€çš„æ¦‚å¿µäº†. ä¸Šä¸ªä¸–çºª 70 å¹´ä»£, æ—©æœŸçš„ Unix ç³»ç»Ÿä¸Šå°±å·²ç»æœ‰äº†è¿™ä¸ª Load Average, IETF è¿˜æœ‰ä¸€ä¸ª RFC546 å®šä¹‰äº† Load Average, è¿™é‡Œå®šä¹‰çš„ Load Average æ˜¯**ä¸€ç§ CPU èµ„æºéœ€æ±‚çš„åº¦é‡.  ** ä¸¾ä¸ªä¾‹å­, "),t("strong",[s._v('å¯¹äºä¸€ä¸ªå•ä¸ª CPU çš„ç³»ç»Ÿ, å¦‚æœåœ¨ 1 åˆ†é’Ÿçš„æ—¶é—´é‡Œ, å¤„ç†å™¨ä¸Šå§‹ç»ˆæœ‰ä¸€ä¸ªè¿›ç¨‹åœ¨è¿è¡Œ, åŒæ—¶æ“ä½œç³»ç»Ÿçš„è¿›ç¨‹å¯è¿è¡Œé˜Ÿåˆ—ä¸­å§‹ç»ˆéƒ½æœ‰ 9 ä¸ªè¿›ç¨‹åœ¨ç­‰å¾…è·å– CPU èµ„æº. é‚£ä¹ˆå¯¹äºè¿™ 1 åˆ†é’Ÿçš„æ—¶é—´æ¥è¯´, ç³»ç»Ÿçš„ "load average" å°±æ˜¯ 1+9=10')]),s._v(", è¿™ä¸ªå®šä¹‰å¯¹ç»å¤§éƒ¨åˆ†çš„ Unix ç³»ç»Ÿéƒ½é€‚ç”¨.")]),s._v(" "),t("p",[s._v("å¯¹äº Linux æ¥è¯´, "),t("mark",[t("strong",[s._v("å¦‚æœåªè€ƒè™‘ CPU çš„èµ„æº, Load Averag ç­‰äºå•ä½æ—¶é—´å†…æ­£åœ¨è¿è¡Œçš„è¿›ç¨‹åŠ ä¸Šå¯è¿è¡Œé˜Ÿåˆ—çš„è¿›ç¨‹, è¿™ä¸ªå®šä¹‰ä¹Ÿæ˜¯æˆç«‹çš„")])]),s._v(". é€šè¿‡è¿™ä¸ªå®šä¹‰å½’çº³äº†ä¸‹é¢ä¸‰ç‚¹å¯¹ Load Average çš„ç†è§£.")]),s._v(" "),t("ul",[t("li",[s._v("ç¬¬ä¸€, ä¸è®ºè®¡ç®—æœº CPU æ˜¯ç©ºé—²è¿˜æ˜¯æ»¡è´Ÿè½½, Load Average éƒ½æ˜¯ Linux è¿›ç¨‹è°ƒåº¦å™¨ä¸­**å¯è¿è¡Œé˜Ÿåˆ—(Running Queue)é‡Œçš„ä¸€æ®µæ—¶é—´çš„å¹³å‡è¿›ç¨‹æ•°ç›®. **")]),s._v(" "),t("li",[s._v("ç¬¬äºŒ, è®¡ç®—æœºä¸Šçš„ "),t("strong",[s._v('CPU è¿˜æœ‰ç©ºé—²çš„æƒ…å†µä¸‹, CPU Usage å¯ä»¥ç›´æ¥åæ˜ åˆ° "load average" ä¸Š')]),s._v(", ä»€ä¹ˆæ˜¯ CPU è¿˜æœ‰ç©ºé—²å‘¢? å…·ä½“æ¥è¯´å°±æ˜¯"),t("strong",[s._v("å¯è¿è¡Œé˜Ÿåˆ—ä¸­çš„è¿›ç¨‹æ•°ç›®å°äº CPU ä¸ªæ•°")]),s._v(', è¿™ç§æƒ…å†µä¸‹, å•ä½æ—¶é—´è¿›ç¨‹ CPU Usage ç›¸åŠ çš„å¹³å‡å€¼åº”è¯¥å°±æ˜¯ "load average" çš„å€¼.')]),s._v(" "),t("li",[s._v("ç¬¬ä¸‰, è®¡ç®—æœºä¸Šçš„ "),t("strong",[s._v("CPU æ»¡è´Ÿè½½")]),s._v('çš„æƒ…å†µä¸‹, è®¡ç®—æœºä¸Šçš„ CPU å·²ç»æ˜¯æ»¡è´Ÿè½½äº†, åŒæ—¶è¿˜æœ‰æ›´å¤šçš„è¿›ç¨‹åœ¨æ’é˜Ÿéœ€è¦ CPU èµ„æº. è¿™æ—¶ "load average" å°±ä¸èƒ½å’Œ CPU Usage ç­‰åŒäº†.')])]),s._v(" "),t("p",[s._v('æ¯”å¦‚å¯¹äºå•ä¸ª CPU çš„ç³»ç»Ÿ, CPU Usage æœ€å¤§åªæ˜¯æœ‰ 100%, ä¹Ÿå°± 1 ä¸ª CPU; è€Œ "load average" çš„å€¼å¯ä»¥'),t("strong",[s._v("è¿œè¿œå¤§äº 1")]),s._v(', å› ä¸º "load average" çœ‹çš„æ˜¯æ“ä½œç³»ç»Ÿä¸­'),t("strong",[s._v("å¯è¿è¡Œé˜Ÿåˆ—ä¸­è¿›ç¨‹çš„ä¸ªæ•°")]),s._v(".")]),s._v(" "),t("p",[s._v("è¿™æ ·çš„è§£é‡Šå¯èƒ½å¤ªæŠ½è±¡äº†, ä¸ºäº†æ–¹ä¾¿ç†è§£, ä¸€èµ·åŠ¨æ‰‹éªŒè¯ä¸€ä¸‹. æ€ä¹ˆéªŒè¯å‘¢? å¯ä»¥æ‰§è¡Œä¸ªç¨‹åºæ¥æ¨¡æ‹Ÿä¸€ä¸‹, å…ˆå‡†å¤‡å¥½ä¸€ä¸ªå¯ä»¥æ¶ˆè€—ä»»æ„ CPU Usage çš„ç¨‹åº, åœ¨æ‰§è¡Œè¿™ä¸ªç¨‹åºçš„æ—¶å€™, åé¢åŠ ä¸ªæ•°å­—ä½œä¸ºå‚æ•°. æ¯”å¦‚ä¸‹é¢çš„è®¾ç½®, å‚æ•°æ˜¯ 2, å°±æ˜¯è¯´è¿™ä¸ª"),t("strong",[s._v("è¿›ç¨‹ä¼šåˆ›å»ºå‡ºä¸¤ä¸ªçº¿ç¨‹")]),s._v(", å¹¶ä¸”æ¯ä¸ªçº¿ç¨‹éƒ½è·‘æ»¡ 100% çš„ CPU, 2 ä¸ªçº¿ç¨‹å°±æ˜¯ 2 * 100% = 200% çš„ CPU Usage, ä¹Ÿå°±æ˜¯æ¶ˆè€—äº†æ•´æ•´ä¸¤ä¸ª CPU çš„èµ„æº.")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ./threads-cpu 2")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("å‡†å¤‡å¥½äº†è¿™ä¸ª CPU Usage çš„æ¨¡æ‹Ÿç¨‹åº, å°±å¯ä»¥ç”¨å®ƒæ¥æŸ¥çœ‹ CPU Usage å’Œ Load Average ä¹‹é—´çš„å…³ç³»äº†.")]),s._v(" "),t("p",[s._v("æ¥ä¸‹æ¥ä¸€èµ·è·‘ä¸¤ä¸ªä¾‹å­, ç¬¬ä¸€ä¸ªä¾‹å­æ˜¯æ‰§è¡Œ 2 ä¸ªæ»¡è´Ÿè½½çš„çº¿ç¨‹, ç¬¬äºŒä¸ªä¾‹å­æ‰§è¡Œ 6 ä¸ªæ»¡è´Ÿè½½çš„çº¿ç¨‹, åŒæ ·éƒ½æ˜¯åœ¨ä¸€å° "),t("strong",[s._v("4 ä¸ª CPU")]),s._v(" çš„èŠ‚ç‚¹ä¸Š.")]),s._v(" "),t("p",[s._v("å…ˆæ¥çœ‹ç¬¬ä¸€ä¸ªä¾‹å­, åœ¨ä¸€å° 4 ä¸ª CPU çš„è®¡ç®—æœºèŠ‚ç‚¹ä¸Šè¿è¡Œåˆšæ‰è¿™ä¸ªæ¨¡æ‹Ÿç¨‹åº, è¿˜æ˜¯è®¾ç½®å‚æ•°ä¸º 2, ä¹Ÿå°±æ˜¯ä½¿ç”¨ 2 ä¸ª CPU Usage. åœ¨è¿™ä¸ªç¨‹åºè¿è¡Œäº†å‡ åˆ†é’Ÿä¹‹å, è¿è¡Œ top æ¥æŸ¥çœ‹ä¸€ä¸‹ CPU Usage å’Œ Load Average. å¯ä»¥çœ‹åˆ°ä¸¤ä¸ª threads-cpu å„è‡ªéƒ½å äº†å°†è¿‘ 100% çš„ CPU, ä¸¤ä¸ªå°±æ˜¯ 200%, 2 ä¸ª CPU, å¯¹äº 4 ä¸ª CPU çš„è®¡ç®—æœºæ¥è¯´, "),t("strong",[s._v("CPU Usage å äº† 50%")]),s._v(" , ç©ºé—²äº†ä¸€åŠ, è¿™ä¸ªæˆ‘ä»¬ä¹Ÿå¯ä»¥ä» idle (id): 49.9% å¾—åˆ°å°è¯. è¿™æ—¶å€™, Load Average é‡Œç¬¬ä¸€é¡¹(ä¹Ÿå°±æ˜¯å‰ 1 åˆ†é’Ÿçš„æ•°å€¼)ä¸º "),t("strong",[s._v("1.98")]),s._v(", è¿‘ä¼¼äº 2. è¿™ä¸ªå€¼å’Œä¸€ç›´è¿è¡Œçš„ 200%CPU Usage ç›¸å¯¹åº”, ä¹ŸéªŒè¯äº†ä¹‹å‰å½’çº³çš„ç¬¬äºŒç‚¹--- CPU æœªæ»¡è´Ÿè½½æ—¶ **CPU Usage å¯ä»¥åæ˜ åˆ° Load Average ä¸Š. **")]),s._v(" "),t("p",[s._v("å› ä¸ºè¿è¡Œçš„æ—¶é—´ä¸å¤Ÿ, å‰ 5 åˆ†é’Ÿ, å‰ 15 åˆ†é’Ÿçš„ Load Average è¿˜æ²¡æœ‰åˆ° 2, è€Œä¸”åé¢çš„ä¾‹å­ç¨‹åºä¸€èˆ¬éƒ½åªä¼šè¿è¡Œå‡ åˆ†é’Ÿ, æ‰€ä»¥è¿™é‡Œåªçœ‹å‰ 1 åˆ†é’Ÿçš„ Load Average å€¼å°±è¡Œ. å¦å¤–, Linux å†…æ ¸ä¸­"),t("strong",[s._v("ä¸ä½¿ç”¨æµ®ç‚¹è®¡ç®—")]),s._v(", è¿™å¯¼è‡´ Load Average é‡Œçš„ 1 åˆ†é’Ÿ, 5 åˆ†é’Ÿ, 15 åˆ†é’Ÿçš„æ—¶é—´å€¼å¹¶ä¸ç²¾ç¡®, ä½†è¿™ä¸å½±å“æŸ¥çœ‹ Load Average çš„æ•°å€¼, æ‰€ä»¥å…ˆä¸ç”¨ç®¡è¿™ä¸ªæ—¶é—´çš„å‡†ç¡®æ€§.")]),s._v(" "),t("p",[t("img",{attrs:{src:"/img/77a6eaf2658556c4dfea076b38c82514-20230731161430-xq9ygnj.png",alt:""}})]),s._v(" "),t("p",[s._v("å†æ¥è·‘ç¬¬äºŒä¸ªä¾‹å­, åŒæ ·åœ¨è¿™ä¸ª 4 ä¸ª CPU çš„è®¡ç®—æœºèŠ‚ç‚¹ä¸Š, å¦‚æœæ‰§è¡Œ CPU Usage æ¨¡æ‹Ÿç¨‹åº threads-cpu, è®¾ç½®å‚æ•°ä¸º 6, è®©è¿™ä¸ªè¿›ç¨‹å»ºå‡º 6 ä¸ªçº¿ç¨‹, è¿™æ ·"),t("strong",[s._v("æ¯ä¸ªçº¿ç¨‹éƒ½ä¼šå°½é‡å»æŠ¢å  CPU, ä½†æ˜¯è®¡ç®—æœºæ€»å…±åªæœ‰ 4 ä¸ª CPU, æ‰€ä»¥è¿™ 6 ä¸ªçº¿ç¨‹çš„ CPU Usage åŠ èµ·æ¥åªæ˜¯ 400%")]),s._v(" . æ˜¾ç„¶è¿™æ—¶å€™ 4 ä¸ª CPU éƒ½è¢«å æ»¡äº†, å¯ä»¥çœ‹åˆ°æ•´ä¸ªèŠ‚ç‚¹çš„ idle(id)ä¹Ÿå·²ç»æ˜¯ 0.0% äº†. ä½†è¿™ä¸ªæ—¶å€™, çœ‹çœ‹å‰ 1 åˆ†é’Ÿçš„ "),t("strong",[s._v("Load Average")]),s._v(", æ•°å€¼ä¸æ˜¯ 4 è€Œæ˜¯ "),t("strong",[s._v("5.93 æ¥è¿‘ 6")]),s._v(", æ­£å¥½æ¨¡æ‹Ÿäº† 6 ä¸ªé«˜ CPU éœ€æ±‚çš„çº¿ç¨‹. è¿™ä¹Ÿè¡¨æ˜ "),t("strong",[s._v("Load Average è¡¨ç¤ºçš„æ˜¯ä¸€æ®µæ—¶é—´é‡Œè¿è¡Œé˜Ÿåˆ—ä¸­éœ€è¦è¢«è°ƒåº¦çš„è¿›ç¨‹ / çº¿ç¨‹å¹³å‡æ•°ç›®")]),s._v(".")]),s._v(" "),t("p",[t("img",{attrs:{src:"/img/ae78d71d66f03b07a0c4804558bf74fc-20230731161430-dy7sr5m.png",alt:""}})]),s._v(" "),t("p",[s._v("è®²åˆ°è¿™é‡Œ, æ˜¯ä¸æ˜¯å°±å¯ä»¥è®¤å®š Load Average å°±ä»£è¡¨ä¸€æ®µæ—¶é—´é‡Œè¿è¡Œé˜Ÿåˆ—ä¸­éœ€è¦è¢«è°ƒåº¦çš„è¿›ç¨‹æˆ–è€…çº¿ç¨‹å¹³å‡æ•°ç›®äº†å‘¢? æˆ–è®¸å¯¹å…¶ä»–çš„ Unix ç³»ç»Ÿæ¥è¯´, è¿™ä¸ªç†è§£å·²ç»å¤Ÿäº†, ä½†æ˜¯"),t("strong",[s._v("å¯¹äº Linux ç³»ç»Ÿè¿˜ä¸èƒ½è¿™ä¹ˆè®¤å®š")]),s._v(".")]),s._v(" "),t("p",[s._v("ä¸ºä»€ä¹ˆè¿™ä¹ˆè¯´å‘¢? æ•…äº‹è¿˜è¦ä» Linux æ—©æœŸçš„å†å²è¯´èµ·, é‚£æ—¶å¼€å‘è€… Matthias æœ‰è¿™ä¹ˆä¸€ä¸ªå‘ç°, æ¯”å¦‚æŠŠå¿«é€Ÿçš„ç£ç›˜æ¢æˆäº†æ…¢é€Ÿçš„ç£ç›˜, è¿è¡ŒåŒæ ·çš„è´Ÿè½½, ç³»ç»Ÿçš„æ€§èƒ½æ˜¯ä¸‹é™çš„, ä½†æ˜¯ Load Average å´æ²¡æœ‰åæ˜ å‡ºæ¥. ä»–å‘ç°è¿™æ˜¯"),t("strong",[s._v("å› ä¸º Load Average åªè€ƒè™‘è¿è¡Œæ€çš„è¿›ç¨‹æ•°ç›®, è€Œæ²¡æœ‰è€ƒè™‘ç­‰å¾… I/O çš„è¿›ç¨‹")]),s._v(". æ‰€ä»¥ä»–è®¤ä¸º "),t("strong",[s._v("Load Average å¦‚æœåªæ˜¯è€ƒè™‘è¿›ç¨‹è¿è¡Œé˜Ÿåˆ—ä¸­éœ€è¦è¢«è°ƒåº¦çš„è¿›ç¨‹æˆ–çº¿ç¨‹å¹³å‡æ•°ç›®æ˜¯ä¸å¤Ÿçš„, å› ä¸ºå¯¹äºå¤„äº I/O èµ„æºç­‰å¾…çš„è¿›ç¨‹éƒ½æ˜¯å¤„äº TASK_UNINTERRUPTIBLE çŠ¶æ€çš„")]),s._v(". é‚£ä»–æ˜¯æ€ä¹ˆå¤„ç†è¿™ä»¶äº‹çš„å‘¢? ä¼°è®¡ä½ ä¹ŸçŒœåˆ°äº†, ä»–ç»™å†…æ ¸åŠ ä¸€ä¸ª patch(è¡¥ä¸), æŠŠå¤„äº "),t("strong",[s._v("TASK_UNINTERRUPTIBLE")]),s._v(" çŠ¶æ€çš„è¿›ç¨‹æ•°ç›®ä¹Ÿè®¡å…¥äº† Load Average ä¸­.")]),s._v(" "),t("p",[s._v("åœ¨è¿™é‡Œåˆæåˆ°äº† TASK_UNINTERRUPTIBLE çŠ¶æ€çš„è¿›ç¨‹, å†å¼ºè°ƒä¸€ä¸‹, **TASK_UNINTERRUPTIBLE æ˜¯ Linux è¿›ç¨‹çŠ¶æ€çš„ä¸€ç§, æ˜¯è¿›ç¨‹ä¸ºç­‰å¾…æŸä¸ªç³»ç»Ÿèµ„æºè€Œè¿›å…¥äº†ç¡çœ çš„çŠ¶æ€, å¹¶ä¸”è¿™ç§ç¡çœ çš„çŠ¶æ€æ˜¯ä¸èƒ½è¢«ä¿¡å·æ‰“æ–­çš„. **")]),s._v(" "),t("p",[s._v("**é‚£ä¹ˆå¯¹äº Linux çš„ Load Average æ¥è¯´, é™¤äº†å¯è¿è¡Œé˜Ÿåˆ—ä¸­çš„è¿›ç¨‹æ•°ç›®, ç­‰å¾…é˜Ÿåˆ—ä¸­çš„ UNINTERRUPTIBLE è¿›ç¨‹æ•°ç›®ä¹Ÿä¼šå¢åŠ  Load Average. **")]),s._v(" "),t("p",[s._v("ä¸ºäº†éªŒè¯è¿™ä¸€ç‚¹, å¯ä»¥æ¨¡æ‹Ÿä¸€ä¸‹ UNINTERRUPTIBLE çš„è¿›ç¨‹, æ¥çœ‹çœ‹ Load Average çš„å˜åŒ–.")]),s._v(" "),t("p",[s._v("è¿™é‡Œåšä¸€ä¸ª kernel module, é€šè¿‡ä¸€ä¸ª /proc æ–‡ä»¶ç³»ç»Ÿç»™ç”¨æˆ·ç¨‹åºæä¾›ä¸€ä¸ªè¯»å–çš„æ¥å£, åªè¦ç”¨æˆ·è¿›ç¨‹è¯»å–äº†è¿™ä¸ªæ¥å£å°±ä¼šè¿›å…¥ UNINTERRUPTIBLE. è¿™æ ·å°±å¯ä»¥æ¨¡æ‹Ÿä¸¤ä¸ªå¤„äº UNINTERRUPTIBLE çŠ¶æ€çš„è¿›ç¨‹, ç„¶åæŸ¥çœ‹ä¸€ä¸‹ Load Average æœ‰æ²¡æœ‰å¢åŠ .")]),s._v(" "),t("p",[s._v("å¯ä»¥å‘ç°ç¨‹åºè·‘äº†å‡ åˆ†é’Ÿä¹‹å, å‰ 1 åˆ†é’Ÿçš„ Load Average å·®ä¸å¤šä» 0 å¢åŠ åˆ°äº† "),t("strong",[s._v("2.16")]),s._v(", èŠ‚ç‚¹ä¸Š CPU Usage å‡ ä¹ä¸º 0, idle ä¸º 99.8%. å¯ä»¥çœ‹åˆ°, å¯è¿è¡Œé˜Ÿåˆ—(Running Queue)ä¸­çš„è¿›ç¨‹æ•°ç›®æ˜¯ 0, åªæœ‰ä¼‘çœ é˜Ÿåˆ—(Sleeping Queue)ä¸­æœ‰ä¸¤ä¸ªè¿›ç¨‹, å¹¶ä¸”è¿™ä¸¤ä¸ªè¿›ç¨‹æ˜¾ç¤ºä¸º D state è¿›ç¨‹, è¿™ä¸ª D state è¿›ç¨‹ä¹Ÿå°±æ˜¯æ¨¡æ‹Ÿå‡ºæ¥çš„ TASK_UNINTERRUPTIBLE çŠ¶æ€çš„è¿›ç¨‹.")]),s._v(" "),t("p",[s._v("è¿™ä¸ªä¾‹å­"),t("strong",[s._v("è¯æ˜äº† Linux å°† TASK_UNINTERRUPTIBLE çŠ¶æ€çš„è¿›ç¨‹æ•°ç›®è®¡å…¥äº† Load Average ä¸­, æ‰€ä»¥å³ä½¿ CPU ä¸Šä¸åšä»»ä½•çš„è®¡ç®—, Load Average ä»ç„¶ä¼šå‡é«˜")]),s._v(". å¦‚æœ TASK_UNINTERRUPTIBLE çŠ¶æ€çš„è¿›ç¨‹æ•°ç›®æœ‰å‡ ç™¾å‡ åƒä¸ª, é‚£ä¹ˆ Load Average çš„æ•°å€¼ä¹Ÿå¯ä»¥è¾¾åˆ°å‡ ç™¾å‡ åƒ.")]),s._v(" "),t("p",[t("img",{attrs:{src:"/img/5a45ad7ca1e4229bf02255c121ae92d7-20230731161430-xiet95g.png",alt:""}})]),s._v(" "),t("p",[s._v("å¥½äº†, åˆ°è¿™é‡Œå°±å¯ä»¥å‡†ç¡®å®šä¹‰ Linux ç³»ç»Ÿé‡Œçš„ Load Average äº†, å…¶å®ä¹Ÿå¾ˆç®€å•, åªéœ€è¦è®°ä½, "),t("strong",[s._v("å¹³å‡è´Ÿè½½ç»Ÿè®¡äº†è¿™ä¸¤ç§æƒ…å†µçš„è¿›ç¨‹")]),s._v(":")]),s._v(" "),t("p",[s._v("**ç¬¬ä¸€ç§æ˜¯ Linux è¿›ç¨‹è°ƒåº¦å™¨ä¸­å¯è¿è¡Œé˜Ÿåˆ—(Running Queue)ä¸€æ®µæ—¶é—´(1 åˆ†é’Ÿ, 5 åˆ†é’Ÿ, 15 åˆ†é’Ÿ)çš„è¿›ç¨‹å¹³å‡æ•°. **")]),s._v(" "),t("p",[s._v("**ç¬¬äºŒç§æ˜¯ Linux è¿›ç¨‹è°ƒåº¦å™¨ä¸­ä¼‘çœ é˜Ÿåˆ—(Sleeping Queue)é‡Œçš„ä¸€æ®µæ—¶é—´çš„ TASK_UNINTERRUPTIBLE çŠ¶æ€ä¸‹çš„è¿›ç¨‹å¹³å‡æ•°. **")]),s._v(" "),t("p",[s._v("æ‰€ä»¥æœ€åçš„å…¬å¼å°±æ˜¯: "),t("strong",[s._v("==Load Average= å¯è¿è¡Œé˜Ÿåˆ—è¿›ç¨‹å¹³å‡æ•° + ä¼‘çœ é˜Ÿåˆ—ä¸­ä¸å¯æ‰“æ–­çš„è¿›ç¨‹å¹³å‡æ•°==")])]),s._v(" "),t("p",[s._v("å¦‚æœæ‰“ä¸ªæ¯”æ–¹æ¥è¯´æ˜ Load Average çš„ç»Ÿè®¡åŸç†. å¯ä»¥æƒ³è±¡"),t("strong",[s._v("æ¯ä¸ª CPU å°±æ˜¯ä¸€æ¡é“è·¯, æ¯ä¸ªè¿›ç¨‹éƒ½æ˜¯ä¸€è¾†è½¦")]),s._v(", æ€ä¹ˆç§‘å­¦ç»Ÿè®¡é“è·¯çš„å¹³å‡è´Ÿè½½å‘¢? å°±æ˜¯çœ‹å•ä½æ—¶é—´é€šè¿‡çš„è½¦è¾†, ä¸€æ¡é“ä¸Šçš„è½¦è¶Šå¤š, é‚£ä¹ˆè¿™æ¡é“è·¯çš„è´Ÿè½½ä¹Ÿå°±è¶Šé«˜. æ­¤å¤–, Linux è®¡ç®—ç³»ç»Ÿè´Ÿè½½çš„æ—¶å€™, è¿˜é¢å¤–åšäº†ä¸ªè¡¥ä¸æŠŠ TASK_UNINTERRUPTIBLE çŠ¶æ€çš„è¿›ç¨‹ä¹Ÿè€ƒè™‘äº†, è¿™ä¸ªå°±åƒé“è·¯ä¸­è¦æŠŠ"),t("strong",[s._v("çº¢ç»¿ç¯æƒ…å†µ")]),s._v("ä¹Ÿè€ƒè™‘è¿›å». ä¸€æ—¦æœ‰äº†çº¢ç¯, æ±½è½¦å°±è¦åœä¸‹æ¥æ’é˜Ÿ, é‚£ä¹ˆå³ä½¿é“è·¯å¾ˆç©º, ä½†æ˜¯çº¢ç¯å¤šäº†, æ±½è½¦ä¹Ÿè¦æ’é˜Ÿç­‰å¾…, ä¹Ÿå¼€ä¸å¿«.")]),s._v(" "),t("h5",{attrs:{id:"_3-ç°è±¡è§£é‡Š-ä¸ºä»€ä¹ˆ-load-averageä¼šå‡é«˜"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-ç°è±¡è§£é‡Š-ä¸ºä»€ä¹ˆ-load-averageä¼šå‡é«˜"}},[s._v("#")]),s._v(" 3.ç°è±¡è§£é‡Š:ä¸ºä»€ä¹ˆ Load Averageä¼šå‡é«˜?")]),s._v(" "),t("p",[s._v("è§£é‡Šäº† Load Average è¿™ä¸ªæ¦‚å¿µ, å†å›åˆ°è¿™ä¸€è®²æœ€å¼€å§‹çš„é—®é¢˜, ä¸ºä»€ä¹ˆå¯¹å®¹å™¨å·²ç»ç”¨ CPU Cgroup é™åˆ¶äº†å®ƒçš„ CPU Usage, å®¹å™¨é‡Œçš„è¿›ç¨‹è¿˜æ˜¯å¯ä»¥"),t("strong",[s._v("é€ æˆæ•´ä¸ªç³»ç»Ÿå¾ˆé«˜çš„ Load Average")]),s._v(".")]),s._v(" "),t("p",[s._v("å‰é¢ç†è§£äº† Load Average è¿™ä¸ªæ¦‚å¿µä¹‹å, å°±èƒ½åŒºåˆ†å‡º Load Averge å’Œ CPU ä½¿ç”¨ç‡çš„åŒºåˆ«äº†. é‚£ä¹ˆè¿™ä¸ªçœ‹ä¼¼çŸ›ç›¾çš„é—®é¢˜ä¹Ÿå°±å¾ˆå¥½å›ç­”äº†, å› ä¸º "),t("mark",[t("strong",[s._v("Linux ä¸‹çš„ Load Averge ä¸ä»…ä»…è®¡ç®—äº† CPU Usage çš„éƒ¨åˆ†, å®ƒè¿˜è®¡ç®—äº†ç³»ç»Ÿä¸­ TASK_UNINTERRUPTIBLE çŠ¶æ€çš„è¿›ç¨‹æ•°ç›®")])]),s._v("â€‹ **. **")]),s._v(" "),t("p",[s._v("è®²åˆ°è¿™é‡Œä¸ºæ­¢, æ‰¾åˆ°äº†ç¬¬ä¸€ä¸ªé—®é¢˜çš„ç­”æ¡ˆ, é‚£ä¹ˆç°åœ¨å†çœ‹ç¬¬äºŒä¸ªé—®é¢˜: å¦‚æœ Load Average å€¼å‡é«˜, åº”ç”¨çš„æ€§èƒ½å·²ç»ä¸‹é™äº†, çœŸæ­£çš„åŸå› æ˜¯ä»€ä¹ˆ? é—®é¢˜å°±å‡ºåœ¨ "),t("strong",[s._v("TASK_UNINTERRUPTIBLE")]),s._v(" çŠ¶æ€çš„è¿›ç¨‹ä¸Šäº†.")]),s._v(" "),t("p",[s._v("æ€ä¹ˆéªŒè¯è¿™ä¸ªåˆ¤æ–­å‘¢? è¿™æ—¶å€™åªè¦è¿è¡Œ "),t("code",[s._v('ps aux | grep " D "')]),s._v('â€‹, å°±å¯ä»¥çœ‹åˆ°å®¹å™¨ä¸­æœ‰å¤šå°‘ TASK_UNINTERRUPTIBLE çŠ¶æ€(åœ¨ ps å‘½ä»¤ä¸­è¿™ä¸ªçŠ¶æ€çš„è¿›ç¨‹æ ‡ç¤ºä¸º "D" çŠ¶æ€)çš„è¿›ç¨‹, ä¸ºäº†æ–¹ä¾¿ç†è§£, åé¢ç®€ç§°ä¸º D çŠ¶æ€è¿›ç¨‹. è€Œæ­£æ˜¯è¿™äº› D çŠ¶æ€è¿›ç¨‹å¼•èµ·äº† Load Average çš„å‡é«˜.')]),s._v(" "),t("p",[s._v("æ‰¾åˆ°äº† Load Average å‡é«˜çš„é—®é¢˜å‡ºåœ¨ D çŠ¶æ€è¿›ç¨‹äº†, æƒ³è¦çœŸæ­£è§£å†³é—®é¢˜, è¿˜æœ‰å¿…è¦äº†è§£ "),t("strong",[s._v("D çŠ¶æ€è¿›ç¨‹äº§ç”Ÿçš„æœ¬è´¨")]),s._v("æ˜¯ä»€ä¹ˆ?")]),s._v(" "),t("p",[s._v("åœ¨ Linux å†…æ ¸ä¸­æœ‰æ•°ç™¾å¤„"),t("strong",[s._v("è°ƒç”¨ç‚¹")]),s._v(", å®ƒä»¬ä¼š"),t("strong",[s._v("æŠŠè¿›ç¨‹è®¾ç½®ä¸º D çŠ¶æ€, ä¸»è¦é›†ä¸­åœ¨ disk I/O çš„è®¿é—®å’Œä¿¡å·é‡(Semaphore)é”çš„è®¿é—®ä¸Š, å› æ­¤ D çŠ¶æ€çš„è¿›ç¨‹åœ¨ Linux é‡Œæ˜¯å¾ˆå¸¸è§çš„")]),s._v(". "),t("strong",[s._v("æ— è®ºæ˜¯å¯¹ disk I/O çš„è®¿é—®è¿˜æ˜¯å¯¹ä¿¡å·é‡çš„è®¿é—®, éƒ½æ˜¯å¯¹ Linux ç³»ç»Ÿé‡Œçš„èµ„æºçš„ä¸€ç§ç«äº‰. ** å½“è¿›ç¨‹å¤„äº D çŠ¶æ€æ—¶, å°±è¯´æ˜")]),s._v("è¿›ç¨‹è¿˜æ²¡è·å¾—èµ„æº**, è¿™ä¼šåœ¨åº”ç”¨ç¨‹åºçš„æœ€ç»ˆæ€§èƒ½ä¸Šä½“ç°å‡ºæ¥, ä¹Ÿå°±æ˜¯è¯´ç”¨æˆ·ä¼šå‘è§‰åº”ç”¨çš„æ€§èƒ½ä¸‹é™äº†.")]),s._v(" "),t("p",[s._v("é‚£ä¹ˆ D çŠ¶æ€è¿›ç¨‹å¯¼è‡´äº†æ€§èƒ½ä¸‹é™, è‚¯å®šæ˜¯æƒ³æ–¹è®¾æ³•å»åšè°ƒè¯•çš„. ä½†ç›®å‰ D çŠ¶æ€è¿›ç¨‹å¼•èµ·çš„"),t("strong",[s._v("å®¹å™¨ä¸­")]),s._v("è¿›ç¨‹æ€§èƒ½ä¸‹é™é—®é¢˜, Cgroups è¿˜ä¸èƒ½è§£å†³, è¿™ä¹Ÿå°±æ˜¯ä¸ºä»€ä¹ˆç”¨ Cgroups åšäº†é…ç½®, å³ä½¿ä¿è¯äº†å®¹å™¨çš„ CPU èµ„æº, å®¹å™¨ä¸­çš„è¿›ç¨‹è¿˜æ˜¯è¿è¡Œå¾ˆæ…¢çš„æ ¹æœ¬åŸå› .")]),s._v(" "),t("p",[s._v("è¿™é‡Œè¿›ä¸€æ­¥åšåˆ†æ, ä¸ºä»€ä¹ˆ CPU Cgroups ä¸èƒ½è§£å†³è¿™ä¸ªé—®é¢˜å‘¢? å°±æ˜¯"),t("strong",[s._v("å› ä¸º Cgroups æ›´å¤šçš„æ˜¯ä»¥è¿›ç¨‹ä¸ºå•ä½è¿›è¡Œéš”ç¦», è€Œ D çŠ¶æ€è¿›ç¨‹æ˜¯å†…æ ¸ä¸­ç³»ç»Ÿå…¨å±€èµ„æºå¼•å…¥çš„, æ‰€ä»¥ Cgroups å½±å“ä¸äº†å®ƒ")]),s._v(".")]),s._v(" "),t("p",[s._v("æ‰€ä»¥å¯ä»¥åšçš„æ˜¯, "),t("strong",[s._v("åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ç›‘æ§å®¹å™¨çš„å®¿ä¸»æœºèŠ‚ç‚¹é‡Œ D çŠ¶æ€çš„è¿›ç¨‹æ•°é‡, ç„¶åå¯¹ D çŠ¶æ€è¿›ç¨‹æ•°ç›®å¼‚å¸¸çš„èŠ‚ç‚¹è¿›è¡Œåˆ†æ, æ¯”å¦‚ç£ç›˜ç¡¬ä»¶å‡ºç°é—®é¢˜å¼•èµ· D çŠ¶æ€è¿›ç¨‹æ•°ç›®å¢åŠ , è¿™æ—¶å°±éœ€è¦æ›´æ¢ç¡¬ç›˜")]),s._v(".")]),s._v(" "),t("h5",{attrs:{id:"_4-é‡ç‚¹æ€»ç»“-4"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_4-é‡ç‚¹æ€»ç»“-4"}},[s._v("#")]),s._v(" 4.é‡ç‚¹æ€»ç»“")]),s._v(" "),t("p",[s._v("è¿™ä¸€è®²ä» CPU Usage å’Œ Load Average å·®å¼‚è¿™ä¸ªç°è±¡è®²èµ·, æœ€ä¸»è¦çš„ç›®çš„æ˜¯è®²æ¸…æ¥š Linux ä¸‹çš„ Load Average è¿™ä¸ªæ¦‚å¿µ.")]),s._v(" "),t("p",[s._v("åœ¨å…¶ä»– Unix æ“ä½œç³»ç»Ÿé‡Œ Load Average åªè€ƒè™‘ CPU éƒ¨åˆ†, "),t("strong",[s._v("Load Average è®¡ç®—çš„æ˜¯è¿›ç¨‹è°ƒåº¦å™¨ä¸­å¯è¿è¡Œé˜Ÿåˆ—(Running Queue)é‡Œçš„ä¸€æ®µæ—¶é—´(1 åˆ†é’Ÿ, 5 åˆ†é’Ÿ, 15 åˆ†é’Ÿ)çš„å¹³å‡è¿›ç¨‹æ•°ç›®, è€Œ Linux åœ¨è¿™ä¸ªåŸºç¡€ä¸Š, åˆåŠ ä¸Šäº†è¿›ç¨‹è°ƒåº¦å™¨ä¸­ä¼‘çœ é˜Ÿåˆ—(Sleeping Queue)é‡Œçš„ä¸€æ®µæ—¶é—´çš„ TASK_UNINTERRUPTIBLE çŠ¶æ€çš„å¹³å‡è¿›ç¨‹æ•°ç›®")]),s._v(".")]),s._v(" "),t("p",[s._v("è¿™é‡Œéœ€è¦é‡ç‚¹æŒæ¡ Load Average çš„è®¡ç®—å…¬å¼, å¦‚ä¸‹å›¾.")]),s._v(" "),t("p",[t("img",{attrs:{src:"/img/0538bbc4ed03446a23be251ed2877486-20230731161430-p9d3c2n.png",alt:""}})]),s._v(" "),t("p",[s._v("å› ä¸º "),t("strong",[s._v("TASK_UNINTERRUPTIBLE")]),s._v(" çŠ¶æ€çš„è¿›ç¨‹åŒæ ·ä¹Ÿä¼šç«äº‰ç³»ç»Ÿèµ„æº, æ‰€ä»¥å®ƒä¼šå½±å“åˆ°åº”ç”¨ç¨‹åºçš„æ€§èƒ½. å¯ä»¥åœ¨å®¹å™¨å®¿ä¸»æœºçš„èŠ‚ç‚¹å¯¹ D çŠ¶æ€è¿›ç¨‹åšç›‘æ§, å®šå‘åˆ†æè§£å†³.")]),s._v(" "),t("p",[s._v("æœ€åå¼ºè°ƒä¸€ä¸‹, è¿™ä¸€è®²ä¸­æåˆ°çš„å¯¹ D çŠ¶æ€è¿›ç¨‹è¿›è¡Œç›‘æ§ä¹Ÿå¾ˆé‡è¦, å› ä¸ºè¿™æ˜¯é€šç”¨ç³»ç»Ÿæ€§èƒ½çš„ç›‘æ§æ–¹æ³•.")]),s._v(" "),t("h3",{attrs:{id:"å®¹å™¨å†…å­˜"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#å®¹å™¨å†…å­˜"}},[s._v("#")]),s._v(" å®¹å™¨å†…å­˜")]),s._v(" "),t("h4",{attrs:{id:"_08-å®¹å™¨å†…å­˜-æˆ‘çš„å®¹å™¨ä¸ºä»€ä¹ˆè¢«æ€äº†"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_08-å®¹å™¨å†…å­˜-æˆ‘çš„å®¹å™¨ä¸ºä»€ä¹ˆè¢«æ€äº†"}},[s._v("#")]),s._v(" 08 | å®¹å™¨å†…å­˜:æˆ‘çš„å®¹å™¨ä¸ºä»€ä¹ˆè¢«æ€äº†?")]),s._v(" "),t("p",[s._v("ä»è¿™ä¸€è®²å†…å®¹å¼€å§‹è¿›å…¥"),t("strong",[s._v("å®¹å™¨å†…å­˜")]),s._v("è¿™ä¸ªæ¨¡å—. åœ¨ä½¿ç”¨å®¹å™¨çš„æ—¶å€™, ä¸€å®šä¼šä¼´éšç€ "),t("strong",[s._v("Memory Cgroup")]),s._v(". è€Œ Memory Cgroup ç»™ Linux åŸæœ¬å°±å¤æ‚çš„å†…å­˜ç®¡ç†å¸¦æ¥äº†æ–°çš„å˜åŒ–, ä¸‹é¢å°±æ¥å­¦ä¹ è¿™ä¸€å—å†…å®¹.")]),s._v(" "),t("p",[s._v("æœ¬èŠ‚æ¥è§£å†³å®¹å™¨åœ¨ç³»ç»Ÿä¸­æ¶ˆå¤±çš„é—®é¢˜.")]),s._v(" "),t("p",[s._v("ä¸çŸ¥é“ä½ åœ¨ä½¿ç”¨å®¹å™¨æ—¶, æœ‰æ²¡æœ‰è¿‡è¿™æ ·çš„ç»å†? "),t("strong",[s._v("ä¸€ä¸ªå®¹å™¨åœ¨ç³»ç»Ÿä¸­è¿è¡Œä¸€æ®µæ—¶é—´å, çªç„¶æ¶ˆå¤±äº†, çœ‹çœ‹è‡ªå·±ç¨‹åºçš„ log æ–‡ä»¶, ä¹Ÿæ²¡å‘ç°ä»€ä¹ˆé”™è¯¯, ä¸åƒæ˜¯è‡ªå·±ç¨‹åº Crash, ä½†æ˜¯å®¹å™¨å°±æ˜¯æ¶ˆå¤±äº†")]),s._v(".")]),s._v(" "),t("p",[s._v('é‚£ä¹ˆè¿™æ˜¯æ€ä¹ˆå›äº‹å‘¢? æ¥ä¸‹æ¥å°±ä¸€èµ·æ¥ "ç ´æ¡ˆ".')]),s._v(" "),t("h5",{attrs:{id:"_1-é—®é¢˜å†ç°-4"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-é—®é¢˜å†ç°-4"}},[s._v("#")]),s._v(" 1.é—®é¢˜å†ç°")]),s._v(" "),t("p",[s._v("**å®¹å™¨åœ¨ç³»ç»Ÿä¸­è¢«æ€æ‰, å…¶å®åªæœ‰ä¸€ç§æƒ…å†µ, é‚£å°±æ˜¯å®¹å™¨ä¸­çš„è¿›ç¨‹ä½¿ç”¨äº†å¤ªå¤šçš„å†…å­˜. å…·ä½“æ¥è¯´, å°±æ˜¯å®¹å™¨é‡Œæ‰€æœ‰è¿›ç¨‹ä½¿ç”¨çš„å†…å­˜é‡, è¶…è¿‡äº†å®¹å™¨æ‰€åœ¨ Memory Cgroup é‡Œçš„å†…å­˜é™åˆ¶. è¿™æ—¶ Linux ç³»ç»Ÿå°±ä¼šä¸»åŠ¨æ€æ­»å®¹å™¨ä¸­çš„ä¸€ä¸ªè¿›ç¨‹, å¾€å¾€è¿™ä¼šå¯¼è‡´æ•´ä¸ªå®¹å™¨çš„é€€å‡º. **")]),s._v(" "),t("p",[s._v("å¯ä»¥åšä¸ªç®€å•çš„å®¹å™¨, æ¨¡æ‹Ÿä¸€ä¸‹è¿™ç§å®¹å™¨è¢«æ€æ­»çš„åœºæ™¯. åšå®¹å™¨çš„ Dockerfile å’Œä»£ç , å¯ä»¥ä»è¿™é‡Œè·å¾—. æ¥ä¸‹æ¥ç”¨ä¸‹é¢çš„è¿™ä¸ªè„šæœ¬æ¥å¯åŠ¨å®¹å™¨, å…ˆæŠŠè¿™ä¸ªå®¹å™¨çš„ Cgroup å†…å­˜ä¸Šé™è®¾ç½®ä¸º 512MB(536870912 bytes).")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token shebang important"}},[s._v("#!/bin/bash")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" stop mem_alloc"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("rm")]),s._v(" mem_alloc\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" run "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-d")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--name")]),s._v(" mem_alloc registry/mem_alloc:v1\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("sleep")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("CONTAINER_ID")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token variable"}},[t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$(")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ps")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--format")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"{{.ID}}'),t("span",{pre:!0,attrs:{class:"token entity",title:"\\t"}},[s._v("\\t")]),s._v('{{.Names}}"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("grep")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-i")]),s._v(" mem_alloc "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("awk")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'{print $1}'")]),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v(")")])]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$CONTAINER_ID")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("CGROUP_CONTAINER_PATH")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token variable"}},[t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$(")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("find")]),s._v(" /sys/fs/cgroup/memory/ "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-name")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"*'),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$CONTAINER_ID")]),s._v('*"')]),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v(")")])]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$CGROUP_CONTAINER_PATH")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("536870912")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$CGROUP_CONTAINER_PATH")]),s._v("/memory.limit_in_bytes\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$CGROUP_CONTAINER_PATH")]),s._v("/memory.limit_in_bytes\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br")])]),t("p",[s._v("å®¹å™¨å¯åŠ¨å, é‡Œé¢æœ‰ä¸€ä¸ªå°ç¨‹åº mem_alloc ä¼šä¸æ–­åœ°ç”³è¯·å†…å­˜. å½“å®ƒç”³è¯·çš„å†…å­˜è¶…è¿‡ 512MB çš„æ—¶å€™, ä½ å°±ä¼šå‘ç°, å¯åŠ¨çš„è¿™ä¸ªå®¹å™¨æ¶ˆå¤±äº†.")]),s._v(" "),t("p",[t("img",{attrs:{src:"/img/8adb2c20396030b1dd7f7370d93ec919-20230731161430-ly7a004.png",alt:""}})]),s._v(" "),t("p",[s._v("è¿™æ—¶å€™, å¦‚æœè¿è¡Œ "),t("code",[s._v("docker inspect")]),s._v('â€‹ å‘½ä»¤æŸ¥çœ‹å®¹å™¨é€€å‡ºçš„åŸå› , å°±ä¼šçœ‹åˆ°å®¹å™¨å¤„äº "exited" çŠ¶æ€, å¹¶ä¸” "'),t("strong",[s._v("OOMKilled")]),s._v('" æ˜¯ true.')]),s._v(" "),t("p",[t("img",{attrs:{src:"/img/b154de19653b84d926399427867b47d8-20230731161430-tk3rnv9.png",alt:""}})]),s._v(" "),t("p",[s._v("é‚£ä¹ˆé—®é¢˜æ¥äº†, ä»€ä¹ˆæ˜¯ OOM Killed å‘¢? å®ƒå’Œä¹‹å‰å¯¹å®¹å™¨ Memory Cgroup åšçš„è®¾ç½®æœ‰ä»€ä¹ˆå…³ç³», åˆæ˜¯æ€ä¹ˆå¼•èµ·å®¹å™¨é€€å‡ºçš„? æƒ³ææ¸…æ¥šè¿™äº›é—®é¢˜, å°±éœ€è¦å…ˆç†æ¸…æ¥šåŸºæœ¬æ¦‚å¿µ.")]),s._v(" "),t("h6",{attrs:{id:"_1-å¦‚ä½•ç†è§£oom-killer"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-å¦‚ä½•ç†è§£oom-killer"}},[s._v("#")]),s._v(" (1)å¦‚ä½•ç†è§£OOM Killer?")]),s._v(" "),t("p",[s._v("å…ˆæ¥çœ‹ä¸€çœ‹ OOM Killer æ˜¯ä»€ä¹ˆæ„æ€. OOM æ˜¯ Out of Memory çš„ç¼©å†™, é¡¾åæ€ä¹‰å°±æ˜¯å†…å­˜ä¸è¶³çš„æ„æ€, è€Œ Killer åœ¨è¿™é‡ŒæŒ‡éœ€è¦æ€æ­»æŸä¸ªè¿›ç¨‹. é‚£ä¹ˆ OOM Killer å°±æ˜¯"),t("mark",[t("strong",[s._v("åœ¨ Linux ç³»ç»Ÿé‡Œå¦‚æœå†…å­˜ä¸è¶³æ—¶, å°±éœ€è¦æ€æ­»ä¸€ä¸ªæ­£åœ¨è¿è¡Œçš„è¿›ç¨‹æ¥é‡Šæ”¾ä¸€äº›å†…å­˜")])]),s._v("â€‹ **. **")]),s._v(" "),t("p",[s._v("é‚£ä¹ˆè®²åˆ°è¿™é‡Œ, ä½ å¯èƒ½ä¼šæœ‰ä¸ªé—®é¢˜äº†, Linux é‡Œçš„ç¨‹åºéƒ½æ˜¯"),t("strong",[s._v("è°ƒç”¨ malloc() æ¥ç”³è¯·å†…å­˜, å¦‚æœå†…å­˜ä¸è¶³, ç›´æ¥ malloc() è¿”å›å¤±è´¥å°±å¯ä»¥, ä¸ºä»€ä¹ˆè¿˜è¦å»æ€æ­»æ­£åœ¨è¿è¡Œçš„è¿›ç¨‹")]),s._v("å‘¢? å…¶å®è¿™ä¸ªå’Œ Linux è¿›ç¨‹çš„å†…å­˜ç”³è¯·ç­–ç•¥æœ‰å…³, Linux å…è®¸è¿›ç¨‹åœ¨ç”³è¯·å†…å­˜çš„æ—¶å€™æ˜¯ overcommit çš„, è¿™æ˜¯ä»€ä¹ˆæ„æ€å‘¢? å°±æ˜¯è¯´å…è®¸è¿›ç¨‹ç”³è¯·è¶…è¿‡å®é™…ç‰©ç†å†…å­˜ä¸Šé™çš„å†…å­˜.")]),s._v(" "),t("p",[s._v("ä¸ºäº†æ›´å¥½åœ°ç†è§£, æˆ‘ä¸¾ä¸ªä¾‹å­è¯´æ˜. æ¯”å¦‚èŠ‚ç‚¹ä¸Šçš„ç©ºé—²ç‰©ç†å†…å­˜åªæœ‰ 512MB äº†, ä½†æ˜¯å¦‚æœä¸€ä¸ªè¿›ç¨‹è°ƒç”¨ malloc() ç”³è¯·äº† 600MB, é‚£ä¹ˆ malloc() çš„è¿™æ¬¡ç”³è¯·è¿˜æ˜¯è¢«"),t("strong",[s._v("å…è®¸")]),s._v("çš„. è¿™æ˜¯å› ä¸º malloc() ç”³è¯·çš„æ˜¯"),t("strong",[s._v("å†…å­˜çš„è™šæ‹Ÿåœ°å€, ç³»ç»Ÿåªæ˜¯ç»™äº†ç¨‹åºä¸€ä¸ªåœ°å€èŒƒå›´, ç”±äºæ²¡æœ‰å†™å…¥æ•°æ®, æ‰€ä»¥ç¨‹åºå¹¶æ²¡æœ‰å¾—åˆ°çœŸæ­£çš„ç‰©ç†å†…å­˜. ç‰©ç†å†…å­˜åªæœ‰ç¨‹åºçœŸçš„å¾€è¿™ä¸ªåœ°å€å†™å…¥æ•°æ®çš„æ—¶å€™, æ‰ä¼šåˆ†é…ç»™ç¨‹åº")]),s._v(".")]),s._v(" "),t("p",[s._v("å¯ä»¥çœ‹å¾—å‡ºæ¥, è¿™ç§ overcommit çš„å†…å­˜ç”³è¯·æ¨¡å¼å¯ä»¥å¸¦æ¥ä¸€ä¸ªå¥½å¤„, å®ƒå¯ä»¥æœ‰æ•ˆæé«˜ç³»ç»Ÿçš„å†…å­˜åˆ©ç”¨ç‡. ä¸è¿‡è¿™ä¹Ÿå¸¦æ¥äº†ä¸€ä¸ªé—®é¢˜, å°±æ˜¯ç‰©ç†å†…å­˜çœŸçš„ä¸å¤Ÿäº†, åˆè¯¥æ€ä¹ˆåŠå‘¢? æ‰“ä¸ªæ¯”æ–¹, è¿™ä¸ªæœ‰ç‚¹åƒèˆªç©ºå…¬å¸åœ¨å–é£æœºç¥¨. å”®å–é£æœºç¥¨çš„æ—¶å€™å¾€å¾€æ˜¯"),t("strong",[s._v("è¶…å”®")]),s._v("çš„. æ¯”å¦‚å®é™…ä¸Šæœ‰ 100 ä¸ªä½å­, èˆªç©ºå…¬å¸ä¼šå– 105 å¼ æœºç¥¨, åœ¨ç™»æœºçš„æ—¶å€™å¦‚æœå®é™…ç™»æœºçš„ä¹˜å®¢è¶…è¿‡äº† 100 ä¸ª, é‚£ä¹ˆå°±éœ€è¦æŒ‰ç…§ä¸€å®šè§„åˆ™, ä¸å…è®¸å¤šå‡ºçš„å‡ ä½ä¹˜å®¢ç™»æœºäº†.")]),s._v(" "),t("p",[s._v("åŒæ ·çš„é“ç†, é‡åˆ°å†…å­˜ä¸å¤Ÿçš„è¿™ç§æƒ…å†µ, "),t("strong",[s._v("Linux é‡‡å–çš„æªæ–½å°±æ˜¯æ€æ­»æŸä¸ªæ­£åœ¨è¿è¡Œçš„è¿›ç¨‹")]),s._v(".")]),s._v(" "),t("p",[s._v("é‚£ä¹ˆä¸€å®šä¼šé—®äº†, åœ¨å‘ç”Ÿ OOM çš„æ—¶å€™, Linux åˆ°åº•æ˜¯æ ¹æ®"),t("strong",[s._v("ä»€ä¹ˆæ ‡å‡†")]),s._v("æ¥é€‰æ‹©è¢«æ€çš„è¿›ç¨‹å‘¢? è¿™å°±è¦æåˆ°ä¸€ä¸ªåœ¨ Linux å†…æ ¸é‡Œæœ‰ä¸€ä¸ª "),t("strong",[s._v("oom_badness() å‡½æ•°")]),s._v(", å°±æ˜¯å®ƒå®šä¹‰äº†é€‰æ‹©è¿›ç¨‹çš„æ ‡å‡†. å…¶å®è¿™é‡Œçš„åˆ¤æ–­æ ‡å‡†ä¹Ÿå¾ˆç®€å•, å‡½æ•°ä¸­æ¶‰åŠä¸¤ä¸ªæ¡ä»¶:")]),s._v(" "),t("p",[s._v("ç¬¬ä¸€, "),t("strong",[s._v("è¿›ç¨‹å·²ç»ä½¿ç”¨çš„ç‰©ç†å†…å­˜é¡µé¢æ•°")]),s._v(".")]),s._v(" "),t("p",[s._v("ç¬¬äºŒ, "),t("strong",[s._v("æ¯ä¸ªè¿›ç¨‹çš„ OOM æ ¡å‡†å€¼ oom_score_adj")]),s._v(". åœ¨ /proc æ–‡ä»¶ç³»ç»Ÿä¸­, æ¯ä¸ªè¿›ç¨‹éƒ½æœ‰ä¸€ä¸ª /proc//oom_score_adj çš„æ¥å£æ–‡ä»¶. å¯ä»¥åœ¨è¿™ä¸ªæ–‡ä»¶ä¸­è¾“å…¥ -1000 åˆ° 1000 ä¹‹é—´çš„ä»»æ„ä¸€ä¸ªæ•°å€¼, è°ƒæ•´è¿›ç¨‹"),t("strong",[s._v("è¢« OOM Kill çš„å‡ ç‡")]),s._v(".")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("adj "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("long"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("p-"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("signal-"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("oom_score_adj"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\npoints "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" get_mm_rss"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("p-"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("mm"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" + get_mm_counter"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("p-"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("mm, MM_SWAPENTS"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" +mm_pgtables_bytes"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("p-"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("mm"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" / PAGE_SIZE"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\nadj *"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" totalpages / "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1000")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\npoints "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+=")]),s._v(" adj"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br")])]),t("p",[s._v("ç»“åˆå‰é¢è¯´çš„ä¸¤ä¸ªæ¡ä»¶, å‡½æ•° oom_badness() é‡Œçš„æœ€ç»ˆè®¡ç®—æ–¹æ³•æ˜¯è¿™æ ·çš„:")]),s._v(" "),t("p",[s._v("**ç”¨ç³»ç»Ÿæ€»çš„å¯ç”¨é¡µé¢æ•°, å»ä¹˜ä»¥ OOM æ ¡å‡†å€¼ oom_score_adj, å†åŠ ä¸Šè¿›ç¨‹å·²ç»ä½¿ç”¨çš„ç‰©ç†é¡µé¢æ•°, è®¡ç®—å‡ºæ¥çš„å€¼è¶Šå¤§, é‚£ä¹ˆè¿™ä¸ªè¿›ç¨‹è¢« OOM Kill çš„å‡ ç‡ä¹Ÿå°±è¶Šå¤§. **")]),s._v(" "),t("h6",{attrs:{id:"_2-å¦‚ä½•ç†è§£memory-cgroup"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-å¦‚ä½•ç†è§£memory-cgroup"}},[s._v("#")]),s._v(" (2)å¦‚ä½•ç†è§£Memory Cgroup?")]),s._v(" "),t("p",[s._v("å‰é¢ä»‹ç»äº† OOM Killer, å®¹å™¨å‘ç”Ÿ OOM Kill å¤§å¤šæ˜¯å› ä¸º Memory Cgroup çš„é™åˆ¶æ‰€å¯¼è‡´çš„, æ‰€ä»¥åœ¨è¿˜éœ€è¦"),t("strong",[s._v("ç†è§£ Memory Cgroup çš„è¿è¡Œæœºåˆ¶")]),s._v(". å‰é¢è®²è¿‡ Cgroups æ˜¯å®¹å™¨çš„ä¸¤å¤§æ”¯æŸ±æŠ€æœ¯ä¹‹ä¸€, åœ¨ CPU çš„ç« èŠ‚ä¸­, ä¹Ÿè®²åˆ°äº† CPU Cgroups. é‚£ä¹ˆæŒ‰ç…§åŒæ ·çš„æ€è·¯, æƒ³ç†è§£å®¹å™¨ Memory, è‡ªç„¶è¦è®¨è®ºä¸€ä¸‹ Memory Cgroup äº†.")]),s._v(" "),t("p",[s._v('**Memory Cgroup ä¹Ÿæ˜¯ Linux Cgroups å­ç³»ç»Ÿä¹‹ä¸€, å®ƒçš„ä½œç”¨æ˜¯å¯¹ä¸€ç»„è¿›ç¨‹çš„ Memory ä½¿ç”¨åšé™åˆ¶. Memory Cgroup çš„è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿçš„æŒ‚è½½ç‚¹ä¸€èˆ¬åœ¨ "/sys/fs/cgroup/memory" è¿™ä¸ªç›®å½•ä¸‹, è¿™ä¸ªå’Œ CPU Cgroup ç±»ä¼¼. å¯ä»¥åœ¨ Memory Cgroup çš„æŒ‚è½½ç‚¹ç›®å½•ä¸‹, åˆ›å»ºä¸€ä¸ªå­ç›®å½•ä½œä¸ºæ§åˆ¶ç»„. **')]),s._v(" "),t("p",[s._v("æ¯ä¸€ä¸ªæ§åˆ¶ç»„ä¸‹é¢æœ‰ä¸å°‘å‚æ•°, åœ¨è¿™ä¸€è®²é‡Œ, è¿™é‡Œåªè®²è·Ÿ OOM æœ€ç›¸å…³çš„ 3 ä¸ªå‚æ•°: "),t("strong",[s._v("memory.limit_in_bytes, memory.oom_control å’Œ memory.usage_in_bytes")]),s._v(". å…¶ä»–å‚æ•°å¦‚æœæœ‰å…´è¶£, å¯ä»¥å‚è€ƒå†…æ ¸çš„æ–‡æ¡£è¯´æ˜.")]),s._v(" "),t("p",[s._v("é¦–å…ˆæ¥çœ‹ç¬¬ä¸€ä¸ªå‚æ•° "),t("strong",[s._v("memory.limit_in_bytes")]),s._v(". è¯·æ³¨æ„, è¿™ä¸ª memory.limit_in_bytes æ˜¯æ¯ä¸ªæ§åˆ¶ç»„é‡Œ"),t("strong",[s._v("æœ€é‡è¦")]),s._v("çš„ä¸€ä¸ªå‚æ•°äº†. è¿™æ˜¯å› ä¸º"),t("mark",[t("strong",[s._v("ä¸€ä¸ªæ§åˆ¶ç»„é‡Œæ‰€æœ‰è¿›ç¨‹å¯ä½¿ç”¨å†…å­˜çš„æœ€å¤§å€¼, å°±æ˜¯ç”±è¿™ä¸ªå‚æ•°çš„å€¼æ¥ç›´æ¥é™åˆ¶çš„")])]),s._v(".")]),s._v(" "),t("p",[s._v("é‚£ä¹ˆä¸€æ—¦è¾¾åˆ°äº†æœ€å¤§å€¼, åœ¨è¿™ä¸ªæ§åˆ¶ç»„é‡Œçš„è¿›ç¨‹ä¼šå‘ç”Ÿä»€ä¹ˆå‘¢?")]),s._v(" "),t("p",[s._v("è¿™å°±æ¶‰åŠåˆ°ç¬¬äºŒä¸ªå‚æ•° "),t("strong",[s._v("memory.oom_control")]),s._v(" äº†. è¿™ä¸ª memory.oom_control åˆæ˜¯å¹²å•¥çš„å‘¢? å½“æ§åˆ¶ç»„ä¸­çš„è¿›ç¨‹å†…å­˜ä½¿ç”¨è¾¾åˆ°ä¸Šé™å€¼æ—¶, è¿™ä¸ªå‚æ•°"),t("strong",[s._v("èƒ½å¤Ÿå†³å®šä¼šä¸ä¼šè§¦å‘ OOM Killer")]),s._v(". å¦‚æœæ²¡æœ‰äººä¸ºè®¾ç½®çš„è¯, memory.oom_control çš„ç¼ºçœå€¼é»˜è®¤å°±ä¼šè§¦å‘ OOM Killer. è¿™æ˜¯ä¸€ä¸ªæ§åˆ¶ç»„å†…çš„ OOM Killer, å’Œæ•´ä¸ªç³»ç»Ÿçš„ OOM Killer çš„åŠŸèƒ½å·®ä¸å¤š, å·®åˆ«åªæ˜¯è¢«æ€è¿›ç¨‹çš„é€‰æ‹©èŒƒå›´: æ§åˆ¶ç»„å†…çš„ OOM Killer å½“ç„¶åªèƒ½æ€æ­»æ§åˆ¶ç»„å†…çš„è¿›ç¨‹, è€Œä¸èƒ½é€‰èŠ‚ç‚¹ä¸Šçš„å…¶ä»–è¿›ç¨‹. å¦‚æœè¦æ”¹å˜ç¼ºçœå€¼, ä¹Ÿå°±æ˜¯ä¸å¸Œæœ›è§¦å‘ OOM Killer, åªè¦æ‰§è¡Œ "),t("code",[s._v("echo 1 > memory.oom_control")]),s._v("â€‹ å°±è¡Œäº†, è¿™æ—¶å€™å³ä½¿æ§åˆ¶ç»„é‡Œæ‰€æœ‰è¿›ç¨‹ä½¿ç”¨çš„å†…å­˜è¾¾åˆ° memory.limit_in_bytes è®¾ç½®çš„ä¸Šé™å€¼, "),t("strong",[s._v("æ§åˆ¶ç»„ä¹Ÿä¸ä¼šæ€æ‰é‡Œé¢çš„è¿›ç¨‹")]),s._v(".")]),s._v(" "),t("p",[s._v("éœ€è¦æ³¨æ„è¿™æ ·æ“ä½œä»¥å, å°±ä¼š"),t("strong",[s._v("å½±å“åˆ°æ§åˆ¶ç»„ä¸­æ­£åœ¨ç”³è¯·ç‰©ç†å†…å­˜é¡µé¢çš„è¿›ç¨‹")]),s._v(". è¿™äº›è¿›ç¨‹ä¼šå¤„äºä¸€ä¸ªåœæ­¢çŠ¶æ€, ä¸èƒ½å¾€ä¸‹è¿è¡Œäº†.")]),s._v(" "),t("p",[s._v("æœ€åç¬¬ä¸‰ä¸ªå‚æ•°, ä¹Ÿå°±æ˜¯ "),t("strong",[s._v("memory.usage_in_bytes")]),s._v(". è¿™ä¸ªå‚æ•°æ˜¯åªè¯»çš„, å®ƒé‡Œé¢çš„æ•°å€¼æ˜¯å½“å‰æ§åˆ¶ç»„é‡Œ"),t("strong",[s._v("æ‰€æœ‰è¿›ç¨‹å®é™…ä½¿ç”¨çš„å†…å­˜æ€»å’Œ")]),s._v(". å¯ä»¥æŸ¥çœ‹è¿™ä¸ªå€¼, ç„¶åæŠŠå®ƒå’Œ memory.limit_in_bytes é‡Œçš„å€¼åšæ¯”è¾ƒ, æ ¹æ®æ¥è¿‘ç¨‹åº¦æ¥å¯ä»¥åšä¸ªé¢„åˆ¤. è¿™ä¸¤ä¸ªå€¼è¶Šæ¥è¿‘, OOM çš„é£é™©è¶Šé«˜. é€šè¿‡è¿™ä¸ªæ–¹æ³•å°±å¯ä»¥å¾—çŸ¥, å½“å‰æ§åˆ¶ç»„å†…ä½¿ç”¨æ€»çš„å†…å­˜é‡æœ‰æ²¡æœ‰ OOM çš„é£é™©äº†.")]),s._v(" "),t("p",[s._v("æ§åˆ¶ç»„ä¹‹é—´ä¹ŸåŒæ ·æ˜¯æ ‘çŠ¶çš„"),t("strong",[s._v("å±‚çº§ç»“æ„")]),s._v(", åœ¨è¿™ä¸ªç»“æ„ä¸­, çˆ¶èŠ‚ç‚¹çš„æ§åˆ¶ç»„é‡Œçš„ memory.limit_in_bytes å€¼, å°±å¯ä»¥é™åˆ¶å®ƒçš„å­èŠ‚ç‚¹ä¸­æ‰€æœ‰è¿›ç¨‹çš„å†…å­˜ä½¿ç”¨.")]),s._v(" "),t("p",[s._v("ç”¨ä¸€ä¸ªå…·ä½“ä¾‹å­æ¥è¯´æ˜, æ¯”å¦‚åƒä¸‹é¢å›¾é‡Œå±•ç¤ºçš„é‚£æ ·, group1 é‡Œçš„ memory.limit_in_bytes è®¾ç½®çš„å€¼æ˜¯ 200MB, å®ƒçš„å­æ§åˆ¶ç»„ group3 é‡Œ memory.limit_in_bytes å€¼æ˜¯ 500MB. é‚£ä¹ˆåœ¨ group3 é‡Œæ‰€æœ‰è¿›ç¨‹ä½¿ç”¨çš„å†…å­˜æ€»å€¼å°±ä¸èƒ½è¶…è¿‡ 200MB, è€Œä¸æ˜¯ 500MB.")]),s._v(" "),t("p",[t("img",{attrs:{src:"/img/2a497b0a2e293ecf4200dc5d38c598ad-20230731161430-ufku8zx.png",alt:""}})]),s._v(" "),t("p",[s._v("è¿™é‡Œä»‹ç»äº† Memory Cgroup æœ€åŸºæœ¬çš„æ¦‚å¿µ, ç®€å•æ€»ç»“ä¸€ä¸‹:")]),s._v(" "),t("p",[s._v('ç¬¬ä¸€, Memory Cgroup ä¸­æ¯ä¸€ä¸ªæ§åˆ¶ç»„å¯ä»¥ä¸ºä¸€ç»„è¿›ç¨‹é™åˆ¶å†…å­˜ä½¿ç”¨é‡, ä¸€æ—¦æ‰€æœ‰è¿›ç¨‹ä½¿ç”¨å†…å­˜çš„æ€»é‡è¾¾åˆ°é™åˆ¶å€¼, ç¼ºçœæƒ…å†µä¸‹, å°±ä¼šè§¦å‘ OOM Killer. è¿™æ ·ä¸€æ¥, æ§åˆ¶ç»„é‡Œçš„ "æŸä¸ªè¿›ç¨‹" å°±ä¼šè¢«æ€æ­».')]),s._v(" "),t("p",[s._v('ç¬¬äºŒ, è¿™é‡Œæ€æ­» "æŸä¸ªè¿›ç¨‹" çš„é€‰æ‹©æ ‡å‡†æ˜¯, **æ§åˆ¶ç»„ä¸­æ€»çš„å¯ç”¨é¡µé¢ä¹˜ä»¥è¿›ç¨‹çš„ oom_score_adj, åŠ ä¸Šè¿›ç¨‹å·²ç»ä½¿ç”¨çš„ç‰©ç†å†…å­˜é¡µé¢, æ‰€å¾—å€¼æœ€å¤§çš„è¿›ç¨‹, å°±ä¼šè¢«ç³»ç»Ÿé€‰ä¸­æ€æ­». **')]),s._v(" "),t("h5",{attrs:{id:"_2-è§£å†³é—®é¢˜"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-è§£å†³é—®é¢˜"}},[s._v("#")]),s._v(" 2.è§£å†³é—®é¢˜")]),s._v(" "),t("p",[s._v("è§£é‡Šäº† Memory Cgroup å’Œ OOM Killer å, ä½ åº”è¯¥æ˜ç™½äº†ä¸ºä»€ä¹ˆå®¹å™¨åœ¨è¿è¡Œè¿‡ç¨‹ä¸­ä¼šçªç„¶æ¶ˆå¤±äº†. å¯¹äºæ¯ä¸ªå®¹å™¨åˆ›å»ºå, ç³»ç»Ÿéƒ½ä¼šä¸ºå®ƒ"),t("strong",[s._v("å»ºç«‹ä¸€ä¸ª Memory Cgroup çš„æ§åˆ¶ç»„, å®¹å™¨çš„æ‰€æœ‰è¿›ç¨‹éƒ½åœ¨è¿™ä¸ªæ§åˆ¶ç»„é‡Œ")]),s._v(".")]),s._v(" "),t("p",[s._v("ä¸€èˆ¬çš„å®¹å™¨äº‘å¹³å°, æ¯”å¦‚ Kubernetes éƒ½ä¼šä¸ºå®¹å™¨è®¾ç½®ä¸€ä¸ª"),t("strong",[s._v("å†…å­˜ä½¿ç”¨çš„ä¸Šé™")]),s._v(". è¿™ä¸ªå†…å­˜çš„ä¸Šé™å€¼ä¼šè¢«å†™å…¥ Cgroup é‡Œ, å…·ä½“æ¥è¯´å°±æ˜¯å®¹å™¨å¯¹åº”çš„ Memory Cgroup æ§åˆ¶ç»„é‡Œ "),t("strong",[s._v("memory.limit_in_bytes")]),s._v(" è¿™ä¸ªå‚æ•°ä¸­.  æ‰€ä»¥ä¸€æ—¦å®¹å™¨ä¸­"),t("strong",[s._v("è¿›ç¨‹ä½¿ç”¨çš„å†…å­˜è¾¾åˆ°äº†ä¸Šé™å€¼")]),s._v(", OOM Killer ä¼šæ€æ­»è¿›ç¨‹ä½¿å®¹å™¨é€€å‡º.")]),s._v(" "),t("p",[s._v("**é‚£ä¹ˆæ€æ ·æ‰èƒ½å¿«é€Ÿç¡®å®šå®¹å™¨å‘ç”Ÿäº† OOM å‘¢? è¿™ä¸ªå¯ä»¥é€šè¿‡æŸ¥çœ‹å†…æ ¸æ—¥å¿—åŠæ—¶åœ°å‘ç°. **")]),s._v(" "),t("p",[s._v("è¿˜æ˜¯æ‹¿è¿™ä¸€è®²æœ€å¼€å§‹å‘ç”Ÿ OOM çš„å®¹å™¨ä½œä¸ºä¾‹å­. é€šè¿‡æŸ¥çœ‹å†…æ ¸çš„æ—¥å¿—, ä½¿ç”¨ç”¨ "),t("code",[s._v("journal -k")]),s._v("â€‹ å‘½ä»¤, æˆ–è€…ç›´æ¥æŸ¥çœ‹æ—¥å¿—æ–‡ä»¶  "),t("strong",[s._v("/var/log/message")]),s._v(", ä¼šå‘ç°å½“å®¹å™¨å‘ç”Ÿ OOM Kill çš„æ—¶å€™, å†…æ ¸ä¼šè¾“å‡ºä¸‹é¢çš„è¿™æ®µä¿¡æ¯, å¤§è‡´åŒ…å«ä¸‹é¢è¿™ä¸‰éƒ¨åˆ†çš„ä¿¡æ¯:")]),s._v(" "),t("p",[s._v('ç¬¬ä¸€ä¸ªéƒ¨åˆ†å°±æ˜¯**å®¹å™¨é‡Œæ¯ä¸€ä¸ªè¿›ç¨‹ä½¿ç”¨çš„å†…å­˜é¡µé¢æ•°é‡. ** åœ¨ "rss" åˆ—é‡Œ, "rss" æ˜¯ Resident Set Size çš„ç¼©å†™, æŒ‡çš„å°±æ˜¯è¿›ç¨‹çœŸæ­£åœ¨ä½¿ç”¨çš„ç‰©ç†å†…å­˜é¡µé¢æ•°é‡.')]),s._v(" "),t("p",[s._v('æ¯”å¦‚ä¸‹é¢çš„æ—¥å¿—é‡Œ, çœ‹åˆ° init è¿›ç¨‹çš„ "rss" æ˜¯ 1 ä¸ªé¡µé¢, mem_alloc è¿›ç¨‹çš„ "rss" æ˜¯ 130801 ä¸ªé¡µé¢, å†…å­˜é¡µé¢çš„å¤§å°ä¸€èˆ¬æ˜¯ 4KB, å¯ä»¥åšä¸ªä¼°ç®—, 130801 * 4KB å¤§è‡´ç­‰äº 512MB.')]),s._v(" "),t("p",[t("img",{attrs:{src:"/img/b8796ec34cc2fffec4ca808517868b05-20230731161430-402r009.png",alt:""}})]),s._v(" "),t("p",[s._v("ç¬¬äºŒéƒ¨åˆ†æ¥çœ‹ä¸Šé¢å›¾ç‰‡çš„  "),t("strong",[s._v('"oom-kill:"')]),s._v("  è¿™è¡Œ, è¿™ä¸€è¡Œé‡Œåˆ—å‡ºäº†å‘ç”Ÿ OOM çš„ "),t("strong",[s._v("Memroy Cgroup çš„æ§åˆ¶ç»„")]),s._v(", å¯ä»¥ä»æ§åˆ¶ç»„çš„ä¿¡æ¯ä¸­çŸ¥é“ OOM æ˜¯åœ¨å“ªä¸ªå®¹å™¨å‘ç”Ÿçš„.")]),s._v(" "),t("p",[s._v('ç¬¬ä¸‰éƒ¨åˆ†æ˜¯å›¾ä¸­  **"Killed process 7445 (mem_alloc)" è¿™è¡Œ, å®ƒæ˜¾ç¤ºäº†æœ€ç»ˆè¢« OOM Killer æ€æ­»çš„è¿›ç¨‹. **')]),s._v(" "),t("p",[s._v("é€šè¿‡äº†è§£å†…æ ¸æ—¥å¿—é‡Œçš„è¿™äº›ä¿¡æ¯, å¯ä»¥å¾ˆå¿«åœ°åˆ¤æ–­å‡ºå®¹å™¨æ˜¯å› ä¸º OOM è€Œé€€å‡ºçš„, å¹¶ä¸”è¿˜å¯ä»¥çŸ¥é“æ˜¯å“ªä¸ªè¿›ç¨‹æ¶ˆè€—äº†æœ€å¤šçš„ Memory.")]),s._v(" "),t("p",[s._v("é‚£ä¹ˆçŸ¥é“äº†å“ªä¸ªè¿›ç¨‹æ¶ˆè€—äº†æœ€å¤§å†…å­˜ä¹‹å, å°±å¯ä»¥æœ‰é’ˆå¯¹æ€§åœ°å¯¹è¿™ä¸ªè¿›ç¨‹è¿›è¡Œåˆ†æäº†, ä¸€èˆ¬æœ‰è¿™ä¸¤ç§æƒ…å†µ:")]),s._v(" "),t("p",[s._v("ç¬¬ä¸€ç§æƒ…å†µæ˜¯"),t("strong",[s._v("è¿™ä¸ªè¿›ç¨‹æœ¬èº«çš„ç¡®éœ€è¦å¾ˆå¤§çš„å†…å­˜")]),s._v(", è¿™è¯´æ˜ç»™ memory.limit_in_bytes é‡Œçš„å†…å­˜ä¸Šé™å€¼è®¾ç½®å°äº†, é‚£ä¹ˆå°±éœ€è¦å¢å¤§å†…å­˜çš„ä¸Šé™å€¼.")]),s._v(" "),t("p",[s._v("ç¬¬äºŒç§æƒ…å†µæ˜¯**è¿›ç¨‹çš„ä»£ç ä¸­æœ‰ Bug, ä¼šå¯¼è‡´å†…å­˜æ³„æ¼, è¿›ç¨‹å†…å­˜ä½¿ç”¨åˆ°è¾¾äº† Memory Cgroup ä¸­çš„ä¸Šé™. ** å¦‚æœæ˜¯è¿™ç§æƒ…å†µ, å°±éœ€è¦å…·ä½“å»è§£å†³ä»£ç é‡Œçš„é—®é¢˜äº†.")]),s._v(" "),t("h5",{attrs:{id:"_3-é‡ç‚¹æ€»ç»“-3"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-é‡ç‚¹æ€»ç»“-3"}},[s._v("#")]),s._v(" 3.é‡ç‚¹æ€»ç»“")]),s._v(" "),t("p",[s._v("æœ¬èŠ‚ä»å®¹å™¨åœ¨ç³»ç»Ÿä¸­è¢«æ€çš„é—®é¢˜, å­¦ä¹ äº† OOM Killer å’Œ Memory Cgroup è¿™ä¸¤ä¸ªæ¦‚å¿µ. OOM Killer è¿™ä¸ªè¡Œä¸ºåœ¨ Linux ä¸­å¾ˆæ—©å°±å­˜åœ¨äº†, å®ƒå…¶å®æ˜¯"),t("strong",[s._v("ä¸€ç§å†…å­˜è¿‡è½½åçš„ä¿æŠ¤æœºåˆ¶, é€šè¿‡ç‰ºç‰²ä¸ªåˆ«çš„è¿›ç¨‹, æ¥ä¿è¯æ•´ä¸ªèŠ‚ç‚¹çš„å†…å­˜ä¸ä¼šè¢«å…¨éƒ¨æ¶ˆè€—æ‰")]),s._v(".")]),s._v(" "),t("p",[s._v('åœ¨ Cgroup çš„æ¦‚å¿µå‡ºç°å, Memory Cgroup ä¸­æ¯ä¸€ä¸ªæ§åˆ¶ç»„å¯ä»¥å¯¹ä¸€ç»„è¿›ç¨‹é™åˆ¶å†…å­˜ä½¿ç”¨é‡, ä¸€æ—¦æ‰€æœ‰è¿›ç¨‹ä½¿ç”¨å†…å­˜çš„æ€»é‡è¾¾åˆ°é™åˆ¶å€¼, åœ¨ç¼ºçœæƒ…å†µä¸‹, å°±ä¼šè§¦å‘ OOM Killer, æ§åˆ¶ç»„é‡Œçš„ "æŸä¸ªè¿›ç¨‹" å°±ä¼šè¢«æ€æ­».')]),s._v(" "),t("p",[s._v('è¯·æ³¨æ„, è¿™é‡Œ Linux ç³»ç»Ÿè‚¯å®šä¸èƒ½éšå¿ƒæ‰€æ¬²åœ°æ€æ‰è¿›ç¨‹, é‚£å…·ä½“è¦ç”¨ä»€ä¹ˆé€‰æ‹©æ ‡å‡†å‘¢? æ€æ‰ "æŸä¸ªè¿›ç¨‹" çš„é€‰æ‹©æ ‡å‡†, æ¶‰åŠåˆ°å†…æ ¸å‡½æ•° oom_badness(). å…·ä½“çš„è®¡ç®—æ–¹æ³•æ˜¯: **ç³»ç»Ÿæ€»çš„å¯ç”¨é¡µé¢æ•°ä¹˜ä»¥è¿›ç¨‹çš„ OOM æ ¡å‡†å€¼ oom_score_adj, å†åŠ ä¸Šè¿›ç¨‹å·²ç»ä½¿ç”¨çš„ç‰©ç†é¡µé¢æ•°, è®¡ç®—å‡ºæ¥çš„å€¼è¶Šå¤§, é‚£ä¹ˆè¿™ä¸ªè¿›ç¨‹è¢« OOM Kill çš„å‡ ç‡ä¹Ÿå°±è¶Šå¤§. **')]),s._v(" "),t("p",[s._v("æ¥ä¸‹æ¥, è®²è§£äº† Memory Cgroup é‡Œæœ€åŸºæœ¬çš„ä¸‰ä¸ªå‚æ•°, åˆ†åˆ«æ˜¯ **memory.limit_in_bytes,  memory.oom_control å’Œ memory.usage_in_bytes. ** è¿™é‡ŒæŠŠè¿™ä¸‰ä¸ªå‚æ•°çš„ä½œç”¨, æ€»ç»“æˆäº†ä¸€å¼ å›¾. ç¬¬ä¸€ä¸ªå’Œç¬¬ä¸‰ä¸ªå‚æ•°, ä¸‹ä¸€èŠ‚è¿˜ä¼šç”¨åˆ°, è¿™é‡Œå¯ä»¥å…ˆæœ‰ä¸ªå°è±¡.")]),s._v(" "),t("p",[t("img",{attrs:{src:"/img/9222abe8d22c30daccffdfd23e95d13c-20230731161430-qffk334.png",alt:""}})]),s._v(" "),t("p",[s._v("å®¹å™¨å› ä¸º OOM è¢«æ€, è¦å¦‚ä½•å¤„ç†å‘¢? "),t("strong",[s._v("å¯ä»¥é€šè¿‡å†…æ ¸æ—¥å¿—åšæ’æŸ¥, æŸ¥çœ‹å®¹å™¨é‡Œå†…å­˜ä½¿ç”¨æœ€å¤šçš„è¿›ç¨‹, ç„¶åå¯¹å®ƒè¿›è¡Œåˆ†æ")]),s._v(". æ ¹æ®ç»éªŒ, "),t("strong",[s._v("è§£å†³æ€è·¯è¦ä¹ˆæ˜¯æé«˜å®¹å™¨çš„æœ€å¤§å†…å­˜é™åˆ¶, è¦ä¹ˆéœ€è¦å…·ä½“å»è§£å†³è¿›ç¨‹ä»£ç çš„ BUG")]),s._v(".")]),s._v(" "),t("h4",{attrs:{id:"_09-page-cache-ä¸ºä»€ä¹ˆæˆ‘çš„å®¹å™¨å†…å­˜ä½¿ç”¨é‡æ€»æ˜¯åœ¨ä¸´ç•Œç‚¹"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_09-page-cache-ä¸ºä»€ä¹ˆæˆ‘çš„å®¹å™¨å†…å­˜ä½¿ç”¨é‡æ€»æ˜¯åœ¨ä¸´ç•Œç‚¹"}},[s._v("#")]),s._v(" 09 | Page Cache:ä¸ºä»€ä¹ˆæˆ‘çš„å®¹å™¨å†…å­˜ä½¿ç”¨é‡æ€»æ˜¯åœ¨ä¸´ç•Œç‚¹?")]),s._v(" "),t("p",[s._v("ä¸Šä¸€èŠ‚è®²äº† Memory Cgroup æ˜¯å¦‚ä½•æ§åˆ¶ä¸€ä¸ªå®¹å™¨çš„å†…å­˜çš„. å¦‚æœå®¹å™¨ä½¿ç”¨çš„ç‰©ç†å†…å­˜è¶…è¿‡äº† Memory Cgroup é‡Œçš„ memory.limit_in_bytes å€¼, é‚£ä¹ˆå®¹å™¨ä¸­çš„è¿›ç¨‹ä¼šè¢« OOM Killer æ€æ­».")]),s._v(" "),t("p",[s._v("ä¸è¿‡åœ¨ä¸€äº›å®¹å™¨çš„ä½¿ç”¨åœºæ™¯ä¸­, æ¯”å¦‚å®¹å™¨é‡Œçš„åº”ç”¨æœ‰å¾ˆå¤šæ–‡ä»¶è¯»å†™, ä½ ä¼šå‘ç°"),t("strong",[s._v("æ•´ä¸ªå®¹å™¨çš„å†…å­˜ä½¿ç”¨é‡å·²ç»å¾ˆæ¥è¿‘ Memory Cgroup çš„ä¸Šé™å€¼äº†, ä½†æ˜¯åœ¨å®¹å™¨ä¸­æ¥ç€å†ç”³è¯·å†…å­˜, è¿˜æ˜¯å¯ä»¥ç”³è¯·å‡ºæ¥, å¹¶ä¸”æ²¡æœ‰å‘ç”Ÿ OOM")]),s._v(".")]),s._v(" "),t("p",[s._v("è¿™æ˜¯æ€ä¹ˆå›äº‹å‘¢? æœ¬èŠ‚å°±æ¥èŠèŠè¿™ä¸ªé—®é¢˜.")]),s._v(" "),t("h5",{attrs:{id:"_1-é—®é¢˜å†ç°-5"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-é—®é¢˜å†ç°-5"}},[s._v("#")]),s._v(" 1.é—®é¢˜å†ç°")]),s._v(" "),t("p",[s._v("å¯ä»¥ç”¨è¿™é‡Œçš„ä»£ç åšä¸ªå®¹å™¨é•œåƒ, ç„¶åç”¨ä¸‹é¢çš„è¿™ä¸ªè„šæœ¬å¯åŠ¨å®¹å™¨, å¹¶ä¸”è®¾ç½®å®¹å™¨ Memory Cgroup é‡Œçš„å†…å­˜ä¸Šé™å€¼æ˜¯ "),t("strong",[s._v("100MB")]),s._v("(104857600bytes).")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token shebang important"}},[s._v("#!/bin/bash")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" stop page_cache"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("rm")]),s._v(" page_cache\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-f")]),s._v(" ./test.file "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("then")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("dd")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("if")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/dev/zero "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("of")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("./test.file "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("bs")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("4096")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("count")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("30000")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Please run start_container.sh again "')]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("exit")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("fi")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" /proc/sys/vm/drop_caches\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("sleep")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" run "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-d")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--init")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--name")]),s._v(" page_cache "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-v")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token variable"}},[t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$(")]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("pwd")]),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v(")")])]),s._v(":/mnt registry/page_cache_test:v1\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("CONTAINER_ID")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token variable"}},[t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$(")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ps")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--format")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"{{.ID}}'),t("span",{pre:!0,attrs:{class:"token entity",title:"\\t"}},[s._v("\\t")]),s._v('{{.Names}}"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("grep")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-i")]),s._v(" page_cache "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("awk")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'{print $1}'")]),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v(")")])]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$CONTAINER_ID")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("CGROUP_CONTAINER_PATH")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token variable"}},[t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$(")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("find")]),s._v(" /sys/fs/cgroup/memory/ "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-name")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"*'),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$CONTAINER_ID")]),s._v('*"')]),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v(")")])]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("104857600")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$CGROUP_CONTAINER_PATH")]),s._v("/memory.limit_in_bytes\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$CGROUP_CONTAINER_PATH")]),s._v("/memory.limit_in_bytes\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br")])]),t("p",[s._v("æŠŠå®¹å™¨å¯åŠ¨èµ·æ¥å, æŸ¥çœ‹ä¸€ä¸‹å®¹å™¨çš„ Memory Cgroup ä¸‹çš„ "),t("strong",[s._v("memory.limit_in_bytes å’Œ memory.usage_in_bytes")]),s._v(" è¿™ä¸¤ä¸ªå€¼. å¦‚ä¸‹å›¾æ‰€ç¤º, å¯ä»¥çœ‹åˆ°å®¹å™¨å†…å­˜çš„ä¸Šé™å€¼è®¾ç½®ä¸º 104857600bytes(100MB), è€Œè¿™æ—¶æ•´ä¸ªå®¹å™¨çš„å·²ä½¿ç”¨å†…å­˜æ˜¾ç¤ºä¸º 104767488bytes, è¿™ä¸ªå€¼å·²ç»"),t("strong",[s._v("éå¸¸æ¥è¿‘ä¸Šé™")]),s._v("å€¼äº†.")]),s._v(" "),t("p",[s._v("æŠŠå®¹å™¨å†…å­˜ä¸Šé™å€¼å’Œå·²ä½¿ç”¨çš„å†…å­˜æ•°å€¼åšä¸ªå‡æ³•, 104857600â€“104767488 = 90112bytes, åªå·®å¤§æ¦‚ 90KB å·¦å³çš„å¤§å°.")]),s._v(" "),t("p",[t("img",{attrs:{src:"/img/7b592679c71cd6bd0ebecd5e31618855-20230731161430-or4mkd3.png",alt:""}})]),s._v(" "),t("p",[s._v("ä½†å¦‚æœè¿™æ—¶å€™ç»§ç»­å¯åŠ¨ä¸€ä¸ªç¨‹åº, è®©è¿™ä¸ªç¨‹åºç”³è¯·å¹¶ä½¿ç”¨ 50MB çš„ç‰©ç†å†…å­˜, å°±ä¼šå‘ç°è¿™ä¸ªç¨‹åºè¿˜æ˜¯å¯ä»¥è¿è¡ŒæˆåŠŸ, è¿™æ—¶å€™å®¹å™¨å¹¶æ²¡æœ‰å‘ç”Ÿ OOM çš„æƒ…å†µ. è¿™æ—¶å†å»æŸ¥çœ‹å‚æ•° memory.usage_in_bytes, å°±ä¼šå‘ç°å®ƒçš„å€¼å˜æˆäº† 103186432bytes, æ¯”ä¹‹å‰è¿˜å°‘äº†ä¸€äº›. é‚£è¿™æ˜¯æ€ä¹ˆå›äº‹å‘¢?")]),s._v(" "),t("p",[t("img",{attrs:{src:"/img/b2df2152bed5d65857348fa3ea39f6fe-20230731161430-q5ou4v5.png",alt:""}})]),s._v(" "),t("h5",{attrs:{id:"_2-çŸ¥è¯†è¯¦è§£-linux-ç³»ç»Ÿæœ‰é‚£äº›å†…å­˜ç±»å‹"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-çŸ¥è¯†è¯¦è§£-linux-ç³»ç»Ÿæœ‰é‚£äº›å†…å­˜ç±»å‹"}},[s._v("#")]),s._v(" 2.çŸ¥è¯†è¯¦è§£:Linux ç³»ç»Ÿæœ‰é‚£äº›å†…å­˜ç±»å‹?")]),s._v(" "),t("p",[s._v("è¦è§£é‡Šåˆšæ‰çœ‹åˆ°çš„å®¹å™¨é‡Œå†…å­˜åˆ†é…çš„ç°è±¡, å°±éœ€è¦å…ˆç†è§£ Linux æ“ä½œç³»ç»Ÿé‡Œ"),t("strong",[s._v("æœ‰å“ªå‡ ç§å†…å­˜çš„ç±»å‹")]),s._v(". åªæœ‰çŸ¥é“äº†å†…å­˜çš„ç±»å‹, æ‰èƒ½æ˜ç™½"),t("strong",[s._v("æ¯ä¸€ç§ç±»å‹çš„å†…å­˜, å®¹å™¨åˆ†åˆ«ä½¿ç”¨äº†å¤šå°‘. è€Œä¸”å¯¹äºä¸åŒç±»å‹çš„å†…å­˜, ä¸€æ—¦æ€»å†…å­˜å¢é«˜åˆ°å®¹å™¨é‡Œå†…å­˜æœ€é«˜é™åˆ¶çš„æ•°å€¼, ç›¸åº”çš„å¤„ç†æ–¹å¼ä¹Ÿä¸åŒ")]),s._v(".")]),s._v(" "),t("h6",{attrs:{id:"_1-linuxå†…å­˜ç±»å‹"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-linuxå†…å­˜ç±»å‹"}},[s._v("#")]),s._v(" (1)Linuxå†…å­˜ç±»å‹")]),s._v(" "),t("p",[s._v("Linux çš„å„ä¸ªæ¨¡å—éƒ½éœ€è¦å†…å­˜, æ¯”å¦‚å†…æ ¸éœ€è¦åˆ†é…å†…å­˜ç»™é¡µè¡¨, å†…æ ¸æ ˆ, è¿˜æœ‰ slab, ä¹Ÿå°±æ˜¯å†…æ ¸å„ç§æ•°æ®ç»“æ„çš„ Cache Pool; ç”¨æˆ·æ€è¿›ç¨‹é‡Œçš„å †å†…å­˜å’Œæ ˆçš„å†…å­˜, å…±äº«åº“çš„å†…å­˜, è¿˜æœ‰æ–‡ä»¶è¯»å†™çš„ Page Cache.")]),s._v(" "),t("p",[s._v("åœ¨è¿™ä¸€è®²é‡Œ, è®¨è®ºçš„ Memory Cgroup é‡Œéƒ½ä¸ä¼šå¯¹å†…æ ¸çš„å†…å­˜åšé™åˆ¶(æ¯”å¦‚é¡µè¡¨, slab ç­‰). æ‰€ä»¥ä¸»è¦è®¨è®º**ä¸ç”¨æˆ·æ€ç›¸å…³çš„ä¸¤ä¸ªå†…å­˜ç±»å‹, RSS å’Œ Page Cache. **")]),s._v(" "),t("h6",{attrs:{id:"_2-rss"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-rss"}},[s._v("#")]),s._v(" (2)RSS")]),s._v(" "),t("p",[s._v("å…ˆçœ‹ä»€ä¹ˆæ˜¯ RSS. RSS æ˜¯ "),t("strong",[s._v("Resident Set Size")]),s._v(" çš„ç¼©å†™, ç®€å•æ¥è¯´å®ƒå°±æ˜¯"),t("strong",[s._v("æŒ‡è¿›ç¨‹çœŸæ­£ç”³è¯·åˆ°ç‰©ç†é¡µé¢çš„å†…å­˜å¤§å°")]),s._v(". è¿™æ˜¯ä»€ä¹ˆæ„æ€å‘¢?")]),s._v(" "),t("p",[s._v("åº”ç”¨ç¨‹åºåœ¨ç”³è¯·å†…å­˜çš„æ—¶å€™, æ¯”å¦‚è°ƒç”¨ malloc() æ¥ç”³è¯· 100MB çš„å†…å­˜å¤§å°, malloc() è¿”å›æˆåŠŸäº†, è¿™æ—¶å€™ç³»ç»Ÿå…¶å®åªæ˜¯æŠŠ 100MB çš„"),t("strong",[s._v("è™šæ‹Ÿåœ°å€ç©ºé—´")]),s._v("åˆ†é…ç»™äº†è¿›ç¨‹, ä½†æ˜¯"),t("strong",[s._v("å¹¶æ²¡æœ‰æŠŠå®é™…çš„ç‰©ç†å†…å­˜é¡µé¢åˆ†é…ç»™è¿›ç¨‹")]),s._v(". å½“è¿›ç¨‹å¯¹"),t("strong",[s._v("è¿™å—å†…å­˜åœ°å€å¼€å§‹åšçœŸæ­£è¯»å†™æ“ä½œ")]),s._v("çš„æ—¶å€™, ç³»ç»Ÿæ‰ä¼šæŠŠå®é™…éœ€è¦çš„ç‰©ç†å†…å­˜åˆ†é…ç»™è¿›ç¨‹. è€Œè¿™ä¸ªè¿‡ç¨‹ä¸­, "),t("strong",[s._v("è¿›ç¨‹çœŸæ­£å¾—åˆ°çš„ç‰©ç†å†…å­˜, å°±æ˜¯è¿™ä¸ª RSS äº†")]),s._v(".")]),s._v(" "),t("p",[s._v("æ¯”å¦‚ä¸‹é¢çš„è¿™æ®µä»£ç , å…ˆç”¨ malloc ç”³è¯· 100MB çš„å†…å­˜.")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("p "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" malloc"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("100")]),s._v(" * MB"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("p "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),s._v(" NULL"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("return")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br")])]),t("p",[s._v("ç„¶å, è¿è¡Œ top å‘½ä»¤æŸ¥çœ‹è¿™ä¸ªç¨‹åºåœ¨è¿è¡Œäº† malloc() ä¹‹åçš„å†…å­˜, å¯ä»¥çœ‹åˆ°è¿™ä¸ªç¨‹åºçš„è™šæ‹Ÿåœ°å€ç©ºé—´(VIRT)å·²ç»æœ‰äº† 106728KB(ï½100MB), ä½†æ˜¯å®é™…çš„ç‰©ç†å†…å­˜ RSS(top å‘½ä»¤é‡Œæ˜¾ç¤ºçš„æ˜¯ RES, å°±æ˜¯ Resident çš„ç®€å†™, å’Œ RSS æ˜¯ä¸€ä¸ªæ„æ€)åœ¨è¿™é‡Œåªæœ‰ "),t("strong",[s._v("688KB")]),s._v(".")]),s._v(" "),t("p",[t("img",{attrs:{src:"/img/ee7fda690625dedde1884a2813ec6ab4-20230731161430-8rww7o5.png",alt:""}})]),s._v(" "),t("p",[s._v("æ¥ç€åœ¨ç¨‹åºé‡Œç­‰å¾… 30 ç§’ä¹‹å, å†å¯¹è¿™å—ç”³è¯·çš„ç©ºé—´é‡Œå†™å…¥ 20MB çš„æ•°æ®.")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("sleep"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("30")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\nmemset"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("p, 0x00, "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("20")]),s._v(" * MB"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])]),t("p",[s._v("å½“ç”¨ memset() å‡½æ•°å¯¹è¿™å—åœ°å€ç©ºé—´å†™å…¥ 20MB çš„æ•°æ®ä¹‹å, å†ç”¨ top æŸ¥çœ‹, è¿™æ—¶å€™å¯ä»¥çœ‹åˆ°"),t("strong",[s._v("è™šæ‹Ÿåœ°å€ç©ºé—´(VIRT)è¿˜æ˜¯ 106728, ä¸è¿‡ç‰©ç†å†…å­˜ RSS(RES)çš„å€¼å˜æˆäº† 21432(å¤§å°çº¦ä¸º 20MB)")]),s._v(" , è¿™é‡Œçš„å•ä½éƒ½æ˜¯ KB.")]),s._v(" "),t("p",[t("img",{attrs:{src:"/img/84979224b1798db4a16579871fe78c70-20230731161430-a5ebxdm.png",alt:""}})]),s._v(" "),t("p",[s._v("æ‰€ä»¥é€šè¿‡åˆšæ‰ä¸Šé¢çš„å°å®éªŒ, å¯ä»¥"),t("strong",[s._v("éªŒè¯ RSS å°±æ˜¯è¿›ç¨‹é‡ŒçœŸæ­£è·å¾—çš„ç‰©ç†å†…å­˜å¤§å°")]),s._v(".")]),s._v(" "),t("p",[s._v("å¯¹äºè¿›ç¨‹æ¥è¯´, "),t("strong",[s._v("RSS å†…å­˜åŒ…å«äº†è¿›ç¨‹çš„ä»£ç æ®µå†…å­˜, æ ˆå†…å­˜, å †å†…å­˜, å…±äº«åº“çš„å†…å­˜, è¿™äº›å†…å­˜æ˜¯è¿›ç¨‹è¿è¡Œæ‰€å¿…é¡»çš„")]),s._v(". åˆšæ‰é€šè¿‡ malloc/memset å¾—åˆ°çš„å†…å­˜, å°±æ˜¯å±äºå †å†…å­˜.")]),s._v(" "),t("p",[s._v("å…·ä½“çš„æ¯ä¸€éƒ¨åˆ†çš„ RSS å†…å­˜çš„å¤§å°, å¯ä»¥æŸ¥çœ‹ "),t("code",[s._v("/proc/[pid]/smaps")]),s._v("â€‹ æ–‡ä»¶.")]),s._v(" "),t("h6",{attrs:{id:"_3-page-cache"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-page-cache"}},[s._v("#")]),s._v(" (3)Page Cache")]),s._v(" "),t("p",[s._v("æ¯ä¸ªè¿›ç¨‹é™¤äº†å„è‡ªç‹¬ç«‹åˆ†é…åˆ°çš„ RSS å†…å­˜å¤–, å¦‚æœè¿›ç¨‹"),t("strong",[s._v("å¯¹ç£ç›˜ä¸Šçš„æ–‡ä»¶åšäº†è¯»å†™æ“ä½œ")]),s._v(", Linux è¿˜ä¼šåˆ†é…å†…å­˜, "),t("strong",[s._v("æŠŠç£ç›˜ä¸Šè¯»å†™åˆ°çš„é¡µé¢å­˜æ”¾åœ¨å†…å­˜ä¸­, è¿™éƒ¨åˆ†çš„å†…å­˜å°±æ˜¯ Page Cache")]),s._v(".")]),s._v(" "),t("p",[t("mark",[s._v("**Page Cache çš„ä¸»è¦ä½œç”¨æ˜¯æé«˜ç£ç›˜æ–‡ä»¶çš„è¯»å†™æ€§èƒ½, å› ä¸ºç³»ç»Ÿè°ƒç”¨ read() å’Œ write() çš„ç¼ºçœè¡Œä¸ºéƒ½ä¼šæŠŠè¯»è¿‡æˆ–è€…å†™è¿‡çš„é¡µé¢å­˜æ”¾åœ¨ Page Cache é‡Œ. **")])]),s._v(" "),t("p",[s._v("è¿˜æ˜¯ç”¨è¿™ä¸€è®²æœ€å¼€å§‹çš„çš„ä¾‹å­: ä»£ç ç¨‹åºå»è¯»å– 100MB çš„æ–‡ä»¶, åœ¨è¯»å–æ–‡ä»¶å‰, ç³»ç»Ÿä¸­ Page Cache çš„å¤§å°æ˜¯ 388MB, è¯»å–å Page Cache çš„å¤§å°æ˜¯ 506MB, å¢é•¿äº†å¤§çº¦ 100MB å·¦å³, å¤šå‡ºæ¥çš„è¿™ 100MB, æ­£æ˜¯è¯»å–æ–‡ä»¶çš„å¤§å°.")]),s._v(" "),t("p",[t("img",{attrs:{src:"/img/5c3ad5044e7a40cf94ed5c61d081073b-20230731161430-u2009v9.png",alt:""}})]),s._v(" "),t("p",[t("mark",[t("strong",[s._v("åœ¨ Linux ç³»ç»Ÿé‡Œåªè¦æœ‰ç©ºé—²çš„å†…å­˜, ç³»ç»Ÿå°±ä¼šè‡ªåŠ¨åœ°æŠŠè¯»å†™è¿‡çš„ç£ç›˜æ–‡ä»¶é¡µé¢æ”¾å…¥åˆ° Page Cache é‡Œ")])]),s._v(". é‚£ä¹ˆè¿™äº›å†…å­˜éƒ½è¢« Page Cache å ç”¨äº†, ä¸€æ—¦è¿›ç¨‹éœ€è¦ç”¨åˆ°æ›´å¤šçš„ç‰©ç†å†…å­˜, æ‰§è¡Œ malloc() è°ƒç”¨åšç”³è¯·æ—¶, å°±ä¼šå‘ç°å‰©ä½™çš„ç‰©ç†å†…å­˜ä¸å¤Ÿäº†, é‚£è¯¥æ€ä¹ˆåŠå‘¢?")]),s._v(" "),t("p",[s._v("è¿™å°±è¦æåˆ° Linux çš„å†…å­˜ç®¡ç†æœºåˆ¶äº†. "),t("mark",[t("strong",[s._v("Linux çš„å†…å­˜ç®¡ç†æœ‰ä¸€ç§å†…å­˜é¡µé¢å›æ”¶æœºåˆ¶(page frame reclaim), ä¼šæ ¹æ®ç³»ç»Ÿé‡Œç©ºé—²ç‰©ç†å†…å­˜æ˜¯å¦ä½äºæŸä¸ªé˜ˆå€¼(wartermark), æ¥å†³å®šæ˜¯å¦å¯åŠ¨å†…å­˜çš„å›æ”¶")])]),s._v("â€‹ "),t("strong",[s._v(".")])]),s._v(" "),t("p",[s._v("å†…å­˜å›æ”¶çš„ç®—æ³•ä¼šæ ¹æ®ä¸åŒç±»å‹çš„å†…å­˜ä»¥åŠå†…å­˜çš„æœ€è¿‘æœ€å°‘ç”¨åŸåˆ™, å°±æ˜¯ "),t("strong",[s._v("LRU")]),s._v("(Least Recently Used)ç®—æ³•å†³å®šå“ªäº›å†…å­˜é¡µé¢å…ˆè¢«é‡Šæ”¾. å› ä¸º Page Cache çš„å†…å­˜é¡µé¢åªæ˜¯èµ·åˆ° "),t("strong",[s._v("Cache ä½œç”¨")]),s._v(", è‡ªç„¶æ˜¯ä¼šè¢«ä¼˜å…ˆé‡Šæ”¾çš„.")]),s._v(" "),t("p",[s._v("æ‰€ä»¥, Page Cache æ˜¯ä¸€ç§ä¸ºäº†æé«˜ç£ç›˜æ–‡ä»¶è¯»å†™æ€§èƒ½è€Œåˆ©ç”¨ç©ºé—²ç‰©ç†å†…å­˜çš„æœºåˆ¶. åŒæ—¶å†…å­˜ç®¡ç†ä¸­çš„é¡µé¢å›æ”¶æœºåˆ¶, åˆèƒ½ä¿è¯ Cache æ‰€å ç”¨çš„é¡µé¢å¯ä»¥åŠæ—¶é‡Šæ”¾, è¿™æ ·ä¸€æ¥å°±ä¸ä¼šå½±å“ç¨‹åºå¯¹å†…å­˜çš„çœŸæ­£éœ€æ±‚äº†.")]),s._v(" "),t("h6",{attrs:{id:"_4-rss-page-cache-in-memory-cgroup"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_4-rss-page-cache-in-memory-cgroup"}},[s._v("#")]),s._v(" (4)RSS & Page Cache in Memory Cgroup")]),s._v(" "),t("p",[s._v("å­¦ä¹ äº† RSS å’Œ Page Cache çš„åŸºæœ¬æ¦‚å¿µä¹‹å, ä¸‹é¢æ¥çœ‹ä¸åŒç±»å‹çš„å†…å­˜, ç‰¹åˆ«æ˜¯ RSS å’Œ Page Cache æ˜¯å¦‚ä½•å½±å“ Memory Cgroup çš„å·¥ä½œçš„.")]),s._v(" "),t("p",[s._v("å…ˆä» Linux çš„å†…æ ¸ä»£ç çœ‹ä¸€ä¸‹, ä» mem_cgroup_charge_statistics() è¿™ä¸ªå‡½æ•°é‡Œ, "),t("mark",[t("strong",[s._v("å¯ä»¥çœ‹åˆ° Memory Cgroup ä¹Ÿçš„ç¡®åªæ˜¯ç»Ÿè®¡äº† RSS å’Œ Page Cache è¿™ä¸¤éƒ¨åˆ†çš„å†…å­˜")])]),s._v(".")]),s._v(" "),t("p",[s._v("RSS çš„å†…å­˜, å°±æ˜¯åœ¨å½“å‰ Memory Cgroup æ§åˆ¶ç»„é‡Œ"),t("strong",[s._v("æ‰€æœ‰è¿›ç¨‹çš„ RSS çš„æ€»å’Œ")]),s._v("; è€Œ Page Cache è¿™éƒ¨åˆ†å†…å­˜æ˜¯"),t("strong",[s._v("æ§åˆ¶ç»„é‡Œçš„è¿›ç¨‹è¯»å†™ç£ç›˜æ–‡ä»¶å, è¢«æ”¾å…¥åˆ° Page Cache é‡Œçš„ç‰©ç†å†…å­˜")]),s._v(".")]),s._v(" "),t("p",[t("img",{attrs:{src:"/img/fe65cad7205d49a4d836eb631a31b614-20230731161430-qbedznp.png",alt:""}})]),s._v(" "),t("p",[t("mark",[s._v("**Memory Cgroup æ§åˆ¶ç»„é‡Œ RSS å†…å­˜å’Œ Page Cache å†…å­˜çš„å’Œ, æ­£å¥½æ˜¯ memory.usage_in_bytes çš„å€¼. **")])]),s._v(" "),t("p",[s._v("å½“æ§åˆ¶ç»„é‡Œçš„è¿›ç¨‹éœ€è¦ç”³è¯·æ–°çš„ç‰©ç†å†…å­˜, è€Œä¸” memory.usage_in_bytes é‡Œçš„å€¼è¶…è¿‡æ§åˆ¶ç»„é‡Œçš„å†…å­˜ä¸Šé™å€¼ memory.limit_in_bytes, è¿™æ—¶å‰é¢è¯´çš„ Linux çš„å†…å­˜å›æ”¶(page frame reclaim)å°±ä¼šè¢«è°ƒç”¨èµ·æ¥.")]),s._v(" "),t("p",[s._v("é‚£ä¹ˆåœ¨è¿™ä¸ªæ§åˆ¶ç»„é‡Œçš„ page cache çš„å†…å­˜ä¼šæ ¹æ®æ–°ç”³è¯·çš„å†…å­˜å¤§å°"),t("strong",[s._v("é‡Šæ”¾ä¸€éƒ¨åˆ†")]),s._v(", è¿™æ ·è¿˜æ˜¯èƒ½æˆåŠŸç”³è¯·åˆ°æ–°çš„ç‰©ç†å†…å­˜, æ•´ä¸ªæ§åˆ¶ç»„é‡Œæ€»çš„ç‰©ç†å†…å­˜å¼€é”€ memory.usage_in_bytes è¿˜æ˜¯ä¸ä¼šè¶…è¿‡ä¸Šé™å€¼ memory.limit_in_bytes.")]),s._v(" "),t("h5",{attrs:{id:"_3-è§£å†³é—®é¢˜-3"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-è§£å†³é—®é¢˜-3"}},[s._v("#")]),s._v(" 3.è§£å†³é—®é¢˜")]),s._v(" "),t("p",[s._v("æ˜ç™½äº† Memory Cgroup ä¸­å†…å­˜ç±»å‹çš„ç»Ÿè®¡æ–¹æ³•, å†å›è¿‡å¤´çœ‹è¿™ä¸€è®²å¼€å¤´çš„é—®é¢˜, ä¸ºä»€ä¹ˆ memory.usage_in_bytes ä¸ memory.limit_in_bytes çš„å€¼åªç›¸å·®äº† 90KB, åœ¨å®¹å™¨ä¸­è¿˜æ˜¯å¯ä»¥ç”³è¯·å‡º 50MB çš„ç‰©ç†å†…å­˜?")]),s._v(" "),t("p",[s._v("ä½ åº”è¯¥å·²ç»çŸ¥é“ç­”æ¡ˆäº†, "),t("strong",[s._v("å®¹å™¨é‡Œè‚¯å®šæœ‰å¤§äº 50MB çš„å†…å­˜æ˜¯ Page Cache, å› ä¸ºä½œä¸º Page Cache çš„å†…å­˜åœ¨ç³»ç»Ÿéœ€è¦æ–°ç”³è¯·ç‰©ç†å†…å­˜çš„æ—¶å€™(ä½œä¸º RSS)æ˜¯å¯ä»¥è¢«é‡Šæ”¾çš„")]),s._v(".")]),s._v(" "),t("p",[s._v("çŸ¥é“äº†è¿™ä¸ªç­”æ¡ˆ, é‚£ä¹ˆæ€ä¹ˆæ¥éªŒè¯å‘¢? éªŒè¯çš„æ–¹æ³•ä¹ŸæŒºç®€å•çš„, åœ¨ Memory Cgroup ä¸­æœ‰ä¸€ä¸ªå‚æ•° "),t("strong",[s._v("memory.stat")]),s._v(", å¯ä»¥"),t("strong",[s._v("æ˜¾ç¤ºåœ¨å½“å‰æ§åˆ¶ç»„é‡Œå„ç§å†…å­˜ç±»å‹çš„å®é™…çš„å¼€é”€")]),s._v(".")]),s._v(" "),t("p",[s._v("é‚£è¿˜æ˜¯æ‹¿æœ¬èŠ‚çš„å®¹å™¨ä¾‹å­, å†è·‘ä¸€éä»£ç , è¿™æ¬¡è¦æŸ¥çœ‹ä¸€ä¸‹ memory.stat é‡Œçš„æ•°æ®.")]),s._v(" "),t("p",[s._v("ç¬¬ä¸€æ­¥, è¿˜æ˜¯ç”¨åŒæ ·çš„è„šæœ¬æ¥å¯åŠ¨å®¹å™¨, å¹¶ä¸”è®¾ç½®å¥½å®¹å™¨çš„ Memory Cgroup é‡Œçš„ memory.limit_in_bytes å€¼ä¸º 100MB. å¯åŠ¨å®¹å™¨å, è¿™æ¬¡ä¸ä»…è¦çœ‹ memory.usage_in_bytes çš„å€¼, è¿˜è¦çœ‹ä¸€ä¸‹ "),t("strong",[s._v("memory.stat")]),s._v('. è™½ç„¶ memory.stat é‡Œçš„å‚æ•°æœ‰ä¸å°‘, ä½†ç›®å‰åªéœ€è¦å…³æ³¨ "cache" å’Œ "rss" è¿™ä¸¤ä¸ªå€¼.')]),s._v(" "),t("p",[s._v("å¯ä»¥çœ‹åˆ°, å®¹å™¨å¯åŠ¨å, cache, ä¹Ÿå°±æ˜¯ "),t("strong",[s._v("Page Cache å çš„å†…å­˜æ˜¯ 99508224bytes")]),s._v(", å¤§æ¦‚æ˜¯ 99MB, è€Œ RSS å çš„å†…å­˜åªæœ‰ 1826816bytes, ä¹Ÿå°±æ˜¯ 1MB å¤šä¸€ç‚¹. è¿™å°±æ„å‘³ç€, åœ¨è¿™ä¸ªå®¹å™¨çš„ Memory Cgroup é‡Œ"),t("strong",[s._v("å¤§éƒ¨åˆ†çš„å†…å­˜éƒ½è¢«ç”¨ä½œäº† Page Cache, è€Œè¿™éƒ¨åˆ†å†…å­˜æ˜¯å¯ä»¥è¢«å›æ”¶çš„")]),s._v(".")]),s._v(" "),t("p",[t("img",{attrs:{src:"/img/f1b76a58b7927b89307cd9b8ffda7617-20230731161430-fledclv.png",alt:""}})]),s._v(" "),t("p",[s._v("é‚£ä¹ˆå†æ‰§è¡Œä¸€ä¸‹ mem_alloc ç¨‹åº, ç”³è¯· 50MB çš„ç‰©ç†å†…å­˜. å¯ä»¥å†æ¥æŸ¥çœ‹ä¸€ä¸‹ memory.stat, è¿™æ—¶å€™ "),t("strong",[s._v("cache çš„å†…å­˜å€¼é™åˆ°äº† 46632960bytes, å¤§æ¦‚ 46MB")]),s._v(", è€Œ rss çš„å†…å­˜å€¼åˆ°äº† 54759424bytes, 54MB å·¦å³å§. æ€»çš„ memory.usage_in_bytes å€¼å’Œä¹‹å‰ç›¸æ¯”, æ²¡æœ‰å¤ªå¤šçš„å˜åŒ–.")]),s._v(" "),t("p",[t("img",{attrs:{src:"/img/4e08dadceabc075d15469d047f4cb369-20230731161430-rni4t79.png",alt:""}})]),s._v(" "),t("p",[s._v("ä»è¿™é‡Œå‘ç°, Page Cache å†…å­˜å¯¹åˆ¤æ–­å®¹å™¨å®é™…å†…å­˜ä½¿ç”¨ç‡çš„å½±å“, "),t("strong",[s._v("ç›®å‰ Page Cache å®Œå…¨å°±æ˜¯ Linux å†…æ ¸çš„ä¸€ä¸ªè‡ªåŠ¨çš„è¡Œä¸º, åªè¦è¯»å†™ç£ç›˜æ–‡ä»¶, åªè¦æœ‰ç©ºé—²çš„å†…å­˜, å°±ä¼šè¢«ç”¨ä½œ Page Cache")]),s._v(".")]),s._v(" "),t("p",[s._v("æ‰€ä»¥, åˆ¤æ–­å®¹å™¨çœŸå®çš„å†…å­˜ä½¿ç”¨é‡, "),t("strong",[s._v("ä¸èƒ½ç”¨ Memory Cgroup é‡Œçš„ memory.usage_in_bytes, è€Œéœ€è¦ç”¨ memory.stat é‡Œçš„ rss å€¼")]),s._v('. è¿™ä¸ªå¾ˆåƒç”¨ free å‘½ä»¤æŸ¥çœ‹èŠ‚ç‚¹çš„å¯ç”¨å†…å­˜, ä¸èƒ½çœ‹ "free" å­—æ®µä¸‹çš„å€¼, è€Œè¦çœ‹é™¤å» Page Cache ä¹‹åçš„ "'),t("strong",[s._v("available")]),s._v('" å­—æ®µä¸‹çš„å€¼.')]),s._v(" "),t("h5",{attrs:{id:"_4-é‡ç‚¹æ€»ç»“-5"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_4-é‡ç‚¹æ€»ç»“-5"}},[s._v("#")]),s._v(" 4.é‡ç‚¹æ€»ç»“")]),s._v(" "),t("p",[s._v("æ¯ä¸ªå®¹å™¨çš„ Memory Cgroup åœ¨ç»Ÿè®¡æ¯ä¸ªæ§åˆ¶ç»„çš„å†…å­˜ä½¿ç”¨æ—¶åŒ…å«äº†ä¸¤éƒ¨åˆ†, RSS å’Œ Page Cache. "),t("strong",[s._v("RSS æ˜¯æ¯ä¸ªè¿›ç¨‹å®é™…å ç”¨çš„ç‰©ç†å†…å­˜, å®ƒåŒ…æ‹¬äº†è¿›ç¨‹çš„ä»£ç æ®µå†…å­˜, è¿›ç¨‹è¿è¡Œæ—¶éœ€è¦çš„å †å’Œæ ˆçš„å†…å­˜, è¿™éƒ¨åˆ†å†…å­˜æ˜¯è¿›ç¨‹è¿è¡Œæ‰€å¿…é¡»çš„")]),s._v(". **Page Cache æ˜¯è¿›ç¨‹åœ¨è¿è¡Œä¸­è¯»å†™ç£ç›˜æ–‡ä»¶å, ä½œä¸º Cache è€Œç»§ç»­ä¿ç•™åœ¨å†…å­˜ä¸­çš„, å®ƒçš„ç›®çš„æ˜¯ä¸ºäº†æé«˜ç£ç›˜æ–‡ä»¶çš„è¯»å†™æ€§èƒ½. **")]),s._v(" "),t("p",[s._v("å½“èŠ‚ç‚¹çš„å†…å­˜ç´§å¼ æˆ–è€… Memory Cgroup æ§åˆ¶ç»„çš„å†…å­˜è¾¾åˆ°ä¸Šé™çš„æ—¶å€™, Linux ä¼šå¯¹å†…å­˜åšå›æ”¶æ“ä½œ, è¿™ä¸ªæ—¶å€™ "),t("strong",[s._v("Page Cache çš„å†…å­˜é¡µé¢ä¼šè¢«é‡Šæ”¾, è¿™æ ·ç©ºå‡ºæ¥çš„å†…å­˜å°±å¯ä»¥åˆ†é…ç»™æ–°çš„å†…å­˜ç”³è¯·")]),s._v(".")]),s._v(" "),t("p",[s._v("æ­£æ˜¯ Page Cache å†…å­˜çš„è¿™ç§ Cache çš„ç‰¹æ€§, å¯¹äºé‚£äº›æœ‰"),t("strong",[s._v("é¢‘ç¹ç£ç›˜è®¿é—®å®¹å™¨, å¾€å¾€ä¼šçœ‹åˆ°å®ƒçš„å†…å­˜ä½¿ç”¨ç‡ä¸€ç›´æ¥è¿‘å®¹å™¨å†…å­˜çš„é™åˆ¶å€¼(memory.limit_in_bytes)")]),s._v(" . ä½†æ˜¯è¿™æ—¶å€™, å¹¶ä¸éœ€è¦æ‹…å¿ƒå®ƒå†…å­˜çš„ä¸å¤Ÿ, åœ¨åˆ¤æ–­ä¸€ä¸ªå®¹å™¨çš„å†…å­˜ä½¿ç”¨çŠ¶å†µçš„æ—¶å€™, å¯ä»¥æŠŠ Page Cache è¿™éƒ¨åˆ†å†…å­˜ä½¿ç”¨é‡å¿½ç•¥, è€Œæ›´å¤šçš„è€ƒè™‘å®¹å™¨ä¸­ RSS çš„å†…å­˜ä½¿ç”¨é‡.")]),s._v(" "),t("h4",{attrs:{id:"_10-swap-å®¹å™¨å¯ä»¥ä½¿ç”¨swapç©ºé—´å—"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_10-swap-å®¹å™¨å¯ä»¥ä½¿ç”¨swapç©ºé—´å—"}},[s._v("#")]),s._v(" 10 | Swap:å®¹å™¨å¯ä»¥ä½¿ç”¨Swapç©ºé—´å—?")]),s._v(" "),t("p",[s._v("æœ¬èŠ‚æ¥çœ‹çœ‹å®¹å™¨ä¸­æ˜¯å¦å¯ä»¥ä½¿ç”¨ Swap ç©ºé—´.")]),s._v(" "),t("p",[s._v("ç”¨è¿‡ Linux çš„åŒå­¦åº”è¯¥éƒ½å¾ˆç†Ÿæ‚‰ Swap ç©ºé—´äº†, ç®€å•æ¥è¯´å®ƒå°±æ˜¯å°±æ˜¯ä¸€å—"),t("strong",[s._v("ç£ç›˜ç©ºé—´")]),s._v(". å½“å†…å­˜å†™æ»¡çš„æ—¶å€™, å°±å¯ä»¥æŠŠå†…å­˜ä¸­ä¸å¸¸ç”¨çš„æ•°æ®æš‚æ—¶å†™åˆ°è¿™ä¸ª Swap ç©ºé—´ä¸Š. è¿™æ ·ä¸€æ¥å†…å­˜ç©ºé—´å°±å¯ä»¥é‡Šæ”¾å‡ºæ¥, ç”¨æ¥æ»¡è¶³æ–°çš„å†…å­˜ç”³è¯·çš„éœ€æ±‚.")]),s._v(" "),t("p",[s._v("å®ƒçš„å¥½å¤„æ˜¯å¯ä»¥"),t("strong",[s._v("åº”å¯¹ä¸€äº›ç¬æ—¶çªå‘çš„å†…å­˜å¢å¤§éœ€æ±‚")]),s._v(", ä¸è‡³äºå› ä¸ºå†…å­˜ä¸€æ—¶ä¸å¤Ÿè€Œè§¦å‘ OOM Killer, å¯¼è‡´è¿›ç¨‹è¢«æ€æ­». é‚£ä¹ˆå¯¹äºä¸€ä¸ªå®¹å™¨, ç‰¹åˆ«æ˜¯å®¹å™¨è¢«è®¾ç½®äº† Memory Cgroup ä¹‹å, å®ƒè¿˜å¯ä»¥ä½¿ç”¨ Swap ç©ºé—´å—? ä¼šä¸ä¼šå‡ºç°ä»€ä¹ˆé—®é¢˜å‘¢?")]),s._v(" "),t("h5",{attrs:{id:"_1-é—®é¢˜å†ç°-6"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-é—®é¢˜å†ç°-6"}},[s._v("#")]),s._v(" 1.é—®é¢˜å†ç°")]),s._v(" "),t("p",[s._v("æ¥ä¸‹æ¥å°±ç»“åˆä¸€ä¸ªå°ä¾‹å­, ä¸€èµ·æ¥çœ‹çœ‹. é¦–å…ˆåœ¨ä¸€ä¸ª"),t("strong",[s._v("æœ‰ Swap ç©ºé—´çš„èŠ‚ç‚¹ä¸Šå¯åŠ¨ä¸€ä¸ªå®¹å™¨")]),s._v(", è®¾ç½®å¥½å®ƒçš„ Memory Cgroup çš„é™åˆ¶, æ¥çœ‹çœ‹æ¥ä¸‹æ¥ä¼šå‘ç”Ÿä»€ä¹ˆ. å¦‚æœèŠ‚ç‚¹ä¸Šæ²¡æœ‰ Swap åˆ†åŒº, ä¹Ÿæ²¡æœ‰å…³ç³», å¯ä»¥ç”¨ä¸‹é¢çš„è¿™ç»„å‘½ä»¤æ¥æ–°å»ºä¸€ä¸ª.")]),s._v(" "),t("p",[s._v("è¿™ä¸ªä¾‹å­é‡Œ, Swap ç©ºé—´çš„å¤§å°æ˜¯ 20G, å¯ä»¥æ ¹æ®è‡ªå·±ç£ç›˜ç©ºé—²ç©ºé—´æ¥å†³å®šè¿™ä¸ª Swap çš„å¤§å°. æ‰§è¡Œå®Œè¿™ç»„å‘½ä»¤ä¹‹å, æ¥è¿è¡Œ free å‘½ä»¤, å°±å¯ä»¥çœ‹åˆ° Swap ç©ºé—´æœ‰ 20G. è¾“å‡ºçš„ç»“æœå¯ä»¥å‚è€ƒä¸‹å›¾.")]),s._v(" "),t("p",[t("img",{attrs:{src:"/img/22fdc51325c3150cba606ae646f9303c-20230731161430-oe1by0l.png",alt:""}})]),s._v(" "),t("p",[s._v("ç„¶åå†å¯åŠ¨ä¸€ä¸ªå®¹å™¨, å’Œ OOM é‚£ä¸€è®²é‡Œçš„ä¾‹å­å·®ä¸å¤š, å®¹å™¨çš„ Memory Cgroup é™åˆ¶ä¸º "),t("strong",[s._v("512MB")]),s._v(", å®¹å™¨ä¸­çš„ mem_alloc ç¨‹åºå»ç”³è¯· 2GB å†…å­˜. å¯ä»¥å‘ç°, è¿™æ¬¡å’Œä¸Šæ¬¡ OOM é‚£ä¸€è®²é‡Œçš„æƒ…å†µä¸ä¸€æ ·äº†, "),t("strong",[s._v("å¹¶æ²¡æœ‰å‘ç”Ÿ OOM å¯¼è‡´å®¹å™¨é€€å‡ºçš„æƒ…å†µ, å®¹å™¨è¿è¡Œå¾—å¥½å¥½çš„")]),s._v(".")]),s._v(" "),t("p",[s._v("ä»ä¸‹å›¾å¯ä»¥çœ‹åˆ°, mem_alloc è¿›ç¨‹çš„ RSS å†…å­˜ä¸€ç›´åœ¨ "),t("strong",[s._v("512MB")]),s._v("(RES: 515596)å·¦å³.")]),s._v(" "),t("p",[t("img",{attrs:{src:"/img/04a40668910f777c7c542c0570a6878c-20230731161430-ko5i494.png",alt:""}})]),s._v(" "),t("p",[s._v("å†çœ‹ä¸€ä¸‹ Swap ç©ºé—´, ä½¿ç”¨äº† 1.5GB (used 1542144KB). è¾“å‡ºçš„ç»“æœå¦‚ä¸‹å›¾, ç®€å•è®¡ç®—ä¸€ä¸‹, 1.5GB + 512MB, ç»“æœæ­£å¥½æ˜¯ mem_alloc è¿™ä¸ªç¨‹åºç”³è¯·çš„ 2GB å†…å­˜.")]),s._v(" "),t("p",[t("img",{attrs:{src:"/img/74c7ed7754054b5333d230a727add23d-20230731161430-wz8lh3o.png",alt:""}})]),s._v(" "),t("p",[s._v("é€šè¿‡åˆšåˆšçš„ä¾‹å­, ä½ ä¹Ÿè®¸ä¼šè¿™ä¹ˆæƒ³, å› ä¸ºæœ‰äº† Swap ç©ºé—´, æœ¬æ¥ä¼šè¢« OOM Kill çš„å®¹å™¨, å¯ä»¥å¥½å¥½åœ°è¿è¡Œäº†. åˆçœ‹è¿™æ ·ä¼¼ä¹ä¹ŸæŒºå¥½çš„, ä¸è¿‡ä»”ç»†æƒ³æƒ³, "),t("strong",[s._v("è¿™æ ·ä¸€æ¥, Memory Cgroup å¯¹å†…å­˜çš„é™åˆ¶ä¸å°±å¤±å»äº†ä½œç”¨ä¹ˆ")]),s._v("?")]),s._v(" "),t("p",[t("strong",[s._v("å†è¿›ä¸€æ­¥åˆ†æ, å¦‚æœä¸€ä¸ªå®¹å™¨ä¸­çš„ç¨‹åºå‘ç”Ÿäº†å†…å­˜æ³„æ¼(Memory leak), é‚£ä¹ˆæœ¬æ¥ Memory Cgroup å¯ä»¥åŠæ—¶æ€æ­»è¿™ä¸ªè¿›ç¨‹, è®©å®ƒä¸å½±å“æ•´ä¸ªèŠ‚ç‚¹ä¸­çš„å…¶ä»–åº”ç”¨ç¨‹åº. ç»“æœç°åœ¨è¿™ä¸ªå†…å­˜æ³„æ¼çš„è¿›ç¨‹æ²¡è¢«æ€æ­», è¿˜ä¼šä¸æ–­åœ°è¯»å†™ Swap ç£ç›˜, åè€Œå½±å“äº†æ•´ä¸ªèŠ‚ç‚¹çš„æ€§èƒ½.")])]),s._v(" "),t("p",[s._v("ä½ çœ‹, è¿™æ ·ä¸€åˆ†æ, å¯¹äºè¿è¡Œå®¹å™¨çš„èŠ‚ç‚¹, ä½ æ˜¯ä¸æ˜¯åˆè§‰å¾—åº”è¯¥ç¦æ­¢ä½¿ç”¨ Swap äº†å‘¢? ä¸è¿‡ä¸èƒ½ä¸€åˆ€åˆ‡åœ°ä¸‹ç»“è®º, å…·ä½“æƒ…å†µè¦å…·ä½“åˆ†æ, è½åœ°åˆ°å…·ä½“çš„åœºæ™¯é‡Œ, å°±ä¼šå‘ç°æƒ…å†µåˆæ²¡æœ‰æƒ³å¾—é‚£ä¹ˆç®€å•.")]),s._v(" "),t("p",[s._v("æ¯”å¦‚æŸä¸€ç±»ç¨‹åºå°±æ˜¯éœ€è¦ Swap ç©ºé—´, æ‰èƒ½é˜²æ­¢å› ä¸º"),t("strong",[s._v("å¶å°”çš„å†…å­˜çªç„¶å¢åŠ ")]),s._v("è€Œè¢« OOM Killer æ€æ­». å› ä¸ºè¿™ç±»ç¨‹åºé‡æ–°å¯åŠ¨çš„åˆå§‹åŒ–æ—¶é—´ä¼šå¾ˆé•¿, è¿™æ ·ç¨‹åºé‡å¯çš„ä»£ä»·å°±å¾ˆå¤§äº†, ä¹Ÿå°±æ˜¯è¯´æ‰“å¼€ Swap å¯¹è¿™ç±»ç¨‹åºæ˜¯æœ‰æ„ä¹‰çš„. "),t("strong",[s._v('è¿™ä¸€ç±»ç¨‹åºä¸€æ—¦æ”¾åˆ°å®¹å™¨ä¸­è¿è¡Œ, å°±æ„å‘³ç€å®ƒä¼šå’Œ "åˆ«çš„å®¹å™¨" åœ¨åŒä¸€ä¸ªå®¿ä¸»æœºä¸Šå…±åŒè¿è¡Œ, é‚£å¦‚æœè¿™ä¸ª "åˆ«çš„å®¹å™¨" å¦‚æœä¸éœ€è¦ Swap, è€Œæ˜¯å¸Œæœ› Memory Cgroup çš„ä¸¥æ ¼å†…å­˜é™åˆ¶. è¿™æ ·ä¸€æ¥, åœ¨è¿™ä¸€ä¸ªå®¿ä¸»æœºä¸Šçš„ä¸¤ä¸ªå®¹å™¨å°±ä¼šæœ‰å†²çªäº†, åº”è¯¥æ€ä¹ˆè§£å†³è¿™ä¸ªé—®é¢˜å‘¢')]),s._v("? è¦è§£å†³è¿™ä¸ªé—®é¢˜, å…ˆæ¥çœ‹çœ‹ Linux é‡Œçš„ Swappiness è¿™ä¸ªæ¦‚å¿µ, åé¢å®ƒå¯ä»¥å¸®åˆ°æˆ‘ä»¬.")]),s._v(" "),t("h5",{attrs:{id:"_2-å¦‚ä½•æ­£ç¡®ç†è§£swappinesså‚æ•°"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-å¦‚ä½•æ­£ç¡®ç†è§£swappinesså‚æ•°"}},[s._v("#")]),s._v(" 2.å¦‚ä½•æ­£ç¡®ç†è§£swappinesså‚æ•°?")]),s._v(" "),t("p",[s._v("åœ¨æ™®é€š Linux ç³»ç»Ÿä¸Š, å¦‚æœä½ ä½¿ç”¨è¿‡ Swap ç©ºé—´, é‚£ä¹ˆä½ å¯èƒ½"),t("strong",[s._v("é…ç½®è¿‡ proc æ–‡ä»¶ç³»ç»Ÿä¸‹çš„ swappiness è¿™ä¸ªå‚æ•°")]),s._v(" (/proc/sys/vm/swappiness). swappiness çš„å®šä¹‰åœ¨Linux å†…æ ¸æ–‡æ¡£ä¸­å¯ä»¥æ‰¾åˆ°, å°±æ˜¯ä¸‹é¢è¿™æ®µè¯.")]),s._v(" "),t("blockquote",[t("p",[s._v("swappiness")]),s._v(" "),t("p",[s._v("This control is used to define how aggressive the kernel will swap memory pages. Higher values will increase aggressiveness, lower values decrease the amount of swap. A value of 0 instructs the kernel not to initiate swap until the amount of free and file-backed pages is less than the high water mark in a zone.")]),s._v(" "),t("p",[s._v("The default value is 60.")])]),s._v(" "),t("p",[s._v("å‰é¢ä¸¤å¥è¯å¤§è‡´ç¿»è¯‘è¿‡æ¥, æ„æ€å°±æ˜¯ "),t("mark",[t("strong",[s._v("swappiness å¯ä»¥å†³å®šç³»ç»Ÿå°†ä¼šæœ‰å¤šé¢‘ç¹åœ°ä½¿ç”¨äº¤æ¢åˆ†åŒº")])]),s._v("â€‹ "),t("strong",[s._v(". ä¸€ä¸ªè¾ƒé«˜çš„å€¼ä¼šä½¿å¾—å†…æ ¸æ›´é¢‘ç¹åœ°ä½¿ç”¨äº¤æ¢åˆ†åŒº, è€Œä¸€ä¸ªè¾ƒä½çš„å–å€¼, åˆ™ä»£è¡¨ç€å†…æ ¸ä¼šå°½é‡é¿å…ä½¿ç”¨äº¤æ¢åˆ†åŒº")]),s._v(". swappiness çš„å–å€¼èŒƒå›´æ˜¯ 0â€“100, ç¼ºçœå€¼ 60.")]),s._v(" "),t("p",[s._v("æˆ‘ç¬¬ä¸€æ¬¡è¯»åˆ°è¿™ä¸ªå®šä¹‰, å†çŸ¥é“äº†è¿™ä¸ªå–å€¼èŒƒå›´å, æˆ‘è§‰å¾—è¿™æ˜¯ä¸€ä¸ªç™¾åˆ†æ¯”å€¼, ä¹Ÿå°±æ˜¯å®šä¹‰äº†ä½¿ç”¨ Swap ç©ºé—´çš„"),t("strong",[s._v("é¢‘ç‡")]),s._v(". å½“è¿™ä¸ªå€¼æ˜¯ 100 çš„æ—¶å€™, å“ªæ€•è¿˜æœ‰ç©ºé—²å†…å­˜, ä¹Ÿä¼šå»åšå†…å­˜äº¤æ¢, å°½é‡æŠŠå†…å­˜æ•°æ®å†™å…¥åˆ° Swap ç©ºé—´é‡Œ; å€¼æ˜¯ 0 çš„æ—¶å€™, åŸºæœ¬ä¸Šå°±ä¸åšå†…å­˜äº¤æ¢äº†, ä¹Ÿå°±ä¸å†™ Swap ç©ºé—´äº†. åæ¥å†å›é¡¾çš„æ—¶å€™, æˆ‘å‘ç°è¿™ä¸ªæƒ³æ³•ä¸èƒ½è¯´æ˜¯å®Œå…¨é”™çš„, ä½†æ˜¯æƒ³å¾—ç®€å•äº†äº›. é‚£è¿™æ®µ swappiness çš„å®šä¹‰, åº”è¯¥æ€ä¹ˆæ­£ç¡®åœ°ç†è§£å‘¢?")]),s._v(" "),t("p",[s._v("è¿˜è®°å¾—ä¸Šä¸€è®²é‡Œè¯´è¿‡çš„ä¸¤ç§å†…å­˜ç±»å‹ Page Cache å’Œ RSS ä¹ˆ?")]),s._v(" "),t("p",[s._v("åœ¨æœ‰ç£ç›˜æ–‡ä»¶è®¿é—®çš„æ—¶å€™, "),t("strong",[s._v("Linux ä¼šå°½é‡æŠŠç³»ç»Ÿçš„ç©ºé—²å†…å­˜ç”¨ä½œ Page Cache æ¥æé«˜æ–‡ä»¶çš„è¯»å†™æ€§èƒ½. åœ¨æ²¡æœ‰æ‰“å¼€ Swap ç©ºé—´çš„æƒ…å†µä¸‹, ä¸€æ—¦å†…å­˜ä¸å¤Ÿ, è¿™ç§æƒ…å†µä¸‹å°±åªèƒ½æŠŠ Page Cache é‡Šæ”¾äº†, è€Œ RSS å†…å­˜æ˜¯ä¸èƒ½é‡Šæ”¾çš„")]),s._v(".")]),s._v(" "),t("p",[s._v("åœ¨ RSS é‡Œçš„å†…å­˜, å¤§éƒ¨åˆ†éƒ½æ˜¯æ²¡æœ‰å¯¹åº”ç£ç›˜æ–‡ä»¶çš„å†…å­˜, æ¯”å¦‚ç”¨ malloc() ç”³è¯·å¾—åˆ°çš„å†…å­˜, è¿™ç§å†…å­˜ä¹Ÿè¢«ç§°ä¸º"),t("strong",[s._v("åŒ¿åå†…å­˜(Anonymous memory)")]),s._v(" . é‚£ä¹ˆå½“ Swap ç©ºé—´æ‰“å¼€å, å¯ä»¥å†™å…¥ Swap ç©ºé—´çš„, å°±æ˜¯è¿™äº›åŒ¿åå†…å­˜.")]),s._v(" "),t("p",[s._v("æ‰€ä»¥åœ¨ Swap ç©ºé—´æ‰“å¼€çš„æ—¶å€™, é—®é¢˜ä¹Ÿå°±æ¥äº†, åœ¨å†…å­˜ç´§å¼ çš„æ—¶å€™, Linux ç³»ç»Ÿ"),t("strong",[s._v("æ€ä¹ˆå†³å®šæ˜¯å…ˆé‡Šæ”¾ Page Cache, è¿˜æ˜¯å…ˆæŠŠåŒ¿åå†…å­˜é‡Šæ”¾å¹¶å†™å…¥åˆ° Swap ç©ºé—´é‡Œ")]),s._v("å‘¢?")]),s._v(" "),t("p",[s._v("ä¸€èµ·æ¥åˆ†æåˆ†æ, éƒ½å¯èƒ½å‘ç”Ÿæ€æ ·çš„æƒ…å†µ. æœ€å¯èƒ½å‘ç”Ÿçš„æ˜¯ä¸‹é¢ä¸¤ç§æƒ…å†µ:")]),s._v(" "),t("p",[s._v("ç¬¬ä¸€ç§æƒ…å†µæ˜¯, å¦‚æœç³»ç»Ÿå…ˆæŠŠ Page Cache éƒ½é‡Šæ”¾äº†, é‚£ä¹ˆä¸€æ—¦èŠ‚ç‚¹é‡Œæœ‰é¢‘ç¹çš„æ–‡ä»¶è¯»å†™æ“ä½œ, ç³»ç»Ÿçš„æ€§èƒ½å°±ä¼šä¸‹é™.")]),s._v(" "),t("p",[s._v("è¿˜æœ‰å¦ä¸€ç§æƒ…å†µ, å¦‚æœ Linux ç³»ç»Ÿå…ˆæŠŠåŒ¿åå†…å­˜éƒ½é‡Šæ”¾å¹¶å†™å…¥åˆ° Swap, é‚£ä¹ˆä¸€æ—¦è¿™äº›è¢«é‡Šæ”¾çš„åŒ¿åå†…å­˜é©¬ä¸Šéœ€è¦ä½¿ç”¨, åˆéœ€è¦ä» Swap ç©ºé—´è¯»å›åˆ°å†…å­˜ä¸­, è¿™æ ·åˆä¼šè®© Swap(å…¶å®ä¹Ÿæ˜¯ç£ç›˜)çš„è¯»å†™é¢‘ç¹, å¯¼è‡´ç³»ç»Ÿæ€§èƒ½ä¸‹é™.")]),s._v(" "),t("p",[t("strong",[s._v("æ˜¾ç„¶, åœ¨é‡Šæ”¾å†…å­˜çš„æ—¶å€™, éœ€è¦å¹³è¡¡ Page Cache çš„é‡Šæ”¾å’ŒåŒ¿åå†…å­˜çš„é‡Šæ”¾, è€Œ swappiness, å°±æ˜¯ç”¨æ¥å®šä¹‰è¿™ä¸ªå¹³è¡¡çš„å‚æ•°.")])]),s._v(" "),t("p",[s._v("é‚£ä¹ˆ swappiness å…·ä½“æ˜¯æ€ä¹ˆæ¥æ§åˆ¶è¿™ä¸ªå¹³è¡¡çš„? çœ‹ä¸€ä¸‹åœ¨ Linux å†…æ ¸ä»£ç é‡Œæ˜¯æ€ä¹ˆç”¨è¿™ä¸ª swappiness å‚æ•°. å‰é¢è¯´äº† swappiness çš„è¿™ä¸ªå€¼çš„èŒƒå›´æ˜¯ 0 åˆ° 100, ä½†æ˜¯è¯·ä¸€å®šè¦æ³¨æ„, "),t("mark",[t("strong",[s._v("å®ƒä¸æ˜¯ä¸€ä¸ªç™¾åˆ†æ¯”, æ›´åƒæ˜¯ä¸€ä¸ªæƒé‡")])]),s._v(". "),t("strong",[s._v("å®ƒæ˜¯ç”¨æ¥å®šä¹‰ Page Cache å†…å­˜å’ŒåŒ¿åå†…å­˜çš„é‡Šæ”¾çš„ä¸€ä¸ªæ¯”ä¾‹")]),s._v(".")]),s._v(" "),t("p",[s._v("ç»“åˆä¸‹é¢çš„è¿™æ®µä»£ç å…·ä½“è®²ä¸€è®².")]),s._v(" "),t("p",[s._v("å¯ä»¥çœ‹åˆ°, è¿™ä¸ªæ¯”ä¾‹æ˜¯ "),t("strong",[s._v("anon_prio : file_prio")]),s._v(", è¿™é‡Œ anon_prio çš„å€¼å°±ç­‰äº swappiness. ä¸‹é¢åˆ†ä¸‰ä¸ªæƒ…å†µåšè®¨è®º:")]),s._v(" "),t("p",[s._v("ç¬¬ä¸€ç§æƒ…å†µ, å½“ swappiness çš„å€¼æ˜¯ 100 çš„æ—¶å€™, åŒ¿åå†…å­˜å’Œ Page Cache å†…å­˜çš„é‡Šæ”¾æ¯”ä¾‹å°±æ˜¯ "),t("strong",[s._v("100: 100")]),s._v(", ä¹Ÿå°±æ˜¯ç­‰æ¯”ä¾‹é‡Šæ”¾äº†.")]),s._v(" "),t("p",[s._v("ç¬¬äºŒç§æƒ…å†µ, å°±æ˜¯ swappiness ç¼ºçœå€¼æ˜¯ 60 çš„æ—¶å€™, åŒ¿åå†…å­˜å’Œ Page Cache å†…å­˜çš„é‡Šæ”¾æ¯”ä¾‹å°±æ˜¯ "),t("strong",[s._v("60 : 140")]),s._v(", Page Cache å†…å­˜çš„é‡Šæ”¾è¦"),t("strong",[s._v("ä¼˜å…ˆäº")]),s._v("åŒ¿åå†…å­˜.")]),s._v(" "),t("div",{staticClass:"language-c line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-c"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("/*\n * With swappiness at 100, anonymous and file have the same priority.\n * This scanning priority is essentially the inverse of IO cost.\n */")]),s._v("\nanon_prio "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" swappiness"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\nfile_prio "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("200")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v(" anon_prio"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br")])]),t("p",[s._v("è¿˜æœ‰ä¸€ç§æƒ…å†µ, å½“ swappiness çš„å€¼æ˜¯ 0 çš„æ—¶å€™, ä¼šå‘ç”Ÿä»€ä¹ˆå‘¢? è¿™ç§æƒ…å†µä¸‹, Linux ç³»ç»Ÿæ˜¯ä¸å…è®¸åŒ¿åå†…å­˜å†™å…¥ Swap ç©ºé—´äº†å—? å¯ä»¥å›åˆ°å‰é¢, å†çœ‹ä¸€ä¸‹é‚£æ®µ swappiness çš„è‹±æ–‡å®šä¹‰, é‡Œé¢ç‰¹åˆ«å¼ºè°ƒäº† swappiness ä¸º 0 çš„æƒ…å†µ.")]),s._v(" "),t("p",[s._v('å½“ç©ºé—²å†…å­˜å°‘äºå†…å­˜ä¸€ä¸ª zone çš„ "high water mark" ä¸­çš„å€¼çš„æ—¶å€™, Linux è¿˜æ˜¯ä¼šåšå†…å­˜äº¤æ¢, ä¹Ÿå°±æ˜¯æŠŠåŒ¿åå†…å­˜å†™å…¥åˆ° Swap ç©ºé—´åé‡Šæ”¾å†…å­˜. åœ¨è¿™é‡Œ zone æ˜¯ Linux åˆ’åˆ†ç‰©ç†å†…å­˜çš„ä¸€ä¸ªåŒºåŸŸ, é‡Œé¢æœ‰ 3 ä¸ªæ°´ä½çº¿(water mark), æ°´ä½çº¿å¯ä»¥ç”¨æ¥è­¦ç¤ºç©ºé—²å†…å­˜çš„ç´§å¼ ç¨‹åº¦.')]),s._v(" "),t("p",[s._v("è¿™é‡Œå¯ä»¥å†åšä¸ªè¯•éªŒæ¥éªŒè¯ä¸€ä¸‹, å…ˆè¿è¡Œ "),t("code",[s._v("echo 0 > /proc/sys/vm/swappiness")]),s._v("â€‹ å‘½ä»¤æŠŠ swappiness è®¾ç½®ä¸º 0, ç„¶åç”¨ä¹‹å‰ä¾‹å­é‡Œçš„ "),t("strong",[s._v("mem_alloc")]),s._v(" ç¨‹åºæ¥ç”³è¯·å†…å­˜.")]),s._v(" "),t("p",[s._v("æ¯”å¦‚è¿™ä¸ªèŠ‚ç‚¹ä¸Šå†…å­˜æœ‰ 12GB, åŒæ—¶æœ‰ 2GB çš„ Swap, ç”¨ mem_alloc ç”³è¯· 12GB çš„å†…å­˜, å¯ä»¥çœ‹åˆ° Swap ç©ºé—´åœ¨ mem_alloc è°ƒç”¨ä¹‹å‰, used=0, è¾“å‡ºç»“æœå¦‚ä¸‹å›¾æ‰€ç¤º.")]),s._v(" "),t("p",[t("img",{attrs:{src:"/img/a57a39f15985d7937046fa0d474ab4bc-20230731161430-ax17cs8.png",alt:""}})]),s._v(" "),t("p",[s._v("æ¥ä¸‹æ¥, è°ƒç”¨ mem_alloc ä¹‹å, Swap ç©ºé—´å°±è¢«ä½¿ç”¨äº†.")]),s._v(" "),t("p",[t("img",{attrs:{src:"/img/9734797b44e39617e717adab6752f8b0-20230731161430-2vfpfy9.png",alt:""}})]),s._v(" "),t("p",[s._v("å› ä¸º mem_alloc ç”³è¯· 12GB å†…å­˜å·²ç»å’ŒèŠ‚ç‚¹æœ€å¤§å†…å­˜å·®ä¸å¤šäº†, å¦‚æœæŸ¥çœ‹ "),t("code",[s._v("cat /proc/zoneinfo")]),s._v("â€‹ , ä¹Ÿå¯ä»¥çœ‹åˆ° normal zone é‡Œ high (water mark)çš„å€¼å’Œ free çš„å€¼å·®ä¸å¤š, è¿™æ ·åœ¨ free<high çš„æ—¶å€™, ç³»ç»Ÿå°±ä¼šå›æ”¶åŒ¿åå†…å­˜é¡µé¢å¹¶å†™å…¥ Swap ç©ºé—´.")]),s._v(" "),t("p",[t("img",{attrs:{src:"/img/6707d25112f55d7e1aee362775f20241-20230731161430-3ndai5a.png",alt:""}})]),s._v(" "),t("p",[s._v("å¥½äº†, åœ¨è¿™é‡Œä»‹ç»äº† Linux ç³»ç»Ÿé‡Œ swappiness çš„æ¦‚å¿µ, å®ƒæ˜¯ç”¨æ¥å†³å®šåœ¨å†…å­˜ç´§å¼ æ—¶å€™, å›æ”¶åŒ¿åå†…å­˜å’Œ Page Cache å†…å­˜çš„æ¯”ä¾‹.")]),s._v(" "),t("p",[t("mark",[s._v("**swappiness çš„å–å€¼èŒƒå›´åœ¨ 0 åˆ° 100, å€¼ä¸º 100 çš„æ—¶å€™ç³»ç»Ÿå¹³ç­‰å›æ”¶åŒ¿åå†…å­˜å’Œ Page Cache å†…å­˜; ä¸€èˆ¬ç¼ºçœå€¼ä¸º 60, å°±æ˜¯ä¼˜å…ˆå›æ”¶ Page Cache; å³ä½¿ swappiness ä¸º 0, ä¹Ÿä¸èƒ½å®Œå…¨ç¦æ­¢ Swap åˆ†åŒºçš„ä½¿ç”¨, å°±æ˜¯è¯´åœ¨å†…å­˜ç´§å¼ çš„æ—¶å€™, ä¹Ÿä¼šä½¿ç”¨ Swap æ¥å›æ”¶åŒ¿åå†…å­˜. **")])]),s._v(" "),t("h5",{attrs:{id:"_3-è§£å†³é—®é¢˜-4"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-è§£å†³é—®é¢˜-4"}},[s._v("#")]),s._v(" 3.è§£å†³é—®é¢˜")]),s._v(" "),t("p",[s._v("é‚£ä¹ˆè¿è¡Œäº†å®¹å™¨, ä½¿ç”¨äº† Memory Cgroup ä¹‹å, swappiness æ€ä¹ˆå·¥ä½œå‘¢?")]),s._v(" "),t("p",[s._v("å¦‚æœæŸ¥çœ‹ä¸€ä¸‹ Memory Cgroup æ§åˆ¶ç»„ä¸‹é¢çš„å‚æ•°, ä¼šçœ‹åˆ°æœ‰ä¸€ä¸ª "),t("strong",[s._v("memory.swappiness")]),s._v(" å‚æ•°. è¿™ä¸ªå‚æ•°å¯ä»¥"),t("strong",[s._v("æ§åˆ¶è¿™ä¸ª Memroy Cgroup æ§åˆ¶ç»„ä¸‹é¢åŒ¿åå†…å­˜å’Œ page cache çš„å›æ”¶, å–å€¼çš„èŒƒå›´å’Œå·¥ä½œæ–¹å¼å’Œå…¨å±€çš„ swappiness å·®ä¸å¤š")]),s._v(". è¿™é‡Œæœ‰ä¸€ä¸ªä¼˜å…ˆé¡ºåº, åœ¨ Memory Cgorup çš„æ§åˆ¶ç»„é‡Œ, å¦‚æœè®¾ç½®äº† memory.swappiness å‚æ•°, å®ƒå°±ä¼šè¦†ç›–å…¨å±€çš„ swappiness, è®©å…¨å±€çš„ swappiness åœ¨è¿™ä¸ªæ§åˆ¶ç»„é‡Œä¸èµ·ä½œç”¨.")]),s._v(" "),t("p",[s._v("ä¸è¿‡è¿™é‡Œæœ‰ä¸€ç‚¹ä¸åŒ, éœ€è¦ç•™æ„: **å½“ memory.swappiness = 0 çš„æ—¶å€™, å¯¹åŒ¿åé¡µçš„å›æ”¶æ˜¯å§‹ç»ˆç¦æ­¢çš„, ä¹Ÿå°±æ˜¯å§‹ç»ˆéƒ½ä¸ä¼šä½¿ç”¨ Swap ç©ºé—´. ** è¿™æ—¶ Linux ç³»ç»Ÿä¸ä¼šå†å»æ¯”è¾ƒ free å†…å­˜å’Œ zone é‡Œçš„ high water mark çš„å€¼, å†å†³å®šä¸€ä¸ª Memory Cgroup ä¸­çš„åŒ¿åå†…å­˜è¦ä¸è¦å›æ”¶äº†. è¯·æ³¨æ„, "),t("strong",[s._v('å½“è®¾ç½®äº† "memory.swappiness=0" æ—¶, åœ¨ Memory Cgroup ä¸­çš„è¿›ç¨‹, å°±ä¸ä¼šå†ä½¿ç”¨ Swap ç©ºé—´')]),s._v(", çŸ¥é“è¿™ä¸€ç‚¹å¾ˆé‡è¦.")]),s._v(" "),t("p",[s._v("å¯ä»¥è·‘ä¸ªå®¹å™¨è¯•ä¸€è¯•, è¿˜æ˜¯åœ¨ä¸€ä¸ªæœ‰ Swap ç©ºé—´çš„èŠ‚ç‚¹ä¸Šè¿è¡Œ, è¿è¡Œå’Œè¿™ä¸€è®²å¼€å§‹ä¸€æ ·çš„å®¹å™¨, å”¯ä¸€ä¸åŒçš„æ˜¯æŠŠå®¹å™¨å¯¹åº” Memory Cgroup é‡Œçš„ memory.swappiness è®¾ç½®ä¸º 0.")]),s._v(" "),t("p",[t("img",{attrs:{src:"/img/8ab1c7f6bbac8af6d2b7e36c86b58944-20230731161430-glc8ksb.png",alt:""}})]),s._v(" "),t("p",[s._v("è¿™æ¬¡åœ¨å®¹å™¨ä¸­ç”³è¯·å†…å­˜ä¹‹å, Swap ç©ºé—´å°±æ²¡æœ‰è¢«ä½¿ç”¨äº†, è€Œå½“å®¹å™¨ç”³è¯·çš„å†…å­˜è¶…è¿‡ memory.limit_in_bytes ä¹‹å, å°±å‘ç”Ÿäº† OOM Kill.")]),s._v(" "),t("p",[s._v('æœ‰äº† "memory.swappiness = 0" çš„é…ç½®å’ŒåŠŸèƒ½, å°±å¯ä»¥è§£å†³åœ¨è¿™ä¸€è®²é‡Œæœ€å¼€å§‹æå‡ºçš„é—®é¢˜äº†. '),t("strong",[s._v("åœ¨åŒä¸€ä¸ªå®¿ä¸»æœºä¸Š, å‡è®¾åŒæ—¶å­˜åœ¨å®¹å™¨ A å’Œå…¶ä»–å®¹å™¨, å®¹å™¨ A ä¸Šè¿è¡Œç€éœ€è¦ä½¿ç”¨ Swap ç©ºé—´çš„åº”ç”¨, è€Œåˆ«çš„å®¹å™¨ä¸éœ€è¦ä½¿ç”¨ Swap ç©ºé—´")]),s._v(".")]),s._v(" "),t("p",[s._v("é‚£ä¹ˆ, è¿˜æ˜¯"),t("strong",[s._v("å¯ä»¥åœ¨å®¿ä¸»æœºèŠ‚ç‚¹ä¸Šæ‰“å¼€ Swap ç©ºé—´, åŒæ—¶åœ¨å…¶ä»–å®¹å™¨å¯¹åº”çš„ Memory Cgroups æ§åˆ¶ç»„é‡Œ, æŠŠ memory.swappiness è¿™ä¸ªå‚æ•°è®¾ç½®ä¸º 0")]),s._v(". è¿™æ ·ä¸€æ¥, ä¸ä½†æ»¡è¶³äº†å®¹å™¨ A çš„éœ€æ±‚, è€Œä¸”åˆ«çš„å®¹å™¨ä¹Ÿä¸ä¼šå—åˆ°å½±å“, ä»ç„¶å¯ä»¥ä¸¥æ ¼æŒ‰ç…§ Memory Cgroups é‡Œçš„ memory.limit_in_bytes æ¥é™åˆ¶å†…å­˜çš„ä½¿ç”¨.")]),s._v(" "),t("p",[s._v("æ€»ä¹‹, "),t("strong",[s._v("memory.swappiness è¿™ä¸ªå‚æ•°å¾ˆæœ‰ç”¨, é€šè¿‡å®ƒå¯ä»¥è®©éœ€è¦ä½¿ç”¨ Swap ç©ºé—´çš„å®¹å™¨å’Œä¸éœ€è¦ Swap çš„å®¹å™¨, åŒæ—¶è¿è¡Œåœ¨åŒä¸€ä¸ªå®¿ä¸»æœºä¸Š")]),s._v(".")]),s._v(" "),t("h5",{attrs:{id:"_4-é‡ç‚¹æ€»ç»“-6"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_4-é‡ç‚¹æ€»ç»“-6"}},[s._v("#")]),s._v(" 4.é‡ç‚¹æ€»ç»“")]),s._v(" "),t("p",[s._v("æœ¬èŠ‚ä¸»è¦è®¨è®ºçš„é—®é¢˜æ˜¯åœ¨å®¹å™¨ä¸­æ˜¯å¦å¯ä»¥ä½¿ç”¨ Swap? è¿™ä¸ªé—®é¢˜æ²¡æœ‰çœ‹èµ·æ¥é‚£ä¹ˆç®€å•. å½“ç„¶åªè¦åœ¨å®¿ä¸»æœºèŠ‚ç‚¹ä¸Šæ‰“å¼€ Swap ç©ºé—´, åœ¨å®¹å™¨ä¸­å°±æ˜¯å¯ä»¥ç”¨åˆ° Swap çš„. ä½†å‡ºç°çš„"),t("strong",[s._v("é—®é¢˜æ˜¯åœ¨åŒä¸€ä¸ªå®¿ä¸»æœºä¸Š, å¯¹äºä¸éœ€è¦ä½¿ç”¨ swap çš„å®¹å™¨, å®ƒçš„ Memory Cgroups çš„é™åˆ¶ä¹Ÿå¤±å»äº†ä½œç”¨")]),s._v(".")]),s._v(" "),t("p",[s._v("é’ˆå¯¹è¿™ä¸ªé—®é¢˜, å­¦ä¹ äº† Linux ä¸­çš„ swappiness è¿™ä¸ªå‚æ•°. "),t("strong",[s._v("swappiness å‚æ•°å€¼çš„ä½œç”¨æ˜¯, åœ¨ç³»ç»Ÿé‡Œæœ‰ Swap ç©ºé—´ä¹‹å, å½“ç³»ç»Ÿéœ€è¦å›æ”¶å†…å­˜çš„æ—¶å€™, æ˜¯ä¼˜å…ˆé‡Šæ”¾ Page Cache ä¸­çš„å†…å­˜, è¿˜æ˜¯ä¼˜å…ˆé‡Šæ”¾åŒ¿åå†…å­˜(ä¹Ÿå°±æ˜¯å†™å…¥ Swap)")]),s._v(" .")]),s._v(" "),t("p",[s._v("swappiness çš„å–å€¼èŒƒå›´åœ¨ 0 åˆ° 100 ä¹‹é—´, å¯ä»¥è®°ä½ä¸‹é¢ä¸‰ä¸ªå€¼:")]),s._v(" "),t("ol",[t("li",[s._v("å€¼ä¸º 100 çš„æ—¶å€™, é‡Šæ”¾ Page Cache å’ŒåŒ¿åå†…å­˜æ˜¯åŒç­‰ä¼˜å…ˆçº§çš„.")]),s._v(" "),t("li",[s._v("å€¼ä¸º 60, è¿™æ˜¯å¤§å¤šæ•° Linux ç³»ç»Ÿçš„ç¼ºçœå€¼, è¿™æ—¶å€™ Page Cache çš„é‡Šæ”¾ä¼˜å…ˆçº§é«˜äºåŒ¿åå†…å­˜çš„é‡Šæ”¾.")]),s._v(" "),t("li",[s._v("å€¼ä¸º 0 çš„æ—¶å€™, å½“ç³»ç»Ÿä¸­ç©ºé—²å†…å­˜ä½äºä¸€ä¸ªä¸´ç•Œå€¼çš„æ—¶å€™, ä»ç„¶ä¼šé‡Šæ”¾åŒ¿åå†…å­˜å¹¶æŠŠé¡µé¢å†™å…¥ Swap ç©ºé—´.")])]),s._v(" "),t("p",[t("img",{attrs:{src:"/img/23f810fd577934a1afdb14cdc49ce4ed-20230731161430-wfe9h6z.png",alt:""}})]),s._v(" "),t("p",[s._v("swappiness å‚æ•°é™¤äº†åœ¨ proc æ–‡ä»¶ç³»ç»Ÿä¸‹æœ‰ä¸ªå…¨å±€çš„å€¼å¤–, ** åœ¨æ¯ä¸ª Memory Cgroup æ§åˆ¶ç»„é‡Œä¹Ÿæœ‰ä¸€ä¸ª memory.swappiness**, é‚£å®ƒä»¬æœ‰ä»€ä¹ˆä¸åŒå‘¢?")]),s._v(" "),t("p",[s._v("**ä¸åŒå°±æ˜¯æ¯ä¸ª Memory Cgroup æ§åˆ¶ç»„é‡Œçš„ swappiness å‚æ•°å€¼ä¸º 0 çš„æ—¶å€™, å°±å¯ä»¥è®©æ§åˆ¶ç»„é‡Œçš„å†…å­˜åœæ­¢å†™å…¥ Swap. è¿™æ ·ä¸€æ¥, æœ‰äº† memory.swappiness è¿™ä¸ªå‚æ•°å, éœ€è¦ä½¿ç”¨ Swap å’Œä¸éœ€è¦ Swap çš„å®¹å™¨å°±å¯ä»¥åœ¨åŒä¸€ä¸ªå®¿ä¸»æœºä¸ŠåŒæ—¶è¿è¡Œäº†, è¿™æ ·å¯¹äºç¡¬ä»¶èµ„æºçš„åˆ©ç”¨ç‡ä¹Ÿå°±æ›´é«˜äº†. **")]),s._v(" "),t("h3",{attrs:{id:"å®¹å™¨å­˜å‚¨"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#å®¹å™¨å­˜å‚¨"}},[s._v("#")]),s._v(" å®¹å™¨å­˜å‚¨")]),s._v(" "),t("h4",{attrs:{id:"_11-å®¹å™¨æ–‡ä»¶ç³»ç»Ÿ-æˆ‘åœ¨å®¹å™¨ä¸­è¯»å†™æ–‡ä»¶æ€ä¹ˆå˜æ…¢äº†"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_11-å®¹å™¨æ–‡ä»¶ç³»ç»Ÿ-æˆ‘åœ¨å®¹å™¨ä¸­è¯»å†™æ–‡ä»¶æ€ä¹ˆå˜æ…¢äº†"}},[s._v("#")]),s._v(" 11 | å®¹å™¨æ–‡ä»¶ç³»ç»Ÿ:æˆ‘åœ¨å®¹å™¨ä¸­è¯»å†™æ–‡ä»¶æ€ä¹ˆå˜æ…¢äº†?")]),s._v(" "),t("p",[s._v("ä»è¿™ä¸€è®²å¼€å§‹è¿›å…¥å®¹å™¨å­˜å‚¨è¿™ä¸ªæ¨¡å—. è¿™ä¸€æ¨¡å—çš„å†…å®¹, éƒ½å’Œå®¹å™¨é‡Œçš„"),t("strong",[s._v("æ–‡ä»¶è¯»å†™")]),s._v("å¯†åˆ‡ç›¸å…³. å› ä¸ºæ‰€æœ‰çš„å®¹å™¨çš„è¿è¡Œéƒ½éœ€è¦ä¸€ä¸ªå®¹å™¨æ–‡ä»¶ç³»ç»Ÿ, é‚£ä¹ˆå°±ä»å®¹å™¨æ–‡ä»¶ç³»ç»Ÿå…ˆå¼€å§‹è®²èµ·.")]),s._v(" "),t("p",[s._v("è¿˜æ˜¯å’Œä»¥å‰ä¸€æ ·, å…ˆæ¥çœ‹çœ‹æˆ‘ä¹‹å‰ç¢°åˆ°äº†ä»€ä¹ˆé—®é¢˜. è¿™ä¸ªé—®é¢˜å…·ä½“æ˜¯æˆ‘ä»¬åœ¨å®¿ä¸»æœºä¸Š, æŠŠ Linux ä» ubuntu18.04 å‡çº§åˆ° ubuntu20.04 ä¹‹åå‘ç°çš„. åœ¨æˆ‘ä»¬åšäº†å®¿ä¸»æœºçš„å‡çº§å, å¯åŠ¨äº†ä¸€ä¸ªå®¹å™¨, åœ¨å®¹å™¨é‡Œç”¨ fio è¿™ä¸ªç£ç›˜æ€§èƒ½æµ‹è¯•å·¥å…·, æƒ³çœ‹ä¸€ä¸‹å®¹å™¨é‡Œæ–‡ä»¶çš„è¯»å†™æ€§èƒ½. ç»“æœæˆ‘ä»¬å¾ˆæƒŠè®¶åœ°å‘ç°, åœ¨ ubuntu 20.04 å®¿ä¸»æœºä¸Šçš„å®¹å™¨ä¸­æ–‡ä»¶è¯»å†™çš„æ€§èƒ½åªæœ‰ ubuntu18.04 å®¿ä¸»æœºä¸Šçš„ 1/8 å·¦å³äº†, é‚£è¿™æ˜¯æ€ä¹ˆå›äº‹å‘¢?")]),s._v(" "),t("h5",{attrs:{id:"_1-é—®é¢˜å†ç°-7"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-é—®é¢˜å†ç°-7"}},[s._v("#")]),s._v(" 1.é—®é¢˜å†ç°")]),s._v(" "),t("p",[s._v("è¿™é‡Œæé†’ä¸€ä¸‹, å› ä¸ºæ¶‰åŠåˆ°ä¸¤ä¸ª Linux çš„è™šæ‹Ÿæœº, é—®é¢˜å†ç°è¿™é‡Œåˆ—å‡ºäº†å…³é”®çš„ç»“æœè¾“å‡ºæˆªå›¾, ä¸æ–¹ä¾¿æ“ä½œçš„åŒå­¦å¯ä»¥é‡ç‚¹çœ‹å…¶ä¸­çš„æ€è·¯.")]),s._v(" "),t("p",[s._v("å¯ä»¥å…ˆå¯åŠ¨ä¸€ä¸ª ubuntu18.04 çš„è™šæ‹Ÿæœº, å®ƒçš„ Linux å†…æ ¸ç‰ˆæœ¬æ˜¯ 4.15 çš„, ç„¶ååœ¨è™šæ‹Ÿæœºä¸Šç”¨å‘½ä»¤ "),t("code",[s._v("docker run -it ubuntu:18.04 bash")]),s._v("â€‹ å¯åŠ¨ä¸€ä¸ªå®¹å™¨, æ¥ç€åœ¨å®¹å™¨é‡Œè¿è¡Œ fio è¿™æ¡å‘½ä»¤, çœ‹ä¸€ä¸‹åœ¨å®¹å™¨ä¸­è¯»å–æ–‡ä»¶çš„æ€§èƒ½.")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# fio -direct=1 -iodepth=64 -rw=read -ioengine=libaio -bs=4k -size=10G -numjobs=1  -name=./fio.test")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("è¿™é‡Œè§£é‡Šä¸€ä¸‹ fio å‘½ä»¤ä¸­çš„å‡ ä¸ªä¸»è¦å‚æ•°:")]),s._v(" "),t("p",[s._v('ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ "-direct=1", ä»£è¡¨é‡‡ç”¨é buffered I/O æ–‡ä»¶è¯»å†™çš„æ–¹å¼, é¿å…æ–‡ä»¶è¯»å†™è¿‡ç¨‹ä¸­å†…å­˜ç¼“å†²å¯¹æ€§èƒ½çš„å½±å“.')]),s._v(" "),t("p",[s._v('æ¥ç€æ¥çœ‹è¿™ "-iodepth=64" å’Œ "-ioengine=libaio" è¿™ä¸¤ä¸ªå‚æ•°, è¿™é‡ŒæŒ‡æ–‡ä»¶è¯»å†™é‡‡ç”¨'),t("strong",[s._v("å¼‚æ­¥ I/O")]),s._v("(Async I/O)çš„æ–¹å¼, ä¹Ÿå°±æ˜¯è¿›ç¨‹å¯ä»¥å‘èµ·å¤šä¸ª I/O è¯·æ±‚, å¹¶ä¸”ä¸ç”¨é˜»å¡åœ°ç­‰å¾… I/O çš„å®Œæˆ. ç¨åç­‰ I/O å®Œæˆä¹‹å, è¿›ç¨‹ä¼šæ”¶åˆ°é€šçŸ¥. è¿™ç§å¼‚æ­¥ I/O å¾ˆé‡è¦, å› ä¸ºå®ƒå¯ä»¥æå¤§åœ°æé«˜æ–‡ä»¶è¯»å†™çš„æ€§èƒ½. åœ¨è¿™é‡Œè®¾ç½®äº†åŒæ—¶å‘å‡º 64 ä¸ª I/O è¯·æ±‚.")]),s._v(" "),t("p",[s._v('ç„¶åæ˜¯ "-rw=read, -bs=4k, -size=10G", è¿™å‡ ä¸ªå‚æ•°æŒ‡è¿™ä¸ªæµ‹è¯•æ˜¯ä¸ªè¯»æ–‡ä»¶æµ‹è¯•, æ¯æ¬¡è¯» 4KB å¤§å°æ•°å—, æ€»å…±è¯» 10GB çš„æ•°æ®.')]),s._v(" "),t("p",[s._v('æœ€åä¸€ä¸ªå‚æ•°æ˜¯ "-numjobs=1", æŒ‡åªæœ‰ä¸€ä¸ªè¿›ç¨‹ / çº¿ç¨‹åœ¨è¿è¡Œ.')]),s._v(" "),t("p",[t("strong",[s._v("æ‰€ä»¥è¿™æ¡ fio å‘½ä»¤è¡¨ç¤ºé€šè¿‡å¼‚æ­¥æ–¹å¼è¯»å–äº† 10GB çš„ç£ç›˜æ–‡ä»¶, ç”¨æ¥è®¡ç®—æ–‡ä»¶çš„è¯»å–æ€§èƒ½.")])]),s._v(" "),t("p",[s._v("å¯ä»¥çœ‹åˆ°åœ¨ ubuntu 18.04, å†…æ ¸ 4.15 ä¸Šçš„å®¹å™¨ I/O æ€§èƒ½æ˜¯ 584MB/s çš„å¸¦å®½, IOPS(I/O per second)æ˜¯ 150K å·¦å³.")]),s._v(" "),t("p",[t("img",{attrs:{src:"/img/1c40045943e8892834dbfba56fb0195b-20230731161430-ps4qgzw.png",alt:""}})]),s._v(" "),t("p",[s._v("åŒæ ·å†å¯åŠ¨ä¸€ä¸ª ubuntu 20.04, å†…æ ¸ 5.4 çš„è™šæ‹Ÿæœº, ç„¶ååœ¨å®ƒçš„ä¸Šé¢ä¹Ÿå¯åŠ¨ä¸€ä¸ªå®¹å™¨. è¿è¡Œ "),t("code",[s._v("docker run -it ubuntu:20.04 bash")]),s._v("â€‹, æ¥ç€åœ¨å®¹å™¨ä¸­ä½¿ç”¨åŒæ ·çš„ fio å‘½ä»¤, å¯ä»¥çœ‹åˆ°å®ƒçš„ I/O æ€§èƒ½æ˜¯ 70MB å¸¦å®½, IOPS æ˜¯ 18K å·¦å³. å®è·µè¯æ˜, è¿™çš„ç¡®æ¯”è€ç‰ˆæœ¬çš„ ubuntu 18.04 å·®äº†å¾ˆå¤š.")]),s._v(" "),t("p",[t("img",{attrs:{src:"/img/70bb078d3737219d8e1da4ca76d3b0c7-20230731161430-okanw0k.png",alt:""}})]),s._v(" "),t("h5",{attrs:{id:"_2-çŸ¥è¯†è¯¦è§£-3"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-çŸ¥è¯†è¯¦è§£-3"}},[s._v("#")]),s._v(" 2.çŸ¥è¯†è¯¦è§£")]),s._v(" "),t("h6",{attrs:{id:"_1-å¦‚ä½•ç†è§£å®¹å™¨æ–‡ä»¶ç³»ç»Ÿ"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-å¦‚ä½•ç†è§£å®¹å™¨æ–‡ä»¶ç³»ç»Ÿ"}},[s._v("#")]),s._v(" (1)å¦‚ä½•ç†è§£å®¹å™¨æ–‡ä»¶ç³»ç»Ÿ?")]),s._v(" "),t("p",[s._v("åˆšæ‰å¯¹æ¯”äº†å‡çº§å‰åçš„å®¹å™¨è¯»å†™æ€§èƒ½å·®å¼‚, é‚£æƒ³è¦åˆ†æåˆšåˆšè¯´çš„è¿™ä¸ªæ€§èƒ½çš„å·®å¼‚, éœ€è¦"),t("strong",[s._v("å…ˆç†è§£å®¹å™¨çš„æ–‡ä»¶ç³»ç»Ÿ")]),s._v(".")]),s._v(" "),t("p",[s._v("åœ¨å®¹å™¨é‡Œ, è¿è¡Œ "),t("code",[s._v("df")]),s._v("â€‹ å‘½ä»¤, å¯ä»¥çœ‹åˆ°åœ¨"),t("strong",[s._v('å®¹å™¨ä¸­æ ¹ç›®å½• (/) çš„æ–‡ä»¶ç³»ç»Ÿç±»å‹æ˜¯ "overlay"')]),s._v(" , å®ƒä¸æ˜¯åœ¨æ™®é€š Linux èŠ‚ç‚¹ä¸Šçœ‹åˆ°çš„ Ext4 æˆ–è€… XFS ä¹‹ç±»å¸¸è§çš„æ–‡ä»¶ç³»ç»Ÿ.")]),s._v(" "),t("p",[s._v("Overlay æ˜¯ä¸€ä¸ªä»€ä¹ˆæ ·çš„æ–‡ä»¶ç³»ç»Ÿå‘¢, å®¹å™¨ä¸ºä»€ä¹ˆè¦ç”¨è¿™ç§æ–‡ä»¶ç³»ç»Ÿ?")]),s._v(" "),t("p",[t("img",{attrs:{src:"/img/d343cedab568b1bdd97a29b20e583385-20230731161430-0yyrxdu.png",alt:""}})]),s._v(" "),t("p",[s._v("åœ¨è¯´å®¹å™¨æ–‡ä»¶ç³»ç»Ÿå‰, å…ˆæ¥æƒ³è±¡ä¸€ä¸‹å¦‚æœæ²¡æœ‰æ–‡ä»¶ç³»ç»Ÿç®¡ç†çš„è¯ä¼šæ€æ ·. å‡è®¾æœ‰è¿™ä¹ˆä¸€ä¸ªåœºæ™¯, åœ¨ä¸€ä¸ªå®¿ä¸»æœºä¸Šéœ€è¦è¿è¡Œ 100 ä¸ªå®¹å™¨.")]),s._v(" "),t("p",[s._v("åœ¨è¿™ä¸ªè¯¾ç¨‹çš„ç¬¬ä¸€è®²é‡Œ, å°±è¯´è¿‡æ¯ä¸ªå®¹å™¨éƒ½éœ€è¦ä¸€ä¸ª"),t("strong",[s._v("é•œåƒ")]),s._v(", è¿™ä¸ªé•œåƒå°±æŠŠå®¹å™¨ä¸­ç¨‹åºéœ€è¦è¿è¡Œçš„äºŒè¿›åˆ¶æ–‡ä»¶, åº“æ–‡ä»¶, é…ç½®æ–‡ä»¶, å…¶ä»–çš„ä¾èµ–æ–‡ä»¶ç­‰å…¨éƒ¨éƒ½æ‰“åŒ…æˆä¸€ä¸ªé•œåƒæ–‡ä»¶. "),t("strong",[s._v("å¦‚æœæ²¡æœ‰ç‰¹åˆ«çš„å®¹å™¨æ–‡ä»¶ç³»ç»Ÿ, åªæ˜¯æ™®é€šçš„ Ext4 æˆ–è€… XFS æ–‡ä»¶ç³»ç»Ÿ, é‚£ä¹ˆæ¯æ¬¡å¯åŠ¨ä¸€ä¸ªå®¹å™¨, å°±éœ€è¦æŠŠä¸€ä¸ªé•œåƒæ–‡ä»¶ä¸‹è½½å¹¶ä¸”å­˜å‚¨åœ¨å®¿ä¸»æœºä¸Š")]),s._v(". ä¸¾ä¸ªä¾‹å­, æ¯”å¦‚è¯´, å‡è®¾ä¸€ä¸ªé•œåƒæ–‡ä»¶çš„å¤§å°æ˜¯ 500MB, é‚£ä¹ˆ 100 ä¸ªå®¹å™¨çš„è¯, å°±éœ€è¦ä¸‹è½½ 500MB*100= 50GB çš„æ–‡ä»¶, å¹¶ä¸”å ç”¨ 50GB çš„ç£ç›˜ç©ºé—´.")]),s._v(" "),t("p",[s._v("å¦‚æœå†åˆ†æä¸€ä¸‹è¿™ 50GB é‡Œçš„å†…å®¹, ä½ ä¼šå‘ç°ç»å¤§éƒ¨åˆ†çš„æ“ä½œç³»ç»Ÿé‡Œ, "),t("strong",[s._v("åº“æ–‡ä»¶éƒ½æ˜¯å·®ä¸å¤š")]),s._v('çš„. è€Œä¸”åœ¨å®¹å™¨è¿è¡Œçš„æ—¶å€™, è¿™ç±»æ–‡ä»¶ä¹Ÿä¸ä¼šè¢«æ”¹åŠ¨, åŸºæœ¬ä¸Šéƒ½æ˜¯åªè¯»çš„. ç‰¹åˆ«æ˜¯è¿™æ ·çš„æƒ…å†µ: å‡å¦‚è¿™ 100 ä¸ªå®¹å™¨é•œåƒéƒ½æ˜¯åŸºäº "ubuntu:18.04" çš„, æ¯ä¸ªå®¹å™¨é•œåƒåªæ˜¯é¢å¤–å¤åˆ¶äº† 50MB å·¦å³è‡ªå·±çš„åº”ç”¨ç¨‹åºåˆ° "ubuntu: 18.04" é‡Œ, é‚£ä¹ˆå°±æ˜¯è¯´åœ¨æ€»å…± 50GB çš„æ•°æ®é‡Œ, æœ‰ 90% çš„æ•°æ®æ˜¯å†—ä½™çš„.')]),s._v(" "),t("p",[s._v("è®²åˆ°è¿™é‡Œ, å°±ä¸éš¾æ¨æµ‹å‡ºç†æƒ³çš„æƒ…å†µåº”è¯¥æ˜¯ä»€ä¹ˆæ ·çš„. æ²¡é”™, å½“ç„¶æ˜¯"),t("strong",[s._v('åœ¨ä¸€ä¸ªå®¿ä¸»æœºä¸Šåªè¦ä¸‹è½½å¹¶ä¸”å­˜å‚¨å­˜ä¸€ä»½ "ubuntu:18.04", æ‰€æœ‰åŸºäº "ubuntu:18.04" é•œåƒçš„å®¹å™¨éƒ½å¯ä»¥å…±äº«è¿™ä¸€ä»½é€šç”¨çš„éƒ¨åˆ†')]),s._v(". è¿™æ ·è®¾ç½®çš„è¯, ä¸åŒå®¹å™¨å¯åŠ¨çš„æ—¶å€™, åªéœ€è¦"),t("strong",[s._v("ä¸‹è½½è‡ªå·±ç‹¬ç‰¹çš„ç¨‹åºéƒ¨åˆ†å°±å¯ä»¥")]),s._v(". å°±åƒä¸‹é¢è¿™å¼ å›¾å±•ç¤ºçš„è¿™æ ·.")]),s._v(" "),t("p",[t("img",{attrs:{src:"/img/66ebb544d59f593149c2d7f40d4528cd-20230731161430-fgvgieo.png",alt:""}})]),s._v(" "),t("p",[t("mark",[s._v("**æ­£æ˜¯ä¸ºäº†æœ‰æ•ˆåœ°å‡å°‘ç£ç›˜ä¸Šå†—ä½™çš„é•œåƒæ•°æ®, åŒæ—¶å‡å°‘å†—ä½™çš„é•œåƒæ•°æ®åœ¨ç½‘ç»œä¸Šçš„ä¼ è¾“, é€‰æ‹©ä¸€ç§é’ˆå¯¹äºå®¹å™¨çš„æ–‡ä»¶ç³»ç»Ÿæ˜¯å¾ˆæœ‰å¿…è¦çš„, è€Œè¿™ç±»çš„æ–‡ä»¶ç³»ç»Ÿè¢«ç§°ä¸º UnionFS. **")])]),s._v(" "),t("p",[t("strong",[s._v("UnionFS è¿™ç±»æ–‡ä»¶ç³»ç»Ÿå®ç°çš„ä¸»è¦åŠŸèƒ½æ˜¯æŠŠå¤šä¸ªç›®å½•(å¤„äºä¸åŒçš„åˆ†åŒº)ä¸€èµ·æŒ‚è½½(mount)åœ¨ä¸€ä¸ªç›®å½•ä¸‹")]),s._v(". è¿™ç§å¤šç›®å½•æŒ‚è½½çš„æ–¹å¼, æ­£å¥½å¯ä»¥è§£å†³åˆšæ‰è¯´çš„å®¹å™¨é•œåƒçš„é—®é¢˜.")]),s._v(" "),t("p",[s._v("æ¯”å¦‚, å¯ä»¥æŠŠ ubuntu18.04 è¿™ä¸ªåŸºç¡€é•œåƒçš„æ–‡ä»¶æ”¾åœ¨ä¸€ä¸ªç›®å½• ubuntu18.04/ ä¸‹, å®¹å™¨è‡ªå·±é¢å¤–çš„ç¨‹åºæ–‡ä»¶ app_1_bin æ”¾åœ¨ app_1/ ç›®å½•ä¸‹. ç„¶åæŠŠè¿™ä¸¤ä¸ªç›®å½•æŒ‚è½½åˆ° container_1/ è¿™ä¸ªç›®å½•ä¸‹, ä½œä¸ºå®¹å™¨ 1 çœ‹åˆ°çš„æ–‡ä»¶ç³»ç»Ÿ; å¯¹äºå®¹å™¨ 2, å°±å¯ä»¥æŠŠ ubuntu18.04/ å’Œ app_2/ ä¸¤ä¸ªç›®å½•ä¸€èµ·æŒ‚è½½åˆ° container_2 çš„ç›®å½•ä¸‹.")]),s._v(" "),t("p",[s._v("è¿™æ ·åœ¨èŠ‚ç‚¹ä¸Šåªè¦ä¿ç•™ä¸€ä»½ ubuntu18.04 çš„æ–‡ä»¶å°±å¯ä»¥äº†.")]),s._v(" "),t("p",[t("img",{attrs:{src:"/img/2d830fb32bad5ee14121cd9b73328908-20230731161430-evedzmi.png",alt:""}})]),s._v(" "),t("h6",{attrs:{id:"_2-overlayfs"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-overlayfs"}},[s._v("#")]),s._v(" (2)OverlayFS")]),s._v(" "),t("p",[s._v("UnionFS ç±»ä¼¼çš„æœ‰å¾ˆå¤šç§"),t("strong",[s._v("å®ç°")]),s._v(", åŒ…æ‹¬åœ¨ Docker é‡Œæœ€æ—©ä½¿ç”¨çš„ AUFS, è¿˜æœ‰ç›®å‰ä½¿ç”¨çš„ "),t("strong",[s._v("OverlayFS")]),s._v(". å‰é¢åœ¨è¿è¡Œ "),t("code",[s._v("df")]),s._v('â€‹ çš„æ—¶å€™, çœ‹åˆ°çš„æ–‡ä»¶ç³»ç»Ÿç±»å‹ "overlay" æŒ‡çš„å°±æ˜¯ OverlayFS.')]),s._v(" "),t("p",[s._v("åœ¨ Linux å†…æ ¸ 3.18 ç‰ˆæœ¬ä¸­, OverlayFS ä»£ç æ­£å¼åˆå…¥ Linux å†…æ ¸çš„ä¸»åˆ†æ”¯. åœ¨è¿™ä¹‹å, "),t("strong",[s._v("OverlayFS ä¹Ÿå°±é€æ¸æˆä¸ºå„ä¸ªä¸»æµ Linux å‘è¡Œç‰ˆæœ¬é‡Œç¼ºçœä½¿ç”¨çš„å®¹å™¨æ–‡ä»¶ç³»ç»Ÿäº†")]),s._v(".")]),s._v(" "),t("p",[s._v("ç½‘ä¸Š Julia Evans æœ‰ä¸ª blog, é‡Œé¢æœ‰ä¸ªçš„ OverlayFS ä½¿ç”¨çš„ä¾‹å­, å¾ˆç®€å•, æˆ‘ä»¬ä¹Ÿæ‹¿è¿™ä¸ªä¾‹å­æ¥ç†è§£ä¸€ä¸‹ OverlayFS çš„ä¸€äº›åŸºæœ¬æ¦‚å¿µ.")]),s._v(" "),t("p",[s._v("å¯ä»¥å…ˆæ‰§è¡Œä¸€ä¸‹è¿™ä¸€ç»„å‘½ä»¤.")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token shebang important"}},[s._v("#!/bin/bash")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("umount")]),s._v(" ./merged\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("rm")]),s._v(" upper lower merged work "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-r")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("mkdir")]),s._v(" upper lower merged work\n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"I\'m from lower!"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" lower/in_lower.txt\n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"I\'m from upper!"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" upper/in_upper.txt\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# `in_both` is in both directories")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"I\'m from lower!"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" lower/in_both.txt\n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"I\'m from upper!"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" upper/in_both.txt\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("mount")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-t")]),s._v(" overlay overlay "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-o")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("lowerdir")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("./lower,upperdir"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("./upper,workdir"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("./work "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n ./merged\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br")])]),t("p",[s._v("å¯ä»¥çœ‹åˆ°, OverlayFS çš„ä¸€ä¸ª mount å‘½ä»¤ç‰µæ¶‰åˆ°"),t("strong",[s._v("å››ç±»ç›®å½•")]),s._v(", åˆ†åˆ«æ˜¯ "),t("strong",[s._v("lower, upper, merged å’Œ work")]),s._v(", é‚£å®ƒä»¬æ˜¯ä»€ä¹ˆå…³ç³»å‘¢?")]),s._v(" "),t("p",[s._v("çœ‹ä¸‹é¢è¿™å¼ å›¾, è¿™å’Œå‰é¢ UnionFS çš„å·¥ä½œç¤ºæ„å›¾å¾ˆåƒ, ä¹Ÿä¸å¥‡æ€ª, "),t("strong",[s._v("OverlayFS å°±æ˜¯ UnionFS çš„ä¸€ç§å®ç°")]),s._v(". æ¥ä¸‹æ¥ä»ä¸‹å¾€ä¸Šä¾æ¬¡çœ‹çœ‹æ¯ä¸€å±‚çš„åŠŸèƒ½.")]),s._v(" "),t("p",[s._v('é¦–å…ˆ, æœ€ä¸‹é¢çš„ "'),t("strong",[s._v("lower/")]),s._v(' ", ä¹Ÿå°±æ˜¯è¢« mount ä¸¤å±‚ç›®å½•ä¸­åº•ä¸‹çš„è¿™å±‚(lowerdir). åœ¨ OverlayFS ä¸­, '),t("strong",[s._v("æœ€åº•ä¸‹è¿™ä¸€å±‚é‡Œçš„æ–‡ä»¶æ˜¯ä¸ä¼šè¢«ä¿®æ”¹çš„, å¯ä»¥è®¤ä¸ºå®ƒæ˜¯åªè¯»çš„")]),s._v(". æé†’ä¸€ç‚¹, åœ¨è¿™ä¸ªä¾‹å­é‡Œåªæœ‰ä¸€ä¸ª lower/ ç›®å½•, ä¸è¿‡ OverlayFS æ˜¯æ”¯æŒå¤šä¸ª lowerdir çš„.")]),s._v(" "),t("p",[s._v('ç„¶åçœ‹ "'),t("strong",[s._v("uppder/")]),s._v(' ", å®ƒæ˜¯è¢« mount ä¸¤å±‚ç›®å½•ä¸­ä¸Šé¢çš„è¿™å±‚ (upperdir). åœ¨ OverlayFS ä¸­, å¦‚æœ'),t("strong",[s._v("æœ‰æ–‡ä»¶çš„åˆ›å»º, ä¿®æ”¹, åˆ é™¤æ“ä½œ, é‚£ä¹ˆéƒ½ä¼šåœ¨è¿™ä¸€å±‚åæ˜ å‡ºæ¥, å®ƒæ˜¯å¯è¯»å†™çš„")]),s._v(".")]),s._v(" "),t("p",[s._v('æ¥ç€æ˜¯æœ€ä¸Šé¢çš„ "'),t("strong",[s._v("merged")]),s._v('", å®ƒæ˜¯'),t("strong",[s._v("æŒ‚è½½ç‚¹(mount point)ç›®å½•, ä¹Ÿæ˜¯ç”¨æˆ·çœ‹åˆ°çš„ç›®å½•, ç”¨æˆ·çš„å®é™…æ–‡ä»¶æ“ä½œåœ¨è¿™é‡Œè¿›è¡Œ")]),s._v(".")]),s._v(" "),t("p",[s._v('å…¶å®è¿˜æœ‰ä¸€ä¸ª "'),t("strong",[s._v("work/")]),s._v(' ", è¿™ä¸ªç›®å½•æ²¡æœ‰åœ¨è¿™ä¸ªå›¾é‡Œ, å®ƒåªæ˜¯ä¸€ä¸ªå­˜æ”¾'),t("strong",[s._v("ä¸´æ—¶æ–‡ä»¶")]),s._v("çš„ç›®å½•, OverlayFS ä¸­å¦‚æœæœ‰æ–‡ä»¶ä¿®æ”¹, å°±ä¼šåœ¨ä¸­é—´è¿‡ç¨‹ä¸­ä¸´æ—¶å­˜æ”¾æ–‡ä»¶åˆ°è¿™é‡Œ.")]),s._v(" "),t("p",[t("img",{attrs:{src:"/img/e398a145ed5b51fdee5b5fac6f5fe203-20230731161430-9mrkmju.png",alt:""}})]),s._v(" "),t("p",[s._v("ä»è¿™ä¸ªä¾‹å­å¯ä»¥çœ‹åˆ°, "),t("strong",[s._v("OverlayFS ä¼š mount ä¸¤å±‚ç›®å½•, åˆ†åˆ«æ˜¯ lower å±‚å’Œ upper å±‚, è¿™ä¸¤å±‚ç›®å½•ä¸­çš„æ–‡ä»¶éƒ½ä¼šæ˜ å°„åˆ°æŒ‚è½½ç‚¹ä¸Š")]),s._v(".")]),s._v(" "),t("p",[s._v('ä»æŒ‚è½½ç‚¹çš„è§†è§’çœ‹, upper å±‚çš„æ–‡ä»¶ä¼šè¦†ç›– lower å±‚çš„æ–‡ä»¶, æ¯”å¦‚ "in_both.txt" è¿™ä¸ªæ–‡ä»¶, åœ¨ lower å±‚å’Œ upper å±‚éƒ½æœ‰, ä½†æ˜¯æŒ‚è½½ç‚¹ merged/ é‡Œçœ‹åˆ°çš„åªæ˜¯ upper å±‚é‡Œçš„ in_both.txt.')]),s._v(" "),t("p",[s._v("å¦‚æœåœ¨ merged/ ç›®å½•é‡Œåš"),t("strong",[s._v("æ–‡ä»¶æ“ä½œ")]),s._v(", å…·ä½“åŒ…æ‹¬è¿™ä¸‰ç§.")]),s._v(" "),t("p",[s._v("ç¬¬ä¸€ç§"),t("strong",[s._v("æ–°å»ºæ–‡ä»¶")]),s._v(", è¿™ä¸ªæ–‡ä»¶ä¼šå‡ºç°åœ¨ "),t("strong",[s._v("upper/")]),s._v("  ç›®å½•ä¸­.")]),s._v(" "),t("p",[s._v("ç¬¬äºŒç§æ˜¯"),t("strong",[s._v("åˆ é™¤æ–‡ä»¶")]),s._v(', å¦‚æœåˆ é™¤ "in_upper.txt", é‚£ä¹ˆè¿™ä¸ªæ–‡ä»¶ä¼šåœ¨ upper/ ç›®å½•ä¸­æ¶ˆå¤±. å¦‚æœåˆ é™¤ "in_lower.txt", åœ¨ lower/ ç›®å½•é‡Œçš„ "in_lower.txt" æ–‡ä»¶ä¸ä¼šæœ‰å˜åŒ–, åªæ˜¯åœ¨ upper/ ç›®å½•ä¸­å¢åŠ äº†ä¸€ä¸ªç‰¹æ®Šæ–‡ä»¶æ¥å‘Šè¯‰ OverlayFS, "in_lower.txt" è¿™ä¸ªæ–‡ä»¶'),t("strong",[s._v("ä¸èƒ½å‡ºç°åœ¨ merged/ é‡Œ")]),s._v("äº†, è¿™å°±è¡¨ç¤ºå®ƒå·²ç»è¢«åˆ é™¤äº†.")]),s._v(" "),t("p",[t("img",{attrs:{src:"/img/aa9c573433c84ebfe5407fd33387552f-20230731161430-ojv3x04.png",alt:""}})]),s._v(" "),t("p",[s._v("è¿˜æœ‰ä¸€ç§æ“ä½œæ˜¯"),t("strong",[s._v("ä¿®æ”¹æ–‡ä»¶")]),s._v(', ç±»ä¼¼å¦‚æœä¿®æ”¹ "in_lower.txt", é‚£ä¹ˆå°±ä¼š'),t("strong",[s._v('åœ¨ upper/ ç›®å½•ä¸­æ–°å»ºä¸€ä¸ª "in_lower.txt" æ–‡ä»¶, åŒ…å«æ›´æ–°çš„å†…å®¹, è€Œåœ¨ lower/ ä¸­çš„åŸæ¥çš„å®é™…æ–‡ä»¶ "in_lower.txt" ä¸ä¼šæ”¹å˜')]),s._v(".")]),s._v(" "),t("p",[s._v("é€šè¿‡è¿™ä¸ªä¾‹å­å¯ä»¥çŸ¥é“ OverlayFS æ˜¯æ€ä¹ˆå·¥ä½œçš„. å¯ä»¥å†æƒ³ä¸€æƒ³, æ€ä¹ˆæŠŠå®ƒè¿ç”¨åˆ°å®¹å™¨çš„é•œåƒæ–‡ä»¶ä¸Š?")]),s._v(" "),t("p",[s._v("å…¶å®ä¹Ÿä¸éš¾, ä»ç³»ç»Ÿçš„ mounts ä¿¡æ¯ä¸­, å¯ä»¥çœ‹åˆ° Docker æ˜¯æ€ä¹ˆç”¨ OverlayFS æ¥æŒ‚è½½é•œåƒæ–‡ä»¶çš„. "),t("strong",[s._v("å®¹å™¨é•œåƒæ–‡ä»¶å¯ä»¥åˆ†æˆå¤šä¸ªå±‚(layer), æ¯å±‚å¯ä»¥å¯¹åº” OverlayFS é‡Œ lowerdir çš„ä¸€ä¸ªç›®å½•, lowerdir æ”¯æŒå¤šä¸ªç›®å½•, ä¹Ÿå°±å¯ä»¥æ”¯æŒå¤šå±‚çš„é•œåƒæ–‡ä»¶")]),s._v(".")]),s._v(" "),t("p",[s._v("åœ¨å®¹å™¨å¯åŠ¨å, å¯¹é•œåƒæ–‡ä»¶ä¸­ä¿®æ”¹å°±ä¼šè¢«ä¿å­˜åœ¨ upperdir é‡Œäº†.")]),s._v(" "),t("p",[t("img",{attrs:{src:"/img/b34f54d0d99473e1e235635bbce832bd-20230731161430-udfrexx.png",alt:""}})]),s._v(" "),t("h5",{attrs:{id:"_3-è§£å†³é—®é¢˜-5"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-è§£å†³é—®é¢˜-5"}},[s._v("#")]),s._v(" 3.è§£å†³é—®é¢˜")]),s._v(" "),t("p",[s._v("åœ¨ç†è§£äº†å®¹å™¨ä½¿ç”¨çš„ OverlayFS æ–‡ä»¶ç³»ç»Ÿå, å†å›åˆ°å¼€å§‹çš„é—®é¢˜, ä¸ºä»€ä¹ˆ"),t("strong",[s._v("åœ¨å®¿ä¸»æœºå‡çº§ä¹‹å, åœ¨å®¹å™¨é‡Œè¯»å†™æ–‡ä»¶çš„æ€§èƒ½é™ä½")]),s._v("äº†? ç°åœ¨è‡³å°‘åº”è¯¥çŸ¥é“, åœ¨å®¹å™¨ä¸­è¯»å†™æ–‡ä»¶æ€§èƒ½é™ä½äº†, é‚£ä¹ˆåº”è¯¥æ˜¯ OverlayFS çš„æ€§èƒ½åœ¨æ–°çš„ ubuntu20.04 ä¸­é™ä½äº†.")]),s._v(" "),t("p",[s._v("è¦æ‰¾åˆ°é—®é¢˜çš„æ ¹å› , è¿˜éœ€è¦è¿›ä¸€æ­¥çš„ debug. å¯¹äºæ€§èƒ½é—®é¢˜, éœ€è¦ä½¿ç”¨ Linux ä¸‹çš„ "),t("strong",[s._v("perf å·¥å…·")]),s._v("æ¥æŸ¥çœ‹ä¸€ä¸‹, å…·ä½“æ€ä¹ˆä½¿ç”¨ perf æ¥è§£å†³é—®é¢˜, ä¼šåœ¨åé¢è®²è§£.")]),s._v(" "),t("p",[s._v("è¿™é‡Œåªè¦çœ‹ä¸€ä¸‹ç»“æœå°±å¯ä»¥äº†, "),t("strong",[s._v("è‡ªä¸‹è€Œä¸Šæ˜¯å‡½æ•°çš„ä¸€ä¸ªè°ƒç”¨é¡ºåº")]),s._v(". é€šè¿‡ perf å·¥å…·, å¯ä»¥æ¯”è¾ƒåœ¨å®¹å™¨ä¸­"),t("strong",[s._v("è¿è¡Œ fio çš„æ—¶å€™")]),s._v(", ubuntu 18.04 å’Œ ubuntu 20.04 åœ¨å†…æ ¸å‡½æ•°è°ƒç”¨ä¸Šçš„ä¸åŒ.")]),s._v(" "),t("p",[t("img",{attrs:{src:"/img/ea7f0caf11a52b8f0d7a294cd648663c-20230731161430-sdg5pr7.png",alt:"",title:"ubuntu 18.04 (Linux å†…æ ¸ 4.15)ç¯å¢ƒä¸‹ä½¿ç”¨ perf è¾“å‡ºçš„å‡½æ•°è°ƒç”¨ç»“æœ"}})]),s._v(" "),t("p",[t("img",{attrs:{src:"/img/223b74e96ac63f3c23c1a6f128b1a0f4-20230731161430-m98pcqy.png",alt:"",title:"ubuntu 20.04 (Linux å†…æ ¸ 5.4)ç¯å¢ƒä¸‹ä½¿ç”¨ perf è¾“å‡ºçš„å‡½æ•°è°ƒç”¨ç»“æœ"}})]),s._v(" "),t("p",[s._v("ä»ç³»ç»Ÿè°ƒç”¨æ¡†æ¶ä¹‹åçš„å‡½æ•° aio_read() å¼€å§‹æ¯”è¾ƒ: Linux å†…æ ¸ 4.15 é‡Œ aio_read() ä¹‹åè°ƒç”¨çš„æ˜¯ xfs_file_read_iter(), è€Œåœ¨ Linux å†…æ ¸ 5.4 é‡Œ, aio_read() ä¹‹åè°ƒç”¨çš„æ˜¯ "),t("strong",[s._v("ovl_read_iter")]),s._v("() è¿™ä¸ªå‡½æ•°, ä¹‹åå†è°ƒç”¨ xfs_file_read_iter().")]),s._v(" "),t("p",[s._v("è¿™æ ·å°±å¯ä»¥å»æŸ¥çœ‹ä¸€ä¸‹, åœ¨å†…æ ¸ 4.15 ä¹‹åæ–°åŠ å…¥çš„è¿™ä¸ªå‡½æ•° ovl_read_iter() çš„ä»£ç . æŸ¥çœ‹ä»£ç åå°±èƒ½æ˜ç™½, Linux ä¸ºäº†å®Œå–„ OverlayFS, "),t("strong",[s._v("å¢åŠ äº† OverlayFS è‡ªå·±çš„ read/write å‡½æ•°æ¥å£, ä»è€Œä¸å†ç›´æ¥è°ƒç”¨ OverlayFS åç«¯æ–‡ä»¶ç³»ç»Ÿ(æ¯”å¦‚ XFS, Ext4)çš„è¯»å†™æ¥å£. ä½†æ˜¯å®ƒåªå®ç°äº†åŒæ­¥ I/O(sync I/O), å¹¶æ²¡æœ‰å®ç°å¼‚æ­¥ I/O")]),s._v(". è€Œåœ¨ fio åšæ–‡ä»¶ç³»ç»Ÿæ€§èƒ½æµ‹è¯•çš„æ—¶å€™ä½¿ç”¨çš„æ˜¯"),t("strong",[s._v("å¼‚æ­¥ I/O")]),s._v(", è¿™æ ·æ‰å¯ä»¥å¾—åˆ°æ–‡ä»¶ç³»ç»Ÿçš„æ€§èƒ½æœ€å¤§å€¼. æ‰€ä»¥åœ¨å†…æ ¸ 5.4 ä¸Šå°±æ— æ³•å¯¹ OverlayFS æµ‹å‡ºæœ€é«˜çš„æ€§èƒ½æŒ‡æ ‡äº†.")]),s._v(" "),t("p",[s._v("åœ¨ Linux å†…æ ¸ 5.6 ç‰ˆæœ¬ä¸­, è¿™ä¸ªé—®é¢˜å·²ç»é€šè¿‡ä¸‹é¢çš„è¿™ä¸ªè¡¥ä¸ç»™è§£å†³äº†, æœ‰å…´è¶£çš„åŒå­¦å¯ä»¥çœ‹ä¸€ä¸‹.")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("commit 2406a307ac7ddfd7effeeaff6947149ec6a95b4e\nAuthor: Jiufei Xue "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("jiufei.xue@linux.alibaba.com"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\nDate:   Wed Nov "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("20")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("17")]),s._v(":45:26 "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2019")]),s._v(" +0800\n \n    ovl: implement async IO routines\n \n    A performance regression was observed since linux v4.19 with aio "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("test")]),s._v(" using\n    fio with iodepth "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("128")]),s._v(" on overlayfs.  The queue depth of the device was\n    always "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("which")]),s._v(" is unexpected.\n \n    After investigation, it was found that commit 16914e6fc7e1 "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"ovl: add\n    ovl_read_iter()"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" and commit 2a92e07edc5e "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"ovl: add ovl_write_iter()"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    resulted "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v(" vfs_iter_"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("read,write"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" being called on underlying filesystem,\n    "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("which")]),s._v(" always results "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v(" syncronous IO.\n \n    Implement async IO "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" stacked reading and writing.  This resolves the\n    performance regresion.\n \n    This is implemented by allocating a new kiocb "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" submitting the AIO\n    request on the underlying filesystem.  When the request is completed, the\n    new kiocb is freed and the completion callback is called on the original\n    iocb.\n \n    Signed-off-by: Jiufei Xue "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("jiufei.xue@linux.alibaba.com"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\n    Signed-off-by: Miklos Szeredi "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("mszeredi@redhat.com"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br"),t("span",{staticClass:"line-number"},[s._v("25")]),t("br")])]),t("h5",{attrs:{id:"_4-é‡ç‚¹æ€»ç»“-7"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_4-é‡ç‚¹æ€»ç»“-7"}},[s._v("#")]),s._v(" 4.é‡ç‚¹æ€»ç»“")]),s._v(" "),t("p",[s._v("è¿™ä¸€è®²æœ€ä¸»è¦çš„å†…å®¹æ˜¯ç†è§£å®¹å™¨æ–‡ä»¶ç³»ç»Ÿ. "),t("strong",[s._v("ä¸ºä»€ä¹ˆè¦æœ‰å®¹å™¨è‡ªå·±çš„æ–‡ä»¶ç³»ç»Ÿ? å¾ˆé‡è¦çš„ä¸€ç‚¹æ˜¯å‡å°‘ç›¸åŒé•œåƒæ–‡ä»¶åœ¨åŒä¸€ä¸ªèŠ‚ç‚¹ä¸Šçš„æ•°æ®å†—ä½™, å¯ä»¥èŠ‚çœç£ç›˜ç©ºé—´, ä¹Ÿå¯ä»¥å‡å°‘é•œåƒæ–‡ä»¶ä¸‹è½½å ç”¨çš„ç½‘ç»œèµ„æº")]),s._v(".")]),s._v(" "),t("p",[s._v("ä½œä¸ºå®¹å™¨æ–‡ä»¶ç³»ç»Ÿ, UnionFS é€šè¿‡å¤šä¸ªç›®å½•æŒ‚è½½çš„æ–¹å¼å·¥ä½œ. OverlayFS å°±æ˜¯ UnionFS çš„ä¸€ç§å®ç°, æ˜¯ç›®å‰ä¸»æµ Linux å‘è¡Œç‰ˆæœ¬ä¸­ç¼ºçœä½¿ç”¨çš„å®¹å™¨æ–‡ä»¶ç³»ç»Ÿ. OverlayFS ä¹Ÿæ˜¯æŠŠå¤šä¸ªç›®å½•åˆå¹¶æŒ‚è½½, è¢«æŒ‚è½½çš„ç›®å½•åˆ†ä¸ºä¸¤å¤§ç±»: "),t("strong",[s._v("lowerdir")]),s._v(" å’Œ "),t("strong",[s._v("upperdir")]),s._v(". l"),t("strong",[s._v("owerdir å…è®¸æœ‰å¤šä¸ªç›®å½•, åœ¨è¢«æŒ‚è½½å, è¿™äº›ç›®å½•é‡Œçš„æ–‡ä»¶éƒ½æ˜¯ä¸ä¼šè¢«ä¿®æ”¹æˆ–è€…åˆ é™¤çš„, ä¹Ÿå°±æ˜¯åªè¯»çš„; upperdir åªæœ‰ä¸€ä¸ª, ä¸è¿‡è¿™ä¸ªç›®å½•æ˜¯å¯è¯»å†™çš„, æŒ‚è½½ç‚¹ç›®å½•ä¸­çš„æ‰€æœ‰æ–‡ä»¶ä¿®æ”¹éƒ½ä¼šåœ¨ upperdir ä¸­åæ˜ å‡ºæ¥")]),s._v(".")]),s._v(" "),t("p",[s._v("å®¹å™¨çš„é•œåƒæ–‡ä»¶ä¸­å„å±‚æ­£å¥½ä½œä¸º OverlayFS çš„ lowerdir çš„ç›®å½•, ç„¶ååŠ ä¸Šä¸€ä¸ªç©ºçš„ upperdir ä¸€èµ·æŒ‚è½½å¥½å, å°±ç»„æˆäº†å®¹å™¨çš„æ–‡ä»¶ç³»ç»Ÿ.")]),s._v(" "),t("p",[s._v("OverlayFS åœ¨ Linux å†…æ ¸ä¸­è¿˜åœ¨ä¸æ–­çš„å®Œå–„, æ¯”å¦‚åœ¨è¿™ä¸€è®²çœ‹åˆ°çš„åœ¨ kenel 5.4 ä¸­å¯¹å¼‚æ­¥ I/O æ“ä½œçš„ç¼ºå¤±, è¿™ä¹Ÿæ˜¯åœ¨ä½¿ç”¨å®¹å™¨æ–‡ä»¶ç³»ç»Ÿçš„æ—¶å€™éœ€è¦æ³¨æ„çš„.")]),s._v(" "),t("h4",{attrs:{id:"_12-å®¹å™¨æ–‡ä»¶quota-å®¹å™¨ä¸ºä»€ä¹ˆæŠŠå®¿ä¸»æœºçš„ç£ç›˜å†™æ»¡äº†"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_12-å®¹å™¨æ–‡ä»¶quota-å®¹å™¨ä¸ºä»€ä¹ˆæŠŠå®¿ä¸»æœºçš„ç£ç›˜å†™æ»¡äº†"}},[s._v("#")]),s._v(" 12 | å®¹å™¨æ–‡ä»¶Quota:å®¹å™¨ä¸ºä»€ä¹ˆæŠŠå®¿ä¸»æœºçš„ç£ç›˜å†™æ»¡äº†?")]),s._v(" "),t("p",[s._v("æœ¬èŠ‚èŠä¸€èŠå®¹å™¨æ–‡ä»¶ Quota.")]),s._v(" "),t("p",[s._v("ä¸Šä¸€è®²å­¦ä¹ äº†å®¹å™¨æ–‡ä»¶ç³»ç»Ÿ OverlayFS, è¿™ä¸ª OverlayFS æœ‰ä¸¤å±‚, åˆ†åˆ«æ˜¯ lowerdir å’Œ upperdir. "),t("mark",[t("strong",[s._v("lowerdir é‡Œæ˜¯å®¹å™¨é•œåƒä¸­çš„æ–‡ä»¶, å¯¹äºå®¹å™¨æ¥è¯´æ˜¯åªè¯»çš„; upperdir å­˜æ”¾çš„æ˜¯å®¹å™¨å¯¹æ–‡ä»¶ç³»ç»Ÿé‡Œçš„æ‰€æœ‰æ”¹åŠ¨, å®ƒæ˜¯å¯è¯»å†™çš„")])]),s._v(". ä»å®¿ä¸»æœºçš„è§’åº¦çœ‹, upperdir å°±æ˜¯ä¸€ä¸ª"),t("strong",[s._v("ç›®å½•")]),s._v(", å¦‚æœå®¹å™¨ä¸æ–­å¾€å®¹å™¨æ–‡ä»¶ç³»ç»Ÿä¸­å†™å…¥æ•°æ®, "),t("strong",[s._v("å®é™…ä¸Šå°±æ˜¯å¾€å®¿ä¸»æœºçš„ç£ç›˜ä¸Šå†™æ•°æ®, è¿™äº›æ•°æ®ä¹Ÿå°±å­˜åœ¨äºå®¿ä¸»æœºçš„ç£ç›˜ç›®å½•ä¸­")]),s._v(". å½“ç„¶å¯¹äºå®¹å™¨æ¥è¯´, å¦‚æœæœ‰å¤§é‡çš„å†™æ“ä½œæ˜¯ä¸å»ºè®®å†™å…¥å®¹å™¨æ–‡ä»¶ç³»ç»Ÿçš„, "),t("strong",[s._v("ä¸€èˆ¬æ˜¯éœ€è¦ç»™å®¹å™¨æŒ‚è½½ä¸€ä¸ª volume, ç”¨æ¥æ»¡è¶³å¤§é‡çš„æ–‡ä»¶è¯»å†™")]),s._v(".")]),s._v(" "),t("p",[s._v("ä½†æ˜¯ä¸èƒ½é¿å…çš„æ˜¯, ç”¨æˆ·åœ¨å®¹å™¨ä¸­è¿è¡Œçš„ç¨‹åºæœ‰é”™è¯¯, æˆ–è€…è¿›è¡Œäº†é”™è¯¯çš„é…ç½®. æ¯”å¦‚æŠŠ log å†™åœ¨äº†å®¹å™¨æ–‡ä»¶ç³»ç»Ÿä¸Š, å¹¶ä¸”æ²¡æœ‰åš log rotation, é‚£ä¹ˆæ—¶é—´ä¸€ä¹…, å°±ä¼šå¯¼è‡´å®¿ä¸»æœºä¸Šçš„ç£ç›˜è¢«å†™æ»¡. è¿™æ ·å½±å“çš„å°±ä¸æ­¢æ˜¯å®¹å™¨æœ¬èº«äº†, è€Œæ˜¯"),t("strong",[s._v("æ•´ä¸ªå®¿ä¸»æœº")]),s._v("äº†.")]),s._v(" "),t("p",[s._v("é‚£å¯¹äºè¿™æ ·çš„é—®é¢˜è¯¥æ€ä¹ˆè§£å†³å‘¢?")]),s._v(" "),t("h5",{attrs:{id:"_1-é—®é¢˜å†ç°-8"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-é—®é¢˜å†ç°-8"}},[s._v("#")]),s._v(" 1.é—®é¢˜å†ç°")]),s._v(" "),t("p",[s._v("å¯ä»¥è‡ªå·±å…ˆå¯åŠ¨ä¸€ä¸ªå®¹å™¨, ä¸€èµ·è¯•è¯•"),t("strong",[s._v("ä¸æ–­åœ°å¾€å®¹å™¨æ–‡ä»¶ç³»ç»Ÿä¸­å†™å…¥æ•°æ®")]),s._v(", çœ‹çœ‹æ˜¯ä¸€ä¸ªä»€ä¹ˆæ ·çš„æƒ…å†µ. ç”¨ Docker å¯åŠ¨ä¸€ä¸ªå®¹å™¨å, å¯ä»¥çœ‹åˆ°"),t("strong",[s._v("å®¹å™¨çš„æ ¹ç›®å½• (/) ä¹Ÿå°±æ˜¯å®¹å™¨æ–‡ä»¶ç³»ç»Ÿ OverlayFS")]),s._v(", å®ƒçš„å¤§å°æ˜¯ 160G, å·²ç»ä½¿ç”¨äº† 100G. å…¶å®è¿™ä¸ªå¤§å°ä¹Ÿæ˜¯å®¿ä¸»æœºä¸Šçš„ç£ç›˜ç©ºé—´å’Œä½¿ç”¨æƒ…å†µ.")]),s._v(" "),t("p",[t("img",{attrs:{src:"/img/c36825d1aae0c7e12b1eb100ce7f094c-20230731161430-0qr9iyf.png",alt:""}})]),s._v(" "),t("p",[s._v("è¿™æ—¶å€™, å¯ä»¥å›åˆ°"),t("strong",[s._v("å®¿ä¸»æœº")]),s._v("ä¸ŠéªŒè¯ä¸€ä¸‹, å°±ä¼šå‘ç°å®¿ä¸»æœºçš„æ ¹ç›®å½• (/) çš„å¤§å°ä¹Ÿæ˜¯ 160G, åŒæ ·æ˜¯ä½¿ç”¨äº† 100G.")]),s._v(" "),t("p",[t("img",{attrs:{src:"/img/a6a4a5c0798f91344ef826318bd6f9da-20230731161430-g6ss2ai.png",alt:""}})]),s._v(" "),t("p",[s._v("å¥½, é‚£ç°åœ¨å†å¾€å®¹å™¨çš„æ ¹ç›®å½•é‡Œå†™å…¥ 10GB çš„æ•°æ®. è¿™é‡Œå¯ä»¥çœ‹åˆ°å®¹å™¨çš„æ ¹ç›®å½•ä½¿ç”¨çš„å¤§å°å¢åŠ äº†, ä»åˆšæ‰çš„ 100G å˜æˆç°åœ¨çš„ 110G. è€Œå¤šå†™å…¥çš„ 10G å¤§å°çš„æ•°æ®, å¯¹åº”çš„æ˜¯ "),t("strong",[s._v("test.log")]),s._v(" è¿™ä¸ªæ–‡ä»¶.")]),s._v(" "),t("p",[t("img",{attrs:{src:"/img/74e171ca360426c75d9c0b4015161638-20230731161430-0aqth21.png",alt:""}})]),s._v(" "),t("p",[s._v("æ¥ä¸‹æ¥å†å›åˆ°å®¿ä¸»æœºä¸Š, å¯ä»¥çœ‹åˆ°å®¿ä¸»æœºä¸Šçš„æ ¹ç›®å½• (/) é‡Œä½¿ç”¨çš„å¤§å°ä¹Ÿæ˜¯ 110G äº†.")]),s._v(" "),t("p",[t("img",{attrs:{src:"/img/530804c975c857204835090517d06374-20230731161430-lahk9c3.png",alt:""}})]),s._v(" "),t("p",[s._v("è¿˜æ˜¯ç»§ç»­çœ‹å®¿ä¸»æœº, çœ‹çœ‹ OverlayFS é‡Œ "),t("strong",[s._v("upperdir ç›®å½•")]),s._v("ä¸­æœ‰ä»€ä¹ˆæ–‡ä»¶?")]),s._v(" "),t("p",[s._v("è¿™é‡Œä»ç„¶å¯ä»¥é€šè¿‡ /proc/mounts è¿™ä¸ªè·¯å¾„, æ‰¾åˆ°å®¹å™¨ "),t("strong",[s._v("OverlayFS å¯¹åº”çš„ lowerdir å’Œ upperdir")]),s._v(". å› ä¸ºå†™å…¥çš„æ•°æ®éƒ½åœ¨ upperdir é‡Œ, å°±åªè¦çœ‹ upperdir å¯¹åº”çš„é‚£ä¸ªç›®å½•å°±è¡Œäº†. æœç„¶é‡Œé¢å­˜æ”¾ç€å®¹å™¨å†™å…¥çš„æ–‡ä»¶ test.log, å®ƒçš„å¤§å°æ˜¯ 10GB.")]),s._v(" "),t("p",[t("img",{attrs:{src:"/img/136d90bc2fb6771e11966b29b9d52892-20230731161430-h138nc7.png",alt:""}})]),s._v(" "),t("p",[s._v("é€šè¿‡è¿™ä¸ªä¾‹å­, å·²ç»éªŒè¯äº†åœ¨å®¹å™¨ä¸­å¯¹äº OverlayFS ä¸­å†™å…¥æ•°æ®, **å…¶å®å°±æ˜¯å¾€å®¿ä¸»æœºçš„ä¸€ä¸ªç›®å½•(upperdir)é‡Œå†™æ•°æ®. ** ç°åœ¨å·²ç»å†™äº† 10GB çš„æ•°æ®, å¦‚æœç»§ç»­åœ¨å®¹å™¨ä¸­å†™å…¥æ•°æ®, ç»“æœä¼°è®¡ä½ ä¹ŸçŸ¥é“äº†, å°±æ˜¯ä¼šå†™æ»¡å®¿ä¸»æœºçš„ç£ç›˜.")]),s._v(" "),t("p",[s._v("é‚£é‡åˆ°è¿™ç§æƒ…å†µè¯¥æ€ä¹ˆåŠå‘¢?")]),s._v(" "),t("h5",{attrs:{id:"_2-çŸ¥è¯†è¯¦è§£-4"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-çŸ¥è¯†è¯¦è§£-4"}},[s._v("#")]),s._v(" 2.çŸ¥è¯†è¯¦è§£")]),s._v(" "),t("p",[s._v("å®¹å™¨å†™è‡ªå·±çš„ OverlayFS æ ¹ç›®å½•, ç»“æœæŠŠå®¿ä¸»æœºçš„ç£ç›˜å†™æ»¡äº†. å‘ç”Ÿè¿™ä¸ªé—®é¢˜, é¦–å…ˆå°±ä¼šæƒ³åˆ°"),t("strong",[s._v("éœ€è¦å¯¹å®¹å™¨åšé™åˆ¶")]),s._v(", é™åˆ¶å®ƒå†™å…¥è‡ªå·± OverlayFS çš„æ•°æ®é‡, æ¯”å¦‚åªå…è®¸ä¸€ä¸ªå®¹å™¨å†™ 100MB çš„æ•°æ®. ä¸è¿‡å®é™…æŸ¥çœ‹ OverlayFS æ–‡ä»¶ç³»ç»Ÿçš„ç‰¹æ€§, å°±ä¼šå‘ç°æ²¡æœ‰ç›´æ¥é™åˆ¶æ–‡ä»¶å†™å…¥é‡çš„ç‰¹æ€§. åˆ«æ‹…å¿ƒ, åœ¨æ²¡æœ‰ç°æˆå·¥å…·çš„æƒ…å†µä¸‹, åªè¦ææ‡‚äº†åŸç†, å°±èƒ½æƒ³å‡ºè§£å†³åŠæ³•.")]),s._v(" "),t("p",[s._v("æ‰€ä»¥å†æ¥åˆ†æä¸€ä¸‹ OverlayFS, å®ƒæ˜¯"),t("strong",[s._v("é€šè¿‡ lowerdir å’Œ upperdir ä¸¤å±‚ç›®å½•è”åˆæŒ‚è½½æ¥å®ç°çš„, lowerdir æ˜¯åªè¯»çš„, æ•°æ®åªä¼šå†™åœ¨ upperdir ä¸­")]),s._v(". é‚£æ˜¯ä¸æ˜¯å¯ä»¥é€šè¿‡"),t("strong",[s._v("é™åˆ¶ upperdir ç›®å½•å®¹é‡")]),s._v("çš„æ–¹å¼, æ¥é™åˆ¶ä¸€ä¸ªå®¹å™¨ OverlayFS æ ¹ç›®å½•çš„å†™å…¥æ•°æ®é‡å‘¢?")]),s._v(" "),t("p",[s._v("æ²¿ç€è¿™ä¸ªæ€è·¯ç»§ç»­å¾€ä¸‹æƒ³, å› ä¸º upperdir åœ¨å®¿ä¸»æœºä¸Šä¹Ÿæ˜¯ä¸€ä¸ª"),t("strong",[s._v("æ™®é€šçš„ç›®å½•")]),s._v(", è¿™æ ·å°±è¦çœ‹**å®¿ä¸»æœºä¸Šçš„æ–‡ä»¶ç³»ç»Ÿæ˜¯å¦å¯ä»¥æ”¯æŒå¯¹ä¸€ä¸ªç›®å½•é™åˆ¶å®¹é‡äº†. **")]),s._v(" "),t("p",[s._v("å¯¹äº Linux ä¸Šæœ€å¸¸ç”¨çš„ä¸¤ä¸ªæ–‡ä»¶ç³»ç»Ÿ XFS å’Œ ext4, å®ƒä»¬æœ‰ä¸€ä¸ªç‰¹æ€§ "),t("strong",[s._v("Quota")]),s._v(", é‚£å°±ä»¥ XFS æ–‡ä»¶ç³»ç»Ÿä¸ºä¾‹, å­¦ä¹ ä¸€ä¸‹è¿™ä¸ª Quota æ¦‚å¿µ, ç„¶åçœ‹çœ‹è¿™ä¸ªç‰¹æ€§èƒ½ä¸èƒ½é™åˆ¶ä¸€ä¸ªç›®å½•çš„ä½¿ç”¨é‡.")]),s._v(" "),t("h6",{attrs:{id:"_1-xfs-quota"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-xfs-quota"}},[s._v("#")]),s._v(" (1)XFS Quota")]),s._v(" "),t("p",[s._v("åœ¨ Linux ç³»ç»Ÿé‡Œçš„ XFS æ–‡ä»¶ç³»ç»Ÿç¼ºçœéƒ½æœ‰ "),t("strong",[s._v("Quota çš„ç‰¹æ€§, è¿™ä¸ªç‰¹æ€§å¯ä»¥ä¸º Linux ç³»ç»Ÿé‡Œçš„ä¸€ä¸ªç”¨æˆ·(user), ä¸€ä¸ªç”¨æˆ·ç»„(group)æˆ–è€…ä¸€ä¸ªé¡¹ç›®(project)æ¥é™åˆ¶å®ƒä»¬ä½¿ç”¨æ–‡ä»¶ç³»ç»Ÿçš„é¢åº¦(quota), ä¹Ÿå°±æ˜¯é™åˆ¶å®ƒä»¬å¯ä»¥å†™å…¥æ–‡ä»¶ç³»ç»Ÿçš„æ–‡ä»¶æ€»é‡")]),s._v(".")]),s._v(" "),t("p",[s._v("å› ä¸ºç›®æ ‡æ˜¯è¦é™åˆ¶ä¸€ä¸ªç›®å½•ä¸­æ€»ä½“çš„å†™å…¥æ–‡ä»¶æ•°æ®é‡, é‚£ä¹ˆæ˜¾ç„¶ç»™ç”¨æˆ·å’Œç”¨æˆ·ç»„é™åˆ¶æ–‡ä»¶ç³»ç»Ÿçš„å†™å…¥æ•°æ®é‡çš„æ¨¡å¼, å¹¶ä¸é€‚åˆè¿™ä¸ªéœ€æ±‚. å› ä¸ºåŒä¸€ä¸ªç”¨æˆ·æˆ–è€…ç”¨æˆ·ç»„å¯ä»¥æ“ä½œå¤šä¸ªç›®å½•, å¤šä¸ªç”¨æˆ·æˆ–è€…ç”¨æˆ·ç»„ä¹Ÿå¯ä»¥æ“ä½œåŒä¸€ä¸ªç›®å½•, è¿™æ ·å¯¹ä¸€ä¸ªç”¨æˆ·æˆ–è€…ç”¨æˆ·ç»„çš„é™åˆ¶, å°±å¾ˆéš¾ç”¨æ¥é™åˆ¶ä¸€ä¸ªç›®å½•.")]),s._v(" "),t("p",[s._v("é‚£æ’é™¤äº†é™åˆ¶ç”¨æˆ·æˆ–ç”¨æˆ·ç»„çš„æ¨¡å¼, å†æ¥çœ‹çœ‹ "),t("strong",[s._v("Project")]),s._v(" æ¨¡å¼. Project æ¨¡å¼æ˜¯æ€ä¹ˆå·¥ä½œçš„å‘¢? ä¸¾ä¸€ä¸ªä¾‹å­, å¯¹ Linux ç†Ÿæ‚‰çš„åŒå­¦å¯ä»¥ä¸€è¾¹æ“ä½œ, ä¸€è¾¹ä½“ä¼šä¸€ä¸‹å®ƒçš„å·¥ä½œæ–¹å¼. ä¸ç†Ÿæ‚‰çš„åŒå­¦ä¹Ÿæ²¡å…³ç³», å¯ä»¥é‡ç‚¹å…³æ³¨åé¢çš„è®²è§£æ€è·¯.")]),s._v(" "),t("p",[s._v('é¦–å…ˆè¦ä½¿ç”¨ XFS Quota ç‰¹æ€§, å¿…é¡»åœ¨æ–‡ä»¶ç³»ç»ŸæŒ‚è½½çš„æ—¶å€™åŠ ä¸Šå¯¹åº”çš„ Quota é€‰é¡¹, æ¯”å¦‚ç›®å‰éœ€è¦é…ç½® Project Quota, é‚£ä¹ˆè¿™ä¸ªæŒ‚è½½å‚æ•°å°±æ˜¯ "pquota". å¯¹äºæ ¹ç›®å½•æ¥è¯´, **è¿™ä¸ªå‚æ•°å¿…é¡»ä½œä¸ºä¸€ä¸ªå†…æ ¸å¯åŠ¨çš„å‚æ•° "rootflags=pquota", è¿™æ ·è®¾ç½®å°±å¯ä»¥ä¿è¯æ ¹ç›®å½•åœ¨å¯åŠ¨æŒ‚è½½çš„æ—¶å€™, å¸¦ä¸Š XFS Quota çš„ç‰¹æ€§å¹¶ä¸”æ”¯æŒ Project æ¨¡å¼. **')]),s._v(" "),t("p",[s._v('å¯ä»¥ä» /proc/mounts ä¿¡æ¯é‡Œ, çœ‹çœ‹æ ¹ç›®å½•æ˜¯ä¸æ˜¯å¸¦ "prjquota" å­—æ®µ. å¦‚æœé‡Œé¢æœ‰è¿™ä¸ªå­—æ®µ, å°±å¯ä»¥ç¡®ä¿æ–‡ä»¶ç³»ç»Ÿå·²ç»å¸¦ä¸Šäº†æ”¯æŒ project æ¨¡å¼çš„ XFS quota ç‰¹æ€§.')]),s._v(" "),t("p",[t("img",{attrs:{src:"/img/e837543f64590c99417091854b0cc546-20230731161430-bi4tklb.png",alt:""}})]),s._v(" "),t("p",[s._v("ä¸‹ä¸€æ­¥, è¿˜éœ€è¦ç»™ä¸€ä¸ª"),t("strong",[s._v("æŒ‡å®šçš„ç›®å½•æ‰“ä¸Šä¸€ä¸ª Project ID")]),s._v(". è¿™ä¸ªæ­¥éª¤å¯ä»¥ä½¿ç”¨ XFS æ–‡ä»¶ç³»ç»Ÿè‡ªå¸¦çš„å·¥å…· xfs_quota æ¥å®Œæˆ, ç„¶åæ‰§è¡Œä¸‹é¢çš„è¿™ä¸ªå‘½ä»¤å°±å¯ä»¥äº†. æ‰§è¡Œå‘½ä»¤ä¹‹å‰, å…ˆå¯¹ä¸‹é¢çš„å‘½ä»¤å’Œè¾“å‡ºåšä¸¤ç‚¹è§£é‡Š, ä»¥ç†è§£è¿™ä¸ªå‘½ä»¤çš„å«ä¹‰.")]),s._v(" "),t("p",[s._v("ç¬¬ä¸€ç‚¹, æ–°å»ºçš„ç›®å½• /tmp/xfs_prjquota, æˆ‘ä»¬æƒ³å¯¹å®ƒåš Quota é™åˆ¶. æ‰€ä»¥åœ¨è¿™é‡Œè¦å¯¹å®ƒæ‰“ä¸Šä¸€ä¸ª Project ID.")]),s._v(" "),t("p",[s._v("ç¬¬äºŒç‚¹, é€šè¿‡ xfs_quota è¿™æ¡å‘½ä»¤, ç»™ /tmp/xfs_prjquota æ‰“ä¸Š Project ID å€¼ 101, è¿™ä¸ª 101 æ˜¯éšä¾¿é€‰çš„ä¸€ä¸ªæ•°å­—, å°±æ˜¯ä¸ª ID æ ‡è¯†, å…ˆæœ‰ä¸ªå°è±¡. åœ¨åé¢é’ˆå¯¹ Project è¿›è¡Œ Quota é™åˆ¶çš„æ—¶å€™, è¿˜ä¼šç”¨åˆ°è¿™ä¸ª ID.")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# mkdir -p  /tmp/xfs_prjquota")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# xfs_quota -x -c 'project -s -p /tmp/xfs_prjquota 101' /")]),s._v("\nSetting up project "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("101")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("path /tmp/xfs_prjquota"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\nProcessed "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("/etc/projects and cmdline"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" paths "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" project "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("101")]),s._v(" with recursion depth infinite "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("-1"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(".\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br")])]),t("p",[s._v("æœ€å, è¿˜æ˜¯ä½¿ç”¨ xfs_quota å‘½ä»¤, å¯¹ 101(åˆšæ‰å»ºç«‹çš„è¿™ä¸ª Project ID)åš Quota é™åˆ¶.")]),s._v(" "),t("p",[s._v('å¯ä»¥æ‰§è¡Œä¸‹é¢è¿™æ¡å‘½ä»¤, é‡Œé¢çš„ "-p bhard=10m 101" å°±ä»£è¡¨é™åˆ¶ 101 è¿™ä¸ª project ID, é™åˆ¶å®ƒçš„æ•°æ®å—å†™å…¥é‡ä¸èƒ½è¶…è¿‡ 10MB.')]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# xfs_quota -x -c 'limit -p bhard=10m 101' /")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("åšå¥½é™åˆ¶ä¹‹å, å¯ä»¥å°è¯•å¾€ /tmp/xfs_prjquota å†™æ•°æ®, çœ‹çœ‹æ˜¯å¦å¯ä»¥è¶…è¿‡ 10MB. æ¯”å¦‚å°è¯•å†™å…¥ 20MB çš„æ•°æ®åˆ° /tmp/xfs_prjquota é‡Œ.")]),s._v(" "),t("p",[s._v('å¯ä»¥çœ‹åˆ°, æ‰§è¡Œ dd å†™å…¥å‘½ä»¤, å°±ä¼šæœ‰ä¸ªå‡ºé”™è¿”å›ä¿¡æ¯ "No space left on device". è¿™è¡¨ç¤ºå·²ç»ä¸èƒ½å†å¾€è¿™ä¸ªç›®å½•ä¸‹å†™å…¥æ•°æ®äº†, è€Œæœ€åå†™å…¥æ•°æ®çš„æ–‡ä»¶ test.file å¤§å°ä¹Ÿåœç•™åœ¨äº† 10MB.')]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# dd if=/dev/zero of=/tmp/xfs_prjquota/test.file bs=1024 count=20000")]),s._v("\ndd: error writing "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'/tmp/xfs_prjquota/test.file'")]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" No space left on device\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("10241")]),s._v("+0 records "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("10240")]),s._v("+0 records out\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("10485760")]),s._v(" bytes "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v(" MB, "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v(" MiB"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" copied, "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.0357122")]),s._v(" s, "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("294")]),s._v(" MB/s\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ls -l /tmp/xfs_prjquota/test.file")]),s._v("\n-rw-r--r-- "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" root root "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("10485760")]),s._v(" Oct "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("31")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v(":00 /tmp/xfs_prjquota/test.file\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br")])]),t("p",[s._v("å¥½äº†, åšåˆ°è¿™é‡Œ, å¯ä»¥å‘ç°ä½¿ç”¨ XFS Quota çš„ Project æ¨¡å¼, ç¡®å®å¯ä»¥é™åˆ¶ä¸€ä¸ªç›®å½•é‡Œçš„å†™å…¥æ•°æ®é‡, å®ƒå®ç°çš„æ–¹å¼å…¶å®ä¹Ÿä¸éš¾, å°±æ˜¯ä¸‹é¢è¿™ä¸¤æ­¥.")]),s._v(" "),t("p",[s._v("ç¬¬ä¸€æ­¥, ç»™ç›®æ ‡ç›®å½•æ‰“ä¸Šä¸€ä¸ª Project ID, è¿™ä¸ª ID æœ€ç»ˆæ˜¯å†™åˆ°"),t("strong",[s._v("ç›®å½•å¯¹åº”çš„ inode ä¸Š")]),s._v(". inode æ˜¯æ–‡ä»¶ç³»ç»Ÿä¸­ç”¨æ¥æè¿°ä¸€ä¸ªæ–‡ä»¶æˆ–è€…ä¸€ä¸ªç›®å½•çš„å…ƒæ•°æ®, é‡Œé¢åŒ…å«æ–‡ä»¶å¤§å°, æ•°æ®å—çš„ä½ç½®, æ–‡ä»¶æ‰€å±ç”¨æˆ· / ç»„, æ–‡ä»¶è¯»å†™å±æ€§ä»¥åŠå…¶ä»–ä¸€äº›å±æ€§. é‚£ä¹ˆä¸€æ—¦ç›®å½•æ‰“ä¸Šè¿™ä¸ª ID ä¹‹å, åœ¨è¿™ä¸ªç›®å½•ä¸‹çš„"),t("strong",[s._v("æ–°å»ºçš„æ–‡ä»¶å’Œç›®å½•ä¹Ÿéƒ½ä¼šç»§æ‰¿è¿™ä¸ª ID")]),s._v(".")]),s._v(" "),t("p",[s._v("ç¬¬äºŒæ­¥, åœ¨ XFS æ–‡ä»¶ç³»ç»Ÿä¸­, éœ€è¦ç»™è¿™ä¸ª project ID "),t("strong",[s._v("è®¾ç½®ä¸€ä¸ªå†™å…¥æ•°æ®å—çš„é™åˆ¶")]),s._v(". æœ‰äº† ID å’Œé™åˆ¶å€¼ä¹‹å, æ–‡ä»¶ç³»ç»Ÿå°±å¯ä»¥ç»Ÿè®¡æ‰€æœ‰å¸¦è¿™ä¸ª ID æ–‡ä»¶çš„æ•°æ®å—å¤§å°æ€»å’Œ, å¹¶ä¸”ä¸é™åˆ¶å€¼è¿›è¡Œæ¯”è¾ƒ. ä¸€æ—¦æ‰€æœ‰æ–‡ä»¶å¤§å°çš„æ€»å’Œè¾¾åˆ°é™åˆ¶å€¼, æ–‡ä»¶ç³»ç»Ÿå°±ä¸å†å…è®¸æ›´å¤šçš„æ•°æ®å†™å…¥äº†.")]),s._v(" "),t("p",[s._v("ç”¨ä¸€å¥è¯æ¦‚æ‹¬, XFS Quota å°±æ˜¯é€šè¿‡å‰é¢è¿™ä¸¤æ­¥é™åˆ¶äº†ä¸€ä¸ªç›®å½•é‡Œå†™å…¥çš„æ•°æ®é‡.")]),s._v(" "),t("h5",{attrs:{id:"_3-è§£å†³é—®é¢˜-6"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-è§£å†³é—®é¢˜-6"}},[s._v("#")]),s._v(" 3.è§£å†³é—®é¢˜")]),s._v(" "),t("p",[s._v("ç†è§£äº† XFS Quota å¯¹ç›®å½•é™æµçš„æœºåˆ¶ä¹‹å, å†å›åˆ°æœ€å¼€å§‹çš„é—®é¢˜, å¦‚ä½•ç¡®ä¿å®¹å™¨ä¸ä¼šå†™æ»¡å®¿ä¸»æœºä¸Šçš„ç£ç›˜. æ–¹æ³•å°±æ˜¯"),t("mark",[t("strong",[s._v("å¯¹ OverlayFS çš„ upperdir ç›®å½•åš XFS Quota çš„é™æµ")])]),s._v(", å°±æ˜¯è¿™ä¸ªè§£å†³åŠæ³•!")]),s._v(" "),t("p",[s._v("å…¶å® Docker ä¹Ÿå·²ç»å®ç°äº†é™æµåŠŸèƒ½, ä¹Ÿå°±æ˜¯"),t("strong",[s._v("ç”¨ XFS Quota æ¥é™åˆ¶å®¹å™¨çš„ OverlayFS å¤§å°")]),s._v(". åœ¨ç”¨ "),t("code",[s._v("docker run")]),s._v("â€‹ å¯åŠ¨å®¹å™¨çš„æ—¶å€™, åŠ ä¸Šä¸€ä¸ªå‚æ•° "),t("code",[s._v("--storage-opt size= <SIZE>")]),s._v("â€‹, å°±èƒ½é™åˆ¶ä½å®¹å™¨ OverlayFS æ–‡ä»¶ç³»ç»Ÿå¯å†™å…¥çš„æœ€å¤§æ•°æ®é‡äº†.")]),s._v(" "),t("p",[s._v("è¯•ä¸€ä¸‹, è¿™é‡Œé™åˆ¶çš„ size æ˜¯ 10MB. è¿›å…¥å®¹å™¨ä¹‹å, å…ˆè¿è¡Œ "),t("code",[s._v("df -h")]),s._v("â€‹ å‘½ä»¤, è¿™æ—¶å€™å¯ä»¥çœ‹åˆ°æ ¹ç›®å½• (/)overlayfs æ–‡ä»¶ç³»ç»Ÿçš„å¤§å°å°± 10MB, è€Œä¸æ˜¯ä¹‹å‰çœ‹åˆ°çš„ 160GB çš„å¤§å°äº†. è¿™æ ·å®¹å™¨åœ¨å®ƒçš„æ ¹ç›®å½•ä¸‹, æœ€å¤šåªèƒ½å†™ 10MB æ•°æ®, å°±ä¸ä¼šæŠŠå®¿ä¸»æœºçš„ç£ç›˜ç»™å†™æ»¡äº†.")]),s._v(" "),t("p",[t("img",{attrs:{src:"/img/d6c65e47d669fbd3c05a583384cb7373-20230731161430-oiv046b.png",alt:""}})]),s._v(" "),t("p",[s._v("å®Œæˆäº†ä¸Šé¢è¿™ä¸ªå°è¯•éªŒä¹‹å, å¯ä»¥å†çœ‹ä¸€ä¸‹ Docker çš„ä»£ç , çœ‹çœ‹å®ƒçš„å®ç°æ˜¯ä¸æ˜¯å’Œæˆ‘ä»¬æƒ³çš„ä¸€æ ·. Docker é‡Œ SetQuota() å‡½æ•°å°±æ˜¯ç”¨æ¥å®ç° XFS Quota é™åˆ¶çš„, å¯ä»¥çœ‹åˆ°å®ƒé‡Œé¢æœ€é‡è¦çš„ä¸¤æ­¥, åˆ†åˆ«æ˜¯ "),t("code",[s._v("setProjectID")]),s._v("â€‹ å’Œ "),t("code",[s._v("setProjectQuota")]),s._v("â€‹.")]),s._v(" "),t("p",[s._v("å…¶å®è¿™ä¸¤æ­¥åšçš„å°±æ˜¯åœ¨åŸºæœ¬æ¦‚å¿µä¸­æåˆ°çš„é‚£ä¸¤æ­¥: ç¬¬ä¸€æ­¥, ç»™ç›®æ ‡ç›®å½•æ‰“ä¸Šä¸€ä¸ª Project ID; ç¬¬äºŒæ­¥, ä¸ºè¿™ä¸ª Project ID åœ¨ XFS æ–‡ä»¶ç³»ç»Ÿä¸­, è®¾ç½®ä¸€ä¸ªå†™å…¥æ•°æ®å—çš„é™åˆ¶.")]),s._v(" "),t("div",{staticClass:"language-go line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-go"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// SetQuota - assign a unique project id to directory and set the quota limits")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// for that project id")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("func")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("q "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("Control"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("SetQuota")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("targetPath "),t("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("string")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" quota Quota"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("error")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        q"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("RLock")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n        projectID"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" ok "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":=")]),s._v(" q"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("quotas"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("targetPath"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n        q"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("RUnlock")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),s._v("ok "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n                q"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("Lock")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n                projectID "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" q"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("nextProjectID\n                "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//")]),s._v("\n                "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// assign project id to new container directory")]),s._v("\n                "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//")]),s._v("\n                err "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("setProjectID")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("targetPath"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" projectID"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n                "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" err "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("nil")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n                        q"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("Unlock")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n                        "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" err\n                "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n                q"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("quotas"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("targetPath"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" projectID\n                q"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("nextProjectID"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("++")]),s._v("\n                q"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("Unlock")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n \n        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// set the quota limit for the container's project id")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//")]),s._v("\n        logrus"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("Debugf")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"SetQuota(%s, %d): projectID=%d"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" targetPath"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" quota"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("Size"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" projectID"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("setProjectQuota")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("q"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("backingFsBlockDev"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" projectID"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" quota"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br"),t("span",{staticClass:"line-number"},[s._v("25")]),t("br"),t("span",{staticClass:"line-number"},[s._v("26")]),t("br"),t("span",{staticClass:"line-number"},[s._v("27")]),t("br"),t("span",{staticClass:"line-number"},[s._v("28")]),t("br")])]),t("p",[s._v("é‚£ "),t("code",[s._v("setProjectID")]),s._v(" å’Œ "),t("code",[s._v("setProjectQuota")]),s._v(" æ˜¯å¦‚ä½•å®ç°çš„å‘¢?")]),s._v(" "),t("p",[s._v("å¯ä»¥è¿›å…¥åˆ°è¿™ä¸¤ä¸ªå‡½æ•°é‡Œçœ‹ä¸€ä¸‹, **å®ƒä»¬åˆ†åˆ«è°ƒç”¨äº† ioctl() å’Œ quotactl() è¿™ä¸¤ä¸ªç³»ç»Ÿè°ƒç”¨æ¥ä¿®æ”¹å†…æ ¸ä¸­ XFS çš„æ•°æ®ç»“æ„, ä»è€Œå®Œæˆ project ID çš„è®¾ç½®å’Œ Quota å€¼çš„è®¾ç½®. ** å…·ä½“çš„ç»†èŠ‚ä¸åœ¨è¿™é‡Œå±•å¼€äº†, å¦‚æœä½ æœ‰å…´è¶£å¯ä»¥ç»§ç»­å»æŸ¥çœ‹å†…æ ¸ä¸­å¯¹åº”çš„ä»£ç .")]),s._v(" "),t("p",[s._v("å¥½äº†, Docker é‡Œ XFS Quota æ“ä½œçš„æ­¥éª¤å®Œå…¨å’Œå…ˆå‰è®¾æƒ³çš„ä¸€æ ·, é‚£ä¹ˆè¿˜æœ‰æœ€åä¸€ä¸ªé—®é¢˜è¦è§£å†³, "),t("strong",[s._v("XFS Quota é™åˆ¶çš„ç›®å½•")]),s._v('æ˜¯å“ªä¸€ä¸ª? è¿™ä¸ªå¯ä»¥æ ¹æ® /proc/mounts ä¸­å®¹å™¨çš„ OverlayFS Mount ä¿¡æ¯, å†ç»“åˆ Docker çš„ä»£ç , å°±å¯ä»¥çŸ¥é“é™åˆ¶çš„ç›®å½•æ˜¯ "'),t("code",[s._v("/var/lib/docker/overlay2/<docker_id>")]),s._v('â€‹". é‚£è¿™ä¸ªç›®å½•ä¸‹æœ‰ä»€ä¹ˆå‘¢? '),t("strong",[s._v('æœç„¶ upperdir ç›®å½•ä¸­æœ‰å¯¹åº”çš„ "diff" ç›®å½•, å°±åœ¨é‡Œé¢')]),s._v("!")]),s._v(" "),t("p",[t("img",{attrs:{src:"/img/f61912de258cc687227613627b5f61e5-20230731161430-nv8rvp3.png",alt:""}})]),s._v(" "),t("p",[s._v("è®²åˆ°è¿™é‡Œ, æˆ‘æƒ³ä½ å·²ç»æ¸…æ¥šäº†å¯¹äºä½¿ç”¨ OverlayFS çš„å®¹å™¨, åº”è¯¥å¦‚ä½•å»é˜²æ­¢å®ƒæŠŠå®¿ä¸»æœºçš„ç£ç›˜ç»™å†™æ»¡äº†å§? "),t("mark",[t("strong",[s._v("æ–¹æ³•å°±æ˜¯å¯¹ OverlayFS çš„ upperdir ç›®å½•åš XFS Quota çš„é™æµ")])]),s._v("â€‹ **. **")]),s._v(" "),t("h5",{attrs:{id:"_4-é‡ç‚¹æ€»ç»“-8"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_4-é‡ç‚¹æ€»ç»“-8"}},[s._v("#")]),s._v(" 4.é‡ç‚¹æ€»ç»“")]),s._v(" "),t("p",[s._v("æœ¬èŠ‚é—®é¢˜æ˜¯, å®¹å™¨å†™äº†å¤§é‡æ•°æ®åˆ° OverlayFS æ–‡ä»¶ç³»ç»Ÿçš„æ ¹ç›®å½•, åœ¨è¿™ä¸ªæƒ…å†µä¸‹å°±ä¼šæŠŠå®¿ä¸»æœºçš„ç£ç›˜å†™æ»¡.")]),s._v(" "),t("p",[s._v("ç”±äº OverlayFS è‡ªå·±æ²¡æœ‰ä¸“é—¨çš„ç‰¹æ€§, å¯ä»¥é™åˆ¶æ–‡ä»¶æ•°æ®å†™å…¥é‡. è¿™æ—¶é€šè¿‡å®é™…è¯•éªŒæ‰¾åˆ°äº†è§£å†³æ€è·¯: "),t("strong",[s._v("ä¾é åº•å±‚æ–‡ä»¶ç³»ç»Ÿçš„ Quota ç‰¹æ€§æ¥é™åˆ¶ OverlayFS çš„ upperdir ç›®å½•çš„å¤§å°, è¿™æ ·å°±èƒ½å®ç°é™åˆ¶å®¹å™¨å†™ç£ç›˜çš„ç›®çš„")]),s._v(".")]),s._v(" "),t("p",[s._v("åº•å±‚æ–‡ä»¶ç³»ç»Ÿ XFS Quota çš„ Project æ¨¡å¼, èƒ½å¤Ÿé™åˆ¶ä¸€ä¸ªç›®å½•çš„æ–‡ä»¶å†™å…¥é‡, è¿™ä¸ªåŠŸèƒ½å…·ä½“æ˜¯é€šè¿‡è¿™ä¸¤ä¸ªæ­¥éª¤å®ç°:")]),s._v(" "),t("p",[s._v("**ç¬¬ä¸€æ­¥, ç»™ç›®æ ‡ç›®å½•æ‰“ä¸Šä¸€ä¸ª Project ID. **")]),s._v(" "),t("p",[s._v("**ç¬¬äºŒæ­¥, ç»™è¿™ä¸ª Project ID åœ¨ XFS æ–‡ä»¶ç³»ç»Ÿä¸­è®¾ç½®ä¸€ä¸ªå†™å…¥æ•°æ®å—çš„é™åˆ¶. **")]),s._v(" "),t("p",[t("mark",[s._v("**Docker æ­£æ˜¯ä½¿ç”¨äº†è¿™ä¸ªæ–¹æ³•, ä¹Ÿå°±æ˜¯ç”¨ XFS Quota æ¥é™åˆ¶ OverlayFS çš„ upperdir ç›®å½•, é€šè¿‡è¿™ä¸ªæ–¹å¼æ§åˆ¶å®¹å™¨ OverlayFS çš„æ ¹ç›®å½•å¤§å°. **")])]),s._v(" "),t("p",[s._v("å½“ç†è§£äº†è¿™ä¸ªæ–¹æ³•å, å¯¹äºä¸æ˜¯ç”¨ Docker å¯åŠ¨çš„å®¹å™¨, æ¯”å¦‚ç›´æ¥"),t("strong",[s._v("ç”± containerd å¯åŠ¨èµ·æ¥çš„å®¹å™¨, ä¹Ÿå¯ä»¥è‡ªå·±å®ç° XFS Quota é™åˆ¶ upperdir ç›®å½•")]),s._v(". è¿™æ ·å°±èƒ½æœ‰æ•ˆæ§åˆ¶å®¹å™¨å¯¹ OverlayFS çš„å†™æ•°æ®æ“ä½œ, é¿å…å®¿ä¸»æœºçš„ç£ç›˜è¢«å†™æ»¡.")]),s._v(" "),t("h4",{attrs:{id:"_13-å®¹å™¨ç£ç›˜é™é€Ÿ-æˆ‘çš„å®¹å™¨é‡Œç£ç›˜è¯»å†™ä¸ºä»€ä¹ˆä¸ç¨³å®š"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_13-å®¹å™¨ç£ç›˜é™é€Ÿ-æˆ‘çš„å®¹å™¨é‡Œç£ç›˜è¯»å†™ä¸ºä»€ä¹ˆä¸ç¨³å®š"}},[s._v("#")]),s._v(" 13 | å®¹å™¨ç£ç›˜é™é€Ÿ:æˆ‘çš„å®¹å™¨é‡Œç£ç›˜è¯»å†™ä¸ºä»€ä¹ˆä¸ç¨³å®š?")]),s._v(" "),t("p",[s._v("æœ¬èŠ‚èŠä¸€èŠç£ç›˜è¯»å†™ä¸ç¨³å®šçš„é—®é¢˜.")]),s._v(" "),t("p",[s._v("ä¸Šä¸€è®²è®²äº†å¦‚ä½•é€šè¿‡ XFS Quota æ¥é™åˆ¶å®¹å™¨æ–‡ä»¶ç³»ç»Ÿçš„å¤§å°, è¿™æ˜¯"),t("strong",[s._v("é™æ€å®¹é‡")]),s._v("å¤§å°çš„ä¸€ä¸ªé™åˆ¶.")]),s._v(" "),t("p",[s._v("ä½ ä¹Ÿè®¸ä¼šé©¬ä¸Šæƒ³åˆ°, ç£ç›˜é™¤äº†å®¹é‡çš„åˆ’åˆ†, è¿˜æœ‰ä¸€ä¸ª"),t("strong",[s._v("è¯»å†™æ€§èƒ½")]),s._v("çš„é—®é¢˜. å…·ä½“æ¥è¯´, å°±æ˜¯"),t("strong",[s._v("å¦‚æœå¤šä¸ªå®¹å™¨åŒæ—¶è¯»å†™èŠ‚ç‚¹ä¸Šçš„åŒä¸€å—ç£ç›˜, é‚£ä¹ˆå®ƒä»¬çš„ç£ç›˜è¯»å†™ç›¸äº’ä¹‹é—´å½±å“å—? å¦‚æœå®¹å™¨ä¹‹é—´è¯»å†™ç£ç›˜ç›¸äº’å½±å“, æœ‰ä»€ä¹ˆåŠæ³•è§£å†³å‘¢")]),s._v("?")]),s._v(" "),t("p",[s._v("æ¥ä¸‹æ¥, å°±å¸¦ç€é—®é¢˜ä¸€èµ·å­¦ä¹ ä»Šå¤©çš„å†…å®¹.")]),s._v(" "),t("h5",{attrs:{id:"_1-åœºæ™¯å†ç°-2"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-åœºæ™¯å†ç°-2"}},[s._v("#")]),s._v(" 1.åœºæ™¯å†ç°")]),s._v(" "),t("p",[s._v("å…ˆç”¨è¿™é‡Œçš„ä»£ç , è¿è¡Œä¸€ä¸‹ "),t("code",[s._v("make image")]),s._v("â€‹ æ¥åšä¸€ä¸ªå¸¦ fio çš„å®¹å™¨é•œåƒ, fio åœ¨ä¹‹å‰çš„è¯¾ç¨‹é‡Œæåˆ°è¿‡, å®ƒæ˜¯ç”¨æ¥"),t("strong",[s._v("æµ‹è¯•ç£ç›˜æ–‡ä»¶ç³»ç»Ÿè¯»å†™æ€§èƒ½")]),s._v("çš„å·¥å…·. æœ‰äº†è¿™ä¸ªå¸¦ fio çš„é•œåƒ, å¯ä»¥ç”¨å®ƒå¯åŠ¨ä¸€ä¸ªå®¹å™¨, åœ¨å®¹å™¨ä¸­è¿è¡Œ fio, å°±å¯ä»¥å¾—åˆ°åªæœ‰ä¸€ä¸ªå®¹å™¨è¯»å†™ç£ç›˜æ—¶çš„æ€§èƒ½æ•°æ®.")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("mkdir")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-p")]),s._v(" /tmp/test1\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" stop fio_test1"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("rm")]),s._v(" fio_test1\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" run "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--name")]),s._v(" fio_test1 "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--volume")]),s._v(" /tmp/test1:/tmp  registery/fio:v1 fio "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-direct")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-rw")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("write "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-ioengine")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("libaio "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-bs")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("4k "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-size")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("1G "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-numjobs")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-name")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/tmp/fio_test1.log\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br")])]),t("p",[s._v('ä¸Šé¢çš„è¿™ä¸ª Docker å‘½ä»¤, æˆ‘ç»™ä½ ç®€å•åœ°è§£é‡Šä¸€ä¸‹: åœ¨è¿™é‡Œç¬¬ä¸€æ¬¡ç”¨åˆ°äº† "--volume" è¿™ä¸ªå‚æ•°. ä¹‹å‰è®²è¿‡å®¹å™¨æ–‡ä»¶ç³»ç»Ÿ, æ¯”å¦‚ OverlayFS. ä¸è¿‡å®¹å™¨æ–‡ä»¶ç³»ç»Ÿå¹¶ä¸é€‚åˆé¢‘ç¹åœ°è¯»å†™. å¯¹äºé¢‘ç¹è¯»å†™çš„æ•°æ®, å®¹å™¨éœ€è¦æŠŠä»–ä»¬åˆ°æ”¾åˆ° "'),t("strong",[s._v("volume")]),s._v('" ä¸­. è¿™é‡Œçš„ '),t("strong",[s._v("volume å¯ä»¥æ˜¯ä¸€ä¸ªæœ¬åœ°çš„ç£ç›˜, ä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªç½‘ç»œç£ç›˜")]),s._v(". åœ¨è¿™ä¸ªä¾‹å­é‡Œå°±"),t("strong",[s._v("ä½¿ç”¨äº†å®¿ä¸»æœºæœ¬åœ°ç£ç›˜, æŠŠç£ç›˜ä¸Šçš„ /tmp/test1 ç›®å½•ä½œä¸º volume æŒ‚è½½åˆ°å®¹å™¨çš„ /tmp ç›®å½•ä¸‹")]),s._v(".")]),s._v(" "),t("p",[s._v("ç„¶ååœ¨å¯åŠ¨å®¹å™¨ä¹‹å, ç›´æ¥è¿è¡Œ fio çš„å‘½ä»¤, è¿™é‡Œçš„å‚æ•°å’Œå‰é¢çš„ä¾‹å­å·®ä¸å¤š, åªæ˜¯è¿™æ¬¡è¿è¡Œçš„æ˜¯ "),t("strong",[s._v("write")]),s._v(", ä¹Ÿå°±æ˜¯å†™ç£ç›˜çš„æ“ä½œ, è€Œå†™çš„ç›®æ ‡ç›˜å°±æ˜¯æŒ‚è½½åˆ° /tmp ç›®å½•çš„ volume.")]),s._v(" "),t("p",[s._v("å¯ä»¥çœ‹åˆ°, fio çš„è¿è¡Œç»“æœå¦‚ä¸‹å›¾æ‰€ç¤º, IOPS æ˜¯ 18K, å¸¦å®½ (BW) æ˜¯ 70MB/s å·¦å³.")]),s._v(" "),t("p",[t("img",{attrs:{src:"/img/23db24d7da44d9dcf00f4020b9056b2e-20230731161430-a3ual8h.png",alt:""}})]),s._v(" "),t("p",[s._v("åˆšæ‰æ¨¡æ‹Ÿäº†ä¸€ä¸ªå®¹å™¨å†™ç£ç›˜çš„æ€§èƒ½. é‚£ä¹ˆå¦‚æœè¿™æ—¶å€™"),t("strong",[s._v("æœ‰ä¸¤ä¸ªå®¹å™¨, éƒ½åœ¨å¾€åŒä¸€ä¸ªç£ç›˜ä¸Šå†™æ•°æ®åˆæ˜¯ä»€ä¹ˆæƒ…")]),s._v("å†µå‘¢? å¯ä»¥å†ç”¨ä¸‹é¢çš„è¿™ä¸ªè„šæœ¬è¯•ä¸€ä¸‹:")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("mkdir")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-p")]),s._v(" /tmp/test1\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("mkdir")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-p")]),s._v(" /tmp/test2\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" stop fio_test1"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("rm")]),s._v(" fio_test1\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" stop fio_test2"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("rm")]),s._v(" fio_test2\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" run "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--name")]),s._v(" fio_test1 "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--volume")]),s._v(" /tmp/test1:/tmp  registery/fio:v1 fio "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-direct")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-rw")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("write "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-ioengine")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("libaio "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-bs")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("4k "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-size")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("1G "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-numjobs")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-name")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/tmp/fio_test1.log "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" run "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--name")]),s._v(" fio_test2 "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--volume")]),s._v(" /tmp/test2:/tmp  registery/fio:v1 fio "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-direct")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-rw")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("write "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-ioengine")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("libaio "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-bs")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("4k "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-size")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("1G "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-numjobs")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-name")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/tmp/fio_test2.log "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br")])]),t("p",[s._v("è¿™æ—¶å€™, çœ‹åˆ°çš„ç»“æœ, åœ¨å®¹å™¨ fio_test1 é‡Œ, IOPS æ˜¯ 15K å·¦å³, å¸¦å®½æ˜¯ 59MB/s äº†, æ¯”ä¹‹å‰å•ç‹¬è¿è¡Œçš„æ—¶å€™æ€§èƒ½ä¸‹é™äº†ä¸å°‘.")]),s._v(" "),t("p",[t("img",{attrs:{src:"/img/f45312b8153cf4f2e4206cfaf6e302cc-20230731161430-njkt770.png",alt:""}})]),s._v(" "),t("p",[s._v("æ˜¾ç„¶ä»è¿™ä¸ªä¾‹å­ä¸­, å¯ä»¥çœ‹åˆ°"),t("strong",[s._v("å¤šä¸ªå®¹å™¨åŒæ—¶å†™ä¸€å—ç£ç›˜çš„æ—¶å€™, å®ƒçš„æ€§èƒ½å—åˆ°äº†å¹²æ‰°")]),s._v(". é‚£ä¹ˆæœ‰ä»€ä¹ˆåŠæ³•å¯ä»¥ä¿è¯æ¯ä¸ªå®¹å™¨çš„ç£ç›˜è¯»å†™æ€§èƒ½å‘¢?")]),s._v(" "),t("p",[s._v("ä¹‹å‰è®¨è®ºè¿‡ç”¨ Cgroups æ¥ä¿è¯å®¹å™¨çš„ CPU ä½¿ç”¨ç‡, ä»¥åŠæ§åˆ¶ Memroy çš„å¯ç”¨å¤§å°. é‚£ä¹ˆä½ è‚¯å®šæƒ³åˆ°äº†, æ˜¯ä¸æ˜¯ä¹Ÿå¯ä»¥ç”¨ Cgroups æ¥ä¿è¯æ¯ä¸ªå®¹å™¨çš„ç£ç›˜è¯»å†™æ€§èƒ½? æ²¡é”™, åœ¨ Cgroup v1 ä¸­æœ‰ "),t("strong",[s._v("blkio")]),s._v(" å­ç³»ç»Ÿ, å®ƒå¯ä»¥æ¥"),t("strong",[s._v("é™åˆ¶ç£ç›˜çš„ I/O")]),s._v(". ä¸è¿‡ blkio å­ç³»ç»Ÿå¯¹äºç£ç›˜ I/O çš„é™åˆ¶, å¹¶ä¸åƒ CPU, Memory é‚£ä¹ˆç›´æ¥, ä¸‹é¢ä¼šè¯¦ç»†è®²è§£.")]),s._v(" "),t("h5",{attrs:{id:"_2-çŸ¥è¯†è¯¦è§£-5"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-çŸ¥è¯†è¯¦è§£-5"}},[s._v("#")]),s._v(" 2.çŸ¥è¯†è¯¦è§£")]),s._v(" "),t("h6",{attrs:{id:"_1-blkio-cgroup"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-blkio-cgroup"}},[s._v("#")]),s._v(" (1)Blkio Cgroup")]),s._v(" "),t("p",[s._v("åœ¨è®²è§£ blkio Cgroup å‰, å…ˆç®€å•äº†è§£ä¸€ä¸‹"),t("strong",[s._v("è¡¡é‡ç£ç›˜æ€§èƒ½çš„ä¸¤ä¸ªå¸¸è§çš„æŒ‡æ ‡ IOPS å’Œååé‡(Throughput)")]),s._v(" æ˜¯ä»€ä¹ˆæ„æ€, åé¢è®² Blkio Cgroup çš„å‚æ•°é…ç½®æ—¶ä¼šç”¨åˆ°.")]),s._v(" "),t("p",[s._v("IOPS æ˜¯ Input/Output Operations Per Second çš„ç®€ç§°, ä¹Ÿå°±æ˜¯"),t("strong",[s._v("æ¯ç§’é’Ÿç£ç›˜è¯»å†™çš„æ¬¡æ•°")]),s._v(", è¿™ä¸ªæ•°å€¼è¶Šå¤§, å½“ç„¶ä¹Ÿå°±è¡¨ç¤ºæ€§èƒ½è¶Šå¥½.")]),s._v(" "),t("p",[s._v("ååé‡(Throughput)æ˜¯æŒ‡"),t("strong",[s._v("æ¯ç§’é’Ÿç£ç›˜ä¸­æ•°æ®çš„è¯»å–é‡, ä¸€èˆ¬ä»¥ MB/s ä¸ºå•ä½")]),s._v(". è¿™ä¸ªè¯»å–é‡å¯ä»¥å«ä½œååé‡, æœ‰æ—¶å€™ä¹Ÿè¢«ç§°ä¸ºå¸¦å®½(Bandwidth). åˆšæ‰ç”¨åˆ°çš„ fio æ˜¾ç¤ºç»“æœå°±ä½“ç°äº†å¸¦å®½.")]),s._v(" "),t("p",[s._v("IOPS å’Œååé‡ä¹‹é—´æ˜¯æœ‰å…³è”çš„, åœ¨ IOPS å›ºå®šçš„æƒ…å†µä¸‹, å¦‚æœè¯»å†™çš„æ¯ä¸€ä¸ªæ•°æ®å—è¶Šå¤§, é‚£ä¹ˆååé‡ä¹Ÿè¶Šå¤§, å®ƒä»¬çš„å…³ç³»å¤§æ¦‚æ˜¯è¿™æ ·çš„: "),t("strong",[s._v("ååé‡ = æ•°æ®å—å¤§å° * IOPS")]),s._v(".")]),s._v(" "),t("p",[s._v("å†å›åˆ° blkio Cgroup è¿™ä¸ªæ¦‚å¿µä¸Š, "),t("strong",[s._v("blkio Cgroup ä¹Ÿæ˜¯ Cgroups é‡Œçš„ä¸€ä¸ªå­ç³»ç»Ÿ")]),s._v('. åœ¨ Cgroups v1 é‡Œ, blkio Cgroup çš„è™šæ‹Ÿæ–‡ä»¶ç³»ç»ŸæŒ‚è½½ç‚¹ä¸€èˆ¬åœ¨ " '),t("strong",[s._v("/sys/fs/cgroup/blkio/")]),s._v(' ". å’Œä¹‹å‰è®²è¿‡çš„ CPU, memory Cgroup ä¸€æ ·, '),t("strong",[s._v('åœ¨è¿™ä¸ª "/sys/fs/cgroup/blkio/" ç›®å½•ä¸‹åˆ›å»ºå­ç›®å½•ä½œä¸ºæ§åˆ¶ç»„, å†æŠŠéœ€è¦åš I/O é™åˆ¶çš„è¿›ç¨‹ pid å†™åˆ°æ§åˆ¶ç»„çš„ cgroup.procs å‚æ•°ä¸­å°±å¯ä»¥äº†')]),s._v(".")]),s._v(" "),t("p",[s._v("åœ¨ blkio Cgroup ä¸­, æœ‰å››ä¸ªæœ€ä¸»è¦çš„å‚æ•°, å®ƒä»¬å¯ä»¥ç”¨æ¥"),t("strong",[s._v("é™åˆ¶ç£ç›˜ I/O æ€§èƒ½")]),s._v(", å¦‚ä¸‹æ‰€ç¤º.")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("blkio.throttle.read_iops_device\nblkio.throttle.read_bps_device\nblkio.throttle.write_iops_device\nblkio.throttle.write_bps_device\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br")])]),t("p",[s._v("å‰é¢åˆšè¯´äº†ç£ç›˜ I/O çš„ä¸¤ä¸ªä¸»è¦æ€§èƒ½æŒ‡æ ‡ IOPS å’Œååé‡, åœ¨è¿™é‡Œæ ¹æ®è¿™å››ä¸ªå‚æ•°çš„åå­—, å…¶å®å·²ç»å¤§æ¦‚çŒœåˆ°å®ƒä»¬çš„æ„æ€äº†. å®ƒä»¬åˆ†åˆ«è¡¨ç¤º: "),t("strong",[s._v("ç£ç›˜è¯»å– IOPS é™åˆ¶, ç£ç›˜è¯»å–ååé‡é™åˆ¶, ç£ç›˜å†™å…¥ IOPS é™åˆ¶, ç£ç›˜å†™å…¥ååé‡é™åˆ¶")]),s._v(".")]),s._v(" "),t("p",[s._v("å¯¹äºæ¯ä¸ªå‚æ•°å†™å…¥å€¼çš„æ ¼å¼, å¯ä»¥å‚è€ƒå†…æ ¸blkio çš„æ–‡æ¡£. ä¸ºäº†è®©ä½ æ›´å¥½åœ°ç†è§£, åœ¨è¿™é‡Œä¸¾ä¸ªä¾‹å­. å¦‚æœè¦å¯¹ä¸€ä¸ªæ§åˆ¶ç»„åšé™åˆ¶, é™åˆ¶å®ƒ"),t("strong",[s._v("å¯¹ç£ç›˜ /dev/vdb çš„å†™å…¥ååé‡ä¸è¶…è¿‡ 10MB/s")]),s._v(", é‚£ä¹ˆå¯¹ blkio.throttle.write_bps_device å‚æ•°çš„é…ç½®å°±æ˜¯ä¸‹é¢è¿™ä¸ªå‘½ä»¤.")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"252:16 10485760"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$CGROUP_CONTAINER_PATH")]),s._v("/blkio.throttle.write_bps_device\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v('åœ¨è¿™ä¸ªå‘½ä»¤ä¸­, "252:16" æ˜¯ /dev/vdb çš„'),t("strong",[s._v("ä¸»æ¬¡è®¾å¤‡å·")]),s._v(", å¯ä»¥é€šè¿‡ "),t("code",[s._v("ls -l /dev/vdb")]),s._v('â€‹ çœ‹åˆ°è¿™ä¸¤ä¸ªå€¼, è€Œåé¢çš„ "10485760" å°±æ˜¯ 10MB çš„æ¯ç§’é’Ÿå¸¦å®½é™åˆ¶.')]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ls -l /dev/vdb -l")]),s._v("\nbrw-rw---- "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" root disk "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("252")]),s._v(", "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("16")]),s._v(" Nov  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" 08:02 /dev/vdb\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])]),t("p",[s._v("äº†è§£äº† blkio Cgroup çš„å‚æ•°é…ç½®, å†è¿è¡Œä¸‹é¢çš„è¿™ä¸ªä¾‹å­, "),t("strong",[s._v("é™åˆ¶ä¸€ä¸ªå®¹å™¨ blkio çš„è¯»å†™ç£ç›˜ååé‡")]),s._v(", ç„¶ååœ¨è¿™ä¸ªå®¹å™¨é‡Œè¿è¡Œä¸€ä¸‹ fio, çœ‹çœ‹ç»“æœæ˜¯ä»€ä¹ˆ.")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("mkdir")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-p")]),s._v(" /tmp/test1\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("rm")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-f")]),s._v(" /tmp/test1/*\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" stop fio_test1"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("rm")]),s._v(" fio_test1\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" run "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-d")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--name")]),s._v(" fio_test1 "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--volume")]),s._v(" /tmp/test1:/tmp  registery/fio:v1 "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("sleep")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("3600")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("sleep")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("CONTAINER_ID")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token variable"}},[t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$(")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ps")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--format")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"{{.ID}}'),t("span",{pre:!0,attrs:{class:"token entity",title:"\\t"}},[s._v("\\t")]),s._v('{{.Names}}"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("grep")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-i")]),s._v(" fio_test1 "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("awk")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'{print $1}'")]),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v(")")])]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$CONTAINER_ID")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("CGROUP_CONTAINER_PATH")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token variable"}},[t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$(")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("find")]),s._v(" /sys/fs/cgroup/blkio/ "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-name")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"*'),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$CONTAINER_ID")]),s._v('*"')]),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v(")")])]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$CGROUP_CONTAINER_PATH")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# To get the device major and minor id from /dev for the device that /tmp/test1 is on.")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"253:0 10485760"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$CGROUP_CONTAINER_PATH")]),s._v("/blkio.throttle.read_bps_device\n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"253:0 10485760"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$CGROUP_CONTAINER_PATH")]),s._v("/blkio.throttle.write_bps_device\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("exec")]),s._v(" fio_test1 fio "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-direct")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-rw")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("write "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-ioengine")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("libaio "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-bs")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("4k "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-size")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("100MB "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-numjobs")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-name")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/tmp/fio_test1.log\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("exec")]),s._v(" fio_test1 fio "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-direct")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-rw")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("read "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-ioengine")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("libaio "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-bs")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("4k "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-size")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("100MB "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-numjobs")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-name")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/tmp/fio_test1.log\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br")])]),t("p",[s._v('åœ¨è¿™é‡Œ, æˆ‘çš„æœºå™¨ä¸Š /tmp/test1 æ‰€åœ¨ç£ç›˜ä¸»æ¬¡è®¾å¤‡å·æ˜¯ "253:0", è‡ªå·±è¿è¡Œè¿™ç»„å‘½ä»¤çš„æ—¶å€™, éœ€è¦æŠŠä¸»æ¬¡è®¾å¤‡å·æ”¹æˆè‡ªå·±ç£ç›˜çš„å¯¹åº”å€¼. è¿˜æœ‰ä¸€ç‚¹è¦æé†’ä¸€ä¸‹, ä¸åŒæ•°æ®å—å¤§å°, åœ¨æ€§èƒ½æµ‹è¯•ä¸­å¯ä»¥é€‚ç”¨äºä¸åŒçš„æµ‹è¯•ç›®çš„. ä½†å› ä¸ºè¿™é‡Œä¸æ˜¯è¦è®²çš„é‡ç‚¹, æ‰€ä»¥ä¸ºäº†æ–¹ä¾¿ç†è§£æ¦‚å¿µ, è¿™é‡Œå°±ç”¨å›ºå®šå€¼. åœ¨åé¢çš„ä¾‹å­é‡Œ, fio è¯»å†™çš„æ•°æ®å—éƒ½'),t("strong",[s._v("å›ºå®šåœ¨ 4KB")]),s._v(". æ‰€ä»¥å¯¹äºç£ç›˜çš„æ€§èƒ½é™åˆ¶, åœ¨ blkio Cgroup é‡Œå°±åªè®¾ç½®ååé‡é™åˆ¶äº†.")]),s._v(" "),t("p",[s._v("åœ¨åŠ äº† blkio Cgroup é™åˆ¶ 10MB/s å, ä» fio è¿è¡Œåçš„è¾“å‡ºç»“æœé‡Œ, å¯ä»¥çœ‹åˆ°è¿™ä¸ªå®¹å™¨å¯¹ç£ç›˜æ— è®ºæ˜¯"),t("strong",[s._v("è¯»è¿˜æ˜¯å†™")]),s._v(", å®ƒçš„æœ€å¤§å€¼å°±ä¸ä¼šå†è¶…è¿‡ 10MB/s äº†.")]),s._v(" "),t("p",[t("img",{attrs:{src:"/img/40bd4d165d174a6a4563651e6ac77322-20230731161430-7q3ls2a.png",alt:""}})]),s._v(" "),t("p",[t("img",{attrs:{src:"/img/d20f09f220d19ec82ce7203e788ad950-20230731161430-ugsj09q.png",alt:""}})]),s._v(" "),t("p",[s._v("**åœ¨ç»™æ¯ä¸ªå®¹å™¨éƒ½åŠ äº† blkio Cgroup é™åˆ¶, é™åˆ¶ä¸º 10MB/s å, å³ä½¿ä¸¤ä¸ªå®¹å™¨åŒæ—¶åœ¨ä¸€ä¸ªç£ç›˜ä¸Šå†™å…¥æ–‡ä»¶, é‚£ä¹ˆæ¯ä¸ªå®¹å™¨çš„å†™å…¥ç£ç›˜çš„æœ€å¤§ååé‡, ä¹Ÿä¸ä¼šäº’ç›¸å¹²æ‰°äº†. **")]),s._v(" "),t("p",[s._v("å¯ä»¥ç”¨ä¸‹é¢çš„è¿™ä¸ªè„šæœ¬æ¥éªŒè¯ä¸€ä¸‹.")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token shebang important"}},[s._v("#!/bin/bash")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("mkdir")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-p")]),s._v(" /tmp/test1\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("rm")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-f")]),s._v(" /tmp/test1/*\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" stop fio_test1"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("rm")]),s._v(" fio_test1\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("mkdir")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-p")]),s._v(" /tmp/test2\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("rm")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-f")]),s._v(" /tmp/test2/*\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" stop fio_test2"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("rm")]),s._v(" fio_test2\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" run "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-d")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--name")]),s._v(" fio_test1 "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--volume")]),s._v(" /tmp/test1:/tmp  registery/fio:v1 "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("sleep")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("3600")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" run "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-d")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--name")]),s._v(" fio_test2 "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--volume")]),s._v(" /tmp/test2:/tmp  registery/fio:v1 "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("sleep")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("3600")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("sleep")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("CONTAINER_ID1")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token variable"}},[t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$(")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ps")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--format")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"{{.ID}}'),t("span",{pre:!0,attrs:{class:"token entity",title:"\\t"}},[s._v("\\t")]),s._v('{{.Names}}"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("grep")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-i")]),s._v(" fio_test1 "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("awk")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'{print $1}'")]),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v(")")])]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$CONTAINER_ID1")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("CGROUP_CONTAINER_PATH1")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token variable"}},[t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$(")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("find")]),s._v(" /sys/fs/cgroup/blkio/ "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-name")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"*'),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$CONTAINER_ID1")]),s._v('*"')]),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v(")")])]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$CGROUP_CONTAINER_PATH1")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# To get the device major and minor id from /dev for the device that /tmp/test1 is on.")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"253:0 10485760"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$CGROUP_CONTAINER_PATH1")]),s._v("/blkio.throttle.read_bps_device\n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"253:0 10485760"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$CGROUP_CONTAINER_PATH1")]),s._v("/blkio.throttle.write_bps_device\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("CONTAINER_ID2")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token variable"}},[t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$(")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ps")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--format")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"{{.ID}}'),t("span",{pre:!0,attrs:{class:"token entity",title:"\\t"}},[s._v("\\t")]),s._v('{{.Names}}"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("grep")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-i")]),s._v(" fio_test2 "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("awk")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'{print $1}'")]),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v(")")])]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$CONTAINER_ID2")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("CGROUP_CONTAINER_PATH2")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token variable"}},[t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$(")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("find")]),s._v(" /sys/fs/cgroup/blkio/ "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-name")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"*'),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$CONTAINER_ID2")]),s._v('*"')]),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v(")")])]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$CGROUP_CONTAINER_PATH2")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# To get the device major and minor id from /dev for the device that /tmp/test1 is on.")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"253:0 10485760"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$CGROUP_CONTAINER_PATH2")]),s._v("/blkio.throttle.read_bps_device\n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"253:0 10485760"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$CGROUP_CONTAINER_PATH2")]),s._v("/blkio.throttle.write_bps_device\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("exec")]),s._v(" fio_test1 fio "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-direct")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-rw")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("write "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-ioengine")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("libaio "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-bs")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("4k "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-size")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("100MB "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-numjobs")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-name")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/tmp/fio_test1.log "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("exec")]),s._v(" fio_test2 fio "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-direct")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-rw")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("write "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-ioengine")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("libaio "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-bs")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("4k "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-size")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("100MB "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-numjobs")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-name")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/tmp/fio_test2.log "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br"),t("span",{staticClass:"line-number"},[s._v("25")]),t("br"),t("span",{staticClass:"line-number"},[s._v("26")]),t("br")])]),t("p",[s._v("è¿˜æ˜¯çœ‹çœ‹ fio è¿è¡Œè¾“å‡ºçš„ç»“æœ, è¿™æ—¶å€™, fio_test1 å’Œ fio_test2 ä¸¤ä¸ªå®¹å™¨é‡Œæ‰§è¡Œçš„ç»“æœéƒ½æ˜¯ 10MB/s äº†.")]),s._v(" "),t("p",[t("img",{attrs:{src:"/img/d9ca21124a285b8f75323060089c6630-20230731161430-c11ov2s.png",alt:""}})]),s._v(" "),t("p",[t("img",{attrs:{src:"/img/d91cbb027126df5608329a3e44bacf07-20230731161430-ek3lzds.png",alt:""}})]),s._v(" "),t("p",[s._v("é‚£ä¹ˆåšåˆ°äº†è¿™ä¸€æ­¥, æ˜¯ä¸æ˜¯å°±å¯ä»¥è®¤ä¸º, blkio Cgroup å¯ä»¥å®Œç¾åœ°å¯¹ç£ç›˜ I/O åšé™åˆ¶äº†å‘¢?")]),s._v(" "),t("p",[s._v('å…ˆåˆ«æ€¥, å¯ä»¥å†åšä¸ªè¯•éªŒ, æŠŠå‰é¢è„šæœ¬é‡Œ fio å‘½ä»¤ä¸­çš„ " '),t("strong",[s._v("-direct=1")]),s._v('" ç»™å»æ‰, ä¹Ÿå°±æ˜¯ä¸è®© fio è¿è¡Œåœ¨ Direct I/O æ¨¡å¼äº†, è€Œæ˜¯ç”¨ '),t("strong",[s._v("Buffered I/O")]),s._v(" æ¨¡å¼å†è¿è¡Œä¸€æ¬¡, çœ‹çœ‹ fio æ‰§è¡Œçš„è¾“å‡º. åŒæ—¶ä¹Ÿå¯ä»¥è¿è¡Œ iostat å‘½ä»¤, æŸ¥çœ‹å®é™…çš„ç£ç›˜å†™å…¥é€Ÿåº¦. è¿™æ—¶å€™ä½ ä¼šå‘ç°, å³ä½¿è®¾ç½®äº† blkio Cgroup, ä¹Ÿæ ¹æœ¬"),t("strong",[s._v("ä¸èƒ½")]),s._v("é™åˆ¶ç£ç›˜çš„ååé‡äº†.")]),s._v(" "),t("h6",{attrs:{id:"_2-direct-i-o-å’Œ-buffered-i-o"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-direct-i-o-å’Œ-buffered-i-o"}},[s._v("#")]),s._v(" (2)Direct I/O å’Œ Buffered I/O")]),s._v(" "),t("p",[s._v("ä¸ºä»€ä¹ˆä¼šè¿™æ ·çš„å‘¢? è¿™å°±è¦æåˆ° Linux çš„ä¸¤ç§æ–‡ä»¶ I/O æ¨¡å¼äº†: "),t("strong",[s._v("Direct I/O å’Œ Buffered I/O")]),s._v(".")]),s._v(" "),t("p",[s._v("Direct I/O æ¨¡å¼, ç”¨æˆ·è¿›ç¨‹å¦‚æœè¦å†™ç£ç›˜æ–‡ä»¶, å°±ä¼šé€šè¿‡ Linux å†…æ ¸çš„"),t("strong",[s._v("æ–‡ä»¶ç³»ç»Ÿå±‚ (filesystem) -> å—è®¾å¤‡å±‚ (block layer) -> ç£ç›˜é©±åŠ¨ -> ç£ç›˜ç¡¬ä»¶, è¿™æ ·ä¸€è·¯ä¸‹å»å†™å…¥ç£ç›˜")]),s._v(".")]),s._v(" "),t("p",[s._v("è€Œå¦‚æœæ˜¯ Buffered I/O æ¨¡å¼, é‚£ä¹ˆç”¨æˆ·è¿›ç¨‹åªæ˜¯æŠŠ"),t("strong",[s._v("æ–‡ä»¶æ•°æ®å†™åˆ°å†…å­˜ä¸­(Page Cache)")]),s._v(" å°±è¿”å›äº†, è€Œ Linux å†…æ ¸è‡ªå·±æœ‰çº¿ç¨‹ä¼šæŠŠå†…å­˜ä¸­çš„æ•°æ®å†å†™å…¥åˆ°ç£ç›˜ä¸­. "),t("mark",[t("strong",[s._v("åœ¨ Linux é‡Œ, ç”±äºè€ƒè™‘åˆ°æ€§èƒ½é—®é¢˜, ç»å¤§å¤šæ•°çš„åº”ç”¨éƒ½ä¼šä½¿ç”¨ Buffered I/O æ¨¡å¼")])]),s._v("â€‹ **. **")]),s._v(" "),t("p",[t("img",{attrs:{src:"/img/a0f67ebbbbc5557dcdaf5c99c82a566b-20230731161430-5oo2hm6.png",alt:""}})]),s._v(" "),t("p",[s._v("é€šè¿‡å‰é¢çš„æµ‹è¯•, "),t("strong",[s._v("å‘ç° Direct I/O å¯ä»¥é€šè¿‡ blkio Cgroup æ¥é™åˆ¶ç£ç›˜ I/O, ä½†æ˜¯ Buffered I/O ä¸èƒ½è¢«é™åˆ¶")]),s._v(".")]),s._v(" "),t("p",[s._v("é‚£é€šè¿‡ä¸Šé¢çš„ä¸¤ç§ I/O æ¨¡å¼çš„è§£é‡Š, ä½ æ˜¯ä¸æ˜¯å¯ä»¥æƒ³åˆ°åŸå› å‘¢? æ˜¯çš„, åŸå› å°±æ˜¯"),t("strong",[s._v("è¢« Cgroups v1 çš„æ¶æ„é™åˆ¶")]),s._v("äº†.")]),s._v(" "),t("p",[s._v("å‰é¢å·²ç»å­¦ä¹ è¿‡äº† v1 çš„ CPU Cgroup, memory Cgroup å’Œ blkio Cgroup, é‚£ä¹ˆ Cgroup v1 çš„ä¸€ä¸ªæ•´ä½“ç»“æ„, ä½ åº”è¯¥å·²ç»å¾ˆç†Ÿæ‚‰äº†. "),t("strong",[s._v("å®ƒçš„æ¯ä¸€ä¸ªå­ç³»ç»Ÿéƒ½æ˜¯ç‹¬ç«‹çš„, èµ„æºçš„é™åˆ¶åªèƒ½åœ¨å­ç³»ç»Ÿä¸­å‘ç”Ÿ")]),s._v(".")]),s._v(" "),t("p",[s._v("å°±åƒä¸‹é¢å›¾é‡Œçš„"),t("strong",[s._v("è¿›ç¨‹ pid_y")]),s._v(", "),t("strong",[s._v("å®ƒå¯ä»¥åˆ†åˆ«å±äº memory Cgroup å’Œ blkio Cgroup. ä½†æ˜¯åœ¨ blkio Cgroup å¯¹è¿›ç¨‹ pid_y åšç£ç›˜ I/O åšé™åˆ¶çš„æ—¶å€™, blkio å­ç³»ç»Ÿæ˜¯ä¸ä¼šå»å…³å¿ƒ pid_y ç”¨äº†å“ªäº›å†…å­˜, å“ªäº›å†…å­˜æ˜¯ä¸æ˜¯å±äº Page Cache, è€Œè¿™äº› Page Cache çš„é¡µé¢åœ¨åˆ·å…¥ç£ç›˜çš„æ—¶å€™, äº§ç”Ÿçš„ I/O ä¹Ÿä¸ä¼šè¢«è®¡ç®—åˆ°è¿›ç¨‹ pid_y ä¸Šé¢")]),s._v(".")]),s._v(" "),t("p",[s._v("å°±æ˜¯è¿™ä¸ªåŸå› , "),t("strong",[s._v("å¯¼è‡´äº† blkio åœ¨ Cgroups v1 é‡Œä¸èƒ½é™åˆ¶ Buffered I/O")]),s._v(".")]),s._v(" "),t("p",[t("img",{attrs:{src:"/img/e6a89d666b2420293d69509554ec3785-20230731161430-27bc1c5.png",alt:""}})]),s._v(" "),t("p",[s._v("è¿™ä¸ª Buffered I/O é™é€Ÿçš„é—®é¢˜, "),t("strong",[s._v("åœ¨ Cgroup V2 é‡Œå¾—åˆ°äº†è§£å†³")]),s._v(", å…¶å®è¿™ä¸ªé—®é¢˜ä¹Ÿæ˜¯ä¿ƒä½¿ Linux å¼€å‘è€…é‡æ–°è®¾è®¡ Cgroup V2 çš„åŸå› ä¹‹ä¸€.")]),s._v(" "),t("h5",{attrs:{id:"_3-cgroup-v2"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-cgroup-v2"}},[s._v("#")]),s._v(" 3.Cgroup V2")]),s._v(" "),t("p",[s._v("Cgroup v2 ç›¸æ¯” Cgroup v1 åšçš„æœ€å¤§çš„å˜åŠ¨å°±æ˜¯"),t("strong",[s._v("ä¸€ä¸ªè¿›ç¨‹å±äºä¸€ä¸ªæ§åˆ¶ç»„, è€Œæ¯ä¸ªæ§åˆ¶ç»„é‡Œå¯ä»¥å®šä¹‰è‡ªå·±éœ€è¦çš„å¤šä¸ªå­ç³»ç»Ÿ")]),s._v(".")]),s._v(" "),t("p",[s._v("æ¯”å¦‚ä¸‹é¢çš„ Cgroup V2 ç¤ºæ„å›¾é‡Œ, è¿›ç¨‹ pid_y å±äºæ§åˆ¶ç»„ group2, è€Œåœ¨ group2 é‡Œ"),t("strong",[s._v("åŒæ—¶æ‰“å¼€äº† io å’Œ memory å­ç³»ç»Ÿ")]),s._v(" (Cgroup V2 é‡Œçš„ io å­ç³»ç»Ÿå°±ç­‰åŒäº Cgroup v1 é‡Œçš„ blkio å­ç³»ç»Ÿ).")]),s._v(" "),t("p",[s._v("é‚£ä¹ˆ, "),t("strong",[s._v("Cgroup å¯¹è¿›ç¨‹ pid_y çš„ç£ç›˜ I/O åšé™åˆ¶çš„æ—¶å€™, å°±å¯ä»¥è€ƒè™‘åˆ°è¿›ç¨‹ pid_y å†™å…¥åˆ° Page Cache å†…å­˜çš„é¡µé¢äº†, è¿™æ · buffered I/O çš„ç£ç›˜é™é€Ÿå°±å®ç°")]),s._v("äº†.")]),s._v(" "),t("p",[t("img",{attrs:{src:"/img/9e335f68ae8d9872080b733e04b33038-20230731161430-om3536m.png",alt:""}})]),s._v(" "),t("p",[s._v("ä¸‹é¢åœ¨ Cgroup v2 é‡Œ, å°è¯•ä¸€ä¸‹è®¾ç½®äº† blkio Cgroup+Memory Cgroup ä¹‹å, æ˜¯å¦å¯ä»¥å¯¹ Buffered I/O è¿›è¡Œç£ç›˜é™é€Ÿ.")]),s._v(" "),t("p",[s._v('è¦åšçš„ç¬¬ä¸€æ­¥, å°±æ˜¯åœ¨ Linux ç³»ç»Ÿé‡Œæ‰“å¼€ Cgroup v2 çš„åŠŸèƒ½. å› ä¸ºç›®å‰å³ä½¿æœ€æ–°ç‰ˆæœ¬çš„ Ubuntu Linux æˆ–è€… Centos Linux, ä»ç„¶åœ¨ä½¿ç”¨ Cgroup v1 ä½œä¸ºç¼ºçœçš„ Cgroup. æ‰“å¼€æ–¹æ³•å°±æ˜¯é…ç½®ä¸€ä¸ª kernel å‚æ•° "cgroup_no_v1=blkio,memory", è¿™è¡¨ç¤ºæŠŠ Cgroup v1 çš„ blkio å’Œ Memory ä¸¤ä¸ªå­ç³»ç»Ÿç»™ç¦æ­¢, è¿™æ · Cgroup v2 çš„ io å’Œ Memory è¿™ä¸¤ä¸ªå­ç³»ç»Ÿå°±æ‰“å¼€äº†. å¯ä»¥æŠŠè¿™ä¸ªå‚æ•°é…ç½®åˆ° grub ä¸­, ç„¶åé‡å¯ Linux æœºå™¨, è¿™æ—¶ Cgroup v2 çš„ io è¿˜æœ‰ Memory è¿™ä¸¤ä¸ªå­ç³»ç»Ÿ, å®ƒä»¬çš„åŠŸèƒ½å°±æ‰“å¼€äº†.')]),s._v(" "),t("p",[s._v("ç³»ç»Ÿé‡å¯å, ä¼šçœ‹åˆ° Cgroup v2 çš„"),t("strong",[s._v("è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿè¢«æŒ‚è½½åˆ°äº† /sys/fs/cgroup/unified ç›®å½•")]),s._v("ä¸‹.")]),s._v(" "),t("p",[s._v("ç„¶å, ç”¨ä¸‹é¢çš„è¿™ä¸ªè„šæœ¬åš Cgroup v2 io çš„é™é€Ÿé…ç½®, å¹¶ä¸”è¿è¡Œ fio, çœ‹çœ‹ buffered I/O æ˜¯å¦å¯ä»¥è¢«é™é€Ÿ.")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# Create a new control group")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("mkdir")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-p")]),s._v(" /sys/fs/cgroup/unified/iotest\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# enable the io and memory controller subsystem")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"+io +memory"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" /sys/fs/cgroup/unified/cgroup.subtree_control\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# Add current bash pid in iotest control group.")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# Then all child processes of the bash will be in iotest group too,")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# including the fio")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$$")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("/sys/fs/cgroup/unified/iotest/cgroup.procs\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 256:16 are device major and minor ids, /mnt is on the device.")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"252:16 wbps=10485760"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" /sys/fs/cgroup/unified/iotest/io.max\n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("cd")]),s._v(" /mnt\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#Run the fio in non direct I/O mode")]),s._v("\nfio "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-iodepth")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-rw")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("write "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-ioengine")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("libaio "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-bs")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("4k "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-size")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("1G "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-numjobs")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-name")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("./fio.test\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br")])]),t("p",[s._v("åœ¨è¿™ä¸ªä¾‹å­é‡Œ, å»ºç«‹äº†ä¸€ä¸ª"),t("strong",[s._v("åå« iotest çš„æ§åˆ¶ç»„, å¹¶ä¸”åœ¨è¿™ä¸ªæ§åˆ¶ç»„é‡ŒåŠ å…¥äº† io å’Œ Memory ä¸¤ä¸ªæ§åˆ¶å­ç³»ç»Ÿ, å¯¹ç£ç›˜æœ€å¤§ååé‡çš„è®¾ç½®ä¸º 10MB")]),s._v('. è¿è¡Œ fio çš„æ—¶å€™ä¸åŠ  "-direct=1", ä¹Ÿå°±æ˜¯è®© fio è¿è¡Œåœ¨ '),t("strong",[s._v("buffered I/O")]),s._v(" æ¨¡å¼ä¸‹.")]),s._v(" "),t("p",[s._v("è¿è¡Œ fio å†™å…¥ 1GB çš„æ•°æ®å, ä½ ä¼šå‘ç° fio é©¬ä¸Šå°±æ‰§è¡Œå®Œäº†, å› ä¸ºç³»ç»Ÿä¸Šæœ‰è¶³å¤Ÿçš„å†…å­˜, "),t("strong",[s._v("fio æŠŠæ•°æ®å†™å…¥å†…å­˜å°±è¿”å›äº†")]),s._v(', ä¸è¿‡åªè¦å†è¿è¡Œ "iostat -xz 10" è¿™ä¸ªå‘½ä»¤, å°±å¯ä»¥çœ‹åˆ°'),t("strong",[s._v("ç£ç›˜ vdb ä¸Šç¨³å®šçš„å†™å…¥é€Ÿç‡")]),s._v("æ˜¯ 10240wkB/s, ä¹Ÿå°±æ˜¯åœ¨ io Cgroup é‡Œé™åˆ¶çš„ 10MB/s.")]),s._v(" "),t("p",[t("img",{attrs:{src:"/img/330d7c4fe7224c81b635a7b8139aaa0b-20230731161430-rs60uet.png",alt:""}})]),s._v(" "),t("p",[s._v("è¿™ä¸ªç»“æœè¯å®äº† "),t("strong",[s._v("Cgoupv2 io+Memory ä¸¤ä¸ªå­ç³»ç»Ÿä¸€èµ·ä½¿ç”¨, å°±å¯ä»¥å¯¹ buffered I/O æ§åˆ¶ç£ç›˜å†™å…¥é€Ÿç‡")]),s._v(".")]),s._v(" "),t("h5",{attrs:{id:"_4-é‡ç‚¹æ€»ç»“-9"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_4-é‡ç‚¹æ€»ç»“-9"}},[s._v("#")]),s._v(" 4.é‡ç‚¹æ€»ç»“")]),s._v(" "),t("p",[s._v("è¿™ä¸€è®²ä¸»è¦æƒ³è§£å†³çš„é—®é¢˜æ˜¯å¦‚ä½•ä¿è¯å®¹å™¨è¯»å†™ç£ç›˜é€Ÿç‡çš„ç¨³å®š, ç‰¹åˆ«æ˜¯å½“å¤šä¸ªå®¹å™¨åŒæ—¶è¯»å†™åŒä¸€ä¸ªç£ç›˜çš„æ—¶å€™, éœ€è¦å‡å°‘ç›¸äº’çš„å¹²æ‰°.")]),s._v(" "),t("p",[s._v("Cgroup V1 çš„ blkiio æ§åˆ¶å­ç³»ç»Ÿ, å¯ä»¥ç”¨æ¥é™åˆ¶å®¹å™¨ä¸­è¿›ç¨‹çš„è¯»å†™çš„ IOPS å’Œååé‡(Throughput), ä½†æ˜¯å®ƒåªèƒ½å¯¹äº "),t("strong",[s._v("Direct I/O çš„è¯»å†™æ–‡ä»¶åšç£ç›˜é™é€Ÿ, å¯¹ Buffered I/O çš„æ–‡ä»¶è¯»å†™, å®ƒæ— æ³•è¿›è¡Œç£ç›˜é™é€Ÿ")]),s._v(".")]),s._v(" "),t("p",[t("mark",[s._v("**è¿™æ˜¯å› ä¸º Buffered I/O ä¼šæŠŠæ•°æ®å…ˆå†™å…¥åˆ°å†…å­˜ Page Cache ä¸­, ç„¶åç”±å†…æ ¸çº¿ç¨‹æŠŠæ•°æ®å†™å…¥ç£ç›˜, è€Œ Cgroup v1 blkio çš„å­ç³»ç»Ÿç‹¬ç«‹äº memory å­ç³»ç»Ÿ, æ— æ³•ç»Ÿè®¡åˆ°ç”± Page Cache åˆ·å…¥åˆ°ç£ç›˜çš„æ•°æ®é‡. **")]),s._v(" è¿™ä¸ª Buffered I/O æ— æ³•è¢«é™é€Ÿçš„é—®é¢˜, åœ¨ Cgroup v2 é‡Œè¢«è§£å†³äº†. Cgroup v2 ä»æ¶æ„ä¸Šå…è®¸ä¸€ä¸ªæ§åˆ¶ç»„é‡Œæœ‰å¤šä¸ªå­ç³»ç»ŸååŒè¿è¡Œ, è¿™æ ·åœ¨ä¸€ä¸ªæ§åˆ¶ç»„é‡Œåªè¦åŒæ—¶æœ‰ io å’Œ Memory å­ç³»ç»Ÿ, å°±å¯ä»¥å¯¹ Buffered I/O ä½œç£ç›˜è¯»å†™çš„é™é€Ÿ.")]),s._v(" "),t("p",[s._v("è™½ç„¶ Cgroup v2 è§£å†³äº† Buffered I/O ç£ç›˜è¯»å†™é™é€Ÿçš„é—®é¢˜, ä½†æ˜¯åœ¨ç°å®çš„å®¹å™¨å¹³å°ä¸Šä¹Ÿä¸æ˜¯èƒ½å¤Ÿç«‹åˆ»ä½¿ç”¨çš„, è¿˜éœ€è¦ç­‰å¾…ä¸€æ®µæ—¶é—´. ç›®å‰ä» runC, containerd åˆ° Kubernetes éƒ½æ˜¯åˆšåˆšå¼€å§‹æ”¯æŒ Cgroup v2, è€Œå¯¹ç”Ÿäº§ç¯å¢ƒä¸­åŸæœ‰è¿è¡Œ Cgroup v1 çš„èŠ‚ç‚¹è¦è¿ç§»è½¬åŒ–æˆ Cgroup v2 éœ€è¦ä¸€ä¸ªè¿‡ç¨‹.")]),s._v(" "),t("h4",{attrs:{id:"_14-å®¹å™¨ä¸­çš„å†…å­˜ä¸i-o-å®¹å™¨å†™æ–‡ä»¶çš„å»¶æ—¶ä¸ºä»€ä¹ˆæ³¢åŠ¨å¾ˆå¤§"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_14-å®¹å™¨ä¸­çš„å†…å­˜ä¸i-o-å®¹å™¨å†™æ–‡ä»¶çš„å»¶æ—¶ä¸ºä»€ä¹ˆæ³¢åŠ¨å¾ˆå¤§"}},[s._v("#")]),s._v(" 14 | å®¹å™¨ä¸­çš„å†…å­˜ä¸I/O:å®¹å™¨å†™æ–‡ä»¶çš„å»¶æ—¶ä¸ºä»€ä¹ˆæ³¢åŠ¨å¾ˆå¤§?")]),s._v(" "),t("p",[s._v("æœ¬èŠ‚ç»§ç»­èŠä¸€èŠå®¹å™¨ä¸­å†™æ–‡ä»¶æ€§èƒ½æ³¢åŠ¨çš„é—®é¢˜.")]),s._v(" "),t("p",[s._v("ä¸Šä¸€è®²ä¸­è®²è¿‡ Linux ä¸­çš„ä¸¤ç§ I/O æ¨¡å¼, Direct I/O å’Œ Buffered I/O. "),t("strong",[s._v("å¯¹äº Linux çš„ç³»ç»Ÿè°ƒç”¨ write() æ¥è¯´, Buffered I/O æ˜¯ç¼ºçœæ¨¡å¼")]),s._v(", ä½¿ç”¨èµ·æ¥æ¯”è¾ƒæ–¹ä¾¿, è€Œä¸”ä»ç”¨æˆ·è§’åº¦çœ‹, åœ¨å¤§å¤šæ•°çš„åº”ç”¨åœºæ™¯ä¸‹, ç”¨ Buffered I/O çš„ write() å‡½æ•°è°ƒç”¨è¿”å›è¦å¿«ä¸€äº›. æ‰€ä»¥, Buffered I/O åœ¨ç¨‹åºä¸­ä½¿ç”¨å¾—æ›´"),t("strong",[s._v("æ™®é")]),s._v("ä¸€äº›.")]),s._v(" "),t("p",[s._v("**å½“ä½¿ç”¨ Buffered I/O çš„åº”ç”¨ç¨‹åºä»è™šæ‹Ÿæœºè¿ç§»åˆ°å®¹å™¨, è¿™æ—¶å°±ä¼šå‘ç°å¤šäº† Memory Cgroup çš„é™åˆ¶ä¹‹å, write() å†™ç›¸åŒå¤§å°çš„æ•°æ®å—èŠ±è´¹çš„æ—¶é—´, å»¶æ—¶æ³¢åŠ¨ä¼šæ¯”è¾ƒå¤§. **")]),s._v(" "),t("p",[s._v("è¿™æ˜¯æ€ä¹ˆå›äº‹å‘¢? æ¥ä¸‹æ¥å°±å¸¦ç€é—®é¢˜å¼€å§‹ä»Šå¤©çš„å­¦ä¹ .")]),s._v(" "),t("h5",{attrs:{id:"_1-é—®é¢˜å†ç°-9"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-é—®é¢˜å†ç°-9"}},[s._v("#")]),s._v(" 1.é—®é¢˜å†ç°")]),s._v(" "),t("p",[s._v("å¯ä»¥å…ˆåŠ¨æ‰‹å†™ä¸€ä¸ªå°ç¨‹åº, ç”¨æ¥æ¨¡æ‹Ÿåˆšåˆšè¯´çš„ç°è±¡. è¿™ä¸ªå°ç¨‹åºè¿™æ ·æ¥è®¾è®¡: "),t("strong",[s._v("ä»ä¸€ä¸ªæ–‡ä»¶ä¸­æ¯æ¬¡è¯»å–ä¸€ä¸ª 64KB å¤§å°çš„æ•°æ®å—, ç„¶åå†™åˆ°ä¸€ä¸ªæ–°æ–‡ä»¶ä¸­, å®ƒå¯ä»¥ä¸æ–­è¯»å†™ 10GB å¤§å°çš„æ•°æ®. åŒæ—¶åœ¨è¿™ä¸ªå°ç¨‹åºä¸­åšä¸ªè®°å½•, è®°å½•å†™æ¯ä¸ª 64KB çš„æ•°æ®å—éœ€è¦èŠ±è´¹çš„æ—¶é—´.")])]),s._v(" "),t("p",[s._v("å¯ä»¥å…ˆåœ¨"),t("strong",[s._v("è™šæ‹Ÿæœº")]),s._v("é‡Œç›´æ¥è¿è¡Œ, è™šæ‹Ÿæœºé‡Œå†…å­˜å¤§å°æ˜¯å¤§äº 10GB çš„. æ¥ç€æŠŠè¿™ä¸ªç¨‹åºæ”¾åˆ°"),t("strong",[s._v("å®¹å™¨")]),s._v("ä¸­è¿è¡Œ, å› ä¸ºè¿™ä¸ªç¨‹åºæœ¬èº«å¹¶ä¸éœ€è¦å¾ˆå¤šçš„å†…å­˜, ç»™å®ƒåšäº†ä¸€ä¸ª Memory Cgroup çš„å†…å­˜é™åˆ¶, è®¾ç½®ä¸º 1GB.")]),s._v(" "),t("p",[s._v("è¿è¡Œç»“æŸå, æ¯”è¾ƒä¸€ä¸‹ç¨‹åºå†™æ•°æ®å—çš„æ—¶é—´. æŠŠç»“æœç”»äº†ä¸€å¼ å›¾, å›¾é‡Œçš„çºµè½´æ˜¯æ—¶é—´, å•ä½ us; æ¨ªè½´æ˜¯æ¬¡æ•°, åœ¨è¿™é‡Œè®°å½•äº† 96 æ¬¡. å›¾ä¸­æ©˜çº¢è‰²çš„çº¿æ˜¯åœ¨å®¹å™¨é‡Œè¿è¡Œçš„ç»“æœ, è“è‰²çš„çº¿æ˜¯åœ¨è™šæ‹Ÿæœºä¸Šè¿è¡Œçš„ç»“æœ.")]),s._v(" "),t("p",[s._v("ç»“æœå¾ˆæ˜æ˜¾, "),t("strong",[s._v("åœ¨å®¹å™¨ä¸­å†™å…¥æ•°æ®å—çš„æ—¶é—´ä¼šæ—¶ä¸æ—¶åœ°å¢é«˜åˆ° 200us")]),s._v("; è€Œåœ¨è™šæ‹Ÿæœºé‡Œçš„å†™å…¥æ•°æ®å—æ—¶é—´å°±æ¯”è¾ƒå¹³ç¨³, ä¸€ç›´åœ¨ 30ï½50us è¿™ä¸ªèŒƒå›´å†….")]),s._v(" "),t("p",[t("img",{attrs:{src:"/img/dc4bc8ed6423f45da1f32e0d257684ef-20230731161430-80w948r.png",alt:""}})]),s._v(" "),t("p",[s._v("é€šè¿‡è¿™ä¸ªå°ç¨‹åº, å†ç°äº†é—®é¢˜, é‚£å°±æ¥åˆ†æä¸€ä¸‹, ä¸ºä»€ä¹ˆä¼šäº§ç”Ÿè¿™æ ·çš„ç»“æœ.")]),s._v(" "),t("h5",{attrs:{id:"_2-æ—¶é—´æ³¢åŠ¨æ˜¯å› ä¸ºdirty-pagesçš„å½±å“ä¹ˆ"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-æ—¶é—´æ³¢åŠ¨æ˜¯å› ä¸ºdirty-pagesçš„å½±å“ä¹ˆ"}},[s._v("#")]),s._v(" 2.æ—¶é—´æ³¢åŠ¨æ˜¯å› ä¸ºDirty Pagesçš„å½±å“ä¹ˆ?")]),s._v(" "),t("p",[s._v("å¯¹æ–‡ä»¶çš„"),t("strong",[s._v("å†™å…¥æ“ä½œæ˜¯ Buffered I/O")]),s._v(". åœ¨å‰ä¸€è®²ä¸­å…¶å®å·²ç»çŸ¥é“äº†, "),t("mark",[t("strong",[s._v("å¯¹äº Buffer I/O, ç”¨æˆ·çš„æ•°æ®æ˜¯å…ˆå†™å…¥åˆ° Page Cache é‡Œçš„. è€Œè¿™äº›å†™å…¥äº†æ•°æ®çš„å†…å­˜é¡µé¢, åœ¨å®ƒä»¬æ²¡æœ‰è¢«å†™å…¥åˆ°ç£ç›˜æ–‡ä»¶ä¹‹å‰, å°±è¢«å«ä½œ dirty pages. Linux å†…æ ¸ä¼šæœ‰ä¸“é—¨çš„å†…æ ¸çº¿ç¨‹(æ¯ä¸ªç£ç›˜è®¾å¤‡å¯¹åº”çš„ kworker/flush çº¿ç¨‹)æŠŠ dirty pages å†™å…¥åˆ°ç£ç›˜ä¸­")])]),s._v(".")]),s._v(" "),t("p",[s._v("é‚£æˆ‘ä»¬è‡ªç„¶ä¼šè¿™æ ·çŒœæµ‹, ä¹Ÿè®¸æ˜¯ Linux å†…æ ¸å¯¹ dirty pages çš„æ“ä½œå½±å“äº† Buffered I/O çš„å†™æ“ä½œ?")]),s._v(" "),t("p",[s._v("æƒ³è¦éªŒè¯è¿™ä¸ªæƒ³æ³•, éœ€è¦å…ˆæ¥çœ‹çœ‹ dirty pages æ˜¯åœ¨ä»€ä¹ˆæ—¶å€™è¢«å†™å…¥åˆ°ç£ç›˜çš„. è¿™é‡Œå°±è¦ç”¨åˆ°  "),t("strong",[s._v("/proc/sys/vm é‡Œå’Œ dirty page ç›¸å…³çš„å†…æ ¸å‚æ•°")]),s._v("äº†, éœ€è¦çŸ¥é“æ‰€æœ‰ç›¸å…³å‚æ•°çš„å«ä¹‰, æ‰èƒ½åˆ¤æ–­å‡ºæœ€åçœŸæ­£å¯¼è‡´é—®é¢˜å‘ç”Ÿçš„åŸå› .")]),s._v(" "),t("p",[s._v("ç°åœ¨æŒ¨ä¸ªæ¥çœ‹ä¸€ä¸‹. ä¸ºäº†æ–¹ä¾¿åé¢çš„è®²è¿°, å¯ä»¥è®¾å®šä¸€ä¸ªæ¯”å€¼ A, "),t("mark",[t("strong",[s._v("A ç­‰äº dirty pages çš„å†…å­˜ / èŠ‚ç‚¹å¯ç”¨å†…å­˜ 100%")])]),s._v(" .")]),s._v(" "),t("p",[s._v("ç¬¬ä¸€ä¸ªå‚æ•°, "),t("strong",[s._v("dirty_background_ratio")]),s._v(", è¿™ä¸ªå‚æ•°é‡Œçš„æ•°å€¼æ˜¯ä¸€ä¸ªç™¾åˆ†æ¯”å€¼, ç¼ºçœæ˜¯ 10%. å¦‚æœæ¯”å€¼ A å¤§äº dirty_background_ratio çš„è¯, æ¯”å¦‚å¤§äºé»˜è®¤çš„ 10%, "),t("strong",[s._v("å†…æ ¸ flush çº¿ç¨‹å°±ä¼šæŠŠ dirty pages åˆ·åˆ°ç£ç›˜é‡Œ")]),s._v(".")]),s._v(" "),t("p",[s._v("ç¬¬äºŒä¸ªå‚æ•°, æ˜¯å’Œ dirty_background_ratio ç›¸å¯¹åº”ä¸€ä¸ªå‚æ•°, ä¹Ÿå°±æ˜¯ "),t("strong",[s._v("dirty_background_bytes")]),s._v(", å®ƒå’Œ dirty_background_ratio ä½œç”¨ç›¸åŒ. åŒºåˆ«åªæ˜¯ dirty_background_bytes æ˜¯å…·ä½“çš„"),t("strong",[s._v("å­—èŠ‚æ•°")]),s._v(", å®ƒç”¨æ¥å®šä¹‰çš„æ˜¯ dirty pages å†…å­˜çš„ä¸´ç•Œå€¼, è€Œä¸æ˜¯æ¯”ä¾‹å€¼.")]),s._v(" "),t("p",[s._v("è¿™é‡Œè¿˜è¦æ³¨æ„, "),t("strong",[s._v("dirty_background_ratio å’Œ dirty_background_bytes åªæœ‰ä¸€ä¸ªå¯ä»¥èµ·ä½œç”¨")]),s._v(", å¦‚æœç»™å…¶ä¸­ä¸€ä¸ªèµ‹å€¼ä¹‹å, å¦å¤–ä¸€ä¸ªå‚æ•°å°±å½’ 0 äº†.")]),s._v(" "),t("p",[s._v("æ¥ä¸‹æ¥çœ‹ç¬¬ä¸‰ä¸ªå‚æ•°, "),t("strong",[s._v("dirty_ratio")]),s._v(", è¿™ä¸ªå‚æ•°çš„æ•°å€¼ä¹Ÿæ˜¯ä¸€ä¸ªç™¾åˆ†æ¯”å€¼, ç¼ºçœæ˜¯ 20%. å¦‚æœæ¯”å€¼ A, å¤§äºå‚æ•° dirty_ratio çš„å€¼, æ¯”å¦‚å¤§äºé»˜è®¤è®¾ç½®çš„ 20%, è¿™æ—¶å€™æ­£åœ¨æ‰§è¡Œ Buffered I/O å†™æ–‡ä»¶çš„è¿›ç¨‹å°±ä¼šè¢«é˜»å¡ä½, ç›´åˆ°å®ƒå†™çš„æ•°æ®é¡µé¢éƒ½å†™åˆ°ç£ç›˜ä¸ºæ­¢.")]),s._v(" "),t("p",[s._v("åŒæ ·, ç¬¬å››ä¸ªå‚æ•° "),t("strong",[s._v("dirty_bytes")]),s._v(" ä¸ dirty_ratio ç›¸å¯¹åº”, å®ƒä»¬çš„å…³ç³»å’Œ dirty_background_ratio ä¸ dirty_background_bytes ä¸€æ ·. ç»™å…¶ä¸­ä¸€ä¸ªèµ‹å€¼å, å¦ä¸€ä¸ªå°±ä¼šå½’é›¶.")]),s._v(" "),t("p",[s._v("ç„¶åæ¥çœ‹ "),t("strong",[s._v("dirty_writeback_centisecs")]),s._v(", è¿™ä¸ªå‚æ•°çš„å€¼æ˜¯ä¸ª"),t("strong",[s._v("æ—¶é—´å€¼")]),s._v(", ä»¥ç™¾åˆ†ä¹‹ä¸€ç§’ä¸ºå•ä½, ç¼ºçœå€¼æ˜¯ 500, ä¹Ÿå°±æ˜¯ 5 ç§’é’Ÿ. å®ƒè¡¨ç¤º"),t("strong",[s._v("æ¯ 5 ç§’é’Ÿä¼šå”¤é†’å†…æ ¸çš„ flush çº¿ç¨‹æ¥å¤„ç† dirty pages")]),s._v(".")]),s._v(" "),t("p",[s._v("æœ€åè¿˜æœ‰ "),t("strong",[s._v("dirty_expire_centisecs")]),s._v(", è¿™ä¸ªå‚æ•°çš„å€¼ä¹Ÿæ˜¯ä¸€ä¸ªæ—¶é—´å€¼, ä»¥ç™¾åˆ†ä¹‹ä¸€ç§’ä¸ºå•ä½, ç¼ºçœå€¼æ˜¯ 3000, ä¹Ÿå°±æ˜¯ 30 ç§’é’Ÿ. å®ƒå®šä¹‰äº† dirty page åœ¨å†…å­˜ä¸­å­˜æ”¾çš„"),t("strong",[s._v("æœ€é•¿æ—¶é—´")]),s._v(", å¦‚æœä¸€ä¸ª dirty page è¶…è¿‡è¿™é‡Œå®šä¹‰çš„æ—¶é—´, é‚£ä¹ˆå†…æ ¸çš„ flush çº¿ç¨‹ä¹Ÿä¼šæŠŠè¿™ä¸ªé¡µé¢å†™å…¥ç£ç›˜.")]),s._v(" "),t("p",[s._v("å¥½äº†, ä»è¿™äº› dirty pages ç›¸å…³çš„å‚æ•°å®šä¹‰, ä½ ä¼šæƒ³åˆ°äº›ä»€ä¹ˆå‘¢?")]),s._v(" "),t("p",[s._v("**è¿›ç¨‹å†™æ“ä½œä¸Šçš„æ—¶é—´æ³¢åŠ¨, åªæœ‰å¯èƒ½æ˜¯å› ä¸º dirty pages çš„æ•°é‡å¾ˆå¤š, å·²ç»è¾¾åˆ°äº†ç¬¬ä¸‰ä¸ªå‚æ•° dirty_ratio çš„å€¼. è¿™æ—¶æ‰§è¡Œå†™æ–‡ä»¶åŠŸèƒ½çš„è¿›ç¨‹å°±ä¼šè¢«æš‚åœ, ç›´åˆ°å†™æ–‡ä»¶çš„æ“ä½œå°†æ•°æ®é¡µé¢å†™å…¥ç£ç›˜, å†™æ–‡ä»¶çš„è¿›ç¨‹æ‰èƒ½ç»§ç»­è¿è¡Œ, æ‰€ä»¥è¿›ç¨‹é‡Œä¸€æ¬¡å†™æ–‡ä»¶æ•°æ®å—çš„æ“ä½œæ—¶é—´ä¼šå¢åŠ . **")]),s._v(" "),t("p",[s._v("åˆšåˆšè¯´çš„åªæ˜¯æ¨ç†, é‚£æƒ…å†µçœŸçš„ä¼šæ˜¯è¿™æ ·å—? å…¶å®å¯ä»¥åœ¨å®¹å™¨ä¸­è¿›ç¨‹ä¸æ–­å†™å…¥æ•°æ®çš„æ—¶å€™, "),t("strong",[s._v("æŸ¥çœ‹èŠ‚ç‚¹ä¸Š dirty pages çš„å®æ—¶æ•°ç›®")]),s._v(". å…·ä½“æ“ä½œå¦‚ä¸‹:")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("watch")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-n")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"cat /proc/vmstat | grep dirty"')]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("å½“èŠ‚ç‚¹å¯ç”¨å†…å­˜æ˜¯ 12GB çš„æ—¶å€™, å‡è®¾ dirty_ratio æ˜¯ 20%, dirty_background_ratio æ˜¯ 10%, é‚£ä¹ˆåœ¨ 1GB memory å®¹å™¨ä¸­å†™ 10GB çš„æ•°æ®, å°±ä¼šçœ‹åˆ°å®ƒå®æ—¶çš„ dirty pages æ•°ç›®, ä¹Ÿ"),t("strong",[s._v("å°±æ˜¯ /proc/vmstat é‡Œçš„ nr_dirty çš„æ•°å€¼")]),s._v(", è¿™ä¸ªæ•°å€¼å¯¹åº”çš„å†…å­˜å¹¶ä¸èƒ½è¾¾åˆ° dirty_ratio æ‰€å çš„å†…å­˜å€¼.")]),s._v(" "),t("p",[t("img",{attrs:{src:"/img/ffa122a6dc84d8093e2f84a08bdfdddb-20230731161430-4tp3agg.png",alt:""}})]),s._v(" "),t("p",[s._v("å…¶å®è¿˜å¯ä»¥å†åšä¸ªå®éªŒ, å°±æ˜¯åœ¨ dirty_bytes å’Œ dirty_background_bytes é‡Œå†™å…¥ä¸€ä¸ªå¾ˆå°çš„å€¼.")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("8192")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" /proc/sys/vm/dirty_bytes\n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("4096")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" /proc/sys/vm/dirty_background_bytes\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])]),t("p",[s._v("ç„¶åå†è®°å½•ä¸€ä¸‹å®¹å™¨ç¨‹åºé‡Œæ¯å†™å…¥ 64KB æ•°æ®å—çš„æ—¶é—´, è¿™æ—¶å€™å°±ä¼šçœ‹åˆ°, æ—¶ä¸æ—¶ä¸€æ¬¡å†™å…¥çš„æ—¶é—´å°±ä¼šè¾¾åˆ° 9ms, è¿™å·²ç»è¿œè¿œé«˜äºä¹‹å‰çœ‹åˆ°çš„ 200us äº†.")]),s._v(" "),t("p",[s._v("å› æ­¤, æˆ‘ä»¬çŸ¥é“äº†è¿™ä¸ª"),t("strong",[s._v("æ—¶é—´çš„æ³¢åŠ¨, å¹¶ä¸æ˜¯å¼ºåˆ¶æŠŠ dirty page å†™å…¥åˆ°ç£ç›˜å¼•èµ·çš„")]),s._v(".")]),s._v(" "),t("h5",{attrs:{id:"_3-è°ƒè¯•é—®é¢˜"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-è°ƒè¯•é—®é¢˜"}},[s._v("#")]),s._v(" 3.è°ƒè¯•é—®é¢˜")]),s._v(" "),t("p",[s._v("é‚£æ¥ä¸‹æ¥è¿˜èƒ½æ€ä¹ˆåˆ†æè¿™ä¸ªé—®é¢˜å‘¢?")]),s._v(" "),t("p",[s._v("å¯ä»¥"),t("strong",[s._v("ç”¨ perf å’Œ ftrace è¿™ä¸¤ä¸ªå·¥å…·")]),s._v(", å¯¹å®¹å™¨é‡Œå†™æ•°æ®å—çš„è¿›ç¨‹åšä¸ª profile, çœ‹çœ‹åˆ°åº•æ˜¯è°ƒç”¨å“ªä¸ª"),t("strong",[s._v("å‡½æ•°")]),s._v("èŠ±è´¹äº†æ¯”è¾ƒé•¿çš„æ—¶é—´. åé¢ä¼šä¸“é—¨ä»‹ç»å¦‚ä½•ä½¿ç”¨ perf, ftrace ç­‰å·¥å…·ä»¥åŠå®ƒä»¬çš„å·¥ä½œåŸç†, åœ¨è¿™é‡Œåªè¦äº†è§£è°ƒè¯•æ€è·¯å°±è¡Œ.")]),s._v(" "),t("p",[s._v("æ€ä¹ˆä½¿ç”¨è¿™ä¸¤ä¸ªå·¥å…·å»å®šä½è€—æ—¶é«˜çš„å‡½æ•°å‘¢? å¤§è‡´æ€è·¯æ˜¯è¿™æ ·çš„: æˆ‘ä»¬å‘ç°å®¹å™¨ä¸­çš„è¿›ç¨‹ç”¨åˆ°äº† write() è¿™ä¸ªå‡½æ•°è°ƒç”¨, ç„¶åå†™ 64KB æ•°æ®å—çš„æ—¶é—´å¢åŠ äº†, è€Œ write() æ˜¯ä¸€ä¸ªç³»ç»Ÿè°ƒç”¨, é‚£éœ€è¦è¿›è¡Œä¸‹é¢è¿™ä¸¤æ­¥æ“ä½œ.")]),s._v(" "),t("p",[s._v("**ç¬¬ä¸€æ­¥, è¦æ‰¾åˆ°å†…æ ¸ä¸­ write() è¿™ä¸ªç³»ç»Ÿè°ƒç”¨å‡½æ•°ä¸‹, åˆè°ƒç”¨äº†å“ªäº›å­å‡½æ•°. ** æƒ³æ‰¾å‡ºä¸»è¦çš„å­å‡½æ•°å¯ä»¥æŸ¥çœ‹ä»£ç , ä¹Ÿå¯ä»¥ç”¨ perf è¿™ä¸ªå·¥å…·æ¥å¾—åˆ°.")]),s._v(" "),t("p",[s._v("ç„¶åæ˜¯**ç¬¬äºŒæ­¥, å¾—åˆ°äº† write() çš„ä¸»è¦å­å‡½æ•°ä¹‹å, å¯ä»¥ç”¨ ftrace è¿™ä¸ªå·¥å…·æ¥ trace è¿™äº›å‡½æ•°çš„æ‰§è¡Œæ—¶é—´, è¿™æ ·å°±å¯ä»¥æ‰¾åˆ°èŠ±è´¹æ—¶é—´æœ€é•¿çš„å‡½æ•°äº†. **")]),s._v(" "),t("p",[s._v("ä¸‹é¢å°±æŒ‰ç…§åˆšæ‰æ¢³ç†çš„æ€è·¯æ¥åšä¸€ä¸‹. é¦–å…ˆæ˜¯ç¬¬ä¸€æ­¥, åœ¨å®¹å™¨å¯åŠ¨å†™ç£ç›˜çš„è¿›ç¨‹å, åœ¨å®¿ä¸»æœºä¸Šå¾—åˆ°è¿™ä¸ªè¿›ç¨‹çš„ pid, ç„¶åè¿è¡Œä¸‹é¢çš„ perf å‘½ä»¤.")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("perf record "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-a")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-g")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-p")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("pid"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("ç­‰å†™ç£ç›˜çš„è¿›ç¨‹é€€å‡ºä¹‹å, è¿™ä¸ª perf record ä¹Ÿå°±åœæ­¢äº†.")]),s._v(" "),t("p",[s._v("è¿™æ—¶å†æ‰§è¡Œ "),t("code",[s._v("perf report")]),s._v("â€‹ æŸ¥çœ‹ç»“æœ. æŠŠ vfs_write() å‡½æ•°å±•å¼€ä¹‹å, å°±å¯ä»¥çœ‹åˆ°, write() è¿™ä¸ªç³»ç»Ÿè°ƒç”¨ä¸‹é¢çš„è°ƒç”¨åˆ°äº†å“ªäº›ä¸»è¦çš„å­å‡½æ•°, åˆ°è¿™é‡Œç¬¬ä¸€æ­¥å°±å®Œæˆäº†.")]),s._v(" "),t("p",[t("img",{attrs:{src:"/img/4a756f36dd2c4a4ee4829e5d66835a8e-20230731161430-sui6afm.png",alt:""}})]),s._v(" "),t("p",[s._v("ä¸‹é¢å†æ¥åšç¬¬äºŒæ­¥, æŠŠä¸»è¦çš„å‡½æ•°å†™å…¥åˆ° ftrace çš„ set_ftrace_filter é‡Œ, ç„¶åæŠŠ ftrace çš„ tracer è®¾ç½®ä¸º function_graph, å¹¶ä¸”"),t("strong",[s._v("æ‰“å¼€ tracing_on å¼€å¯è¿½è¸ª")]),s._v(".")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cd /sys/kernel/debug/tracing")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# echo vfs_write >> set_ftrace_filter")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# echo xfs_file_write_iter >> set_ftrace_filter")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# echo xfs_file_buffered_aio_write >> set_ftrace_filter")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# echo iomap_file_buffered_write")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# echo iomap_file_buffered_write >> set_ftrace_filter")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# echo pagecache_get_page >> set_ftrace_filter")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# echo try_to_free_mem_cgroup_pages >> set_ftrace_filter")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# echo try_charge >> set_ftrace_filter")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# echo mem_cgroup_try_charge >> set_ftrace_filter")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# echo function_graph > current_tracer")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# echo 1 > tracing_on")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br")])]),t("p",[s._v("è¿™äº›è®¾ç½®å®Œæˆä¹‹å, å†è¿è¡Œä¸€ä¸‹å®¹å™¨ä¸­çš„å†™ç£ç›˜ç¨‹åº, åŒæ—¶"),t("strong",[s._v("ä» ftrace çš„ trace_pipe ä¸­è¯»å–å‡ºè¿½è¸ªåˆ°çš„è¿™äº›å‡½æ•°")]),s._v(".")]),s._v(" "),t("p",[s._v("è¿™æ—¶å¯ä»¥çœ‹åˆ°, å½“"),t("strong",[s._v("éœ€è¦ç”³è¯· Page Cache é¡µé¢çš„æ—¶å€™, write() ç³»ç»Ÿè°ƒç”¨ä¼šåå¤åœ°è°ƒç”¨ mem_cgroup_try_charge()")]),s._v(" , å¹¶ä¸”åœ¨é‡Šæ”¾é¡µé¢çš„æ—¶å€™, å‡½æ•° do_try_to_free_pages() èŠ±è´¹çš„æ—¶é—´ç‰¹åˆ«é•¿, æœ‰ 50+us(æ—¶é—´å•ä½, micro-seconds)è¿™ä¹ˆå¤š.")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("               "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token function-name function"}},[s._v("vfs_write")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("               "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("    xfs_file_write_iter "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("xfs"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("               "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("      xfs_file_buffered_aio_write "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("xfs"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("               "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("        "),t("span",{pre:!0,attrs:{class:"token function-name function"}},[s._v("iomap_file_buffered_write")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("               "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("          "),t("span",{pre:!0,attrs:{class:"token function-name function"}},[s._v("pagecache_get_page")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("               "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("            "),t("span",{pre:!0,attrs:{class:"token function-name function"}},[s._v("mem_cgroup_try_charge")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.338")]),s._v(" us    "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("              try_charge"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.791")]),s._v(" us    "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("            "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("4.127")]),s._v(" us    "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("          "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\nâ€¦\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("               "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("          "),t("span",{pre:!0,attrs:{class:"token function-name function"}},[s._v("pagecache_get_page")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("               "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("            "),t("span",{pre:!0,attrs:{class:"token function-name function"}},[s._v("mem_cgroup_try_charge")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("               "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("              "),t("span",{pre:!0,attrs:{class:"token function-name function"}},[s._v("try_charge")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("               "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("                "),t("span",{pre:!0,attrs:{class:"token function-name function"}},[s._v("try_to_free_mem_cgroup_pages")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" + "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("52.798")]),s._v(" us   "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("                  do_try_to_free_pages"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" + "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("53.958")]),s._v(" us   "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("                "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" + "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("54.751")]),s._v(" us   "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("              "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" + "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("55.188")]),s._v(" us   "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("            "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" + "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("56.742")]),s._v(" us   "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("          "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\nâ€¦\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("109.925")]),s._v(" us  "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("        "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("110.558")]),s._v(" us  "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("      "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("110.984")]),s._v(" us  "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("111.515")]),s._v(" us  "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br")])]),t("p",[s._v("çœ‹åˆ°è¿™ä¸ª ftrace çš„ç»“æœ, ä½ æ˜¯ä¸æ˜¯ä¼šæƒ³åˆ°, æˆ‘ä»¬åœ¨å®¹å™¨å†…å­˜é‚£ä¸€è®²ä¸­æåˆ°çš„ Page Cahe å‘¢? æ˜¯çš„, è¿™ä¸ªé—®é¢˜çš„ç¡®å’Œ Page Cache æœ‰å…³, "),t("strong",[s._v("Linux ä¼šæŠŠæ‰€æœ‰çš„ç©ºé—²å†…å­˜åˆ©ç”¨èµ·æ¥, ä¸€æ—¦æœ‰ Buffered I/O, è¿™äº›å†…å­˜éƒ½ä¼šè¢«ç”¨ä½œ Page Cache")]),s._v(". å½“å®¹å™¨åŠ äº† Memory Cgroup é™åˆ¶äº†å†…å­˜ä¹‹å, å¯¹äºå®¹å™¨é‡Œçš„ Buffered I/O, "),t("strong",[s._v("å°±åªèƒ½ä½¿ç”¨å®¹å™¨ä¸­å…è®¸ä½¿ç”¨çš„æœ€å¤§å†…å­˜æ¥åš Page Cache")]),s._v(".")]),s._v(" "),t("p",[t("mark",[s._v("**é‚£ä¹ˆå¦‚æœå®¹å™¨åœ¨åšå†…å­˜é™åˆ¶çš„æ—¶å€™, Cgroup ä¸­ memory.limit_in_bytes è®¾ç½®å¾—æ¯”è¾ƒå°, è€Œå®¹å™¨ä¸­çš„è¿›ç¨‹åˆæœ‰å¾ˆå¤§é‡çš„ I/O, è¿™æ ·ç”³è¯·æ–°çš„ Page Cache å†…å­˜çš„æ—¶å€™, åˆä¼šä¸æ–­é‡Šæ”¾è€çš„å†…å­˜é¡µé¢, è¿™äº›æ“ä½œå°±ä¼šå¸¦æ¥é¢å¤–çš„ç³»ç»Ÿå¼€é”€äº†. **")])]),s._v(" "),t("h5",{attrs:{id:"_4-é‡ç‚¹æ€»ç»“-10"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_4-é‡ç‚¹æ€»ç»“-10"}},[s._v("#")]),s._v(" 4.é‡ç‚¹æ€»ç»“")]),s._v(" "),t("p",[s._v("æœ¬èŠ‚è®¨è®ºçš„é—®é¢˜æ˜¯åœ¨å®¹å™¨ä¸­ç”¨ Buffered I/O æ–¹å¼å†™æ–‡ä»¶çš„æ—¶å€™, ä¼šå‡ºç°å†™å…¥æ—¶é—´æ³¢åŠ¨çš„é—®é¢˜.")]),s._v(" "),t("p",[s._v("ç”±äºè¿™æ˜¯ Buffered I/O æ–¹å¼, å¯¹äºå†™å…¥æ–‡ä»¶ä¼šå…ˆå†™åˆ°å†…å­˜é‡Œ, è¿™æ ·å°±äº§ç”Ÿäº† dirty pages, æ‰€ä»¥å…ˆç ”ç©¶äº†ä¸€ä¸‹ Linux å¯¹ dirty pages çš„å›æ”¶æœºåˆ¶æ˜¯å¦ä¼šå½±å“åˆ°å®¹å™¨ä¸­å†™å…¥æ•°æ®çš„æ³¢åŠ¨.")]),s._v(" "),t("p",[s._v("åœ¨è¿™é‡Œæœ€ä¸»è¦çš„æ˜¯ç†è§£è¿™ä¸¤ä¸ªå‚æ•°, "),t("strong",[s._v("dirty_background_ratio å’Œ dirty_ratio")]),s._v(", è¿™ä¸¤ä¸ªå€¼éƒ½æ˜¯ç›¸å¯¹äºèŠ‚ç‚¹å¯ç”¨å†…å­˜çš„ç™¾åˆ†æ¯”å€¼.")]),s._v(" "),t("p",[t("mark",[s._v("**å½“ dirty pages æ•°é‡è¶…è¿‡ dirty_background_ratio å¯¹åº”çš„å†…å­˜é‡çš„æ—¶å€™, å†…æ ¸ flush çº¿ç¨‹å°±ä¼šå¼€å§‹æŠŠ dirty pages å†™å…¥ç£ç›˜ ; å½“ dirty pages æ•°é‡è¶…è¿‡ dirty_ratio å¯¹åº”çš„å†…å­˜é‡, è¿™æ—¶å€™ç¨‹åºå†™æ–‡ä»¶çš„å‡½æ•°è°ƒç”¨ write() å°±ä¼šè¢«é˜»å¡ä½, ç›´åˆ°è¿™æ¬¡è°ƒç”¨çš„ dirty pages å…¨éƒ¨å†™å…¥åˆ°ç£ç›˜. **")])]),s._v(" "),t("p",[s._v("åœ¨èŠ‚ç‚¹æ˜¯å¤§å†…å­˜å®¹é‡, å¹¶ä¸” dirty_ratio ä¸ºç³»ç»Ÿç¼ºçœå€¼ 20%, dirty_background_ratio æ˜¯ç³»ç»Ÿç¼ºçœå€¼ 10% çš„æƒ…å†µä¸‹, é€šè¿‡è§‚å¯Ÿ /proc/vmstat ä¸­çš„ nr_dirty æ•°å€¼å¯ä»¥å‘ç°, "),t("mark",[t("strong",[s._v("dirty pages ä¸ä¼šé˜»å¡è¿›ç¨‹çš„ Buffered I/O å†™æ–‡ä»¶æ“ä½œ")])]),s._v(".")]),s._v(" "),t("p",[s._v("æ‰€ä»¥åšäº†å¦ä¸€ç§å°è¯•, ä½¿ç”¨ perf å’Œ ftrace å·¥å…·å¯¹å®¹å™¨ä¸­çš„å†™æ–‡ä»¶è¿›ç¨‹è¿›è¡Œ profile. ç”¨ perf å¾—åˆ°äº†ç³»ç»Ÿè°ƒç”¨ write() åœ¨å†…æ ¸ä¸­çš„ä¸€ç³»åˆ—å­å‡½æ•°è°ƒç”¨, å†ç”¨ ftrace æ¥æŸ¥çœ‹è¿™äº›å­å‡½æ•°çš„è°ƒç”¨æ—¶é—´.")]),s._v(" "),t("p",[t("mark",[s._v("**æ ¹æ® ftrace çš„ç»“æœå‘ç°å†™æ•°æ®åˆ° Page Cache çš„æ—¶å€™, éœ€è¦ä¸æ–­åœ°å»é‡Šæ”¾åŸæœ‰çš„é¡µé¢, è¿™ä¸ªæ—¶é—´å¼€é”€æ˜¯æœ€å¤§çš„. é€ æˆå®¹å™¨ä¸­ Buffered I/O write() ä¸ç¨³å®šçš„åŸå› , æ­£æ˜¯å®¹å™¨åœ¨é™åˆ¶å†…å­˜ä¹‹å, Page Cache çš„æ•°é‡è¾ƒå°å¹¶ä¸”ä¸æ–­ç”³è¯·é‡Šæ”¾. **")])]),s._v(" "),t("p",[s._v("å…¶å®è¿™ä¸ªé—®é¢˜ä¹Ÿæé†’äº†æˆ‘ä»¬: "),t("mark",[t("strong",[s._v("åœ¨å¯¹å®¹å™¨åš Memory Cgroup é™åˆ¶å†…å­˜å¤§å°çš„æ—¶å€™, ä¸ä»…è¦è€ƒè™‘å®¹å™¨ä¸­è¿›ç¨‹å®é™…ä½¿ç”¨çš„å†…å­˜é‡, è¿˜è¦è€ƒè™‘å®¹å™¨ä¸­ç¨‹åº I/O çš„é‡, åˆç†é¢„ç•™è¶³å¤Ÿçš„å†…å­˜ä½œä¸º Buffered I/O çš„ Page Cache")])]),s._v(".")]),s._v(" "),t("p",[s._v("æ¯”å¦‚, å¦‚æœçŸ¥é“éœ€è¦åå¤è¯»å†™æ–‡ä»¶çš„å¤§å°, å¹¶ä¸”åœ¨å†…å­˜è¶³å¤Ÿçš„æƒ…å†µä¸‹, é‚£ä¹ˆ Memory Cgroup çš„å†…å­˜é™åˆ¶å¯ä»¥è¶…è¿‡è¿™ä¸ªæ–‡ä»¶çš„å¤§å°.")]),s._v(" "),t("p",[s._v("è¿˜æœ‰ä¸€ä¸ªè§£å†³æ€è·¯æ˜¯, åœ¨ç¨‹åºä¸­è‡ªå·±ç®¡ç†æ–‡ä»¶çš„ cache å¹¶ä¸”è°ƒç”¨ Direct I/O æ¥è¯»å†™æ–‡ä»¶, è¿™æ ·æ‰ä¼šå¯¹åº”ç”¨ç¨‹åºçš„æ€§èƒ½æœ‰ä¸€ä¸ªæ›´å¥½çš„é¢„æœŸ.")]),s._v(" "),t("h3",{attrs:{id:"å®¹å™¨ç½‘ç»œ"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#å®¹å™¨ç½‘ç»œ"}},[s._v("#")]),s._v(" å®¹å™¨ç½‘ç»œ")]),s._v(" "),t("h4",{attrs:{id:"_15-å®¹å™¨ç½‘ç»œ-æˆ‘ä¿®æ”¹äº†-proc-sys-netä¸‹çš„å‚æ•°-ä¸ºä»€ä¹ˆåœ¨å®¹å™¨ä¸­ä¸èµ·æ•ˆ"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_15-å®¹å™¨ç½‘ç»œ-æˆ‘ä¿®æ”¹äº†-proc-sys-netä¸‹çš„å‚æ•°-ä¸ºä»€ä¹ˆåœ¨å®¹å™¨ä¸­ä¸èµ·æ•ˆ"}},[s._v("#")]),s._v(" 15 | å®¹å™¨ç½‘ç»œ:æˆ‘ä¿®æ”¹äº†/proc/sys/netä¸‹çš„å‚æ•°,ä¸ºä»€ä¹ˆåœ¨å®¹å™¨ä¸­ä¸èµ·æ•ˆ?")]),s._v(" "),t("p",[s._v("æœ¬èŠ‚è¿›å…¥åˆ°äº†å®¹å™¨ç½‘ç»œè¿™ä¸ªæ¨¡å—. å®¹å™¨ç½‘ç»œæœ€æ˜æ˜¾çš„ä¸€ä¸ªç‰¹å¾å°±æ˜¯å®ƒ"),t("strong",[s._v("æœ‰è‡ªå·±çš„ Network Namespace äº†")]),s._v(". ç¬¬ä¸€è®²é‡Œå°±æåˆ°è¿‡ "),t("strong",[s._v("Network Namespace è´Ÿè´£ç®¡ç†ç½‘ç»œç¯å¢ƒçš„éš”ç¦»")]),s._v(". æœ¬èŠ‚å°±æ·±å…¥åœ°è®¨è®ºä¸€ä¸‹å’Œ Network Namespace ç›¸å…³çš„ä¸€ä¸ªé—®é¢˜â€”â€”å®¹å™¨ä¸­çš„ç½‘ç»œå‚æ•°.")]),s._v(" "),t("p",[s._v("å’Œä¹‹å‰çš„æ€è·¯ä¸€æ ·, å…ˆæ¥çœ‹ä¸€ä¸ªé—®é¢˜. ç„¶ååœ¨è§£å†³é—®é¢˜çš„è¿‡ç¨‹ä¸­, æ›´æ·±å…¥åœ°ç†è§£å®¹å™¨çš„ç½‘ç»œå‚æ•°é…ç½®.")]),s._v(" "),t("h5",{attrs:{id:"_1-é—®é¢˜å†ç°-10"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-é—®é¢˜å†ç°-10"}},[s._v("#")]),s._v(" 1.é—®é¢˜å†ç°")]),s._v(" "),t("p",[s._v("åœ¨å®¹å™¨ä¸­è¿è¡Œçš„åº”ç”¨ç¨‹åº, å¦‚æœéœ€è¦ç”¨åˆ° tcp/ip åè®®æ ˆçš„è¯, å¸¸å¸¸éœ€è¦ä¿®æ”¹ä¸€äº›"),t("strong",[s._v("ç½‘ç»œå‚æ•°")]),s._v("(å†…æ ¸ä¸­ç½‘ç»œåè®®æ ˆçš„å‚æ•°). å¾ˆå¤§ä¸€éƒ¨åˆ†ç½‘ç»œå‚æ•°éƒ½"),t("strong",[s._v("åœ¨ /proc æ–‡ä»¶ç³»ç»Ÿä¸‹çš„/proc/sys/net/ç›®å½•é‡Œ")]),s._v(".")]),s._v(" "),t("p",[t("mark",[s._v('**ä¿®æ”¹è¿™äº›å‚æ•°ä¸»è¦æœ‰ä¸¤ç§æ–¹æ³•: ä¸€ç§æ–¹æ³•æ˜¯ç›´æ¥åˆ° /proc æ–‡ä»¶ç³»ç»Ÿä¸‹çš„ "/proc/sys/net/" ç›®å½•é‡Œå¯¹å‚æ•°åšä¿®æ”¹; è¿˜æœ‰ä¸€ç§æ–¹æ³•æ˜¯ä½¿ç”¨ sysctl è¿™ä¸ªå·¥å…·æ¥ä¿®æ”¹. **')])]),s._v(" "),t("p",[s._v("åœ¨å¯åŠ¨å®¹å™¨ä¹‹å‰, æ ¹æ®éœ€è¦æˆ‘ä»¬åœ¨å®¿ä¸»æœºä¸Šå·²ç»ä¿®æ”¹è¿‡äº†å‡ ä¸ªå‚æ•°, ä¹Ÿå°±æ˜¯è¯´è¿™äº›å‚æ•°çš„å€¼å·²ç»ä¸æ˜¯å†…æ ¸é‡ŒåŸæ¥çš„ç¼ºçœå€¼äº†.")]),s._v(" "),t("p",[s._v("æ¯”å¦‚æ”¹äº†ä¸‹é¢çš„å‡ ä¸ªå‚æ•°:")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# # The default value:")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cat /proc/sys/net/ipv4/tcp_congestion_control")]),s._v("\ncubic\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cat /proc/sys/net/ipv4/tcp_keepalive_time")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("7200")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cat /proc/sys/net/ipv4/tcp_keepalive_intvl")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("75")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cat /proc/sys/net/ipv4/tcp_keepalive_probes")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("9")]),s._v("\n \n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# # To update the value:")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# echo bbr > /proc/sys/net/ipv4/tcp_congestion_control")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# echo 600 > /proc/sys/net/ipv4/tcp_keepalive_time")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# echo 10 > /proc/sys/net/ipv4/tcp_keepalive_intvl")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# echo 6 > /proc/sys/net/ipv4/tcp_keepalive_probes")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#")]),s._v("\n \n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# # Double check the value after update:")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cat /proc/sys/net/ipv4/tcp_congestion_control")]),s._v("\nbbr\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cat /proc/sys/net/ipv4/tcp_keepalive_time")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("600")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cat /proc/sys/net/ipv4/tcp_keepalive_intvl")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cat /proc/sys/net/ipv4/tcp_keepalive_probes")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("6")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br"),t("span",{staticClass:"line-number"},[s._v("25")]),t("br"),t("span",{staticClass:"line-number"},[s._v("26")]),t("br")])]),t("p",[s._v("ç„¶åå¯åŠ¨ä¸€ä¸ªå®¹å™¨, å†æ¥"),t("strong",[s._v("æŸ¥çœ‹ä¸€ä¸‹å®¹å™¨é‡Œè¿™äº›å‚æ•°çš„å€¼")]),s._v(". ä½ å¯ä»¥å…ˆæƒ³æƒ³, å®¹å™¨é‡Œè¿™äº›å‚æ•°çš„å€¼ä¼šæ˜¯ä»€ä¹ˆ? æˆ‘æœ€åˆè§‰å¾—å®¹å™¨é‡Œå‚æ•°å€¼åº”è¯¥ä¼šç»§æ‰¿å®¿ä¸»æœº Network Namesapce é‡Œçš„å€¼, å®é™…ä¸Šæ˜¯ä¸æ˜¯è¿™æ ·å‘¢?")]),s._v(" "),t("p",[s._v("è¿˜æ˜¯å…ˆæŒ‰ä¸‹é¢çš„è„šæœ¬, å¯åŠ¨å®¹å™¨, ç„¶åè¿è¡Œ "),t("code",[s._v("docker exec")]),s._v("â€‹ å‘½ä»¤ä¸€èµ·çœ‹ä¸€ä¸‹:")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# docker run -d --name net_para centos:8.1.1911 sleep 3600")]),s._v("\ndeec6082bac7b336fa28d0f87d20e1af21a784e4ef11addfc2b9146a9fa77e95\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# docker exec -it net_para bash")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@deec6082bac7 /"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cat /proc/sys/net/ipv4/tcp_congestion_control")]),s._v("\nbbr\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@deec6082bac7 /"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cat /proc/sys/net/ipv4/tcp_keepalive_time")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("7200")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@deec6082bac7 /"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cat /proc/sys/net/ipv4/tcp_keepalive_intvl")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("75")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@deec6082bac7 /"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cat /proc/sys/net/ipv4/tcp_keepalive_probes")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("9")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br")])]),t("p",[s._v("ä»è¿™ä¸ªç»“æœçœ‹åˆ°, tcp_congestion_control çš„å€¼æ˜¯ bbr, å’Œå®¿ä¸»æœº Network Namespace é‡Œçš„å€¼æ˜¯ä¸€æ ·çš„, è€Œå…¶ä»–ä¸‰ä¸ª tcp keepalive ç›¸å…³çš„å€¼, éƒ½"),t("strong",[s._v("ä¸æ˜¯å®¿ä¸»æœº Network Namespace é‡Œè®¾ç½®çš„å€¼, è€Œæ˜¯åŸæ¥ç³»ç»Ÿé‡Œçš„ç¼ºçœå€¼")]),s._v("äº†.")]),s._v(" "),t("p",[s._v("é‚£ä¸ºä»€ä¹ˆä¼šè¿™æ ·å‘¢? åœ¨åˆ†æè¿™ä¸ªé—®é¢˜ä¹‹å‰, éœ€è¦å…ˆæ¥çœ‹çœ‹ Network Namespace è¿™ä¸ªæ¦‚å¿µ.")]),s._v(" "),t("h5",{attrs:{id:"_2-çŸ¥è¯†è¯¦è§£-6"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-çŸ¥è¯†è¯¦è§£-6"}},[s._v("#")]),s._v(" 2.çŸ¥è¯†è¯¦è§£")]),s._v(" "),t("h6",{attrs:{id:"_1-å¦‚ä½•ç†è§£network-namespace"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-å¦‚ä½•ç†è§£network-namespace"}},[s._v("#")]),s._v(" (1)å¦‚ä½•ç†è§£Network Namespace?")]),s._v(" "),t("p",[s._v("å¯¹äº Network Namespace, ä»å­—é¢ä¸Šå»ç†è§£çš„è¯, å¯ä»¥çŸ¥é“å®ƒæ˜¯åœ¨"),t("strong",[s._v("ä¸€å° Linux èŠ‚ç‚¹ä¸Šå¯¹ç½‘ç»œçš„éš”ç¦»")]),s._v(", ä¸è¿‡å®ƒå…·ä½“åˆ°åº•éš”ç¦»äº†å“ªéƒ¨åˆ†çš„ç½‘ç»œèµ„æºå‘¢?")]),s._v(" "),t("p",[s._v("è¿˜æ˜¯å…ˆæ¥çœ‹çœ‹æ“ä½œæ‰‹å†Œ, åœ¨ Linux Programmerâ€™s Manual é‡Œå¯¹ Network Namespace æœ‰ä¸€ä¸ªæ®µç®€çŸ­çš„æè¿°, åœ¨é‡Œé¢å°±åˆ—å‡ºäº†æœ€ä¸»è¦çš„å‡ éƒ¨åˆ†èµ„æº, å®ƒä»¬éƒ½æ˜¯é€šè¿‡ Network Namespace éš”ç¦»çš„.")]),s._v(" "),t("p",[s._v("æˆ‘æŠŠè¿™äº›èµ„æºåšäº†ä¸€ä¸ªæ¢³ç†:")]),s._v(" "),t("p",[s._v("ç¬¬ä¸€ç§, "),t("strong",[s._v("ç½‘ç»œè®¾å¤‡")]),s._v(", è¿™é‡ŒæŒ‡çš„æ˜¯ lo, eth0 ç­‰ç½‘ç»œè®¾å¤‡. é€šè¿‡ "),t("code",[s._v("ip link")]),s._v("â€‹ å‘½ä»¤çœ‹åˆ°å®ƒä»¬.")]),s._v(" "),t("p",[s._v("ç¬¬äºŒç§æ˜¯ "),t("strong",[s._v("IPv4 å’Œ IPv6 åè®®æ ˆ")]),s._v(". ä»è¿™é‡Œå¯ä»¥çŸ¥é“, IP å±‚ä»¥åŠä¸Šé¢çš„ TCP å’Œ UPD åè®®æ ˆä¹Ÿæ˜¯æ¯ä¸ª Namespace ç‹¬ç«‹å·¥ä½œçš„. æ‰€ä»¥ IP, TCP, PUD çš„å¾ˆå¤šåè®®, å®ƒä»¬çš„ç›¸å…³å‚æ•°ä¹Ÿæ˜¯"),t("strong",[s._v("æ¯ä¸ª Namespace ç‹¬ç«‹")]),s._v("çš„, è¿™äº›å‚æ•°å¤§å¤šæ•°éƒ½åœ¨ /proc/sys/net/ ç›®å½•ä¸‹é¢, åŒæ—¶ä¹ŸåŒ…æ‹¬äº† TCP å’Œ UPD çš„ port èµ„æº.")]),s._v(" "),t("p",[s._v("ç¬¬ä¸‰ç§, "),t("strong",[s._v("IP è·¯ç”±è¡¨")]),s._v(", è¿™ä¸ªèµ„æºä¹Ÿæ˜¯æ¯”è¾ƒå¥½ç†è§£çš„, å¯ä»¥åœ¨ä¸åŒçš„ Network Namespace è¿è¡Œ "),t("code",[s._v("ip route")]),s._v("â€‹ å‘½ä»¤, å°±èƒ½çœ‹åˆ°ä¸åŒçš„è·¯ç”±è¡¨äº†.")]),s._v(" "),t("p",[s._v("ç¬¬å››ç§æ˜¯"),t("strong",[s._v("é˜²ç«å¢™è§„åˆ™")]),s._v(", å…¶å®è¿™é‡Œè¯´çš„å°±æ˜¯ "),t("strong",[s._v("iptables è§„åˆ™")]),s._v("äº†, æ¯ä¸ª Namespace é‡Œéƒ½å¯ä»¥ç‹¬ç«‹é…ç½® iptables è§„åˆ™.")]),s._v(" "),t("p",[s._v("æœ€åä¸€ç§æ˜¯"),t("strong",[s._v("ç½‘ç»œçš„çŠ¶æ€ä¿¡æ¯")]),s._v(", è¿™äº›ä¿¡æ¯å¯ä»¥ä» /proc/net å’Œ /sys/class/net é‡Œå¾—åˆ°, è¿™é‡Œçš„çŠ¶æ€åŸºæœ¬ä¸ŠåŒ…æ‹¬äº†å‰é¢ 4 ç§èµ„æºçš„çš„çŠ¶æ€ä¿¡æ¯.")]),s._v(" "),t("h6",{attrs:{id:"_2-namespaceçš„æ“ä½œ"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-namespaceçš„æ“ä½œ"}},[s._v("#")]),s._v(" (2)Namespaceçš„æ“ä½œ")]),s._v(" "),t("p",[s._v("é‚£æ€ä¹ˆå»ºç«‹ä¸€ä¸ªæ–°çš„ Network Namespace å‘¢?")]),s._v(" "),t("p",[s._v("**å¯ä»¥é€šè¿‡ç³»ç»Ÿè°ƒç”¨ clone() æˆ–è€… unshare() è¿™ä¸¤ä¸ªå‡½æ•°æ¥å»ºç«‹æ–°çš„ Network Namespace. **")]),s._v(" "),t("p",[s._v("ä¸‹é¢ä¼šè®²ä¸¤ä¸ªä¾‹å­, å¸¦ä½ ä½“ä¼šä¸€ä¸‹è¿™ä¸¤ä¸ªæ–¹æ³•å…·ä½“æ€ä¹ˆç”¨.")]),s._v(" "),t("p",[s._v("ç¬¬ä¸€ç§æ–¹æ³•æ˜¯åœ¨"),t("strong",[s._v("æ–°çš„è¿›ç¨‹åˆ›å»ºçš„æ—¶å€™, ä¼´éšæ–°è¿›ç¨‹å»ºç«‹, åŒæ—¶ä¹Ÿå»ºç«‹å‡ºæ–°çš„ Network Namespace")]),s._v(". è¿™ä¸ªæ–¹æ³•, å…¶å®å°±æ˜¯é€šè¿‡ clone() ç³»ç»Ÿè°ƒç”¨"),t("strong",[s._v("å¸¦ä¸Š CLONE_NEWNET flag")]),s._v(" æ¥å®ç°çš„.")]),s._v(" "),t("p",[s._v("Clone å»ºç«‹å‡ºæ¥ä¸€ä¸ªæ–°çš„è¿›ç¨‹, è¿™ä¸ªæ–°çš„è¿›ç¨‹æ‰€åœ¨çš„ Network Namespace ä¹Ÿæ˜¯æ–°çš„. ç„¶åæ‰§è¡Œ "),t("code",[s._v("ip link")]),s._v("â€‹ å‘½ä»¤æŸ¥çœ‹ Namespace é‡Œçš„ç½‘ç»œè®¾å¤‡, å°±å¯ä»¥ç¡®è®¤ä¸€ä¸ªæ–°çš„ Network Namespace å·²ç»å»ºç«‹å¥½äº†.")]),s._v(" "),t("p",[s._v("å…·ä½“æ“ä½œå¯ä»¥çœ‹ä¸€ä¸‹è¿™æ®µä»£ç .")]),s._v(" "),t("div",{staticClass:"language-c line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-c"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("new_netns")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("void")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("para"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("printf")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"New Namespace Devices:\\n"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("system")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"ip link"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("printf")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"\\n\\n"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n \n    "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("sleep")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("100")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n \n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("main")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("void")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("pid_t")]),s._v(" pid"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n \n    "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("printf")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Host Namespace Devices:\\n"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("system")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"ip link"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("printf")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"\\n\\n"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n \n    pid "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("clone")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("new_netns"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" stack "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),s._v(" STACK_SIZE"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" CLONE_NEWNET "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" SIGCHLD"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token constant"}},[s._v("NULL")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("pid "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("mark"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n                "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("errExit")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"clone"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n \n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("waitpid")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("pid"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token constant"}},[s._v("NULL")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("mark"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n                "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("errExit")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"waitpid"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n \n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br"),t("span",{staticClass:"line-number"},[s._v("25")]),t("br"),t("span",{staticClass:"line-number"},[s._v("26")]),t("br"),t("span",{staticClass:"line-number"},[s._v("27")]),t("br"),t("span",{staticClass:"line-number"},[s._v("28")]),t("br")])]),t("p",[s._v("ç¬¬äºŒç§æ–¹æ³•å°±æ˜¯"),t("strong",[s._v("è°ƒç”¨ unshare() è¿™ä¸ªç³»ç»Ÿè°ƒç”¨æ¥ç›´æ¥æ”¹å˜å½“å‰è¿›ç¨‹çš„ Network Namespace")]),s._v(", å¯ä»¥çœ‹ä¸€ä¸‹è¿™æ®µä»£ç .")]),s._v(" "),t("div",{staticClass:"language-c line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-c"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("main")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("void")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("pid_t")]),s._v(" pid"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n \n    "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("printf")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Host Namespace Devices:\\n"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("system")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"ip link"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("printf")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"\\n\\n"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n \n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("unshare")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("CLONE_NEWNET"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n                "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("errExit")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"unshare"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n \n    "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("printf")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"New Namespace Devices:\\n"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("system")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"ip link"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("printf")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"\\n\\n"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n \n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br")])]),t("p",[s._v("å…¶å®ä¸ä»…æ˜¯ Network Namespace, "),t("strong",[s._v("å…¶å®ƒçš„ Namespace ä¹Ÿæ˜¯é€šè¿‡ clone() æˆ–è€… unshare() ç³»ç»Ÿè°ƒç”¨æ¥å»ºç«‹çš„")]),s._v(". è€Œåˆ›å»ºå®¹å™¨çš„ç¨‹åº, æ¯”å¦‚ runC ä¹Ÿæ˜¯ç”¨ unshare() ç»™æ–°å»ºçš„å®¹å™¨å»ºç«‹ Namespace çš„. è¿™é‡Œç®€å•è¯´ä¸€ä¸‹ runC æ˜¯ä»€ä¹ˆ, æˆ‘ä»¬ç”¨ Docker æˆ–è€… containerd å»å¯åŠ¨å®¹å™¨, æœ€åéƒ½ä¼š"),t("strong",[s._v("è°ƒç”¨ runC åœ¨ Linux ä¸­æŠŠå®¹å™¨å¯åŠ¨èµ·æ¥")]),s._v(".")]),s._v(" "),t("p",[s._v("é™¤äº†åœ¨ä»£ç ä¸­ç”¨ç³»ç»Ÿè°ƒç”¨æ¥å»ºç«‹ Network Namespace, ä¹Ÿå¯ä»¥ç”¨å‘½ä»¤è¡Œå·¥å…·æ¥å»ºç«‹ Network Namespace. æ¯”å¦‚ç”¨ "),t("code",[s._v("ip netns")]),s._v("â€‹ å‘½ä»¤, åœ¨ä¸‹ä¸€è®²å­¦ä¹ å®¹å™¨ç½‘ç»œé…ç½®çš„æ—¶å€™å‘¢, ä¼šç”¨åˆ° "),t("code",[s._v("ip netns")]),s._v("â€‹, è¿™é‡Œå…ˆæœ‰ä¸ªå°è±¡å°±è¡Œ.")]),s._v(" "),t("p",[s._v("åœ¨ Network Namespace åˆ›å»ºå¥½äº†ä¹‹å, å¯ä»¥åœ¨å®¿ä¸»æœºä¸Šè¿è¡Œ "),t("code",[s._v("lsns -t net")]),s._v("â€‹ è¿™ä¸ªå‘½ä»¤æ¥æŸ¥çœ‹ç³»ç»Ÿé‡Œå·²æœ‰çš„ Network Namespace. å½“ç„¶, "),t("code",[s._v("lsns")]),s._v("â€‹ ä¹Ÿå¯ä»¥ç”¨æ¥æŸ¥çœ‹å…¶å®ƒ Namespace. ç”¨ "),t("code",[s._v("lsns")]),s._v("â€‹ æŸ¥çœ‹å·²æœ‰çš„ Namespace å, è¿˜å¯ä»¥ç”¨ "),t("code",[s._v("nsenter")]),s._v("â€‹ è¿™ä¸ªå‘½ä»¤è¿›å…¥åˆ°æŸä¸ª Network Namespace é‡Œ, å…·ä½“å»æŸ¥çœ‹è¿™ä¸ª Namespace é‡Œçš„ç½‘ç»œé…ç½®.")]),s._v(" "),t("p",[s._v("æ¯”å¦‚ä¸‹é¢çš„è¿™ä¸ªä¾‹å­, ç”¨ä¹‹å‰çš„ clone() çš„ä¾‹å­é‡Œçš„ä»£ç , ç¼–è¯‘å‡º clone-ns è¿™ä¸ªç¨‹åº, è¿è¡Œåå†ä½¿ç”¨ "),t("code",[s._v("lsns")]),s._v("â€‹ æŸ¥çœ‹æ–°å»ºçš„ Network Namespace, å¹¶ä¸”ç”¨ "),t("code",[s._v("nsenter")]),s._v("â€‹ è¿›å…¥åˆ°è¿™ä¸ª Namespace, æŸ¥çœ‹é‡Œé¢çš„ lo device.")]),s._v(" "),t("p",[s._v("å…·ä½“æ“ä½œå¯ä»¥å‚è€ƒä¸‹é¢çš„ä»£ç :")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ./clone-ns &")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("7732")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# Host Namespace Devices:")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(": lo: "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("LOOPBACK,UP,LOWER_UP"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" mtu "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("65536")]),s._v(" qdisc noqueue state UNKNOWN mode DEFAULT group default qlen "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1000")]),s._v("\n    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(": eth0: "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("BROADCAST,MULTICAST,UP,LOWER_UP"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" mtu "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1500")]),s._v(" qdisc fq_codel state UP mode DEFAULT group default qlen "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1000")]),s._v("\n    link/ether "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("74")]),s._v(":db:d1:80:54:14 brd ff:ff:ff:ff:ff:ff\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v(": docker0: "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("NO-CARRIER,BROADCAST,MULTICAST,UP"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" mtu "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1500")]),s._v(" qdisc noqueue state DOWN mode DEFAULT group default\n    link/ether 02:42:0c:ff:2b:77 brd ff:ff:ff:ff:ff:ff\n \n \nNew Namespace Devices:\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(": lo: "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("LOOPBACK"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" mtu "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("65536")]),s._v(" qdisc noop state DOWN mode DEFAULT group default qlen "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1000")]),s._v("\n    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00\n \n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# lsns -t net")]),s._v("\n        NS TYPE NPROCS   PID "),t("span",{pre:!0,attrs:{class:"token environment constant"}},[s._v("USER")]),s._v("    NETNSID NSFS COMMAND\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("4026531992")]),s._v(" net     "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("283")]),s._v("     "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" root unassigned      /usr/lib/systemd/systemd --switched-root "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--system")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--deserialize")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("16")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("4026532241")]),s._v(" net       "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("7734")]),s._v(" root unassigned      ./clone-ns\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# nsenter -t 7734 -n ip addr")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(": lo: "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("LOOPBACK"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" mtu "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("65536")]),s._v(" qdisc noop state DOWN group default qlen "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1000")]),s._v("\n    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br")])]),t("h5",{attrs:{id:"_3-è§£å†³é—®é¢˜-7"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-è§£å†³é—®é¢˜-7"}},[s._v("#")]),s._v(" 3.è§£å†³é—®é¢˜")]),s._v(" "),t("p",[s._v("é‚£ç†è§£äº† Network Namespace ä¹‹å, å†æ¥çœ‹çœ‹è¿™ä¸€è®²æœ€å¼€å§‹çš„é—®é¢˜, åº”è¯¥"),t("strong",[s._v("æ€ä¹ˆæ¥è®¾ç½®å®¹å™¨é‡Œçš„ç½‘ç»œç›¸å…³å‚æ•°")]),s._v("å‘¢?")]),s._v(" "),t("p",[s._v("é¦–å…ˆè¦é¿å…èµ°å…¥è¯¯åŒº. ä»æˆ‘ä¸€å¼€å§‹çš„ä¾‹å­é‡Œä¹Ÿå¯ä»¥çœ‹åˆ°, "),t("mark",[t("strong",[s._v("å®¹å™¨é‡Œ Network Namespace çš„ç½‘ç»œå‚æ•°å¹¶ä¸æ˜¯å®Œå…¨ä»å®¿ä¸»æœº Host Namespace é‡Œç»§æ‰¿çš„, ä¹Ÿä¸æ˜¯å®Œå…¨åœ¨æ–°çš„ Network Namespace å»ºç«‹çš„æ—¶å€™é‡æ–°åˆå§‹åŒ–çš„")])]),s._v(". è¿™ä¸€ç‚¹åªè¦çœ‹ä¸€ä¸‹å†…æ ¸ä»£ç ä¸­å¯¹åè®®æ ˆçš„åˆå§‹åŒ–å‡½æ•°, å¾ˆå¿«å°±å¯ä»¥çŸ¥é“ä¸ºä»€ä¹ˆä¼šæœ‰è¿™æ ·çš„æƒ…å†µ.")]),s._v(" "),t("p",[s._v("åœ¨ä¾‹å­é‡Œ tcp_congestion_control çš„å€¼æ˜¯ä» Host Namespace é‡Œç»§æ‰¿çš„, è€Œ tcp_keepalive ç›¸å…³çš„å‡ ä¸ªå€¼ä¼šè¢«é‡æ–°åˆå§‹åŒ–äº†. åœ¨å‡½æ•° tcp_sk_init() é‡Œ, tcp_keepalive çš„ä¸‰ä¸ªå‚æ•°éƒ½æ˜¯"),t("strong",[s._v("é‡æ–°åˆå§‹åŒ–")]),s._v("çš„, è€Œ tcp_congestion_control çš„å€¼æ˜¯ä» Host Namespace é‡Œå¤åˆ¶è¿‡æ¥çš„.")]),s._v(" "),t("div",{staticClass:"language-c line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-c"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("static")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" __net_init "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("tcp_sk_init")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("struct")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("net")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("net"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n    net"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("ipv4"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("sysctl_tcp_keepalive_time "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" TCP_KEEPALIVE_TIME"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    net"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("ipv4"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("sysctl_tcp_keepalive_probes "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" TCP_KEEPALIVE_PROBES"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    net"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("ipv4"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("sysctl_tcp_keepalive_intvl "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" TCP_KEEPALIVE_INTVL"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n \n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("/* Reno is always built in */")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("net_eq")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("net"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&")]),s._v("init_net"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&&")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("try_module_get")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("init_net"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("ipv4"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("tcp_congestion_control"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("owner"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n            net"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("ipv4"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("tcp_congestion_control "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" init_net"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("ipv4"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("tcp_congestion_control"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("else")]),s._v("\n            net"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("ipv4"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("tcp_congestion_control "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&")]),s._v("tcp_reno"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br")])]),t("p",[s._v("é‚£ä¹ˆç°åœ¨çŸ¥é“ Network Namespace çš„ç½‘ç»œå‚æ•°æ˜¯æ€ä¹ˆåˆå§‹åŒ–çš„äº†, ä½ å¯èƒ½ä¼šé—®äº†, åœ¨å®¹å™¨é‡Œä¹Ÿå¯ä»¥ä¿®æ”¹è¿™äº›å‚æ•°å—?")]),s._v(" "),t("p",[s._v('å¯ä»¥å¯åŠ¨ä¸€ä¸ªæ™®é€šçš„å®¹å™¨, è¿™é‡Œçš„ "æ™®é€š" æŒ‡çš„ä¸æ˜¯ "privileged" çš„é‚£ç§å®¹å™¨, ä¹Ÿå°±æ˜¯åœ¨è¿™ä¸ªå®¹å™¨ä¸­, æœ‰å¾ˆå¤šæ“ä½œéƒ½æ˜¯ä¸å…è®¸åšçš„, æ¯”å¦‚ mount ä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿ. è¿™ä¸ª privileged å®¹å™¨æ¦‚å¿µ, ä¼šåœ¨åé¢å®¹å™¨å®‰å…¨è¿™ä¸€è®²é‡Œè¯¦ç»†å±•å¼€.')]),s._v(" "),t("p",[s._v('é‚£ä¹ˆåœ¨å¯åŠ¨å®Œä¸€ä¸ªæ™®é€šå®¹å™¨å, å°è¯•ä¸€ä¸‹åœ¨å®¹å™¨é‡Œå»ä¿®æ”¹ "/proc/sys/net/" ä¸‹çš„å‚æ•°. è¿™æ—¶å€™ä½ ä¼šçœ‹åˆ°, å®¹å™¨ä¸­ "/proc/sys/" æ˜¯'),t("strong",[s._v("åªè¯» mount çš„")]),s._v(", é‚£ä¹ˆ"),t("strong",[s._v('åœ¨å®¹å™¨é‡Œæ˜¯ä¸èƒ½ä¿®æ”¹ "/proc/sys/net/" ä¸‹é¢çš„ä»»ä½•å‚æ•°')]),s._v("äº†.")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# docker run -d --name net_para centos:8.1.1911 sleep 3600")]),s._v("\n977bf3f07da90422e9c1e89e56edf7a59fab5edff26317eeb253700c2fa657f7\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# docker exec -it net_para bash")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@977bf3f07da9 /"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# echo 600 > /proc/sys/net/ipv4/tcp_keepalive_time")]),s._v("\nbash: /proc/sys/net/ipv4/tcp_keepalive_time: Read-only "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("file")]),s._v(" system\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@977bf3f07da9 /"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v('# cat /proc/mounts | grep "proc/sys"')]),s._v("\nproc /proc/sys proc ro,relatime "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br")])]),t("p",[s._v('ä¸ºä»€ä¹ˆ "/proc/sys/" åœ¨å®¹å™¨é‡Œæ˜¯åªè¯» mount å‘¢?  è¿™æ˜¯'),t("strong",[s._v("å› ä¸º runC å½“åˆå‡ºäºå®‰å…¨çš„è€ƒè™‘, æŠŠå®¹å™¨ä¸­æ‰€æœ‰ /proc å’Œ /sys ç›¸å…³çš„ç›®å½•ç¼ºçœéƒ½åšäº† read-only mount çš„å¤„ç†")]),s._v(".")]),s._v(" "),t("p",[s._v("é‚£åº”è¯¥æ€ä¹ˆæ¥ä¿®æ”¹å®¹å™¨ä¸­ Network Namespace çš„ç½‘ç»œå‚æ•°å‘¢?")]),s._v(" "),t("p",[s._v('å½“ç„¶, å¦‚æœæœ‰å®¿ä¸»æœºä¸Šçš„ root æƒé™, æœ€ç®€å•ç²—æš´çš„æ–¹æ³•å°±æ˜¯ä¹‹å‰è¯´çš„ "nsenter" å·¥å…·æ¥ä¿®æ”¹å®¹å™¨é‡Œçš„ç½‘ç»œå‚æ•°. ä¸è¿‡è¿™ä¸ªæ–¹æ³•åœ¨'),t("strong",[s._v("ç”Ÿäº§ç¯å¢ƒé‡Œæ˜¾ç„¶æ˜¯ä¸ä¼šè¢«å…è®¸çš„")]),s._v(", å› ä¸ºä¸ä¼šå…è®¸ç”¨æˆ·æ‹¥æœ‰å®¿ä¸»æœºçš„ç™»é™†æƒé™. å…¶æ¬¡ä¸€èˆ¬æ¥è¯´"),t("strong",[s._v("åœ¨å®¹å™¨ä¸­çš„åº”ç”¨å·²ç»å¯åŠ¨äº†ä¹‹å, æ‰ä¼šåšè¿™æ ·çš„ä¿®æ”¹")]),s._v(". ä¹Ÿå°±æ˜¯è¯´, å¾ˆå¤š tcp é“¾æ¥å·²ç»å»ºç«‹å¥½äº†, é‚£ä¹ˆå³ä½¿æ–°æ”¹äº†å‚æ•°, å¯¹å·²ç»å»ºç«‹å¥½çš„é“¾æ¥ä¹Ÿä¸ä¼šç”Ÿæ•ˆäº†. è¿™å°±éœ€è¦é‡å¯åº”ç”¨, éƒ½çŸ¥é“ç”Ÿäº§ç¯å¢ƒé‡Œé€šå¸¸è¦é¿å…åº”ç”¨é‡å¯, é‚£è¿™æ ·åšæ˜¾ç„¶ä¹Ÿä¸åˆé€‚.")]),s._v(" "),t("p",[s._v('é€šè¿‡åˆšåˆšçš„æ’é™¤æ³•, å¯ä»¥æ¨ç†å‡ºäº†ç½‘ç»œå‚æ•°ä¿®æ”¹çš„ "æ­£ç¡®æ—¶æœº": '),t("mark",[t("strong",[s._v("æƒ³ä¿®æ”¹ Network Namespace é‡Œçš„ç½‘ç»œå‚æ•°, è¦é€‰æ‹©å®¹å™¨åˆšåˆšå¯åŠ¨, è€Œå®¹å™¨ä¸­çš„åº”ç”¨ç¨‹åºè¿˜æ²¡å¯åŠ¨ä¹‹å‰è¿›è¡Œ")])]),s._v(".")]),s._v(" "),t("p",[s._v("å…¶å®, runC ä¹Ÿåœ¨å¯¹ /proc/sys ç›®å½•åš read-only mount ä¹‹å‰, é¢„ç•™å‡ºäº†"),t("strong",[s._v("ä¿®æ”¹æ¥å£")]),s._v(', å°±æ˜¯ç”¨æ¥ä¿®æ”¹å®¹å™¨é‡Œ "/proc/sys" ä¸‹å‚æ•°çš„, åŒæ ·ä¹Ÿ'),t("strong",[s._v("æ˜¯ sysctl çš„å‚æ•°")]),s._v(". "),t("strong",[s._v("è€Œ Docker çš„ â€“sysctl æˆ–è€… Kubernetes é‡Œçš„ allowed-unsafe-sysctls ç‰¹æ€§ä¹Ÿéƒ½åˆ©ç”¨äº† runC çš„ sysctl å‚æ•°ä¿®æ”¹æ¥å£, å…è®¸å®¹å™¨åœ¨å¯åŠ¨æ—¶ä¿®æ”¹å®¹å™¨ Namespace é‡Œçš„å‚æ•°")]),s._v(".")]),s._v(" "),t("p",[s._v("æ¯”å¦‚å¯ä»¥è¯•ä¸€ä¸‹ docker â€“sysctl, è¿™æ—¶å€™ä¼šå‘ç°, åœ¨å®¹å™¨çš„ Network Namespace é‡Œ, /proc/sys/net/ipv4/tcp_keepalive_time è¿™ä¸ªç½‘ç»œå‚æ•°ç»ˆäºè¢«ä¿®æ”¹äº†!")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# docker run -d --name net_para --sysctl net.ipv4.tcp_keepalive_time=600 centos:8.1.1911 sleep 3600")]),s._v("\n7efed88a44d64400ff5a6d38fdcc73f2a74a7bdc3dbc7161060f2f7d0be170d1\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# docker exec net_para cat /proc/sys/net/ipv4/tcp_keepalive_time")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("600")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br")])]),t("h5",{attrs:{id:"_4-é‡ç‚¹æ€»ç»“-11"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_4-é‡ç‚¹æ€»ç»“-11"}},[s._v("#")]),s._v(" 4.é‡ç‚¹æ€»ç»“")]),s._v(" "),t("p",[s._v("æœ¬èŠ‚è®¨è®ºé—®é¢˜æ˜¯å®¹å™¨ä¸­ç½‘ç»œå‚æ•°çš„é—®é¢˜, å› ä¸ºæ˜¯é—®é¢˜å‘ç”Ÿåœ¨å®¹å™¨é‡Œ, åˆæ˜¯ç½‘ç»œçš„å‚æ•°, é‚£ä¹ˆè‡ªç„¶å°±å’Œ "),t("strong",[s._v("Network Namespace")]),s._v(" æœ‰å…³, æ‰€ä»¥é¦–å…ˆè¦ç†è§£ Network Namespace.")]),s._v(" "),t("p",[s._v("**Network Namespace å¯ä»¥éš”ç¦»ç½‘ç»œè®¾å¤‡, ip åè®®æ ˆ, ip è·¯ç”±è¡¨, é˜²ç«å¢™è§„åˆ™, ä»¥åŠå¯ä»¥æ˜¾ç¤ºç‹¬ç«‹çš„ç½‘ç»œçŠ¶æ€ä¿¡æ¯. ** å¯ä»¥é€šè¿‡ clone() æˆ–è€… unshare() ç³»ç»Ÿè°ƒç”¨æ¥å»ºç«‹æ–°çš„ Network Namespace.")]),s._v(" "),t("p",[s._v('æ­¤å¤–, è¿˜æœ‰ä¸€äº›å·¥å…· "ip", "netns", "unshare", "lsns" å’Œ "nsenter", ä¹Ÿå¯ä»¥ç”¨æ¥æ“ä½œ Network Namespace.')]),s._v(" "),t("p",[s._v("è¿™äº›å·¥å…·çš„é€‚ç”¨æ¡ä»¶æ•´ç†å¦‚ä¸‹, å¯ä»¥åšä¸ªå‚è€ƒ.")]),s._v(" "),t("p",[t("img",{attrs:{src:"/img/297628570c36c17bf078c8dde883f99f-20230731161430-zcxk0pn.png",alt:""}})]),s._v(" "),t("p",[s._v("æ¥ç€åˆ†æäº†å¦‚ä½•ä¿®æ”¹æ™®é€šå®¹å™¨(é privileged)çš„ç½‘ç»œå‚æ•°.")]),s._v(" "),t("p",[s._v("ç”±äºå®‰å…¨çš„åŸå› , æ™®é€šå®¹å™¨çš„ /proc/sys æ˜¯ read-only mount çš„, æ‰€ä»¥åœ¨å®¹å™¨å¯åŠ¨ä»¥å, æ‰€ä»¥æ— æ³•åœ¨å®¹å™¨å†…éƒ¨ä¿®æ”¹ /proc/sys/net ä¸‹ç½‘ç»œç›¸å…³çš„å‚æ•°. "),t("mark",[s._v("è¿™æ—¶å¯è¡Œçš„æ–¹æ³•æ˜¯")]),s._v("â€‹"),t("mark",[s._v("**é€šè¿‡ runC sysctl ç›¸å…³çš„æ¥å£, åœ¨å®¹å™¨å¯åŠ¨çš„æ—¶å€™å¯¹å®¹å™¨å†…çš„ç½‘ç»œå‚æ•°åšé…ç½®. **")])]),s._v(" "),t("p",[s._v("è¿™æ ·ä¸€æ¥, æƒ³è¦ä¿®æ”¹ç½‘ç»œå‚æ•°å°±å¯ä»¥è¿™ä¹ˆåš: "),t("strong",[s._v('å¦‚æœæ˜¯ä½¿ç”¨ Docker, å¯ä»¥åŠ ä¸Š "â€”sysctl" è¿™ä¸ªå‚æ•°; è€Œå¦‚æœä½¿ç”¨ Kubernetes çš„è¯, å°±éœ€è¦ç”¨åˆ° "allowed unsaft sysctl" è¿™ä¸ªç‰¹æ€§')]),s._v(".")]),s._v(" "),t("h4",{attrs:{id:"_16-å®¹å™¨ç½‘ç»œé…ç½®-1-å®¹å™¨ç½‘ç»œä¸é€šäº†è¦æ€ä¹ˆè°ƒè¯•"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_16-å®¹å™¨ç½‘ç»œé…ç½®-1-å®¹å™¨ç½‘ç»œä¸é€šäº†è¦æ€ä¹ˆè°ƒè¯•"}},[s._v("#")]),s._v(" 16 | å®¹å™¨ç½‘ç»œé…ç½®(1):å®¹å™¨ç½‘ç»œä¸é€šäº†è¦æ€ä¹ˆè°ƒè¯•?")]),s._v(" "),t("p",[s._v("ä¸Šä¸€è®²äº† Network Namespace éš”ç¦»äº†ç½‘ç»œè®¾å¤‡, IP åè®®æ ˆå’Œè·¯ç”±è¡¨, ä»¥åŠé˜²ç«å¢™è§„åˆ™, é‚£å®¹å™¨ Network Namespace é‡Œçš„å‚æ•°æ€ä¹ˆå»é…ç½®, ç°åœ¨å·²ç»å¾ˆæ¸…æ¥šäº†.")]),s._v(" "),t("p",[s._v("å…¶å®å¯¹äºç½‘ç»œé…ç½®çš„é—®é¢˜, è¿˜æœ‰ä¸€ä¸ªæœ€éœ€è¦å…³å¿ƒçš„å†…å®¹, "),t("strong",[s._v("é‚£å°±æ˜¯å®¹å™¨å’Œå¤–é¢çš„å®¹å™¨æˆ–è€…èŠ‚ç‚¹æ˜¯æ€ä¹ˆé€šè®¯çš„")]),s._v(", è¿™å°±æ¶‰åŠåˆ°äº†å®¹å™¨ç½‘ç»œæ¥å£é…ç½®çš„é—®é¢˜äº†. æœ¬èŠ‚å°±æ¥èŠèŠ"),t("strong",[s._v("å®¹å™¨ Network Namespace é‡Œå¦‚ä½•é…ç½®ç½‘ç»œæ¥å£, è¿˜æœ‰å½“å®¹å™¨ç½‘ç»œä¸é€šçš„æ—¶å€™")]),s._v(", åº”è¯¥æ€ä¹ˆå»åšä¸€ä¸ªç®€å•è°ƒè¯•.")]),s._v(" "),t("h5",{attrs:{id:"_1-é—®é¢˜å†ç°-11"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-é—®é¢˜å†ç°-11"}},[s._v("#")]),s._v(" 1.é—®é¢˜å†ç°")]),s._v(" "),t("p",[s._v("åœ¨å‰é¢çš„è¯¾ç¨‹é‡Œ, ä¸€ç›´æ˜¯ç”¨ "),t("code",[s._v("docker run")]),s._v('â€‹ è¿™ä¸ªå‘½ä»¤æ¥å¯åŠ¨å®¹å™¨çš„. å®¹å™¨å¯åŠ¨äº†ä¹‹åå¯ä»¥çœ‹åˆ°, åœ¨å®¹å™¨é‡Œé¢æœ‰ä¸€ä¸ª "'),t("strong",[s._v("eth0")]),s._v('" çš„ç½‘ç»œæ¥å£, æ¥å£ä¸Šä¹Ÿé…ç½®äº†ä¸€ä¸ª IP åœ°å€. '),t("strong",[s._v("ä¸è¿‡å¦‚æœæƒ³ä»å®¹å™¨é‡Œè®¿é—®å¤–é¢çš„ä¸€ä¸ª IP åœ°å€, æ¯”å¦‚è¯´ 39.106.233.176(è¿™ä¸ªæ˜¯æå®¢æ—¶é—´ç½‘å€å¯¹åº”çš„ IP), ç»“æœå°±å‘ç°æ˜¯ä¸èƒ½ ping é€šçš„.")])]),s._v(" "),t("p",[s._v("è¿™æ—¶å¯èƒ½ä¼šæƒ³åˆ°, åˆ°åº•æ˜¯ä¸æ˜¯å®¹å™¨å†…å‡ºäº†é—®é¢˜, åœ¨å®¹å™¨é‡Œæ— æ³•è®¿é—®, ä¼šä¸ä¼šå®¿ä¸»æœºä¹Ÿä¸€æ ·ä¸è¡Œå‘¢?")]),s._v(" "),t("p",[s._v("æ‰€ä»¥éœ€è¦éªŒè¯ä¸€ä¸‹, é¦–å…ˆé€€å‡ºå®¹å™¨, ç„¶ååœ¨å®¿ä¸»æœºçš„ Network Namespace ä¸‹, å†è¿è¡Œ "),t("code",[s._v("ping 39.106.233.176")]),s._v("â€‹, ç»“æœå°±ä¼šå‘ç°åœ¨å®¿ä¸»æœºä¸Š, å´æ˜¯å¯ä»¥"),t("strong",[s._v("è¿é€š")]),s._v("è¿™ä¸ªåœ°å€çš„.")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# docker run -d --name if-test centos:8.1.1911 sleep 36000")]),s._v("\n244d44f94dc2931626194c6fd3f99cec7b7c4bf61aafc6c702551e2c5ca2a371\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# docker exec -it if-test bash")]),s._v("\n \n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@244d44f94dc2 /"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ip addr")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(": lo: "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("LOOPBACK,UP,LOWER_UP"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" mtu "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("65536")]),s._v(" qdisc noqueue state UNKNOWN group default qlen "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1000")]),s._v("\n    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00\n    inet "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1/8 scope "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("host")]),s._v(" lo\n       valid_lft forever preferred_lft forever\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("808")]),s._v(": eth0@if809: "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("BROADCAST,MULTICAST,UP,LOWER_UP"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" mtu "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1500")]),s._v(" qdisc noqueue state UP group default\n    link/ether 02:42:ac:11:00:02 brd ff:ff:ff:ff:ff:ff link-netnsid "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\n    inet "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.17")]),s._v(".0.2/16 brd "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.17")]),s._v(".255.255 scope global eth0\n       valid_lft forever preferred_lft forever\n \n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@244d44f94dc2 /"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ping 39.106.233.176       ### å®¹å™¨ä¸­æ— æ³•pingé€š")]),s._v("\nPING "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("39.106")]),s._v(".233.176 "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("39.106")]),s._v(".233.176"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("56")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("84")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" bytes of data.\n^C\n--- "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("39.106")]),s._v(".233.176 "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ping")]),s._v(" statistics ---\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("9")]),s._v(" packets transmitted, "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" received, "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("100")]),s._v("% packet loss, "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("time")]),s._v(" 185ms\n \n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@244d44f94dc2 /"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# exit             ###é€€å‡ºå®¹å™¨")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("exit")]),s._v("\n \n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ping 39.106.233.176                        ### å®¿ä¸»æœºä¸Šå¯ä»¥pingé€š")]),s._v("\nPING "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("39.106")]),s._v(".233.176 "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("39.106")]),s._v(".233.176"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("56")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("84")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" bytes of data.\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("64")]),s._v(" bytes from "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("39.106")]),s._v(".233.176: "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("icmp_seq")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("ttl")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("78")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("time")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("296")]),s._v(" ms\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("64")]),s._v(" bytes from "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("39.106")]),s._v(".233.176: "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("icmp_seq")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("ttl")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("78")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("time")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("306")]),s._v(" ms\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("64")]),s._v(" bytes from "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("39.106")]),s._v(".233.176: "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("icmp_seq")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("ttl")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("78")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("time")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("303")]),s._v(" ms\n^C\n--- "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("39.106")]),s._v(".233.176 "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ping")]),s._v(" statistics ---\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v(" packets transmitted, "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v(" received, "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("25")]),s._v("% packet loss, "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("time")]),s._v(" 7ms\nrtt min/avg/max/mdev "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("296.059")]),s._v("/301.449/305.580/4.037 ms\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br"),t("span",{staticClass:"line-number"},[s._v("25")]),t("br"),t("span",{staticClass:"line-number"},[s._v("26")]),t("br"),t("span",{staticClass:"line-number"},[s._v("27")]),t("br"),t("span",{staticClass:"line-number"},[s._v("28")]),t("br"),t("span",{staticClass:"line-number"},[s._v("29")]),t("br"),t("span",{staticClass:"line-number"},[s._v("30")]),t("br"),t("span",{staticClass:"line-number"},[s._v("31")]),t("br"),t("span",{staticClass:"line-number"},[s._v("32")]),t("br")])]),t("p",[s._v("é‚£ä¹ˆç¢°åˆ°è¿™ç§å®¹å™¨å†…ç½‘ç»œä¸é€šçš„é—®é¢˜, åº”è¯¥æ€ä¹ˆåˆ†æè°ƒè¯•å‘¢? è¿˜æ˜¯éœ€è¦å…ˆæ¥ç†è§£ä¸€ä¸‹, "),t("strong",[s._v("å®¹å™¨ Network Namespace é‡Œçš„ç½‘ç»œæ¥å£æ˜¯æ€ä¹ˆé…ç½®")]),s._v("çš„.")]),s._v(" "),t("h5",{attrs:{id:"_2-åŸºæœ¬æ¦‚å¿µ"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-åŸºæœ¬æ¦‚å¿µ"}},[s._v("#")]),s._v(" 2.åŸºæœ¬æ¦‚å¿µ")]),s._v(" "),t("p",[s._v("åœ¨è®²è§£å®¹å™¨çš„ç½‘ç»œæ¥å£é…ç½®ä¹‹å‰, éœ€è¦å…ˆå»ºç«‹ä¸€ä¸ªæ•´ä½“çš„è®¤è¯†, ææ¸…æ¥š"),t("strong",[s._v("å®¹å™¨ç½‘ç»œæ¥å£åœ¨ç³»ç»Ÿæ¶æ„ä¸­å¤„äºå“ªä¸ªä½ç½®")]),s._v(".")]),s._v(" "),t("p",[s._v("å¯ä»¥çœ‹ä¸€ä¸‹è¿™å¼ å›¾, å›¾é‡Œå±•ç¤ºçš„æ˜¯"),t("strong",[s._v("å®¹å™¨æœ‰è‡ªå·±çš„ Network Namespace, eth0 æ˜¯è¿™ä¸ª Network Namespace é‡Œçš„ç½‘ç»œæ¥å£")]),s._v(". è€Œ"),t("strong",[s._v("å®¿ä¸»æœºä¸Šä¹Ÿæœ‰è‡ªå·±çš„ eth0, å®¿ä¸»æœºä¸Šçš„ eth0 å¯¹åº”ç€çœŸæ­£çš„ç‰©ç†ç½‘å¡, å¯ä»¥å’Œå¤–é¢é€šè®¯")]),s._v(".")]),s._v(" "),t("p",[t("img",{attrs:{src:"/img/ea4a452ffbbfac9f7d7c848bf65baaca-20230731161430-4djmcto.png",alt:""}})]),s._v(" "),t("p",[s._v("é‚£å¯ä»¥å…ˆæƒ³æƒ³, è¦è®©å®¹å™¨ Network Namespace ä¸­çš„æ•°æ®åŒ…æœ€ç»ˆå‘é€åˆ°"),t("strong",[s._v("ç‰©ç†ç½‘å¡")]),s._v("ä¸Š, éœ€è¦å®Œæˆå“ªäº›æ­¥éª¤å‘¢? ä»å›¾ä¸Šçœ‹, å¤§è‡´å¯ä»¥çŸ¥é“åº”è¯¥åŒ…æ‹¬è¿™ä¸¤æ­¥.")]),s._v(" "),t("p",[s._v("**ç¬¬ä¸€æ­¥, å°±æ˜¯è¦è®©æ•°æ®åŒ…ä»å®¹å™¨çš„ Network Namespace å‘é€åˆ° Host Network Namespace ä¸Š. **")]),s._v(" "),t("p",[s._v("**ç¬¬äºŒæ­¥, æ•°æ®åŒ…å‘åˆ°äº† Host Network Namespace ä¹‹å, è¿˜è¦è§£å†³æ•°æ®åŒ…æ€ä¹ˆä»å®¿ä¸»æœºä¸Šçš„ eth0 å‘é€å‡ºå»çš„é—®é¢˜. **")]),s._v(" "),t("p",[s._v("æ•´ä½“çš„æ€è·¯å·²ç»ç†æ¸…æ¥šäº†, æ¥ä¸‹æ¥åšå…·ä½“åˆ†æ.")]),s._v(" "),t("p",[s._v("å…ˆæ¥çœ‹ç¬¬ä¸€æ­¥, æ€ä¹ˆè®©æ•°æ®åŒ…ä»å®¹å™¨çš„ Network Namespace å‘é€åˆ° Host Network Namespace ä¸Šé¢. å¯ä»¥æŸ¥çœ‹ä¸€ä¸‹ Docker ç½‘ç»œçš„æ–‡æ¡£æˆ–è€… Kubernetes ç½‘ç»œçš„æ–‡æ¡£, è¿™äº›æ–‡æ¡£é‡Œé¢ä»‹ç»äº†å¾ˆå¤šç§å®¹å™¨ç½‘ç»œé…ç½®çš„æ–¹å¼. ä¸è¿‡å¯¹äº"),t("strong",[s._v("å®¹å™¨ä»è‡ªå·±çš„ Network Namespace è¿æ¥åˆ° Host Network Namespace çš„æ–¹æ³•, ä¸€èˆ¬æ¥è¯´å°±åªæœ‰ä¸¤ç±»è®¾å¤‡æ¥å£: ä¸€ç±»æ˜¯ veth, å¦å¤–ä¸€ç±»æ˜¯  macvlan/ipvlan")]),s._v(".")]),s._v(" "),t("p",[s._v("åœ¨è¿™äº›æ–¹æ³•ä¸­, ä½¿ç”¨æœ€å¤šçš„å°±æ˜¯ "),t("strong",[s._v("veth çš„æ–¹å¼")]),s._v(", ç”¨ Docker å¯åŠ¨çš„å®¹å™¨ç¼ºçœçš„ç½‘ç»œæ¥å£ç”¨çš„ä¹Ÿæ˜¯è¿™ä¸ª veth. æ—¢ç„¶å®ƒè¿™ä¹ˆå¸¸è§, æ‰€ä»¥å°±ç”¨ veth ä½œä¸ºä¾‹å­æ¥è¯¦ç»†è®²è§£. è‡³äºå¦å¤–ä¸€ç±» macvlan/ipvlan çš„æ–¹å¼, ä¸‹ä¸€è®²ä¼šè®²åˆ°.")]),s._v(" "),t("p",[s._v("é‚£ä»€ä¹ˆæ˜¯ veth å‘¢? ä¸ºäº†æ–¹ä¾¿ç†è§£, å…ˆæ¥"),t("strong",[s._v("æ¨¡æ‹Ÿä¸€ä¸‹ Docker ä¸ºå®¹å™¨å»ºç«‹ eth0 ç½‘ç»œæ¥å£çš„è¿‡ç¨‹")]),s._v(", åŠ¨æ‰‹æ“ä½œä¸€ä¸‹, è¿™æ ·å°±å¯ä»¥å¾ˆå¿«æ˜ç™½ä»€ä¹ˆæ˜¯ veth äº†. è¿™ä¸ªæ¨¡æ‹Ÿæ“ä½œä¸»è¦ç”¨åˆ°çš„æ˜¯ "),t("strong",[s._v("ip netns è¿™ä¸ªå‘½ä»¤")]),s._v(', é€šè¿‡å®ƒæ¥å¯¹ Network Namespace åšæ“ä½œ. é¦–å…ˆå…ˆå¯åŠ¨ä¸€ä¸ªä¸å¸¦ç½‘ç»œé…ç½®çš„å®¹å™¨, å’Œä¹‹å‰çš„å‘½ä»¤æ¯”è¾ƒ, ä¸»è¦æ˜¯å¤šåŠ ä¸Šäº† " '),t("strong",[s._v("--network none")]),s._v('" å‚æ•°. å¯ä»¥çœ‹åˆ°, è¿™æ ·åœ¨å¯åŠ¨çš„å®¹å™¨ä¸­, Network Namespace é‡Œå°±'),t("strong",[s._v("åªæœ‰ loopback ä¸€ä¸ªç½‘ç»œè®¾å¤‡, è€Œæ²¡æœ‰äº† eth0 ç½‘ç»œè®¾å¤‡")]),s._v("äº†.")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# docker run -d --name if-test --network none centos:8.1.1911 sleep 36000")]),s._v("\ncf3d3105b11512658a025f5b401a09c888ed3495205f31e0a0d78a2036729472\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# docker exec -it if-test ip addr")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(": lo: "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("LOOPBACK,UP,LOWER_UP"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" mtu "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("65536")]),s._v(" qdisc noqueue state UNKNOWN group default qlen "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1000")]),s._v("\n    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00\n    inet "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1/8 scope "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("host")]),s._v(" lo\n       valid_lft forever preferred_lft forever\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br")])]),t("p",[s._v("å®Œæˆåˆšæ‰çš„è®¾ç½®ä»¥å, å°±"),t("strong",[s._v("åœ¨è¿™ä¸ªå®¹å™¨çš„ Network Namespace é‡Œå»ºç«‹ veth")]),s._v(", å¯ä»¥æ‰§è¡Œä¸€ä¸‹åé¢çš„è¿™ä¸ªè„šæœ¬.")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("pid")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token variable"}},[t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$(")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ps")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-ef")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("grep")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"sleep 36000"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("grep")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-v")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("grep")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("awk")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'{print $2}'")]),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v(")")])]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$pid")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ln")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-s")]),s._v(" /proc/"),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$pid")]),s._v("/ns/net /var/run/netns/"),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$pid")]),s._v("\n \n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# Create a pair of veth interfaces")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ip")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("link")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("add")]),s._v(" name veth_host "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("type")]),s._v(" veth peer name veth_container\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# Put one of them in the new net ns")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ip")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("link")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v(" veth_container netns "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$pid")]),s._v("\n \n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# In the container, setup veth_container")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ip")]),s._v(" netns "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("exec")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$pid")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ip")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("link")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v(" veth_container name eth0\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ip")]),s._v(" netns "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("exec")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$pid")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ip")]),s._v(" addr "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("add")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.17")]),s._v(".1.2/16 dev eth0\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ip")]),s._v(" netns "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("exec")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$pid")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ip")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("link")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v(" eth0 up\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ip")]),s._v(" netns "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("exec")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$pid")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ip")]),s._v(" route "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("add")]),s._v(" default via "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.17")]),s._v(".0.1\n \n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# In the host, set veth_host up")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ip")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("link")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v(" veth_host up\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br")])]),t("p",[s._v("è§£é‡Šä¸€ä¸‹, è¿™ä¸ª veth çš„å»ºç«‹è¿‡ç¨‹æ˜¯ä»€ä¹ˆæ ·çš„.")]),s._v(" "),t("p",[s._v('é¦–å…ˆæ‰¾åˆ°è¿™ä¸ªå®¹å™¨é‡Œè¿è¡Œçš„è¿›ç¨‹ "sleep 36000" çš„ pid, é€šè¿‡ "/proc/$pid/ns/net" è¿™ä¸ªæ–‡ä»¶'),t("strong",[s._v("å¾—åˆ° Network Namespace çš„ ID, è¿™ä¸ª Network Namespace ID æ—¢æ˜¯è¿™ä¸ªè¿›ç¨‹çš„, ä¹ŸåŒæ—¶å±äºè¿™ä¸ªå®¹å™¨")]),s._v(".")]),s._v(" "),t("p",[s._v('ç„¶ååœ¨ "/var/run/netns/" çš„ç›®å½•ä¸‹å»ºç«‹ä¸€ä¸ª'),t("strong",[s._v("ç¬¦å·é“¾æ¥")]),s._v(', æŒ‡å‘è¿™ä¸ªå®¹å™¨çš„ Network Namespace. å®Œæˆè¿™æ­¥æ“ä½œä¹‹å, åœ¨åé¢çš„ "ip netns" æ“ä½œé‡Œ, å°±å¯ä»¥'),t("strong",[s._v("ç”¨ pid çš„å€¼ä½œä¸ºè¿™ä¸ªå®¹å™¨çš„ Network Namesapce çš„æ ‡è¯†")]),s._v("äº†.")]),s._v(" "),t("p",[s._v("æ¥ä¸‹æ¥ç”¨ "),t("code",[s._v("ip link")]),s._v("â€‹ å‘½ä»¤æ¥"),t("strong",[s._v("å»ºç«‹ä¸€å¯¹ veth çš„è™šæ‹Ÿè®¾å¤‡æ¥å£")]),s._v(", åˆ†åˆ«æ˜¯ "),t("strong",[s._v("veth_container å’Œ veth_host")]),s._v(". ä»åå­—å°±å¯ä»¥çœ‹å‡ºæ¥, "),t("strong",[s._v("veth_container è¿™ä¸ªæ¥å£ä¼šè¢«æ”¾åœ¨å®¹å™¨ Network Namespace é‡Œ, è€Œ veth_host ä¼šæ”¾åœ¨å®¿ä¸»æœºçš„ Host Network Namespace")]),s._v(".")]),s._v(" "),t("p",[s._v("æ‰€ä»¥åé¢çš„å‘½ä»¤ä¹Ÿå¾ˆå¥½ç†è§£äº†, å°±æ˜¯ç”¨ "),t("code",[s._v("ip link set veth_container netns $pid")]),s._v("â€‹ æŠŠ veth_container è¿™ä¸ªæ¥å£æ”¾å…¥åˆ°å®¹å™¨çš„ Network Namespace ä¸­.")]),s._v(" "),t("p",[s._v("å†ç„¶å"),t("strong",[s._v("è¦æŠŠ veth_container é‡æ–°å‘½åä¸º eth0")]),s._v(", å› ä¸ºè¿™æ—¶å€™æ¥å£å·²ç»åœ¨å®¹å™¨çš„ Network Namesapce é‡Œäº†, eth0 å°±ä¸ä¼šå’Œå®¿ä¸»æœºä¸Šçš„ eth0 å†²çªäº†.")]),s._v(" "),t("p",[s._v("æœ€åå¯¹å®¹å™¨å†…çš„ eht0, è¿˜è¦åšåŸºæœ¬çš„"),t("strong",[s._v("ç½‘ç»œ IP å’Œç¼ºçœè·¯ç”±é…ç½®")]),s._v(". å› ä¸º veth_host å·²ç»åœ¨å®¿ä¸»æœºçš„ Host Network Namespace äº†, å°±ä¸éœ€è¦å†åšä»€ä¹ˆäº†, è¿™æ—¶åªéœ€è¦ up ä¸€ä¸‹è¿™ä¸ªæ¥å£å°±å¯ä»¥äº†.")]),s._v(" "),t("p",[s._v("é‚£åˆšæ‰è¿™äº›æ“ä½œå®Œæˆä»¥å, å°±"),t("strong",[s._v("å»ºç«‹äº†ä¸€å¯¹ veth è™šæ‹Ÿè®¾å¤‡æ¥å£")]),s._v(". ä¸‹å›¾ç›´è§‚å±•ç¤ºäº†è¿™å¯¹æ¥å£åœ¨å®¹å™¨å’Œå®¿ä¸»æœºä¸Šçš„ä½ç½®.")]),s._v(" "),t("p",[t("img",{attrs:{src:"/img/03863cd49dad179c08c05765a419462c-20230731161430-nnm7qj0.png",alt:""}})]),s._v(" "),t("p",[s._v("ç°åœ¨å†æ¥çœ‹çœ‹ veth çš„å®šä¹‰, å…¶å®å®ƒä¹Ÿå¾ˆç®€å•. "),t("mark",[t("strong",[s._v("veth å°±æ˜¯ä¸€ä¸ªè™šæ‹Ÿçš„ç½‘ç»œè®¾å¤‡, ä¸€èˆ¬éƒ½æ˜¯æˆå¯¹åˆ›å»º, è€Œä¸”è¿™å¯¹è®¾å¤‡æ˜¯ç›¸äº’è¿æ¥çš„. å½“æ¯ä¸ªè®¾å¤‡åœ¨ä¸åŒçš„ Network Namespaces çš„æ—¶å€™, Namespace ä¹‹é—´å°±å¯ä»¥ç”¨è¿™å¯¹ veth è®¾å¤‡æ¥è¿›è¡Œç½‘ç»œé€šè®¯äº†")])]),s._v(".")]),s._v(" "),t("p",[s._v("æ¯”å¦‚å¯ä»¥æ‰§è¡Œä¸‹é¢çš„è¿™æ®µä»£ç , "),t("strong",[s._v("è¯•è¯•åœ¨ veth_host ä¸ŠåŠ ä¸Šä¸€ä¸ª IP, 172.17.1.1/16, ç„¶åä»å®¹å™¨é‡Œå°±å¯ä»¥ ping é€šè¿™ä¸ª IP äº†")]),s._v(". è¿™ä¹Ÿè¯æ˜äº†ä»å®¹å™¨åˆ°å®¿ä¸»æœºå¯ä»¥åˆ©ç”¨è¿™å¯¹ veth æ¥å£æ¥é€šè®¯äº†.")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ip addr add 172.17.1.1/16 dev veth_host")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# docker exec -it if-test ping 172.17.1.1")]),s._v("\nPING "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.17")]),s._v(".1.1 "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.17")]),s._v(".1.1"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("56")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("84")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" bytes of data.\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("64")]),s._v(" bytes from "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.17")]),s._v(".1.1: "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("icmp_seq")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("ttl")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("64")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("time")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.073")]),s._v(" ms\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("64")]),s._v(" bytes from "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.17")]),s._v(".1.1: "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("icmp_seq")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("ttl")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("64")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("time")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.092")]),s._v(" ms\n^C\n--- "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.17")]),s._v(".1.1 "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ping")]),s._v(" statistics ---\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" packets transmitted, "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" received, "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("% packet loss, "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("time")]),s._v(" 30ms\nrtt min/avg/max/mdev "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.073")]),s._v("/0.082/0.092/0.013 ms\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br")])]),t("p",[s._v("å¥½äº†, è¿™æ ·å®Œæˆäº†ç¬¬ä¸€æ­¥, "),t("strong",[s._v("é€šè¿‡ä¸€å¯¹ veth è™šæ‹Ÿè®¾å¤‡, å¯ä»¥è®©æ•°æ®åŒ…ä»å®¹å™¨çš„ Network Namespace å‘é€åˆ° Host Network Namespace ä¸Š")]),s._v(".")]),s._v(" "),t("p",[s._v("ä¸‹é¢å†æ¥çœ‹ç¬¬äºŒæ­¥, "),t("strong",[s._v("æ•°æ®åŒ…åˆ°äº† Host Network Namespace ä¹‹å, æ€ä¹ˆæŠŠå®ƒä»å®¿ä¸»æœºä¸Šçš„ eth0 å‘é€å‡ºå»")]),s._v("?")]),s._v(" "),t("p",[s._v("å…¶å®è¿™ä¸€æ­¥å°±æ˜¯ä¸€ä¸ª"),t("strong",[s._v("æ™®é€š Linux èŠ‚ç‚¹ä¸Šæ•°æ®åŒ…è½¬å‘")]),s._v("çš„é—®é¢˜äº†. è¿™é‡Œè§£å†³é—®é¢˜çš„æ–¹æ³•æœ‰å¾ˆå¤šç§, æ¯”å¦‚"),t("strong",[s._v("ç”¨ nat æ¥åšä¸ªè½¬å‘, æˆ–è€…å»ºç«‹ Overlay ç½‘ç»œå‘é€, ä¹Ÿå¯ä»¥é€šè¿‡é…ç½® proxy arp åŠ è·¯ç”±çš„æ–¹æ³•æ¥å®ç°")]),s._v(".")]),s._v(" "),t("p",[s._v("å› ä¸ºè€ƒè™‘åˆ°ç½‘ç»œç¯å¢ƒçš„é…ç½®, åŒæ—¶ "),t("mark",[t("strong",[s._v("Docker ç¼ºçœä½¿ç”¨çš„æ˜¯ bridge + nat çš„è½¬å‘æ–¹å¼")])]),s._v(",  é‚£å°±åœ¨åˆšæ‰è®²çš„ç¬¬ä¸€æ­¥åŸºç¡€ä¸Š, å†æ‰‹åŠ¨å®ç°ä¸€ä¸‹ bridge+nat çš„è½¬å‘æ–¹å¼. å¯¹äºå…¶ä»–çš„é…ç½®æ–¹æ³•, å¯ä»¥çœ‹ä¸€ä¸‹ Docker æˆ–è€… Kubernetes ç›¸å…³çš„æ–‡æ¡£.")]),s._v(" "),t("p",[s._v("Docker ç¨‹åºåœ¨èŠ‚ç‚¹ä¸Šå®‰è£…å®Œä¹‹å, å°±ä¼š"),t("strong",[s._v("è‡ªåŠ¨å»ºç«‹äº†ä¸€ä¸ª docker0 çš„ bridge interface")]),s._v(". æ‰€ä»¥åªéœ€è¦"),t("mark",[t("strong",[s._v("æŠŠç¬¬ä¸€æ­¥ä¸­å»ºç«‹çš„ veth_host è¿™ä¸ªè®¾å¤‡, æ¥å…¥åˆ° docker0 è¿™ä¸ª bridge ä¸Š")])]),s._v(".")]),s._v(" "),t("p",[s._v('è¿™é‡Œè¦æ³¨æ„ä¸€ä¸‹, å¦‚æœä¹‹å‰åœ¨ veth_host ä¸Šè®¾ç½®äº† IP çš„, å°±éœ€å…ˆè¿è¡Œä¸€ä¸‹ "ip addr delete 172.17.1.1/16 dev veth_host", æŠŠ IP ä» veth_host ä¸Šåˆ é™¤.')]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ip addr delete 172.17.1.1/16 dev veth_host ")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ip")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("link")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v(" veth_host master docker0\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])]),t("p",[s._v("è¿™ä¸ªå‘½ä»¤æ‰§è¡Œå®Œä¹‹å, å®¹å™¨å’Œå®¿ä¸»æœºçš„ç½‘ç»œé…ç½®å°±ä¼šå‘ç”Ÿå˜åŒ–, è¿™ç§é…ç½®æ˜¯ä»€ä¹ˆæ ·å‘¢? å¯ä»¥å‚è€ƒä¸€ä¸‹é¢è¿™å¼ å›¾çš„æè¿°.")]),s._v(" "),t("p",[t("img",{attrs:{src:"/img/65dbd7d7328edf61fd0c17f1a4f1b135-20230731161430-eua67xj.png",alt:""}})]),s._v(" "),t("p",[s._v("ä»è¿™å¼ ç¤ºæ„å›¾ä¸­å¯ä»¥çœ‹å‡º, "),t("strong",[s._v("å®¹å™¨å’Œ docker0 ç»„æˆäº†ä¸€ä¸ªå­ç½‘, docker0 ä¸Šçš„ IP å°±æ˜¯è¿™ä¸ªå­ç½‘çš„ç½‘å…³ IP")]),s._v(". å¦‚æœè¦è®©å­ç½‘é€šè¿‡å®¿ä¸»æœºä¸Š eth0 å»è®¿é—®å¤–ç½‘çš„è¯, é‚£ä¹ˆ"),t("strong",[s._v("åŠ ä¸Š iptables çš„è§„åˆ™")]),s._v("å°±å¯ä»¥äº†, ä¹Ÿå°±æ˜¯ä¸‹é¢è¿™æ¡è§„åˆ™.")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("iptables "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-P")]),s._v(" FORWARD ACCEPT\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("è¿›è¡Œåˆ°è¿™é‡Œ, é€šè¿‡ bridge+nat çš„é…ç½®, ä¼¼ä¹å·²ç»å®Œæˆäº†ç¬¬äºŒæ­¥---è®©æ•°æ®ä»å®¿ä¸»æœºçš„ eth0 å‘é€å‡ºå». é‚£ä¹ˆè¿™æ ·é…ç½®, çœŸçš„å¯ä»¥è®©å®¹å™¨é‡Œå‘é€æ•°æ®åŒ…åˆ°å¤–ç½‘å—? è¿™éœ€è¦åšä¸ªæµ‹è¯•, å†é‡æ–°å°è¯•ä¸‹è¿™ä¸€è®²å¼€å§‹çš„æ“ä½œ, ä»å®¹å™¨é‡Œ ping å¤–ç½‘çš„ IP, è¿™æ—¶å€™, ä¼šå‘ç°"),t("strong",[s._v("è¿˜æ˜¯ ping ä¸é€š")]),s._v(".")]),s._v(" "),t("p",[s._v("å…¶å®åšåˆ°è¿™ä¸€æ­¥, æˆ‘ä»¬é€šè¿‡é€æ­¥çš„æ“ä½œé‡ç°äº†è¿™ä¸€è®²äº†æœ€å¼€å§‹çš„é—®é¢˜.")]),s._v(" "),t("h5",{attrs:{id:"_3-è§£å†³é—®é¢˜-8"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-è§£å†³é—®é¢˜-8"}},[s._v("#")]),s._v(" 3.è§£å†³é—®é¢˜")]),s._v(" "),t("p",[s._v("æ—¢ç„¶ç°åœ¨æ¸…æ¥šäº†åœ¨è¿™ä¸ªèŠ‚ç‚¹ä¸Šå®¹å™¨å’Œå®¿ä¸»æœºä¸Šçš„ç½‘ç»œé…ç½®æ˜¯æ€ä¹ˆä¸€å›äº‹. é‚£ä¹ˆè¦è°ƒè¯•è¿™ä¸ªé—®é¢˜ä¹Ÿæœ‰äº†æ€è·¯, "),t("strong",[s._v("å…³é”®å°±æ˜¯æ‰¾åˆ°æ•°æ®åŒ…ä¼ åˆ°å“ªä¸ªç¯èŠ‚æ—¶å‘ç”Ÿäº†ä¸­æ–­")]),s._v(".")]),s._v(" "),t("p",[t("strong",[s._v("é‚£æœ€ç›´æ¥çš„æ–¹æ³•, å°±æ˜¯åœ¨å®¹å™¨ä¸­ç»§ç»­ ping å¤–ç½‘çš„ IP 39.106.233.176, ç„¶ååœ¨å®¹å™¨çš„ eth0 (veth_container), å®¹å™¨å¤–çš„ veth_host, docker0, å®¿ä¸»æœºçš„ eth0 è¿™ä¸€æ¡æ•°æ®åŒ…çš„è·¯å¾„ä¸Šè¿è¡Œ tcpdump")]),s._v(".")]),s._v(" "),t("p",[s._v("è¿™æ ·å°±å¯ä»¥æŸ¥åˆ°åˆ°åº•åœ¨å“ªä¸ªè®¾å¤‡æ¥å£ä¸Šæ²¡æœ‰æ”¶åˆ° ping çš„ icmp åŒ…. æˆ‘æŠŠ tcpdump è¿è¡Œçš„ç»“æœæˆ‘åˆ—åˆ°äº†ä¸‹é¢.")]),s._v(" "),t("p",[s._v("å®¹å™¨çš„ eth0:")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ip netns exec $pid tcpdump -i eth0 host 39.106.233.176 -nn")]),s._v("\ntcpdump: verbose output suppressed, use "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-v")]),s._v(" or "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-vv")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" full protocol decode\nlistening on eth0, link-type EN10MB "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("Ethernet"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(", capture size "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("262144")]),s._v(" bytes\n00:47:29.934294 IP "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.17")]),s._v(".1.2 "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("39.106")]),s._v(".233.176: ICMP "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" request, "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("id")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("71")]),s._v(", "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("seq")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(", length "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("64")]),s._v("\n00:47:30.934766 IP "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.17")]),s._v(".1.2 "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("39.106")]),s._v(".233.176: ICMP "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" request, "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("id")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("71")]),s._v(", "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("seq")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(", length "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("64")]),s._v("\n00:47:31.958875 IP "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.17")]),s._v(".1.2 "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("39.106")]),s._v(".233.176: ICMP "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" request, "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("id")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("71")]),s._v(", "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("seq")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v(", length "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("64")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br")])]),t("p",[s._v("veth_host:")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# tcpdump -i veth_host host 39.106.233.176 -nn")]),s._v("\ntcpdump: verbose output suppressed, use "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-v")]),s._v(" or "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-vv")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" full protocol decode\nlistening on veth_host, link-type EN10MB "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("Ethernet"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(", capture size "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("262144")]),s._v(" bytes\n00:48:01.654720 IP "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.17")]),s._v(".1.2 "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("39.106")]),s._v(".233.176: ICMP "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" request, "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("id")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("71")]),s._v(", "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("seq")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("32")]),s._v(", length "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("64")]),s._v("\n00:48:02.678752 IP "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.17")]),s._v(".1.2 "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("39.106")]),s._v(".233.176: ICMP "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" request, "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("id")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("71")]),s._v(", "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("seq")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("33")]),s._v(", length "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("64")]),s._v("\n00:48:03.702827 IP "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.17")]),s._v(".1.2 "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("39.106")]),s._v(".233.176: ICMP "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" request, "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("id")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("71")]),s._v(", "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("seq")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("34")]),s._v(", length "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("64")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br")])]),t("p",[s._v("docker0:")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# tcpdump -i docker0 host 39.106.233.176 -nn")]),s._v("\ntcpdump: verbose output suppressed, use "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-v")]),s._v(" or "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-vv")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" full protocol decode\nlistening on docker0, link-type EN10MB "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("Ethernet"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(", capture size "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("262144")]),s._v(" bytes\n00:48:20.086841 IP "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.17")]),s._v(".1.2 "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("39.106")]),s._v(".233.176: ICMP "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" request, "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("id")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("71")]),s._v(", "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("seq")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("50")]),s._v(", length "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("64")]),s._v("\n00:48:21.110765 IP "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.17")]),s._v(".1.2 "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("39.106")]),s._v(".233.176: ICMP "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" request, "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("id")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("71")]),s._v(", "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("seq")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("51")]),s._v(", length "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("64")]),s._v("\n00:48:22.134839 IP "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.17")]),s._v(".1.2 "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("39.106")]),s._v(".233.176: ICMP "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" request, "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("id")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("71")]),s._v(", "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("seq")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("52")]),s._v(", length "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("64")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br")])]),t("p",[s._v("host eth0:")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# tcpdump -i eth0 host 39.106.233.176 -nn")]),s._v("\ntcpdump: verbose output suppressed, use "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-v")]),s._v(" or "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-vv")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" full protocol decode\nlistening on eth0, link-type EN10MB "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("Ethernet"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(", capture size "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("262144")]),s._v(" bytes\n^C\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" packets captured\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" packets received by filter\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" packets dropped by kernel\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br")])]),t("p",[s._v("é€šè¿‡ä¸Šé¢çš„è¾“å‡ºç»“æœ, "),t("strong",[s._v("å‘ç° icmp åŒ…åˆ°è¾¾äº† docker0, ä½†æ˜¯æ²¡æœ‰åˆ°è¾¾å®¿ä¸»æœºä¸Šçš„ eth0")]),s._v(".")]),s._v(" "),t("p",[s._v("å› ä¸ºå·²ç»é…ç½®äº† iptables nat çš„è½¬å‘, è¿™ä¸ªä¹Ÿå¯ä»¥é€šè¿‡"),t("strong",[s._v("æŸ¥çœ‹ iptables çš„ nat è¡¨ç¡®è®¤ä¸€ä¸‹")]),s._v(", æ˜¯æ²¡æœ‰é—®é¢˜çš„, å…·ä½“çš„æ“ä½œå‘½ä»¤å¦‚ä¸‹:")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# iptables -L  -t nat")]),s._v("\nChain PREROUTING "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("policy ACCEPT"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\ntarget     prot opt "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("source")]),s._v("               destination\nDOCKER     all  --  anywhere             anywhere             ADDRTYPE match dst-type LOCAL\n \nChain INPUT "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("policy ACCEPT"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\ntarget     prot opt "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("source")]),s._v("               destination\n \nChain POSTROUTING "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("policy ACCEPT"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\ntarget     prot opt "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("source")]),s._v("               destination\nMASQUERADE  all  --  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.17")]),s._v(".0.0/16        anywhere\n \nChain OUTPUT "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("policy ACCEPT"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\ntarget     prot opt "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("source")]),s._v("               destination\nDOCKER     all  --  anywhere            "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.0/8          ADDRTYPE match dst-type LOCAL\n \nChain DOCKER "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" references"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\ntarget     prot opt "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("source")]),s._v("               destination\nRETURN     all  --  anywhere             anywhere\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br")])]),t("p",[s._v("é‚£ä¹ˆä¼šæ˜¯ä»€ä¹ˆé—®é¢˜å‘¢? å› ä¸ºè¿™é‡Œ"),t("strong",[s._v("éœ€è¦åšä¸¤ä¸ªç½‘ç»œè®¾å¤‡æ¥å£ä¹‹é—´çš„æ•°æ®åŒ…è½¬å‘, ä¹Ÿå°±æ˜¯ä» docker0 æŠŠæ•°æ®åŒ…è½¬å‘åˆ° eth0 ä¸Š")]),s._v(", ä½ å¯èƒ½æƒ³åˆ°äº† Linux åè®®æ ˆé‡Œçš„ä¸€ä¸ªå¸¸ç”¨å‚æ•° "),t("strong",[s._v("ip_forward")]),s._v(".")]),s._v(" "),t("p",[s._v("å¯ä»¥çœ‹ä¸€ä¸‹, å®ƒçš„å€¼æ˜¯ 0, å½“æŠŠå®ƒæ”¹æˆ 1 ä¹‹å, é‚£ä¹ˆå°±å¯ä»¥ä»å®¹å™¨ä¸­ ping é€šå¤–ç½‘ 39.106.233.176 è¿™ä¸ª IP äº†!")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cat /proc/sys/net/ipv4/ip_forward")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# echo 1 > /proc/sys/net/ipv4/ip_forward")]),s._v("\n \n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# docker exec -it if-test ping 39.106.233.176")]),s._v("\nPING "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("39.106")]),s._v(".233.176 "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("39.106")]),s._v(".233.176"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("56")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("84")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" bytes of data.\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("64")]),s._v(" bytes from "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("39.106")]),s._v(".233.176: "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("icmp_seq")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("ttl")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("77")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("time")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("359")]),s._v(" ms\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("64")]),s._v(" bytes from "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("39.106")]),s._v(".233.176: "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("icmp_seq")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("ttl")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("77")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("time")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("346")]),s._v(" ms\n^C\n--- "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("39.106")]),s._v(".233.176 "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ping")]),s._v(" statistics ---\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" packets transmitted, "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" received, "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("% packet loss, "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("time")]),s._v(" 1ms\nrtt min/avg/max/mdev "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("345.889")]),s._v("/352.482/359.075/6.593 ms\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br")])]),t("h5",{attrs:{id:"_4-é‡ç‚¹å°ç»“-2"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_4-é‡ç‚¹å°ç»“-2"}},[s._v("#")]),s._v(" 4.é‡ç‚¹å°ç»“")]),s._v(" "),t("p",[s._v("è¿™ä¸€è®²ä¸»è¦è§£å†³çš„é—®é¢˜æ˜¯"),t("strong",[s._v("å¦‚ä½•ç»™å®¹å™¨é…ç½®ç½‘ç»œæ¥å£, è®©å®¹å™¨å¯ä»¥å’Œå¤–é¢é€šè®¯")]),s._v("; åŒæ—¶è¿˜å­¦ä¹ äº†å½“å®¹å™¨ç½‘ç»œä¸é€šçš„æ—¶å€™, åº”è¯¥æ€ä¹ˆæ¥åšä¸€ä¸ªç®€å•è°ƒè¯•.")]),s._v(" "),t("p",[s._v("è§£å†³å®¹å™¨ä¸å¤–ç•Œé€šè®¯çš„é—®é¢˜, ä¸€å…±éœ€è¦å®Œæˆä¸¤æ­¥. ç¬¬ä¸€æ­¥æ˜¯, "),t("strong",[s._v("æ€ä¹ˆè®©æ•°æ®åŒ…ä»å®¹å™¨çš„ Network Namespace å‘é€åˆ° Host Network Namespace ä¸Š")]),s._v("; ç¬¬äºŒæ­¥, "),t("strong",[s._v("æ•°æ®åŒ…åˆ°äº† Host Network Namespace ä¹‹å, è¿˜éœ€è¦è®©å®ƒå¯ä»¥ä»å®¿ä¸»æœºçš„ eth0 å‘é€å‡ºå»")]),s._v(".")]),s._v(" "),t("p",[s._v("æƒ³è®©æ•°æ®ä»å®¹å™¨ Netowrk Namespace å‘é€åˆ° Host Network Namespace, å¯ä»¥ç”¨"),t("strong",[s._v("é…ç½®ä¸€å¯¹ veth è™šæ‹Ÿç½‘ç»œè®¾å¤‡")]),s._v("çš„æ–¹æ³•å®ç°. è€Œè®©æ•°æ®åŒ…ä»å®¿ä¸»æœºçš„ eth0 å‘é€å‡ºå», å°±ç”¨å¯ "),t("strong",[s._v("bridge+nat")]),s._v(" çš„æ–¹å¼å®Œæˆ. è¿™é‡Œè®²çš„æ˜¯æœ€åŸºæœ¬çš„ä¸€ç§é…ç½®, ä½†å®ƒä¹Ÿæ˜¯å¾ˆå¸¸ç”¨çš„ä¸€ä¸ªç½‘ç»œé…ç½®. é’ˆå¯¹å…¶ä»–ä¸åŒéœ€è¦, å®¹å™¨ç½‘ç»œè¿˜æœ‰å¾ˆå¤šç§.")]),s._v(" "),t("p",[t("strong",[s._v("é‡åˆ°å®¹å™¨ä¸­ç½‘ç»œä¸é€šçš„æƒ…å†µ, å…ˆè¦ç†è§£è‡ªå·±çš„å®¹å™¨ä»¥åŠå®¹å™¨åœ¨å®¿ä¸»æœºä¸Šçš„é…ç½®, é€šè¿‡å¯¹ä¸»è¦è®¾å¤‡ä¸Šåš tcpdump å¯ä»¥æ‰¾åˆ°å…·ä½“åœ¨å“ªä¸€æ­¥æ•°æ®åŒ…åœæ­¢äº†è½¬å‘. ç„¶åç»“åˆå†…æ ¸ç½‘ç»œé…ç½®å‚æ•°, è·¯ç”±è¡¨ä¿¡æ¯, é˜²ç«å¢™è§„åˆ™, ä¸€èˆ¬éƒ½å¯ä»¥å®šä½å‡ºæ ¹æœ¬åŸå› , æœ€ç»ˆè§£å†³è¿™ç§ç½‘ç»œå®Œå…¨ä¸é€šçš„é—®é¢˜.")])]),s._v(" "),t("p",[s._v("ä½†æ˜¯å¦‚æœæ˜¯ç½‘ç»œå¶å°”ä¸¢åŒ…çš„é—®é¢˜, è¿™ä¸ªå°±éœ€è¦ç”¨åˆ°å…¶ä»–çš„ä¸€äº›å·¥å…·æ¥åšåˆ†æäº†, è¿™ä¸ªä¼šåœ¨ä¹‹åçš„ç« èŠ‚åšè®²è§£.")]),s._v(" "),t("h4",{attrs:{id:"_17-å®¹å™¨ç½‘ç»œé…ç½®-2-å®¹å™¨ç½‘ç»œå»¶æ—¶è¦æ¯”å®¿ä¸»æœºä¸Šçš„é«˜å—"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_17-å®¹å™¨ç½‘ç»œé…ç½®-2-å®¹å™¨ç½‘ç»œå»¶æ—¶è¦æ¯”å®¿ä¸»æœºä¸Šçš„é«˜å—"}},[s._v("#")]),s._v(" 17 | å®¹å™¨ç½‘ç»œé…ç½®(2):å®¹å™¨ç½‘ç»œå»¶æ—¶è¦æ¯”å®¿ä¸»æœºä¸Šçš„é«˜å—?")]),s._v(" "),t("p",[s._v("ä¸Šä¸€è®²å­¦ä¹ äº†åœ¨å®¹å™¨ä¸­çš„ç½‘ç»œæ¥å£é…ç½®, é‡ç‚¹è®²è§£çš„"),t("strong",[s._v("æ˜¯ veth çš„æ¥å£é…ç½®æ–¹å¼")]),s._v(", è¿™ä¹Ÿæ˜¯ç»å¤§éƒ¨åˆ†å®¹å™¨ç”¨çš„ç¼ºçœçš„ç½‘ç»œé…ç½®æ–¹å¼.")]),s._v(" "),t("p",[s._v("ä¸è¿‡ä» veth çš„è¿™ç§ç½‘ç»œæ¥å£é…ç½®ä¸Šçœ‹, ä¸€ä¸ªæ•°æ®åŒ…è¦ä»å®¹å™¨é‡Œå‘é€åˆ°å®¿ä¸»æœºå¤–, éœ€è¦å…ˆ"),t("mark",[t("strong",[s._v("ä»å®¹å™¨é‡Œçš„ eth0 (veth_container) æŠŠåŒ…å‘é€åˆ°å®¿ä¸»æœºä¸Š veth_host, ç„¶åå†åœ¨å®¿ä¸»æœºä¸Šé€šè¿‡ nat æˆ–è€…è·¯ç”±çš„æ–¹å¼, ç»è¿‡å®¿ä¸»æœºä¸Šçš„ eth0 å‘å¤–å‘é€")])]),s._v(".")]),s._v(" "),t("p",[t("img",{attrs:{src:"/img/219f774010ba68f3a9180f84c4d42a25-20230731161430-2h360s0.png",alt:""}})]),s._v(" "),t("p",[s._v("è¿™ç§å®¹å™¨å‘å¤–å‘é€æ•°æ®åŒ…çš„è·¯å¾„, ç›¸æ¯”å®¿ä¸»æœºä¸Šç›´æ¥å‘å¤–å‘é€æ•°æ®åŒ…çš„è·¯å¾„, å¾ˆæ˜æ˜¾è¦"),t("strong",[s._v("å¤šäº†ä¸€æ¬¡æ¥å£å±‚çš„å‘é€å’Œæ¥æ”¶")]),s._v(". å°½ç®¡ veth æ˜¯è™šæ‹Ÿç½‘ç»œæ¥å£, åœ¨è½¯ä»¶ä¸Šè¿˜æ˜¯ä¼šå¢åŠ ä¸€äº›å¼€é”€. å¦‚æœåº”ç”¨ç¨‹åºå¯¹ç½‘ç»œæ€§èƒ½æœ‰å¾ˆé«˜çš„è¦æ±‚, ç‰¹åˆ«æ˜¯ä¹‹å‰è¿è¡Œåœ¨ç‰©ç†æœºå™¨ä¸Š, ç°åœ¨è¿ç§»åˆ°å®¹å™¨ä¸Šçš„, å¦‚æœç½‘ç»œé…ç½®é‡‡ç”¨ veth æ–¹å¼, å°±ä¼šå‡ºç°"),t("strong",[s._v("ç½‘ç»œå»¶æ—¶å¢åŠ ")]),s._v("çš„ç°è±¡.")]),s._v(" "),t("p",[s._v("æœ¬èŠ‚å°±æ¥èŠä¸€èŠ, "),t("strong",[s._v("å®¹å™¨ç½‘ç»œæ¥å£å¯¹äºå®¹å™¨ä¸­åº”ç”¨ç¨‹åºç½‘ç»œå»¶æ—¶æœ‰æ€æ ·çš„å½±å“, è¿˜æœ‰è¿™ä¸ªé—®é¢˜åº”è¯¥æ€ä¹ˆè§£å†³")]),s._v(".")]),s._v(" "),t("h5",{attrs:{id:"_1-é—®é¢˜é‡ç°-2"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-é—®é¢˜é‡ç°-2"}},[s._v("#")]),s._v(" 1.é—®é¢˜é‡ç°")]),s._v(" "),t("p",[s._v("å¯¹äºè¿™ç§ veth æ¥å£é…ç½®å¯¼è‡´ç½‘ç»œå»¶æ—¶å¢åŠ çš„ç°è±¡, å¯ä»¥é€šè¿‡è¿è¡Œ "),t("strong",[s._v("netperf")]),s._v("(Netperf æ˜¯ä¸€ä¸ªè¡¡é‡ç½‘ç»œæ€§èƒ½çš„å·¥å…·, å®ƒå¯ä»¥æä¾›å•å‘ååé‡å’Œç«¯åˆ°ç«¯å»¶è¿Ÿçš„æµ‹è¯•)æ¥æ¨¡æ‹Ÿä¸€ä¸‹. è¿™é‡Œéœ€è¦ä¸¤å°"),t("strong",[s._v("è™šæ‹Ÿæœºæˆ–è€…ç‰©ç†æœº")]),s._v(", è¿™ä¸¤å°æœºå™¨éœ€è¦åŒå¤„äºä¸€ä¸ª"),t("strong",[s._v("äºŒå±‚çš„ç½‘ç»œ")]),s._v("ä¸­.")]),s._v(" "),t("p",[s._v("å…·ä½“çš„é…ç½®ç¤ºæ„å›¾å¦‚ä¸‹:")]),s._v(" "),t("p",[t("img",{attrs:{src:"/img/785bdc55d6bc1fb589311caf46bac81f-20230731161430-repdrum.png",alt:""}})]),s._v(" "),t("p",[s._v("é¦–å…ˆéœ€è¦åœ¨ç¬¬ä¸€å°æœºå™¨ä¸Šå¯åŠ¨ä¸€ä¸ª veth æ¥å£çš„"),t("strong",[s._v("å®¹å™¨")]),s._v(", å®¹å™¨çš„å¯åŠ¨å’Œå®¿ä¸»æœºä¸Šçš„é…ç½®å¯ä»¥å‚è€ƒä¸€ä¸‹è¿™é‡Œçš„è„šæœ¬. åœ¨ç¬¬äºŒå°æœºå™¨ä¸Š, åªè¦å¯åŠ¨ä¸€ä¸ª netserver å°±å¯ä»¥äº†. ç„¶ååˆ†åˆ«åœ¨"),t("strong",[s._v("å®¹å™¨é‡Œå’Œå®¿ä¸»æœºä¸Šè¿è¡Œä¸ netserver äº¤äº’çš„ netperf")]),s._v(", å†æ¯”è¾ƒä¸€ä¸‹å®ƒä»¬å»¶æ—¶çš„å·®å¼‚.")]),s._v(" "),t("p",[s._v("å¯ä»¥è¿è¡Œ netperf çš„ TCP_RR æµ‹è¯•ç”¨ä¾‹, TCP_RR æ˜¯ netperf é‡Œä¸“é—¨ç”¨æ¥æµ‹è¯•ç½‘ç»œå»¶æ—¶çš„, ç¼ºçœæ¯æ¬¡è¿è¡Œ 10 ç§’é’Ÿ. è¿è¡Œä»¥å, è¿˜è¦è®¡ç®—å¹³å‡æ¯ç§’é’Ÿ TCP request/response çš„æ¬¡æ•°, è¿™ä¸ªæ¬¡æ•°è¶Šé«˜, å°±è¯´æ˜å»¶æ—¶è¶Šå°.")]),s._v(" "),t("p",[s._v("æ¥ä¸‹æ¥å…ˆåœ¨ç¬¬ä¸€å°æœºå™¨çš„"),t("strong",[s._v("å®¿ä¸»æœº")]),s._v("ä¸Šç›´æ¥è¿è¡Œ netperf çš„ TCP_RR æµ‹è¯•ç”¨ä¾‹ 3 è½®, å¾—åˆ°çš„å€¼åˆ†åˆ«æ˜¯ 2504.92, 2410.14 å’Œ 2422.81, è®¡ç®—ä¸€ä¸‹å¯ä»¥å¾—åˆ°ä¸‰è½® Transactions å¹³å‡å€¼æ˜¯ 2446/s.")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ./netperf -H 192.168.0.194 -t TCP_RR")]),s._v("\nMIGRATED TCP REQUEST/RESPONSE TEST from "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.0")]),s._v(".0.0 "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.0")]),s._v(".0.0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" port "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" AF_INET to "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".0.194 "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" port "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" AF_INET "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" first burst "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\nLocal /Remote\nSocket Size   Request  Resp.   Elapsed  Trans.\nSend   Recv   Size     Size    Time     Rate\nbytes  Bytes  bytes    bytes   secs.    per sec\n \n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("16384")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("131072")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("        "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("       "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.00")]),s._v("    "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2504.92")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("16384")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("131072")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ./netperf -H 192.168.0.194 -t TCP_RR")]),s._v("\nMIGRATED TCP REQUEST/RESPONSE TEST from "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.0")]),s._v(".0.0 "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.0")]),s._v(".0.0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" port "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" AF_INET to "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".0.194 "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" port "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" AF_INET "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" first burst "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\nLocal /Remote\nSocket Size   Request  Resp.   Elapsed  Trans.\nSend   Recv   Size     Size    Time     Rate\nbytes  Bytes  bytes    bytes   secs.    per sec\n \n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("16384")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("131072")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("        "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("       "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.00")]),s._v("    "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2410.14")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("16384")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("131072")]),s._v("\n \n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ./netperf -H 192.168.0.194 -t TCP_RR")]),s._v("\nMIGRATED TCP REQUEST/RESPONSE TEST from "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.0")]),s._v(".0.0 "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.0")]),s._v(".0.0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" port "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" AF_INET to "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".0.194 "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" port "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" AF_INET "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" first burst "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\nLocal /Remote\nSocket Size   Request  Resp.   Elapsed  Trans.\nSend   Recv   Size     Size    Time     Rate\nbytes  Bytes  bytes    bytes   secs.    per sec\n \n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("16384")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("131072")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("        "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("       "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.00")]),s._v("    "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2422.81")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("16384")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("131072")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br"),t("span",{staticClass:"line-number"},[s._v("25")]),t("br"),t("span",{staticClass:"line-number"},[s._v("26")]),t("br"),t("span",{staticClass:"line-number"},[s._v("27")]),t("br"),t("span",{staticClass:"line-number"},[s._v("28")]),t("br")])]),t("p",[s._v("åŒæ ·å†åœ¨"),t("strong",[s._v("å®¹å™¨ä¸­")]),s._v("è¿è¡Œä¸€ä¸‹ netperf çš„ TCP_RR, ä¹Ÿä¸€æ ·è¿è¡Œä¸‰è½®, è®¡ç®—ä¸€ä¸‹è¿™ä¸‰æ¬¡çš„å¹³å‡å€¼, å¾—åˆ°çš„å€¼æ˜¯ 2141.")]),s._v(" "),t("p",[s._v("æ‹¿è¿™æ¬¡å®¹å™¨ç¯å¢ƒä¸­çš„å¹³å‡å€¼å’Œå®¿ä¸»æœºä¸Šå¾—åˆ°çš„å€¼ 2446 åšæ¯”è¾ƒ, ä¼šå‘ç° Transactions ä¸‹é™äº†å¤§æ¦‚ 12.5%, ä¹Ÿå°±æ˜¯"),t("strong",[s._v("ç½‘ç»œçš„å»¶æ—¶")]),s._v("è¶…è¿‡äº† 10%.")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@4150e2a842b5 /"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ./netperf -H 192.168.0.194 -t TCP_RR")]),s._v("\nMIGRATED TCP REQUEST/RESPONSE TEST from "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.0")]),s._v(".0.0 "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.0")]),s._v(".0.0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" port "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" AF_INET to "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".0.194 "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" port "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" AF_INET "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" first burst "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\nLocal /Remote\nSocket Size   Request  Resp.   Elapsed  Trans.\nSend   Recv   Size     Size    Time     Rate\nbytes  Bytes  bytes    bytes   secs.    per sec\n \n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("16384")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("131072")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("        "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("       "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.00")]),s._v("    "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2104.68")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("16384")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("131072")]),s._v("\n \n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@4150e2a842b5 /"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ./netperf -H 192.168.0.194 -t TCP_RR")]),s._v("\nMIGRATED TCP REQUEST/RESPONSE TEST from "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.0")]),s._v(".0.0 "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.0")]),s._v(".0.0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" port "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" AF_INET to "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".0.194 "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" port "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" AF_INET "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" first burst "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\nLocal /Remote\nSocket Size   Request  Resp.   Elapsed  Trans.\nSend   Recv   Size     Size    Time     Rate\nbytes  Bytes  bytes    bytes   secs.    per sec\n \n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("16384")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("131072")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("        "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("       "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.00")]),s._v("    "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2146.34")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("16384")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("131072")]),s._v("\n \n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@4150e2a842b5 /"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ./netperf -H 192.168.0.194 -t TCP_RR")]),s._v("\nMIGRATED TCP REQUEST/RESPONSE TEST from "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.0")]),s._v(".0.0 "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.0")]),s._v(".0.0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" port "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" AF_INET to "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".0.194 "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" port "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" AF_INET "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" first burst "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\nLocal /Remote\nSocket Size   Request  Resp.   Elapsed  Trans.\nSend   Recv   Size     Size    Time     Rate\nbytes  Bytes  bytes    bytes   secs.    per sec\n \n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("16384")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("131072")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("        "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("       "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.00")]),s._v("    "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2173.79")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("16384")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("131072")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br"),t("span",{staticClass:"line-number"},[s._v("25")]),t("br"),t("span",{staticClass:"line-number"},[s._v("26")]),t("br"),t("span",{staticClass:"line-number"},[s._v("27")]),t("br"),t("span",{staticClass:"line-number"},[s._v("28")]),t("br"),t("span",{staticClass:"line-number"},[s._v("29")]),t("br")])]),t("h5",{attrs:{id:"_2-åˆ†æé—®é¢˜"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-åˆ†æé—®é¢˜"}},[s._v("#")]),s._v(" 2.åˆ†æé—®é¢˜")]),s._v(" "),t("p",[s._v("åˆšæ‰å·²ç»å¾—åˆ°äº†æµ‹è¯•çš„æ•°å€¼, å‘ç° veth æ–¹å¼çš„ç¡®å¸¦æ¥äº†å¾ˆé«˜çš„ç½‘ç»œå»¶æ—¶. ç°åœ¨å…ˆæ¥åˆ†æä¸€ä¸‹, ä¸ºä»€ä¹ˆ veth ä¼šå¸¦æ¥è¿™ä¹ˆå¤§çš„ç½‘ç»œå»¶æ—¶, ç„¶åå†çœ‹çœ‹æœ‰ä»€ä¹ˆæ–¹æ³•å¯ä»¥é™ä½å®¹å™¨é‡Œçš„ç½‘ç»œå»¶æ—¶.")]),s._v(" "),t("p",[s._v("å…ˆå›é¡¾ä¸€ä¸‹å®¹å™¨é‡Œ veth æ¥å£çš„é…ç½®, è¿˜æ˜¯æ‹¿ä¸Šä¸€è®²é‡Œå®¹å™¨ veth çš„å›¾ä½œä¸ºä¾‹å­.")]),s._v(" "),t("p",[t("img",{attrs:{src:"/img/03863cd49dad179c08c05765a419462c-20230731161430-tgwj5wa.png",alt:""}})]),s._v(" "),t("p",[s._v("ä¸Šä¸€è®²æåˆ°è¿‡, veth çš„è™šæ‹Ÿç½‘ç»œæ¥å£ä¸€èˆ¬éƒ½æ˜¯"),t("strong",[s._v("æˆå¯¹å‡ºç°")]),s._v(", å°±åƒä¸Šé¢å›¾é‡Œçš„ veth_container å’Œ veth_host ä¸€æ ·. åœ¨æ¯æ¬¡ç½‘ç»œä¼ è¾“çš„è¿‡ç¨‹ä¸­, æ•°æ®åŒ…éƒ½éœ€è¦"),t("strong",[s._v("é€šè¿‡ veth_container è¿™ä¸ªæ¥å£å‘å¤–å‘é€, è€Œä¸”å¿…é¡»ä¿è¯ veth_host å…ˆæ¥æ”¶åˆ°è¿™ä¸ªæ•°æ®åŒ…")]),s._v(".")]),s._v(" "),t("p",[s._v("è™½ç„¶ veth æ˜¯ä¸€ä¸ªè™šæ‹Ÿçš„ç½‘ç»œæ¥å£, ä½†æ˜¯åœ¨æ¥æ”¶æ•°æ®åŒ…çš„æ“ä½œä¸Š, "),t("strong",[s._v("è¿™ä¸ªè™šæ‹Ÿæ¥å£å’ŒçœŸå®çš„ç½‘è·¯æ¥å£å¹¶æ²¡æœ‰å¤ªå¤§çš„åŒºåˆ«")]),s._v(". è¿™é‡Œé™¤äº†æ²¡æœ‰ç¡¬ä»¶ä¸­æ–­çš„å¤„ç†, å…¶ä»–æ“ä½œéƒ½å·®ä¸å¤š, ç‰¹åˆ«æ˜¯è½¯ä¸­æ–­(softirq)çš„å¤„ç†éƒ¨åˆ†å…¶å®å°±å’ŒçœŸå®çš„ç½‘ç»œæ¥å£æ˜¯ä¸€æ ·çš„.")]),s._v(" "),t("p",[s._v("å¯ä»¥é€šè¿‡é˜…è¯» Linux å†…æ ¸é‡Œçš„ veth çš„é©±åŠ¨ä»£ç (drivers/net/veth.c)ç¡®è®¤ä¸€ä¸‹. veth å‘é€æ•°æ®çš„å‡½æ•°æ˜¯ veth_xmit(), å®ƒé‡Œé¢çš„ä¸»è¦æ“ä½œå°±æ˜¯"),t("strong",[s._v("æ‰¾åˆ° veth peer è®¾å¤‡, ç„¶åè§¦å‘ peer è®¾å¤‡å»æ¥æ”¶æ•°æ®åŒ…")]),s._v(".")]),s._v(" "),t("p",[s._v("æ¯”å¦‚ veth_container è¿™ä¸ªæ¥å£è°ƒç”¨äº† veth_xmit() æ¥å‘é€æ•°æ®åŒ…, æœ€åå°±æ˜¯è§¦å‘äº†å®ƒçš„ peer è®¾å¤‡ veth_host å»è°ƒç”¨ netif_rx() æ¥æ¥æ”¶æ•°æ®åŒ…. ä¸»è¦çš„ä»£ç åˆ—åœ¨ä¸‹é¢äº†:")]),s._v(" "),t("div",{staticClass:"language-c line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-c"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("static")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("netdev_tx_t")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("veth_xmit")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("struct")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("sk_buff")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("skb"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("struct")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("net_device")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("dev"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("/* æ‹¿åˆ°veth peerè®¾å¤‡çš„net_device */")]),s._v("\n    rcv "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("rcu_dereference")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("priv"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("peer"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("/* å°†æ•°æ®é€åˆ°veth peerè®¾å¤‡ */")]),s._v(" \n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("likely")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("veth_forward_skb")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("rcv"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" skb"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" rq"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" rcv_xdp"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),s._v(" NET_RX_SUCCESS"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n \n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("static")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("veth_forward_skb")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("struct")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("net_device")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("dev"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("struct")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("sk_buff")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("skb"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n                            "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("struct")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("veth_rq")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("rq"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" bool xdp"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n     "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("/* è¿™é‡Œæœ€åè°ƒç”¨äº† netif_rx() */")]),s._v("\n     "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("__dev_forward_skb")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("dev"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" skb"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("?")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" xdp "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("?")]),s._v("\n             "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("veth_xdp_rx")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("rq"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" skb"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v("\n             "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("netif_rx")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("skb"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br")])]),t("p",[s._v("è€Œ netif_rx() æ˜¯ä¸€ä¸ªç½‘ç»œè®¾å¤‡é©±åŠ¨é‡Œé¢æ ‡å‡†çš„æ¥æ”¶æ•°æ®åŒ…çš„å‡½æ•°, netif_rx() é‡Œé¢ä¼šä¸ºè¿™ä¸ªæ•°æ®åŒ… raise ä¸€ä¸ª softirq.")]),s._v(" "),t("p",[s._v("__raise_softirq_irqoff(NET_RX_SOFTIRQ);")]),s._v(" "),t("p",[s._v("å…¶å® softirq è¿™ä¸ªæ¦‚å¿µ, ä¹‹å‰åœ¨ CPU çš„æ¨¡å—ä¸­ä¹Ÿæåˆ°è¿‡. åœ¨å¤„ç†ç½‘ç»œæ•°æ®çš„æ—¶å€™, ä¸€äº›è¿è¡Œæ—¶é—´è¾ƒé•¿è€Œä¸”ä¸èƒ½åœ¨ç¡¬ä¸­æ–­ä¸­å¤„ç†çš„å·¥ä½œ, å°±ä¼šé€šè¿‡ softirq æ¥å¤„ç†. ä¸€èˆ¬åœ¨ç¡¬ä»¶ä¸­æ–­å¤„ç†ç»“æŸä¹‹å, ç½‘ç»œ softirq çš„å‡½æ•°æ‰ä¼šå†å»æ‰§è¡Œæ²¡æœ‰å®Œæˆçš„åŒ…çš„å¤„ç†å·¥ä½œ. å³ä½¿è¿™é‡Œ softirq çš„æ‰§è¡Œé€Ÿåº¦å¾ˆå¿«, è¿˜æ˜¯ä¼šå¸¦æ¥é¢å¤–çš„å¼€é”€.")]),s._v(" "),t("p",[t("mark",[s._v("**æ‰€ä»¥æ ¹æ® veth è¿™ä¸ªè™šæ‹Ÿç½‘ç»œè®¾å¤‡çš„å®ç°æ–¹å¼, å¯ä»¥çœ‹åˆ°å®ƒå¿…ç„¶ä¼šå¸¦æ¥é¢å¤–çš„å¼€é”€, è¿™æ ·å°±ä¼šå¢åŠ æ•°æ®åŒ…çš„ç½‘ç»œå»¶æ—¶. **")])]),s._v(" "),t("h5",{attrs:{id:"_3-è§£å†³é—®é¢˜-9"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-è§£å†³é—®é¢˜-9"}},[s._v("#")]),s._v(" 3.è§£å†³é—®é¢˜")]),s._v(" "),t("p",[s._v("æœ‰ä»€ä¹ˆæ–¹æ³•å¯ä»¥å‡å°‘å®¹å™¨çš„ç½‘ç»œå»¶æ—¶å‘¢? ä½ å¯èƒ½ä¼šæƒ³åˆ°, å¯ä¸å¯ä»¥"),t("strong",[s._v("ä¸ä½¿ç”¨")]),s._v(" veth è¿™ä¸ªæ–¹å¼é…ç½®ç½‘ç»œæ¥å£, è€Œæ˜¯æ¢æˆåˆ«çš„æ–¹å¼å‘¢?")]),s._v(" "),t("p",[s._v("çš„ç¡®æ˜¯è¿™æ ·, å…¶å®é™¤äº† veth ä¹‹å¤–, å®¹å™¨è¿˜å¯ä»¥é€‰æ‹©å…¶ä»–çš„ç½‘ç»œé…ç½®æ–¹å¼. åœ¨ Docker çš„æ–‡æ¡£ä¸­æåˆ°äº† "),t("strong",[s._v("macvlan")]),s._v(" çš„é…ç½®æ–¹å¼, å’Œ macvlan å¾ˆç±»ä¼¼çš„æ–¹å¼è¿˜æœ‰ "),t("strong",[s._v("ipvlan")]),s._v(".")]),s._v(" "),t("p",[s._v("å…ˆæ¥ç®€å•çœ‹ä¸€ä¸‹ macvlan å’Œ ipvlan çš„å¼‚åŒç‚¹.")]),s._v(" "),t("p",[s._v("å…ˆæ¥çœ‹è¿™ä¸¤ä¸ªæ–¹å¼çš„ç›¸åŒä¹‹å¤„, æ— è®ºæ˜¯ macvlan è¿˜æ˜¯ ipvlan, å®ƒä»¬"),t("strong",[s._v("éƒ½æ˜¯åœ¨ä¸€ä¸ªç‰©ç†çš„ç½‘ç»œæ¥å£ä¸Šå†é…ç½®å‡ ä¸ªè™šæ‹Ÿçš„ç½‘ç»œæ¥å£")]),s._v(". åœ¨è¿™äº›è™šæ‹Ÿçš„ç½‘ç»œæ¥å£ä¸Š, éƒ½å¯ä»¥"),t("strong",[s._v("é…ç½®ç‹¬ç«‹çš„ IP, å¹¶ä¸”è¿™äº› IP å¯ä»¥å±äºä¸åŒçš„ Namespace")]),s._v(".")]),s._v(" "),t("p",[s._v("ç„¶åå†è¯´è¯´å®ƒä»¬çš„ä¸åŒç‚¹. "),t("mark",[t("strong",[s._v("å¯¹äº macvlan, æ¯ä¸ªè™šæ‹Ÿç½‘ç»œæ¥å£éƒ½æœ‰è‡ªå·±ç‹¬ç«‹çš„ mac åœ°å€; è€Œ ipvlan çš„è™šæ‹Ÿç½‘ç»œæ¥å£æ˜¯å’Œç‰©ç†ç½‘ç»œæ¥å£å…±äº«åŒä¸€ä¸ª mac åœ°å€")])]),s._v("â€‹ **. ** è€Œä¸”å®ƒä»¬éƒ½æœ‰è‡ªå·±çš„ L2/L3 çš„é…ç½®æ–¹å¼, ä¸è¿‡ä¸»è¦æ˜¯æ‹¿ macvlan/ipvlan æ¥å’Œ veth åšæ¯”è¾ƒ, è¿™é‡Œå¯ä»¥å…ˆå¿½ç•¥ macvlan/ipvlan è¿™äº›è¯¦ç»†çš„ç‰¹æ€§.")]),s._v(" "),t("p",[s._v("å°±ä»¥ ipvlan ä¸ºä¾‹, è¿è¡Œä¸‹é¢çš„è¿™ä¸ªè„šæœ¬, ä¸º"),t("strong",[s._v("å®¹å™¨æ‰‹åŠ¨é…ç½®ä¸Š ipvlan çš„ç½‘ç»œæ¥å£")]),s._v(".")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" run "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--init")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--name")]),s._v(" lat-test-1 "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--network")]),s._v(" none "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-d")]),s._v(" registry/latency-test:v1 "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("sleep")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("36000")]),s._v("\n \n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("pid1")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token variable"}},[t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$(")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" inspect lat-test-1 "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("grep")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-i")]),s._v(" Pid "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("head")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-n")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("awk")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'{print $2}'")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("awk")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-F")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('","')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'{print $1}'")]),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v(")")])]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$pid1")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ln")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-s")]),s._v(" /proc/"),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$pid1")]),s._v("/ns/net /var/run/netns/"),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$pid1")]),s._v("\n \n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ip")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("link")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("add")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("link")]),s._v(" eth0 ipvt1 "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("type")]),s._v(" ipvlan mode l2\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ip")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("link")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v(" dev ipvt1 netns "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$pid1")]),s._v("\n \n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ip")]),s._v(" netns "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("exec")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$pid1")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ip")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("link")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v(" ipvt1 name eth0\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ip")]),s._v(" netns "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("exec")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$pid1")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ip")]),s._v(" addr "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("add")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.17")]),s._v(".3.2/16 dev eth0\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ip")]),s._v(" netns "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("exec")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$pid1")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ip")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("link")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v(" eth0 up\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br")])]),t("p",[s._v('åœ¨è¿™ä¸ªè„šæœ¬é‡Œ, å…ˆå¯åŠ¨ä¸€ä¸ªå®¹å™¨, è¿™é‡Œç”¨ "â€”network none" çš„æ–¹å¼æ¥å¯åŠ¨, ä¹Ÿå°±æ˜¯åœ¨'),t("strong",[s._v("å®¹å™¨ä¸­æ²¡æœ‰é…ç½®ä»»ä½•çš„ç½‘ç»œæ¥å£")]),s._v(". æ¥ç€åœ¨"),t("strong",[s._v("å®¿ä¸»æœº eth0 çš„æ¥å£ä¸Šå¢åŠ ä¸€ä¸ª ipvlan è™šæ‹Ÿç½‘ç»œæ¥å£ ipvt1, å†æŠŠå®ƒåŠ å…¥åˆ°å®¹å™¨çš„ Network Namespace é‡Œé¢, é‡å‘½åä¸ºå®¹å™¨å†…çš„ eth0, å¹¶ä¸”é…ç½®ä¸Š IP")]),s._v(". è¿™æ ·å°±é…ç½®å¥½äº†ç¬¬ä¸€ä¸ªç”¨ ipvlan ç½‘ç»œæ¥å£çš„å®¹å™¨.")]),s._v(" "),t("p",[s._v("å¯ä»¥ç”¨åŒæ ·çš„æ–¹å¼é…ç½®ç¬¬äºŒä¸ªå®¹å™¨, è¿™æ ·ä¸¤ä¸ªå®¹å™¨å¯ä»¥ç›¸äº’ ping ä¸€ä¸‹ IP, çœ‹çœ‹ç½‘ç»œæ˜¯å¦é…ç½®æˆåŠŸäº†.")]),s._v(" "),t("p",[s._v("ä¸¤ä¸ªå®¹å™¨é…ç½®å¥½ä¹‹å, å°±åƒä¸‹é¢å›¾ä¸­æè¿°çš„ä¸€æ ·äº†. ä»è¿™å¼ å›¾é‡Œ, å¾ˆå®¹æ˜“å°±èƒ½çœ‹å‡º macvlan/ipvlan ä¸ veth ç½‘ç»œé…ç½®æœ‰ä»€ä¹ˆä¸ä¸€æ ·. "),t("mark",[t("strong",[s._v("å®¹å™¨çš„è™šæ‹Ÿç½‘ç»œæ¥å£, ç›´æ¥è¿æ¥åœ¨äº†å®¿ä¸»æœºçš„ç‰©ç†ç½‘ç»œæ¥å£ä¸Šäº†, å½¢æˆäº†ä¸€ä¸ªç½‘ç»œäºŒå±‚çš„è¿æ¥")])]),s._v(".")]),s._v(" "),t("p",[t("img",{attrs:{src:"/img/d129bf1961d38ceec98d611c42939a03-20230731161430-plxw1d9.png",alt:""}})]),s._v(" "),t("p",[s._v("å¦‚æœä»å®¹å™¨é‡Œå‘å®¿ä¸»æœºå¤–å‘é€æ•°æ®, çœ‹ä¸Šå»é€šè¿‡çš„æ¥å£è¦æ¯” veth å°‘äº†, é‚£ä¹ˆå®é™…æƒ…å†µæ˜¯ä¸æ˜¯è¿™æ ·å‘¢? å…ˆæ¥çœ‹ä¸€ä¸‹ ipvlan æ¥å£å‘é€æ•°æ®çš„ä»£ç .")]),s._v(" "),t("p",[s._v("ä»ä¸‹é¢çš„ ipvlan æ¥å£çš„å‘é€ä»£ç å¯ä»¥çœ‹åˆ°, å¦‚æœæ˜¯"),t("strong",[s._v("å¾€å®¿ä¸»æœºå¤–å‘é€æ•°æ®, å‘é€å‡½æ•°ä¼šç›´æ¥æ‰¾åˆ° ipvlan è™šæ‹Ÿæ¥å£å¯¹åº”çš„ç‰©ç†ç½‘ç»œæ¥å£")]),s._v(".")]),s._v(" "),t("p",[s._v("æ¯”å¦‚åœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­, è¿™ä¸ªç‰©ç†æ¥å£å°±æ˜¯å®¿ä¸»æœºä¸Šçš„ "),t("strong",[s._v("eth0")]),s._v(", ç„¶åç›´æ¥è°ƒç”¨ dev_queue_xmit(), é€šè¿‡ç‰©ç†æ¥å£æŠŠæ•°æ®ç›´æ¥å‘é€å‡ºå».")]),s._v(" "),t("div",{staticClass:"language-c line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-c"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("static")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ipvlan_xmit_mode_l2")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("struct")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("sk_buff")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("skb"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("struct")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("net_device")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("dev"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ipvlan_is_vepa")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("ipvlan"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("port"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&&")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ether_addr_equal")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("eth"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("h_dest"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" eth"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("h_source"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("else")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("is_multicast_ether_addr")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("eth"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("h_dest"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("/* \n     * å¯¹äºæ™®é€šçš„å¯¹å¤–å‘é€æ•°æ®, ä¸Šé¢çš„if å’Œ else ifä¸­çš„æ¡ä»¶éƒ½ä¸æˆç«‹, \n     * æ‰€ä»¥ä¼šæ‰§è¡Œåˆ°è¿™ä¸€æ­¥, æ‹¿åˆ°ipvlanå¯¹åº”çš„ç‰©ç†ç½‘è·¯æ¥å£è®¾å¤‡, \n     * ç„¶åç›´æ¥ä»è¿™ä¸ªè®¾å¤‡å‘é€æ•°æ®. \n     */")]),s._v(" \n    skb"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("dev "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" ipvlan"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("phy_dev"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("dev_queue_xmit")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("skb"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br")])]),t("p",[t("strong",[s._v("å’Œ veth æ¥å£ç›¸æ¯”, ç”¨ ipvlan å‘é€å¯¹å¤–æ•°æ®å°±è¦ç®€å•å¾—å¤š, å› ä¸ºè¿™ç§æ–¹å¼æ²¡æœ‰å†…éƒ¨é¢å¤–çš„ softirq å¤„ç†å¼€é”€.")])]),s._v(" "),t("p",[s._v("ç°åœ¨è¿˜å¯ä»¥çœ‹ä¸€ä¸‹, åœ¨å®é™…ç”Ÿäº§ç¯å¢ƒä¸­, ä¸€ä¸ªåº”ç”¨ç¨‹åºè·‘åœ¨ä½¿ç”¨ veth æ¥å£çš„å®¹å™¨ä¸­, è·Ÿè¿™ä¸ªåº”ç”¨ç¨‹åºè·‘åœ¨ä½¿ç”¨ ipvlan æ¥å£çš„å®¹å™¨ä¸­, ä¸¤è€…çš„ç½‘ç»œå»¶æ—¶å·®å¼‚æ˜¯æ€æ ·çš„.")]),s._v(" "),t("p",[s._v("ä¸‹é¢è¿™å¼ å›¾æ˜¯ç½‘ç»œå»¶æ—¶çš„ç›‘æ§å›¾, "),t("strong",[s._v("å›¾é‡Œè“è‰²çš„çº¿è¡¨ç¤ºç¨‹åºè¿è¡Œåœ¨ veth å®¹å™¨ä¸­, é»„è‰²çº¿è¡¨ç¤ºç¨‹åºè¿è¡Œåœ¨ ipvlan çš„å®¹å™¨é‡Œ, ç»¿è‰²çš„çº¿ä»£è¡¨ç¨‹åºç›´æ¥è¿è¡Œåœ¨ç‰©ç†æœºä¸Š")]),s._v(". ä»è¿™å¼ å»¶æ—¶(Latency)å›¾å¯ä»¥çœ‹åˆ°, åœ¨ veth å®¹å™¨é‡Œç¨‹åºçš„ç½‘ç»œå»¶æ—¶è¦æ˜æ˜¾é«˜ä¸€äº›, è€Œç¨‹åºåœ¨ ipvlan å®¹å™¨é‡Œçš„ç½‘ç»œå»¶æ—¶å·²ç»æ¯”è¾ƒ"),t("strong",[s._v("æ¥è¿‘")]),s._v("ç‰©ç†æœºä¸Šçš„ç½‘ç»œå»¶æ—¶äº†.")]),s._v(" "),t("p",[t("img",{attrs:{src:"/img/2ee1cf7312d7404ba31aa48201da0d38-20230731161430-opanz4h.png",alt:""}})]),s._v(" "),t("p",[t("strong",[s._v("æ‰€ä»¥å¯¹äºç½‘ç»œå»¶æ—¶æ•æ„Ÿçš„åº”ç”¨ç¨‹åº, å¯ä»¥è€ƒè™‘ä½¿ç”¨ ipvlan/macvlan çš„å®¹å™¨ç½‘ç»œé…ç½®æ–¹å¼æ¥æ›¿æ¢ç¼ºçœçš„ veth ç½‘ç»œé…ç½®.")])]),s._v(" "),t("h5",{attrs:{id:"_4-é‡ç‚¹å°ç»“-3"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_4-é‡ç‚¹å°ç»“-3"}},[s._v("#")]),s._v(" 4.é‡ç‚¹å°ç»“")]),s._v(" "),t("p",[s._v("æœ¬èŠ‚ä¸»è¦è®¨è®ºäº†å®¹å™¨ç½‘ç»œæ¥å£å¯¹å®¹å™¨ä¸­åº”ç”¨ç¨‹åºç½‘ç»œå»¶æ—¶çš„å½±å“. å®¹å™¨é€šå¸¸ç¼ºçœä½¿ç”¨ veth è™šæ‹Ÿç½‘ç»œæ¥å£, ä¸è¿‡ veth æ¥å£ä¼šæœ‰æ¯”è¾ƒå¤§çš„ç½‘ç»œå»¶æ—¶. å¯ä»¥ä½¿ç”¨ netperf è¿™ä¸ªå·¥å…·æ¥æ¯”è¾ƒç½‘ç»œå»¶æ—¶, ç›¸æ¯”ç‰©ç†æœºä¸Šçš„ç½‘ç»œå»¶æ—¶, ä½¿ç”¨ veth æ¥å£å®¹å™¨çš„ç½‘ç»œå»¶æ—¶ä¼šå¢åŠ è¶…è¿‡ 10%.")]),s._v(" "),t("p",[s._v("é€šè¿‡å¯¹ veth å®ç°çš„ä»£ç åšåˆ†æ, å¯ä»¥çœ‹åˆ°ç”±äº veth æ¥å£æ˜¯æˆå¯¹å·¥ä½œ, **åœ¨å¯¹å¤–å‘é€æ•°æ®çš„æ—¶å€™, peer veth æ¥å£éƒ½ä¼š raise softirq æ¥å®Œæˆä¸€æ¬¡æ”¶åŒ…æ“ä½œ, è¿™æ ·å°±ä¼šå¸¦æ¥æ•°æ®åŒ…å¤„ç†çš„é¢å¤–å¼€é”€. **")]),s._v(" "),t("p",[s._v("å¦‚æœè¦å‡å°å®¹å™¨ç½‘ç»œå»¶æ—¶, å°±å¯ä»¥"),t("strong",[s._v("ç»™å®¹å™¨é…ç½® ipvlan/macvlan çš„ç½‘ç»œæ¥å£æ¥æ›¿ä»£ veth ç½‘ç»œæ¥å£")]),s._v(". Ipvlan/macvlan ç›´æ¥åœ¨ç‰©ç†ç½‘ç»œæ¥å£ä¸Šè™šæ‹Ÿå‡ºæ¥å£, åœ¨å‘é€å¯¹å¤–æ•°æ®åŒ…çš„æ—¶å€™å¯ä»¥ç›´æ¥é€šè¿‡ç‰©ç†æ¥å£å®Œæˆ, æ²¡æœ‰èŠ‚ç‚¹å†…éƒ¨ç±»ä¼¼ veth çš„é‚£ç§ softirq çš„å¼€é”€. **å®¹å™¨ä½¿ç”¨ ipvlan/maclan çš„ç½‘ç»œæ¥å£, å®ƒçš„ç½‘ç»œå»¶æ—¶å¯ä»¥éå¸¸æ¥è¿‘ç‰©ç†ç½‘ç»œæ¥å£çš„å»¶æ—¶. **")]),s._v(" "),t("p",[s._v("å¯¹äºå»¶æ—¶æ•æ„Ÿçš„åº”ç”¨ç¨‹åº, å¯ä»¥è€ƒè™‘ä½¿ç”¨ ipvlan/macvlan ç½‘ç»œæ¥å£çš„å®¹å™¨. ä¸è¿‡ç”±äº ipvlan/macvlan ç½‘ç»œæ¥å£ç›´æ¥æŒ‚è½½åœ¨ç‰©ç†ç½‘ç»œæ¥å£ä¸Š, å¯¹äº"),t("strong",[s._v("éœ€è¦ä½¿ç”¨ iptables è§„åˆ™çš„å®¹å™¨, æ¯”å¦‚ Kubernetes é‡Œä½¿ç”¨ service çš„å®¹å™¨, å°±ä¸èƒ½å·¥ä½œäº†")]),s._v(". è¿™å°±éœ€è¦ç»“åˆå®é™…åº”ç”¨çš„éœ€æ±‚åšä¸ªåˆ¤æ–­, å†é€‰æ‹©åˆé€‚çš„æ–¹æ¡ˆ.")]),s._v(" "),t("h4",{attrs:{id:"_18-å®¹å™¨ç½‘ç»œé…ç½®-3-å®¹å™¨ä¸­çš„ç½‘ç»œä¹±åºåŒ…æ€ä¹ˆè¿™ä¹ˆé«˜"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_18-å®¹å™¨ç½‘ç»œé…ç½®-3-å®¹å™¨ä¸­çš„ç½‘ç»œä¹±åºåŒ…æ€ä¹ˆè¿™ä¹ˆé«˜"}},[s._v("#")]),s._v(" 18 | å®¹å™¨ç½‘ç»œé…ç½®(3):å®¹å™¨ä¸­çš„ç½‘ç»œä¹±åºåŒ…æ€ä¹ˆè¿™ä¹ˆé«˜?")]),s._v(" "),t("p",[s._v("æœ¬èŠ‚æ¥èŠä¸€ä¸‹å®¹å™¨ä¸­å‘åŒ…ä¹±åºçš„é—®é¢˜. è¿™ä¸ªé—®é¢˜ä¹ŸåŒæ ·æ¥è‡ªäºå·¥ä½œå®è·µ, ç”¨æˆ·æŠŠä»–ä»¬çš„åº”ç”¨ç¨‹åºä»ç‰©ç†æœºè¿ç§»åˆ°å®¹å™¨ä¹‹å, ä»ç½‘ç»œç›‘æ§ä¸­å‘ç°, "),t("strong",[s._v("å®¹å™¨ä¸­æ•°æ®åŒ…çš„é‡ä¼ çš„æ•°é‡è¦æ¯”åœ¨ç‰©ç†æœºé‡Œé«˜äº†ä¸å°‘")]),s._v(".")]),s._v(" "),t("p",[s._v("å‰é¢å·²ç»çŸ¥é“äº†å®¹å™¨ç½‘ç»œç¼ºçœçš„æ¥å£æ˜¯ veth, veth æ¥å£éƒ½æ˜¯"),t("strong",[s._v("æˆå¯¹")]),s._v("ä½¿ç”¨çš„. å®¹å™¨é€šè¿‡ veth æ¥å£å‘å¤–å‘é€æ•°æ®, é¦–å…ˆéœ€è¦ä» veth çš„ä¸€ä¸ªæ¥å£å‘é€ç»™è·Ÿå®ƒæˆå¯¹çš„å¦ä¸€ä¸ªæ¥å£. é‚£ä¹ˆ"),t("strong",[s._v("è¿™ç§æ¥å£ä¼šä¸ä¼šå¼•èµ·æ›´å¤šçš„ç½‘ç»œé‡ä¼ å‘¢? å¦‚æœä¼šå¼•èµ·é‡ä¼ , åŸå› æ˜¯ä»€ä¹ˆ, æˆ‘ä»¬åˆè¦å¦‚ä½•è§£å†³å‘¢")]),s._v("?")]),s._v(" "),t("h5",{attrs:{id:"_1-é—®é¢˜é‡ç°-3"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-é—®é¢˜é‡ç°-3"}},[s._v("#")]),s._v(" 1.é—®é¢˜é‡ç°")]),s._v(" "),t("p",[s._v("å¯ä»¥åœ¨å®¹å™¨é‡Œè¿è¡Œä¸€ä¸‹ "),t("code",[s._v("iperf3")]),s._v('â€‹ å‘½ä»¤, å‘å®¹å™¨å¤–éƒ¨å‘é€ä¸€ä¸‹æ•°æ®, ä» iperf3 çš„è¾“å‡º "Retr" åˆ—é‡Œ, å¯ä»¥çœ‹åˆ°æœ‰å¤šå°‘é‡ä¼ çš„æ•°æ®åŒ….')]),s._v(" "),t("p",[s._v("æ¯”å¦‚ä¸‹é¢çš„ä¾‹å­é‡Œ, å¯ä»¥çœ‹åˆ°æœ‰ 162 ä¸ªé‡ä¼ çš„æ•°æ®åŒ….")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# iperf3 -c 192.168.147.51")]),s._v("\nConnecting to "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("host")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".147.51, port "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("5201")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("local")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".225.12 port "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("51700")]),s._v(" connected to "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".147.51 port "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("5201")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v(" ID"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" Interval           Transfer     Bitrate                        Retr    Cwnd\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.00")]),s._v("-1.00   sec  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1001")]),s._v(" MBytes  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("8.40")]),s._v(" Gbits/sec  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("162")]),s._v("    "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("192")]),s._v(" KBytes\nâ€¦\n- - - - - - - - - - - - - - - - - - - - - - - - -\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v(" ID"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" Interval           Transfer     Bitrate         Retr\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.00")]),s._v("-10.00  sec  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("9.85")]),s._v(" GBytes  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("8.46")]),s._v(" Gbits/sec  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("162")]),s._v("             sender\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.00")]),s._v("-10.04  sec  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("9.85")]),s._v(" GBytes  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("8.42")]),s._v(" Gbits/sec                  receiver\n \niperf Done.\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br")])]),t("p",[t("mark",[t("strong",[s._v("ç½‘ç»œä¸­å‘ç”Ÿäº†æ•°æ®åŒ…çš„é‡ä¼ , æœ‰å¯èƒ½æ˜¯æ•°æ®åŒ…åœ¨ç½‘ç»œä¸­ä¸¢äº†, ä¹Ÿæœ‰å¯èƒ½æ˜¯æ•°æ®åŒ…ä¹±åºå¯¼è‡´çš„")])]),s._v("â€‹ **. ** é‚£ä¹ˆæ€ä¹ˆæ¥åˆ¤æ–­åˆ°åº•æ˜¯å“ªä¸€ç§æƒ…å†µå¼•èµ·çš„é‡ä¼ å‘¢?")]),s._v(" "),t("p",[s._v("æœ€ç›´æ¥çš„æ–¹æ³•å°±æ˜¯ç”¨ "),t("strong",[s._v("tcpdump")]),s._v(" å»æŠ“åŒ…, ä¸è¿‡å¯¹äºå¤§æµé‡çš„ç½‘ç»œ, ç”¨ tcpdump æŠ“åŒ…ç¬é—´å°±ä¼šæœ‰å‡ ä¸ª GB çš„æ•°æ®. å¯æ˜¯è¿™æ ·åšçš„è¯, å¸¦æ¥çš„é¢å¤–ç³»ç»Ÿå¼€é”€æ¯”è¾ƒå¤§, ç‰¹åˆ«æ˜¯åœ¨ç”Ÿäº§ç¯å¢ƒä¸­è¿™ä¸ªæ–¹æ³•ä¹Ÿä¸å¤ªå¥½ç”¨.")]),s._v(" "),t("p",[s._v("æ‰€ä»¥è¿™é‡Œæœ‰ä¸€ä¸ªç®€å•çš„æ–¹æ³•, é‚£å°±æ˜¯è¿è¡Œ "),t("strong",[s._v("netstat å‘½ä»¤æ¥")]),s._v("æŸ¥çœ‹åè®®æ ˆä¸­çš„ä¸¢åŒ…å’Œé‡ä¼ çš„æƒ…å†µ. æ¯”å¦‚åœ¨è¿è¡Œä¸Šé¢çš„ iperf3 å‘½ä»¤å‰å, éƒ½åœ¨å®¹å™¨çš„ Network Namespace é‡Œè¿è¡Œä¸€ä¸‹ netstat çœ‹çœ‹é‡ä¼ çš„æƒ…å†µ.")]),s._v(" "),t("p",[s._v("å¯ä»¥å‘ç°ä¸€å…±å‘ç”Ÿäº† 162 æ¬¡(604-442)"),t("strong",[s._v("å¿«é€Ÿé‡ä¼ ")]),s._v("(fast retransmits), è¿™ä¸ªæ•°å€¼å’Œ iperf3 ä¸­çš„ Retr åˆ—é‡Œçš„æ•°å€¼æ˜¯ä¸€æ ·çš„.")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("-bash-4.2"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# nsenter -t 51598 -n netstat -s | grep retran")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("454")]),s._v(" segments retransmited\n    "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("442")]),s._v(" fast retransmits\n-bash-4.2"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# nsenter -t 51598 -n netstat -s | grep retran")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("616")]),s._v(" segments retransmited\n    "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("604")]),s._v(" fast retransmits\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br")])]),t("h5",{attrs:{id:"_2-é—®é¢˜åˆ†æ"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-é—®é¢˜åˆ†æ"}},[s._v("#")]),s._v(" 2.é—®é¢˜åˆ†æ")]),s._v(" "),t("h6",{attrs:{id:"_1-å¿«é€Ÿé‡ä¼ -fast-retransmit"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-å¿«é€Ÿé‡ä¼ -fast-retransmit"}},[s._v("#")]),s._v(" (1)å¿«é€Ÿé‡ä¼ (fast retransmit)")]),s._v(" "),t("p",[s._v("åœ¨åˆšæ‰çš„é—®é¢˜é‡ç°é‡Œ, è¿è¡Œ netstat å‘½ä»¤å, ç»Ÿè®¡äº†å¿«é€Ÿé‡ä¼ çš„æ¬¡æ•°. é‚£ä»€ä¹ˆæ˜¯å¿«é€Ÿé‡ä¼ (fast retransmit)å‘¢? è¿™é‡Œè§£é‡Šä¸€ä¸‹.")]),s._v(" "),t("p",[s._v("TCP åè®®é‡Œ, å‘é€ç«¯(sender)å‘æ¥å—ç«¯(receiver)å‘é€ä¸€ä¸ªæ•°æ®åŒ…, "),t("strong",[s._v("æ¥å—ç«¯(receiver)éƒ½å›åº” ACK")]),s._v(". å¦‚æœè¶…è¿‡ä¸€ä¸ªåè®®æ ˆè§„å®šçš„æ—¶é—´(RTO), å‘é€ç«¯æ²¡æœ‰æ”¶åˆ° ACK åŒ…, é‚£ä¹ˆå‘é€ç«¯å°±ä¼š"),t("strong",[s._v("é‡ä¼ ")]),s._v("(Retransmit)æ•°æ®åŒ…, å°±åƒä¸‹é¢çš„ç¤ºæ„å›¾ä¸€æ ·.")]),s._v(" "),t("p",[t("img",{attrs:{src:"/img/1dbceb4bec3dc19c7560772cf3a0e328-20230731161430-hilj6su.png",alt:""}})]),s._v(" "),t("p",[s._v("ä¸è¿‡è¿™æ ·ç­‰å¾…ä¸€ä¸ªè¶…æ—¶ä¹‹åå†é‡ä¼ æ•°æ®, å¯¹äºå®é™…åº”ç”¨æ¥è¯´å¤ªæ…¢äº†, æ‰€ä»¥ TCP åè®®åˆå®šä¹‰äº†"),t("strong",[s._v("å¿«é€Ÿé‡ä¼ ")]),s._v(" (fast retransmit)çš„æ¦‚å¿µ. å®ƒçš„åŸºæœ¬å®šä¹‰æ˜¯è¿™æ ·çš„: **å¦‚æœå‘é€ç«¯æ”¶åˆ° 3 ä¸ªé‡å¤çš„ ACK, é‚£ä¹ˆå‘é€ç«¯å°±å¯ä»¥ç«‹åˆ»é‡æ–°å‘é€ ACK å¯¹åº”çš„ä¸‹ä¸€ä¸ªæ•°æ®åŒ…. **")]),s._v(" "),t("p",[s._v("å°±åƒä¸‹é¢ç¤ºæ„å›¾é‡Œæè¿°çš„é‚£æ ·, æ¥å—ç«¯æ²¡æœ‰æ”¶åˆ° Seq 2 è¿™ä¸ªåŒ…, ä½†æ˜¯æ”¶åˆ°äº† Seq 3â€“5 çš„æ•°æ®åŒ…, é‚£ä¹ˆæ¥æ”¶ç«¯åœ¨å›åº” Ack çš„æ—¶å€™, Ack çš„æ•°å€¼åªèƒ½æ˜¯ 2. è¿™æ˜¯å› ä¸ºæŒ‰é¡ºåºæ¥è¯´æ”¶åˆ° Seq 1 çš„åŒ…ä¹‹å, åé¢ Seq 2 ä¸€ç›´æ²¡æœ‰åˆ°, æ‰€ä»¥æ¥æ”¶ç«¯å°±åªèƒ½ä¸€ç›´å‘é€ Ack 2.")]),s._v(" "),t("p",[s._v("é‚£ä¹ˆå½“å‘é€ç«¯æ”¶åˆ° 3 ä¸ªé‡å¤çš„ Ack 2 å, å°±å¯ä»¥"),t("strong",[s._v("é©¬ä¸Šé‡æ–°å‘é€ Seq 2 è¿™ä¸ªæ•°æ®åŒ…")]),s._v("äº†, è€Œä¸ç”¨å†ç­‰åˆ°é‡ä¼ è¶…æ—¶ä¹‹åäº†.")]),s._v(" "),t("p",[t("img",{attrs:{src:"/img/4d7982fc8432c2315113332c21701f5e-20230731161430-p9l9nsr.png",alt:""}})]),s._v(" "),t("p",[s._v("è™½ç„¶ TCP å¿«é€Ÿé‡ä¼ çš„æ ‡å‡†å®šä¹‰æ˜¯éœ€è¦æ”¶åˆ° 3 ä¸ªé‡å¤çš„ Ack, ä¸è¿‡ä½ ä¼šå‘ç°åœ¨ Linux ä¸­å¸¸å¸¸æ”¶åˆ°ä¸€ä¸ª Dup Ack(é‡å¤çš„ Ack)å, å°±é©¬ä¸Šé‡ä¼ æ•°æ®äº†. è¿™æ˜¯ä»€ä¹ˆåŸå› å‘¢? è¿™é‡Œå…ˆéœ€è¦æåˆ° "),t("strong",[s._v("SACK")]),s._v(" è¿™ä¸ªæ¦‚å¿µ, SACK ä¹Ÿå°±æ˜¯"),t("strong",[s._v("é€‰æ‹©æ€§ç¡®è®¤")]),s._v("(Selective Acknowledgement). å…¶å®è·Ÿæ™®é€šçš„ ACK ç›¸æ¯”å‘¢, SACK ä¼šæŠŠæ¥æ”¶ç«¯æ”¶åˆ°çš„æ‰€æœ‰åŒ…çš„åºåˆ—ä¿¡æ¯, éƒ½åé¦ˆç»™å‘é€ç«¯.")]),s._v(" "),t("p",[s._v("çœ‹çœ‹ä¸‹é¢è¿™å¼ å›¾, å°±èƒ½æ˜ç™½è¿™æ˜¯ä»€ä¹ˆæ„æ€äº†.")]),s._v(" "),t("p",[t("img",{attrs:{src:"/img/2d520e708051cb4b99049e172495986e-20230731161430-ghk52zs.png",alt:""}})]),s._v(" "),t("p",[s._v("é‚£æœ‰äº† SACK, å¯¹äºå‘é€ç«¯æ¥è¯´, åœ¨æ”¶åˆ° SACK ä¹‹åå°±å·²ç»çŸ¥é“æ¥æ”¶ç«¯æ”¶åˆ°äº†å“ªäº›æ•°æ®, æ²¡æœ‰æ”¶åˆ°å“ªäº›æ•°æ®.")]),s._v(" "),t("p",[s._v("åœ¨ Linux å†…æ ¸ä¸­ä¼šæœ‰ä¸ªåˆ¤æ–­(å¯ä»¥çœ‹çœ‹ä¸‹é¢çš„è¿™ä¸ªå‡½æ•°), å¤§æ¦‚æ„æ€æ˜¯è¿™æ ·çš„: "),t("strong",[s._v("å¦‚æœåœ¨æ¥æ”¶ç«¯æ”¶åˆ°çš„æ•°æ®å’Œè¿˜æ²¡æœ‰æ”¶åˆ°çš„æ•°æ®ä¹‹é—´, ä¸¤è€…æ•°æ®é‡å·®å¾—å¤ªå¤§çš„è¯(è¶…è¿‡äº† reordering*mss_cache), ä¹Ÿå¯ä»¥é©¬ä¸Šé‡ä¼ æ•°æ®")]),s._v(".")]),s._v(" "),t("p",[s._v("è¿™é‡Œéœ€è¦æ³¨æ„ä¸€ä¸‹, **è¿™é‡Œçš„æ•°æ®é‡å·®æ˜¯æ ¹æ® bytes æ¥è®¡ç®—çš„, è€Œä¸æ˜¯æŒ‰ç…§åŒ…çš„æ•°ç›®æ¥è®¡ç®—çš„, æ‰€ä»¥ä¼šçœ‹åˆ°å³ä½¿åªæ”¶åˆ°ä¸€ä¸ª SACK, Linux ä¹Ÿå¯ä»¥é‡å‘æ•°æ®åŒ…. **")]),s._v(" "),t("div",{staticClass:"language-c line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-c"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("static")]),s._v(" bool "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("tcp_force_fast_retransmit")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("struct")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("sock")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("sk"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("struct")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("tcp_sock")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("tp "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("tcp_sk")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("sk"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n \n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("after")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("tcp_highest_sack_seq")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("tp"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n                 tp"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("snd_una "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),s._v(" tp"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("reordering "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v(" tp"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("mss_cache"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br")])]),t("p",[s._v("äº†è§£äº†å¿«é€Ÿé‡ä¼ çš„æ¦‚å¿µä¹‹å, å†æ¥çœ‹çœ‹å¦‚æœ netstat ä¸­æœ‰"),t("strong",[s._v('å¤§é‡çš„ "fast retransmits"')]),s._v('  æ„å‘³ç€ä»€ä¹ˆ? å¦‚æœå†ç”¨ netstat æŸ¥çœ‹ "reordering", å°±å¯ä»¥çœ‹åˆ°å¤§é‡çš„ SACK å‘ç°çš„ä¹±åºåŒ….')]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("-bash-4.2"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# nsenter -t 51598 -n netstat -s  | grep reordering")]),s._v("\n    Detected reordering "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("501067")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("times")]),s._v(" using SACK\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])]),t("p",[t("strong",[s._v("å…¶å®åœ¨äº‘å¹³å°çš„è¿™ç§ç½‘ç»œç¯å¢ƒé‡Œ, ç½‘ç»œåŒ…ä¹±åº + SACK ä¹‹å, äº§ç”Ÿçš„æ•°æ®åŒ…é‡ä¼ çš„é‡è¦è¿œè¿œé«˜äºç½‘ç»œä¸¢åŒ…å¼•èµ·çš„é‡ä¼ . ** æ¯”å¦‚åƒä¸‹é¢è¿™å¼ å›¾é‡Œå±•ç¤ºçš„è¿™æ ·, Seq 2 ä¸ Seq 3 è¿™ä¸¤ä¸ªåŒ…å¦‚æœ")]),s._v("ä¹±åº**çš„è¯, é‚£ä¹ˆå°±ä¼šå¼•èµ· Seq 2 çš„ç«‹åˆ»é‡ä¼ .")]),s._v(" "),t("p",[t("img",{attrs:{src:"/img/f3511e4f11f5d7bcae932b347d4e2726-20230731161430-08iry81.png",alt:""}})]),s._v(" "),t("h6",{attrs:{id:"_2-vethæ¥å£çš„æ•°æ®åŒ…çš„å‘é€"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-vethæ¥å£çš„æ•°æ®åŒ…çš„å‘é€"}},[s._v("#")]),s._v(" (2)Vethæ¥å£çš„æ•°æ®åŒ…çš„å‘é€")]),s._v(" "),t("p",[s._v("ç°åœ¨çŸ¥é“äº†"),t("strong",[s._v("ç½‘ç»œåŒ…ä¹±åºä¼šé€ æˆæ•°æ®åŒ…çš„é‡ä¼ ")]),s._v(", æ¥ç€å†æ¥çœ‹çœ‹å®¹å™¨çš„ veth æ¥å£é…ç½®æœ‰æ²¡æœ‰å¯èƒ½ä¼šå¼•èµ·æ•°æ®åŒ…çš„ä¹±åº.")]),s._v(" "),t("p",[s._v("åœ¨ä¸Šä¸€è®²é‡Œ, è®²è¿‡é€šè¿‡ veth æ¥å£ä»å®¹å™¨å‘å¤–å‘é€æ•°æ®åŒ…, ä¼š"),t("strong",[s._v("è§¦å‘ peer veth è®¾å¤‡å»æ¥æ”¶æ•°æ®åŒ…, è¿™ä¸ªæ¥æ”¶çš„è¿‡ç¨‹å°±æ˜¯ä¸€ä¸ªç½‘ç»œçš„ softirq çš„å¤„ç†è¿‡ç¨‹")]),s._v(". åœ¨è§¦å‘ softirq ä¹‹å‰, veth æ¥å£ä¼š"),t("strong",[s._v("æ¨¡æ‹Ÿç¡¬ä»¶æ¥æ”¶æ•°æ®")]),s._v("çš„è¿‡ç¨‹, é€šè¿‡ enqueue_to_backlog() å‡½æ•°æŠŠæ•°æ®åŒ…æ”¾åˆ°æŸä¸ª CPU å¯¹åº”çš„æ•°æ®åŒ…é˜Ÿåˆ—é‡Œ(softnet_data).")]),s._v(" "),t("div",{staticClass:"language-c line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-c"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("static")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("netif_rx_internal")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("struct")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("sk_buff")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("skb"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" ret"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n \n    "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("net_timestamp_check")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("netdev_tstamp_prequeue"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" skb"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n \n    "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("trace_netif_rx")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("skb"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n \n"),t("span",{pre:!0,attrs:{class:"token macro property"}},[t("span",{pre:!0,attrs:{class:"token directive-hash"}},[s._v("#")]),t("span",{pre:!0,attrs:{class:"token directive keyword"}},[s._v("ifdef")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token expression"}},[s._v("CONFIG_RPS")])]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("static_branch_unlikely")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&")]),s._v("rps_needed"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("struct")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("rps_dev_flow")]),s._v(" voidflow"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("rflow "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&")]),s._v("voidflow"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" cpu"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n \n            "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("preempt_disable")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("rcu_read_lock")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n \n            cpu "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("get_rps_cpu")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("skb"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("dev"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" skb"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&")]),s._v("rflow"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("cpu "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n                    cpu "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("smp_processor_id")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n \n            ret "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("enqueue_to_backlog")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("skb"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" cpu"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&")]),s._v("rflow"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("last_qtail"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n \n            "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("rcu_read_unlock")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("preempt_enable")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("else")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token macro property"}},[t("span",{pre:!0,attrs:{class:"token directive-hash"}},[s._v("#")]),t("span",{pre:!0,attrs:{class:"token directive keyword"}},[s._v("endif")])]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("unsigned")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" qtail"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n \n            ret "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("enqueue_to_backlog")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("skb"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("get_cpu")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&")]),s._v("qtail"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("put_cpu")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" ret"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br"),t("span",{staticClass:"line-number"},[s._v("25")]),t("br"),t("span",{staticClass:"line-number"},[s._v("26")]),t("br"),t("span",{staticClass:"line-number"},[s._v("27")]),t("br"),t("span",{staticClass:"line-number"},[s._v("28")]),t("br"),t("span",{staticClass:"line-number"},[s._v("29")]),t("br"),t("span",{staticClass:"line-number"},[s._v("30")]),t("br"),t("span",{staticClass:"line-number"},[s._v("31")]),t("br"),t("span",{staticClass:"line-number"},[s._v("32")]),t("br"),t("span",{staticClass:"line-number"},[s._v("33")]),t("br"),t("span",{staticClass:"line-number"},[s._v("34")]),t("br")])]),t("p",[s._v('ä»ä¸Šé¢çš„ä»£ç , å¯ä»¥çœ‹åˆ°, åœ¨ç¼ºçœçš„çŠ¶å†µä¸‹(ä¹Ÿå°±æ˜¯æ²¡æœ‰ RPS çš„æƒ…å†µä¸‹), enqueue_to_backlog() æŠŠæ•°æ®åŒ…æ”¾åˆ°äº† "å½“å‰è¿è¡Œçš„ CPU"(get_cpu())å¯¹åº”çš„æ•°æ®é˜Ÿåˆ—ä¸­. å¦‚æœæ˜¯ä»å®¹å™¨é‡Œé€šè¿‡ veth å¯¹å¤–å‘é€æ•°æ®åŒ…, é‚£ä¹ˆè¿™ä¸ª "å½“å‰è¿è¡Œçš„ CPU" å°±æ˜¯å®¹å™¨ä¸­å‘é€æ•°æ®çš„è¿›ç¨‹æ‰€åœ¨çš„ CPU.')]),s._v(" "),t("p",[s._v("å¯¹äºå¤šæ ¸çš„ç³»ç»Ÿ, è¿™ä¸ª"),t("strong",[s._v("å‘é€æ•°æ®çš„è¿›ç¨‹å¯ä»¥åœ¨å¤šä¸ª CPU ä¸Šåˆ‡æ¢è¿è¡Œ")]),s._v(". è¿›ç¨‹åœ¨ä¸åŒçš„ CPU ä¸ŠæŠŠæ•°æ®æ”¾å…¥é˜Ÿåˆ—å¹¶ä¸” raise softirq ä¹‹å, "),t("strong",[s._v("å› ä¸ºæ¯ä¸ª CPU ä¸Šå¤„ç† softirq æ˜¯ä¸ªå¼‚æ­¥æ“ä½œ, æ‰€ä»¥ä¸¤ä¸ª CPU network softirq handler å¤„ç†è¿™ä¸ªè¿›ç¨‹çš„æ•°æ®åŒ…æ—¶, å¤„ç†çš„å…ˆåé¡ºåºå¹¶ä¸èƒ½ä¿è¯")]),s._v(". æ‰€ä»¥, veth å¯¹çš„è¿™ç§å‘é€æ•°æ®æ–¹å¼"),t("strong",[s._v("å¢åŠ äº†å®¹å™¨å‘å¤–å‘é€æ•°æ®å‡ºç°ä¹±åºçš„å‡ ç‡")]),s._v(".")]),s._v(" "),t("p",[t("img",{attrs:{src:"/img/b43534c08738c178324f7954e6f3675f-20230731161430-g3cemt4.png",alt:""}})]),s._v(" "),t("h6",{attrs:{id:"_3-rsså’Œrps"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-rsså’Œrps"}},[s._v("#")]),s._v(" (3)RSSå’ŒRPS")]),s._v(" "),t("p",[s._v('é‚£ä¹ˆå¯¹äº veth æ¥å£çš„è¿™ç§å‘åŒ…æ–¹å¼, æœ‰åŠæ³•å‡å°‘ä¸€ä¸‹ä¹±åºçš„å‡ ç‡å—? å…¶å®åœ¨ä¸Šé¢ netif_rx_internal() é‚£æ®µä»£ç ä¸­, æœ‰ä¸€æ®µåœ¨ "'),t("code",[s._v("#ifdef CONFIG_RPS")]),s._v('â€‹" ä¸­çš„ä»£ç .')]),s._v(" "),t("p",[s._v("è¿™æ®µä»£ç ä¸­åœ¨è°ƒç”¨ enqueue_to_backlog() çš„æ—¶å€™, ä¼ å…¥çš„ CPU å¹¶ä¸æ˜¯å½“å‰è¿è¡Œçš„ CPU, è€Œæ˜¯é€šè¿‡ "),t("strong",[s._v("get_rps_cpu()")]),s._v("  å¾—åˆ°çš„ CPU, é‚£ä¹ˆè¿™ä¼šæœ‰ä»€ä¹ˆä¸åŒå‘¢? è¿™é‡Œçš„ RPS åˆæ˜¯ä»€ä¹ˆæ„æ€å‘¢?")]),s._v(" "),t("p",[s._v("è¦è§£é‡Š RPS éœ€è¦å…ˆçœ‹ä¸€ä¸‹ RSS, è¿™ä¸ª RSS ä¹‹å‰è¯´çš„å†…å­˜ RSS, è€Œæ˜¯å’Œç½‘å¡ç¡¬ä»¶ç›¸å…³çš„ä¸€ä¸ªæ¦‚å¿µ, å®ƒæ˜¯ Receive Side Scaling çš„ç¼©å†™. ç°åœ¨çš„ç½‘å¡æ€§èƒ½è¶Šæ¥è¶Šå¼ºåŠ²äº†, ä»åŸæ¥ä¸€æ¡ RX é˜Ÿåˆ—æ‰©å±•åˆ°äº† N æ¡ RX é˜Ÿåˆ—, è€Œç½‘å¡çš„ç¡¬ä»¶ä¸­æ–­ä¹Ÿä»ä¸€ä¸ªç¡¬ä»¶ä¸­æ–­, å˜æˆäº†æ¯æ¡ RX é˜Ÿåˆ—éƒ½ä¼šæœ‰ä¸€ä¸ªç¡¬ä»¶ä¸­æ–­. æ¯ä¸ªç¡¬ä»¶ä¸­æ–­å¯ä»¥ç”±ä¸€ä¸ª CPU æ¥å¤„ç†, é‚£ä¹ˆå¯¹äºå¤šæ ¸çš„ç³»ç»Ÿ, å¤šä¸ª CPU å¯ä»¥å¹¶è¡Œçš„æ¥æ”¶ç½‘ç»œåŒ…, è¿™æ ·å°±å¤§å¤§åœ°æé«˜äº†ç³»ç»Ÿçš„ç½‘ç»œæ•°æ®çš„å¤„ç†èƒ½åŠ›. åŒæ—¶, åœ¨ç½‘å¡ç¡¬ä»¶ä¸­, å¯ä»¥æ ¹æ®æ•°æ®åŒ…çš„ 4 å…ƒç»„æˆ–è€… 5 å…ƒç»„ä¿¡æ¯æ¥ä¿è¯åŒä¸€ä¸ªæ•°æ®æµ, æ¯”å¦‚ä¸€ä¸ª TCP æµçš„æ•°æ®å§‹ç»ˆåœ¨ä¸€ä¸ª RX é˜Ÿåˆ—ä¸­, è¿™æ ·ä¹Ÿèƒ½ä¿è¯åŒä¸€æµä¸ä¼šå‡ºç°ä¹±åºçš„æƒ…å†µ.")]),s._v(" "),t("p",[s._v("ä¸‹é¢è¿™å¼ å›¾, å¤§è‡´æè¿°äº†ä¸€ä¸‹ RSS æ˜¯æ€ä¹ˆå·¥ä½œçš„.")]),s._v(" "),t("p",[t("img",{attrs:{src:"/img/cb625048ce5d257d49ea4492d811ed5f-20230731161430-v12zdff.png",alt:""}})]),s._v(" "),t("p",[t("strong",[s._v("RSS çš„å®ç°åœ¨ç½‘å¡ç¡¬ä»¶å’Œé©±åŠ¨é‡Œé¢, è€Œ RPS(Receive Packet Steering)å…¶å®å°±æ˜¯åœ¨è½¯ä»¶å±‚é¢å®ç°ç±»ä¼¼çš„åŠŸèƒ½")]),s._v(". å®ƒä¸»è¦å®ç°çš„ä»£ç æ¡†æ¶å°±åœ¨ä¸Šé¢çš„ netif_rx_internal() ä»£ç é‡Œ, åŸç†ä¹Ÿä¸éš¾.")]),s._v(" "),t("p",[s._v("å°±åƒä¸‹é¢çš„è¿™å¼ ç¤ºæ„å›¾é‡Œæè¿°çš„è¿™æ ·: åœ¨ç¡¬ä»¶ä¸­æ–­å, CPU2 æ”¶åˆ°äº†æ•°æ®åŒ…, å†ä¸€æ¬¡å¯¹æ•°æ®åŒ…è®¡ç®—ä¸€æ¬¡å››å…ƒç»„çš„ hash å€¼, å¾—åˆ°è¿™ä¸ªæ•°æ®åŒ…ä¸ CPU1 çš„æ˜ å°„å…³ç³». æ¥ç€ä¼šæŠŠè¿™ä¸ªæ•°æ®åŒ…æ”¾åˆ° CPU1 å¯¹åº”çš„ softnet_data æ•°æ®é˜Ÿåˆ—ä¸­, åŒæ—¶å‘ CPU1 å‘é€ä¸€ä¸ª IPI çš„ä¸­æ–­ä¿¡å·.")]),s._v(" "),t("p",[s._v("è¿™æ ·ä¸€æ¥, åé¢ CPU1 å°±ä¼šç»§ç»­æŒ‰ç…§ Netowrk softirq çš„æ–¹å¼æ¥å¤„ç†è¿™ä¸ªæ•°æ®åŒ…äº†.")]),s._v(" "),t("p",[t("img",{attrs:{src:"/img/ac14fc0f8fbea977fb33a1081163b278-20230731161430-i6uc53w.png",alt:""}})]),s._v(" "),t("p",[s._v("**RSS å’Œ RPS çš„ç›®çš„éƒ½æ˜¯æŠŠæ•°æ®åŒ…åˆ†æ•£åˆ°æ›´å¤šçš„ CPU ä¸Šè¿›è¡Œå¤„ç†, ä½¿å¾—ç³»ç»Ÿæœ‰æ›´å¼ºçš„ç½‘ç»œåŒ…å¤„ç†èƒ½åŠ›. åœ¨æŠŠæ•°æ®åŒ…åˆ†æ•£åˆ°å„ä¸ª CPU æ—¶, ä¿è¯äº†åŒä¸€ä¸ªæ•°æ®æµåœ¨ä¸€ä¸ª CPU ä¸Š, è¿™æ ·å°±å¯ä»¥å‡å°‘åŒ…çš„ä¹±åº. **")]),s._v(" "),t("p",[s._v("æ˜ç™½äº† RPS çš„æ¦‚å¿µä¹‹å, å†å›å¤´æ¥çœ‹ veth å¯¹å¤–å‘é€æ•°æ®æ—¶å€™, åœ¨ enqueue_to_backlog() çš„æ—¶å€™é€‰æ‹© CPU çš„é—®é¢˜. æ˜¾ç„¶, å¦‚æœå¯¹åº”çš„ veth æ¥å£ä¸Šæ‰“å¼€äº† RPS çš„é…ç½®ä»¥å, é‚£ä¹ˆå¯¹äºåŒä¸€ä¸ªæ•°æ®æµ, å°±å¯ä»¥å§‹ç»ˆé€‰æ‹©åŒä¸€ä¸ª CPU äº†.")]),s._v(" "),t("p",[s._v("æ‰“å¼€ RPS çš„æ–¹æ³•æŒºç®€å•çš„, åªè¦å» /sys ç›®å½•ä¸‹, åœ¨ç½‘ç»œæ¥å£è®¾å¤‡æ¥æ”¶é˜Ÿåˆ—ä¸­"),t("strong",[s._v("ä¿®æ”¹é˜Ÿåˆ—é‡Œçš„ rps_cpus çš„å€¼")]),s._v(", è¿™æ ·å°±å¯ä»¥äº†. rps_cpus æ˜¯ä¸€ä¸ª 16 è¿›åˆ¶çš„æ•°, æ¯ä¸ª bit ä»£è¡¨ä¸€ä¸ª CPU. æ¯”å¦‚åœ¨ä¸€ä¸ª 12CPU çš„èŠ‚ç‚¹ä¸Š, æƒ³è®© host ä¸Šçš„ veth æ¥å£åœ¨æ‰€æœ‰çš„ 12 ä¸ª CPU ä¸Š, éƒ½å¯ä»¥é€šè¿‡ RPS é‡æ–°åˆ†é…æ•°æ®åŒ…. é‚£ä¹ˆå°±å¯ä»¥æ‰§è¡Œä¸‹é¢è¿™æ®µå‘½ä»¤:")]),s._v(" "),t("div",{staticClass:"language-c line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-c"}},[t("code",[t("span",{pre:!0,attrs:{class:"token macro property"}},[t("span",{pre:!0,attrs:{class:"token directive-hash"}},[s._v("#")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token directive keyword"}},[s._v("cat")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token expression"}},[t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("sys"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("devices"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("virtual"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("net"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("veth57703b6"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("queues"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("rx"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("rps_cpus")])]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("000")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token macro property"}},[t("span",{pre:!0,attrs:{class:"token directive-hash"}},[s._v("#")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token directive keyword"}},[s._v("echo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token expression"}},[s._v("fff "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("sys"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("devices"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("virtual"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("net"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("veth57703b6"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("queues"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("rx"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("rps_cpus")])]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token macro property"}},[t("span",{pre:!0,attrs:{class:"token directive-hash"}},[s._v("#")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token directive keyword"}},[s._v("cat")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token expression"}},[t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("sys"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("devices"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("virtual"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("net"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("veth57703b6"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("queues"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("rx"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("rps_cpus")])]),s._v("\nfff\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br")])]),t("h5",{attrs:{id:"_3-é‡ç‚¹å°ç»“"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-é‡ç‚¹å°ç»“"}},[s._v("#")]),s._v(" 3.é‡ç‚¹å°ç»“")]),s._v(" "),t("p",[s._v("æœ¬èŠ‚è®¨è®ºçš„æ˜¯å®¹å™¨ä¸­ç½‘ç»œåŒ…ä¹±åºå¼•èµ·é‡ä¼ çš„é—®é¢˜.")]),s._v(" "),t("p",[s._v("ç”±äºåœ¨å®¹å™¨å¹³å°ä¸­çœ‹åˆ°å¤§éƒ¨åˆ†çš„é‡ä¼ æ˜¯å¿«é€Ÿé‡ä¼ (fast retransmits). å¿«é€Ÿé‡ä¼ çš„åŸºæœ¬å®šä¹‰æ˜¯: **å¦‚æœå‘é€ç«¯æ”¶åˆ° 3 ä¸ªé‡å¤çš„ ACK, é‚£ä¹ˆå‘é€ç«¯å°±å¯ä»¥ç«‹åˆ»é‡æ–°å‘é€ ACK å¯¹åº”çš„ä¸‹ä¸€ä¸ªæ•°æ®åŒ…, è€Œä¸ç”¨ç­‰å¾…å‘é€è¶…æ—¶. ** ä¸è¿‡åœ¨ Linux ç³»ç»Ÿä¸Šè¿˜ä¼šçœ‹åˆ°å‘é€ç«¯æ”¶åˆ°ä¸€ä¸ªé‡å¤çš„ ACK å°±å¿«é€Ÿé‡ä¼ çš„, è¿™æ˜¯å› ä¸º Linux ä¸‹å¯¹ SACK åšäº†ä¸€ä¸ªç‰¹åˆ«çš„åˆ¤æ–­ä¹‹å, å°±å¯ä»¥ç«‹åˆ»é‡ä¼ æ•°æ®åŒ….")]),s._v(" "),t("p",[s._v("å†å¯¹å®¹å™¨äº‘å¹³å°ä¸­çš„å¿«é€Ÿé‡ä¼ åšåˆ†æ, å°±ä¼šå‘ç°"),t("strong",[s._v("è¿™äº›é‡ä¼ å¤§éƒ¨åˆ†æ˜¯ç”±åŒ…çš„ä¹±åºè§¦å‘")]),s._v("çš„. é€šè¿‡å¯¹å®¹å™¨ veth ç½‘ç»œæ¥å£è¿›ä¸€æ­¥ç ”ç©¶, æˆ‘ä»¬çŸ¥é“å®ƒå¯èƒ½ä¼šå¢åŠ æ•°æ®åŒ…ä¹±åºçš„å‡ ç‡. åŒæ—¶åœ¨è¿™ä¸ªåˆ†æè¿‡ç¨‹ä¸­, ä¹Ÿçœ‹åˆ°äº† Linux ç½‘ç»œ RPS çš„ç‰¹æ€§.")]),s._v(" "),t("p",[t("strong",[s._v("RPS å’Œ RSS çš„ä½œç”¨ç±»ä¼¼, éƒ½æ˜¯æŠŠæ•°æ®åŒ…åˆ†æ•£åˆ°æ›´å¤šçš„ CPU ä¸Šè¿›è¡Œå¤„ç†, ä½¿å¾—ç³»ç»Ÿæœ‰æ›´å¼ºçš„ç½‘ç»œåŒ…å¤„ç†èƒ½åŠ›. å®ƒä»¬çš„åŒºåˆ«æ˜¯ RSS å·¥ä½œåœ¨ç½‘å¡çš„ç¡¬ä»¶å±‚, è€Œ RPS å·¥ä½œåœ¨ Linux å†…æ ¸çš„è½¯ä»¶å±‚. ** åœ¨æŠŠæ•°æ®åŒ…åˆ†æ•£åˆ°å„ä¸ª CPU æ—¶, RPS ä¿è¯äº†åŒä¸€ä¸ªæ•°æ®æµæ˜¯åœ¨ä¸€ä¸ª CPU ä¸Šçš„, è¿™æ ·å°±å¯ä»¥æœ‰æ•ˆå‡å°‘åŒ…çš„ä¹±åº. é‚£ä¹ˆå¯ä»¥")]),s._v("æŠŠ RPS çš„è¿™ä¸ªç‰¹æ€§é…ç½®åˆ° veth ç½‘ç»œæ¥å£ä¸Š, æ¥å‡å°‘æ•°æ®åŒ…ä¹±åºçš„å‡ ç‡**.")]),s._v(" "),t("p",[s._v("ä¸è¿‡è¿™é‡Œè¿˜è¦è¯´æ˜çš„æ˜¯, RPS çš„é…ç½®è¿˜æ˜¯ä¼šå¸¦æ¥"),t("strong",[s._v("é¢å¤–çš„ç³»ç»Ÿå¼€é”€")]),s._v(", åœ¨æŸäº›ç½‘ç»œç¯å¢ƒä¸­ä¼šå¼•èµ· softirq CPU ä½¿ç”¨ç‡çš„å¢å¤§. é‚£æ¥å£è¦ä¸è¦æ‰“å¼€ RPS å‘¢? è¿™ä¸ªé—®é¢˜éœ€è¦æ ¹æ®å®é™…æƒ…å†µæ¥åšä¸ªæƒè¡¡.")]),s._v(" "),t("p",[s._v("åŒæ—¶è¿˜è¦æ³¨æ„, TCP çš„ä¹±åºåŒ…, å¹¶ä¸ä¸€å®šéƒ½ä¼šäº§ç”Ÿæ•°æ®åŒ…çš„é‡ä¼ . æƒ³è¦å‡å°‘ç½‘ç»œæ•°æ®åŒ…çš„é‡ä¼ , è¿˜å¯ä»¥è€ƒè™‘åè®®æ ˆä¸­å…¶ä»–å‚æ•°çš„è®¾ç½®, æ¯”å¦‚ /proc/sys/net/ipv4/tcp_reordering.")]),s._v(" "),t("h3",{attrs:{id:"å®¹å™¨å®‰å…¨"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#å®¹å™¨å®‰å…¨"}},[s._v("#")]),s._v(" å®¹å™¨å®‰å…¨")]),s._v(" "),t("h4",{attrs:{id:"_19-å®¹å™¨å®‰å…¨-1-æˆ‘çš„å®¹å™¨çœŸçš„éœ€è¦privilegedæƒé™å—"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_19-å®¹å™¨å®‰å…¨-1-æˆ‘çš„å®¹å™¨çœŸçš„éœ€è¦privilegedæƒé™å—"}},[s._v("#")]),s._v(" 19 | å®¹å™¨å®‰å…¨(1):æˆ‘çš„å®¹å™¨çœŸçš„éœ€è¦privilegedæƒé™å—?")]),s._v(" "),t("p",[s._v("æœ¬èŠ‚è¿›å…¥åˆ°äº†å®¹å™¨å®‰å…¨çš„æ¨¡å—. å®¹å™¨å®‰å…¨æ˜¯ä¸€ä¸ªå¾ˆå¤§çš„è¯é¢˜, å®¹å™¨çš„å®‰å…¨æ€§å¾ˆå¤§ç¨‹åº¦æ˜¯ç”±å®¹å™¨çš„æ¶æ„ç‰¹æ€§æ‰€å†³å®šçš„. æ¯”å¦‚å®¹å™¨ä¸å®¿ä¸»æœºå…±äº« Linux å†…æ ¸, é€šè¿‡ Namespace æ¥åšèµ„æºçš„éš”ç¦», é€šè¿‡ shim/runC çš„æ–¹å¼æ¥å¯åŠ¨ç­‰ç­‰.")]),s._v(" "),t("p",[s._v('è¿™äº›å®¹å™¨æ¶æ„ç‰¹æ€§, åœ¨é€‰æ‹©ä½¿ç”¨å®¹å™¨ä¹‹å, ä½œä¸ºä½¿ç”¨å®¹å™¨çš„ç”¨æˆ·, å…¶å®ä½ å·²ç»æ²¡æœ‰å¤šå°‘èƒ½åŠ›å»å¯¹æ¶æ„è¿™ä¸ªå±‚é¢åšå®‰å…¨ä¸Šçš„æ”¹åŠ¨äº†. ä½ å¯èƒ½ä¼šè¯´ç”¨ Kata Container, gVisor å°±æ˜¯å®‰å…¨ "å®¹å™¨" äº†. ä¸è¿‡ Kata æˆ–è€… gVisor åªæ˜¯å…¼å®¹äº†å®¹å™¨æ¥å£æ ‡å‡†, è€Œå†…éƒ¨çš„å®ç°å®Œå…¨æ˜¯å¦å¤–çš„æŠ€æœ¯äº†.')]),s._v(" "),t("p",[s._v("é‚£ä¹ˆå¯¹äºä½¿ç”¨å®¹å™¨çš„ç”¨æˆ·, åœ¨è¿è¡Œå®¹å™¨çš„æ—¶å€™, åœ¨å®‰å…¨æ–¹é¢å¯ä»¥åšäº›ä»€ä¹ˆå‘¢? ä¸»è¦å¯ä»¥ä»è¿™ä¸¤ä¸ªæ–¹é¢æ¥è€ƒè™‘: "),t("strong",[s._v("ç¬¬ä¸€æ˜¯èµ‹äºˆå®¹å™¨åˆç†çš„ capabilities, ç¬¬äºŒæ˜¯åœ¨å®¹å™¨ä¸­ä»¥é root ç”¨æˆ·æ¥è¿è¡Œç¨‹åº")]),s._v(".")]),s._v(" "),t("p",[s._v("ä¸ºæœ¬èŠ‚å…ˆæ¥çœ‹å®¹å™¨çš„ capabilities çš„é—®é¢˜.")]),s._v(" "),t("h5",{attrs:{id:"_1-é—®é¢˜å†ç°-12"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-é—®é¢˜å†ç°-12"}},[s._v("#")]),s._v(" 1.é—®é¢˜å†ç°")]),s._v(" "),t("p",[s._v("åˆšåˆšä½¿ç”¨å®¹å™¨çš„åŒå­¦, å¾€å¾€ä¼šå‘ç°ç”¨ç¼ºçœ "),t("code",[s._v("docker run")]),s._v("â€‹ çš„æ–¹å¼å¯åŠ¨å®¹å™¨å, åœ¨å®¹å™¨é‡Œå¾ˆå¤šæ“ä½œéƒ½æ˜¯"),t("strong",[s._v("ä¸å…è®¸")]),s._v("çš„, å³ä½¿æ˜¯ä»¥ root ç”¨æˆ·æ¥è¿è¡Œç¨‹åºä¹Ÿä¸è¡Œ.")]),s._v(" "),t("p",[s._v("ç”¨ä¸‹é¢çš„ä¾‹å­æ¥é‡ç°ä¸€ä¸‹è¿™ä¸ªé—®é¢˜. å…ˆè¿è¡Œ "),t("code",[s._v("make image")]),s._v("â€‹ åšä¸ªå®¹å™¨é•œåƒ, ç„¶åè¿è¡Œä¸‹é¢çš„è„šæœ¬:")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# docker run --name iptables -it registry/iptables:v1 bash")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@0b88d6486149 /"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# iptables -L")]),s._v("\niptables v1.8.4 "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("nf_tables"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(": Could not fetch rule "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v(" generation id: Permission denied "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("you must be root"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n \n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@0b88d6486149 /"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# id")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("uid")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("root"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("gid")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("root"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("groups")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("root"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br")])]),t("p",[s._v("åœ¨å®¹å™¨ä¸­è¿è¡Œ "),t("code",[s._v("iptables")]),s._v('â€‹ è¿™ä¸ªå‘½ä»¤, æ¥æŸ¥çœ‹ä¸€ä¸‹é˜²ç«å¢™çš„è§„åˆ™, ä½†æ˜¯æ‰§è¡Œå‘½ä»¤ä¹‹å, ä¼šå‘ç°ç»“æœè¾“å‡ºä¸­ç»™å‡ºäº† "Permission denied (you must be root)" çš„é”™è¯¯æç¤º, è¿™ä¸ªæç¤ºè¦æ±‚ç”¨ root ç”¨æˆ·æ¥è¿è¡Œ. ä¸è¿‡åœ¨å®¹å™¨ä¸­, ç°åœ¨'),t("strong",[s._v("å·²ç»æ˜¯ä»¥ root ç”¨æˆ·")]),s._v('æ¥è¿è¡Œäº†, ä¸ºä»€ä¹ˆè¿˜æ˜¯ä¸å¯ä»¥è¿è¡Œ "iptables" è¿™æ¡å‘½ä»¤?')]),s._v(" "),t("p",[s._v('æ˜¯ä¸æ˜¯å®¹å™¨ä¸­åˆåšäº†åˆ«çš„æƒé™é™åˆ¶? å¦‚æœæŸ¥ä¸€ä¸‹èµ„æ–™, å°±ä¼šçœ‹åˆ°å¯åŠ¨å®¹å™¨æœ‰ä¸€ä¸ª "'),t("strong",[s._v("privileged")]),s._v('" çš„å‚æ•°. å¯ä»¥è¯•ä¸€ä¸‹ç”¨ä¸Šè¿™ä¸ªå‚æ•°, æ²¡é”™, ç”¨äº†è¿™ä¸ªå‚æ•°ä¹‹å, iptables è¿™ä¸ªå‘½ä»¤å°±æ‰§è¡ŒæˆåŠŸäº†.')]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# docker stop iptables;docker rm iptables")]),s._v("\niptables\niptables\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# docker run --name iptables --privileged -it registry/iptables:v1 bash")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@44168f4b9b24 /"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# iptables -L")]),s._v("\nChain INPUT "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("policy ACCEPT"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\ntarget     prot opt "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("source")]),s._v("               destination\n \nChain FORWARD "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("policy ACCEPT"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\ntarget     prot opt "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("source")]),s._v("               destination\n \nChain OUTPUT "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("policy ACCEPT"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\ntarget     prot opt "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("source")]),s._v("               destination\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br")])]),t("p",[s._v('çœ‹ä¸Šå», ç”¨äº†ä¸€ä¸ªé…ç½®å‚æ•°å°±å·²ç»è§£å†³äº†é—®é¢˜, ä¼¼ä¹å¾ˆå®¹æ˜“. ä¸è¿‡è¿™é‡Œå¯ä»¥è¿›ä¸€æ­¥æƒ³æƒ³, ç”¨ "privileged" å‚æ•°æ¥è§£å†³é—®é¢˜, æ˜¯ä¸æ˜¯ä¸€ä¸ªåˆç†çš„æ–¹æ³•? ç”¨å®ƒä¼šæœ‰ä»€ä¹ˆé—®é¢˜?')]),s._v(" "),t("p",[s._v('è¦å›ç­”è¿™äº›é—®é¢˜, å…ˆæ¥äº†è§£ä¸€ä¸‹ "privileged" æ˜¯ä»€ä¹ˆæ„æ€. ä» Docker çš„ä»£ç é‡Œå¯ä»¥çœ‹åˆ°, å¦‚æœé…ç½®äº† privileged çš„å‚æ•°çš„è¯, å°±ä¼šè·å–æ‰€æœ‰çš„ '),t("strong",[s._v("capabilities")]),s._v(", é‚£ä»€ä¹ˆæ˜¯ capabilities å‘¢?")]),s._v(" "),t("div",{staticClass:"language-go line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-go"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" ec"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("Privileged "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    p"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("Capabilities "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" caps"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("GetAllCapabilities")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br")])]),t("h5",{attrs:{id:"_2-åŸºæœ¬æ¦‚å¿µ-2"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-åŸºæœ¬æ¦‚å¿µ-2"}},[s._v("#")]),s._v(" 2.åŸºæœ¬æ¦‚å¿µ")]),s._v(" "),t("h6",{attrs:{id:"_1-linux-capabilities"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-linux-capabilities"}},[s._v("#")]),s._v(" (1)Linux capabilities")]),s._v(" "),t("p",[s._v('è¦äº†è§£ Linux capabilities çš„å®šä¹‰, å¯ä»¥å…ˆæŸ¥çœ‹ä¸€ä¸‹ "Linux Programmer\'s Manual" ä¸­å…³äº Linux capabilities çš„æè¿°. åœ¨ Linux capabilities å‡ºç°å‰, '),t("strong",[s._v("è¿›ç¨‹çš„æƒé™å¯ä»¥ç®€å•åˆ†ä¸ºä¸¤ç±», ç¬¬ä¸€ç±»æ˜¯ç‰¹æƒç”¨æˆ·çš„è¿›ç¨‹(è¿›ç¨‹çš„æœ‰æ•ˆç”¨æˆ· ID æ˜¯ 0, ç®€å•æ¥è¯´å¯ä»¥è®¤ä¸ºå®ƒå°±æ˜¯ root ç”¨æˆ·çš„è¿›ç¨‹), ç¬¬äºŒç±»æ˜¯éç‰¹æƒç”¨æˆ·çš„è¿›ç¨‹(è¿›ç¨‹çš„æœ‰æ•ˆç”¨æˆ· ID æ˜¯é 0, å¯ä»¥ç†è§£ä¸ºé root ç”¨æˆ·è¿›ç¨‹)")]),s._v(" .")]),s._v(" "),t("p",[s._v("ç‰¹æƒç”¨æˆ·è¿›ç¨‹å¯ä»¥æ‰§è¡Œ Linux ç³»ç»Ÿä¸Šçš„"),t("strong",[s._v("æ‰€æœ‰æ“ä½œ")]),s._v(", è€Œéç‰¹æƒç”¨æˆ·åœ¨æ‰§è¡ŒæŸäº›æ“ä½œçš„æ—¶å€™å°±ä¼š"),t("strong",[s._v("è¢«å†…æ ¸é™åˆ¶æ‰§è¡Œ")]),s._v(". å…¶å®è¿™ä¸ªæ¦‚å¿µ, ä¹Ÿæ˜¯é€šå¸¸å¯¹ Linux ä¸­ root ç”¨æˆ·ä¸é root ç”¨æˆ·çš„ç†è§£. ä» kernel 2.2 å¼€å§‹, Linux "),t("strong",[s._v('æŠŠç‰¹æƒç”¨æˆ·æ‰€æœ‰çš„è¿™äº› "ç‰¹æƒ" åšäº†æ›´è¯¦ç»†çš„åˆ’åˆ†, è¿™æ ·è¢«åˆ’åˆ†å‡ºæ¥çš„æ¯ä¸ªå•å…ƒå°±è¢«ç§°ä¸º capability')]),s._v(". æ‰€æœ‰çš„ capabilities éƒ½åœ¨ Linux capabilities çš„æ‰‹å†Œåˆ—å‡ºæ¥äº†, ä¹Ÿå¯ä»¥åœ¨å†…æ ¸çš„æ–‡ä»¶ capability.h ä¸­çœ‹åˆ°æ‰€æœ‰ capabilities çš„å®šä¹‰.")]),s._v(" "),t("p",[t("mark",[s._v("**å¯¹äºä»»æ„ä¸€ä¸ªè¿›ç¨‹, åœ¨åšä»»æ„ä¸€ä¸ªç‰¹æƒæ“ä½œçš„æ—¶å€™, éƒ½éœ€è¦æœ‰è¿™ä¸ªç‰¹æƒæ“ä½œå¯¹åº”çš„ capability. **")])]),s._v(" "),t("p",[s._v("æ¯”å¦‚è¿è¡Œ iptables å‘½ä»¤, å¯¹åº”çš„è¿›ç¨‹éœ€è¦æœ‰ CAP_NET_ADMIN è¿™ä¸ª capability. å¦‚æœè¦ mount ä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿ, é‚£ä¹ˆå¯¹åº”çš„è¿›ç¨‹éœ€è¦æœ‰ CAP_SYS_ADMIN è¿™ä¸ª capability. ä¸è¿‡éœ€è¦æ³¨æ„ CAP_SYS_ADMIN è¿™ä¸ª capability é‡Œå…è®¸äº†å¤§é‡çš„ç‰¹æƒæ“ä½œ, åŒ…æ‹¬æ–‡ä»¶ç³»ç»Ÿ, äº¤æ¢ç©ºé—´, è¿˜æœ‰å¯¹å„ç§è®¾å¤‡çš„æ“ä½œ, ä»¥åŠç³»ç»Ÿè°ƒè¯•ç›¸å…³çš„è°ƒç”¨ç­‰ç­‰.")]),s._v(" "),t("p",[t("strong",[s._v("åœ¨æ™®é€š Linux èŠ‚ç‚¹ä¸Š, é root ç”¨æˆ·å¯åŠ¨çš„è¿›ç¨‹ç¼ºçœæ²¡æœ‰ä»»ä½• Linux capabilities, è€Œ root ç”¨æˆ·å¯åŠ¨çš„è¿›ç¨‹ç¼ºçœåŒ…å«äº†æ‰€æœ‰çš„ Linux capabilities.")])]),s._v(" "),t("p",[s._v("å¯ä»¥åšä¸ªè¯•éªŒ, å¯¹äº root ç”¨æˆ·å¯åŠ¨çš„è¿›ç¨‹, å¦‚æœæŠŠ CAP_NET_ADMIN è¿™ä¸ª capability ç§»é™¤, çœ‹çœ‹å®ƒæ˜¯å¦è¿˜å¯ä»¥è¿è¡Œ iptables.")]),s._v(" "),t("p",[s._v("åœ¨è¿™é‡Œè¦ç”¨åˆ° capsh è¿™ä¸ªå·¥å…·. æ¥ä¸‹æ¥å°±ç”¨ capsh æ‰§è¡Œä¸‹é¢çš„è¿™ä¸ªå‘½ä»¤:")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# sudo /usr/sbin/capsh --keep=1 --user=root   --drop=cap_net_admin  --   -c './iptables -L;sleep 100'")]),s._v("\nChain INPUT "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("policy ACCEPT"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\ntarget     prot opt "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("source")]),s._v("               destination\n \nChain FORWARD "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("policy ACCEPT"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\ntarget     prot opt "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("source")]),s._v("               destination\n \nChain OUTPUT "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("policy ACCEPT"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\ntarget     prot opt "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("source")]),s._v("               destination\niptables: Permission denied "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("you must be root"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(".\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br")])]),t("p",[s._v('è¿™æ—¶å€™, å¯ä»¥çœ‹åˆ°å³ä½¿æ˜¯ root ç”¨æˆ·, å¦‚æœæŠŠ "CAP_NET_ADMIN" ç»™ç§»é™¤äº†, é‚£ä¹ˆåœ¨æ‰§è¡Œ iptables çš„æ—¶å€™å°±ä¼šçœ‹åˆ° "Permission denied (you must be root)." çš„æç¤ºä¿¡æ¯.')]),s._v(" "),t("p",[s._v("åŒæ—¶, å¯ä»¥é€šè¿‡ /proc æ–‡ä»¶ç³»ç»Ÿæ‰¾åˆ°"),t("strong",[s._v("å¯¹åº”è¿›ç¨‹çš„ status")]),s._v(", è¿™æ ·å°±èƒ½ç¡®è®¤è¿›ç¨‹ä¸­çš„ CAP_NET_ADMIN æ˜¯å¦å·²ç»è¢«ç§»é™¤äº†.")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ps -ef | grep sleep")]),s._v("\nroot     "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("22603")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("22275")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("19")]),s._v(":44 pts/1    00:00:00 "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" /usr/sbin/capsh "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--keep")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--user")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("root "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--drop")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("cap_net_admin -- "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-c")]),s._v(" ./iptables -L"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("sleep")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("100")]),s._v("\nroot     "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("22604")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("22603")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("19")]),s._v(":44 pts/1    00:00:00 /bin/bash "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-c")]),s._v(" ./iptables -L"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("sleep")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("100")]),s._v("\n \n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cat /proc/22604/status | grep Cap")]),s._v("\nCapInh:            0000000000000000\nCapPrm:          0000003fffffefff\nCapEff:             0000003fffffefff\nCapBnd:          0000003fffffefff\nCapAmb:         0000000000000000\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br")])]),t("p",[s._v("è¿è¡Œä¸Šé¢çš„å‘½ä»¤æŸ¥çœ‹ /proc//status é‡Œ Linux capabilities çš„ç›¸å…³å‚æ•°ä¹‹åå¯ä»¥å‘ç°, è¾“å‡ºç»“æœä¸­åŒ…å« 5 ä¸ª Cap å‚æ•°.")]),s._v(" "),t("p",[s._v("è¿™é‡Œè§£é‡Šä¸€ä¸‹, "),t("strong",[s._v('å¯¹äºå½“å‰è¿›ç¨‹, ç›´æ¥å½±å“æŸä¸ªç‰¹æƒæ“ä½œæ˜¯å¦å¯ä»¥è¢«æ‰§è¡Œçš„å‚æ•°, æ˜¯ "CapEff"')]),s._v(' , ä¹Ÿå°±æ˜¯ "Effective capability sets", è¿™æ˜¯ä¸€ä¸ª bitmap, æ¯ä¸€ä¸ª bit ä»£è¡¨ä¸€é¡¹ capability æ˜¯å¦è¢«æ‰“å¼€.')]),s._v(" "),t("p",[s._v('åœ¨ Linux å†…æ ¸ capability.h é‡ŒæŠŠ CAP_NET_ADMIN çš„å€¼å®šä¹‰æˆ 12, æ‰€ä»¥å¯ä»¥çœ‹åˆ° "CapEff" çš„å€¼æ˜¯ "0000003fffffefff", ç¬¬ 4 ä¸ªæ•°å€¼æ˜¯ 16 è¿›åˆ¶çš„ "e", è€Œä¸æ˜¯ f. è¿™è¡¨ç¤º CAP_NET_ADMIN å¯¹åº”çš„ç¬¬ 12-bit æ²¡æœ‰è¢«ç½®ä½äº†(0xefff = 0xffff & (~(1 << 12))), æ‰€ä»¥è¿™ä¸ªè¿›ç¨‹ä¹Ÿå°±æ²¡æœ‰æ‰§è¡Œ iptables å‘½ä»¤çš„æƒé™äº†.')]),s._v(" "),t("p",[s._v("å¯¹äºè¿›ç¨‹ status ä¸­å…¶ä»–å‡ ä¸ª capabilities ç›¸å…³çš„å‚æ•°, å®ƒä»¬è¿˜éœ€è¦å’Œåº”ç”¨ç¨‹åºæ–‡ä»¶å±æ€§ä¸­çš„ capabilities ååŒå·¥ä½œ, è¿™æ ·æ‰èƒ½å¾—åˆ°æ–°å¯åŠ¨çš„è¿›ç¨‹æœ€ç»ˆçš„ capabilities å‚æ•°çš„å€¼.")]),s._v(" "),t("p",[s._v("çœ‹ä¸‹é¢çš„å›¾, ç»“åˆè¿™å¼ å›¾çœ‹åé¢çš„è®²è§£:")]),s._v(" "),t("p",[t("img",{attrs:{src:"/img/d8f5fbae828ce11403e3f361858f00d1-20230731161430-urtxkwt.png",alt:""}})]),s._v(" "),t("p",[s._v("å¦‚æœè¦æ–°å¯åŠ¨ä¸€ä¸ªç¨‹åº, åœ¨ Linux é‡Œçš„è¿‡ç¨‹å°±æ˜¯å…ˆé€šè¿‡ "),t("strong",[s._v("fork()")]),s._v("  æ¥åˆ›å»ºå‡ºä¸€ä¸ªå­è¿›ç¨‹, ç„¶åè°ƒç”¨ execve() ç³»ç»Ÿè°ƒç”¨è¯»å–æ–‡ä»¶ç³»ç»Ÿé‡Œçš„ç¨‹åºæ–‡ä»¶, æŠŠç¨‹åºæ–‡ä»¶åŠ è½½åˆ°è¿›ç¨‹çš„ä»£ç æ®µä¸­å¼€å§‹è¿è¡Œ.")]),s._v(" "),t("p",[s._v("å°±åƒå›¾ç‰‡æ‰€æç»˜çš„é‚£æ ·, è¿™ä¸ª"),t("strong",[s._v("æ–°è¿è¡Œçš„è¿›ç¨‹é‡Œçš„ç›¸å…³ capabilities å‚æ•°çš„å€¼, æ˜¯ç”±å®ƒçš„çˆ¶è¿›ç¨‹ä»¥åŠç¨‹åºæ–‡ä»¶ä¸­çš„ capabilities å‚æ•°å€¼è®¡ç®—å¾—æ¥çš„")]),s._v(". å…·ä½“çš„è®¡ç®—è¿‡ç¨‹å¯ä»¥çœ‹ Linux capabilities çš„æ‰‹å†Œä¸­çš„æè¿°, ä¹Ÿå¯ä»¥è¯»ä¸€ä¸‹ç½‘ä¸Šçš„è¿™ä¸¤ç¯‡æ–‡ç« :")]),s._v(" "),t("ol",[t("li",[s._v("Capabilities: Why They Exist and How They Work")]),s._v(" "),t("li",[s._v("Linux Capabilities in Practice")])]),s._v(" "),t("p",[s._v("è¿™é‡Œåªè¦è®°ä½æœ€é‡è¦çš„ä¸€ç‚¹, "),t("mark",[t("strong",[s._v("æ–‡ä»¶ä¸­å¯ä»¥è®¾ç½® capabilities å‚æ•°å€¼, å¹¶ä¸”è¿™ä¸ªå€¼ä¼šå½±å“åˆ°æœ€åè¿è¡Œå®ƒçš„è¿›ç¨‹")])]),s._v("â€‹ "),t("strong",[s._v(". ** æ¯”å¦‚å¦‚æœæŠŠ iptables çš„åº”ç”¨ç¨‹åºåŠ ä¸Š CAP_NET_ADMIN çš„ capability, é‚£ä¹ˆå³ä½¿æ˜¯")]),s._v("é root ç”¨æˆ·ä¹Ÿæœ‰æ‰§è¡Œ iptables çš„æƒé™**äº†.")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("$ "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("id")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("uid")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1000")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("centos"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("gid")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1000")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("centos"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("groups")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1000")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("centos"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(",10"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("wheel"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n$ "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" setcap cap_net_admin+ep ./iptables\n$ getcap ./iptables\n./iptables "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" cap_net_admin+ep\n$./iptables "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-L")]),s._v("\nChain INPUT "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("policy ACCEPT"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\ntarget     prot opt "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("source")]),s._v("               destination\n \nChain FORWARD "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("policy ACCEPT"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\ntarget     prot opt "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("source")]),s._v("               destination\nDOCKER-"),t("span",{pre:!0,attrs:{class:"token environment constant"}},[s._v("USER")]),s._v("  all  --  anywhere             anywhere\nDOCKER-ISOLATION-STAGE-1  all  --  anywhere             anywhere\nACCEPT     all  --  anywhere             anywhere             ctstate RELATED,ESTABLISHED\nDOCKER     all  --  anywhere             anywhere\nACCEPT     all  --  anywhere             anywhere\nACCEPT     all  --  anywhere             anywhere\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br")])]),t("p",[t("strong",[s._v("å…³äº Linux capabilities çš„å†…å®¹åˆ°è¿™é‡Œå°±è®²å®Œäº†, å…¶å®å®ƒå°±æ˜¯æŠŠ Linux root ç”¨æˆ·åŸæ¥æ‰€æœ‰çš„ç‰¹æƒåšäº†ç»†åŒ–, å¯ä»¥æ›´åŠ ç»†ç²’åº¦åœ°ç»™è¿›ç¨‹èµ‹äºˆä¸åŒæƒé™")]),s._v(".")]),s._v(" "),t("h5",{attrs:{id:"_3-è§£å†³é—®é¢˜-10"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-è§£å†³é—®é¢˜-10"}},[s._v("#")]),s._v(" 3.è§£å†³é—®é¢˜")]),s._v(" "),t("p",[s._v("ææ‡‚äº† Linux capabilities ä¹‹å, é‚£ä¹ˆå¯¹ privileged çš„å®¹å™¨ä¹Ÿå¾ˆå®¹æ˜“ç†è§£äº†. "),t("mark",[t("strong",[s._v("Privileged çš„å®¹å™¨ä¹Ÿå°±æ˜¯å…è®¸å®¹å™¨ä¸­çš„è¿›ç¨‹å¯ä»¥æ‰§è¡Œæ‰€æœ‰çš„ç‰¹æƒæ“ä½œ")])]),s._v("â€‹ **. **")]),s._v(" "),t("p",[s._v("å› ä¸ºå®‰å…¨æ–¹é¢çš„è€ƒè™‘, å®¹å™¨ç¼ºçœå¯åŠ¨çš„æ—¶å€™, å“ªæ€•æ˜¯å®¹å™¨ä¸­ root ç”¨æˆ·çš„è¿›ç¨‹, ç³»ç»Ÿä¹Ÿ"),t("strong",[s._v("åªå…è®¸äº† 15 ä¸ª capabilities")]),s._v(". è¿™ä¸ªå¯ä»¥æŸ¥çœ‹ runC spec æ–‡æ¡£ä¸­çš„ security éƒ¨åˆ†, ä¹Ÿå¯ä»¥æŸ¥çœ‹å®¹å™¨ init è¿›ç¨‹ status é‡Œçš„ Cap å‚æ•°, çœ‹ä¸€ä¸‹å®¹å™¨ä¸­ç¼ºçœçš„ capabilities.")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# docker run --name iptables -it registry/iptables:v1 bash")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@e54694652a42 /"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cat /proc/1/status  |grep Cap")]),s._v("\nCapInh:            00000000a80425fb\nCapPrm:          00000000a80425fb\nCapEff:              00000000a80425fb\nCapBnd:          00000000a80425fb\nCapAmb:         0000000000000000\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br")])]),t("p",[s._v("éœ€è¦æ³¨æ„, "),t("strong",[s._v('å½“å‘ç°å®¹å™¨ä¸­è¿è¡ŒæŸä¸ªç¨‹åºçš„æƒé™ä¸å¤Ÿçš„æ—¶å€™, å¹¶ä¸èƒ½ "å·æ‡’" æŠŠå®¹å™¨è®¾ç½®ä¸º "privileged", ä¹Ÿå°±æ˜¯æŠŠæ‰€æœ‰çš„ capabilities éƒ½èµ‹äºˆäº†å®¹å™¨')]),s._v(". å› ä¸ºå®¹å™¨ä¸­çš„"),t("strong",[s._v("æƒé™è¶Šé«˜, å¯¹ç³»ç»Ÿå®‰å…¨çš„å¨èƒæ˜¾ç„¶ä¹Ÿæ˜¯è¶Šå¤§")]),s._v("çš„. æ¯”å¦‚å¦‚æœå®¹å™¨ä¸­çš„è¿›ç¨‹æœ‰äº† CAP_SYS_ADMIN çš„ç‰¹æƒä¹‹å, é‚£ä¹ˆè¿™äº›è¿›ç¨‹å°±å¯ä»¥åœ¨å®¹å™¨é‡Œç›´æ¥è®¿é—®ç£ç›˜è®¾å¤‡, ç›´æ¥å¯ä»¥è¯»å–æˆ–è€…ä¿®æ”¹å®¿ä¸»æœºä¸Šçš„æ‰€æœ‰æ–‡ä»¶äº†.")]),s._v(" "),t("p",[s._v("æ‰€ä»¥åœ¨å®¹å™¨å¹³å°ä¸Šæ˜¯"),t("strong",[s._v('åŸºæœ¬ä¸å…è®¸æŠŠå®¹å™¨ç›´æ¥è®¾ç½®ä¸º "privileged" çš„')]),s._v(", éœ€è¦"),t("strong",[s._v("æ ¹æ®å®¹å™¨ä¸­è¿›ç¨‹éœ€è¦çš„æœ€å°‘ç‰¹æƒæ¥èµ‹äºˆ capabilities")]),s._v(".")]),s._v(" "),t("p",[s._v("ç»“åˆè¿™ä¸€è®²å¼€å§‹çš„ä¾‹å­æ¥è¯´è¯´. åœ¨å¼€å¤´çš„ä¾‹å­ä¸­, å®¹å™¨é‡Œéœ€è¦ä½¿ç”¨ iptables. å› ä¸ºä½¿ç”¨ iptables å‘½ä»¤, åªéœ€è¦è®¾ç½® "),t("strong",[s._v("CAP_NET_ADMIN")]),s._v(" è¿™ä¸ª capability å°±è¡Œ. é‚£ä¹ˆåªè¦åœ¨è¿è¡Œ Docker çš„æ—¶å€™, ç»™è¿™ä¸ªå®¹å™¨å†å¤šåŠ ä¸€ä¸ª NET_ADMIN å‚æ•°å°±å¯ä»¥äº†.")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# docker run --name iptables --cap-add NET_ADMIN -it registry/iptables:v1 bash")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@cfedf124dcf1 /"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# iptables -L")]),s._v("\nChain INPUT "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("policy ACCEPT"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\ntarget     prot opt "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("source")]),s._v("               destination\n \nChain FORWARD "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("policy ACCEPT"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\ntarget     prot opt "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("source")]),s._v("               destination\n \nChain OUTPUT "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("policy ACCEPT"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\ntarget     prot opt "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("source")]),s._v("               destination\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br")])]),t("h5",{attrs:{id:"_4-é‡ç‚¹å°ç»“-4"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_4-é‡ç‚¹å°ç»“-4"}},[s._v("#")]),s._v(" 4.é‡ç‚¹å°ç»“")]),s._v(" "),t("p",[s._v("æœ¬èŠ‚ä¸»è¦å­¦ä¹ äº†å¦‚ä½•ç»™å®¹å™¨èµ‹äºˆåˆç†çš„ capabilities. "),t("mark",[t("strong",[s._v("Linux capabilities å°±æ˜¯æŠŠ Linux root ç”¨æˆ·åŸæ¥æ‰€æœ‰çš„ç‰¹æƒåšäº†ç»†åŒ–, å¯ä»¥æ›´åŠ ç»†ç²’åº¦åœ°ç»™è¿›ç¨‹èµ‹äºˆä¸åŒæƒé™")])]),s._v("â€‹ **. **")]),s._v(" "),t("p",[s._v("**å¯¹äº Linux ä¸­çš„æ¯ä¸€ä¸ªç‰¹æƒæ“ä½œéƒ½æœ‰ä¸€ä¸ªå¯¹åº”çš„ capability, å¯¹äºä¸€ä¸ª capability, æœ‰çš„å¯¹åº”ä¸€ä¸ªç‰¹æƒæ“ä½œ, æœ‰çš„å¯ä»¥å¯¹åº”å¾ˆå¤šä¸ªç‰¹æƒæ“ä½œ. **")]),s._v(" "),t("p",[s._v("æ¯ä¸ª Linux è¿›ç¨‹æœ‰ 5 ä¸ª capabilities é›†åˆå‚æ•°, å…¶ä¸­ Effective é›†åˆé‡Œçš„ capabilities å†³å®šäº†å½“å‰è¿›ç¨‹å¯ä»¥åšå“ªäº›ç‰¹æƒæ“ä½œ, è€Œå…¶ä»–é›†åˆå‚æ•°ä¼šå’Œåº”ç”¨ç¨‹åºæ–‡ä»¶çš„ capabilities é›†åˆå‚æ•°ä¸€èµ·æ¥å†³å®šæ–°å¯åŠ¨ç¨‹åºçš„ capabilities é›†åˆå‚æ•°.")]),s._v(" "),t("p",[s._v("å¯¹äºå®¹å™¨çš„ root ç”¨æˆ·, ç¼ºçœåªèµ‹äºˆäº† 15 ä¸ª capabilities. å¦‚æœå‘ç°å®¹å™¨ä¸­è¿›ç¨‹çš„æƒé™ä¸å¤Ÿ, å°±éœ€è¦"),t("strong",[s._v("åˆ†æå®ƒéœ€è¦çš„æœ€å° capabilities é›†åˆ")]),s._v(', è€Œä¸æ˜¯ç›´æ¥èµ‹äºˆå®¹å™¨ "privileged". å› ä¸º "privileged" åŒ…å«äº†æ‰€æœ‰çš„ Linux capabilities, è¿™æ · "privileged" å°±å¯ä»¥è½»æ˜“è·å–å®¿ä¸»æœºä¸Šçš„æ‰€æœ‰èµ„æº, è¿™ä¼šå¯¹å®¿ä¸»æœºçš„å®‰å…¨äº§ç”Ÿå¨èƒ. æ‰€ä»¥è¦æ ¹æ®å®¹å™¨ä¸­è¿›ç¨‹éœ€è¦çš„æœ€å°‘ç‰¹æƒæ¥èµ‹äºˆ capabilities.')]),s._v(" "),t("h4",{attrs:{id:"_20-å®¹å™¨å®‰å…¨-2-åœ¨å®¹å™¨ä¸­-æˆ‘ä¸ä»¥rootç”¨æˆ·æ¥è¿è¡Œç¨‹åºå¯ä»¥å—"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_20-å®¹å™¨å®‰å…¨-2-åœ¨å®¹å™¨ä¸­-æˆ‘ä¸ä»¥rootç”¨æˆ·æ¥è¿è¡Œç¨‹åºå¯ä»¥å—"}},[s._v("#")]),s._v(" 20 | å®¹å™¨å®‰å…¨(2):åœ¨å®¹å™¨ä¸­,æˆ‘ä¸ä»¥rootç”¨æˆ·æ¥è¿è¡Œç¨‹åºå¯ä»¥å—?")]),s._v(" "),t("p",[s._v("ä¸Šä¸€è®²å­¦ä¹ äº† Linux capabilities çš„æ¦‚å¿µ, ä¹ŸçŸ¥é“äº†å¯¹äºé privileged çš„å®¹å™¨, å®¹å™¨ä¸­ root ç”¨æˆ·çš„ capabilities æ˜¯æœ‰é™åˆ¶çš„, å› æ­¤"),t("strong",[s._v("å®¹å™¨ä¸­çš„ root ç”¨æˆ·æ— æ³•åƒå®¿ä¸»æœºä¸Šçš„ root ç”¨æˆ·ä¸€æ ·, æ‹¿åˆ°å®Œå…¨æŒæ§ç³»ç»Ÿçš„ç‰¹æƒ")]),s._v(".")]),s._v(" "),t("p",[s._v("é‚£ä¹ˆæ˜¯ä¸æ˜¯è®©é privileged çš„å®¹å™¨ä»¥ root ç”¨æˆ·æ¥è¿è¡Œç¨‹åº, è¿™æ ·å°±èƒ½ä¿è¯å®‰å…¨äº†å‘¢? è¿™ä¸€è®²å°±æ¥èŠä¸€èŠå®¹å™¨ä¸­çš„ "),t("strong",[s._v("root ç”¨æˆ·ä¸å®‰å…¨ç›¸å…³")]),s._v("çš„é—®é¢˜.")]),s._v(" "),t("h5",{attrs:{id:"_1-é—®é¢˜å†ç°-13"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-é—®é¢˜å†ç°-13"}},[s._v("#")]),s._v(" 1.é—®é¢˜å†ç°")]),s._v(" "),t("p",[s._v("è¯´åˆ°å®¹å™¨ä¸­çš„ç”¨æˆ·(user), ä½ å¯èƒ½ä¼šæƒ³åˆ°, "),t("strong",[s._v("åœ¨ Linux Namespace ä¸­æœ‰ä¸€é¡¹éš”ç¦»æŠ€æœ¯, ä¹Ÿå°±æ˜¯ User Namespace")]),s._v(". ä¸è¿‡åœ¨å®¹å™¨äº‘å¹³å° Kubernetes ä¸Šç›®å‰è¿˜ä¸æ”¯æŒ User Namespace, æ‰€ä»¥å…ˆæ¥çœ‹çœ‹åœ¨æ²¡æœ‰ User Namespace çš„æƒ…å†µä¸‹, å®¹å™¨ä¸­ç”¨ root ç”¨æˆ·è¿è¡Œ, ä¼šå‘ç”Ÿä»€ä¹ˆæƒ…å†µ.")]),s._v(" "),t("p",[s._v("é¦–å…ˆå¯ä»¥ç”¨ä¸‹é¢çš„å‘½ä»¤å¯åŠ¨ä¸€ä¸ªå®¹å™¨, åœ¨è¿™é‡ŒæŠŠå®¿ä¸»æœºä¸Š  "),t("strong",[s._v("/etc ç›®å½•ä»¥ volume çš„å½¢å¼æŒ‚è½½åˆ°äº†å®¹å™¨ä¸­çš„ /mnt ç›®å½•ä¸‹é¢")]),s._v(".")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# docker run -d --name root_example -v /etc:/mnt  centos sleep 3600")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v('ç„¶åå¯ä»¥çœ‹ä¸€ä¸‹å®¹å™¨ä¸­çš„è¿›ç¨‹ "sleep 3600", å®ƒåœ¨å®¹å™¨ä¸­å’Œå®¿ä¸»æœºä¸Šçš„ç”¨æˆ·'),t("strong",[s._v("éƒ½æ˜¯ root")]),s._v(", ä¹Ÿå°±æ˜¯è¯´, å®¹å™¨ä¸­ç”¨æˆ·çš„ uid/gid å’Œå®¿ä¸»æœºä¸Šçš„å®Œå…¨ä¸€æ ·.")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v('# docker exec -it root_example bash -c "ps -ef | grep sleep"')]),s._v("\nroot         "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("     "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" 01:14 ?        00:00:00 /usr/bin/coreutils --coreutils-prog-shebang"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("sleep /usr/bin/sleep "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("3600")]),s._v("\n \n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ps -ef | grep sleep")]),s._v("\nroot      "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("5473")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("5443")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("18")]),s._v(":14 ?        00:00:00 /usr/bin/coreutils --coreutils-prog-shebang"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("sleep /usr/bin/sleep "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("3600")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br")])]),t("p",[s._v("è™½ç„¶å®¹å™¨é‡Œ root ç”¨æˆ·çš„ capabilities è¢«é™åˆ¶äº†ä¸€äº›, ä½†æ˜¯åœ¨å®¹å™¨ä¸­, å¯¹äºè¢«æŒ‚è½½ä¸Šæ¥çš„ /etc ç›®å½•ä¸‹çš„æ–‡ä»¶, æ¯”å¦‚è¯´ shadow æ–‡ä»¶, ä»¥è¿™ä¸ª root ç”¨æˆ·çš„æƒé™è¿˜æ˜¯å¯ä»¥åšä¿®æ”¹çš„.")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# docker exec -it root_example bash")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@9c7b76232c19 /"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ls /mnt/shadow -l")]),s._v("\n---------- "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" root root "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("586")]),s._v(" Nov "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("26")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("13")]),s._v(":47 /mnt/shadow\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@9c7b76232c19 /"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v('# echo "hello" >> /mnt/shadow')]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br")])]),t("p",[s._v("æ¥ç€çœ‹çœ‹åé¢è¿™æ®µå‘½ä»¤è¾“å‡º, å¯ä»¥ç¡®è®¤"),t("strong",[s._v("åœ¨å®¿ä¸»æœºä¸Šæ–‡ä»¶è¢«ä¿®æ”¹")]),s._v("äº†.")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# tail -n 3 /etc/shadow")]),s._v("\ngrafana:"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),s._v(":18437::::::\ntcpdump:"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),s._v(":18592::::::\nhello\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br")])]),t("p",[s._v("è¿™ä¸ªä¾‹å­è¯´æ˜"),t("strong",[s._v("å®¹å™¨ä¸­çš„ root ç”¨æˆ·ä¹Ÿæœ‰æƒé™ä¿®æ”¹å®¿ä¸»æœºä¸Šçš„å…³é”®æ–‡ä»¶")]),s._v(".")]),s._v(" "),t("p",[s._v("å½“ç„¶åœ¨äº‘å¹³å°ä¸Š, æ¯”å¦‚è¯´åœ¨ Kubernetes é‡Œ, æ˜¯å¯ä»¥é™åˆ¶å®¹å™¨å»æŒ‚è½½å®¿ä¸»æœºçš„ç›®å½•çš„. ä¸è¿‡, ç”±äºå®¹å™¨å’Œå®¿ä¸»æœºæ˜¯"),t("strong",[s._v("å…±äº« Linux å†…æ ¸")]),s._v("çš„, ä¸€æ—¦è½¯ä»¶æœ‰æ¼æ´, é‚£ä¹ˆå®¹å™¨ä¸­ä»¥ root ç”¨æˆ·è¿è¡Œçš„è¿›ç¨‹å°±æœ‰æœºä¼šå»ä¿®æ”¹å®¿ä¸»æœºä¸Šçš„æ–‡ä»¶äº†. æ¯”å¦‚ 2019 å¹´å‘ç°çš„ä¸€ä¸ª RunC çš„æ¼æ´ CVE-2019-5736, "),t("strong",[s._v("è¿™å¯¼è‡´å®¹å™¨ä¸­ root ç”¨æˆ·æœ‰æœºä¼šä¿®æ”¹å®¿ä¸»æœºä¸Šçš„ RunC ç¨‹åº, å¹¶ä¸”å®¹å™¨ä¸­çš„ root ç”¨æˆ·è¿˜ä¼šå¾—åˆ°å®¿ä¸»æœºä¸Šçš„è¿è¡Œæƒé™")]),s._v(".")]),s._v(" "),t("h5",{attrs:{id:"_2-é—®é¢˜åˆ†æ-2"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-é—®é¢˜åˆ†æ-2"}},[s._v("#")]),s._v(" 2.é—®é¢˜åˆ†æ")]),s._v(" "),t("p",[s._v("å¯¹äºå‰é¢çš„é—®é¢˜, æ¥ä¸‹æ¥å°±æ¥è®¨è®ºä¸€ä¸‹"),t("strong",[s._v("è§£å†³åŠæ³•")]),s._v(", åœ¨è®¨è®ºé—®é¢˜çš„è¿‡ç¨‹ä¸­, ä¹Ÿä¼šæ¶‰åŠä¸€äº›æ–°çš„æ¦‚å¿µ, ä¸»è¦æœ‰ä¸‰ä¸ª.")]),s._v(" "),t("h6",{attrs:{id:"_1-æ–¹æ³•ä¸€-run-as-non-root-user-ç»™å®¹å™¨æŒ‡å®šä¸€ä¸ªæ™®é€šç”¨æˆ·"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-æ–¹æ³•ä¸€-run-as-non-root-user-ç»™å®¹å™¨æŒ‡å®šä¸€ä¸ªæ™®é€šç”¨æˆ·"}},[s._v("#")]),s._v(" (1)æ–¹æ³•ä¸€:Run as non-root user(ç»™å®¹å™¨æŒ‡å®šä¸€ä¸ªæ™®é€šç”¨æˆ·)")]),s._v(" "),t("p",[s._v("å¦‚æœä¸æƒ³è®©å®¹å™¨ä»¥ root ç”¨æˆ·è¿è¡Œ, æœ€ç›´æ¥çš„åŠæ³•å°±æ˜¯"),t("strong",[s._v("ç»™å®¹å™¨æŒ‡å®šä¸€ä¸ªæ™®é€šç”¨æˆ· uid")]),s._v('. è¿™ä¸ªæ–¹æ³•å¾ˆç®€å•, æ¯”å¦‚å¯ä»¥åœ¨ docker å¯åŠ¨å®¹å™¨çš„æ—¶å€™åŠ ä¸Š "-u" å‚æ•°, åœ¨å‚æ•°ä¸­æŒ‡å®š '),t("strong",[s._v("uid/gid")]),s._v(".")]),s._v(" "),t("p",[s._v("å…·ä½“çš„æ“ä½œä»£ç å¦‚ä¸‹:")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# docker run -ti --name root_example -u 6667:6667 -v /etc:/mnt  centos bash")]),s._v("\nbash-4.4$ "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("id")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("uid")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("6667")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("gid")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("6667")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("groups")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("6667")]),s._v("\nbash-4.4$ "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ps")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-ef")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token environment constant"}},[s._v("UID")]),s._v("        PID  "),t("span",{pre:!0,attrs:{class:"token environment constant"}},[s._v("PPID")]),s._v("  C STIME TTY          TIME CMD\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("6667")]),s._v("         "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("     "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" 01:27 pts/0    00:00:00 "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("bash")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("6667")]),s._v("         "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("8")]),s._v("     "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" 01:27 pts/0    00:00:00 "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ps")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-ef")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br")])]),t("p",[s._v("è¿˜æœ‰å¦å¤–ä¸€ä¸ªåŠæ³•, å°±æ˜¯åœ¨åˆ›å»ºå®¹å™¨é•œåƒçš„æ—¶å€™, ç”¨ "),t("strong",[s._v("Dockerfile")]),s._v(" ä¸ºå®¹å™¨é•œåƒé‡Œå»ºç«‹ä¸€ä¸ªç”¨æˆ·.")]),s._v(" "),t("p",[s._v("ä¸ºæ–¹ä¾¿ç†è§£, è¿˜æ˜¯ä¸¾ä¾‹è¯´æ˜. å°±åƒä¸‹é¢ä¾‹å­ä¸­çš„ nonroot, å®ƒæ˜¯ä¸€ä¸ªç”¨æˆ·å, ç”¨ USER å…³é”®å­—æ¥æŒ‡å®šè¿™ä¸ª nonroot ç”¨æˆ·, è¿™æ ·æ“ä½œä»¥å, "),t("strong",[s._v("å®¹å™¨é‡Œç¼ºçœçš„è¿›ç¨‹éƒ½ä¼šä»¥è¿™ä¸ªç”¨æˆ·å¯åŠ¨")]),s._v(".")]),s._v(" "),t("p",[s._v('è¿™æ ·åœ¨è¿è¡Œ Docker å‘½ä»¤çš„æ—¶å€™å°±ä¸ç”¨åŠ  "-u" å‚æ•°æ¥æŒ‡å®šç”¨æˆ·äº†.')]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cat Dockerfile")]),s._v("\nFROM centos\n \nRUN adduser "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-u")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("6667")]),s._v(" nonroot\n"),t("span",{pre:!0,attrs:{class:"token environment constant"}},[s._v("USER")]),s._v(" nonroot\n \n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# docker build -t registry/nonroot:v1 .")]),s._v("\nâ€¦\n \n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# docker run -d --name root_example -v /etc:/mnt registry/nonroot:v1 sleep 3600")]),s._v("\n050809a716ab0a9481a6dfe711b332f74800eff5fea8b4c483fa370b62b4b9b3\n \n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# docker exec -it root_example bash")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("nonroot@050809a716ab /"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("$ "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("id")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("uid")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("6667")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("nonroot"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("gid")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("6667")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("nonroot"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("groups")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("6667")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("nonroot"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("nonroot@050809a716ab /"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("$ "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ps")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-ef")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token environment constant"}},[s._v("UID")]),s._v("        PID  "),t("span",{pre:!0,attrs:{class:"token environment constant"}},[s._v("PPID")]),s._v("  C STIME TTY          TIME CMD\nnonroot      "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("     "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" 01:43 ?        00:00:00 /usr/bin/coreutils --coreutils-prog-shebang"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("sleep /usr/bin/sleep "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("3600")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br")])]),t("p",[s._v("å¥½, åœ¨å®¹å™¨ä¸­ä½¿ç”¨æ™®é€šç”¨æˆ·è¿è¡Œä¹‹å, å†çœ‹çœ‹ç°åœ¨èƒ½å¦ä¿®æ”¹è¢«æŒ‚è½½ä¸Šæ¥çš„ /etc ç›®å½•ä¸‹çš„æ–‡ä»¶? æ˜¾ç„¶, "),t("strong",[s._v("ç°åœ¨ä¸å¯ä»¥ä¿®æ”¹")]),s._v("äº†.")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("nonroot@050809a716ab /"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("$ "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"hello"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">>")]),s._v(" /mnt/shadow\nbash: /mnt/shadow: Permission denied\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])]),t("p",[s._v("é‚£ä¹ˆæ˜¯ä¸æ˜¯åªè¦ç»™å®¹å™¨ä¸­æŒ‡å®šäº†ä¸€ä¸ª"),t("strong",[s._v("æ™®é€šç”¨æˆ·")]),s._v(", è¿™ä¸ªé—®é¢˜å°±åœ†æ»¡è§£å†³äº†å‘¢? å…¶å®åœ¨äº‘å¹³å°ä¸Š, è¿™ä¹ˆåšè¿˜æ˜¯ä¼šå¸¦æ¥åˆ«çš„é—®é¢˜. ç”±äºç”¨æˆ· uid æ˜¯"),t("strong",[s._v("æ•´ä¸ªèŠ‚ç‚¹ä¸­å…±äº«")]),s._v("çš„, é‚£ä¹ˆåœ¨å®¹å™¨ä¸­å®šä¹‰çš„ uid, ä¹Ÿå°±æ˜¯å®¿ä¸»æœºä¸Šçš„ uid, è¿™æ ·å°±å¾ˆå®¹æ˜“å¼•èµ· uid çš„å†²çª. æ¯”å¦‚å¤šä¸ªå®¢æˆ·åœ¨å»ºç«‹è‡ªå·±çš„å®¹å™¨é•œåƒçš„æ—¶å€™éƒ½é€‰æ‹©äº†åŒä¸€ä¸ª uid 6667. é‚£ä¹ˆå½“å¤šä¸ªå®¢æˆ·çš„å®¹å™¨åœ¨åŒä¸€ä¸ªèŠ‚ç‚¹ä¸Šè¿è¡Œçš„æ—¶å€™, å…¶å®å°±éƒ½ä½¿ç”¨äº†"),t("strong",[s._v("å®¿ä¸»æœºä¸Š uid 6667")]),s._v(".")]),s._v(" "),t("p",[s._v("åœ¨ä¸€å° Linux ç³»ç»Ÿä¸Š, "),t("strong",[s._v("æ¯ä¸ªç”¨æˆ·ä¸‹çš„èµ„æºæ˜¯æœ‰é™åˆ¶çš„, æ¯”å¦‚æ‰“å¼€æ–‡ä»¶æ•°ç›®(open files), æœ€å¤§è¿›ç¨‹æ•°ç›®(max user processes)ç­‰ç­‰. ä¸€æ—¦æœ‰å¾ˆå¤šä¸ªå®¹å™¨å…±äº«ä¸€ä¸ª uid, è¿™äº›å®¹å™¨å°±å¾ˆå¯èƒ½å¾ˆå¿«æ¶ˆè€—æ‰è¿™ä¸ª uid ä¸‹çš„èµ„æº, è¿™æ ·å¾ˆå®¹æ˜“å¯¼è‡´è¿™äº›å®¹å™¨éƒ½ä¸èƒ½å†æ­£å¸¸å·¥ä½œ")]),s._v(".")]),s._v(" "),t("p",[s._v("è¦è§£å†³è¿™ä¸ªé—®é¢˜, å¿…é¡»è¦æœ‰ä¸€ä¸ªäº‘å¹³å°çº§åˆ«çš„ uid ç®¡ç†å’Œåˆ†é…, ä½†é€‰æ‹©è¿™ä¸ªæ–¹æ³•ä¹Ÿè¦ä»˜å‡ºä»£ä»·. å› ä¸ºè¿™æ ·åšæ˜¯å¯ä»¥è§£å†³é—®é¢˜, ä½†æ˜¯ç”¨æˆ·åœ¨å®šä¹‰è‡ªå·±å®¹å™¨ä¸­çš„ uid çš„æ—¶å€™, ä»–ä»¬å°±éœ€è¦æœ‰é¢å¤–çš„æ“ä½œ, è€Œä¸”å¹³å°ä¹Ÿéœ€è¦æ–°å¼€å‘å¯¹ uid å¹³å°çº§åˆ«çš„ç®¡ç†æ¨¡å—, å®Œæˆè¿™äº›äº‹æƒ…éœ€è¦çš„å·¥ä½œé‡ä¹Ÿä¸å°‘.")]),s._v(" "),t("h6",{attrs:{id:"_2-æ–¹æ³•äºŒ-user-namespace-ç”¨æˆ·éš”ç¦»æŠ€æœ¯çš„æ”¯æŒ"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-æ–¹æ³•äºŒ-user-namespace-ç”¨æˆ·éš”ç¦»æŠ€æœ¯çš„æ”¯æŒ"}},[s._v("#")]),s._v(" (2)æ–¹æ³•äºŒ:User Namespace(ç”¨æˆ·éš”ç¦»æŠ€æœ¯çš„æ”¯æŒ)")]),s._v(" "),t("p",[s._v("é‚£ä¹ˆåœ¨"),t("strong",[s._v("æ²¡æœ‰ä½¿ç”¨ User Namespace")]),s._v(" çš„æƒ…å†µ, å¯¹äºå®¹å™¨å¹³å°ä¸Šçš„ç”¨æˆ·ç®¡ç†è¿˜æ˜¯å­˜åœ¨é—®é¢˜. ä½ å¯èƒ½ä¼šæƒ³åˆ°, æ˜¯ä¸æ˜¯åº”è¯¥å»å°è¯•ä¸€ä¸‹ User Namespace? å°±ä¸€èµ·æ¥çœ‹çœ‹ä½¿ç”¨ User Namespace å¯¹è§£å†³ç”¨æˆ·ç®¡ç†é—®é¢˜æœ‰æ²¡æœ‰å¸®åŠ©.")]),s._v(" "),t("p",[s._v("é¦–å…ˆç®€å•äº†è§£ä¸€ä¸‹ User Namespace çš„æ¦‚å¿µ. "),t("strong",[s._v("User Namespace éš”ç¦»äº†ä¸€å° Linux èŠ‚ç‚¹ä¸Šçš„ User ID(uid)å’Œ Group ID(gid), å®ƒç»™ Namespace ä¸­çš„ uid/gid çš„å€¼ä¸å®¿ä¸»æœºä¸Šçš„ uid/gid å€¼å»ºç«‹äº†ä¸€ä¸ªæ˜ å°„å…³ç³». ç»è¿‡ User Namespace çš„éš”ç¦», åœ¨ Namespace ä¸­çœ‹åˆ°çš„è¿›ç¨‹çš„ uid/gid, å°±å’Œå®¿ä¸»æœº Namespace ä¸­çœ‹åˆ°çš„ uid å’Œ gid ä¸ä¸€æ ·äº†")]),s._v(".")]),s._v(" "),t("p",[s._v("å¯ä»¥çœ‹ä¸‹é¢çš„è¿™å¼ ç¤ºæ„å›¾, åº”è¯¥å°±èƒ½å¾ˆå¿«çŸ¥é“ User Namespace å¤§æ¦‚æ˜¯ä»€ä¹ˆæ„æ€äº†. æ¯”å¦‚ namespace_1 é‡Œçš„ uid å€¼æ˜¯ 0 åˆ° 999, ä½†å…¶å®å®ƒåœ¨å®¿ä¸»æœºä¸Šå¯¹åº”çš„ uid å€¼æ˜¯ 1000 åˆ° 1999. è¿˜æœ‰ä¸€ç‚¹è¦æ³¨æ„çš„æ˜¯, User Namespace æ˜¯å¯ä»¥"),t("strong",[s._v("åµŒå¥—")]),s._v("çš„, æ¯”å¦‚ä¸‹é¢å›¾é‡Œçš„ namespace_2 é‡Œå¯ä»¥å†å»ºç«‹ä¸€ä¸ª namespace_3, è¿™ä¸ªåµŒå¥—çš„ç‰¹æ€§æ˜¯å…¶ä»– Namespace æ²¡æœ‰çš„.")]),s._v(" "),t("p",[t("img",{attrs:{src:"/img/539dc1552acfc634542a05825b9df6e0-20230731161430-gyj4kwk.png",alt:""}})]),s._v(" "),t("p",[s._v("å¯ä»¥å¯åŠ¨ä¸€ä¸ªå¸¦ User Namespace çš„å®¹å™¨æ¥æ„Ÿå—ä¸€ä¸‹. è¿™æ¬¡å¯åŠ¨å®¹å™¨, ç”¨ä¸€ä¸‹ podman è¿™ä¸ªå·¥å…·, è€Œä¸æ˜¯ Docker. è·Ÿ Docker ç›¸æ¯”, podman ä¸å†æœ‰å®ˆæŠ¤è¿›ç¨‹ dockerd, è€Œæ˜¯ç›´æ¥é€šè¿‡ fork/execve çš„æ–¹å¼æ¥å¯åŠ¨ä¸€ä¸ªæ–°çš„å®¹å™¨. è¿™ç§æ–¹å¼å¯åŠ¨å®¹å™¨æ›´åŠ ç®€å•, ä¹Ÿæ›´å®¹æ˜“ç»´æŠ¤. Podman çš„å‘½ä»¤å‚æ•°å…¼å®¹äº†ç»å¤§éƒ¨åˆ†çš„ docker å‘½ä»¤è¡Œå‚æ•°, ç”¨è¿‡ Docker çš„åŒå­¦ä¹Ÿå¾ˆå®¹æ˜“ä¸Šæ‰‹ podman.")]),s._v(" "),t("p",[s._v("é‚£æ¥ä¸‹æ¥å°±ç”¨ä¸‹é¢çš„å‘½ä»¤æ¥å¯åŠ¨ä¸€ä¸ªå®¹å™¨:")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# podman run -ti  -v /etc:/mnt --uidmap 0:2000:1000 centos bash")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("å¯ä»¥çœ‹åˆ°, å…¶ä»–å‚æ•°å’Œå‰é¢çš„ Docker å‘½ä»¤æ˜¯ä¸€æ ·çš„.")]),s._v(" "),t("p",[s._v('è¿™é‡Œåœ¨å‘½ä»¤é‡Œå¢åŠ ä¸€ä¸ªå‚æ•°, "--uidmap 0:2000:1000", è¿™ä¸ªæ˜¯æ ‡å‡†çš„ User Namespace ä¸­ uid çš„æ˜ å°„æ ¼å¼: "ns_uid:host_uid:amount". é‚£è¿™ä¸ªä¾‹å­é‡Œçš„ "0:2000:1000" æ˜¯ä»€ä¹ˆæ„æ€å‘¢? è§£é‡Šä¸€ä¸‹.')]),s._v(" "),t("p",[s._v("ç¬¬ä¸€ä¸ª 0 æ˜¯æŒ‡åœ¨æ–°çš„ Namespace é‡Œ uid ä» 0 å¼€å§‹, ä¸­é—´çš„é‚£ä¸ª 2000 æŒ‡çš„æ˜¯ Host Namespace é‡Œè¢«æ˜ å°„çš„ uid ä» 2000 å¼€å§‹, æœ€åä¸€ä¸ª 1000 æ˜¯æŒ‡æ€»å…±éœ€è¦è¿ç»­æ˜ å°„ 1000 ä¸ª uid.")]),s._v(" "),t("p",[s._v("æ‰€ä»¥å¯ä»¥å¾—å‡º, **è¿™ä¸ªå®¹å™¨é‡Œçš„ uid 0 æ˜¯è¢«æ˜ å°„åˆ°å®¿ä¸»æœºä¸Šçš„ uid 2000 çš„. ** è¿™ä¸€ç‚¹å¯ä»¥éªŒè¯ä¸€ä¸‹.")]),s._v(" "),t("p",[s._v("é¦–å…ˆ, å…ˆåœ¨å®¹å™¨ä¸­ä»¥ç”¨æˆ· uid 0 è¿è¡Œä¸€ä¸‹ "),t("code",[s._v("sleep")]),s._v("â€‹ è¿™ä¸ªå‘½ä»¤:")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# id")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("uid")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("root"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("gid")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("root"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("groups")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("root"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# sleep 3600")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br")])]),t("p",[s._v("ç„¶åå°±æ˜¯ç¬¬äºŒæ­¥, åˆ°å®¿ä¸»æœºä¸ŠæŸ¥çœ‹ä¸€ä¸‹è¿™ä¸ªè¿›ç¨‹çš„ uid. è¿™é‡Œå¯ä»¥çœ‹åˆ°, è¿›ç¨‹ uid çš„ç¡®æ˜¯ 2000 äº†.")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ps -ef |grep sleep")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2000")]),s._v("     "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("27021")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("26957")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" 01:32 pts/0    00:00:00 /usr/bin/coreutils --coreutils-prog-shebang"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("sleep /usr/bin/sleep "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("3600")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])]),t("p",[s._v("ç¬¬ä¸‰æ­¥, å¯ä»¥å†å›åˆ°å®¹å™¨ä¸­, ä»ç„¶ä»¥å®¹å™¨ä¸­çš„ root å¯¹è¢«æŒ‚è½½ä¸Šæ¥çš„ /etc ç›®å½•ä¸‹çš„æ–‡ä»¶åšæ“ä½œ, è¿™æ—¶å¯ä»¥çœ‹åˆ°æ“ä½œæ˜¯"),t("strong",[s._v("ä¸è¢«å…è®¸")]),s._v("çš„.")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v('# echo "hello" >> /mnt/shadow')]),s._v("\nbash: /mnt/shadow: Permission denied\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# id")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("uid")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("root"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("gid")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("root"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("groups")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("root"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br")])]),t("p",[s._v("é€šè¿‡è¿™äº›æ“ä½œä»¥åŠå’Œå‰é¢ User Namespace çš„æ¦‚å¿µçš„è§£é‡Š, å¯ä»¥æ€»ç»“å‡ºå®¹å™¨ä½¿ç”¨ User Namespace æœ‰ä¸¤ä¸ªå¥½å¤„.")]),s._v(" "),t("p",[s._v("**ç¬¬ä¸€, å®ƒæŠŠå®¹å™¨ä¸­ root ç”¨æˆ·(uid 0)æ˜ å°„æˆå®¿ä¸»æœºä¸Šçš„æ™®é€šç”¨æˆ·. **")]),s._v(" "),t("p",[s._v("ä½œä¸ºå®¹å™¨ä¸­çš„ root, å®ƒè¿˜æ˜¯å¯ä»¥æœ‰ä¸€äº› Linux capabilities, é‚£ä¹ˆåœ¨å®¹å™¨ä¸­è¿˜æ˜¯å¯ä»¥æ‰§è¡Œä¸€äº›ç‰¹æƒçš„æ“ä½œ. è€Œåœ¨å®¿ä¸»æœºä¸Š uid æ˜¯æ™®é€šç”¨æˆ·, é‚£ä¹ˆå³ä½¿è¿™ä¸ªç”¨æˆ·é€ƒé€¸å‡ºå®¹å™¨ Namespace, å®ƒçš„æ‰§è¡Œæƒé™è¿˜æ˜¯"),t("strong",[s._v("æœ‰é™")]),s._v("çš„.")]),s._v(" "),t("p",[s._v("**ç¬¬äºŒ, å¯¹äºç”¨æˆ·åœ¨å®¹å™¨ä¸­è‡ªå·±å®šä¹‰æ™®é€šç”¨æˆ· uid çš„æƒ…å†µ, åªè¦ä¸ºæ¯ä¸ªå®¹å™¨åœ¨èŠ‚ç‚¹ä¸Šåˆ†é…ä¸€ä¸ª uid èŒƒå›´, å°±ä¸ä¼šå‡ºç°åœ¨å®¿ä¸»æœºä¸Š uid å†²çªçš„é—®é¢˜äº†. **")]),s._v(" "),t("p",[s._v("å› ä¸ºåœ¨è¿™ä¸ªæ—¶å€™, åªè¦åœ¨èŠ‚ç‚¹ä¸Šåˆ†é…å®¹å™¨çš„ uid èŒƒå›´å°±å¯ä»¥äº†, æ‰€ä»¥ä»å®ç°ä¸Šè¯´, ç›¸æ¯”åœ¨æ•´ä¸ªå¹³å°å±‚é¢ç»™å®¹å™¨åˆ†é… uid, ä½¿ç”¨ User Namespace è¿™ä¸ªåŠæ³•è¦æ–¹ä¾¿å¾—å¤š.")]),s._v(" "),t("p",[s._v("è¿™é‡Œé¢å¤–è¡¥å……ä¸€ä¸‹, å‰é¢è¯´äº† Kubernetes ç›®å‰è¿˜ä¸æ”¯æŒ User Namespace, å¦‚æœæƒ³äº†è§£ç›¸å…³å·¥ä½œçš„è¿›å±•, å¯ä»¥çœ‹ä¸€ä¸‹ç¤¾åŒºçš„è¿™ä¸ªPR.")]),s._v(" "),t("h6",{attrs:{id:"_3-æ–¹æ³•ä¸‰-rootless-container-ä»¥é-root-ç”¨æˆ·å¯åŠ¨å’Œç®¡ç†å®¹å™¨"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-æ–¹æ³•ä¸‰-rootless-container-ä»¥é-root-ç”¨æˆ·å¯åŠ¨å’Œç®¡ç†å®¹å™¨"}},[s._v("#")]),s._v(" (3)æ–¹æ³•ä¸‰:rootless container(ä»¥é root ç”¨æˆ·å¯åŠ¨å’Œç®¡ç†å®¹å™¨)")]),s._v(" "),t("p",[s._v("å‰é¢å·²ç»è®¨è®ºäº†, "),t("strong",[s._v("åœ¨å®¹å™¨ä¸­ä»¥é root ç”¨æˆ·è¿è¡Œè¿›ç¨‹å¯ä»¥é™ä½å®¹å™¨çš„å®‰å…¨é£é™©")]),s._v(". é™¤äº†åœ¨å®¹å™¨ä¸­ä½¿ç”¨é root ç”¨æˆ·, ç¤¾åŒºè¿˜æœ‰ä¸€ä¸ª "),t("strong",[s._v("rootless container")]),s._v(" çš„æ¦‚å¿µ.")]),s._v(" "),t("p",[s._v('è¿™é‡Œ rootless container ä¸­çš„ "rootless" ä¸ä»…ä»…æŒ‡å®¹å™¨ä¸­ä»¥é root ç”¨æˆ·æ¥è¿è¡Œè¿›ç¨‹, è¿˜æŒ‡'),t("strong",[s._v("ä»¥é root ç”¨æˆ·æ¥åˆ›å»ºå®¹å™¨")]),s._v(", ç®¡ç†å®¹å™¨. ä¹Ÿå°±æ˜¯è¯´, å¯åŠ¨å®¹å™¨çš„æ—¶å€™, Docker æˆ–è€… podman æ˜¯ä»¥é root ç”¨æˆ·æ¥æ‰§è¡Œçš„. è¿™æ ·ä¸€æ¥, å°±èƒ½è¿›ä¸€æ­¥æå‡å®¹å™¨ä¸­çš„å®‰å…¨æ€§, å°±ä¸ç”¨å†æ‹…å¿ƒå› ä¸º containerd æˆ–è€… RunC é‡Œçš„ä»£ç æ¼æ´, å¯¼è‡´å®¹å™¨è·å¾—å®¿ä¸»æœºä¸Šçš„æƒé™.")]),s._v(" "),t("p",[s._v("å¯ä»¥å‚è€ƒ redhat blog é‡Œçš„è¿™ç¯‡æ–‡æ¡£, åœ¨å®¿ä¸»æœºä¸Šç”¨ redhat è¿™ä¸ªç”¨æˆ·é€šè¿‡ podman æ¥å¯åŠ¨ä¸€ä¸ªå®¹å™¨. åœ¨è¿™ä¸ªå®¹å™¨ä¸­ä¹Ÿä½¿ç”¨äº† User Namespace, å¹¶ä¸”æŠŠå®¹å™¨ä¸­çš„ uid 0 æ˜ å°„ä¸ºå®¿ä¸»æœºä¸Šçš„ redhat ç”¨æˆ·äº†.")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("$ "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("id")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("uid")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1001")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("redhat"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("gid")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1001")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("redhat"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("groups")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1001")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("redhat"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n$ "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("podman")]),s._v(" run "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-it")]),s._v("  ubi7/ubi "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("bash")]),s._v("   "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("### åœ¨å®¿ä¸»æœºä¸Šä»¥redhatç”¨æˆ·å¯åŠ¨å®¹å™¨")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@206f6d5cb033 /"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# id     ### å®¹å™¨ä¸­çš„ç”¨æˆ·æ˜¯root")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("uid")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("root"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("gid")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("root"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("groups")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("root"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@206f6d5cb033 /"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# sleep 3600   ### åœ¨å®¹å™¨ä¸­å¯åŠ¨ä¸€ä¸ªsleep è¿›ç¨‹")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br")])]),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ps -ef |grep sleep   ###åœ¨å®¿ä¸»æœºä¸ŠæŸ¥çœ‹å®¹å™¨sleepè¿›ç¨‹å¯¹åº”çš„ç”¨æˆ·")]),s._v("\nredhat   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("29433")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("29410")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" 05:14 pts/0    00:00:00 "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("sleep")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("3600")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])]),t("p",[s._v("ç›®å‰ Docker å’Œ podman éƒ½æ”¯æŒäº† rootless container, Kubernetes å¯¹rootless container æ”¯æŒçš„å·¥ä½œä¹Ÿåœ¨è¿›è¡Œä¸­.")]),s._v(" "),t("h5",{attrs:{id:"_3-é‡ç‚¹å°ç»“-2"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-é‡ç‚¹å°ç»“-2"}},[s._v("#")]),s._v(" 3.é‡ç‚¹å°ç»“")]),s._v(" "),t("p",[s._v("æœ¬èŠ‚ä»Šå¤©è®¨è®ºçš„å†…å®¹æ˜¯ root ç”¨æˆ·ä¸å®¹å™¨å®‰å…¨çš„é—®é¢˜. å°½ç®¡å®¹å™¨ä¸­ root ç”¨æˆ·çš„ Linux capabilities å·²ç»å‡å°‘äº†å¾ˆå¤š, ä½†æ˜¯åœ¨æ²¡æœ‰ User Namespace çš„æƒ…å†µä¸‹, "),t("strong",[s._v("å®¹å™¨ä¸­ root ç”¨æˆ·å’Œå®¿ä¸»æœºä¸Šçš„ root ç”¨æˆ·çš„ uid æ˜¯å®Œå…¨ç›¸åŒçš„, ä¸€æ—¦æœ‰è½¯ä»¶çš„æ¼æ´, å®¹å™¨ä¸­çš„ root ç”¨æˆ·å°±å¯ä»¥æ“æ§æ•´ä¸ªå®¿ä¸»æœº")]),s._v(".")]),s._v(" "),t("p",[t("mark",[t("strong",[s._v("ä¸ºäº†å‡å°‘å®‰å…¨é£é™©, ä¸šç•Œéƒ½æ˜¯å»ºè®®åœ¨å®¹å™¨ä¸­ä»¥é root ç”¨æˆ·æ¥è¿è¡Œè¿›ç¨‹")])]),s._v("â€‹ **. ** ä¸è¿‡åœ¨æ²¡æœ‰ User Namespace çš„æƒ…å†µä¸‹, åœ¨å®¹å™¨ä¸­ä½¿ç”¨é root ç”¨æˆ·, å¯¹äºå®¹å™¨äº‘å¹³å°æ¥è¯´, å¯¹ uid çš„ç®¡ç†ä¼šæ¯”è¾ƒéº»çƒ¦.")]),s._v(" "),t("p",[s._v("æ‰€ä»¥è¿˜æ˜¯è¦åˆ†æä¸€ä¸‹ User Namespace, å®ƒå¸¦æ¥çš„å¥½å¤„æœ‰ä¸¤ä¸ª. ä¸€ä¸ªæ˜¯æŠŠå®¹å™¨ä¸­ root ç”¨æˆ·(uid 0)æ˜ å°„æˆå®¿ä¸»æœºä¸Šçš„æ™®é€šç”¨æˆ·, å¦å¤–ä¸€ä¸ªå¥½å¤„æ˜¯åœ¨äº‘å¹³å°é‡Œå¯¹äºå®¹å™¨ uid çš„åˆ†é…è¦å®¹æ˜“äº›. "),t("strong",[s._v("é™¤äº†åœ¨å®¹å™¨ä¸­ä»¥é root ç”¨æˆ·æ¥è¿è¡Œè¿›ç¨‹å¤–, Docker å’Œ podman éƒ½æ”¯æŒäº† rootless container, ä¹Ÿå°±æ˜¯è¯´å®ƒä»¬éƒ½å¯ä»¥ä»¥é root ç”¨æˆ·æ¥å¯åŠ¨å’Œç®¡ç†å®¹å™¨, è¿™æ ·å°±è¿›ä¸€æ­¥é™ä½äº†å®¹å™¨çš„å®‰å…¨é£é™©")]),s._v(".")]),s._v(" "),t("h3",{attrs:{id:"ç»“æŸè¯­"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#ç»“æŸè¯­"}},[s._v("#")]),s._v(" ç»“æŸè¯­")]),s._v(" "),t("h4",{attrs:{id:"ç»“æŸè¯­-è·³å‡ºèˆ’é€‚åŒº-çªç ´æ€è€ƒçš„æƒ°æ€§"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#ç»“æŸè¯­-è·³å‡ºèˆ’é€‚åŒº-çªç ´æ€è€ƒçš„æƒ°æ€§"}},[s._v("#")]),s._v(" ç»“æŸè¯­ | è·³å‡ºèˆ’é€‚åŒº,çªç ´æ€è€ƒçš„æƒ°æ€§")]),s._v(" "),t("p",[s._v('åœ¨å¤šå¹´ä»¥å‰, æˆ‘åœ¨ä¹¦é‡Œè¯»åˆ°ä¸€å¥è¯, è¯´çš„æ˜¯ "'),t("strong",[s._v("æ¯ä¸ªäººéƒ½æœ‰æ½œåœ¨çš„èƒ½é‡, åªæ˜¯å¾ˆå®¹æ˜“è¢«ä¹ æƒ¯æ‰€æ©ç›–, è¢«æ—¶é—´æ‰€è¿·ç¦», è¢«æƒ°æ€§æ‰€æ¶ˆç£¨")]),s._v('."')]),s._v(" "),t("p",[s._v("ä»Šå¤©å†æ¬¡å›çœ‹è¿™æ®µè¯, è¿˜çœŸæ˜¯ä¸€è¯­ä¸­çš„, æ„Ÿè§¦è‰¯å¤š, å›æƒ³èµ·ä¸“æ å†™ä½œçš„æ•´ä¸ªè¿‡ç¨‹, è¿™ä»¶äº‹å¸¦ç»™æˆ‘çš„æœ€å¤§æ„Ÿæ‚Ÿå°±æ˜¯: **è·³å‡ºè‡ªå·±çš„èˆ’é€‚åŒº, æ‰èƒ½æœ‰æ‰€çªç ´. **")]),s._v(" "),t("h5",{attrs:{id:"_1-çªç ´èˆ’é€‚åŒºæ˜¯å¾ˆéš¾çš„äº‹å„¿"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-çªç ´èˆ’é€‚åŒºæ˜¯å¾ˆéš¾çš„äº‹å„¿"}},[s._v("#")]),s._v(" 1.çªç ´èˆ’é€‚åŒºæ˜¯å¾ˆéš¾çš„äº‹å„¿")]),s._v(" "),t("p",[s._v("çªç ´èˆ’é€‚åŒºæ˜¯ä¸€ä»¶å¾ˆéš¾çš„äº‹å„¿. è¿™é‡Œåˆ†äº«ä¸€ä¸ªæˆ‘è‡ªå·±çš„æ•…äº‹, ä¹Ÿè®¸ä½ ä¹Ÿä¼šä»è¿™ä¸ªæ•…äº‹é‡Œæ‰¾åˆ°è‡ªå·±çš„å½±å­.")]),s._v(" "),t("p",[s._v('è®°å¾—åœ¨ 2 å¹´å‰, æˆ‘å‚åŠ è¿‡ eBay çš„ä¸€ä¸ªå†…éƒ¨åŸ¹è®­, åŸ¹è®­çš„ç›®æ ‡å°±æ˜¯è¦è®©è‡ªå·±æœ‰æ‰€"çªç ´". æˆ‘å¿…é¡»æ‰¿è®¤, è¿™ä¸ªåŸ¹è®­æ˜¯æˆ‘ç»å†è¿‡çš„æ‰€æœ‰åŸ¹è®­ä¸­æœ€æ¥åœ°æ°”çš„ä¸€ä¸ªåŸ¹è®­, åœ¨åŸ¹è®­è¿‡ç¨‹é‡Œæˆ‘ä¹Ÿæ˜¯æƒ…ç»ªæ¿€æ˜‚çš„, å‡†å¤‡å¸¦ç€å­¦åˆ°çš„ä¸œè¥¿å›åˆ°å·¥ä½œé‡Œå»å¤§å±•èº«æ‰‹, å¥½å¥½çªç ´ä¸€ç•ªçš„.')]),s._v(" "),t("p",[s._v("ä¸è¿‡ç­‰åŸ¹è®­ç»“æŸ, å†å›åˆ°æ—¥å¸¸å·¥ä½œçš„æ—¶å€™, ä¹‹å‰çš„é›„å¿ƒå£®å¿—, "),t("strong",[s._v("æ¿€æƒ…æ¾æ¹ƒåˆè¢«æ—¥å¸¸çš„çäº‹æ‰€æ·¹æ²¡, ç§¯è“„çš„é‚£è‚¡åŠ²å„¿åˆæ…¢æ…¢è¢«æ¶ˆç£¨")]),s._v('äº†. å‘¨å›´çš„åŒäº‹ä¼šå¼€ç©ç¬‘åœ°å¯¹æˆ‘è¯´: "ç¨‹è¿œå•Š, æˆ‘è§‰å¾—ä½ æ²¡æœ‰çªç ´å•Š. "')]),s._v(" "),t("p",[s._v('å…¶å®, æˆ‘å¿ƒé‡Œä¹ŸçŸ¥é“, æ‰€è°“çš„"çªç ´"å°±è¦è·³å‡ºè‡ªå·±çš„èˆ’é€‚åŒº. ä¸è¿‡æˆ‘å§‹ç»ˆä¸çŸ¥é“æ€ä¹ˆè·³å‡ºæ¥, å“ªæ€•è‡ªå·±æ‰‹ä¸Šçš„å·¥ä½œå†å¤š, å·¥ä½œåˆ°å†æ™š, ä½†è¿™ä»ç„¶æ˜¯å¤„äºè‡ªå·±èˆ’é€‚åŒº. '),t("strong",[s._v("è¿™æ˜¯å› ä¸ºè¿™ä¸€åˆ‡çš„å·¥ä½œèŠ‚å¥è¿˜æœ‰æ€è€ƒçš„é—®é¢˜, éƒ½æ˜¯æˆ‘è‡ªå·±ç†Ÿæ‚‰çš„")]),s._v(".")]),s._v(" "),t("p",[s._v('è¿™ç§ç†Ÿæ‚‰å¾ˆå¯èƒ½è®©æˆ‘ä»¬æ²‰æ¹å…¶ä¸­, è£¹è¶³ä¸å‰. é‚£é—®é¢˜æ¥äº†, æ„è¯†åˆ°è‡ªå·±å¤„äºèˆ’é€‚åŒº, äº§ç”Ÿæƒ³è¦"è·³å‡ºå»"çš„å¿µå¤´çš„ç¡®æ˜¯è‰¯å¥½å¼€å±€, éš¾çš„æ˜¯æ€ä¹ˆæœ‰æ•ˆçªç ´. è¿™å°±è¦èŠåˆ°çªç ´æ–¹æ³•è·¯å¾„çš„é—®é¢˜äº†, æˆ‘æƒ³ç»“åˆè‡ªå·±çš„æ„Ÿæ‚Ÿç»™ä½ è¯´ä¸€è¯´.')]),s._v(" "),t("h5",{attrs:{id:"_2-ä¸»åŠ¨è¿æ¥æŒ‘æˆ˜-åœ¨å®æˆ˜ä¸­è¿›æ­¥"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-ä¸»åŠ¨è¿æ¥æŒ‘æˆ˜-åœ¨å®æˆ˜ä¸­è¿›æ­¥"}},[s._v("#")]),s._v(" 2.ä¸»åŠ¨è¿æ¥æŒ‘æˆ˜,åœ¨å®æˆ˜ä¸­è¿›æ­¥")]),s._v(" "),t("p",[s._v("ä¸çŸ¥é“ä½ æœ‰æ²¡æœ‰å¬è¿‡çƒ­åŠ›å­¦é‡Œç†µå¢çš„å®šå¾‹, å¤§æ¦‚è¯´çš„æ˜¯: "),t("strong",[s._v("å°é—­ç³»ç»Ÿçš„ç†µ(èƒ½é‡)ä¼šä¸å¯é€†åœ°å¢åŠ , æœ€ç»ˆå¯¼è‡´æ•´ä¸ªç³»ç»Ÿå´©æºƒ")]),s._v(". é‚£æ€ä¹ˆæ‰èƒ½ä¿æŒè¿™ä¸ªç³»ç»Ÿçš„æ´»åŠ›å‘¢? "),t("strong",[s._v("å°±æ˜¯èƒ½é‡äº¤æ¢, ä¸æ–­å»å¼•å…¥å¤–éƒ¨çš„èƒ½é‡, ä¹Ÿå°±æ˜¯è´Ÿç†µ")]),s._v(".")]),s._v(" "),t("p",[s._v("å¯ä»¥å¼•ç”³ä¸€ä¸‹, è‡ªç„¶ä¼šæƒ³åˆ°èµ°å‡ºèˆ’é€‚åŒºè¿™ä»¶äº‹, ä¹Ÿæ˜¯åŒæ ·çš„é“ç†. æˆ‘ä»¬"),t("strong",[s._v("è¦æœ‰ä¸€ç§å†’é™©å®¶çš„å‹‡æ°”, ä¸»åŠ¨å»è¿æ¥æŒ‘æˆ˜, åœ¨å®æˆ˜é‡Œè¿«ä½¿è‡ªå·±ä¸æ–­è¿›æ­¥")]),s._v(".")]),s._v(" "),t("p",[s._v('å…¶å®é€‰æ‹©åšè¿™æ ·ä¸€ä¸ªä¸“æ , å¯¹æˆ‘æ¥è¯´å°±æ˜¯èµ°å‡ºèˆ’é€‚åŒºçš„ä¸€é¡¹"æŒ‘æˆ˜". åœ¨ä»Šå¹´ 7 æœˆä»½, é‚£è¿˜æ˜¯æˆ‘ä»¬è¿™ä¸ªä¸“æ ç­¹å¤‡çš„å‰æœŸ, æˆ‘å½“æ—¶å°±ä¸€ä¸ªæƒ³æ³•, å°±æ˜¯æŠŠæˆ‘è¿™äº›å¹´æ¥åœ¨å®¹å™¨æ–¹é¢çš„ç§¯ç´¯ç»™è®°å½•ä¸‹æ¥.')]),s._v(" "),t("p",[s._v("ä» 7 æœˆä»½å†³å®šå†™å®¹å™¨è¿™ä¸ªä¸“æ å¼€å§‹, åˆ°ç°åœ¨å·®ä¸å¤šä¹Ÿæœ‰åŠå¹´çš„æ—¶é—´äº†, æˆ‘çœŸçš„è§‰å¾—, åœ¨å·¥ä½œçš„åŒæ—¶æŠŠå†™ä¸“æ çš„è¿™ä»¶äº‹ç»™åšæŒä¸‹æ¥, çœŸçš„æ˜¯ä¸€ä»¶ä¸å®¹æ˜“çš„äº‹æƒ…. **è¿™é‡Œä¸ä»…ä»…æ˜¯ä¸€ä¸ªç®€å•çš„æ—¶é—´æŠ•å…¥é—®é¢˜, æ›´å¤šçš„æ˜¯è¿«ä½¿è‡ªå·±å†å»æ€è€ƒçš„é—®é¢˜. **")]),s._v(" "),t("p",[s._v("ä¼°è®¡ä½ ä¹Ÿå‘ç°äº†, æˆ‘æ¯ä¸€è®²éƒ½æ¶‰åŠä¸å°‘çŸ¥è¯†ç‚¹. æˆ‘åœ¨ä¸“æ å†™ä½œçš„è¿‡ç¨‹ä¸­, èŠ±æ—¶é—´æœ€å¤šçš„å°±æ˜¯æ€ä¹ˆæŠŠé—®é¢˜è¯´æ¸…æ¥š, è¿™é‡Œè¦è§£é‡Šå“ªäº›å…³é”®çŸ¥è¯†ç‚¹, é€‚åˆç”¨ä»€ä¹ˆæ ·çš„ä¾‹å­åšè§£é‡Š, æ¯ä¸ªçŸ¥è¯†ç‚¹è¦è®²åˆ°ä»€ä¹ˆç¨‹åº¦, éœ€è¦æŸ¥é˜…å“ªäº›ä»£ç å’Œèµ„æ–™æ¥ä¿è¯è‡ªå·±æ‰€è®²å†…å®¹çš„æ­£ç¡®æ€§.")]),s._v(" "),t("p",[s._v("è¿™æ ·çš„æ€è€ƒæ¨¡å¼å’Œæˆ‘æ—¥å¸¸æ€è€ƒå·¥ä½œé—®é¢˜çš„æ¨¡å¼æ˜¯å®Œå…¨ä¸åŒçš„. ä½†ä¹Ÿæ­£æ˜¯å€Ÿç€è¿™æ ·çš„æœºä¼š, æˆ‘æ‰ä»è‡ªå·±åŸå…ˆçš„èˆ’é€‚åŒºé‡Œè·³äº†å‡ºæ¥, å·¥ä½œä¹‹ä½™åŒæ—¶ä¹Ÿåœ¨æ€è€ƒå†™ä¸“æ çš„é—®é¢˜, æ¯å¤©éƒ½æœ‰å¤§é‡çš„ context switch, ä¹Ÿå°±æ˜¯ä¸Šä¸‹æ–‡åˆ‡æ¢.")]),s._v(" "),t("p",[s._v("æˆ‘å¾ˆé«˜å…´è‡ªå·±å¯ä»¥åšæŒä¸‹æ¥, å®Œæˆäº†ä¸“æ çš„ä¸»ä½“éƒ¨åˆ†. å¯ä»¥è¯´, è¿™é—¨è¯¾æ—¢æ˜¯å®¹å™¨çš„å®æˆ˜è¯¾, ä¹Ÿæ˜¯æˆ‘è‡ªå·±èµ°å‡ºèˆ’é€‚åŒºçš„å®æˆ˜è®­ç»ƒ.")]),s._v(" "),t("h5",{attrs:{id:"_3-çªç ´èˆ’é€‚åŒº-æœ¬è´¨æ˜¯çªç ´æ€è€ƒçš„æƒ°æ€§"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-çªç ´èˆ’é€‚åŒº-æœ¬è´¨æ˜¯çªç ´æ€è€ƒçš„æƒ°æ€§"}},[s._v("#")]),s._v(" 3.çªç ´èˆ’é€‚åŒº,æœ¬è´¨æ˜¯çªç ´æ€è€ƒçš„æƒ°æ€§")]),s._v(" "),t("p",[s._v("è¿™æ¬¡çš„ä¸“æ å†™ä½œ, è¿˜è®©æˆ‘æ„è¯†åˆ°, "),t("mark",[t("strong",[s._v("çªç ´èˆ’é€‚åŒºçš„æœ¬è´¨å°±æ˜¯çªç ´æ€è€ƒçš„æƒ°æ€§. åªæœ‰ä¸æ–­æ€è€ƒ, æ‰èƒ½æ¨ç€è‡ªå·±ä¸æ–­å¾€å‰èµ°, æ‰èƒ½è®©æˆ‘ä»¬æ›´ä»å®¹åœ°è§£å†³å·¥ä½œä¸Šçš„é—®é¢˜")])]),s._v("â€‹ **. **")]),s._v(" "),t("p",[s._v("åœ¨ 2020 å¹´çš„ 12 æœˆåˆ, Kubernetes å®£å¸ƒä¸å†æ”¯æŒ dockershim, ä¹Ÿå°±æ˜¯è¯´ Kubernetes èŠ‚ç‚¹ä¸Šä¸èƒ½å†ç›´æ¥ç”¨ Docker æ¥å¯åŠ¨å®¹å™¨äº†. å½“æ—¶æˆ‘çœ‹åˆ°è¿™æ¡æ–°é—», è§‰å¾—è¿™æ˜¯ç†æ‰€å½“ç„¶çš„, å› ä¸ºæˆ‘ä»¬çš„å®¹å™¨äº‘å¹³å°ä¸Šåœ¨ 2019 å¹´åˆå°±ä» Docker è¿ç§»åˆ°äº† Containerd.")]),s._v(" "),t("p",[s._v("ä¸è¿‡, åæ¥æˆ‘åœ¨ä¸“æ ç•™è¨€å›å¤çš„è¿‡ç¨‹ä¸­, è¿ç»­æœ‰ä¸‰ä½åŒå­¦ç•™è¨€, é—®æˆ‘æ€ä¹ˆçœ‹ Kubernetes çš„è¿™ä¸ªå†³å®š, è¿™è®©æˆ‘åˆå›å¿†èµ·äº†å½“åˆæˆ‘ä»¬å›¢é˜Ÿæ˜¯æ€ä¹ˆåšçš„è¿ç§»å†³å®š.")]),s._v(" "),t("p",[s._v("è¿™ä»¶äº‹è¿˜è¦è¿½æº¯åˆ° 2018 å¹´çš„æ—¶å€™, æˆ‘ä»¬å‘ç° kubelet é€šè¿‡ CRI æ¥å£å°±å¯ä»¥é›†æˆ Containerd äº†, äºæ˜¯æˆ‘ä»¬å°±å¼€å§‹æ€è€ƒ, æ˜¯ä¸æ˜¯åº”è¯¥ç”¨ Containerd æ¥æ›¿æ¢ Docker å‘¢?")]),s._v(" "),t("p",[s._v("å½“æ—¶æˆ‘ä»¬çœ‹åˆ°çš„å¥½å¤„æœ‰ä¸¤ç‚¹. ç¬¬ä¸€ç‚¹æ˜¯è¿™æ ·æ›¿æ¢ä¹‹å"),t("strong",[s._v("æ¶æ„ä¸Šçš„ä¼˜åŠ¿")]),s._v(", CRI å¯ä»¥è¯´æ˜¯ kubelet è¿æ¥ Runtime çš„æ ‡å‡†äº†, è€Œç”¨ Dockershim æ¥ Docker å†è½¬ Containerd, è¿™æ ·å¾ˆç´¯èµ˜. ç¬¬äºŒç‚¹å¥½å¤„å°±æ˜¯"),t("strong",[s._v("é™ä½äº†ç»´æŠ¤æˆæœ¬")]),s._v(". Containerd åªæ˜¯ Docker ä¸­çš„ä¸€éƒ¨åˆ†, ç»´æŠ¤ Containerd æ˜æ˜¾è¦æ¯”ç»´æŠ¤åºå¤§çš„ Docker å®¹æ˜“.")]),s._v(" "),t("p",[s._v("å½“ç„¶, è¿™ä¹ˆåšçš„æŒ‘æˆ˜ä¹Ÿæ˜¯å¾ˆå¤§çš„. å½“æ—¶, æˆ‘ä»¬åœ¨ç”Ÿäº§ç¯å¢ƒä¸­å·²ç»æœ‰ 2 ä¸‡å°ç‰©ç†æœºèŠ‚ç‚¹ä»¥åŠå‡ åä¸‡ä¸ªå®¹å™¨, è€Œä¸”é‚£æ—¶å€™ä¸šç•Œè¿˜å‡ ä¹æ²¡æœ‰äººåœ¨ç”Ÿäº§ç¯å¢ƒä¸­ç”¨ kubelet ç›´æ¥è°ƒç”¨ Containerd. æ²¡æœ‰å‰äººçš„å°è¯•å¯ä»¥å€Ÿé‰´, åªèƒ½å’¬ç‰™æ‰“ä¸€åœºç¡¬ä»—.")]),s._v(" "),t("p",[s._v("åæ¥æˆ‘ä»¬é€šè¿‡ä¸€ä¸ªå¤šæœˆçš„æµ‹è¯•, å‘ç°ç›´æ¥ä½¿ç”¨ Containerd, æ— è®ºæ˜¯ç¨³å®šæ€§è¿˜æ˜¯æ€§èƒ½éƒ½æ²¡æœ‰é—®é¢˜. æœ‰äº†å®é™…æµ‹è¯•åšä¿éšœ, æˆ‘ä»¬åœ¨ 2019 å¹´åˆåˆèŠ±äº† 3 ä¸ªæœˆæ—¶é—´, æ‰æŠŠç”Ÿäº§ç¯å¢ƒä¸Šçš„ Docker å…¨éƒ¨æ›¿æ¢æˆ Containerd.")]),s._v(" "),t("p",[s._v("è¿™æ ·çš„ç»“æœçœ‹ä¼¼è½»ææ·¡å†™, ä¸€ä¸¤å¥è¯å°±å¸¦è¿‡äº†. ä½†å®é™…è¿‡ç¨‹é‡Œ, å·²ç»ä¸æ˜¯è¿‡äº”å…³æ–©å…­å°†äº†, è€Œæ˜¯ä¸€ç›´åœ¨å‘ç°é—®é¢˜, è§£å†³é—®é¢˜, å¤§å¤§å°å°çš„æˆ˜å½¹æ‰æ±‡èšæˆäº†æœ€åçš„æˆ˜æœ. å…¶å®, æˆ‘åœ¨è¿™ä¸ªä¸“æ é‡Œå’Œä½ åˆ†äº«çš„ä¸€äº›å®¹å™¨é—®é¢˜, ä¹Ÿæ¥æºäºæˆ‘ä»¬å½“æ—¶çš„è¿ç§»å®è·µ.")]),s._v(" "),t("p",[s._v("ç°åœ¨å›æƒ³èµ·æ¥, å½“åˆçš„è¿™ä¸ªå†³å®šæ— ç–‘æ˜¯éå¸¸æ­£ç¡®çš„äº†. ä¸è¿‡å†æƒ³æƒ³, å¦‚æœå½“æ—¶çœ‹åˆ° Kubernetes çš„å˜åŒ–, æˆ‘ä»¬æ²¡æœ‰ä¸»åŠ¨æ€è€ƒ, ç­‰åˆ°ç°åœ¨ Kubernetes å®£å¸ƒä¸å†æ”¯æŒ Dockershim æ‰å»åšåº”å¯¹, ç»“æœåˆä¼šæ€æ ·å‘¢?")]),s._v(" "),t("p",[s._v("è¿™ä¸ªé—®é¢˜, æˆ‘è§‰å¾—ç”¨æ•°å­—æ¥è¯´è¯æ›´ç›´è§‚. åˆšæ‰æåˆ°å½“æ—¶è¿ç§»çš„æ—¶å€™, æœ‰ 2 ä¸‡å°ç‰©ç†æœºèŠ‚ç‚¹ä»¥åŠå‡ åä¸‡ä¸ªå®¹å™¨. ä½†å¦‚æœç­‰åˆ°ç°åœ¨æ‰è¿ç§», æˆ‘ä»¬éœ€è¦é¢å¯¹çš„å°±æ˜¯ 6 ä¸‡å°ç‰©ç†æœºå’Œä¸Šç™¾ä¸‡çš„å®¹å™¨äº†.")]),s._v(" "),t("p",[s._v("**ä½ çœ‹, æ— è®ºæ˜¯å†™ä¸“æ ä¹Ÿå¥½, è¿˜æ˜¯æˆ‘ä»¬å®é™…å·¥ä½œä¹Ÿå¥½, å‘†åœ¨èˆ’é€‚åŒºé‡Œ, çŸ­æœŸæˆæœ¬çœ‹ç€æŒºå°, ä¸éœ€è¦ä½ å¤§åŠ¨å¹²æˆˆ, æ¶ˆè€—è„‘ç»†èƒå’Œç²¾åŠ›. ä½†æ˜¯, å½“ä½ ä¹ æƒ¯äº†è¿™ç§æ€è€ƒçš„æƒ°æ€§, å°±ä¼šå˜æˆæ¸©æ°´ç…®é’è›™è€Œä¸è‡ªçŸ¥, ç­‰åˆ°å¤–éƒ¨æ¡ä»¶å‘ç”Ÿå˜åŒ–æ—¶ä¼šå¾ˆè¢«åŠ¨. **")]),s._v(" "),t("p",[s._v("â€")])])}),[],!1,null,null,null);t.default=e.exports}}]);