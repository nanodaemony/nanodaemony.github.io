(window.webpackJsonp=window.webpackJsonp||[]).push([[245],{548:function(a,t,e){"use strict";e.r(t);var s=e(7),r=Object(s.a)({},(function(){var a=this,t=a._self._c;return t("ContentSlotsDistributor",{attrs:{"slot-key":a.$parent.slotKey}},[t("h1",{attrs:{id:"_3-口算-拍试卷轮询接口报错🌟"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-口算-拍试卷轮询接口报错🌟"}},[a._v("#")]),a._v(" 3.口算-拍试卷轮询接口报错🌟")]),a._v(" "),t("h4",{attrs:{id:"故障现象"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#故障现象"}},[a._v("#")]),a._v(" 故障现象")]),a._v(" "),t("p",[a._v("企业微信收到报警, 拍试卷轮询接口(/leo-exam/{client:xxx}/photograph/poll) 报错")]),a._v(" "),t("blockquote",[t("p",[a._v("[ERROR][CONTROLLER][leo-exam][[102 次][NullPointerException]null]")]),a._v(" "),t("p",[a._v("request: /leo-exam/{client:xxx}/photograph/poll"),t("br"),a._v("\nmethod: PhotographController.paperPagePool(..)"),t("br"),a._v("\nhost: leo-exam-6b6cbbd75d-gj84r"),t("br"),a._v("\nuser_id: 514597712"),t("br"),a._v("\nplatform: android"),t("br"),a._v("\napp_ver: 3.40.2"),t("br"),a._v("\nUA: Leo/3.40.2 (HUAWEILIO-AN00m; Android 10; Scale/3.00)"),t("br"),a._v("\ntrace_id: 3s95i5yzqu0bf2ufzs9")]),a._v(" "),t("p",[a._v("堆栈信息:"),t("br"),a._v("\ncom.fenbi.leo.db.utils.CachedBeanCopier.copy(CachedBeanCopier.java:39)"),t("br"),a._v("\ncom.fenbi.leo.exam.server.service.impl.PhotographServiceImpl.getPaperPageById(PhotographServiceImpl.java:309)"),t("br"),a._v("\ncom.fenbi.leo.exam.server.web.logic.PhotographLogic.poolPaperPage(PhotographLogic.java:211)"),t("br"),a._v("\ncom.fenbi.leo.exam.server.web.ctrl.PhotographController.paperPagePool$original$ntQmU7pc(PhotographController.java:95)"),t("br"),a._v("\ncom.fenbi.leo.exam.server.web.ctrl.PhotographController.paperPagePool$original$ntQmU7pc$accessor$y8YzcWvp(PhotographController.java)"),t("br"),a._v("\ncom.fenbi.leo.exam.server.web.ctrl.PhotographController$auxiliary$YQwykV1x.call(Unknown Source)"),t("br"),a._v("\ncom.fenbi.leo.exam.server.web.ctrl.PhotographController.paperPagePool(PhotographController.java)"),t("br"),a._v("\ncom.fenbi.leo.exam.server.web.ctrl.PhotographController$$FastClassBySpringCGLIB$$d1575628.invoke("),t("generated",[a._v(")"),t("br"),a._v("\n此消息于 2022-06-13 20:53:17.121 发布")])],1)]),a._v(" "),t("p",[a._v("用户反馈拍试卷功能无法使用.")]),a._v(" "),t("h4",{attrs:{id:"故障复盘-处理过程-现象"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#故障复盘-处理过程-现象"}},[a._v("#")]),a._v(" 故障复盘(处理过程&现象)")]),a._v(" "),t("blockquote",[t("p",[a._v("20:00 开始企业微信有一些leo-exam的报警信息")])]),a._v(" "),t("blockquote",[t("p",[a._v("20:48 定位到异常原因是数据库的主从延迟")])]),a._v(" "),t("p",[a._v("通过企业微信报警错误内容来看, 首先猜测是查询时未查出数据. 然而这部分业务在设计时, 是保证数据库里有数据时才会请求这个接口进行查询, 所以将异常定位在数据库的范围中.")]),a._v(" "),t("p",[a._v("观察监控, leo-c-mysql 集群的"),t("mark",[t("strong",[a._v("主从延迟比较高")])]),a._v(", 已经接近 30s, 所以导致数据插入后, 查询的接口查询不到记录, 导致 NPE.")]),a._v(" "),t("p",[t("img",{attrs:{src:"/img/image-20231126180911-lyn3f0r.png",alt:"image"}})]),a._v(" "),t("blockquote",[t("p",[a._v("20:56 DBA排查主从延迟比较高的原因")])]),a._v(" "),t("p",[a._v("DBA 反馈是由于主库写入比较高, 同时从库的读压力比较大, 导致主从延迟增加. 比较高的读是来自于 leo-midas-group-activity, 该服务只配置了一个从库, 所以导致单个库的流量比较大.")]),a._v(" "),t("p",[a._v("从整体集群上看, 从库的负载不均衡, 大部分请求都打到了其中一个从库上.")]),a._v(" "),t("p",[t("img",{attrs:{src:"/img/image-20231126180945-t6qgfps.png",alt:"image"}})]),a._v(" "),t("blockquote",[t("p",[a._v("21:00 主从延迟恢复正常, 服务恢复")])]),a._v(" "),t("p",[a._v("高峰期已过, 流量慢慢降下来, 主从延迟在 21:00 恢复到正常, 报警信息也没有了, 服务错误 QPS 也恢复正常.")]),a._v(" "),t("p",[t("img",{attrs:{src:"/img/image-20231126181017-4iz8zj0.png",alt:"image"}})]),a._v(" "),t("h4",{attrs:{id:"故障原因"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#故障原因"}},[a._v("#")]),a._v(" 故障原因")]),a._v(" "),t("p",[a._v("leo-c-mysql 集群的写流量比较大, 同时一个从库的读流量比较大, 导致主从延迟增加.")]),a._v(" "),t("h4",{attrs:{id:"优化"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#优化"}},[a._v("#")]),a._v(" 优化")]),a._v(" "),t("h5",{attrs:{id:"_1-增加从库"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-增加从库"}},[a._v("#")]),a._v(" 1.增加从库")]),a._v(" "),t("p",[a._v("流量较大的服务(leo-midas-group-activity)增加多从库配置, 减小单个从库压力")]),a._v(" "),t("h5",{attrs:{id:"_2-原因排查"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-原因排查"}},[a._v("#")]),a._v(" 2.原因排查")]),a._v(" "),t("p",[a._v("06-13 号发生了比较长的主从延迟, 后续观察 06-14 仍然在相同的时间点有较高的主从延迟, 需要排查一下问题原因.")]),a._v(" "),t("p",[t("img",{attrs:{src:"/img/image-20231126181140-4v8pb32.png",alt:"image"}})]),a._v(" "),t("p",[a._v("观察 MySQL 集群的监控, 在 06-07 开始后的几天, 写 QPS 上涨了很多.")]),a._v(" "),t("p",[t("img",{attrs:{src:"/img/image-20231126181202-depovv4.png",alt:"image"}})]),a._v(" "),t("p",[a._v("统计写请求最高的库")]),a._v(" "),t("div",{staticClass:"language-java line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-java"}},[t("code",[a._v("sum "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("rate")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),a._v("mysql_perf_schema_table_io_waits_total"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("{")]),a._v(" instance"),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("~")]),t("span",{pre:!0,attrs:{class:"token string"}},[a._v('".*leo-c-mysql.*"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(",")]),a._v(" operation"),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("~")]),t("span",{pre:!0,attrs:{class:"token string"}},[a._v('"update|delete|insert"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("[")]),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("30")]),a._v("s"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("]")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v(" by "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),a._v("instance"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(",")]),a._v(" schema"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v("\n")])]),a._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[a._v("1")]),t("br")])]),t("p",[t("img",{attrs:{src:"/img/image-20231126181232-361o5jk.png",alt:"image"}})]),a._v(" "),t("p",[a._v("统计是哪张表的写请求")]),a._v(" "),t("div",{staticClass:"language-java line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-java"}},[t("code",[a._v("sum "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("rate")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),a._v("mysql_perf_schema_table_io_waits_total"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("{")]),a._v(" instance"),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("~")]),t("span",{pre:!0,attrs:{class:"token string"}},[a._v('".*leo-c-mysql.*"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(",")]),a._v(" operation"),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("~")]),t("span",{pre:!0,attrs:{class:"token string"}},[a._v('"update|delete|insert"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(",")]),a._v(" schema"),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[a._v('"leo_exam"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("[")]),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("30")]),a._v("s"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("]")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v(" by "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),a._v("instance"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(",")]),a._v(" schema"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(",")]),a._v(" name"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v("\n")])]),a._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[a._v("1")]),t("br")])]),t("p",[t("img",{attrs:{src:"/img/image-20231126181256-h58tb94.png",alt:"image"}})]),a._v(" "),t("p",[a._v("观察服务概览中写 MySQL 的请求也是能够对的上的")]),a._v(" "),t("p",[t("img",{attrs:{src:"/img/image-20231126181313-wq7ywlh.png",alt:"image"}})]),a._v(" "),t("p",[a._v("排查代码, 找到流量来源")]),a._v(" "),t("p",[a._v("排查 leo-exam 代码, 这张表的写入有两个来源, 一个来源是拍照检查的 MQ, 一个来源是 addAnimationKeypointVideos RPC 接口. 看接口监控, addAnimationKeypointVideos 接口的监控比较正常, 但是拍照检查 MQ 的 QPS 和数据库 QPS 上涨规律基本一致. 但是峰值 QPS 相差 3 倍, 看业务逻辑是因为拍照检查一般一次最多 3 个题目, 拿到题目之后会去内容组的接口查询有无视频, 然后 Insert 或者 update search_question_video 这张表, 所以 QPS 相差三倍.")]),a._v(" "),t("p",[t("img",{attrs:{src:"/img/image-20231126181409-chq6ito.png",alt:"image"}})]),a._v(" "),t("p",[a._v("看拍照检查的 QPS 趋势基本一致")]),a._v(" "),t("p",[t("img",{attrs:{src:"/img/image-20231126181453-us5dkj6.png",alt:"image"}})]),a._v(" "),t("p",[a._v("优化了 SQL:")]),a._v(" "),t("ul",[t("li",[t("strong",[a._v("leo-exam 中 insert 可以批量写")])]),a._v(" "),t("li",[a._v("leo-exam 中先 select 后 update/select 可以改为一次 insert into ... on duplicate key update ...")])]),a._v(" "),t("p",[a._v("‍")]),a._v(" "),t("p",[a._v("‍")]),a._v(" "),t("p",[a._v("‍")]),a._v(" "),t("p",[a._v("‍")])])}),[],!1,null,null,null);t.default=r.exports}}]);